{"version":3,"sources":["regexp/wrapper","node_modules/browser-pack/_prelude.js","amp-ad-network-fake-impl.js","ads/_a4a-config.js","ads/_config.js","ads/google/a4a/shared/url-builder.js","ads/google/a4a/traffic-experiments.js","ads/google/a4a/utils.js","build/ampdoc.css.js","build/ampshared.css.js","builtins/amp-img.js","builtins/amp-layout.js","builtins/amp-pixel.js","extensions/amp-a4a/0.1/a4a-variable-source.js","extensions/amp-a4a/0.1/amp-a4a.js","extensions/amp-a4a/0.1/signature-verifier.js","extensions/amp-ad-network-cloudflare-impl/0.1/cloudflare-a4a-config.js","extensions/amp-ad-network-fake-impl/0.1/amp-ad-metadata-transformer.js","extensions/amp-ad-network-fake-impl/0.1/amp-ad-network-fake-impl.js","extensions/amp-ad-network-fake-impl/0.1/external-reorder-head-transformer.js","extensions/amp-ad-network-gmossp-impl/0.1/gmossp-a4a-config.js","extensions/amp-ad-network-triplelift-impl/0.1/triplelift-a4a-config.js","extensions/amp-ad/0.1/concurrent-load.js","src/3p-frame-messaging.js","src/3p-frame.js","src/action-constants.js","src/ad-cid.js","src/ad-helper.js","src/amp-events.js","src/analytics.js","src/animation.js","src/base-element.js","src/chunk.js","src/common-signals.js","src/config.js","src/consent-state.js","src/consent.js","src/cookies.js","src/css.js","src/curve.js","src/custom-element.js","src/document-ready.js","src/document-submit.js","src/dom.js","src/element-service.js","src/element-stub.js","src/error.js","src/event-helper-listen.js","src/event-helper.js","src/experiments.js","src/exponential-backoff.js","src/extension-analytics.js","src/finite-state-machine.js","src/focus-history.js","src/form-data-wrapper.js","src/form.js","src/friendly-iframe-embed.js","src/history.js","src/iframe-attributes.js","src/iframe-helper.js","src/impression.js","src/ini-load.js","src/input.js","src/internal-version.js","src/intersection-observer-polyfill.js","src/json.js","src/layout-delay-meter.js","src/layout-rect.js","src/layout.js","src/loader.js","src/log.js","src/mode-object.js","src/mode.js","src/observable.js","src/pass.js","src/pixel.js","src/polyfills/custom-elements.js","src/polyfills/document-contains.js","src/polyfills/domtokenlist.js","src/preconnect.js","src/render-delaying-services.js","src/service.js","src/service/action-impl.js","src/service/batched-xhr-impl.js","src/service/cache-cid-api.js","src/service/cid-api.js","src/service/cid-impl.js","src/service/core-services.js","src/service/crypto-impl.js","src/service/custom-element-registry.js","src/service/document-info-impl.js","src/service/extension-location.js","src/service/extensions-impl.js","src/service/fixed-layer.js","src/service/hidden-observer-impl.js","src/service/history-impl.js","src/service/ie-media-bug.js","src/service/jank-meter.js","src/service/mutator-interface.js","src/service/navigation.js","src/service/owners-impl.js","src/service/owners-interface.js","src/service/platform-impl.js","src/service/resource.js","src/service/resources-impl.js","src/service/resources-interface.js","src/service/standard-actions-impl.js","src/service/storage-impl.js","src/service/task-queue.js","src/service/template-impl.js","src/service/timer-impl.js","src/service/url-expander/expander.js","src/service/url-impl.js","src/service/url-replacements-impl.js","src/service/variable-source.js","src/service/viewer-cid-api.js","src/service/viewer-impl.js","src/service/viewer-interface.js","src/service/viewport/viewport-binding-def.js","src/service/viewport/viewport-binding-ios-embed-wrapper.js","src/service/viewport/viewport-binding-natural.js","src/service/viewport/viewport-impl.js","src/service/viewport/viewport-interface.js","src/service/vsync-impl.js","src/service/xhr-impl.js","src/services.js","src/size-list.js","src/static-template.js","src/string.js","src/style-installer.js","src/style.js","src/time.js","src/transition.js","src/types.js","src/url-parse-query-string.js","src/url-try-decode-uri-component.js","src/url.js","src/utils/array.js","src/utils/base64.js","src/utils/bytes.js","src/utils/document-visibility.js","src/utils/dom-fingerprint.js","src/utils/function.js","src/utils/img.js","src/utils/key-codes.js","src/utils/lru-cache.js","src/utils/math.js","src/utils/object.js","src/utils/priority-queue.js","src/utils/promise.js","src/utils/rate-limit.js","src/utils/signals.js","src/utils/xhr-utils.js","src/visibility-state.js","src/window-interface.js","third_party/css-escape/css-escape.js"],"names":[],"mappings":"AAAA;ACAA;ACCA;AACA;AACA;AACA;AACA;AACA;ACUA;ADRA;ACSA;ADPA;ACQA;ADNA;ACOA;ADLA;ACdA;ADgBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACTA;ADWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACTA;AAEA;ADUA;AACA;AACA;AACA;ACTO;AACL;AACE;AACE;AAAW;AAAA;AACX;AAAU;AAAA;AACV;AAAe;AAAA;AACf;AACA;AACA;AACA;AAAQ;AAAA;AAER;AACA;AACA;AACA;ADkBN;AC9BsB;AAcnB;ADmBH;ACjBE;AACD;AAED;ADkBA;AACA;AACA;AACA;AACA;AClBO;AACL;AACA;AACA;AACA;AAJ+B;ADyBjC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AEjFA;AFmFA;AEnGA;AFqGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AEjGA;AFmGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AEjGA;AAEA;AFkGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AEjGA;AFmGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AG9KA;AHgLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AG9KA;AACO;AAEP;AH+KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AGhLO;AAML;AACA;AAUA;AHoKF;AGnKE;AACE;AACD;AHqKH;AGpKE;AHsKF;AGrKE;AACE;AACA;AHuKJ;AGtKI;AACE;AACD;AHwKL;AGvKI;AACA;AACA;AHyKJ;AGxKI;AACE;AAAuB;AH2K7B;AGvKM;AACE;AACD;AHyKP;AGxKM;AACE;AACD;AH0KP;AGzKM;AACD;AH2KL;AG1KI;AACA;AACD;AH4KH;AG3KE;AACE;AACD;AH6KH;AG5KE;AACD;AH8KD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AInPA;AJqPA;AIpPA;AJsPA;AInPA;AJqPA;AIpPA;AJsPA;AInRA;AJqRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AInRA;AJqRA;AACA;AACA;AACA;AACA;AACA;AACA;AI5QA;AJ8QA;AACA;AACA;AI5QO;AAEP;AJ6QA;AACA;AI7QO;AAEP;AJ8QA;AACA;AACA;AACA;AACA;AACA;AI9QO;AACL;AACA;AAFwC;AAK1C;AJ+QA;AACA;AACA;AACA;AACA;AACA;AACA;AIhRO;AACL;AJkRF;AI/QE;AACE;AACD;AAED;AJgRF;AACA;AIhRE;AAMA;AACA;AACA;AACK;AAAA;AAML;AACD;AAED;AJwQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AIxQO;AACL;AACE;AACD;AJ0QH;AIzQE;AACD;AAED;AJ0QA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AI1QO;AACL;AAEI;AACD;AAEJ;AAED;AJyQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AIzQO;AACL;AACD;AAED;AJ0QA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AI1QO;AACL;AACE;AACD;AACF;AAED;AJ2QA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AI3QO;AACL;AACE;AACD;AJ6QH;AI5QE;AJ8QF;AI7QE;AACE;AAID;AACC;AACD;AACF;AJ4QD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKjcA;ALmcA;AKlcA;ALocA;AKncA;ALqcA;AKpcA;ALscA;AKrcA;ALucA;AKtcA;ALwcA;AKvcA;ALycA;AKpcA;ALscA;AKrcA;ALucA;AKtcA;ALwcA;AKvcA;ALycA;AKxcA;AL0cA;AKzcA;AL2cA;AK1cA;AL4cA;AK3cA;AL6cA;AK/eA;ALifA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AK3dA;AACA;AAEA;AL4dA;AK3dA;AAEA;AL4dA;AK3dA;AACE;AACA;AACA;AAH0B;AAM5B;AL4dA;AK3dO;AACL;AACA;AACA;AACA;AAJmC;AAOrC;AL4dA;AACA;AACA;AACA;AACA;AK5dA;AACE;AACA;AACA;AACA;AAJ2B;AAO7B;AL6dA;AK5dO;AAEP;AL6dA;AACA;AK7dO;AAEP;AL8dA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AK9dO;AAEP;AL+dA;AACA;AACA;AK/dO;AAEP;ALgeA;AACA;AACA;AACA;AKheO;AAEP;ALieA;AACA;AACA;AACA;AACA;AKjeO;AAA0B;AAAe;AAAhB;AAEhC;ALqeA;AACA;AKreA;AAEA;ALseA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKreA;AACE;AAMD;AAED;ALieA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKjeO;AACL;AAID;AAED;AL+dA;AACA;AACA;AACA;AACA;AACA;AK/dO;AACL;AACD;AAED;ALgeA;AACA;AACA;AACA;AACA;AACA;AKheO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAV6C;AAa7C;ALieF;AKheE;AACE;AACD;ALkeH;AKjeE;AAID;AAED;AL+dA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AK/dO;AAAuD;AAAA;AAE5D;AACA;AACA;AACA;ALkeF;AKjeE;AACE;AACD;ALmeH;AKleE;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AAPK;AASR;AAED;ALmeA;AACA;AACA;AACA;AACA;AACA;AACA;AKneO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AAAuB;AACX;AAAO;AADI;ALyezB;AKhfsD;ALkftD;AKxeE;AL0eF;AKzeE;AAEI;AL0eN;AKxeM;AACE;AACD;AL0eP;AKzeM;AAGA;AACD;AAEC;AAZF;AAaiB;AAGT;AACE;AACD;AAED;ALseZ;AACA;AKteY;AAGD;AAXU;AAbjB;AA4BgB;AAEV;AACA;AACA;AACD;AALW;AAQnB;AAED;ALkeA;AACA;AACA;AACA;AACA;AACA;AKleO;AAA8C;AAEnD;AAEA;ALmeF;AKleE;AAGI;AACA;AACD;ALkeL;AKjeE;AACA;AAIE;AACA;ALgeJ;AKle4B;AAAA;AAAA;ALse5B;AACA;AKleI;AAAgC;AAAe;AAAhB;AALP;AL6e5B;AKteI;ALweJ;AKveI;AACA;AACA;AACA;AACE;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAhCK;AAkCR;AACF;AAED;ALqeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKreO;AAOL;AACA;AACA;AACE;AACA;AACD;AACF;AAED;ALgeA;AACA;AACA;AACA;AACA;AACA;AACA;AKheO;AACL;AAKD;AAED;AL6dA;AACA;AACA;AACA;AACA;AK7dA;AACE;AACA;AL+dF;AK9dE;AACE;AACA;AACD;ALgeH;AK/dE;AACA;AACD;AAED;ALgeA;AACA;AACA;AACA;AACA;AKheA;AACE;AACA;AACE;AACD;AACC;AACD;AACF;AAED;ALieA;AACA;AACA;AACA;AACA;AACA;AKjeO;AACL;AACD;AAED;ALkeA;AACA;AACA;AACA;AACA;AKleA;AAAmC;ALqenC;AKneE;AAAqB;AAEnB;ALqeJ;AKpeI;AACE;AACD;ALseL;AKreI;ALueJ;AKteI;AAIE;AAAiC;AAAO;AACzC;ALueL;AKteI;AACD;AACC;AACE;AACD;ALweL;AKveI;ALyeJ;AKxeI;AACE;AAAiC;AAAO;AACzC;AL4eL;AK3eI;AACD;AACF;AAED;AL4eA;AACA;AACA;AACA;AACA;AK5eA;AACE;AACA;AL8eF;AK7eE;AACE;AACA;AACD;AL+eH;AK9eE;AACA;AACD;AAED;AL+eA;AACA;AACA;AACA;AACA;AACA;AK/eA;AACE;ALifF;AKhfE;AACE;AACD;AACC;AACD;ALkfH;AKjfE;AACD;AAED;ALkfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKlfO;AACL;AACE;AAMD;AL+eH;AK9eE;AACD;AAED;AL+eA;AACA;AACA;AACA;AACA;AACA;AK/eA;AACE;ALifF;AKhfE;AACE;AACD;AACC;AACA;AACA;AACA;AACA;AACD;AACF;AAED;ALifA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKjfO;AACL;AACA;ALmfF;AKlfE;AACE;AACA;AACD;ALofH;AKnfE;AACE;AACA;AACD;ALqfH;AKpfE;AACE;AACA;AACD;ALsfH;AKrfE;AAYD;AAED;AL2eA;AACA;AACA;AACA;AACA;AACA;AACA;AK3eA;AACE;AACE;AACA;AACA;AACE;AACA;AACA;AACA;AACA;AL6eN;AKlfkB;AAOd;AACA;AACA;AAZU;AAcb;AAED;AL6eA;AACA;AACA;AACA;AACA;AK7eO;AACL;AACE;AACE;AADU;AAGZ;AAAc;AAAD;AACb;AACE;AACE;AACA;AAF+C;AAIjD;AACE;AACA;AAF6C;AAI/C;AACE;AACA;AACA;AAEA;AAL6C;AAO/C;AACE;AACA;AAF+C;AAhBvC;AAqBZ;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AARgB;AA1BR;AAqCb;AAED;AL+eA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AK/eO;AAAkE;AAEvE;AACA;AACA;AAAa;AAA4B;AACvC;AACA;AACA;AAHuC;ALuf3C;AKlfE;AACE;AACD;ALofH;AKnfE;AACE;AACD;ALqfH;AKpfE;AACD;AAED;ALqfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKrfO;AACL;AACE;AACD;ALufH;AKtfE;AACE;AAGA;AACA;ALsfJ;AKrfI;AACE;AACD;ALufL;AKrfI;AAAe;AAA0B;AACvC;AAAc;AAAiB;AAAlB;AACb;AACE;AACE;AACA;AACE;AACA;AACA;AACA;AAJgB;AAFC;AADX;AAF2B;ALygB7C;AKzfI;AL2fJ;AK1fI;AACE;AACA;AACD;AL4fL;AACA;AK3fI;AACA;AACA;AACD;AACC;AAMD;ALwfH;AKvfE;AACD;AAED;ALwfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKxfO;AACL;AAAuC;AAAA;AACvC;AACA;AAGD;AAED;ALyfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKzfO;AAOL;AACA;AACA;AACA;AACA;AACA;AAGA;AAKA;AAMA;AACA;AACE;AACA;AACA;AACA;AAJ+C;AAMjD;AACE;AACA;AACA;AACA;AAJmD;AAMrD;AAEA;ALyeF;AKreE;AAEA;AACA;AACD;AAED;ALqeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKreO;AACL;ALueF;AKteE;AAKE;ALoeJ;AKneI;AACE;AACD;AACF;ALqeH;AKpeE;AACD;AAED;ALqeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKreO;AACL;AAEA;AACA;AACA;ALseF;AKreE;AAME;AACD;ALkeH;AKjeE;AACA;AACA;AACD;AAED;ALkeA;AACA;AACA;AACA;AACA;AACA;AKleO;AACL;AAEI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AATF;AAYH;AAED;ALieA;AACA;AKjeA;AAEA;ALkeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKjeO;AAEP;ALkeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKneO;AACL;AACA;AACA;AAKqB;AAGb;AAA+B;AAHlB;AAMrB;AAAO;AAAyC;AAAhD;AACD;AAED;ALieA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKjeA;AAME;AAHA;AAGA;ALgeF;AKheE;AAFA;AAEA;ALoeF;AKpeE;AADA;AACA;ALweF;AKveE;AACA;AAEI;AACA;AACA;AACA;AAJc;AAMP;AAAA;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;ALweN;AKveM;AACE;AACE;AACA;AAAQ;AAAD;AACR;AL2eT;AK1eQ;AAOD;AAKC;AACE;AACA;AACA;AACA;AACA;AACA;AANK;AAQR;ALkeP;AACA;AKjeM;AAAQ;AAAD;AACR;AAEC;AACA;AACD;AACJ;AAED;ALmeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AKneO;AAAqE;AAApB;AAAoB;ALwe5E;AKveE;AACE;AAGA;AACD;ALueH;AKteE;AACA;AAGA;AACD;AAED;ALqeA;AACA;AACA;AACA;AACA;AACA;AKreO;AACL;AACD;AAED;ALseA;AACA;AACA;AACA;AACA;AACA;AKteO;AACL;ALweF;AKveE;AACE;AACE;AACE;AACD;AACF;AACF;AACF;AAED;ALweA;AACA;AACA;AACA;AACA;AACA;AKxeA;AACE;AACA;AACA;AAHiB;AAMnB;ALyeA;AACA;AACA;AACA;AACA;AKxeA;AACE;AACA;AL0eF;AKzeE;AACE;AACD;AL2eH;AK1eE;AL4eF;AK3eE;AACE;AACE;AAED;AL4eL;AK3eI;AACE;AAED;AACF;AL4eH;AK3eE;AACD;AAED;AL4eA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AK5eO;AACL;AACA;AACD;AL8eD;AACA;AACA;AACA;AACA;AACA;AACA;AMpgDA;AAAwB;ANugDxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AO9gDA;AAAwB;APihDxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AQzgDA;AR2gDA;AQ1gDA;AR4gDA;AQ3gDA;AR6gDA;AQ5gDA;AR8gDA;AQ7gDA;AR+gDA;AQ9gDA;ARghDA;AQ/gDA;ARihDA;AQhhDA;ARkhDA;AACA;AACA;AQlhDA;AACA;AAEA;ARmhDA;AACA;AACA;AACA;AQlhDA;ARohDA;AACA;AACA;AACA;AACA;AACA;AQ5gDE;AACA;AAAqB;AR+gDvB;AQ9gDI;AAEA;AR+gDJ;AQ9gDI;AAEA;AR+gDJ;AQ9gDI;AAEA;AR+gDJ;AQ9gDI;AAEA;AR+gDJ;AQ9gDI;AAEA;AR+gDJ;AQ9gDI;AAEA;AR+gDJ;AACA;AACA;AACA;AQ9gDI;AAtBmB;AAuBpB;AAED;ARghDF;AACA;AACA;AACA;AACA;AQlhDI;AACE;AACO;AAAA;ARqhDb;AQlhDM;AAKE;AACA;AACA;AAEA;AAMD;AR0gDP;AQzgDM;AAGE;AAA6B;AAE/B;AACD;AACF;AAED;ARwgDF;AACA;AACA;AQxgDI;AAAyB;AAAW;AACrC;AAED;AR2gDF;AACA;AACA;AQ3gDI;AACA;AACA;AACA;AR6gDJ;AQ5gDI;AACE;AACD;AACC;AR8gDN;AQ7gDM;AACE;AACD;AR+gDP;AACA;AQ9gDM;ARghDN;AQ9gDM;AACE;AACD;AACF;AACF;AAED;AR+gDF;AACA;AACA;AQ/gDI;AACE;AACD;AACF;AAED;ARghDF;AACA;AACA;AQhhDI;AACD;AAED;ARihDF;AACA;AACA;AACA;AACA;AACA;AQjhDI;AACE;AACD;AAED;ARkhDJ;AACA;AQlhDI;AAGA;ARkhDJ;AQjhDI;AACE;AACD;ARmhDL;AQlhDI;AACA;ARohDJ;AQnhDI;AACE;AACD;AAGD;ARmhDJ;AACA;AQnhDI;AACE;AACA;AAMD;ARghDL;AACA;AQ9gDI;AAAyB;AAAwB;AACjD;AACA;AACA;AACA;AAEA;AACD;AAED;ARghDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AQjhD4B;ARmhD5B;AQlhDI;AACE;AACD;ARohDL;AACA;AQnhDI;ARqhDJ;AQphDI;AACE;AACD;AAED;ARqhDJ;AACA;AQrhDI;ARuhDJ;AQthDI;AACE;AACD;ARwhDL;AQthDI;ARwhDJ;AQvhDI;AACE;AACD;ARyhDL;AQvhDI;AAEA;AACA;ARwhDJ;AQthDI;AACE;AACA;AACD;ARwhDL;AQthDI;ARwhDJ;AQthDI;AACE;AACD;AACC;AACE;AACD;AACF;ARwhDL;AQvhDI;AACD;AAED;ARwhDF;AACA;AACA;AACA;AACA;AACA;AACA;AQxhDI;AACE;AACD;AR0hDL;AQzhDI;AACD;AAED;AR0hDF;AACA;AACA;AQ1hDI;AACD;AAED;AR2hDF;AACA;AACA;AQ3hDI;AACD;AAED;AR4hDF;AACA;AACA;AQ7hDmB;AR+hDnB;AQ9hDI;AACA;AACA;AAAyC;AAAA;AACzC;AAA2C;AAAA;ARoiD/C;AQniDI;AACE;AACD;ARqiDL;AQpiDI;AACD;AAED;ARqiDF;AACA;AACA;AQriDI;AACE;AACA;AACD;ARuiDL;AQtiDI;AACE;AACA;AACD;ARwiDL;AQviDI;AACD;AAED;ARwiDF;AACA;AACA;AQxiDI;AR0iDJ;AQziDI;AAKE;AAAiC;AAAD;AACjC;AACC;AACD;AACF;AAED;ARwiDF;AACA;AACA;AACA;AACA;AQziDqB;AR2iDrB;AQ1iDI;AAIE;AACE;ARyiDR;AQxiDQ;AACD;AACF;AACF;AAED;ARyiDF;AACA;AACA;AACA;AACA;AACA;AQ1iDuB;AR4iDvB;AQ3iDI;AACE;AACE;AR6iDR;AQ5iDQ;AAEA;AR6iDR;AACA;AQ7iDQ;AACD;AACD;AACD;AACF;AR+iDH;AACA;AACA;AQ9iDA;ARgjDA;AACA;AACA;AACA;AACA;AACA;AACA;AQljDO;AACL;AACD;ARojDD;AACA;AACA;AACA;AACA;AACA;AACA;AS33DA;AT63DA;AS53DA;AT83DA;AS73DA;AT+3DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ASz4DE;AT24DF;ASz4DI;AACD;AAED;AT04DF;AACA;AACA;AS14DI;AACE;AACD;AT44DL;AS34DI;AACA;AACA;AACE;AACD;AACD;AACD;AAED;AT44DF;AACA;AACA;AS54DI;AACA;AACD;AT84DH;AACA;AACA;AS74DA;AT+4DA;AACA;AACA;AACA;AS/4DO;AACL;AACD;ATi5DD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AU37DA;AV67DA;AU57DA;AV87DA;AU77DA;AV+7DA;AU97DA;AVg8DA;AU/7DA;AVi8DA;AACA;AACA;AUj8DA;AAEA;AVk8DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AUr8DE;AACA;AAAqB;AVw8DvB;AUv8DI;AAEA;AVw8DJ;AUv8DI;AAJmB;AAKpB;AAED;AVy8DF;AACA;AACA;AACA;AACA;AU38DI;AACA;AACD;AAED;AV48DF;AACA;AACA;AU58DI;AACA;AAEA;AV68DJ;AU58DI;AV88DJ;AU78DI;AACE;AACA;AACA;AACA;AAKD;AV28DL;AU18DI;AAIE;AACA;AACD;AVy8DL;AACA;AUx8DI;AAGD;AAED;AVu8DF;AACA;AACA;AACA;AACA;AACA;AACA;AUx8Da;AV08Db;AUz8DI;AACE;AACA;AACA;AACD;AAED;AV08DJ;AACA;AU18DI;AAGI;AV08DR;AUz8DQ;AACE;AACD;AV28DT;AU18DQ;AAGI;AACA;AACA;AACD;AACJ;AACJ;AAED;AVy8DF;AACA;AACA;AACA;AACA;AACA;AACA;AUz8DI;AAMA;AAAO;AAAuB;AAA9B;AACD;AVy8DH;AACA;AACA;AUx8DA;AV08DA;AACA;AACA;AACA;AACA;AACA;AU58DO;AACL;AACD;AV88DD;AACA;AACA;AACA;AACA;AACA;AACA;AW/jEA;AXikEA;AWhkEA;AXkkEA;AW5jEA;AX8jEA;AACA;AACA;AW9jEA;AA+CA;AXkhEA;AACA;AACA;AACA;AACA;AACA;AWrhEE;AXuhEF;AACA;AACA;AWrhEE;AAAoC;AXwhEtC;AWvhEI;AXyhEJ;AWthEI;AXwhEJ;AWvhEI;AAEA;AXwhEJ;AACA;AWxhEI;AAEA;AXyhEJ;AWxhEI;AAXkC;AAYnC;AAED;AX0hEF;AACA;AACA;AACA;AACA;AW7hEe;AX+hEf;AW9hEI;AACA;AACA;AACE;AACA;AACA;AACD;AXgiEL;AW9hEI;AACE;AAKA;AAEE;AAAqB;AACrB;AAAqB;AAExB;AACC;AAKA;AAEE;AAAqB;AACrB;AAAqB;AAExB;AAED;AACE;AACD;AAED;AACE;AACD;AAED;AAEE;AAA+B;AAGjC;AAAsB;AAAA;AACvB;AAED;AXohEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AWphEI;AACA;AAGA;AXohEJ;AWnhEI;AXqhEJ;AWlhEI;AAEA;AAEA;AXkhEJ;AWjhEI;AACE;AACD;AXmhEL;AWlhEI;AACE;AACA;AACD;AXohEL;AWnhEI;AACA;AXqhEJ;AWphEI;AACE;AACD;AACC;AACA;AACD;AXshEL;AWrhEI;AACE;AAKA;AACD;AXmhEL;AWlhEI;AXohEJ;AWnhEI;AAKE;AACA;AXihEN;AWhhEM;AACE;AXkhER;AWjhEQ;AACE;AAGA;AACD;AACF;AXihEP;AWhhEM;AACE;AACD;AACF;AXkhEL;AWjhEI;AACD;AXmhEH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY5uEA;AZ8uEA;AY7uEA;AZ+uEA;AY5uEA;AZ8uEA;AY7uEA;AZ+uEA;AY3uEA;AZ6uEA;AY5uEA;AZ8uEA;AY7uEA;AZ+uEA;AY1uEA;AZ4uEA;AY3uEA;AZ6uEA;AY5uEA;AZ8uEA;AY7uEA;AZ+uEA;AYzuEA;AZ2uEA;AY1uEA;AZ4uEA;AYvuEA;AZyuEA;AYruEA;AZuuEA;AYtuEA;AZwuEA;AYvuEA;AZyuEA;AYxuEA;AZ0uEA;AYtuEA;AZwuEA;AYvuEA;AZyuEA;AYxuEA;AZ0uEA;AYzuEA;AZ2uEA;AY1uEA;AZ4uEA;AY3uEA;AZ6uEA;AY5uEA;AZ8uEA;AY7uEA;AZ+uEA;AY9uEA;AZgvEA;AACA;AACA;AYhvEA;AACA;AAOA;AACA;AZ4uEA;AY3uEA;AZ6uEA;AY5uEO;AAEP;AZ6uEA;AACA;AY7uEO;AAEP;AZ8uEA;AACA;AY9uEO;AAEP;AZ+uEA;AACA;AY/uEO;AAEP;AZgvEA;AACA;AYhvEO;AAEP;AZivEA;AACA;AYjvEA;AAEA;AZkvEA;AYjvEO;AAEP;AZkvEA;AACA;AYlvEO;AAEP;AZmvEA;AACA;AYnvEO;AAEP;AZovEA;AACA;AYpvEO;AAEP;AZqvEA;AACA;AYrvEO;AACL;AACA;AACA;AACA;AAJ0B;AAO5B;AZsvEA;AACA;AYtvEA;AACE;AACA;AACA;AACA;AACA;AACA;AANoC;AAStC;AZuvEA;AYtvEO;AAEP;AZuvEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYvvEO;AAEP;AZwvEA;AACA;AACA;AACA;AACA;AYxvEO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAR8B;AAWhC;AZyvEA;AACA;AACA;AACA;AACA;AYzvEA;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAT2C;AAY7C;AZ0vEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYzvEO;AAIL;AAFA;AAEA;AZ0vEF;AY1vEE;AADA;AACA;AZ8vEF;AY7vEE;AAAsB;AAAX;AAAW;AZkwExB;AYjwEI;AACE;AACD;AACC;AACE;AACE;AACA;AACA;AACA;AACD;AAEA;AACF;AAED;AZiwEN;AACA;AYjwEM;AACD;AACF;AACF;AAED;AZkwEA;AACA;AACA;AACA;AACA;AACA;AACA;AYtwEE;AACA;AZwwEF;AYtwEE;AZwwEF;AACA;AYtwEE;AAAqB;AZywEvB;AYxwEI;AACA;AACA;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AACA;AACA;AACA;AYxwEI;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AACA;AACA;AACA;AACA;AACA;AACA;AYxwEI;AAEA;AZywEJ;AYxwEI;AAEA;AZywEJ;AACA;AACA;AACA;AACA;AYxwEI;AAEA;AZywEJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYxwEI;AAKA;AZswEJ;AYrwEI;AAEA;AZswEJ;AACA;AACA;AACA;AACA;AACA;AYrwEI;AAEA;AZswEJ;AACA;AACA;AACA;AACA;AYrwEI;AAEA;AZswEJ;AACA;AACA;AACA;AACA;AYrwEI;AAEA;AZswEJ;AYrwEI;AAEA;AZswEJ;AACA;AACA;AACA;AYrwEI;AAEA;AZswEJ;AYrwEI;AAEA;AZswEJ;AACA;AACA;AACA;AACA;AYrwEI;AAEA;AZswEJ;AACA;AACA;AACA;AACA;AACA;AYrwEI;AAEA;AZswEJ;AACA;AACA;AACA;AACA;AACA;AACA;AYrwEI;AAEA;AZswEJ;AACA;AACA;AACA;AYrwEI;AApImB;AAqIpB;AAED;AZuwEF;AACA;AACA;AACA;AACA;AYzwEI;AACA;AACA;AACA;AACA;AZ2wEJ;AYzwEI;AACD;AAED;AZ0wEF;AACA;AACA;AY1wEI;AACD;AAED;AZ2wEF;AACA;AACA;AY3wEI;AACD;AAED;AZ4wEF;AACA;AACA;AACA;AACA;AY7wEkB;AZ+wElB;AY9wEI;AACE;AACA;AAFmB;AAIrB;AACA;AAKA;AAEA;AACA;AAGI;AACE;AACD;AACF;AAEH;AZwwEJ;AYvwEI;AACE;AACA;AACA;AAGO;AAHqB;AAK7B;AZuwEL;AYrwEI;AACD;AAED;AZswEF;AACA;AACA;AYtwEI;AACA;AAKE;AACD;AZowEL;AACA;AYnwEI;AACA;AACD;AAED;AZowEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYpwEI;AACD;AAED;AZqwEF;AACA;AACA;AACA;AACA;AACA;AYrwEI;AACD;AAED;AZswEF;AACA;AACA;AACA;AACA;AACA;AYtwEI;AACD;AAED;AZuwEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYvwEI;AACD;AAED;AZwwEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYxwEI;AACD;AAED;AZywEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYzwEI;AAGD;AAED;AZwwEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYzwEqC;AZ2wErC;AY1wEI;AAEA;AACA;AZ2wEJ;AY1wEI;AACE;AACE;AAAuB;AAAkB;AAC1C;AACF;AACF;AAED;AZ6wEF;AACA;AACA;AY7wEI;AACA;AACA;AACE;AACD;AZ+wEL;AY9wEI;AAEA;AZ+wEJ;AY9wEI;AZgxEJ;AY/wEI;AACE;AACD;AACF;AAED;AZgxEF;AACA;AACA;AACA;AACA;AACA;AYhxEI;AACD;AAED;AZixEF;AACA;AACA;AACA;AACA;AACA;AACA;AYjxEI;AACD;AAED;AZkxEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYlxEI;AAID;AAED;AZgxEF;AACA;AACA;AACA;AACA;AACA;AACA;AYhxEI;AZkxEJ;AYjxEI;AAIE;AAKA;AACD;AZ4wEL;AY3wEI;AACE;AAKA;AACD;AAED;AACA;AACA;AZwwEJ;AACA;AYxwEI;AACE;AACA;AAMA;AACD;AZqwEL;AYpwEI;AACD;AAED;AZqwEF;AACA;AACA;AYrwEI;AACD;AAED;AZswEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYvwEsB;AZywEtB;AYxwEI;AACE;AACD;AZ0wEL;AYzwEI;AACE;AACD;AAGD;AZywEJ;AACA;AYzwEI;AZ2wEJ;AYxwEI;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AZwwEJ;AYvwEI;AAGI;AAEA;AACA;AACA;AZswER;AYrwEQ;AZuwER;AYtwEQ;AACE;AAGD;AACF;AZswEP;AYpwEM;AAhBgB;AAkBd;AZswER;AYrwEQ;AZuwER;AYrwEQ;AACE;AAIE;AACA;AACD;AAED;AAIE;AACA;AACD;AAED;AACD;AZ+vET;AY7vEQ;AACD;AZ+vEP;AY7vEM;AA5CgB;AA8Cd;AAEA;AACA;AAEA;AAAO;AAAkC;AAAzC;AAID;AZ6vEP;AY3vEM;AAzDgB;AA2Dd;AACA;AAEA;AACA;AZ4vER;AY3vEQ;AACE;AAEA;AACD;AZ4vET;AY3vEQ;AACD;AAED;AACA;AZ4vEN;AY3vEM;AA1EgB;AA4Ed;AZ6vER;AY5vEQ;AAEA;AZ6vER;AACA;AY7vEQ;AAKE;AZ2vEV;AY1vEU;AACD;AZ4vET;AY3vEQ;AAIE;AAGD;AZwvET;AYvvEQ;AAKE;AACA;AACA;AZqvEV;AYlvEU;AACE;AZovEZ;AYnvEY;AAGD;AACF;AAED;AACA;AACA;AZkvER;AACA;AYlvEQ;AZovER;AYjvEQ;AZmvER;AYlvEQ;AAGE;AAGD;AZgvET;AY/uEQ;AZivER;AY9uEQ;AAIE;AZ6uEV;AY5uEU;AACD;AAED;AACA;AACA;AACA;AACA;AZ6uER;AACA;AY7uEQ;AACE;AACE;AACA;AACA;AZ+uEZ;AY9uEY;AACD;AZgvEX;AY/uEU;AACE;AACA;AAFK;AAIR;AACF;AACD;AA7JgB;AA+Jd;AAEA;AACA;AACA;AACA;AACA;AACA;AZgvER;AY/uEQ;AACE;AACD;AZivET;AY5vE6B;AAAA;AZ+vE7B;AYlvEQ;AZovER;AYnvEQ;AZqvER;AYpvEQ;AAKE;AACD;AZkvET;AYjvEQ;AACD;AAEC;AAEA;AACA;AZivER;AYhvEQ;AACA;AACD;AAED;AZivEN;AYhvEM;AAhMgB;AAkMd;AAEA;AACA;AACA;AZivER;AYhvEQ;AZkvER;AYjvEQ;AAIE;AACE;AACA;AACA;AACD;AZgvEX;AY/uEU;AACD;AZivET;AACA;AY/uEQ;AAEA;AZgvER;AACA;AYhvEQ;AZkvER;AYjvEQ;AAA+D;AAAA;AZqvEvE;AYjvEQ;AAA0D;AAAA;AZqvElE;AYjvEQ;AZmvER;AACA;AYlvEQ;AACO;AAAA;AAEP;AACD;AAEC;AACE;AACA;AACE;AZmvEZ;AYlvEU;AACA;AACE;AACE;AACA;AACA;AAHK;AANX;AAaA;AACA;AZmvER;AACA;AYnvEQ;AZqvER;AYpvEQ;AACD;AACJ;AAED;AZqvEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYtvE2C;AZwvE3C;AYvvEI;AACA;AAEI;AAIE;AACA;AACA;AACD;AZqvET;AYpvEQ;AACD;AAEC;AACA;AZqvER;AYpvEQ;AACE;AACE;AACA;AZsvEZ;AYrvEU;AACE;AAGA;AACF;AZqvEV;AYpvEU;AACA;AACE;AZsvEZ;AYjvEU;AAjBF;AZqwER;AYlvEQ;AACE;AACD;AZovET;AYnvEQ;AACD;AACJ;AAED;AZovEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYrvEmD;AZuvEnD;AYtvEI;AACE;AACE;AACD;AZwvEP;AYvvEM;AZyvEN;AYxvEM;AACE;AACA;AACD;AZ0vEP;AYzvEM;AACD;AACF;AAED;AZ0vEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY3vE8B;AZ6vE9B;AY5vEI;AACA;AACA;AACA;AZ8vEJ;AY7vEI;AACE;AACA;AACA;AACD;AZ+vEL;AY9vEI;AACA;AACE;AACE;AACA;AACA;AACA;AACD;AZgwEP;AY/vEM;AACE;AACA;AACA;AZiwER;AY/vEQ;AAEA;AZgwER;AACA;AYhwEQ;AAGI;AZgwEZ;AY/vEY;AZiwEZ;AACA;AYhwEY;AAGI;AAAwC;AAAO;AAGhD;AACJ;AACJ;AACF;AACF;AAED;AZ+vEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY/vEI;AACE;AACA;AACD;AZiwEL;AY/vEI;AACE;AAAkC;AAAuB;AAC1D;AACC;AACD;AZmwEL;AYlwEI;AACE;AACD;AZowEL;AACA;AYlwEI;AZowEJ;AYnwEI;AACE;AACD;AZqwEL;AACA;AYnwEI;AAAmB;AAAuB;AZuwE9C;AYrwEI;AACE;AACD;AACC;AZuwEN;AYrwEM;AACE;AACD;AACF;AACF;AAED;AZswEF;AACA;AACA;AYtwEI;AACE;AACD;AZwwEL;AYvwEI;AACD;AAED;AZwwEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYzwE4B;AZ2wE5B;AY1wEI;AACA;AACE;AACE;AACD;AZ4wEP;AY3wEM;AACD;AZ6wEL;AY5wEI;AZ8wEJ;AY5wEI;AAEI;AZ6wER;AY5wEQ;AACE;AACD;AAED;AACA;AZ6wER;AACA;AY7wEQ;AACE;AACD;AZ+wET;AY9wEQ;AACE;AACA;AACD;AZgxET;AACA;AY/wEQ;AACE;AAEA;AZgxEV;AY/wEU;AAMA;AACD;AACF;AAEC;AZ2wER;AY1wEQ;AACD;AACJ;AAED;AZ2wEF;AACA;AACA;AACA;AACA;AACA;AY3wEI;AACD;AAED;AZ4wEF;AACA;AACA;AY5wEI;AACA;AACA;AACA;AACA;AACD;AAED;AZ6wEF;AACA;AACA;AY7wEI;AACA;AACD;AAED;AZ8wEF;AACA;AACA;AACA;AACA;AACA;AY/wEiB;AZixEjB;AYhxEI;AACA;AACA;AZkxEJ;AYjxEI;AACE;AAMI;AACD;AAEC;AACA;AACA;AACA;AACD;AACJ;AZ6wEL;AY3wEI;AZ6wEJ;AY1wEI;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;AAED;AZ0wEF;AACA;AACA;AY1wEI;AZ4wEJ;AY3wEI;AACD;AAED;AZ4wEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY7wE8B;AAAf;AAAe;AZixE9B;AYhxEI;AACE;AACD;AZkxEL;AACA;AYjxEI;AACE;AACA;AACD;AZmxEL;AYlxEI;AACE;AACA;AACD;AZoxEL;AYnxEI;AACE;AACA;AACD;AACF;AAED;AZoxEF;AACA;AACA;AYpxEI;AACE;AACD;AZsxEL;AYrxEI;AACE;AACD;AACF;AAED;AZsxEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYtxEI;AACD;AAED;AZuxEF;AACA;AACA;AACA;AACA;AACA;AYvxEI;AACD;AAED;AZwxEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYzxEuB;AZ2xEvB;AY1xEI;AACA;AACE;AACE;AACD;AACF;AACF;AAED;AZ2xEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY3xEI;AZ6xEJ;AY5xEI;AACE;AACD;AZ8xEL;AY7xEI;AZ+xEJ;AY9xEI;AACE;AACA;AACA;AACD;AZgyEL;AY/xEI;AAAO;AAA6B;AAClC;AACA;AAFkC;AAApC;AAID;AAED;AZmyEF;AACA;AACA;AACA;AACA;AACA;AYnyEI;AACE;AACA;AACA;AACA;AACD;AZqyEL;AYpyEI;AAEA;AZqyEJ;AYpyEI;AACA;AACA;AACD;AAED;AZqyEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYryEI;AAGD;AAED;AZoyEF;AACA;AACA;AACA;AACA;AACA;AACA;AYpyEI;AAKD;AAED;AZiyEF;AACA;AACA;AYjyEI;AACD;AAED;AZkyEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYnyEwB;AZqyExB;AYpyEI;AACA;AACE;AACA;AACA;AAHc;AAKhB;AAGI;AACE;AACA;AACD;AAED;AACA;AACA;AZmyER;AACA;AYnyEQ;AAEE;AAAuB;AZqyEjC;AYnyEQ;AZqyER;AYpyEQ;AACE;AACA;AACA;AZsyEV;AYlyEU;AACD;AACC;AACA;AACD;AZoyET;AYnyEQ;AACD;AACJ;AAED;AZoyEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYpyEI;AACD;AAED;AZqyEF;AACA;AACA;AACA;AACA;AACA;AACA;AYryEI;AACD;AAED;AZsyEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYvyEwC;AZyyExC;AYxyEI;AACE;AAKA;AACD;AZsyEL;AACA;AYryEI;AAEA;AZsyEJ;AYryEI;AACA;AZuyEJ;AYtyEI;AAIE;AAGA;AACD;AACC;AACA;AACD;AACC;AACA;AACA;AACA;AAKD;AZ+xEL;AY9xEI;AACE;AACD;AZgyEL;AY/xEI;AACE;AZiyEN;AACA;AYhyEM;AACD;AACF;AAED;AZiyEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYlyEuC;AZoyEvC;AYnyEI;AACA;AACA;AZqyEJ;AYnyEI;AAAc;AAAmC;AAC/C;AAA0B;AAGxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AARG;AAWP;AACA;AZqyEJ;AYpyEI;AACE;AACE;AZsyER;AYryEQ;AACE;AACD;AACF;AACF;AZuyEL;AYtyEI;AACA;AAII;AACA;AACA;AAAK;AAAuB;AAC5B;AACA;AACA;AANF;AASE;AZsyER;AYryEQ;AAEE;AAIH;AAED;AACA;AACA;AZkyEN;AYhyEM;AAGA;AACA;AACE;AAMD;AACD;AACE;AZ2xER;AY1xEQ;AACD;AAGD;AACD;AACF;AAED;AZyxEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY1xEkC;AZ4xElC;AY3xEI;AAGI;AACA;AAFG;AZ8xEX;AYxxEI;AACE;AACD;AAED;AACA;AZyxEJ;AACA;AYzxEI;AACA;AAAc;AAAmC;AAC/C;AAA0B;AAE1B;AAA4B;AZ8xElC;AYzxEI;AACE;AACD;AZ2xEL;AACA;AY1xEI;AAEA;AACA;AZ2xEJ;AY1xEI;AAEE;AAAgB;AAGlB;AACE;AAMD;AACD;AACD;AAED;AZoxEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYpxEI;AACA;AAEI;AACA;AAFG;AAOR;AAED;AZixEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYjxEI;AACD;AAED;AZkxEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYnxEkD;AZqxElD;AYpxEI;AACA;AACA;AAKA;AACA;AACA;AAAkB;AAAA;AAChB;AACA;AACA;AZoxEN;AYnxEM;AACE;AACE;AACA;AZqxEV;AYpxEQ;AACE;AZsxEV;AYpxEU;AZsxEV;AYrxEQ;AACE;AACA;AACA;AASA;AApBJ;AZoyEN;AACA;AY9wEM;AZgxEN;AYzwEM;AACE;AACA;AACD;AACC;AACA;AAGD;AZywEP;AYxwEM;AAAsC;AAAgB;AAAjB;AACtC;AACF;AAED;AZ4wEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY5wEI;AACA;AZ8wEJ;AY7wEI;AACE;AACA;AZ+wEN;AY9wEM;AACE;AACD;AACF;AZgxEL;AY/wEI;AACE;AACA;AAMA;AACD;AZ4wEL;AY3wEI;AZ6wEJ;AY5wEI;AACE;AACA;AAMA;AACD;AZywEL;AYxwEI;AACE;AAGA;AZwwEN;AYtwEM;AAME;AACD;AZmwEP;AYlwEM;AZowEN;AYnwEM;AACE;AZqwER;AYnwEQ;AACE;AAID;AACF;AACC;AACD;AZkwEP;AYjwEM;AACE;AACA;AACA;AACA;AZmwER;AYlwEQ;AACE;AACD;AZowET;AYlwEQ;AZowER;AYnwEQ;AACE;AAME;AACD;AACF;AACF;AZgwEP;AY/vEM;AACE;AACA;AACD;AZiwEP;AYhwEM;AACE;AACA;AACA;AACA;AACE;AACD;AZkwET;AYjwEQ;AACA;AACD;AAED;AZkwEN;AACA;AYlwEM;AAIA;AACD;AACC;AZiwEN;AY3vEM;AACE;AACD;AZ6vEP;AY5vEM;AACD;AACF;AAED;AZ6vEF;AACA;AACA;AACA;AACA;AY7vEI;AAID;AAED;AZ2vEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY3vEI;AACE;AACA;AACD;AZ6vEL;AY5vEI;AAGA;AAAsB;AAA4B;AAC1C;AAAD;AAGP;AACD;AAED;AZ4vEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY5vEI;AACD;AAED;AZ6vEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY7vEI;AACD;AAED;AZ8vEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY9vEI;AACE;AACE;AAKD;AACC;AACD;AACF;AACC;AAKD;AACF;AAED;AZuvEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYvvEI;AACD;AAED;AZwvEF;AACA;AACA;AACA;AACA;AACA;AACA;AYxvEI;AACD;AAED;AZyvEF;AACA;AACA;AACA;AACA;AACA;AYzvEI;AACE;AACE;AAID;AACC;AAAO;AAA6B;AAApC;AACD;AACF;AZ2vEL;AY1vEI;AAGD;AAED;AZyvEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AYxvEE;AZ0vEF;AACA;AACA;AACA;AACA;AACA;AY1vEI;AACD;AAED;AZ2vEF;AACA;AACA;AACA;AACA;AACA;AY3vEI;AZ6vEJ;AY5vEI;AACE;AAID;AACC;AAID;AACF;AZwvEH;AACA;AACA;AYvvEA;AZyvEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY3vEO;AACL;AACE;AACD;AZ6vEH;AY5vEE;AZ8vEF;AY7vEE;AACE;AACD;AZ+vEH;AY9vEE;AAID;AAED;AZ4vEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AY5vEO;AACL;AACA;AAID;AZ2vED;AACA;AACA;AACA;AACA;AACA;AACA;AaptIA;AbstIA;AartIA;AbutIA;AattIA;AbwtIA;AavtIA;AbytIA;Aa5uIA;Ab8uIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AavuIA;AACO;AAEP;AbwuIA;AACA;AACA;AACA;AACA;AACA;AACA;AaxuIO;AACL;AACA;Ab0uIF;AaxuIE;Ab0uIF;AACA;AACA;AACA;AaxuIE;Ab0uIF;AaxuIE;Ab0uIF;AACA;AACA;AaxuIE;Ab0uIF;AaxuIE;Ab0uIF;AACA;AACA;AACA;AaxuIE;Ab0uIF;AaxuIE;Ab0uIF;AACA;AACA;AaxuIE;AA5BgC;AA+BlC;AbyuIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;Aa5uIE;Ab8uIF;AACA;AACA;AACA;Aa5uIE;AACE;AACA;AAEA;Ab6uIJ;Aa5uII;AAEA;Ab6uIJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;Aa5uII;AAEA;Ab6uIJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;Aa5uII;AAID;AAED;Ab0uIF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;Aa5uII;AACE;AACA;AACA;AAAqC;AAAS;AAAV;AACrC;AACF;AAED;AbgvIF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AahvII;AbkvIJ;AajvII;AACE;AACD;AbmvIL;AalvII;AACA;AbovIJ;AanvII;AACE;AACA;AAIA;AACD;AbkvIL;AajvII;AAMD;AAED;Ab6uIF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AazuII;Ab2uIJ;Aa1uII;AACE;AACA;AACD;Ab4uIL;Aa3uII;AACA;AAKA;AACE;AACE;AACA;AACA;AACD;AbyuIP;AaxuIM;Ab0uIN;AazuIM;AACE;AACA;AACA;AAKE;AACE;AACA;AACA;AACD;AbuuIX;AatuIU;AACD;AbwuIT;AatuIQ;AAMD;AACC;AACA;AACD;AACC;AACE;AACE;AACA;AACA;AACD;AbmuIX;AaluIU;AbouIV;AanuIU;AACQ;AAAA;AAKJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;AAEJ;AACF;AACF;AACF;AAED;AbguIF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AajuIwD;AbmuIxD;AaluII;AbouIJ;AanuII;AACE;AACD;AbquIL;AACA;AapuII;AAEI;AACA;AACA;AACA;AACA;AACA;AANc;AAUZ;AACA;AACA;AACA;AACA;AACA;AAIA;AAKA;AAEI;AAAe;AAA4B;AAE3C;AACA;AACA;Ab4tId;Aa3tIc;AACE;AAIA;AACD;Ab0tIf;AaztIc;AACE;AACE;AAID;AACC;AACA;AAGI;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACD;AACJ;AACF;AACD;AACD;AAEC;AACA;AAIA;AACD;AAEJ;AAEC;AACA;AACA;AACA;AACA;AACA;AACE;AACA;AAID;Ab0sIX;AazsIU;AACD;AAEN;Ab0sIH;AACA;AACA;AazsIA;Ab2sIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;Aa7sIA;AACE;AAID;Ab4sID;AACA;AACA;AACA;AACA;AACA;AACA;ActnJA;AdwnJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ActnJA;AdwnJA;AACA;AACA;AACA;AACA;AACA;ActnJO;AACL;AACA;AACA;AACD;AdwnJD;AACA;AACA;AACA;AACA;AACA;AACA;AezoJA;Af2oJA;Ae1oJA;Af4oJA;Ae3oJA;Af6oJA;Ae/pJA;AfiqJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;Ae5pJE;AACA;AACE;AACA;AACA;Af8pJJ;Ae7pJI;AACA;Af+pJJ;Ae9pJI;AACA;AfgqJJ;Ae/pJI;AACA;AfiqJJ;AehqJI;AACA;AfkqJJ;AejqJI;AACA;AfmqJJ;AelqJI;AACA;AfoqJJ;AenqJI;AACA;AfqqJJ;AepqJI;AACA;AfsqJJ;AerqJI;AACD;AAED;AfsqJF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AezqJwB;AAEpB;AACA;AACA;Af0qJJ;AevqJI;AAAqC;AAAO;AAC5C;AACA;AACA;AACA;Af2qJJ;AezqJI;AACE;AACD;Af2qJL;Ae1qJI;AACE;Af4qJN;Ae3qJM;AACE;AACA;AACD;AACF;Af6qJL;Ae5qJI;AACE;AACD;Af8qJL;Ae7qJI;AACE;AACD;Af+qJL;Ae9qJI;AACD;AAED;Af+qJF;AACA;AACA;AACA;AACA;AACA;AACA;Ae/qJI;AACE;AACD;AfirJL;AehrJI;AACE;AfkrJN;AejrJM;AACE;AACE;AACD;AfmrJT;AelrJQ;AforJR;AenrJQ;AACE;AACE;AACA;AAFoB;AAIvB;AfqrJT;AeprJQ;AACE;AACE;AACA;AAFoB;AAIvB;AACF;AfsrJP;AerrJM;AAKE;AACD;AfmrJP;AelrJM;AAKE;AACD;AACF;AACF;AAED;Af+qJF;AACA;AACA;AACA;AACA;AACA;Ae/qJI;AAAqB;AAAD;AfmrJxB;AelrJI;AACE;AACD;AforJL;AenrJI;AACD;AAED;AforJF;AACA;AACA;AACA;AACA;AACA;AeprJI;AACE;AACD;AfsrJL;AerrJI;AACE;AACD;AACF;AAED;AfsrJF;AACA;AACA;AACA;AACA;AACA;AetrJI;AfwrJJ;AevrJI;AACE;AACA;AACA;AACA;AfyrJN;AexrJM;AACE;AACD;Af0rJP;AezrJM;AACE;AACD;Af2rJP;Ae1rJM;AACE;AACD;Af4rJP;Ae3rJM;AACE;AACA;AAFqB;AAIxB;AACF;AAED;Af4rJF;AACA;AACA;AACA;AACA;AACA;AACA;Ae5rJI;Af8rJJ;Ae7rJI;AACE;AACA;Af+rJN;Ae9rJM;AACE;AACA;AACD;AfgsJP;Ae/rJM;AACE;AfisJR;AehsJQ;AACE;AACD;AACF;AfksJP;AejsJM;AAIE;AACD;AACF;AACF;AAED;Af+rJF;AACA;AACA;AACA;AACA;AACA;AACA;Ae/rJI;AACA;AfisJJ;AehsJI;AACE;AACG;AAAO;AACV;AACG;AAAO;AACV;AACA;AAGD;AfksJL;AejsJI;AACD;AAED;AfksJF;AACA;AACA;AACA;AACA;AACA;AACA;AelsJI;AACE;AfosJN;AensJM;AACE;AACA;AAA6C;AAAO;AACpD;AACA;AACA;AACD;AACF;AACF;AACD;AfusJF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AevsJI;AfysJJ;AexsJI;AACE;AACE;AACD;Af0sJP;AezsJM;Af2sJN;Ae1sJM;AACE;AACA;AAAkC;AAAO;AACzC;AACA;AACA;AACA;AACD;AACF;AACF;AACD;Af8sJF;AACA;AACA;AACA;AACA;Ae9sJI;AACE;AACA;AfgtJN;Ae/sJM;AACE;AACA;AfitJR;AehtJQ;AACE;AACD;AACC;AACD;AfktJT;AejtJQ;AACE;AACA;AACE;AACA;AAF+B;AAIlC;AACF;AACF;AACF;AfmtJH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgB1/JA;AhB4/JA;AgB3/JA;AhB6/JA;AgB5/JA;AhB8/JA;AgB7/JA;AhB+/JA;AgB9/JA;AhBggKA;AACA;AACA;AgBhgKA;AhBkgKA;AACA;AACA;AACA;AACA;AACA;AgBpgKE;AhBsgKF;AACA;AgBpgKE;AAAqB;AhBugKvB;AgBtgKI;AAEA;AhBugKJ;AgBtgKI;AACA;AhBwgKJ;AgBvgKI;AANmB;AAOpB;AAED;AhBygKF;AACA;AACA;AACA;AACA;AgB3gKI;AhB6gKJ;AgBxgKI;AACD;AAED;AhBygKF;AACA;AACA;AgBzgKI;AACA;AACA;AACA;AhB2gKJ;AgB1gKI;AACE;AACA;AACD;AhB4gKL;AgB3gKI;AACD;AAED;AhB4gKF;AACA;AACA;AgB5gKI;AACD;AAED;AhB6gKF;AACA;AACA;AgB9gKwB;AhBghKxB;AgB/gKI;AACE;AACE;AACD;AhBihKP;AgBphKwD;AAO9C;AAAoD;AAPN;AAUlD;AACA;AhBghKN;AgB/gKM;AACE;AACc;AAER;AACA;AAFkD;AAD1C;AAMf;AhBghKP;AACA;AgB9gKM;AACD;AACF;AAED;AhB+gKF;AACA;AACA;AACA;AACA;AACA;AACA;AgB/gKI;AACA;AhBihKJ;AgB9gKI;AACE;AACD;AACC;AACD;AACC;AACD;AhBghKL;AgB/gKI;AACE;AACD;AhBihKL;AgB/gKI;AACA;AhBihKJ;AgB9gKI;AhBghKJ;AgB/gKI;AACE;AACD;AhBihKL;AgB/gKI;AAAsB;AAAO;AAC7B;AACA;AAMA;AACD;AhB8gKH;AACA;AACA;AACA;AACA;AgB/gKA;AACE;AACD;AhBihKD;AACA;AACA;AACA;AACA;AACA;AACA;AiBlpKA;AjBopKA;AiBnpKA;AjBqpKA;AiBrqKA;AjBuqKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiBpqKE;AACA;AACE;AACA;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAjBqB;AAmBxB;AAED;AjBqqKF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiBvqKI;AACE;AACD;AACF;AAED;AjBwqKF;AACA;AACA;AACA;AACA;AACA;AACA;AiBxqKI;AACE;AACA;AACD;AACF;AAED;AjByqKF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiBzqKI;AACE;AACE;AjB2qKR;AiB1qKQ;AACE;AACE;AACA;AjB4qKZ;AiB3qKU;AACE;AACA;AjB6qKZ;AiB5qKU;AACE;AACA;AjB8qKZ;AiB7qKU;AACE;AACA;AjB+qKZ;AiB9qKU;AACE;AACA;AjBgrKZ;AiB/qKU;AACE;AACE;AACD;AjBirKb;AiBpsKQ;AAqBD;AjBkrKP;AiBjrKM;AACE;AACD;AjBmrKP;AiBlrKM;AACD;AjBorKL;AiBlrKI;AACD;AAED;AjBmrKF;AACA;AACA;AACA;AACA;AACA;AACA;AiBnrKI;AACE;AACA;AACD;AjBqrKL;AiBprKI;AACE;AACA;AACD;AACF;AAED;AjBqrKF;AACA;AACA;AACA;AACA;AACA;AACA;AiBrrKI;AACA;AACA;AjBurKJ;AiBnrKI;AACE;AjBqrKN;AiBprKM;AAKE;AACA;AACD;AjBkrKP;AiBjrKM;AACA;AACD;AjBmrKL;AiBlrKI;AAYE;AACA;AACD;AjByqKL;AiBxqKI;AAKE;AACA;AACD;AjBsqKL;AiBrqKI;AAME;AACA;AACD;AjBkqKL;AiBjqKI;AACE;AACD;AACF;AAED;AjBkqKF;AACA;AACA;AACA;AACA;AACA;AACA;AiBlqKI;AACE;AACA;AACD;AjBoqKL;AiBnqKI;AACE;AACA;AACD;AjBqqKL;AiBpqKI;AAIE;AACA;AACD;AjBmqKL;AiBlqKI;AACE;AACD;AACF;AAED;AjBmqKF;AACA;AACA;AACA;AACA;AACA;AACA;AiBnqKI;AjBqqKJ;AiBpqKI;AACE;AAIE;AACA;AACD;AjBmqKP;AiBlqKM;AACE;AACA;AACD;AjBoqKP;AiBnqKM;AACD;AjBqqKL;AiBpqKI;AACE;AACA;AACD;AjBsqKL;AiBrqKI;AACE;AACA;AACD;AjBuqKL;AiBtqKI;AACE;AACD;AACF;AAED;AjBuqKF;AACA;AACA;AACA;AACA;AACA;AACA;AiBvqKI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;AjBsqKH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkBh8KA;AlBk8KA;AkBl9KA;AlBo9KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkBh9KA;AACA;AAEA;AlBi9KA;AkBh9KA;AAEA;AlBi9KA;AACA;AACA;AACA;AACA;AACA;AkBh9KO;AACL;AACA;AAOD;AlB48KD;AACA;AACA;AACA;AACA;AACA;AACA;AmBz/KA;AnB2/KA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmBz/KA;AACA;AACA;AnB2/KA;AACA;AACA;AACA;AACA;AACA;AmB1/KO;AACL;AACA;AAMD;AnBu/KD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoBjhLA;ApBmhLA;AoBlhLA;ApBohLA;AoBnhLA;ApBqhLA;AoBtiLA;ApBwiLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoBliLA;ApBoiLA;AACA;AACA;AACA;AoBliLA;AAEA;ApBmiLA;AoBliLA;AACA;ApBoiLA;AoBniLA;AAEA;ApBoiLA;AACA;AACA;AACA;AoBniLO;AACL;AACD;AAED;ApBoiLA;AACA;AoBpiLO;AACL;AACD;AAED;ApBqiLA;AACA;AACA;AACA;AACA;AACA;AoBriLO;AACL;ApBuiLF;AoBtiLE;AACE;AACD;AAED;ApBuiLF;AACA;AoBviLE;AACE;AACD;ApByiLH;AoBxiLE;AAIA;AAIA;AACA;AACD;AAED;ApBmiLA;AACA;AACA;AACA;AACA;AACA;AoBniLO;AACL;AACE;AACD;ApBqiLH;AoBpiLE;ApBsiLF;AoBpiLE;AACE;AACA;AACA;AACD;ApBsiLH;AoBpiLE;AAII;AACE;AACA;AACA;AACD;AACF;AACJ;ApBmiLD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqB/nLA;ArBioLA;AqBhoLA;ArBkoLA;AqBjoLA;ArBmoLA;AqBloLA;ArBooLA;AqBvpLA;ArBypLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqBlpLA;AACA;AACO;AACL;AACA;AACA;AACA;AAJuB;AAOzB;ArBmpLA;AACA;AqBnpLO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AA/ByB;AAkC3B;ArBgpLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqBjpLO;AACL;AAMD;AAED;ArB6oLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqB7oLO;AAKL;AAFA;AAEA;ArB6oLF;AqB7oLE;AADA;AACA;ArBipLF;AqBhpLE;AACA;AACA;AACA;AACA;AACD;AAED;ArBipLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqBjpLO;AACL;AACE;AACD;ArBmpLH;AqBlpLE;AACA;ArBopLF;AqBnpLE;AACE;AACD;AACC;AACA;AACD;AACF;AAED;ArBopLA;AACA;AACA;AACA;AACA;AACA;AqBppLO;AACL;AAKD;AAED;ArBipLA;AACA;AqBjpLO;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ArBkpLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsB7yLA;AtB+yLA;AsB9yLA;AtBgzLA;AsB/yLA;AtBizLA;AsBhzLA;AtBkzLA;AsBjzLA;AtBmzLA;AsBlzLA;AtBozLA;AsBnzLA;AtBqzLA;AsBpzLA;AtBszLA;AsBrzLA;AtBuzLA;AsBtzLA;AtBwzLA;AsBj1LA;AtBm1LA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsBt0LA;AACA;AAEA;AtBu0LA;AsBt0LA;AAEA;AtBu0LA;AsBt0LA;AAEA;AtBu0LA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsBt0LA;AACE;AACA;AACA;AACA;AtBw0LF;AsBt0LE;AACA;AACA;AACA;AACA;AACD;AAED;AtBu0LA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsBv0LO;AAML;AAAA;AAAA;AtBs0LF;AsBr0LE;AACA;AACA;AAKA;AAMA;AAAe;AAAmC;AtBg0LpD;AsB5zLE;AACE;AACD;AtB8zLH;AsB7zLE;AAEA;AACA;AAEA;AACA;AACA;AtB6zLF;AsB5zLE;AAEI;AACA;AACA;AACA;AACA;AALG;AASP;AACA;AACA;AtB2zLF;AsBzzLE;AACE;AACD;AtB2zLH;AsB1zLE;AACE;AACD;AtB4zLH;AsB3zLE;AACE;AACD;AtB6zLH;AsB5zLE;AACE;AACD;AtB8zLH;AsB7zLE;AACA;AACA;AtB+zLF;AsB9zLE;AACE;AACA;AACD;AAED;AACA;AtB+zLF;AACA;AsB/zLE;AACA;AtBi0LF;AsBh0LE;AACE;AACD;AtBk0LH;AsBj0LE;AAIA;AACD;AAED;AtB+zLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsB/zLO;AAAwD;AtBk0L/D;AsBh0LE;AACE;AACA;AACA;AACE;AACD;AACF;AtBk0LH;AsBj0LE;AtBm0LF;AsBl0LE;AACE;AtBo0LJ;AsBn0LI;AACE;AAID;AtBk0LL;AsBj0LI;AACE;AACD;AACF;AACF;AAED;AtBk0LA;AACA;AACA;AACA;AACA;AACA;AACA;AsBl0LO;AACL;AACA;AAGA;AtBk0LF;AsBj0LE;AAGA;AACD;AAED;AtBg0LA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsBh0LO;AAKL;AAGA;AACD;AAED;AtB2zLA;AACA;AACA;AACA;AsB3zLO;AACL;AACD;AAED;AtB4zLA;AACA;AACA;AACA;AsB5zLO;AACL;AACD;AAED;AtB6zLA;AACA;AACA;AACA;AACA;AACA;AACA;AsB7zLO;AACL;AtB+zLF;AsB9zLE;AACE;AACD;AtBg0LH;AACA;AsB/zLE;AAGA;AAMD;AAED;AtByzLA;AACA;AACA;AACA;AACA;AACA;AACA;AsBzzLO;AACL;AASD;AAED;AtBkzLA;AACA;AACA;AACA;AACA;AsBlzLA;AACE;AtBozLF;AsBnzLE;AACE;AACD;AtBqzLH;AsBpzLE;AACD;AAED;AtBqzLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsBrzLO;AACL;AACD;AAED;AtBszLA;AACA;AACA;AACA;AACA;AACA;AsBtzLO;AACL;AtBwzLF;AsBvzLE;AACE;AACA;AACA;AACA;AACD;AACC;AACA;AACD;AtByzLH;AsBxzLE;AACD;AAED;AtByzLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsBzzLA;AACE;AtB2zLF;AsBxzLE;AACE;AACD;AtB0zLH;AsBzzLE;AACA;AAOA;AACA;AtBqzLF;AsBpzLE;AACA;AAUA;AACD;AAED;AtB4yLA;AACA;AACA;AACA;AACA;AACA;AsB5yLO;AACL;AACE;AACD;AAED;AtB6yLF;AACA;AsB7yLE;AAEE;AACA;AAEA;AACA;AAGF;AtB2yLF;AsB1yLE;AAGE;AACA;AAEA;AAEA;AACA;AAEA;AAIF;AACA;AACA;AACA;AtBoyLF;AsBnyLE;AACE;AtBqyLJ;AsBpyLI;AACE;AACA;AACD;AACF;AtBsyLH;AsBryLE;AACD;AAED;AtBsyLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsBtyLO;AACL;AtBwyLF;AsBvyLE;AACE;AACD;AtByyLH;AsBxyLE;AACD;AAED;AtByyLA;AACA;AACA;AACA;AACA;AsBzyLO;AACL;AACD;AtB2yLD;AACA;AACA;AACA;AACA;AACA;AACA;AuBpuMA;AvBsuMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuBpuMA;AvBsuMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuBpuMO;AAEP;AvBquMA;AACA;AuBruMO;AAEP;AvBsuMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuBtuMO;AACL;AACA;AAFyB;AvB2uM3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwB5wMA;AxB8wMA;AwB7wMA;AxB+wMA;AwB9wMA;AxBgxMA;AwBlyMA;AxBoyMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwB9xMA;AxBgyMA;AACA;AACA;AACA;AACA;AwB9xMO;AACL;AxBgyMF;AwB/xME;AACE;AACD;AxBiyMH;AwBhyME;AAKD;AAED;AxB6xMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwB7xMO;AAML;AxB0xMF;AwBxxME;AACE;AACE;AACD;AxB0xML;AwBzxMI;AAGM;AACA;AACA;AAHF;AAQA;AACA;AACA;AACD;AACJ;AAED;AxBqxMF;AACA;AwBrxME;AAGI;AACA;AACA;AACD;AACJ;AxBqxMD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyB91MA;AzBg2MA;AyB/1MA;AzBi2MA;AyBh2MA;AzBk2MA;AyBp3MA;AzBs3MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyB/2MA;AAEA;AzBg3MA;AACA;AACA;AACA;AyB/2MA;AACE;AACA;AACA;AACA;AAJiB;AAOnB;AzBg3MA;AACA;AACA;AACA;AACA;AACA;AACA;AyB/2MA;AAAkC;AAAA;AzBm3MlC;AACA;AyBj3ME;AACD;AAED;AzBk3MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyBl3MO;AACL;AACA;AACA;AzBo3MF;AyBn3ME;AACE;AACE;AACA;AACA;AACA;AACD;AACC;AACA;AACA;AACA;AACD;AzBq3ML;AyBp3MI;AACD;AzBs3MH;AyBr3ME;AACD;AAED;AzBs3MA;AACA;AACA;AACA;AACA;AACA;AACA;AyBt3MO;AACL;AACE;AzBw3MJ;AyBv3MI;AACE;AACE;AACD;AzBy3MP;AyBx3MM;AACD;AzB03ML;AyBz3MI;AACD;AzB23MH;AyB13ME;AACD;AAED;AzB23MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyB33MO;AACL;AACE;AzB63MJ;AyB53MI;AACE;AACD;AACF;AAED;AACA;AACA;AzB63MF;AACA;AyB73ME;AACD;AzB+3MD;AACA;AACA;AACA;AACA;AACA;AACA;A0Bz/MA;A1B2/MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Bz/MA;A1B2/MA;AACA;AACA;A0Bz/MO;AACL;AACA;AACA;AACA;AAA2C;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAZuB;A1BygNzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2BphNA;A3BshNA;A2BtiNA;A3BwiNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2BpiNA;A3BsiNA;AACA;AACA;AACA;AACA;AACA;A2BpiNO;AACL;AACE;AACE;AACD;A3BsiNL;A2BriNI;AACD;AACF;A3BuiND;AACA;AACA;AACA;AACA;AACA;AACA;A4B7jNA;A5B+jNA;A4B9jNA;A5BgkNA;A4B/jNA;A5BikNA;A4BhkNA;A5BkkNA;A4BrlNA;A5BulNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4B/kNA;A5BilNA;A4B/kNA;AAEA;A5BglNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BllNE;A5BolNF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BllNI;AAID;AAED;A5BglNF;AACA;AACA;AACA;AACA;A4BhlNE;AACE;AACA;AAEA;A5BilNJ;A4BhlNI;AAEA;A5BilNJ;A4BhlNI;AAEA;A5BilNJ;AACA;AACA;A4BhlNI;AACD;AAED;A5BilNF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BnlNI;AACE;AACD;A5BqlNL;A4BplNI;AACD;AAED;A5BqlNF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BrlNI;AACE;AACA;AACA;AACA;AAJkB;AAMpB;AACD;AAED;A5BslNF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BtlNI;AAOA;AACD;A5BklNH;AACA;AACA;A4BjlNA;A5BmlNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BvlNE;A5BylNF;AACA;AACA;AACA;AACA;AACA;A4BvlNE;AACE;AACA;AAEA;A5BwlNJ;A4BvlNI;AAEA;A5BwlNJ;A4BvlNI;A5BylNJ;A4BxlNI;AACE;AACA;AACE;AACA;AACA;AACA;AACA;AACA;AANkB;AAQrB;AAED;A5BylNJ;AACA;A4BzlNI;AAEA;A5B0lNJ;A4BzlNI;AAEA;AACA;A5B0lNJ;A4BxlNI;AACA;A5B0lNJ;A4BxlNI;A5B0lNJ;A4BzlNI;AAEA;A5B0lNJ;A4BzlNI;AAEA;AAEA;A5BylNJ;A4BxlNI;AAEA;A5BylNJ;A4BxlNI;AAEA;A5BylNJ;A4BxlNI;AAEA;A5BylNJ;A4BxlNI;AACE;AADyD;A5B4lN/D;A4BxlNI;AACE;AACD;AACC;AACA;AAAe;AAAc;AAAO;AAAU;AAC/C;AACF;AAED;A5B6lNF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4B/lNI;AACE;AACD;A5BimNL;A4BhmNI;AACD;AAED;A5BimNF;AACA;AACA;AACA;AACA;AACA;AACA;A4BjmNI;AACA;AACD;AAED;A5BkmNF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BlmNI;AAAe;AAAc;AAAO;AAAU;AAC/C;AAED;A5BumNF;AACA;AACA;AACA;AACA;AACA;AACA;A4BvmNI;AACE;AACD;A5BymNL;A4BxmNI;A5B0mNJ;A4BzmNI;AACE;AACA;AACE;AACE;AACD;AACF;A5B2mNP;A4B1mNM;AACE;AACE;AACA;AACE;AACD;AACF;AACC;AACA;AACE;AACD;AACF;AACF;AACC;AACA;AACD;AACF;A5B4mNL;A4B3mNI;AACE;AACD;AACC;AACD;AACF;AAED;A5B4mNF;AACA;AACA;AACA;AACA;AACA;A4B5mNI;AACE;AACD;A5B8mNL;A4B7mNI;AACA;A5B+mNJ;A4BzmNI;AACE;A5B2mNN;A4B1mNM;AACE;AACD;AACF;A5B4mNL;AACA;A4B1mNI;AACE;A5B4mNN;A4B3mNM;AACE;AACD;A5B6mNP;A4B5mNM;AACD;A5B8mNL;AACA;A4B5mNI;AACE;AAAe;AAAc;AAAM;AAAU;AAC9C;AACC;AACE;AACD;AACC;AACA;AAAe;AAAc;AAAO;AAAU;AAC/C;AACF;AACF;AAED;A5BqnNF;AACA;AACA;AACA;AACA;AACA;A4BrnNI;AACA;A5BunNJ;A4BtnNI;AACE;AAIA;A5BqnNN;A4BpnNM;AACE;AACE;AACD;AACC;AACA;AAAe;AAAc;AAAO;AAAU;AAC9C;AACD;AACF;AACF;AACC;AACA;AACD;A5B0nNL;A4BznNI;AACE;AACD;A5B2nNL;A4B1nNI;AACE;AACD;AACC;AACA;AAAe;AAAc;AAAO;AAAU;AAC9C;AACD;AACF;A5BgoNH;AACA;AACA;A4B/nNA;A5BioNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BjoNA;AAEA;A5BkoNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4BjoNA;A5BmoNA;AACA;AACA;AACA;AACA;AACA;AACA;A6B//NA;A7BigOA;A6BhgOA;A7BkgOA;A6BjgOA;A7BmgOA;A6BlgOA;A7BogOA;A6BngOA;A7BqgOA;A6BpgOA;A7BsgOA;A6BrgOA;A7BugOA;A6BtgOA;A7BwgOA;A6B/hOA;A7BiiOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BthOA;A7BwhOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BxhOE;AACA;AACE;AACA;AACA;A7B0hOJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BvhOI;A7ByhOJ;A6BxhOI;AAEA;A7ByhOJ;A6BxhOI;AAEA;A7ByhOJ;A6BxhOI;AAEA;A7ByhOJ;A6BxhOI;AAEA;A7ByhOJ;AACA;AACA;AACA;AACA;AACA;AACA;A6BxhOI;AAEA;A7ByhOJ;A6BxhOI;AAEA;A7ByhOJ;A6BxhOI;AACD;AAED;A7ByhOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B3hOI;AACD;AAED;A7B4hOF;AACA;AACA;AACA;AACA;AACA;A6B5hOI;AACD;AAED;A7B6hOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B7hOI;AACD;AAED;A7B8hOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B9hOI;AAGD;AAED;A7B6hOF;AACA;AACA;A6B7hOI;AACD;AAED;A7B8hOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B9hOI;AACD;AAED;A7B+hOF;AACA;AACA;AACA;AACA;AACA;AACA;A6B/hOI;AACD;AAED;A7BgiOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BhiOI;AACD;AAED;A7BiiOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BjiOI;AACD;AAED;A7BkiOF;AACA;AACA;AACA;AACA;AACA;A6BliOI;AACD;AAED;A7BmiOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BniOI;AACD;AAED;A7BoiOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BpiOI;A7BsiOJ;A6BriOI;AACE;AAED;A7BsiOL;A6BriOI;AACD;AAED;A7BsiOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BtiOI;AACD;AAED;A7BuiOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BviOI;AACD;AAED;A7BwiOF;AACA;AACA;AACA;AACA;A6BxiOI;AACD;AAED;A7ByiOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BziOI;AACA;AACD;AAED;A7B0iOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BxiOE;A7B0iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BxiOE;A7B0iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BxiOE;A7B0iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BxiOE;A7B0iOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BxiOE;A7B0iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B1iOI;AACD;AAED;A7B2iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B3iOI;AACD;AAED;A7B4iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B5iOI;AACD;AAED;A7B6iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B7iOI;AACD;AAED;A7B8iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B9iOI;AACA;AACD;AAED;A7B+iOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B/iOI;AACD;AAED;A7BgjOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BhjOI;AACD;AAED;A7BijOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BjjOI;AACD;AAED;A7BkjOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BljOI;AACD;AAED;A7BmjOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BljOE;A7BojOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BnjOE;A7BqjOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BpjOE;A7BsjOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BtjOI;AACD;AAED;A7BujOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BvjOI;AACD;AAED;A7BwjOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BxjOI;AACD;AAED;A7ByjOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BzjOI;AACD;AAED;A7B0jOF;AACA;AACA;A6B1jOI;AACE;AACD;AACF;AAED;A7B2jOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B5jO8D;AAA7B;AAA6B;A7BgkO9D;A6B/jOI;AACA;AAA0B;AAAS;AAAV;AAC1B;AAED;A7BmkOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BhkOI;AAFA;AAEA;A7BokOJ;A6BpkOI;AADA;AACA;A7BwkOJ;A6BvkOI;AAKA;AACA;AACD;AAED;A7BokOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BrkO4C;A7BukO5C;A6BpkOI;AACE;AACD;A7BskOL;A6BrkOI;AACA;AAPwC;AASxC;AATwC;AAAA;A7BklO5C;A6BvkOI;AACE;AACD;AACF;AAED;A7BwkOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BxkOI;A7B0kOJ;A6BzkOI;AACE;AACA;A7B2kON;A6B1kOM;AACE;AACD;AACC;AACD;AACF;AACF;AAED;A7B2kOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B5kOiC;A7B8kOjC;A6B7kOI;AAAuE;AAEnE;AACD;AAHoE;AAMvE;AAAO;AAAkC;AAAA;AAAlC;AACR;AAED;A7BilOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BjlOI;AACD;AAED;A7BklOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BllOI;AACD;AAED;A7BmlOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BnlOI;AACD;AAED;A7BolOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BplOI;AACD;AAED;A7BqlOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BrlOI;AAAmC;AAAD;AACnC;AAED;A7BwlOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BxlOI;AACD;AAED;A7BylOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BzlOI;AACD;AAED;A7B0lOF;AACA;AACA;AACA;AACA;AACA;A6B1lOI;AACD;AAED;A7B2lOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B3lOI;AACD;AAED;A7B4lOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B5lOI;AACD;AAED;A7B6lOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6B7lOI;A7B+lOJ;A6B9lOI;AACE;AACD;AACF;AAED;A7B+lOF;AACA;AACA;AACA;AACA;AACA;A6B/lOI;AACD;AAED;A7BgmOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BhmOI;AACD;AAED;A7BimOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BjmOI;AAEG;AAAO;AAAoC;AAAe;AAC9D;AAED;A7BomOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BpmOI;AACD;AAED;A7BqmOF;AACA;AACA;AACA;AACA;AACA;A6BrmOI;AACD;AAED;A7BsmOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BtmOI;AAE8C;AAAe;AAC9D;AAED;A7BumOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BvmOI;AAMI;AAAgB;AAGrB;AAED;A7BkmOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BlmOI;AACD;AAED;A7BmmOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BnmOI;AACD;AAED;A7BomOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BpmOI;AAGD;AAED;A7BmmOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BjmOE;A7BmmOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BnmOI;AACD;AAED;A7BomOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BlmOE;A7BomOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BlmOE;A7BomOF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6BnmOE;A7BqmOF;AACA;AACA;AACA;AACA;AACA;AACA;A6BpmOE;A7BsmOF;AACA;AACA;AACA;AACA;A6BtmOI;AACD;A7BwmOH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BxlQA;A9B0lQA;A8BzlQA;A9B2lQA;A8B1lQA;A9B4lQA;A8B3lQA;A9B6lQA;A8B5lQA;A9B8lQA;A8B7lQA;A9B+lQA;A8B9lQA;A9BgmQA;AACA;AACA;AACA;AACA;A8BlmQA;A9BomQA;AACA;A8BlmQA;AAEA;A9BmmQA;AACA;AACA;A8BlmQA;AAEA;A9BmmQA;AACA;AACA;A8BlmQA;AAEA;A9BmmQA;AACA;AACA;AACA;AACA;A8BlmQA;AACE;AACA;AACD;AAED;A9BmmQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BnmQO;AACL;AACE;AACA;AACD;A9BqmQH;A8BpmQE;AACA;A9BsmQF;A8BrmQE;AACE;AACE;AACD;AACF;AACF;AAED;A9BsmQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BtmQO;AACL;AACE;AACA;AACD;A9BwmQH;A8BvmQE;AACA;AACD;AAED;A9BwmQA;AACA;AACA;AACA;AACA;A8BxmQO;AACL;AACD;AAED;A9BymQA;AACA;AACA;AACA;AACA;AACA;AACA;A8BzmQO;AACL;AACD;AAED;A9B0mQA;AACA;AACA;AACA;A8B1mQO;AACL;AACD;AAED;A9B2mQA;AACA;AACA;AACA;AACA;AACA;AACA;A8B3mQO;AACL;AACA;A9B6mQF;A8B5mQE;AACE;AACE;AAAsB;AAAmB;AACvC;AACD;AACF;AACC;AACD;AACF;A9BgnQH;A8B/mQE;AACE;AACD;AACF;AAED;A9BgnQA;AACA;AACA;AACA;AACA;A8BhnQO;AACL;AACA;AACA;AAH2B;AAM7B;A9BinQA;AACA;A8BjnQA;AACE;AACA;AAFgB;AAKlB;A9BknQA;AACA;AACA;AACA;AACA;AACA;AACA;A8BnnQE;A9BqnQF;AACA;A8BnnQE;AACE;AACA;AAEA;A9BonQJ;A8BnnQI;AACD;AAED;A9BonQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BtnQI;AACE;AACD;A9BwnQL;A8BvnQI;A9BynQJ;A8BxnQI;AACE;AACD;AACC;AACA;AACD;AACF;AAED;A9BynQF;AACA;AACA;AACA;AACA;AACA;A8BznQI;AACD;AAED;A9B0nQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BxnQE;A9B0nQF;AACA;AACA;AACA;AACA;AACA;AACA;A8B1nQI;AACA;AACD;AAED;A9B2nQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8B3nQI;AACA;AACD;A9B6nQH;AACA;AACA;A8B5nQA;A9B8nQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BloQE;A9BooQF;AACA;AACA;AACA;A8BloQE;AAA6B;A9BqoQ/B;A8BpoQI;AAEA;A9BqoQJ;A8BpoQI;AAJ2B;AAK5B;AAED;A9BsoQF;AACA;AACA;AACA;AACA;A8BxoQI;AACA;AACD;AAED;A9ByoQF;AACA;AACA;A8BzoQI;AACA;AACA;AACD;AAED;A9B0oQF;AACA;AACA;A8B1oQI;AACA;AACA;AACA;AACD;AAED;A9B2oQF;AACA;AACA;AACA;AACA;AACA;A8B3oQI;AACD;A9B6oQH;AACA;AACA;A8B5oQA;A9B8oQA;AACA;AACA;AACA;AACA;AACA;AACA;A8BhpQE;A9BkpQF;AACA;A8BhpQE;AAAoB;A9BmpQtB;A8BlpQI;AACA;AACA;A9BopQJ;A8BnpQI;AACA;A9BqpQJ;A8BppQI;AACA;A9BspQJ;A8BrpQI;AACA;A9BupQJ;A8BtpQI;AACA;A9BwpQJ;A8BvpQI;AAIA;A9BspQJ;AACA;AACA;AACA;AACA;AACA;AACA;A8BrpQI;AACA;A9BupQJ;A8BtpQI;AAIA;AACE;AACE;AAAc;AAAmB;AAClC;AACF;AAED;A9BspQJ;A8BrpQI;A9BupQJ;A8BtpQI;AACE;AACA;AACA;AACD;A9BwpQL;A8BtpQI;AACE;AACE;AACD;AACF;AACF;AAED;A9BupQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BzpQI;AACA;AACD;AAED;A9B0pQF;AACA;AACA;AACA;AACA;AACA;A8B1pQI;AACA;AACD;AAED;A9B2pQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8B3pQI;AACA;AACD;AAED;A9B4pQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8B5pQI;A9B8pQJ;A8B5pQI;AACE;AACA;AACD;A9B8pQL;AACA;A8B7pQI;AACE;AACD;A9B+pQL;A8B9pQI;AACD;AAED;A9B+pQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BhqQyB;A9BkqQzB;A8BjqQI;AAAyB;AAAkB;A9BqqQ/C;A8BpqQI;AACE;AACA;AACA;AACD;A9BsqQL;A8BrqQI;A9BuqQJ;A8BtqQI;AACE;AACA;AACD;AACC;AACA;AACA;AACA;AACA;AAUI;AACA;AACA;A9B+pQV;A8BvpQU;AACD;AACJ;A9BypQL;A8BxpQI;AACD;AAED;A9BypQF;AACA;AACA;AACA;AACA;AACA;AACA;A8B1pQ6B;A9B4pQ7B;A8B3pQI;AACA;AACA;AACA;AAKE;AACA;AACA;AACD;A9BypQL;A8BxpQI;AACE;AACD;AACF;AAED;A9BypQF;AACA;AACA;AACA;AACA;AACA;A8BzpQI;AACE;AACD;A9B2pQL;A8B1pQI;A9B4pQJ;A8B3pQI;AACE;AACD;A9B6pQL;A8B5pQI;AACE;AACA;AAAkB;AAAmB;AACrC;AACD;AAED;A9B+pQJ;AACA;A8B/pQI;AACE;AAGE;AACA;AACA;AACA;AACA;AACA;AAAG;AARC;AASC;AATD;AAYN;AACD;A9BgqQL;A8B/pQI;AACD;AAED;A9BgqQF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BhqQI;AACA;AAAU;AAAO;AAClB;A9BoqQH;AACA;AACA;A8BnqQA;A9BqqQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8BrqQO;AACL;AACA;A9BuqQF;AACA;AACA;A8BtqQE;AACE;AACE;A9BwqQN;A8BvqQM;AACE;AACA;AACD;AACC;AAMA;AAA8B;AAAD;AAC9B;AACF;AACC;AACA;AACD;AACF;A9BsqQH;A8BrqQE;AAA8B;AAAD;AAC9B;A9ByqQD;AACA;AACA;AACA;AACA;AACA;AACA;A+BptRA;A/BstRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+BptRA;A/BstRA;AACA;AACA;A+BptRO;AACL;A/BstRF;AACA;A+BptRE;A/BstRF;A+BptRE;A/BstRF;AACA;A+BptRE;A/BstRF;A+BptRE;A/BstRF;AACA;AACA;A+BptRE;A/BstRF;A+BptRE;A/BstRF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+BptRE;A/BstRF;A+BptRE;A/BstRF;AACA;AACA;AACA;A+BptRE;A/BstRF;A+BptRE;A/BstRF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+BptRE;A/BstRF;A+BptRE;A/BstRF;AACA;A+BptRE;AArD2B;A/B4wR7B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgCvyRA;AhCyyRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgCvyRA;AhCyyRA;AACA;AACA;AACA;AACA;AACA;AgCvyRA;AAEA;AAKA;AAKA;AhCgyRA;AgC/xRO;AACL;AACA;AACA;AACA;AhCiyRF;AgChyRE;AhCkyRF;AACA;AgChyRE;AAEA;AACA;AAEA;AhCgyRF;AgC/xRE;AhCiyRF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgC/xRE;AAvBkB;AhCyzRpB;AgC5xRO;AACL;AADoB;AhCgyRtB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiCx2RA;AjC02RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiCv2RA;AjCy2RA;AiCv2RA;AjCy2RA;AACA;AACA;AiCv2RO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AAPkC;AjCi3RpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkCj4RA;AlCm4RA;AkCh4RA;AlCk4RA;AkCj4RA;AlCm4RA;AkCv5RA;AlCy5RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkCj5RA;AlCm5RA;AACA;AACA;AACA;AACA;AACA;AkCj5RO;AAA8D;AAAtB;AAAsB;AlCs5RrE;AkCr5RE;AAEI;AACE;AACD;AlCs5RP;AkCr5RM;AAAwC;AAAuB;AAChE;AAEJ;AAED;AlCu5RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkCv5RO;AACL;AAEI;AACE;AACD;AlCw5RP;AkCv5RM;AACE;AAAuB;AAE1B;AAEJ;AAED;AlCu5RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkCv5RO;AACL;AACA;AAEI;AACE;AACD;AlCw5RP;AkCv5RM;AACE;AAAuB;AAE1B;AAEJ;AAED;AlCu5RA;AACA;AACA;AACA;AACA;AACA;AkCv5RO;AACL;AlCy5RF;AkCx5RE;AlC05RF;AkCt5RE;AACE;AACD;AAGD;AlCs5RF;AACA;AkCt5RE;AACE;AAIA;AACD;AlCq5RH;AACA;AkCn5RE;AlCq5RF;AkCh5RE;AACE;AACD;AlCk5RH;AkCj5RE;AACD;AlCm5RD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmChgSA;AnCkgSA;AmCjgSA;AnCmgSA;AmC7/RA;AnC+/RA;AmC9/RA;AnCggSA;AmCxhSA;AnC0hSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmC7gSA;AAEA;AnC8gSA;AmC7gSO;AACL;AACA;AACA;AAHsB;AAMxB;AnC8gSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmC/gSO;AACL;AnCihSF;AmChhSE;AACE;AACD;AnCkhSH;AmCjhSE;AnCmhSF;AmClhSE;AACE;AACA;AnCohSJ;AmCnhSI;AACE;AACD;AnCqhSL;AmCphSI;AACE;AACA;AACD;AACF;AnCshSH;AmCrhSE;AACD;AAED;AnCshSA;AACA;AACA;AACA;AACA;AACA;AACA;AmCthSA;AACE;AACE;AACD;AACC;AACA;AACA;AACA;AACD;AACF;AAED;AnCuhSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmCvhSO;AAAmE;AAAd;AAAc;AnC4hS1E;AmC3hSE;AACA;AnC6hSF;AmC3hSE;AACE;AACD;AACC;AAAS;AAAuB;AACjC;AnC+hSH;AmC9hSE;AACD;AAED;AnC+hSA;AACA;AACA;AACA;AACA;AACA;AmC/hSO;AACL;AAEA;AACA;AACA;AACA;AnCgiSF;AmC5hSE;AACE;AACA;AnC8hSJ;AmC5hSI;AnC8hSJ;AmC5hSI;AACE;AACD;AACC;AACA;AACA;AACA;AACD;AACF;AnC8hSH;AmC5hSE;AACE;AACA;AACA;AnC8hSJ;AmC7hSI;AACE;AnC+hSN;AmC7hSM;AnC+hSN;AmC9hSM;AACE;AACA;AACA;AACD;AACF;AACF;AAGD;AACA;AACA;AACA;AACA;AACA;AACA;AnC8hSF;AACA;AmC9hSE;AACD;AAED;AnC+hSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmC/hSA;AACE;AACA;AACA;AACA;AACE;AACA;AACA;AACD;AnCiiSH;AmChiSE;AnCkiSF;AmCzhSE;AACE;AACD;AAEC;AACA;AACD;AACF;AAED;AnCyhSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmCzhSA;AACE;AACE;AACD;AnC2hSH;AmCzhSE;AACD;AAED;AnC0hSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmC1hSA;AACE;AACE;AAKA;AACD;AnCwhSH;AmCvhSE;AAIA;AACA;AACA;AAKD;AAED;AnCihSA;AACA;AACA;AACA;AACA;AACA;AmCjhSA;AACE;AACA;AnCmhSF;AmClhSE;AACE;AACA;AACD;AnCohSH;AmCnhSE;AACD;AnCqhSD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoClySA;ApCoySA;AoCnySA;ApCqySA;AoCtzSA;ApCwzSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoCnzSA;ApCqzSA;AACA;AACA;AACA;AACA;AoCnzSO;AACL;AACD;AAED;ApCozSA;AACA;AACA;AACA;AoCpzSA;AAEA;ApCqzSA;AACA;AACA;AACA;AoCpzSO;AACL;AACD;AAED;ApCqzSA;AACA;AACA;AACA;AACA;AACA;AoCrzSO;AACL;AACE;AACD;ApCuzSH;AoCrzSE;AACD;AAED;ApCszSA;AACA;AACA;AACA;AACA;AACA;AoCtzSA;AACE;AACE;AACA;AACA;AACA;AAEA;ApCuzSJ;AoCtzSI;AAAmB;AAAO;AAC3B;AACC;AACD;AACF;AAED;ApCyzSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoCzzSO;AACL;AACD;AAED;ApC0zSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoC1zSO;AACL;AACD;AAED;ApC2zSA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoC3zSO;AACL;ApC6zSF;AoC3zSE;AACA;AACD;ApC6zSD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqC56SA;ArC86SA;AqCh8SA;ArCk8SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqC/7SA;AACA;ArCi8SA;AqC97SA;ArCg8SA;AACA;AACA;AACA;AqC97SO;AAEP;ArC+7SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqCh8SO;AACL;AACA;AACD;AAED;ArCi8SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqCn8SE;ArCq8SF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqCn8SE;AACE;ArCq8SJ;AACA;AACA;AqCn8SI;AAEA;ArCo8SJ;AACA;AACA;AACA;AqCn8SI;AAEA;ArCo8SJ;AACA;AACA;AACA;AqCn8SI;AAEA;ArCo8SJ;AACA;AACA;AACA;AqCn8SI;AAEA;ArCo8SJ;AACA;AACA;AACA;AqCn8SI;AAEA;ArCo8SJ;AACA;AACA;AACA;AqCn8SI;AAEA;ArCo8SJ;AACA;AACA;AACA;AqCn8SI;AAEA;ArCo8SJ;AACA;AACA;AACA;AqCn8SI;AACD;AAED;ArCo8SF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqCt8SI;AACD;AAED;ArCu8SF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqCv8SI;AACA;ArCy8SJ;AqCt8SI;ArCw8SJ;AqCv8SI;AACE;AACD;AACC;AACD;ArCy8SL;AACA;AqCv8SI;AACA;AACA;ArCy8SJ;AqCx8SI;AACE;AACA;ArC08SN;AqCz8SM;AACE;AACD;AACC;AACD;AACC;AACE;AACD;AACC;AACD;ArC28ST;AqC18SQ;AACD;AACF;AAGD;AACA;ArC08SJ;AACA;AqC18SI;AACE;AACE;AACA;AACD;AACC;AACA;AACD;ArC48SP;AqC38SM;AACD;ArC68SL;AqC58SI;AACD;AAED;ArC68SF;AACA;AACA;AACA;AACA;AACA;AACA;AqC78SI;AACA;AACE;AACD;AACC;AACD;ArC+8SL;AACA;AqC78SI;AACA;AACA;ArC+8SJ;AqC58SI;AACA;ArC88SJ;AqC38SI;AACD;AAED;ArC48SF;AACA;AACA;AACA;AACA;AACA;AACA;AqC58SI;AACA;AACE;AACD;AACC;AACD;ArC88SL;AACA;AqC58SI;AACA;AACA;ArC88SJ;AqC38SI;AACA;ArC68SJ;AqC18SI;AACD;AAED;ArC28SF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqC38SI;AACD;ArC68SH;AACA;AACA;AqC58SA;ArC88SA;AACA;AACA;AACA;AACA;AACA;AqC98SO;AACL;ArCg9SF;AACA;AACA;AACA;AqC98SE;AACE;AACD;ArCg9SH;AqC98SE;ArCg9SF;AACA;AqC98SE;ArCg9SF;AqC98SE;ArCg9SF;AACA;AqC98SE;ArCg9SF;AqC98SE;ArCg9SF;AACA;AqC98SE;ArCg9SF;AqC98SE;ArCg9SF;AACA;AqC98SE;AA5BoB;AA+BtB;ArC+8SA;AACA;AACA;AACA;AqC/8SA;AACE;AACA;AACA;AACA;AACA;AALe;AAQjB;ArCg9SA;AACA;AACA;AACA;AACA;AqC/8SO;AACL;AACE;AACD;ArCi9SH;AqCh9SE;AACE;AACA;AACE;ArCk9SN;AqCj9SM;AACE;ArCm9SR;AqCl9SQ;AACE;AACE;AACE;AACD;AACF;ArCo9SX;AqCn9SU;AACD;AACF;ArCq9SP;AqCp9SM;AACD;ArCs9SL;AqCr9SI;AACD;ArCu9SH;AqCt9SE;AACD;ArCw9SD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsCxwTA;AtC0wTA;AsCzwTA;AtC2wTA;AsC1wTA;AtC4wTA;AsC3wTA;AtC6wTA;AsC5wTA;AtC8wTA;AsCvwTA;AtCywTA;AsCxwTA;AtC0wTA;AsCzwTA;AtC2wTA;AsC1wTA;AtC4wTA;AsC3wTA;AtC6wTA;AsC5wTA;AtC8wTA;AsC7wTA;AtC+wTA;AsC9wTA;AtCgxTA;AsC/wTA;AtCixTA;AsChxTA;AtCkxTA;AsCjxTA;AtCmxTA;AsClxTA;AtCoxTA;AsCnxTA;AtCqxTA;AsCpxTA;AtCsxTA;AsCrxTA;AtCuxTA;AsCtxTA;AtCwxTA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC1yTA;AAEA;AtC2yTA;AACA;AACA;AACA;AACA;AACA;AsC1yTA;AAEA;AtC2yTA;AACA;AACA;AsC1yTA;AACE;AACA;AACA;AACA;AAJmB;AAOrB;AtC2yTA;AACA;AACA;AACA;AsC1yTA;AAEA;AtC2yTA;AACA;AACA;AACA;AsC1yTA;AACE;AACE;AACA;AACD;AtC4yTH;AsC3yTE;AACD;AAED;AtC4yTA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC5yTO;AACL;AAA0B;AAA0C;AtCgzTtE;AsCjzToD;AAAA;AAAA;AAAA;AtCszTpD;AsCjzTI;AtCmzTJ;AACA;AACA;AACA;AsCjzTI;AAAkB;AtCozTtB;AsCnzTM;AACD;AACD;AtCqzTJ;AACA;AACA;AACA;AACA;AsCt0ToD;AtCw0TpD;AsCx0ToD;AAkB9C;AACD;AtCyzTL;AsC50ToD;AAAA;AtC+0TpD;AsC1zTE;AAAO;AAAyC;AAAhD;AACD;AAED;AtC8zTA;AACA;AACA;AACA;AACA;AACA;AACA;AsC9zTA;AACE;AACE;AACD;AtCg0TH;AsC/zTE;AACE;AAA0C;AAE5C;AtCi0TF;AACA;AACA;AsC10T2C;AAAA;AAAA;AAAA;AtC+0T3C;AsCp0TI;AtCs0TJ;AACA;AACA;AACA;AsCp0TI;AAAkB;AtCu0TtB;AsCt0TM;AACA;AACA;AACD;AAED;AtCu0TJ;AACA;AACA;AACA;AACA;AACA;AsCl2T2C;AtCo2T3C;AsCp2T2C;AA4BrC;AACA;AtC20TN;AsC10TM;AACA;AAEA;AtC20TN;AACA;AACA;AACA;AACA;AACA;AACA;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AACA;AACA;AACA;AsC10TM;AAEA;AtC20TN;AACA;AACA;AACA;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AACA;AACA;AACA;AACA;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AsC10TM;AAEA;AtC20TN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC10TM;AAGA;AtC00TN;AsCz0TM;AAAsB;AAAwB;AtC60TpD;AsC10TM;AtC40TN;AsCz0TM;AACE;AACD;AtC20TP;AsC10TM;AACA;AtC40TN;AsC30TM;AAEA;AtC40TN;AACA;AACA;AACA;AACA;AACA;AsC30TM;AAEA;AtC40TN;AACA;AACA;AACA;AACA;AsC30TM;AAEA;AtC40TN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC30TM;AAEA;AtC40TN;AACA;AACA;AACA;AsC30TM;AAEA;AtC40TN;AsC30TM;AtC60TN;AsC30TM;AACA;AtC60TN;AACA;AsC70TM;AAEA;AtC80TN;AsC70TM;AtC+0TN;AsC70TM;AACE;AACA;AACA;AACD;AACF;AAED;AtC80TJ;AACA;AACA;AACA;AsChhU2C;AtCkhU3C;AsClhU2C;AAsMvC;AAtMuC;AtCshU3C;AsCthU2C;AAwMrC;AACD;AAED;AtCg1TJ;AACA;AACA;AACA;AACA;AACA;AsChiU2C;AtCkiU3C;AsCliU2C;AAmNrC;AACA;AAAO;AAAgD;AAAvD;AACD;AAED;AtCo1TJ;AACA;AACA;AACA;AACA;AACA;AsChjU2C;AtCkjU3C;AsCljU2C;AA+NrC;AAIA;AAAO;AAAoE;AAA3E;AAED;AAED;AtCo1TJ;AACA;AACA;AACA;AACA;AACA;AACA;AsCjkU2C;AtCmkU3C;AsCnkU2C;AAgPrC;AACD;AAED;AAnPuC;AtCykU3C;AsCzkU2C;AAqPrC;AACD;AAED;AtCs1TJ;AACA;AACA;AACA;AACA;AACA;AsCnlU2C;AtCqlU3C;AsCrlU2C;AAgQrC;AACE;AACD;AtCw1TP;AsCv1TM;AACE;AACA;AACD;AtCy1TP;AsCx1TM;AtC01TN;AsCz1TM;AACE;AACA;AACA;AACA;AACA;AACD;AACF;AAED;AtC01TJ;AACA;AACA;AACA;AsC9mU2C;AtCgnU3C;AsChnU2C;AAuRrC;AACD;AAED;AtC21TJ;AACA;AACA;AACA;AACA;AsCznU2C;AtC2nU3C;AsC3nU2C;AAiSrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;AAED;AAhTuC;AtC6oU3C;AsC7oU2C;AAkTrC;AAIE;AAOA;AACD;AACF;AAED;AtCo1TJ;AACA;AACA;AACA;AACA;AsCzpU2C;AtC2pU3C;AsC3pU2C;AAwUrC;AACD;AAED;AtCq1TJ;AACA;AACA;AACA;AsCnqU2C;AtCqqU3C;AsCrqU2C;AAiVrC;AACD;AAED;AtCs1TJ;AACA;AACA;AsC5qU2C;AtC8qU3C;AsC9qU2C;AAyVrC;AACA;AACD;AAED;AtCu1TJ;AACA;AACA;AsCtrU2C;AtCwrU3C;AsCxrU2C;AAkWrC;AAIA;AACD;AAED;AtCq1TJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsCtsU2C;AtCwsU3C;AsCxsU2C;AAmX/B;AtCw1TZ;AsCv1TM;AACA;AtCy1TN;AsCx1TM;AACE;AACD;AtC01TP;AsCz1TM;AACE;AtC21TR;AsC11TQ;AACE;AACD;AACC;AAEI;AACE;AACD;AtC21Tf;AsC11Tc;AAAgC;AAAuB;AACxD;AAEC;AACE;AACD;AACC;AACD;AACF;AACJ;AACF;AAEG;AAAgB;AAAe;AtC81TzC;AsC71TU;AtC+1TV;AsC91TU;AtCg2TV;AsC/1TU;AtCi2TV;AsCh2TU;AtCk2TV;AsCj2TU;AACE;AACD;AtCm2TX;AsCl2TU;AACE;AACA;AACA;AAID;AtCi2TX;AsCh2TU;AACE;AtCk2TZ;AsCj2TY;AACE;AACD;AACF;AACF;AAEC;AAEE;AAAuB;AtCk2TnC;AsCh2TU;AACE;AACD;AtCk2TX;AsCj2TU;AACD;AAEJ;AAED;AtCi2TJ;AACA;AACA;AACA;AsCvxU2C;AtCyxU3C;AsCzxU2C;AAwblB;AtCo2TzB;AsCn2TM;AACE;AACD;AACC;AACA;AACA;AACA;AACE;AtCq2TV;AsCp2TU;AACE;AACA;AACD;AACC;AACA;AACD;AtCs2TX;AsCr2TU;AACD;AACF;AACF;AAED;AtCs2TJ;AACA;AACA;AsCrzU2C;AtCuzU3C;AsCvzU2C;AAkdrC;AACD;AAED;AtCu2TJ;AACA;AACA;AACA;AACA;AsCh0U2C;AtCk0U3C;AsCl0U2C;AA2da;AtC02TxD;AsCz2TM;AACA;AtC22TN;AsC12TM;AACE;AACD;AtC42TP;AsC32TM;AACE;AACE;AtC62TV;AsC52TU;AACE;AACD;AACF;AACC;AACD;AACF;AtC82TP;AsC52TM;AACE;AACE;AACA;AACD;AAIC;AACA;AACA;AAAqB;AAAA;AACtB;AACF;AACF;AAED;AtC42TJ;AACA;AACA;AsCz2U2C;AtC22U3C;AsC32U2C;AAggBrC;AAKE;AACA;AACD;AtC02TP;AsCz2TM;AACD;AAED;AtC02TJ;AACA;AACA;AsCv3U2C;AtCy3U3C;AsCz3U2C;AAghBrC;AACE;AACA;AACD;AtC42TP;AsC32TM;AACE;AtC62TR;AsC12TQ;AACE;AACD;AtC42TT;AsC32TQ;AACA;AACD;AACF;AAED;AtC42TJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsCv5U2C;AtCy5U3C;AsCz5U2C;AA8iBrC;AtC82TN;AsC32TM;AACE;AACD;AtC62TP;AsC52TM;AAAsB;AAEpB;AAID;AtC22TP;AACA;AsCz2TM;AACE;AACA;AACD;AtC22TP;AsC12TM;AACE;AAKD;AtCw2TP;AACA;AsCv2TM;AAIE;AACA;AAC+B;AAAmB;AAEnD;AtCs2TP;AsCr2TM;AACE;AtCu2TR;AsCt2TQ;AACE;AAKD;AACF;AACF;AAED;AtCm2TJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC38U2C;AtC68U3C;AsC78U2C;AA2mBrC;AtCq2TN;AsCp2TM;AACE;AACA;AACA;AACA;AACA;AACA;AACE;AACE;AACD;AACF;AACF;AtCs2TP;AsCr2TM;AACE;AACD;AtCu2TP;AsCt2TM;AACE;AACD;AtCw2TP;AsCv2TM;AACE;AACE;AACD;AtCy2TT;AsCx2TQ;AACE;AACD;AtC02TT;AsCz2TQ;AACE;AACD;AtC22TT;AsC12TQ;AACE;AACD;AACF;AtC42TP;AsC32TM;AACE;AACD;AtC62TP;AsC52TM;AACD;AAED;AtC62TJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC1gV2C;AtC4gV3C;AsC5gV2C;AAgqBrC;AACE;AAID;AtC42TP;AsC32TM;AACE;AACD;AtC62TP;AsC32TM;AACE;AACD;AtC62TP;AsC52TM;AtC82TN;AsC52TM;AACE;AACA;AACA;AACD;AtC82TP;AsC52TM;AACE;AACA;AtC82TR;AsC72TQ;AtC+2TR;AsC92TQ;AACA;AtCg3TR;AsC92TQ;AtCg3TR;AsC/2TQ;AAIE;AAID;AACF;AtC22TP;AsC12TM;AACE;AACA;AACD;AtC42TP;AsC32TM;AtC62TN;AsC32TM;AACE;AtC62TR;AsC52TQ;AACE;AACD;AtC82TT;AsC72TQ;AACE;AACE;AACD;AtC+2TX;AsC92TU;AACD;AACF;AACC;AtCg3TR;AsC92TQ;AACE;AACD;AACC;AACD;AtCg3TT;AsC/2TQ;AACE;AACD;AtCi3TT;AsCh3TQ;AACE;AACA;AAEA;AtCi3TV;AsCh3TU;AACD;AACF;AACF;AAED;AtCi3TJ;AACA;AACA;AsChmV2C;AtCkmV3C;AsClmV2C;AAkvBrC;AACD;AAED;AtCk3TJ;AACA;AsCxmV2C;AtC0mV3C;AsC1mV2C;AAyvBrC;AACD;AAED;AA5vBuC;AtCgnV3C;AsChnV2C;AA8vBrC;AACD;AAED;AtCo3TJ;AACA;AACA;AsCvnV2C;AtCynV3C;AsCznV2C;AAqwBzB;AtCu3TlB;AsCt3TM;AACA;AtCw3TN;AsCv3TM;AACE;AACA;AACD;AAGD;AACA;AtCu3TN;AACA;AsCv3TM;AACA;AACA;AtCy3TN;AsCx3TM;AACE;AACA;AACD;AACC;AACA;AAEI;AACD;AAEC;AACA;AACD;AACJ;AACC;AACA;AACE;AAA4C;AAG/C;AACF;AAED;AtCs3TJ;AACA;AACA;AACA;AsClqV2C;AtCoqV3C;AsCpqV2C;AA+yBrC;AAAgB;AAA0B;AAC3C;AAED;AAlzBuC;AtC4qV3C;AsC5qV2C;AAozBrC;AACD;AAED;AtC03TJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC5rV2C;AtC8rV3C;AsC9rV2C;AAq0BrC;AACE;AACD;AtC43TP;AsC33TM;AACE;AACD;AAGD;AACA;AACA;AtC23TN;AACA;AsC33TM;AACE;AACD;AtC63TP;AsC33TM;AACA;AACA;AACD;AAED;AtC43TJ;AACA;AACA;AACA;AACA;AACA;AsC1tV2C;AtC4tV3C;AsC5tV2C;AAi2BrC;AtC83TN;AsC53TM;AACA;AACA;AAAsB;AAAc;AAAM;AAAiB;AAC3D;AACD;AAED;AtCi4TJ;AACA;AACA;AACA;AACA;AACA;AsC/uV2C;AtCivV3C;AsCjvV2C;AAi3BrC;AACE;AACD;AtCm4TP;AsCl4TM;AACD;AAED;AtCm4TJ;AACA;AACA;AACA;AsC7vV2C;AtC+vV3C;AsC/vV2C;AA63BrC;AACD;AAED;AtCo4TJ;AACA;AACA;AACA;AsCvwV2C;AtCywV3C;AsCzwV2C;AAs4BrC;AACD;AAED;AtCq4TJ;AACA;AACA;AACA;AsCjxV2C;AtCmxV3C;AsCnxV2C;AA+4BrC;AACD;AAED;AtCs4TJ;AACA;AACA;AACA;AACA;AACA;AACA;AsC9xV2C;AtCgyV3C;AsChyV2C;AA25BrC;AACD;AAED;AtCu4TJ;AACA;AACA;AACA;AsCxyV2C;AtC0yV3C;AsC1yV2C;AAo6BrC;AACD;AAED;AtCw4TJ;AACA;AACA;AACA;AACA;AsCnzV2C;AtCqzV3C;AsCrzV2C;AA86BrC;AACD;AAED;AtCy4TJ;AACA;AACA;AACA;AACA;AACA;AsC/zV2C;AtCi0V3C;AsCj0V2C;AAy7BrC;AACD;AAED;AtC04TJ;AACA;AACA;AACA;AACA;AsC10V2C;AtC40V3C;AsC50V2C;AAm8BrC;AACD;AAED;AtC24TJ;AACA;AACA;AsCn1V2C;AtCq1V3C;AsCr1V2C;AA28BrC;AACD;AAED;AtC44TJ;AACA;AACA;AACA;AACA;AsC91V2C;AtCg2V3C;AsCh2V2C;AAq9BrC;AACA;AACA;AtC84TN;AsC54TM;AACA;AACD;AAED;AtC64TJ;AACA;AACA;AACA;AsC72V2C;AtC+2V3C;AsC/2V2C;AAm+BrC;AACD;AAED;AtC84TJ;AACA;AACA;AsCt3V2C;AtCw3V3C;AsCx3V2C;AA2+BrC;AACD;AAED;AtC+4TJ;AACA;AACA;AACA;AACA;AsCj4V2C;AtCm4V3C;AsCn4V2C;AAq/BrC;AACD;AAED;AtCg5TJ;AACA;AACA;AACA;AACA;AsC54V2C;AtC84V3C;AsC94V2C;AA8/BV;AtCm5TjC;AsCn5TiC;AAArB;AAAqB;AtCu5TjC;AsCt5TM;AACA;AAAoB;AAAA;AACrB;AAED;AtCy5TJ;AACA;AACA;AsC95V2C;AtCg6V3C;AsCh6V2C;AAwgCrC;AACD;AAED;AtC05TJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsCj7V2C;AtCm7V3C;AsCn7V2C;AAyhCtB;AtC65TrB;AsC55TM;AACA;AACA;AACA;AtC85TN;AsC75TM;AtC+5TN;AsC95TM;AACE;AACD;AtCg6TP;AsC/5TM;AACE;AACD;AtCi6TP;AsC/5TM;AAA2B;AAAA;AAC3B;AAAgB;AAAe;AAC/B;AAEA;AAEI;AACE;AACD;AtCm6TX;AsCl6TU;AACA;AtCo6TV;AsCn6TU;AAA2B;AAAD;AAE1B;AtCs6TV;AACA;AsCt6TU;AACE;AtCw6TZ;AsCv6TY;AtCy6TZ;AsCx6TY;AACD;AACF;AAEC;AACA;AACE;AAEE;AAAuB;AAE1B;AtCw6TX;AsCv6TU;AtCy6TV;AsCx6TU;AAA2B;AAAD;AtC46TpC;AsC36TU;AACD;AAEJ;AAED;AtC26TJ;AACA;AACA;AACA;AsCv/V2C;AtCy/V3C;AsCz/V2C;AA+kCrC;AACD;AAED;AtC46TJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsCrgW2C;AtCugW3C;AsCvgW2C;AA2lCV;AtC+6TjC;AsC96TM;AtCg7TN;AsC/6TM;AACE;AACD;AAED;AtCg7TN;AACA;AsCh7TM;AACE;AACD;AtCk7TP;AsCj7TM;AtCm7TN;AsCl7TM;AACE;AACE;AACD;AACC;AACA;AACA;AACE;AACA;AACA;AACA;AAKE;AACD;AACF;AACF;AACF;AtCg7TP;AsC/6TM;AACE;AACD;AACF;AAED;AtCg7TJ;AACA;AACA;AsCjjW2C;AtCmjW3C;AsCnjW2C;AAooCrC;AACA;AtCk7TN;AsCj7TM;AACE;AACD;AACF;AAED;AtCk7TJ;AACA;AACA;AACA;AsChkW2C;AtCkkW3C;AsClkW2C;AAipCrC;AACD;AAED;AtCm7TJ;AACA;AACA;AACA;AACA;AACA;AsC5kW2C;AtC8kW3C;AsC9kW2C;AA4pCrC;AtCq7TN;AsCp7TM;AACE;AACD;AtCs7TP;AsCr7TM;AACA;AtCu7TN;AsCt7TM;AACE;AACD;AACF;AAED;AtCu7TJ;AACA;AACA;AACA;AACA;AACA;AACA;AsCpmW2C;AtCsmW3C;AsCtmW2C;AAgrCrC;AtCy7TN;AsCx7TM;AACE;AACD;AtC07TP;AsCz7TM;AtC27TN;AsC17TM;AACE;AACD;AACF;AAED;AtC27TJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC5nW2C;AtC8nW3C;AsC9nW2C;AAosCrC;AtC67TN;AsC57TM;AACE;AACD;AtC87TP;AsC77TM;AACA;AtC+7TN;AsC97TM;AACE;AACD;AtCg8TP;AsC/7TM;AACD;AAED;AAhtCuC;AtCipW3C;AsCjpW2C;AAktCrC;AACA;AACA;AACA;AACA;AACA;AACD;AAED;AtCi8TJ;AACA;AACA;AACA;AACA;AACA;AACA;AsCjqW2C;AtCmqW3C;AsCnqW2C;AAmuCrC;AACD;AAED;AtCk8TJ;AACA;AACA;AACA;AACA;AACA;AACA;AsC9qW2C;AtCgrW3C;AsChrW2C;AA+uCrC;AACD;AAED;AtCm8TJ;AACA;AACA;AsCvrW2C;AtCyrW3C;AsCzrW2C;AAuvCrC;AAAqB;AAAO;AAC7B;AAED;AtCs8TJ;AACA;AACA;AsClsW2C;AtCosW3C;AsCpsW2C;AA+vCrC;AACD;AAED;AtCu8TJ;AACA;AACA;AsC3sW2C;AtC6sW3C;AsC7sW2C;AAuwCrC;AAAqB;AAAO;AAC7B;AAED;AtC08TJ;AACA;AACA;AsCttW2C;AtCwtW3C;AsCxtW2C;AA+wCrC;AACD;AAED;AtC28TJ;AACA;AACA;AACA;AACA;AACA;AsCluW2C;AtCouW3C;AsCpuW2C;AA0xCrC;AACD;AAED;AtC48TJ;AACA;AACA;AACA;AACA;AACA;AACA;AsC/uW2C;AtCivW3C;AsCjvW2C;AAsyCrC;AtC88TN;AsC78TM;AACE;AACE;AACD;AtC+8TT;AsC98TQ;AACD;AACC;AACD;AACF;AAED;AtC+8TJ;AACA;AACA;AACA;AsCnwW2C;AtCqwW3C;AsCrwW2C;AAszCrB;AtCk9TtB;AsCj9TM;AACE;AACD;AtCm9TP;AsCj9TM;AACA;AtCm9TN;AsCh9TM;AACE;AACD;AACF;AAED;AtCi9TJ;AACA;AACA;AACA;AACA;AACA;AsC1xW2C;AtC4xW3C;AsC5xW2C;AA40CrC;AACE;AACD;AACC;AAMD;AACF;AAED;AtC68TJ;AACA;AACA;AsCvyW2C;AtCyyW3C;AsCzyW2C;AA61CrC;AtC+8TN;AsC98TM;AACE;AACE;AACA;AACD;AACC;AACA;AACD;AACF;AtCg9TP;AsC/8TM;AACE;AACA;AACA;AACA;AACD;AtCi9TP;AsCh9TM;AACD;AAED;AtCi9TJ;AACA;AACA;AACA;AACA;AACA;AsCt0W2C;AtCw0W3C;AsCx0W2C;AAw3CrC;AAAgC;AAAA;AACjC;AAED;AtCo9TJ;AACA;AACA;AACA;AACA;AsCn1W2C;AtCq1W3C;AsCr1W2C;AAk4CrC;AAES;AAAA;AAEV;AAED;AtCo9TJ;AACA;AACA;AACA;AsC/1W2C;AtCi2W3C;AsCj2W2C;AA84CrC;AACE;AAGE;AACA;AACA;AAEH;AACF;AAED;AtCk9TJ;AACA;AACA;AACA;AsC92W2C;AtCg3W3C;AsCh3W2C;AA+5CrC;AtCo9TN;AsCn9TM;AACE;AtCq9TR;AsCp9TQ;AACE;AAGD;AACF;AACC;AtCo9TR;AsCn9TQ;AACE;AACA;AACA;AACE;AACD;AtCq9TX;AsCp9TU;AACD;AACF;AACF;AAED;AtCq9TJ;AACA;AACA;AACA;AsC54W2C;AtC84W3C;AsC94W2C;AA07CrC;AACD;AAED;AtCs9TJ;AACA;AACA;AACA;AACA;AsCv5W2C;AtCy5W3C;AsCz5W2C;AAo8CrC;AACA;AtCw9TN;AsCt9TM;AAME;AACD;AAED;AACA;AACA;AtCk9TN;AACA;AsCl9TM;AtCo9TN;AsCn9TM;AACE;AtCq9TR;AsCp9TQ;AACE;AAID;AACF;AACF;AAED;AtCk9TJ;AACA;AACA;AACA;AsCp7W2C;AtCs7W3C;AsCt7W2C;AAq+CrC;AACA;AACA;AACD;AAED;AtCm9TJ;AACA;AACA;AACA;AsCh8W2C;AtCk8W3C;AsCl8W2C;AAg/CrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACE;AACD;AtCq9TP;AsCp9TM;AACE;AACD;AtCs9TP;AsCp9TM;AAGE;AAKA;AACD;AtCg9TP;AsC98TM;AACD;AAED;AtC+8TJ;AACA;AsC/9W2C;AtCi+W3C;AsCj+W2C;AAmhDrC;AAEG;AAED;AAJF;AAMD;AAED;AtC88TJ;AACA;AACA;AACA;AACA;AsC7+W2C;AtC++W3C;AsC/+W2C;AAkiDrC;AACE;AACD;AtCg9TP;AsC/8TM;AACE;AACA;AAEA;AAA0B;AAA0B;AAGpD;AAOA;AAEA;AACA;AACA;AACD;AACF;AAED;AtCw8TJ;AACA;AACA;AACA;AACA;AsCvgX2C;AtCygX3C;AsCzgX2C;AAikDL;AtC28TtC;AsC18TM;AACA;AACA;AtC48TN;AsC38TM;AAKE;AACA;AACD;AtCy8TP;AsCx8TM;AACE;AACA;AACD;AtC08TP;AsCz8TM;AtC28TN;AsC18TM;AACE;AACD;AtC48TP;AACA;AsC18TM;AACE;AACA;AACD;AtC48TP;AsC18TM;AACE;AAEA;AtC28TR;AsC18TQ;AACE;AACD;AtC48TT;AsC38TQ;AACE;AACD;AtC68TT;AsC58TQ;AACE;AACD;AtC88TT;AsC58TQ;AtC88TR;AsC78TQ;AtC+8TR;AsC78TQ;AACE;AACA;AACA;AtC+8TV;AsC98TU;AACE;AACD;AACF;AACF;AACF;AAED;AtC+8TJ;AACA;AACA;AsCzkX2C;AtC2kX3C;AsC3kX2C;AA6nDrC;AACE;AAID;AtC88TP;AsC78TM;AACD;AAED;AtC88TJ;AACA;AACA;AsCtlX2C;AtCwlX3C;AsCxlX2C;AA2oDrC;AACE;AtCg9TR;AsC/8TQ;AACE;AACE;AACD;AtCi9TX;AsCh9TU;AACE;AACD;AACF;AACF;AtCk9TP;AsCj9TM;AACD;AAED;AtCk9TJ;AACA;AACA;AACA;AACA;AACA;AACA;AsCjnX2C;AtCmnX3C;AsCnnX2C;AAiqDsB;AtCq9TjE;AsCp9TM;AtCs9TN;AsCr9TM;AACE;AACE;AAKD;AACF;AACC;AtCm9TR;AsCj9TQ;AACE;AACE;AtCm9TZ;AsCl9TY;AAAU;AAAO;AACjB;AACE;AACE;AAAgB;AAInB;AACF;AACF;AACC;AACD;AACF;AACF;AAED;AtCm9TJ;AACA;AACA;AACA;AACA;AsCvpX2C;AtCypX3C;AsCzpX2C;AAusDrC;AACE;AACD;AACC;AACD;AACF;AtCq9TL;AsCjqX2C;AAAA;AtCoqX3C;AsCt9TE;AACA;AAAO;AAA0C;AAAjD;AACD;AAED;AtC09TA;AACA;AACA;AACA;AACA;AsC19TA;AACE;AACD;AAED;AtC29TA;AACA;AsC39TA;AACE;AACD;AAED;AtC49TA;AACA;AACA;AACA;AACA;AACA;AsC59TA;AACE;AACD;AAED;AtC69TA;AACA;AACA;AACA;AACA;AACA;AsC79TA;AACE;AACE;AACD;AtC+9TH;AsC99TE;AAME;AACD;AtC29TH;AsC19TE;AACD;AAED;AtC29TA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsC39TO;AACL;AtC69TF;AsC59TE;AACE;AACD;AtC89TH;AsC79TE;AACD;AtC+9TD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuCz2XA;AvC22XA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuCz2XA;AvC22XA;AACA;AACA;AACA;AuCz2XO;AACL;AACD;AAED;AvC02XA;AACA;AACA;AACA;AACA;AACA;AuC12XA;AACE;AACD;AAED;AvC22XA;AACA;AACA;AACA;AACA;AACA;AuC32XO;AACL;AACD;AAED;AvC42XA;AACA;AACA;AACA;AACA;AACA;AACA;AuC52XA;AACE;AvC82XF;AuC72XE;AACE;AACD;AACC;AACE;AACE;AACE;AACA;AACD;AvC+2XT;AuC92XQ;AACD;AACF;AvCg3XL;AuC/2XI;AACD;AACF;AAED;AvCg3XA;AACA;AACA;AACA;AACA;AACA;AuCh3XO;AACL;AACE;AACD;AACF;AAED;AvCi3XA;AACA;AACA;AACA;AACA;AACA;AuCj3XO;AACL;AACE;AACD;AACF;AvCm3XD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwCj8XA;AxCm8XA;AwCl8XA;AxCo8XA;AwC97XA;AxCg8XA;AwC/7XA;AxCi8XA;AwCh8XA;AxCk8XA;AwC39XA;AxC69XA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwCh9XA;AxCk9XA;AACA;AACA;AwCh9XO;AACL;AACA;AACA;AACE;AACE;AAGD;AACF;AACF;AAED;AxC+8XA;AACA;AACA;AACA;AACA;AACA;AACA;AwC/8XO;AACL;AACE;AACD;AxCi9XH;AwC/8XE;AxCi9XF;AwCh9XE;AACE;AACD;AAGD;AxCg9XF;AACA;AwCh9XE;AACA;AxCk9XF;AwCj9XE;AACE;AACD;AACC;AACD;AAGD;AACA;AxCi9XF;AACA;AwCj9XE;AACE;AACD;AxCm9XH;AwCj9XE;AxCm9XF;AwCl9XE;AACE;AAMD;AxC+8XH;AwC78XE;AACA;AACA;AxC+8XF;AwC78XE;AACE;AACA;AAKA;AACD;AxC28XH;AwC18XE;AACE;AACA;AAKA;AACD;AxCw8XH;AwCt8XE;AACE;AAKD;AACC;AACE;AACA;AAKD;AxCg8XL;AwC97XI;AACE;AACA;AAMD;AACF;AxC27XH;AwCz7XE;AxC27XF;AwC17XE;AACE;AAMD;AACC;AACD;AAGD;AACA;AACA;AxCq7XF;AACA;AwCr7XE;AACE;AAGA;AACA;AxCq7XJ;AwCp7XI;AxCs7XJ;AwCp7XI;AxCs7XJ;AwCr7XI;AAGE;AAAS;AACT;AAAW;AACX;AAAW;AAId;AACF;AxCq7XD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyCzoYA;AzC2oYA;AyC1oYA;AzC4oYA;AyCvoYA;AzCyoYA;AyCxoYA;AzC0oYA;AyCzoYA;AzC2oYA;AyC1oYA;AzC4oYA;AyCrqYA;AzCuqYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyCzpYA;AACE;AACA;AACA;AACA;AACA;AACA;AANwB;AAQ1B;AAEA;AzC0pYA;AyCzpYO;AAEP;AzC0pYA;AACA;AyC1pYO;AAEP;AzC2pYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC5pYO;AACL;AACE;AACA;AACD;AACD;AzC8pYF;AACA;AyC9pYE;AzCgqYF;AyC/pYE;AACE;AACA;AACE;AACE;AACA;AACD;AACF;AACD;AAA0B;AAAD;AAC1B;AACC;AACA;AACE;AACE;AACA;AACD;AACF;AAAE;AAAmB;AACvB;AACF;AAED;AzCoqYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyCpqYO;AACL;AACE;AACD;AACF;AAED;AzCqqYA;AACA;AACA;AACA;AACA;AACA;AyCrqYO;AACL;AAAkC;AAAA;AACnC;AAED;AzCwqYA;AACA;AACA;AACA;AACA;AACA;AyCxqYO;AACL;AAA0B;AAAA;AAC3B;AAED;AzC2qYA;AACA;AACA;AACA;AACA;AyC3qYO;AACL;AACE;AACD;AACF;AAED;AzC4qYA;AACA;AACA;AACA;AACA;AyC5qYO;AACL;AACE;AACD;AACF;AAED;AzC6qYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC7qYO;AACL;AzC+qYF;AyC9qYE;AACE;AACD;AzCgrYH;AyC/qYE;AACD;AAED;AzCgrYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyChrYO;AACL;AACA;AACD;AAED;AzCirYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCjrYO;AACL;AACE;AACD;AzCmrYH;AyClrYE;AACD;AAED;AzCmrYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyCnrYO;AACL;AACA;AACD;AAED;AzCorYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCprYO;AACL;AzCsrYF;AyCrrYE;AACE;AACD;AzCurYH;AACA;AyCrrYE;AzCurYF;AyCtrYE;AACE;AzCwrYJ;AyCvrYI;AACE;AACD;AACC;AACD;AACF;AzCyrYH;AyCxrYE;AACD;AAED;AzCyrYA;AACA;AACA;AACA;AACA;AACA;AyCzrYO;AACL;AACE;AACA;AACD;AzC2rYH;AyC1rYE;AzC4rYF;AyC1rYE;AzC4rYF;AyC3rYE;AACD;AAED;AzC4rYA;AACA;AACA;AACA;AACA;AACA;AyC5rYO;AACL;AACA;AACE;AACD;AAED;AzC6rYF;AACA;AyC7rYE;AACE;AACD;AzC+rYH;AyC9rYE;AACoB;AAAwB;AAG7C;AAED;AzC8rYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC9rYO;AACL;AACE;AACE;AACD;AACF;AzCgsYH;AyC/rYE;AACD;AAED;AzCgsYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyChsYO;AACL;AACE;AACE;AACD;AACF;AzCksYH;AyCjsYE;AACD;AAED;AzCksYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyClsYO;AACL;AACE;AACD;AzCosYH;AyClsYE;AACE;AACD;AACF;AAED;AzCmsYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCnsYO;AACL;AzCqsYF;AyCpsYE;AAKE;AACE;AACD;AACF;AzCksYH;AyCjsYE;AACD;AAED;AzCksYA;AACA;AACA;AACA;AACA;AACA;AACA;AyClsYO;AACL;AACA;AACA;AACE;AACD;AACF;AAED;AzCmsYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCnsYO;AACL;AAKE;AACE;AACD;AACF;AzCisYH;AyChsYE;AACD;AAED;AzCisYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCjsYO;AACL;AzCmsYF;AyClsYE;AAKE;AACE;AACD;AACF;AzCgsYH;AyC/rYE;AACD;AAED;AzCgsYA;AACA;AACA;AACA;AACA;AACA;AACA;AyChsYO;AACL;AAKE;AACE;AACD;AACF;AzC8rYH;AyC7rYE;AACD;AAED;AzC8rYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC9rYO;AACL;AzCgsYF;AyC/rYE;AACE;AACE;AACD;AACF;AzCisYH;AyChsYE;AACD;AAED;AzCisYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCjsYO;AACL;AACA;AAAO;AAAO;AAAd;AACD;AAED;AzCqsYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCrsYO;AACL;AACA;AACE;AACD;AACF;AAED;AzCssYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCtsYO;AACL;AACA;AAAO;AAAO;AAAd;AACD;AAED;AzC0sYA;AACA;AACA;AACA;AACA;AACA;AACA;AyC1sYO;AACL;AACA;AAAO;AAAO;AAAd;AACD;AAED;AzC8sYA;AACA;AACA;AACA;AACA;AACA;AACA;AyC9sYO;AACL;AACA;AAAO;AAAO;AAAd;AACD;AAED;AzCktYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCltYO;AACL;AzCotYF;AyC9sYE;AACE;AACD;AzCgtYH;AyC/sYE;AACD;AAED;AzCgtYA;AACA;AACA;AACA;AACA;AACA;AACA;AyChtYO;AACL;AACA;AAAe;AAAO;AACvB;AAED;AzCmtYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyCntYA;AACE;AACA;AACA;AACA;AAAsB;AAAO;AAC7B;AACA;AACD;AAED;AzCstYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyCttYO;AACL;AACE;AAAY;AAAO;AACpB;AzC0tYH;AACA;AyCxtYE;AACA;AACD;AAED;AzCytYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyCztYO;AACL;AACE;AAAY;AAAO;AAGpB;AzC2tYH;AACA;AyCztYE;AACD;AAED;AzC0tYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC1tYO;AAKL;AAA6D;AAAA;AzC0tY/D;AyC3tYE;AAGA;AACA;AzC2tYF;AyC1tYE;AACE;AzC4tYJ;AyC3tYI;AACE;AzC6tYN;AyC5tYM;AACD;AACF;AzC8tYH;AyC7tYE;AACD;AAED;AzC8tYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC9tYO;AACL;AzCguYF;AyC/tYE;AACE;AACE;AACD;AACF;AzCiuYH;AyC7tYE;AACD;AAED;AzC8tYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC9tYO;AACL;AACE;AACD;AACC;AACA;AACA;AACD;AACF;AAED;AzC+tYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC/tYO;AAAqC;AzCkuY5C;AyChuYE;AACE;AACD;AACF;AAED;AzCiuYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyCjuYO;AACL;AACA;AACA;AACA;AzCmuYF;AyCluYE;AACE;AACD;AACC;AACD;AzCouYH;AACA;AyCluYE;AACE;AACD;AzCouYH;AyCnuYE;AACD;AAED;AzCouYA;AACA;AACA;AACA;AACA;AACA;AyCpuYO;AACL;AAKD;AAED;AzCiuYA;AACA;AACA;AACA;AACA;AACA;AyCjuYO;AACL;AAID;AAED;AzC+tYA;AACA;AACA;AACA;AACA;AACA;AyC/tYO;AACL;AAIA;AACD;AAED;AzC6tYA;AACA;AACA;AACA;AACA;AACA;AyC7tYO;AACL;AACE;AACD;AzC+tYH;AyC9tYE;AACD;AAED;AzC+tYA;AACA;AACA;AACA;AACA;AyC/tYA;AACE;AACD;AAED;AzCguYA;AACA;AACA;AACA;AACA;AACA;AyChuYO;AACL;AACE;AAAQ;AAAO;AAChB;AAEA;AACF;AAED;AzCkuYA;AACA;AACA;AACA;AACA;AACA;AyCluYO;AACL;AACD;AAED;AzCmuYA;AACA;AACA;AACA;AACA;AACA;AyCnuYO;AACL;AAEA;AzCouYF;AyCnuYE;AAGE;AAEH;AAED;AzCiuYA;AACA;AACA;AACA;AACA;AACA;AACA;AyCjuYO;AACL;AzCmuYF;AyCluYE;AACE;AACA;AACD;AAED;AzCmuYF;AACA;AyCnuYE;AACE;AACA;AACA;AACD;AzCquYH;AyCnuYE;AACD;AAED;AzCouYA;AACA;AACA;AACA;AACA;AACA;AyCpuYO;AACL;AzCsuYF;AyC/tYE;AACE;AACD;AACF;AAED;AzCguYA;AACA;AACA;AACA;AACA;AACA;AyChuYO;AACL;AzCkuYF;AyC3tYE;AACE;AACA;AACD;AzC6tYH;AyCxuYwC;AzC0uYxC;AyC7tYE;AACE;AACD;AzC+tYH;AyC9tYE;AzCguYF;AyCztYE;AACE;AACD;AACF;AAED;AzC0tYA;AACA;AACA;AACA;AACA;AACA;AACA;AyC1tYO;AAAsC;AzC6tY7C;AyC3tYE;AACE;AACD;AzC6tYH;AyCjuY6C;AzCmuY7C;AyC7tYE;AACE;AACD;AzC+tYH;AyC9tYE;AAKA;AACD;AAED;AzC2tYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC3tYO;AACL;AACD;AAED;AzC4tYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC5tYO;AACL;AACE;AACD;AzC8tYH;AyC5tYE;AACA;AzC8tYF;AyC1tYE;AACE;AACD;AzC4tYH;AACA;AyC1tYE;AACD;AAED;AzC2tYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyC3tYO;AACL;AACA;AzC6tYF;AyC3tYE;AACE;AACE;AACD;AACC;AACD;AACF;AzC6tYH;AyC3tYE;AACD;AAED;AzC4tYA;AACA;AACA;AACA;AACA;AyC5tYO;AAAwC;AAE7C;AAAwB;AAAO;AAC/B;AAAsC;AAAO;AAC7C;AACD;AzCkuYD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0C1naA;A1C4naA;A0C3naA;A1C6naA;A0CnnaA;A1CqnaA;A0CpnaA;A1CsnaA;AACA;AACA;AACA;AACA;A0CtpaA;A1CwpaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0CxoaA;A1C0oaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0CxoaO;AACL;AACS;AAAA;AAEV;AAED;A1CyoaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0CzoaO;AACL;A1C2oaF;A0C1oaE;AACE;AAAO;AAAkC;AAAzC;AACD;A1C+oaH;A0C9oaE;AACD;AAED;A1C+oaA;AACA;AACA;AACA;AACA;AACA;A0C/oaA;AACE;AACA;AACE;AACD;A1CipaH;A0ChpaE;AACD;AAED;A1CipaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0CjpaO;AACL;AAKc;AAAA;AACf;AAED;A1C+oaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0C/oaO;AAML;A1C4oaF;A0C3oaE;AACE;AAAO;AAAkC;AAAzC;AACD;A1CgpaH;A0C/oaE;AACA;AAEQ;AAAA;AAIJ;AACA;AACA;AACE;AACD;AACC;AACD;A1C8oaP;A0C7oaM;AACD;AACJ;AAED;A1C8oaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0C9oaO;AAKL;A1C4oaF;A0C3oaE;AACE;AAAO;AAAkC;AAAzC;AACD;A1CgpaH;A0C/oaE;AACA;A1CipaF;A0C/oaE;AACE;AACD;AACC;AACA;AACD;AACF;AAED;A1CgpaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0ChpaA;AACE;AAAO;AAAwB;AAA/B;AAUD;AAED;A1C2oaA;AACA;AACA;AACA;AACA;AACA;A0C3oaO;AACL;AACA;AACE;AACD;A1C6oaH;A0C5oaE;AAEA;A1C6oaF;A0C5oaE;A1C8oaF;A0C3oaE;AACE;AACA;AAGA;AACD;A1C2oaH;A0C1oaE;AACD;AAED;A1C2oaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0C3oaO;AACL;AACE;AACD;AACF;AAED;A1C4oaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0C5oaA;AACE;AACD;AAED;A1C6oaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0C7oaA;AACE;A1C+oaF;AACA;AACA;AACA;AACA;AACA;A0C5oaE;AACA;AACA;AACE;AACD;A1C8oaH;A0C5oaE;AACA;AAAO;AAAkC;AAAzC;AAID;AAED;A1C6oaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0C7oaA;AACE;AAEQ;AAAA;AAEJ;AACA;AACA;AACE;AACD;AACC;AACD;A1C8oaP;A0C7oaM;AACD;AACJ;A1C+oaD;AACA;AACA;AACA;AACA;AACA;AACA;A2Cn7aA;A3Cq7aA;A2Cp7aA;A3Cs7aA;AACA;AACA;AACA;AACA;A2Cx7aA;AACO;A3C07aP;AACA;AACA;AACA;AACA;AACA;AACA;A2C77aE;AACA;AAAqB;A3Cg8avB;A2C/7aI;AACA;AAFmB;AAGpB;AAED;A3Ci8aF;AACA;AACA;AACA;AACA;A2Cn8aI;AACD;AAED;A3Co8aF;AACA;AACA;A2Cp8aI;AACA;AACA;AACD;AAED;A3Cq8aF;AACA;AACA;A2Cr8aI;AACA;AACD;A3Cu8aH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4C7/aA;A5C+/aA;A4C9/aA;A5CggbA;A4C//aA;A5CigbA;A4C1/aA;A5C4/aA;A4C3/aA;A5C6/aA;A4C5/aA;A5C8/aA;A4C7/aA;A5C+/aA;A4C9/aA;A5CggbA;A4C//aA;A5CigbA;A4ChgbA;A5CkgbA;A4CjgbA;A5CmgbA;A4ClgbA;A5CogbA;A4CngbA;A5CqgbA;A4CvibA;A5CyibA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4CnhbA;A5CqhbA;AACA;A4CnhbA;AAEA;A5CohbA;AACA;AACA;A4CnhbA;AAEA;A5CohbA;AACA;AACA;A4CnhbA;AAEA;A5CohbA;AACA;AACA;AACA;AACA;A4CnhbA;AAEA;A5CohbA;AACA;AACA;AACA;AACA;A4CnhbA;AAEA;A5CohbA;AACA;AACA;AACA;A4CnhbA;A5CqhbA;A4CnhbA;AAEA;A5CohbA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4CnhbA;AACE;AACE;AACD;A5CqhbH;A4CphbE;AACD;AAED;A5CqhbA;AACA;AACA;AACA;AACA;AACA;AACA;A4CrhbA;AACE;AACA;AACA;AACD;AAED;A5CshbA;AACA;AACA;AACA;AACA;AACA;A4CthbA;AACE;AACE;AACA;AAAsB;AAA4B;AACnD;AACC;AACD;AACF;AAED;A5CyhbA;AACA;AACA;AACA;AACA;AACA;A4CzhbA;AAEA;A5C0hbA;AACA;AACA;AACA;AACA;A4CzhbO;AACL;A5C2hbF;A4C1hbE;AAME;AAAuB;AAAuB;AAC/C;AACF;AAED;A5CwhbA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4CxhbO;AACL;AACE;AACA;A5C0hbJ;A4CzhbI;AACE;AACE;AAAkC;AAAuB;AACzD;AACD;AACC;AACA;AACA;AACD;AACF;AACC;AACD;A5C6hbL;AACA;A4C5hbI;AACE;AACE;AAGA;AACD;AACF;A5C4hbL;A4C1hbI;AACE;AAAO;AAAuB;AAA9B;AACD;A5C+hbL;A4C9hbI;A5CgibJ;A4C7hbI;A5C+hbJ;A4C9hbI;AACE;A5CgibN;A4C/hbM;AACE;AACA;AACD;AACF;A5CiibL;AACA;A4C/hbI;AACE;A5CiibN;A4ChibM;AACE;AACD;AACC;AACE;AACD;AACC;AACD;AACC;AACD;AACF;AACF;A5CkibL;A4CjibI;AACE;AACD;AAGD;A5CiibJ;AACA;A4CjibI;AAQD;AACC;AACE;AACD;AACF;A5C4hbH;A4C3hbE;AAAO;AAAuB;AAA9B;AACD;AAED;A5C+hbA;AACA;AACA;AACA;AACA;A4C/hbO;AACL;AACD;AAED;A5CgibA;AACA;AACA;AACA;AACA;A4ChibO;AACL;AACE;AACD;A5CkibH;A4CjibE;AACE;AACD;A5CmibH;A4ClibE;AACE;AACD;A5CoibH;A4CnibE;AACD;AAED;A5CoibA;AACA;AACA;AACA;AACA;A4CpibO;AACL;AACD;AAED;A5CqibA;AACA;AACA;AACA;AACA;A4CribO;AACL;AACE;AACD;A5CuibH;A4CtibE;AACE;AACD;A5CwibH;A4CvibE;AACE;AACD;A5CyibH;A4CxibE;AACD;AAED;A5CyibA;AACA;AACA;AACA;AACA;A4CzibO;AACL;AAAc;AAA0B;AACxC;AACE;AAME;AACA;AACD;A5CwibL;A4CvibI;AACD;AACF;AAED;A5CwibA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4CxibA;AAAsD;A5C2ibtD;A4C1ibE;AACA;AACE;AACD;A5C4ibH;A4C3ibE;AACE;AACD;A5C6ibH;A4C5ibE;A5C8ibF;A4C7ibE;AACE;AACD;AAEA;A5C8ibH;A4C7ibE;AACE;AACA;AACA;AACA;AACD;A5C+ibH;A4C9ibE;A5CgjbF;A4CxibE;AACE;AACE;AACE;AAEE;AAA4B;AAG7B;AACF;AAEA;AACF;AACF;AACF;AAED;A5CsibA;AACA;AACA;AACA;AACA;AACA;AACA;A4CtibO;AACL;AACA;AACA;AACA;AACE;AACE;AACA;AACA;AACD;AACF;AACF;AAED;A5CuibA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4CvibO;AACL;A5CyibF;A4CxibE;AACE;AACD;A5C0ibH;A4CzibE;AACA;AACA;A5C2ibF;A4C1ibE;AACE;AACD;A5C4ibH;A4C3ibE;A5C6ibF;A4C5ibE;AACE;AACD;A5C8ibH;A4C7ibE;AACE;AACE;AACD;A5C+ibL;A4C9ibI;AACA;AACD;AACF;AAED;A5C+ibA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4C/ibO;AACL;AACE;AAA2B;AAC3B;AAA2B;AAC3B;AAA2B;AAC3B;AAA6B;AAC7B;AAA6B;AAC7B;AAA2B;AAC3B;A5CujbJ;A4C9jbc;AASb;AAED;A5CujbA;AACA;AACA;AACA;AACA;AACA;A4CvjbA;AACE;AACE;AACE;AACD;AACC;AACA;AACD;AACF;A5CyjbH;A4CxjbE;AACE;AACD;A5C0jbH;A4CxjbE;AACD;AAED;A5CyjbA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4CzjbO;AAQL;AAEA;AACA;AACA;AACA;AACA;A5CmjbF;A4CljbE;A5CojbF;A4CnjbE;AACE;AACD;A5CqjbH;A4CpjbE;AACE;AACD;A5CsjbH;A4CpjbE;AACA;AAGA;A5CojbF;A4CnjbE;AAGE;AACA;AAEA;AACA;AAEA;A5CijbJ;A4C/ibI;AACE;AACD;AACF;A5CijbH;A4C/ibE;A5CijbF;A4C9ibE;AACE;AACD;AAGD;AACA;AACA;A5C8ibF;AACA;A4C9ibE;AAAa;AAA4B;AACzC;AACA;AACA;AACA;AAGA;A5CgjbF;A4C/ibE;AACA;AAEA;A5CgjbF;A4C/ibE;AACE;AACA;AACD;AACC;AACD;A5CijbH;A4C/ibE;AACE;AACD;A5CijbH;A4C/ibE;A5CijbF;A4C9ibE;AACE;AACD;AAGD;A5C8ibF;AACA;A4C9ibE;A5CgjbF;A4C7ibE;A5C+ibF;A4C7ibE;AACE;AACD;A5C+ibH;A4C9ibE;AACE;AACD;A5CgjbH;AACA;A4C/ibE;AACE;AACD;A5CijbH;A4C/ibE;AACE;AACA;A5CijbJ;A4ChjbI;AACE;AACD;A5CkjbL;A4CjjbI;AACE;AACD;AACF;A5CmjbH;A4CjjbE;AACE;AACD;A5CmjbH;A4CljbE;AAEA;AACA;A5CmjbF;A4CljbE;AACE;AACA;AACD;A5CojbH;A4CnjbE;A5CqjbF;A4CnjbE;AACE;A5CqjbJ;A4CljbI;A5CojbJ;A4CljbI;AACE;AACD;A5CojbL;A4CljbI;AACE;AACD;A5CojbL;AACA;A4CljbI;AACE;AACD;AACF;AACC;AACA;AACA;AACD;A5CojbH;A4CnjbE;AACA;AACA;AAEA;AAEA;AACD;AAED;A5CkjbA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4CljbO;AACL;AACE;AACD;A5CojbH;A4CnjbE;A5CqjbF;A4CpjbE;AACE;AACE;AACD;AACF;A5CsjbH;A4CrjbE;AACD;AAED;A5CsjbA;AACA;AACA;AACA;A4CtjbO;AACL;AACD;AAED;A5CujbA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4CvjbO;AACL;AACA;A5CyjbF;A4CxjbE;AACE;AACD;A5C0jbH;A4CzjbE;A5C2jbF;A4C1jbE;AACE;AACD;AAAW;A5C6jbd;A4CzjbI;AACE;AACD;A5C2jbL;AACA;A4CzjbI;AACE;AACD;AAGD;AACA;AACA;AACA;AACA;A5CyjbJ;AACA;A4CzjbI;A5C2jbJ;A4C1jbI;AACE;AACD;A5C4jbL;AACA;A4C1jbI;AACE;AACD;AACF;A5C4jbH;A4C1jbE;AACD;AAED;A5C2jbA;AACA;AACA;AACA;AACA;A4C3jbO;AACL;AACA;AACA;AACE;AACE;AACA;AAFgB;AAIlB;AACD;AACF;AAED;A5C4jbA;AACA;AACA;AACA;AACA;AACA;A4C5jbA;AACE;A5C8jbF;A4C3jbE;AACD;A5C6jbD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6CrxcA;A7CuxcA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6CrxcA;A7CuxcA;AACA;AACA;AACA;A6CrxcA;AAEA;A7CsxcA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6CrxcO;AAML;AACA;AACA;A7CkxcF;AACA;AACA;A6CjxcE;A7CmxcF;A6CjxcE;AACE;AACE;AACD;AACC;AACA;A7CmxcN;A6ClxcM;AACD;AACF;A7CoxcH;A6CnxcE;AACA;A7CqxcF;A6CpxcE;AACE;AACD;A7CsxcH;A6CrxcE;AAKA;AACE;AACE;AAKD;A7C+wcL;AACA;A6C9wcI;AACA;AACA;AACD;AACF;AAED;A7C+wcA;AACA;AACA;AACA;AACA;AACA;AACA;A6C/wcO;AACL;AACA;AACE;AACD;A7CixcH;A6C/wcE;A7CixcF;A6ChxcE;AACE;AACA;AACE;AACE;AACD;A7CkxcP;A6CrxcoB;AAKhB;AACA;AACD;AAEA;A7CkxcH;A6CjxcE;AACD;AAED;A7CkxcA;AACA;AACA;AACA;A6ClxcO;AACL;AACD;A7CoxcD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Cv4cA;A9Cy4cA;A8Cx4cA;A9C04cA;A8Cz4cA;A9C24cA;A8C75cA;A9C+5cA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Cz5cA;AACA;AAEA;A9C05cA;A8Cz5cO;AAEP;A9C05cA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8C35cO;AACL;AAAkB;AAAiC;AAAC;AAAD;AACnD;AAEA;A9Cg6cF;A8C/5cE;AACE;AACD;AACC;AACA;AACA;AAMA;AACD;AACF;AAED;A9C25cA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8C35cO;AACL;AAMD;AAED;A9Cu5cA;AACA;AACA;AACA;AACA;AACA;A8Cv5cO;AACL;AAAO;AAA6C;AAApD;AACD;AAED;A9C25cA;AACA;AACA;AACA;AACA;AACA;A8C35cO;AACL;AAAO;AAA6C;AAApD;AACD;AAED;A9C+5cA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8C/5cO;AACL;AACA;AAII;AACE;AACD;AACC;AACA;AACA;AACD;AACF;AAGH;AACD;AAED;A9C25cA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8C35cO;AAML;AACA;AACE;AACD;AACD;A9Cw5cF;A8Cv5cE;AACE;AACD;A9Cy5cH;A8Cx5cE;AACD;AAED;A9Cy5cA;AACA;AACA;AACA;AACA;AACA;A8Cz5cO;AACL;AAKE;AACC;AAEJ;AAED;A9Cq5cA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Cr5cO;AACL;AACA;A9Cu5cF;A8Ct5cE;AACE;AACD;A9Cw5cH;A8Cv5cE;A9Cy5cF;A8Cx5cE;AAIE;AACD;A9Cu5cH;A8Ct5cE;AACE;AACA;AACA;AACE;AACA;AACA;AACE;AADgE;AAGnE;AACC;AACD;A9Cw5cL;AACA;A8Cv5cI;AACE;AACD;A9Cy5cL;A8Cx5cI;AAEA;AACA;A9Cy5cJ;A8Cx5cI;AACE;AAEO;AAAA;A9C05cb;A8Cx5cM;AACE;AACD;AACF;A9C05cL;A8Cz5cI;AACD;AAED;AAEI;AACE;AACD;A9Cy5cP;A8Cx5cM;AACD;AAEC;AACE;AACD;A9Cy5cP;A8Cx5cM;AACD;AAEJ;AAED;A9Cw5cA;AACA;AACA;AACA;AACA;AACA;A8Cx5cA;AACE;AACA;AACA;AACA;AACE;AAED;AAGD;A9Cu5cF;AACA;A8Cv5cE;A9Cy5cF;A8Cx5cE;AACE;AACD;A9C05cH;A8Cz5cE;AACD;AAED;A9C05cA;AACA;AACA;AACA;AACA;AACA;A8C15cA;AACE;AACD;AAED;A9C25cA;AACA;AACA;AACA;AACA;AACA;A8C35cO;AACL;AACD;A9C65cD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+CpqdA;A/CsqdA;A+CrqdA;A/CuqdA;A+CtqdA;A/CwqdA;A+CvqdA;A/CyqdA;A+CnsdA;A/CqsdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+CnsdA;A/CqsdA;AACA;AACA;AACA;AACA;AACA;A+C9rdA;AACA;AAEA;A/C+rdA;A+C9rdA;AAEA;A/C+rdA;A+C9rdA;AAEA;A/C+rdA;AACA;AACA;AACA;AACA;AACA;A+C9rdO;AAEP;A/C+rdA;AACA;AACA;AACA;AACA;AACA;AACA;A+ChsdO;AACL;AACD;AAED;A/CisdA;AACA;AACA;AACA;AACA;AACA;A+CjsdO;AACL;AAGD;AAED;A/CgsdA;AACA;AACA;AACA;AACA;AACA;AACA;A+ChsdO;AACL;AACA;AACD;AAED;A/CisdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+CjsdO;AAML;AAAwC;AAAO;AAC/C;A/CgsdF;A+C/rdE;AACE;AACA;A/CisdJ;A+C/rdI;AACE;AACA;AACA;A/CisdN;A+C/rdM;AACE;AAOD;AACF;AACF;A/C2rdH;A+C1rdE;AACD;AAED;A/C2rdA;AACA;AACA;AACA;AACA;AACA;AACA;A+C3rdO;AACL;AACE;AACD;A/C6rdH;A+C5rdE;AACA;A/C8rdF;A+C3rdE;AACE;AACE;A/C6rdN;A+C5rdM;AACE;AACD;AACF;AACF;A/C8rdH;AACA;A+C7rdE;AAKE;AACA;A/C2rdJ;A+CxrdI;AACE;A/C0rdN;A+CzrdM;AACE;AACE;AACD;AACF;AACF;AACF;A/C2rdH;A+CzrdE;A/C2rdF;A+CzrdE;AAKE;AACA;AACA;A/CurdJ;A+CtrdI;AACE;A/CwrdN;A+CvrdM;AACE;AACD;A/CyrdP;A+CxrdM;AACE;AACD;AACF;AACF;A/C0rdH;A+CzrdE;AACD;AAED;A/C0rdA;AACA;AACA;AACA;AACA;AACA;AACA;A+C1rdO;AACL;AACD;AAED;A/C2rdA;AACA;AACA;AACA;AACA;AACA;A+C3rdA;AACE;A/C6rdF;A+C5rdE;AACE;AACE;AACD;AACF;AACC;AACD;A/C8rdH;A+C7rdE;AAEA;A/C8rdF;A+C7rdE;AACE;AACE;AACD;A/C+rdL;A+C9rdI;AACE;AACD;AACC;AACD;AACF;A/CgsdH;A+C/rdE;AACD;AAED;A/CgsdA;AACA;AACA;AACA;AACA;AACA;A+ChsdA;AACE;A/CksdF;A+CjsdE;AACE;AACD;A/CmsdH;A+ClsdE;AACE;AACE;AACD;AACF;AACC;AACD;AACF;AAED;A/CmsdA;AACA;AACA;AACA;AACA;AACA;AACA;A+CnsdO;AACL;AACD;AAED;A/CosdA;AACA;AACA;AACA;AACA;AACA;A+CpsdO;AACL;AACA;AACD;AAED;A/CqsdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+CrsdA;AACE;AACA;AACD;AAED;A/CssdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+CtsdO;AACL;AADsC;AAIxC;A/CusdA;AACA;AACA;AACA;AACA;AACA;AACA;A+CxsdA;AACE;AACA;AACD;AAED;A/CysdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+CzsdO;AACL;AACA;A/C2sdF;A+C1sdE;AACE;AACA;AACA;AACE;AACD;A/C4sdL;A+C3sdI;AACE;AAEA;AACD;A/C4sdL;A+C1sdI;AAIE;AACA;AACD;AAGD;AACA;A/CusdJ;AACA;A+CvsdI;AAEsB;AAAO;AAC3B;AAEA;AAGA;AAED;AACF;A/CqsdH;A+CpsdE;AACD;AAED;A/CqsdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+CrsdO;AACL;AAGD;AAED;A/CosdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+CpsdO;AACL;AACA;AACA;AACD;A/CssdD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgDhleA;AhDkleA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgDhleA;AhDkleA;AACA;AACA;AACA;AACA;AACA;AgDhleO;AACL;AACA;AACE;AACD;AACF;AAED;AhDileA;AACA;AACA;AACA;AACA;AACA;AgDjleO;AACL;AACA;AACA;AACE;AACA;AACA;AACD;AACF;AAED;AhDkleA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgDlleO;AACL;AACA;AhDoleF;AgDnleE;AACE;AACD;AhDqleH;AgDpleE;AACD;AhDsleD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiD3oeA;AjD6oeA;AiD5oeA;AjD8oeA;AiD7oeA;AjD+oeA;AiD9oeA;AjDgpeA;AiD/oeA;AjDipeA;AiDhpeA;AjDkpeA;AiDjpeA;AjDmpeA;AiDzqeA;AjD2qeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiDjqeA;AjDmqeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiDjqeO;AAKL;AAFA;AAEA;AjDiqeF;AiDjqeE;AADA;AACA;AjDqqeF;AiDpqeE;AAAY;AAA0B;AACtC;AAII;AACA;AAFG;AAKP;AAII;AADG;AAIP;AACA;AACA;AjDgqeF;AiD7peE;AACE;AACA;AjD+peJ;AiD5peI;AjD8peJ;AiD7peI;AAAW;AAAO;AACnB;AACC;AACE;AACD;AACF;AjDiqeH;AiDhqeE;AACA;AACD;AAED;AjDiqeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiDnqeE;AjDqqeF;AACA;AACA;AiDnqeE;AAA4B;AjDsqe9B;AiDrqeI;AACA;AjDuqeJ;AiDtqeI;AAEA;AjDuqeJ;AiDtqeI;AAEA;AjDuqeJ;AiDtqeI;AjDwqeJ;AiDtqeI;AACE;AACA;AAIA;AACA;AACD;AjDqqeL;AiDnqeI;AAII;AACD;AACJ;AAED;AjDiqeF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiDnqeI;AAIA;AAKD;AACD;AjD8peF;AACA;AACA;AACA;AACA;AACA;AiD9peI;AACD;AjDgqeH;AACA;AACA;AiD/peA;AjDiqeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiDnqeE;AACA;AACE;AACA;AAEA;AjDoqeJ;AiDnqeI;AAAe;AAA2B;AACxC;AACA;AAFwC;AAI3C;AAED;AjDsqeF;AACA;AACA;AACA;AACA;AACA;AACA;AiDxqeI;AACD;AAED;AjDyqeF;AACA;AACA;AACA;AACA;AiDzqeI;AACD;AAED;AjD0qeF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiD1qeI;AACA;AAIA;AjDyqeJ;AiDxqeI;AACE;AACA;AACA;AACD;AjD0qeL;AiDzqeI;AACE;AACA;AAFoC;AAItC;AACD;AAED;AjD0qeF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiD1qeI;AACA;AAEE;AAA4B;AAE9B;AACA;AACD;AjD2qeH;AACA;AACA;AiD1qeA;AjD4qeA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiD9qeO;AACL;AACA;AjDgreF;AiD9qeE;AAII;AACE;AACD;AjD6qeP;AiD5qeM;AACE;AACE;AACA;AACD;AjD8qeT;AiD7qeQ;AACA;AACD;AACF;AjD+qeL;AiD5qeE;AAII;AjD2qeN;AiD1qeM;AACE;AACA;AACD;AACF;AACJ;AjD4qeD;AACA;AACA;AACA;AACA;AACA;AACA;AkDn6eA;AlDq6eA;AkDr7eA;AlDu7eA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkDn7eA;AlDq7eA;AACA;AACA;AACA;AACA;AkDr7eE;AlDu7eF;AACA;AACA;AACA;AkDr7eE;AACE;AlDu7eJ;AACA;AACA;AkDr7eI;AAEA;AlDs7eJ;AACA;AACA;AACA;AACA;AkDr7eI;AACD;AAED;AlDs7eF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkDx7eI;AACA;AAIA;AACD;AAED;AlDs7eF;AACA;AACA;AACA;AACA;AACA;AACA;AkDt7eI;AACA;AAEA;AACA;AlDu7eJ;AkDr7eI;AACE;AACD;AACF;AAED;AlDs7eF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkDt7eI;AACD;AlDw7eH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmDvgfA;AnDygfA;AmDxgfA;AnD0gfA;AmDzgfA;AnD2gfA;AmD7hfA;AnD+hfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmDzhfA;AnD2hfA;AACA;AACA;AACA;AACA;AACA;AmD3hfE;AnD6hfF;AACA;AACA;AmD3hfE;AAA+B;AnD8hfjC;AmD7hfI;AACA;AAEA;AnD8hfJ;AmD7hfI;AAEA;AnD8hfJ;AmD7hfI;AAEA;AnD8hfJ;AmD7hfI;AAEA;AnD8hfJ;AACA;AACA;AACA;AmD7hfI;AACE;AACA;AACE;AACD;AACF;AAED;AnD8hfJ;AACA;AACA;AACA;AACA;AmD9hfI;AACE;AACA;AACA;AACA;AACE;AACD;AACF;AnDgifL;AmD/hfI;AACA;AACD;AAED;AnDgifF;AACA;AACA;AACA;AACA;AmDlifI;AACA;AACD;AAED;AnDmifF;AACA;AACA;AACA;AACA;AACA;AACA;AmDnifI;AACD;AAED;AnDoifF;AACA;AACA;AACA;AACA;AACA;AmDpifI;AnDsifJ;AmDrifI;AAIE;AAAoB;AAAa;AAAd;AACpB;AACC;AACD;AnDuifL;AmDtifI;AACA;AACD;AAED;AnDuifF;AACA;AACA;AACA;AACA;AACA;AmDvifI;AACE;AACD;AnDyifL;AmDxifI;AACD;AAED;AnDyifF;AACA;AACA;AACA;AACA;AACA;AmDzifI;AnD2ifJ;AmD1ifI;AACE;AACE;AACA;AACD;AACF;AnD4ifL;AmD3ifI;AACE;AACD;AACF;AAED;AnD4ifF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmD5ifI;AACE;AACD;AnD8ifL;AmD7ifI;AACE;AACE;AACD;AACF;AnD+ifL;AmD9ifI;AACD;AnDgjfH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoD/rfA;ApDisfA;AoDhsfA;ApDksfA;AoDjsfA;ApDmsfA;AoDlsfA;ApDosfA;AACA;AACA;AoDpsfA;ApDssfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDpsfO;AACL;ApDssfF;AoDpsfE;AACE;AACD;AACC;AACD;AACC;AACD;AACF;AAED;ApDqsfA;AACA;AACA;AACA;AACA;AACA;AoDrsfO;AACL;AACA;AACD;AAED;ApDssfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDxsfE;AACA;AAAkC;AAAtB;AAAsB;ApD6sfpC;AoD5sfI;AACA;AACD;AAED;ApD6sfF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoD/sfI;AACA;AACA;AACA;AACA;AACD;AAED;ApDgtfF;AACA;AACA;AoDhtfI;AACD;AAED;ApDitfF;AACA;AACA;AoDltfY;ApDotfZ;AoDntfI;AACA;AACE;AACA;AAAoB;AAAA;AACrB;AAGD;ApDqtfJ;AoDptfI;AACA;AAAO;AAA0C;AAC/C;AACE;AACK;AAAkC;AAAnC;AACC;AAAkB;AAAnB;AACL;AAL8C;AAAjD;AAOD;AAED;ApD4tfF;AACA;AACA;AoD7tfgB;ApD+tfhB;AoD9tfI;AAEA;AACE;AACA;AAAoB;AAAA;AACrB;AAED;AACD;ApDgufH;AACA;AACA;AoD/tfA;ApDiufA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDrufE;AACA;AACE;AACA;AAEA;AACD;AAED;ApDqufF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDvufI;AACA;AACA;AACE;AACD;ApDyufL;AoDvufI;ApDyufJ;AoDxufI;AACE;AACD;AACF;AAED;ApDyufF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDzufI;AACD;AAED;ApD0ufF;AACA;AACA;AoD1ufI;AACD;AAED;ApD2ufF;AACA;AACA;AoD3ufI;AACD;AAED;ApD4ufF;AACA;AACA;AoD5ufI;AACD;ApD8ufH;AACA;AACA;AoD7ufA;ApD+ufA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDnvfE;AACA;AAAsB;ApDsvfxB;AoDrvfI;ApDuvfJ;AoDrvfI;AACE;AACE;AACE;ApDuvfV;AoDtvfU;AACD;AACF;AACF;ApDwvfL;AoDlwfwB;AAWrB;AAED;ApDyvfF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoD3vfI;AACA;AACE;AACD;AACC;AACD;AACF;ApD6vfH;AACA;AACA;AoD5vfA;ApD8vfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDhwfE;ApDkwfF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDhwfE;AAEA;ApDiwfF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDlwfE;ApDowfF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDnwfE;ApDqwfF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDpwfE;ApDswfF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDvwfA;ApDywfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoDzwfA;AACE;AACD;ApD2wfD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqDjkgBA;ArDmkgBA;AqDnlgBA;ArDqlgBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqDjlgBA;AACA;AAEA;ArDklgBA;AACA;AACA;AACA;AqDjlgBO;AACL;AACD;AAED;ArDklgBA;AACA;AACA;AACA;AACA;AqDllgBO;AACL;AACD;AAED;ArDmlgBA;AACA;AACA;AACA;AACA;AACA;AACA;AqDnlgBO;AAA+B;AAEpC;AAAa;AAA4B;ArDulgB3C;AqDrlgBE;ArDulgBF;AqDrlgBE;AACA;ArDulgBF;AqD9lgBsC;AAUlC;AAVkC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;ArDwmgBtC;AqD5lgBI;AAOE;AACD;ArDwlgBL;AqDtlgBI;AACE;AACD;ArDwlgBL;AqDtlgBI;AACE;AACE;AACE;AACD;AACF;AACD;AACD;ArDwlgBL;AqDvlgBI;AAlCkC;ArD4ngBtC;AqDnngBE;AAA0C;ArDsngB5C;AqDtngB4C;AA0BzC;ArD+lgBH;AqD7lgBE;ArD+lgBF;AqD9lgBE;AAAuC;ArDimgBzC;AqD/lgBI;AACE;AACD;ArDimgBL;AqDhmgBI;AACD;AAGD;AACA;AACA;AACA;AACA;ArDgmgBF;AACA;AqDhmgBE;AACE;AACE;AACD;AACF;AAED;AACD;AAED;ArDgmgBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqDhmgBO;AAAmC;AAAA;AAAA;AAIxC;ArDkmgBF;AqDhmgBE;AACE;ArDkmgBJ;AqDhmgBI;AACE;AACD;ArDkmgBL;AqDhmgBI;AACE;AACD;ArDkmgBL;AqDhmgBI;AACE;AACD;AACF;ArDkmgBH;AqDjmgBE;AACD;AAED;ArDkmgBA;AACA;AACA;AACA;AACA;AACA;AqDlmgBA;AAAiC;AAAA;AAE/B;AACD;AAED;ArDomgBA;AACA;AACA;AACA;AACA;AACA;AqDpmgBO;AACL;AACE;AACD;ArDsmgBH;AqDpmgBE;ArDsmgBF;AqDrmgBE;AACE;AACE;AACD;AACF;ArDumgBH;AqDtmgBE;AACD;AAED;ArDumgBA;AACA;AACA;AACA;AACA;AACA;AqDvmgBO;AACL;AACE;AACA;AAAA;ArD0mgBJ;AqDxmgBM;AACE;AACE;AACD;AACF;ArD0mgBP;AqDzmgBM;ArD2mgBN;AqD1mgBI;AACA;AACE;ArD4mgBN;AqD3mgBI;AACE;AAdJ;ArD4ngBF;AqD5mgBE;AACD;AAED;ArD6mgBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqD7mgBO;AACL;AACE;AACE;AACE;AACD;AACC;AACD;ArD+mgBP;AqD9mgBI;AACE;ArDgngBN;AqD/mgBI;AACE;AACA;ArDingBN;AqDhngBI;AACE;AAbJ;AAiBD;ArDgngBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsDn0gBA;AtDq0gBA;AsDp0gBA;AtDs0gBA;AsDr0gBA;AtDu0gBA;AsDt0gBA;AtDw0gBA;AsDv0gBA;AtDy0gBA;AsDx0gBA;AtD00gBA;AsDz0gBA;AtD20gBA;AsD10gBA;AtD40gBA;AsD30gBA;AtD60gBA;AsDx0gBA;AtD00gBA;AsDz0gBA;AtD20gBA;AsDp0gBA;AtDs0gBA;AsDr0gBA;AtDu0gBA;AsDt0gBA;AtDw0gBA;AsDv0gBA;AtDy0gBA;AsDx0gBA;AtD00gBA;AsDz0gBA;AtD20gBA;AsD10gBA;AtD40gBA;AsD30gBA;AtD60gBA;AsD50gBA;AtD80gBA;AsD70gBA;AtD+0gBA;AsD90gBA;AtDg1gBA;AsD/0gBA;AtDi1gBA;AsD10gBA;AtD40gBA;AsD30gBA;AtD60gBA;AsDr4gBA;AtDu4gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsD31gBA;AtD61gBA;AACA;AsD31gBO;AACL;AACA;AACA;AAHiC;AAMnC;AtD41gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsD51gBO;AAEP;AtD61gBA;AACA;AACA;AACA;AACA;AsD71gBA;AAEA;AtD81gBA;AACA;AACA;AACA;AsD71gBO;AACL;AACD;AAED;AtD81gBA;AACA;AACA;AACA;AACA;AsD91gBA;AACE;AACE;AACD;AtDg2gBH;AsD/1gBE;AACD;AAED;AtDg2gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsDh2gBO;AACL;AACD;AAED;AtDi2gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsDj2gBO;AAAA;AAML;AACA;AACA;AtD+1gBF;AsD91gBE;AtDg2gBF;AsD/1gBE;AACA;AtDi2gBF;AsDh2gBE;AAIA;AACA;AACA;AACA;AtD+1gBF;AsD51gBE;AACE;AAAqC;AAAA;AAGtC;AtD81gBH;AsD51gBE;AtD81gBF;AsD31gBE;AACE;AACA;AACD;AtD61gBH;AsD51gBE;AACE;AAGI;AACD;AAEJ;AtD21gBH;AsD11gBE;AtD41gBF;AsD31gBE;AACE;AACA;AACA;AACA;AACD;AACC;AACA;AACA;AACA;AACA;AACA;AAEA;AtD41gBJ;AsD31gBI;AACA;AACD;AAGD;AACA;AACA;AACA;AACA;AtD21gBF;AACA;AsD31gBE;AtD61gBF;AsD51gBE;AACE;AACD;AACC;AACE;AACA;AACE;AACE;AACA;AACD;AACF;AAAE;AAAmB;AAGtB;AtD81gBN;AsD71gBM;AAEI;AACD;AAEC;AACA;AACD;AACJ;AACF;AtD61gBH;AsD31gBE;AACE;AAAiB;AAAwB;AACzC;AACA;AAEuD;AAAD;AAEtD;AACA;AtD81gBJ;AsD31gBI;AACE;AAMD;AACC;AAMD;AtDm1gBL;AACA;AsDl1gBI;AACA;AACD;AACF;AAED;AtDm1gBA;AACA;AACA;AACA;AACA;AACA;AsDn1gBA;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AAMD;AAED;AtD+0gBA;AACA;AACA;AACA;AACA;AACA;AsD/0gBA;AACE;AACA;AtDi1gBF;AsD90gBE;AtDg1gBF;AsD/0gBE;AACE;AACD;AtDi1gBH;AsDh1gBE;AACE;AACD;AtDk1gBH;AsDj1gBE;AACE;AtDm1gBJ;AsDl1gBI;AACE;AACD;AACF;AtDo1gBH;AsDl1gBE;AtDo1gBF;AsDj1gBE;AACE;AACD;AtDm1gBH;AACA;AsDj1gBE;AtDm1gBF;AsDh1gBE;AACE;AACE;AAGD;AACF;AtDg1gBH;AACA;AsD90gBE;AtDg1gBF;AsD10gBE;AACE;AACD;AACC;AACD;AtD40gBH;AsD10gBE;AACD;AAED;AtD20gBA;AACA;AACA;AACA;AACA;AACA;AACA;AsD30gBO;AACL;AACD;AAED;AtD40gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsD90gBE;AtDg1gBF;AACA;AACA;AACA;AACA;AsD90gBE;AAAiD;AtDi1gBnD;AsDh1gBI;AACA;AAEA;AtDi1gBJ;AsDh1gBI;AAAW;AAAwB;AAEnC;AtDm1gBJ;AsDl1gBI;AAEA;AtDm1gBJ;AsDl1gBI;AAEA;AtDm1gBJ;AsDl1gBI;AAEA;AtDm1gBJ;AsDl1gBI;AAEA;AtDm1gBJ;AACA;AACA;AACA;AACA;AsDl1gBI;AAEA;AtDm1gBJ;AsDl1gBI;AAEA;AtDm1gBJ;AsDl1gBI;AAMA;AtD+0gBJ;AsD90gBI;AtDg1gBJ;AsD/0gBI;AACE;AAAsB;AAAA;AACvB;AACF;AAED;AtDk1gBF;AACA;AACA;AACA;AACA;AACA;AACA;AsDp1gBI;AACA;AtDs1gBJ;AsDr1gBI;AACE;AACD;AACF;AAED;AtDs1gBF;AACA;AACA;AACA;AACA;AsDt1gBI;AACD;AAED;AtDu1gBF;AACA;AACA;AACA;AACA;AACA;AsDv1gBI;AACD;AAED;AtDw1gBF;AACA;AACA;AsDx1gBI;AACD;AAED;AtDy1gBF;AACA;AACA;AACA;AACA;AACA;AACA;AsDz1gBI;AACD;AAED;AtD01gBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsD11gBI;AACD;AAED;AtD21gBF;AACA;AACA;AACA;AACA;AACA;AACA;AsD31gBI;AACD;AAED;AtD41gBF;AACA;AACA;AACA;AACA;AACA;AsD71gBiB;AtD+1gBjB;AsD91gBI;AACE;AACD;AACC;AACD;AtDg2gBL;AACA;AsD/1gBI;AtDi2gBJ;AsDh2gBI;AACE;AACA;AACE;AACA;AACA;AAHqD;AAKxD;AtDk2gBL;AACA;AsDh2gBI;AtDk2gBJ;AsDj2gBI;AACE;AACD;AACC;AAGW;AAAO;AACP;AAAO;AAEnB;AtDk2gBL;AsDj2gBI;AAIE;AACD;AACF;AAED;AtD+1gBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsD/1gBI;AACD;AAED;AtDg2gBF;AACA;AACA;AACA;AACA;AACA;AACA;AsDh2gBI;AACD;AAED;AtDi2gBF;AACA;AACA;AACA;AACA;AACA;AACA;AsDj2gBI;AACE;AACA;AACD;AACF;AAED;AtDk2gBF;AACA;AACA;AACA;AACA;AACA;AsDl2gBI;AAAO;AAAiC;AAAxC;AAGD;AAED;AtDo2gBF;AACA;AACA;AACA;AACA;AACA;AsDp2gBI;AACD;AAED;AtDq2gBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsDr2gBI;AAKD;AAED;AtDk2gBF;AACA;AACA;AACA;AACA;AACA;AsDn2gBqB;AtDq2gBrB;AsDp2gBI;AACA;AAEkB;AAAA;AAClB;AACE;AACA;AACD;AACF;AAED;AtDq2gBF;AACA;AACA;AACA;AACA;AsDt2gByB;AtDw2gBzB;AsDv2gBI;AtDy2gBJ;AsDt2gBI;AAKA;AAEA;AACE;AACE;AAEgB;AAAO;AtDm2gB/B;AsDh2gBQ;AtDk2gBR;AsDx2gBqB;AAO2C;AAAS;AAPpD;AAAA;AAAA;AAAA;AtDg3gBrB;AACA;AsDv2gBQ;AACE;AACA;AACA;AACA;AAJU;AAMb;AACD;AACE;AACA;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AAP8B;AtDi3gBxC;AsDt2gBQ;AACE;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAVwC;AAY3C;AA3CwB;AA6C5B;AAED;AtDs2gBF;AACA;AACA;AACA;AACA;AsDv2gByB;AtDy2gBzB;AsDx2gBI;AACE;AACE;AAWA;AtDg2gBR;AsD/1gBQ;AASD;AAvBwB;AAyB5B;AAED;AtDw1gBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsDn1gBI;AACA;AACA;AACA;AtDq1gBJ;AsDl1gBI;AtDo1gBJ;AsDj1gBI;AAME;AAAe;AACf;AAAuB;AACvB;AAAc;AtDi1gBpB;AsD70gBI;AACE;AACD;AtD+0gBL;AACA;AsD70gBI;AtD+0gBJ;AsD50gBI;AACA;AAEA;AAEI;AACA;AACA;AACE;AACD;AtD40gBT;AsD30gBQ;AACD;AAEJ;AAED;AtD20gBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsDt0gBI;AACA;AACA;AtDw0gBJ;AsDr0gBI;AtDu0gBJ;AsDp0gBI;AAME;AAAe;AACf;AAAuB;AACvB;AAAc;AtDo0gBpB;AsDh0gBI;AACE;AACD;AtDk0gBL;AACA;AsDh0gBI;AtDk0gBJ;AsD/zgBI;AACA;AAEA;AACA;AACE;AACA;AACA;AACE;AACD;AtDg0gBP;AACA;AsD9zgBM;AAGI;AACA;AACE;AACD;AtD8zgBX;AsD3zgBU;AtD6zgBV;AsDp0gB2B;AASf;AACA;AACE;AACE;AAGE;AAAuB;AACvB;AAAgB;AAGnB;AACC;AACD;AACF;AACC;AAKD;AtDwzgBb;AsDvzgBY;AACE;AACD;AACC;AACD;AAjCc;AtD21gB3B;AsDn1gBU;AAA8C;AA0B7C;AtD6zgBX;AsD5zgBU;AACE;AAAyC;AAAA;AAC1C;AtDg0gBX;AsD/zgBU;AACD;AACH;AACD;AACD;AACD;AtDi0gBH;AACA;AACA;AsDh0gBA;AtDk0gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsDp0gBA;AACE;AACA;AACA;AACD;AAED;AtDq0gBA;AACA;AACA;AACA;AACA;AACA;AsDr0gBA;AACE;AACA;AACD;AAED;AtDs0gBA;AACA;AACA;AACA;AACA;AsDt0gBA;AACE;AACA;AACD;AAED;AtDu0gBA;AACA;AACA;AACA;AACA;AACA;AsDv0gBO;AACL;AACA;AAIA;AAEE;AAKF;AACA;AACE;AACA;AACD;AACD;AACD;AtDi0gBD;AACA;AACA;AACA;AACA;AACA;AACA;AuD9siBA;AvDgtiBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuD9siBA;AvDgtiBA;AACA;AACA;AACA;AACA;AACA;AuD9siBO;AACL;AACE;AACD;AACC;AACD;AACF;AvDgtiBD;AACA;AACA;AACA;AACA;AACA;AACA;AwDpuiBA;AxDsuiBA;AwDruiBA;AxDuuiBA;AwDtuiBA;AxDwuiBA;AwDvuiBA;AxDyuiBA;AwDxuiBA;AxD0uiBA;AwDzuiBA;AxD2uiBA;AwD1uiBA;AxD4uiBA;AwD3uiBA;AxD6uiBA;AwDnwiBA;AxDqwiBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwD3viBA;AxD6viBA;AACA;AACA;AACA;AACA;AACA;AACA;AwD3viBO;AAML;AACA;AACA;AACA;AACA;AACA;AxDwviBF;AwDvviBE;AACE;AACD;AxDyviBH;AwDxviBE;AAEA;AACA;AxDyviBF;AwDxviBE;AACE;AACD;AxD0viBH;AwDxviBE;AxD0viBF;AwDzviBE;AxD2viBF;AwD1viBE;AxD4viBF;AwD3viBE;AAGA;AxD2viBF;AwD1viBE;AAGA;AACA;AAEA;AACA;AACA;AACA;AxDyviBF;AwDxviBE;AACE;AACA;AAGA;AACA;AACA;AACA;AACA;AACE;AADU;AAGZ;AACA;AACA;AACA;AACA;AACA;AAEM;AACA;AACA;AACA;AAJF;AAOJ;AACA;AACA;AACA;AA5B4B;AA8B9B;AxDsviBF;AwDrviBE;AACE;AACD;AxDuviBH;AwDtviBE;AACD;AxDwviBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDv2iBA;AzDy2iBA;AyDx2iBA;AzD02iBA;AyDz2iBA;AzD22iBA;AyD12iBA;AzD42iBA;AyD32iBA;AzD62iBA;AyD52iBA;AzD82iBA;AyD72iBA;AzD+2iBA;AyD92iBA;AzDg3iBA;AyD/2iBA;AzDi3iBA;AyDz4iBA;AzD24iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyD/3iBA;AzDi4iBA;AACA;AACA;AyD/3iBA;AAEA;AzDg4iBA;AACA;AACA;AACA;AACA;AyD/3iBA;AAEA;AzDg4iBA;AACA;AACA;AACA;AACA;AACA;AyD/3iBA;AAEA;AzDg4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AyD/3iBA;AAA8C;AzDk4iB9C;AyD/3iBE;AACE;AACD;AzDi4iBH;AyDh4iBE;AACD;AAED;AzDi4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDj4iBA;AACE;AzDm4iBF;AyDl4iBE;AACE;AACD;AzDo4iBH;AyDl4iBE;AzDo4iBF;AyDn4iBE;AACE;AACD;AzDq4iBH;AyDp4iBE;AACD;AAED;AzDq4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDr4iBA;AACE;AACA;AAEA;AzDs4iBF;AyDr4iBE;AACE;AzDu4iBJ;AyDt4iBI;AACE;AACA;AACD;AACF;AzDw4iBH;AyDt4iBE;AACE;AACE;AACA;AAFa;AAIf;AACD;AzDw4iBH;AyDt4iBE;AACD;AAED;AzDu4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDv4iBA;AACE;AzDy4iBF;AyDv4iBE;AACE;AACD;AAGD;AACA;AzDu4iBF;AACA;AyDv4iBE;AzDy4iBF;AyDx4iBE;AACE;AAD8C;AzD44iBlD;AyDz4iBI;AACE;AACD;AAIC;AACA;AACA;AACD;AACF;AzDw4iBH;AyDt4iBE;AACD;AAED;AzDu4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDv4iBA;AACE;AACE;AACE;AACD;AACF;AzDy4iBH;AyDx4iBE;AACD;AAED;AzDy4iBA;AACA;AACA;AACA;AACA;AACA;AyDz4iBA;AACE;AAAuB;AAAD;AzD64iBxB;AyD34iBE;AACE;AzD64iBJ;AyD34iBI;AACE;AADqC;AzD+4iB3C;AyD34iBM;AACE;AACA;AACE;AACD;AACF;AACF;AACF;AACF;AAED;AzD44iBA;AACA;AACA;AACA;AACA;AyD54iBA;AACE;AACE;AACD;AzD84iBH;AyD74iBE;AACE;AACE;AACD;AzD+4iBL;AyD94iBI;AzDg5iBJ;AyD94iBI;AACE;AACD;AzDg5iBL;AyD94iBI;AzDg5iBJ;AyD14iBI;AACE;AACD;AzD44iBL;AyD14iBI;AzD44iBJ;AyD34iBI;AACE;AACD;AAGD;AACA;AzD24iBJ;AACA;AyD34iBI;AzD64iBJ;AyD54iBI;AACE;AACA;AACD;AACF;AzD84iBH;AyD54iBE;AACD;AAED;AzD64iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyD74iBO;AAQL;AACA;AAKA;AACA;AAEA;AAEA;AAMA;AACA;AAGA;AzD23iBF;AyD13iBE;AACE;AzD43iBJ;AyDz3iBI;AACE;AACA;AACE;AACD;AzD23iBP;AACA;AyDz3iBM;AzD23iBN;AyD13iBM;AACE;AACD;AACF;AAGD;AACA;AzD03iBJ;AACA;AyD13iBI;AACE;AACD;AzD43iBL;AyD13iBI;AACE;AACA;AACD;AzD43iBL;AyD33iBI;AACD;AzD63iBH;AyD33iBE;AAEA;AACE;AACE;AzD43iBN;AyD33iBM;AACE;AACD;AAED;AzD43iBN;AACA;AyD53iBM;AACA;AACA;AACD;AACF;AACF;AAED;AzD63iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyD73iBO;AACL;AzD+3iBF;AyD93iBE;AACE;AACD;AzDg4iBH;AyD/3iBE;AACE;AACE;AACA;AAII;AACE;AACD;AzD83iBX;AyD73iBU;AAAS;AAAM;AAAQ;AAAQ;AAAvB;AACT;AAGH;AACD;AACF;AACF;AAED;AzDi4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDj4iBO;AACL;AAEI;AAA2B;AAA5B;AAKJ;AAED;AzD+3iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyD/3iBO;AACL;AACE;AACD;AzDi4iBH;AyDh4iBE;AACA;AACA;AzDk4iBF;AyDj4iBE;AACE;AACA;AACD;AzDm4iBH;AyDl4iBE;AACE;AACA;AAAW;AAAO;AACnB;AACF;AAED;AzDq4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDr4iBA;AACE;AACD;AAED;AzDs4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDt4iBO;AACL;AACE;AACE;AAEI;AAMD;AACJ;AACC;AACD;AACC;AACD;AACF;AzDk4iBH;AyDj4iBE;AAAO;AAA4B;AAAnC;AACD;AAED;AzDq4iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDv4iBE;AzDy4iBF;AACA;AACA;AACA;AACA;AACA;AyDv4iBE;AAAiD;AzD04iBnD;AyDz4iBI;AACA;AACA;AzD24iBJ;AyD14iBI;AACA;AzD44iBJ;AyD34iBI;AAEA;AzD44iBJ;AyD34iBI;AAII;AACA;AACA;AAAmC;AAAA;AACjC;AAA0B;AAAa;AAAd;AAC1B;AzD+4iBT;AyD94iBQ;AACD;AAGD;AAAW;AAba;AAe3B;AAED;AzD84iBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyDh5iBI;AACA;AAAkC;AAAA;AAClC;AAOD;AAED;AzD64iBF;AACA;AACA;AACA;AACA;AyD74iBI;AACA;AACD;AzD+4iBH;AACA;AACA;AyD94iBA;AzDg5iBA;AACA;AACA;AACA;AACA;AACA;AACA;AyDl5iBO;AACL;AzDo5iBF;AyDl5iBE;AACE;AACD;AzDo5iBH;AACA;AyDn5iBE;AACD;AAGD;AzDm5iBA;AACA;AyDn5iBA;AAEA;AzDo5iBA;AACA;AACA;AACA;AACA;AACA;AyDn5iBO;AACL;AADgC;AAAA;AzDw5iBlC;AyDr5iBE;AACE;AACA;AzDu5iBJ;AyDt5iBI;AACE;AACD;AzDw5iBL;AyDv5iBI;AACE;AACD;AzDy5iBL;AACA;AyDx5iBI;AACE;AACD;AACF;AzD05iBH;AyDz5iBE;AACD;AAED;AzD05iBA;AACA;AACA;AACA;AACA;AACA;AyD15iBO;AACL;AAAqC;AAAD;AAGpC;AzD45iBF;AyD35iBE;AAEA;AACD;AAED;AzD25iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyD35iBO;AACL;AACA;AACA;AACA;AACA;AACE;AACA;AACA;AACD;AACC;AACA;AACD;AACF;AAED;AzD45iBA;AACA;AyD55iBO;AAEP;AzD65iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyD95iBO;AACL;AAAO;AAA6D;AAApE;AAGD;AAED;AzDg6iBA;AACA;AACA;AACA;AACA;AyDh6iBO;AACL;AAID;AAED;AzD85iBA;AACA;AACA;AACA;AyD95iBO;AACL;AACA;AAID;AAED;AzD45iBA;AACA;AACA;AACA;AACA;AyD55iBO;AACL;AAMD;AAED;AzDw5iBA;AACA;AACA;AACA;AACA;AyDx5iBO;AACL;AACD;AzD05iBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0DrikBA;A1DuikBA;A0DtikBA;A1DwikBA;A0DvikBA;A1DyikBA;A0DnikBA;A1DqikBA;A0DpikBA;A1DsikBA;A0DrikBA;A1DuikBA;A0DjkkBA;A1DmkkBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0DpjkBA;AAEA;AAEA;AAEA;A1DmjkBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0DljkBA;AACE;A1DojkBF;AACA;AACA;A0DljkBE;AAGF;A1DkjkBA;AACA;AACA;AACA;A0DjjkBO;AACL;AACD;AAED;A1DkjkBA;AACA;AACA;AACA;AACA;A0DljkBO;AACL;AACD;AAED;A1DmjkBA;AACA;AACA;AACA;AACA;AACA;A0DnjkBO;AACL;AADwC;AAAA;AAIxC;AAGI;AACD;A1DmjkBL;A0DjjkBE;A1DmjkBF;A0DljkBE;AACA;AAEgB;AAAA;AAChB;AAEI;AACA;AAEA;AACA;A1DkjkBN;A0DjjkBM;AAKE;AACA;AACD;A1D+ikBP;A0D7ikBM;AACA;AAEA;AAEI;AACD;AAGJ;AAEJ;AAED;A1DyikBA;AACA;AACA;AACA;A0DzikBO;AACL;AACD;AAED;A1D0ikBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0D1ikBA;AACE;A1D4ikBF;AACA;A0D1ikBE;AACE;AACA;AACA;AACD;A1D4ikBH;A0D1ikBE;AACE;AACA;AACA;AACA;AACD;A1D4ikBH;AACA;A0D1ikBE;AAC6C;AAAW;AAGlD;AACE;AACA;AACD;A1D2ikBT;A0D1ikBQ;AACD;AAEC;AACD;AAEN;AAED;A1DyikBA;AACA;AACA;AACA;AACA;AACA;A0DzikBO;AACL;A1D2ikBF;A0D1ikBE;AACE;AACD;A1D4ikBH;A0D3ikBE;AAAqC;AAAA;AACtC;AAED;A1D8ikBA;AACA;AACA;AACA;AACA;AACA;AACA;A0D9ikBA;AACE;A1DgjkBF;A0D/ikBE;AAEA;A1DgjkBF;AACA;A0DhjkBE;A1DkjkBF;A0DjjkBE;AACE;AACD;A1DmjkBH;A0DjjkBE;AACE;AAKA;AACD;A1D+ikBH;A0D7ikBE;AACE;AACA;AACA;AACA;AACD;A1D+ikBH;AACA;A0D7ikBE;AAGI;AACD;AAEC;AACD;AAEC;AACD;AACJ;AAED;A1D0ikBA;AACA;AACA;AACA;AACA;AACA;AACA;A0D1ikBA;AACE;AACE;AACD;A1D4ikBH;A0D3ikBE;AAEI;AADmB;AAInB;AACA;AACE;AACD;A1D2ikBP;A0D1ikBM;AACD;AACJ;AAED;A1D2ikBA;AACA;AACA;AACA;AACA;AACA;AACA;A0D3ikBA;AACE;AACE;AACD;A1D6ikBH;A0D3ikBE;AACA;AAGA;A1D2ikBF;A0D1ikBE;A1D4ikBF;A0D1ikBE;AACE;AACA;AACD;A1D4ikBH;AACA;A0D1ikBE;AACE;AACE;AACD;A1D4ikBL;A0D1ikBI;A1D4ikBJ;A0D3ikBI;AACA;AACA;AACA;A1D6ikBJ;A0D3ikBI;AACA;AACD;AACF;AAED;A1D4ikBA;AACA;AACA;AACA;AACA;AACA;AACA;A0D5ikBO;AACL;AACE;AAGD;AACF;AAED;A1D2ikBA;AACA;AACA;AACA;AACA;AACA;AACA;A0D3ikBO;AACL;AACA;AACA;AACA;A1D6ikBF;A0D5ikBE;AACE;A1D8ikBJ;A0D7ikBI;AACE;AACD;AACF;A1D+ikBH;AACA;A0D7ikBE;AAb6C;A1D6jkB/C;A0D9ikBE;AACE;AACD;A1DgjkBH;A0D/ikBE;AACA;A1DijkBF;A0DhjkBE;AACE;A1DkjkBJ;A0DjjkBI;AACE;AACD;AACF;A1DmjkBH;A0DljkBE;AACD;AAED;A1DmjkBA;AACA;AACA;AACA;AACA;AACA;A0DnjkBA;AACE;A1DqjkBF;A0DpjkBE;AACE;AACA;AAID;A1DmjkBH;A0DljkBE;AACD;A1DojkBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2D74kBA;A3D+4kBA;A2D94kBA;A3Dg5kBA;A2Dj6kBA;A3Dm6kBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2D95kBA;AACA;AAOA;A3D05kBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Dz5kBO;AAML;A3Ds5kBF;A2Dr5kBE;AACE;AACA;AACA;AAKE;AACD;A3Dm5kBL;A2Dl5kBI;AACD;AACC;AACA;AACE;AACE;AACD;AACF;AACD;AACD;AACF;AAED;A3Dm5kBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Dn5kBO;AACL;AACA;AACA;AACA;AACA;AACA;AAII;AACA;A3Dk5kBN;A2Dj5kBM;A3Dm5kBN;A2Dl5kBM;AACE;AACE;AACD;AACF;AACD;AACD;AAEC;A3Dm5kBN;A2Dl5kBM;AACE;AAMD;AACF;AACJ;A3D+4kBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4D/+kBA;A5Di/kBA;A4Dh/kBA;A5Dk/kBA;A4Dj/kBA;A5Dm/kBA;A4Dl/kBA;A5Do/kBA;A4Dn/kBA;A5Dq/kBA;A4DzglBA;A5D2glBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4DlglBA;AAEA;AACA;AAEA;A5DkglBA;AACA;AACA;AACA;AACA;AACA;AACA;A4DnglBE;A5DqglBF;AACA;A4DnglBE;AACE;AACA;AAEA;A5DoglBJ;A4DnglBI;AAEA;A5DoglBJ;A4DnglBI;AAEA;A5DoglBJ;A4DnglBI;AAEA;A5DoglBJ;A4DnglBI;AAEA;A5DoglBJ;A4DnglBI;AAEA;A5DoglBJ;A4DnglBI;AAKA;AAEA;A5DgglBJ;A4D//kBI;AACA;AACA;AAEA;A5DgglBJ;A4D//kBI;AAEA;A5DgglBJ;A4D//kBI;AAEA;A5DgglBJ;A4D//kBI;AAEA;A5DgglBJ;A4D//kBI;AAEA;A5DgglBJ;A4D//kBI;AAGA;A5D+/kBJ;A4D9/kBI;AACE;AACA;AAAyB;AAAiC;AAG1D;AACD;AACF;AAED;A5D+/kBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4DjglBI;AACD;AAED;A5DkglBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4DlglBI;AACE;AACD;A5DoglBL;A4DnglBI;AACD;AAED;A5DoglBF;AACA;AACA;AACA;AACA;AACA;A4DpglBI;AACD;AAED;A5DqglBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4DrglBI;AACE;AACD;A5DuglBL;A4DtglBI;AACD;AAED;A5DuglBF;AACA;AACA;AACA;AACA;AACA;A4DvglBI;AACD;AAED;A5DwglBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4DxglBI;AACE;AACD;A5D0glBL;A4DzglBI;AACD;AAED;A5D0glBF;AACA;AACA;AACA;AACA;AACA;A4D1glBI;AACE;AACD;A5D4glBL;A4D1glBI;AACE;AACD;A5D4glBL;AACA;A4DphlBgB;A5DshlBhB;A4D3glBI;AAQE;AACD;A5DsglBL;A4DpglBI;AACA;AACA;AACD;AAED;A5DqglBF;AACA;AACA;A4DrglBI;AACE;AACD;A5DuglBL;A4DtglBI;AACA;AACA;AACD;AAED;A5DuglBF;AACA;AACA;AACA;AACA;AACA;AACA;A4DxglBkB;A5D0glBlB;A4DzglBI;AACA;AACE;AACA;AACD;A5D2glBL;A4D1glBI;AACE;AACA;AACD;AAED;AACA;A5D2glBJ;AACA;A4D3glBI;AACA;AAGE;AAAc;AAEZ;AACD;AAEH;AAGI;AACE;AACD;A5DwglBT;A4DvglBQ;AACD;AACJ;AAED;A5DwglBF;AACA;AACA;A4DxglBI;AACA;AACA;AACD;AAED;A5DyglBF;AACA;AACA;A4DzglBI;AACA;A5D2glBJ;A4D1glBI;AACE;AAGE;AAAiC;AAEpC;AACC;AACD;AACF;A5D0glBH;AACA;AACA;A4DzglBA;A5D2glBA;AACA;AACA;AACA;AACA;AACA;A4D7glBO;AACL;AACD;A5D+glBD;AACA;AACA;AACA;AACA;AACA;AACA;A6D3xlBA;A7D6xlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6D3xlBA;A7D6xlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6D3xlBO;AACL;AACD;A7D6xlBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8DlzlBA;A9DozlBA;A8DnzlBA;A9DqzlBA;A8DpzlBA;A9DszlBA;A8DrzlBA;A9DuzlBA;A8DtzlBA;A9DwzlBA;A8DvzlBA;A9DyzlBA;A8DxzlBA;A9D0zlBA;A8Dh1lBA;A9Dk1lBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Dx0lBA;A9D00lBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Dx0lBO;A9D00lBP;A8Dx0lBO;AAwBP;A9DmzlBA;AACA;AACA;AACA;AACA;AACA;A8DnzlBA;AAEA;A9DozlBA;A8DnzlBA;AAEA;A9DozlBA;A8DnzlBA;AAEA;A9DozlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8DnzlBO;AACL;AAGA;AACA;AACD;AAED;A9DkzlBA;AACA;AACA;AACA;AACA;A8DlzlBO;AACL;AAKD;AAED;A9D+ylBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8DjzlBE;A9DmzlBF;AACA;AACA;AACA;A8DjzlBE;AAA2C;A9DozlB7C;A8DnzlBI;AACA;AAEA;A9DozlBJ;A8DnzlBI;AAEA;A9DozlBJ;A8DnzlBI;AAEA;A9DozlBJ;A8DnzlBI;AAEA;A9DozlBJ;A8DnzlBI;AAEA;A9DozlBJ;A8DnzlBI;AAEA;A9DozlBJ;A8DnzlBI;AAKI;AACD;AAGH;AAEI;AACA;AACE;AACD;A9D8ylBT;A8D7ylBQ;AAAiD;AAAD;AACjD;AACA;AAAD;AAEF;AAEA;A9DgzlBJ;A8D/ylBI;AACE;AACE;AACD;A9DizlBP;A8DhzlBM;AACD;AACF;AAED;A9DizlBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8DpzlB8B;A9DszlB9B;A8DrzlBI;AACA;AACA;AACE;A9DuzlBN;A8DtzlBM;AACD;AAED;AACA;A9DuzlBJ;A8DtzlBI;AACE;AACA;AACD;AACF;AAED;A9DuzlBF;AACA;AACA;AACA;AACA;AACA;A8DvzlBI;AACD;AAED;A9DwzlBF;AACA;AACA;AACA;AACA;A8DxzlBI;AACA;AACA;A9D0zlBJ;A8DzzlBI;AACE;AACA;AACD;A9D2zlBL;A8D1zlBI;AACA;AACD;A9D4zlBH;AACA;AACA;A8D3zlBA;A9D6zlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Dj0lBE;A9Dm0lBF;AACA;AACA;A8Dj0lBE;AACE;AACA;A9Dm0lBJ;A8Dh0lBI;A9Dk0lBJ;A8Dj0lBI;AACE;AACD;AACC;AACD;A9Dm0lBL;A8Dj0lBI;AACE;AAID;AAED;A9D+zlBJ;AACA;AACA;AACA;AACA;A8D/zlBI;AACA;AAMA;A9D4zlBJ;A8D3zlBI;AAEA;A9D4zlBJ;A8D3zlBI;AAEA;A9D4zlBJ;AACA;AACA;AACA;AACA;A8D3zlBI;AAEA;A9D4zlBJ;AACA;AACA;AACA;A8D3zlBI;AAEA;A9D4zlBJ;A8D3zlBI;AACD;AAED;A9D4zlBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8D9zlBI;AACA;AACD;AAED;A9D+zlBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8D/zlBI;AACA;A9Di0lBJ;A8D9zlBI;AACE;AACE;AACA;AACD;AACF;A9Dg0lBL;A8D9zlBI;AACE;AACA;AAFe;A9Dm0lBrB;A8D7zlBI;AACE;A9D+zlBN;A8D1zlBM;AACE;AACD;AACF;AAGD;AACA;A9D0zlBJ;AACA;A8D1zlBI;A9D4zlBJ;A8D3zlBI;AACE;A9D6zlBN;A8DzzlBM;A9D2zlBN;A8D1zlBM;AAGD;A9D0zlBL;AACA;A8DxzlBI;AACD;AAED;A9DyzlBF;AACA;AACA;AACA;AACA;AACA;A8DzzlBI;AACA;AACE;AACE;A9D2zlBR;A8D1zlBQ;AACE;AACD;A9D4zlBT;A8D3zlBQ;AACD;AACF;A9D6zlBL;A8D5zlBI;AACD;AAED;A9D6zlBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8D7zlBI;AACE;AACA;AAKA;AAKD;A9DuzlBL;A8DrzlBI;AACA;AAEA;A9DszlBJ;A8DpzlBI;AACE;A9DszlBN;A8DjzlBM;AACE;AACD;AACF;A9DmzlBL;A8DjzlBI;AACE;AACD;AACF;AAED;A9DkzlBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8DnzlBoE;AAGhE;AACA;AACA;AAGA;A9DizlBJ;A8DhzlBI;A9DkzlBJ;A8D9ylBI;AACA;A9DgzlBJ;A8D9ylBI;AACE;AACD;A9DgzlBL;A8D/ylBI;AAGA;A9D+ylBJ;A8D9ylBI;AAMA;AACA;AACD;AAED;A9D0ylBF;AACA;AACA;AACA;AACA;AACA;A8D1ylBI;AACE;AACD;A9D4ylBL;AACA;A8D1ylBI;AACD;AAED;A9D2ylBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8D5ylBuC;A9D8ylBvC;A8D7ylBI;A9D+ylBJ;A8D9ylBI;A9DgzlBJ;A8D/ylBI;AACE;AACD;AACF;AAED;A9DgzlBF;AACA;AACA;AACA;AACA;AACA;A8DhzlBI;AACE;AACD;A9DkzlBL;A8DjzlBI;A9DmzlBJ;A8DlzlBI;AACE;AACD;A9DozlBL;A8DnzlBI;AACD;A9DqzlBH;AACA;AACA;A8DpzlBA;A9DszlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8DxzlBO;AACL;AACA;A9D0zlBF;A8DvzlBE;AACD;AAED;A9DwzlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8DxzlBO;AACL;AACA;A9D0zlBF;A8DxzlBE;AACE;AACD;A9D0zlBH;A8DzzlBE;A9D2zlBF;A8D1zlBE;AACE;A9D4zlBJ;A8D1zlBI;AACE;AACD;AACC;AACD;A9D4zlBL;A8D3zlBI;AACD;A9D6zlBH;A8D5zlBE;AACD;AAED;A9D6zlBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8D7zlBA;AACE;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;A9D8zlBF;A8D5zlBE;AACE;AACA;AACA;AAAa;AAA6C;AAC1D;AAMA;A9D2zlBJ;A8D1zlBI;A9D4zlBJ;A8DtzlBI;AAKD;A9DozlBH;A8DlzlBE;AAAO;AAA2C;AAChD;AAIA;AACA;AACA;AACA;AARgD;AAAlD;AAUD;A9DozlBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+D73mBA;A/D+3mBA;A+D93mBA;A/Dg4mBA;A+Dt5mBA;A/Dw5mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Dt5mBA;A/Dw5mBA;AACA;AACA;A+Dl5mBA;AACA;A/Do5mBA;A+Dl5mBA;A/Do5mBA;AACA;AACA;A+Dl5mBA;AAEA;A/Dm5mBA;AACA;AACA;AACA;A+Dl5mBA;AAEA;A/Dm5mBA;AACA;AACA;AACA;A+Dl5mBA;AAEA;A/Dm5mBA;AACA;AACA;AACA;A+Dl5mBA;AAEA;A/Dm5mBA;AACA;AACA;AACA;AACA;A+Dl5mBO;AACL;A/Do5mBF;A+Dn5mBE;AACE;AACE;AACD;A/Dq5mBL;A+Dp5mBI;AACA;AACD;A/Ds5mBH;A+Dr5mBE;AAAO;AAA4B;AAAnC;AACD;AAED;A/Dy5mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Dz5mBO;AACL;AACA;AACE;AACD;A/D25mBH;AACA;A+D15mBE;AACA;A/D45mBF;A+D35mBE;AACE;A/D65mBJ;A+D55mBI;AAME;AACA;AACD;A/Dy5mBL;A+Dx5mBI;AACA;AACD;A/D05mBH;A+Dz5mBE;AACD;AAED;A/D05mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+D15mBO;AACL;AAAO;AAA4B;AAAW;AAAuB;AAArE;AACD;AAED;A/Dg6mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Dh6mBO;AACL;AACE;AACD;AACC;AACE;AACD;A/Dk6mBL;A+Dj6mBI;AACD;AACF;AAED;A/Dk6mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Dl6mBO;AACL;AACA;A/Do6mBF;A+Dn6mBE;AACE;AACD;A/Dq6mBH;A+Dp6mBE;A/Ds6mBF;A+Dr6mBE;AACE;AACD;A/Du6mBH;A+Dt6mBE;AACE;AACD;AACC;AACD;AACF;AAED;A/Du6mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Dv6mBO;AAAqC;AAAX;AAAW;A/D46mB5C;A+D36mBE;AACE;AACD;A/D66mBH;A+D56mBE;AACE;AACD;AACD;A/D86mBF;AACA;A+D96mBE;AAAgB;AAAG;AAAG;AAAP;A/Do7mBjB;A+Dn7mBE;AAAyB;AAAA;AAAA;AAAA;A/Dy7mB3B;AACA;A+Dv7mBI;AACE;AACE;AACD;AACC;AACE;AACD;A/Dy7mBT;A+Dx7mBQ;AACE;AAAY;AAAS;AAAS;AAAnB;AACZ;A/D87mBT;A+D77mBQ;AACD;AACC;AAA0B;AAAwB;AAClD;AAA0B;AAAwB;A/Dm8mB1D;A+Dl8mBQ;AACE;AACD;A/Do8mBT;A+Dn8mBQ;AACE;AACA;AAAY;AAAS;AAAS;AAAnB;AACZ;A/Dy8mBT;A+Dx8mBQ;AACD;AACF;A/D08mBL;AACA;A+Dz8mBI;AACE;AACD;AACF;A/D28mBH;A+D18mBE;AACD;AAED;A/D28mBA;AACA;AACA;AACA;AACA;AACA;A+D38mBA;AACE;AACE;AACD;A/D68mBH;A+D58mBE;AACE;AAAwB;AAG3B;AAED;A/D48mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+D58mBO;AACL;AAAO;AAA4B;AAAnC;AACD;AAED;A/Dg9mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Dh9mBO;AACL;AAAO;AAA4C;AAAnD;AACD;AAED;A/Do9mBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Dp9mBO;AACL;AACD;A/Ds9mBD;AACA;AACA;AACA;AACA;AACA;AACA;AgEjtnBA;AhEmtnBA;AgEltnBA;AhEotnBA;AgErunBA;AhEuunBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgEjunBA;AACE;AACA;AAFgB;AAKlB;AhEkunBA;AACA;AACA;AACA;AACA;AACA;AACA;AgEnunBE;AhEqunBF;AACA;AACA;AgEnunBE;AACE;AACA;AACA;AhEqunBJ;AgEpunBI;AACA;AhEsunBJ;AgErunBI;AACA;AhEuunBJ;AgEtunBI;AACA;AhEwunBJ;AgEvunBI;AACA;AhEyunBJ;AgExunBI;AACD;AAED;AhEyunBF;AACA;AACA;AACA;AACA;AACA;AACA;AgE3unBI;AACE;AACD;AhE6unBL;AgE5unBI;AACA;AACD;AAED;AhE6unBF;AACA;AACA;AACA;AACA;AgE7unBI;AACE;AACD;AhE+unBL;AgE9unBI;AACA;AACD;AAED;AhE+unBF;AACA;AACA;AACA;AACA;AgE/unBI;AACE;AACD;AhEivnBL;AgEhvnBI;AACE;AACA;AACD;AhEkvnBL;AgEjvnBI;AACE;AACA;AACD;AhEmvnBL;AgElvnBI;AAIA;AACA;AACA;AACD;AhEivnBH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEp2nBA;AjEs2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEp2nBA;AjEs2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEp2nBO;AAEP;AjEq2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEr2nBO;AAEP;AjEs2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEt2nBO;AAEP;AjEu2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEv2nBO;AACL;AACA;AACA;AAH+B;AAMjC;AjEw2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEz2nBO;AACL;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AARK;AAUR;AAED;AjE02nBA;AACA;AACA;AACA;AACA;AACA;AACA;AiE12nBO;AACL;AAMD;AAED;AjEs2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AiEt2nBO;AACL;AAMD;AAED;AjEk2nBA;AACA;AACA;AACA;AACA;AACA;AiEl2nBO;AACL;AACA;AACA;AACA;AjEo2nBF;AiEn2nBE;AACE;AjEq2nBJ;AiEp2nBI;AACE;AACD;AjEs2nBL;AiEr2nBI;AACA;AACA;AACA;AjEu2nBJ;AiEt2nBI;AACE;AACD;AACF;AjEw2nBH;AiEv2nBE;AACE;AACD;AjEy2nBH;AiEx2nBE;AACD;AAED;AjEy2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AiEz2nBO;AACL;AACE;AACD;AACC;AACD;AACC;AACD;AACF;AAED;AjE02nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiE12nBO;AAKL;AACE;AAA4B;AAC1B;AACA;AACA;AACA;AAJ0B;AjE82nBhC;AiEv2nBE;AACE;AACD;AACC;AACD;AACF;AAED;AjEw2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEx2nBO;AACL;AAMD;AAED;AjEo2nBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiEp2nBO;AACL;AACE;AACD;AjEs2nBH;AiEr2nBE;AACD;AAED;AjEs2nBA;AACA;AACA;AACA;AACA;AACA;AiEt2nBO;AACL;AAMD;AAED;AjEk2nBA;AACA;AACA;AACA;AACA;AACA;AiEl2nBO;AACL;AACD;AAED;AjEm2nBA;AACA;AACA;AACA;AACA;AACA;AiEn2nBO;AACL;AACE;AACD;AjEq2nBH;AiEp2nBE;AAMD;AAED;AjEg2nBA;AACA;AACA;AACA;AACA;AiEh2nBO;AACL;AACE;AACD;AjEk2nBH;AiEj2nBE;AACE;AACA;AACA;AACA;AAJK;AAMR;AjEm2nBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkE5noBA;AlE8noBA;AkE7noBA;AlE+noBA;AkE9noBA;AlEgooBA;AkE/noBA;AlEiooBA;AkEhooBA;AlEkooBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkE5ooBA;AlE8ooBA;AACA;AkE5ooBO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAToB;AAYtB;AlE6ooBA;AACA;AACA;AACA;AACA;AACA;AkE7ooBO;AACL;AACA;AACA;AACA;AAJ4B;AAO9B;AlE8ooBA;AACA;AACA;AACA;AACA;AkE9ooBO;AAEP;AlE+ooBA;AACA;AACA;AACA;AACA;AACA;AACA;AkE/ooBA;AAEA;AlEgpoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkE/ooBO;AACL;AAAc;AAAc;AAAf;AACb;AAAkB;AAAc;AAAf;AACjB;AACA;AACA;AAAqB;AAAe;AAAhB;AALY;AAQlC;AlEypoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkEzpoBO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAd+B;AAgBjC;AlE2poBA;AACA;AACA;AACA;AACA;AACA;AACA;AkE3poBA;AAEA;AlE4poBA;AACA;AACA;AACA;AACA;AkE3poBO;AACL;AACE;AACE;AACD;AACF;AlE6poBH;AkE5poBE;AACD;AAED;AlE6poBA;AACA;AACA;AACA;AACA;AkE7poBO;AACL;AACD;AAED;AlE8poBA;AACA;AACA;AACA;AACA;AACA;AkE9poBO;AACL;AASD;AAED;AlEupoBA;AACA;AACA;AACA;AACA;AACA;AkEvpoBO;AACL;AACD;AAED;AlEwpoBA;AACA;AACA;AACA;AACA;AACA;AkExpoBO;AACL;AACA;AACD;AAED;AlEypoBA;AACA;AACA;AACA;AACA;AACA;AACA;AkEzpoBO;AACL;AACE;AACD;AlE2poBH;AkE1poBE;AACE;AACD;AlE4poBH;AkE3poBE;AACE;AACD;AlE6poBH;AkE5poBE;AACE;AACD;AlE8poBH;AkE7poBE;AACD;AAED;AlE8poBA;AACA;AACA;AACA;AACA;AACA;AACA;AkE9poBO;AACL;AAKA;AAAO;AAA2B;AAAlC;AACD;AAED;AlE8poBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkE9poBO;AACL;AAKA;AACD;AAED;AlE2poBA;AACA;AACA;AACA;AACA;AACA;AkE3poBO;AACL;AACA;AACA;AAKA;AACD;AAED;AlEwpoBA;AACA;AACA;AACA;AACA;AACA;AkExpoBO;AACL;AACA;AACD;AAED;AlEypoBA;AACA;AACA;AACA;AACA;AACA;AACA;AkEzpoBO;AACL;AACA;AACD;AAED;AlE0poBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkE1poBO;AACL;AACA;AlE4poBF;AkE3poBE;AACE;AACA;AACA;AlE6poBJ;AkE3poBI;AACA;AACE;AACA;AAFc;AAIhB;AACA;AACE;AAAa;AAAO;AACpB;AAAc;AAAO;AAFO;AAI9B;AACD;AlEiqoBH;AkEhqoBE;AAAO;AAA8B;AAArC;AACD;AAED;AlEoqoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkEpqoBO;AACL;AACA;AACD;AAED;AlEqqoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkErqoBO;AACL;AACE;AACD;AlEuqoBH;AkEtqoBE;AACD;AAED;AlEuqoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkEvqoBO;AACL;AACA;AACA;AACA;AACA;AlEyqoBF;AkExqoBE;AACE;AAAe;AAAwB;AlE4qoB3C;AkEzqoBI;AAIE;AACA;AAED;AACC;AAEA;AlEsqoBN;AkErqoBM;AACD;AlEuqoBL;AkEtqoBI;AACD;AAGD;AACA;AAEA;AlEqqoBF;AACA;AkErqoBE;AACA;AACA;AACA;AACA;AlEuqoBF;AkEpqoBE;AACA;AACA;AlEsqoBF;AkErqoBE;AAEA;AACA;AlEsqoBF;AkErqoBE;AAEA;AlEsqoBF;AkEnqoBE;AACA;AACA;AlEqqoBF;AkElqoBE;AAOE;AACA;AACA;AACA;AAIA;AACD;AACC;AACA;AACD;AlE2poBH;AACA;AkEzpoBE;AACE;AACD;AACC;AACD;AACC;AACD;AACC;AACD;AACC;AACD;AACC;AACD;AlE2poBH;AACA;AkEzpoBE;AAME;AACD;AlEspoBH;AkErpoBE;AACE;AAMD;AlEkpoBH;AkEjpoBE;AAKE;AAKD;AlE2ooBH;AkEzooBE;AACE;AAMD;AACC;AAID;AlEmooBH;AACA;AkEjooBE;AlEmooBF;AkElooBE;AACE;AACD;AlEoooBH;AkEnooBE;AACE;AACA;AACA;AAEA;AlEoooBJ;AkEnooBI;AACD;AACC;AACE;AACA;AAFiB;AAIpB;AACC;AACD;AACC;AACA;AACE;AADe;AAIjB;AACA;AACD;AACC;AACA;AACA;AACA;AlEoooBJ;AkE/noBI;AACA;AAIA;AACA;AACD;AAEA;AAEC;AACA;AACD;AACC;AACA;AACA;AACE;AACD;AlE4noBL;AkE3noBI;AACE;AACD;AACF;AACC;AlE6noBJ;AkE5noBI;AACE;AACD;AlE8noBL;AkE7noBI;AACD;AAED;AlE8noBF;AACA;AkE9noBE;AACA;AACD;AlEgooBD;AACA;AACA;AACA;AACA;AACA;AACA;AmElppBA;AnEoppBA;AmEpqpBA;AnEsqpBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmElqpBA;AnEoqpBA;AACA;AACA;AACA;AACA;AACA;AmElqpBA;AACE;AAEQ;AAAA;AACT;AAED;AnEmqpBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmEnqpBO;AAML;AAEA;AACA;AnE+ppBF;AmE9ppBE;AAEA;AACE;AACA;AAEA;AAOD;AAED;AACD;AnEuppBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoE/tpBA;ApEiupBA;AoEhupBA;ApEkupBA;AoEjupBA;ApEmupBA;AoElupBA;ApEoupBA;AoEnupBA;ApEqupBA;AoEpupBA;ApEsupBA;AoE3vpBA;ApE6vpBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEnvpBA;AAEA;ApEovpBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEpvpBO;AAEP;ApEqvpBA;AACA;AACA;AACA;AACA;AACA;AoErvpBO;AAEP;ApEsvpBA;AACA;AACA;AACA;AACA;AACA;AoEvvpBO;AACL;AACD;AAED;ApEwvpBA;AACA;AACA;AACA;AACA;AoExvpBO;AACL;AACD;AAED;ApEyvpBA;AACA;AACA;AACA;AACA;AoEzvpBO;AACL;AACA;AACA;AACA;AACA;AALsB;AAQxB;ApE0vpBA;AACA;AACA;AACA;AACA;AACA;AACA;AoE3vpBO;AACL;AACD;AAED;ApE4vpBA;AACA;AACA;AACA;AACA;AoE5vpBA;AAEA;ApE6vpBA;AACA;AACA;AoE5vpBO;AACL;AACD;AAED;ApE6vpBA;AACA;AACA;AACA;AACA;AACA;AACA;AoE7vpBA;AAAsB;AAAA;AAEtB;ApEgwpBA;AACA;AACA;AACA;AACA;AACA;AACA;AoEhwpBA;AAA2B;AAEvB;AAAA;AAFuB;AAM3B;ApEiwpBA;AACA;AACA;AACA;AACA;AACA;AoEjwpBA;AAAuC;AAAA;AAGvC;ApEmwpBA;AACA;AACA;AACA;AACA;AoEnwpBA;AAAwC;AAAA;AAGxC;ApEqwpBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEvwpBE;ApEywpBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEvwpBE;AAA6C;ApE0wpB/C;AoE1wpB+C;AAAjB;AAAiB;ApE8wpB/C;AoE7wpBI;ApE+wpBJ;AACA;AACA;AACA;AoE7wpBI;AAEA;ApE8wpBJ;AoE7wpBI;AAEA;ApE8wpBJ;AoE7wpBI;AAEA;ApE8wpBJ;AoE7wpBI;AAEA;ApE8wpBJ;AoE7wpBI;AAEA;AACE;AAEgB;AAAA;AAEZ;AACE;AAAiB;AAA4B;AAC9C;AACF;AACJ;AACF;AAED;ApE8wpBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEhxpBI;AACD;AAED;ApEixpBF;AACA;AACA;AACA;AACA;AACA;AoEjxpBI;AACA;AACE;AACD;ApEmxpBL;AACA;AoEjxpBI;AACE;AACD;ApEmxpBL;AACA;AoEjxpBI;AACE;AACD;ApEmxpBL;AACA;AoEjxpBI;AACE;AACD;ApEmxpBL;AACA;AoEjxpBI;AACD;AAED;ApEkxpBF;AACA;AACA;AACA;AACA;AACA;AACA;AoElxpBI;AACE;ApEoxpBN;AoEnxpBM;AACE;AACD;AACC;AACD;AACC;AACD;ApEqxpBP;AoEpxpBM;ApEsxpBN;AoEpxpBM;ApEsxpBN;AoErxpBM;AACE;AACA;AACD;AACC;AACD;ApEuxpBP;AoEtxpBM;AACD;AACF;AAED;ApEuxpBF;AACA;AACA;AACA;AACA;AACA;AoEvxpBI;AACD;AAED;ApEwxpBF;AACA;AACA;AACA;AACA;AACA;AACA;AoExxpBI;AACE;AACD;AACF;AAED;ApEyxpBF;AACA;AACA;AACA;AACA;AACA;AACA;AoEzxpBI;AACE;AACD;AACF;AAED;ApE0xpBF;AACA;AACA;AACA;AACA;AACA;AACA;AoE1xpBI;AACE;AACD;AACF;AAED;ApE2xpBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoE3xpBI;AACE;AACD;AACC;AAIA;AACA;AACD;AACF;AAED;ApEyxpBF;AACA;AACA;AACA;AACA;AACA;AACA;AoEzxpBI;ApE2xpBJ;AoE1xpBI;AACE;ApE4xpBN;AoE1xpBM;AACD;AACF;AAED;ApE2xpBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoE3xpBI;ApE6xpBJ;AoE5xpBI;AACE;ApE8xpBN;AoE5xpBM;AACD;AACF;AAED;ApE6xpBF;AACA;AACA;AACA;AACA;AACA;AACA;AoE7xpBI;AACA;AACA;AACD;AAED;ApE8xpBF;AACA;AACA;AACA;AACA;AACA;AACA;AoE9xpBI;AACA;AACA;AACA;AACD;AAED;ApE+xpBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoE/xpBI;ApEiypBJ;AoEhypBI;AACE;AAG4B;AAAuB;AAGpD;ApE+xpBL;AoE9xpBI;AACE;AACA;AACA;AACA;AACA;AACA;AACA;ApEgypBN;AoE/xpBM;AACE;AACA;ApEiypBR;AoEhypBQ;AACE;AACD;ApEkypBT;AoEjypBQ;AACA;AACA;AACD;ApEmypBP;AoElypBM;AACA;AACA;AACA;AACA;ApEoypBN;AoElypBM;ApEoypBN;AoEnypBM;AACD;ApEqypBL;AoEpypBI;AACD;AAED;ApEqypBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoErypBI;AACA;AAMA;AAAO;AAAyB;AAAhC;AACD;AAED;ApEoypBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEpypBI;AAMA;AAAO;AAAuB;AAA9B;AACD;AAED;ApEmypBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEnypBI;AAMA;AAAO;AAAuB;AAA9B;AACD;AAED;ApEkypBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoElypBI;AAMA;AAAO;AAAuB;AAA9B;AACD;AAED;ApEiypBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEjypBI;AAMA;AAAO;AAAwB;AAA/B;AACD;AAED;ApEgypBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEhypBI;AACE;AACD;ApEkypBL;AoEjypBI;AACD;AAED;ApEkypBF;AACA;AACA;AACA;AACA;AACA;AoElypBI;ApEoypBJ;AoEnypBI;AACE;AACE;AACD;AACC;AACD;AACF;AACC;AACD;AACF;AAED;ApEoypBF;AACA;AACA;AACA;AACA;AACA;AACA;AoEpypBI;AACE;AAA+B;AAAuB;AACvD;ApEwypBL;AoEvypBI;AACD;AAED;ApEwypBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoExypBI;AACA;AAEA;AACA;AACA;ApEyypBJ;AoExypBI;AACE;AACD;ApE0ypBL;AoEzypBI;AACE;AACD;ApE2ypBL;AoE1ypBI;AACD;AAED;ApE2ypBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoE3ypBI;AACE;AACD;AACC;AACD;AACF;ApE6ypBH;AACA;AACA;AoE5ypBA;ApE8ypBA;AACA;AACA;AACA;AACA;AACA;AACA;AoEhzpBA;AAAiC;AAC/B;AAAuB;AADQ;AAAA;AAGjC;ApEqzpBA;AACA;AACA;AACA;AACA;AoErzpBA;AACE;AACA;AACE;AACD;ApEuzpBH;AoEtzpBE;AACD;AAED;ApEuzpBA;AACA;AACA;AACA;AACA;AoEvzpBA;AACE;AACE;AACD;AACF;AAED;ApEwzpBA;AACA;AACA;AACA;AACA;AACA;AoExzpBO;AACL;ApE0zpBF;AoEzzpBE;AACE;AACD;ApE2zpBH;AoE/zpBiD;AAAA;AAO/C;ApE4zpBF;AoE1zpBE;AACE;AACD;ApE4zpBH;AACA;AoE3zpBE;AACA;AACD;AAED;ApE4zpBA;AACA;AACA;AACA;AACA;AACA;AoE5zpBO;AACL;AACA;ApE8zpBF;AoE7zpBE;AACE;ApE+zpBJ;AoE9zpBI;AACE;AACD;AACC;AACE;AACD;ApEg0pBP;AoE/zpBM;AACD;AACF;ApEi0pBH;AoE/zpBE;AACE;AACD;AACC;AACD;ApEi0pBH;AoEh0pBE;AACD;AAED;ApEi0pBA;AACA;AACA;AACA;AACA;AACA;AoEj0pBO;AACL;AACA;AACE;AACA;ApEm0pBJ;AoEl0pBI;AACD;AACF;AAED;ApEm0pBA;AACA;AACA;AACA;AACA;AACA;AoEn0pBA;AACE;AACA;AACA;AAHiC;AAMnC;AAEA;ApEm0pBA;AACA;AACA;AACA;AACA;AACA;AoEl0pBA;AAEA;ApEm0pBA;AACA;AACA;AoEl0pBO;AACL;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;ApEm0pBF;AoEl0pBE;AACA;AACD;AAED;ApEm0pBA;AACA;AACA;AACA;AoEn0pBO;AACL;AACD;AAED;ApEo0pBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEp0pBO;AACL;AACE;AACD;ApEs0pBH;AoEr0pBE;AACE;AACD;AACC;AACE;AACD;ApEu0pBL;AoEt0pBI;AACD;AACF;AAED;ApEu0pBA;AACA;AACA;AACA;AACA;AACA;AoEv0pBA;AACE;AACE;AACD;ApEy0pBH;AoEx0pBE;AAGI;ApEw0pBN;AoEv0pBM;AACE;AACD;ApEy0pBP;AoEx0pBM;AACD;AAGJ;AAED;ApEu0pBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoEv0pBO;AACL;AACE;AACD;ApEy0pBH;AoEx0pBE;AACE;AACD;ApE00pBH;AoEz0pBE;AACE;ApE20pBJ;AoE10pBI;AACE;AACD;ApE40pBL;AoE30pBI;AACE;AACD;ApE60pBL;AoE50pBI;AACD;AACF;AAED;ApE60pBA;AACA;AACA;AACA;AACA;AACA;AoE70pBO;AACL;AACE;AACD;ApE+0pBH;AoE90pBE;AACD;AAED;ApE+0pBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoE/0pBO;AAaL;AACE;AACD;ApEq0pBH;AoEp0pBE;AAAa;AAAc;AAa5B;AAED;ApE2zpBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoE3zpBO;AAaL;AAAc;AAAc;AAa7B;ApEuypBD;AACA;AACA;AACA;AACA;AACA;AACA;AqErwrBA;ArEuwrBA;AqEvxrBA;ArEyxrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqErxrBA;ArEuxrBA;AACA;AACA;AACA;AACA;AqErxrBO;AACL;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAVK;AAYR;ArEuxrBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsErzrBA;AtEuzrBA;AsEtzrBA;AtEwzrBA;AsEz0rBA;AtE20rBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsEt0rBA;AtEw0rBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsEt0rBO;AAEP;AtEu0rBA;AACA;AACA;AACA;AACA;AACA;AsEv0rBA;AAEA;AtEw0rBA;AACA;AACA;AACA;AACA;AsEv0rBO;AACL;AtEy0rBF;AsEx0rBE;AACE;AACD;AtE00rBH;AsEz0rBE;AACD;AAED;AtE00rBA;AACA;AACA;AACA;AACA;AACA;AsE10rBA;AACE;AACA;AAGA;AACA;AACA;AtE00rBF;AsEz0rBE;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEE;AACA;AAEF;AAEA;AtEs0rBF;AsEp0rBE;AACE;AACD;AAGD;AACA;AACA;AtEo0rBF;AACA;AsEp0rBE;AACE;AACA;AACA;AACA;AACA;AACA;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAzBK;AA2BR;AAED;AtEi0rBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsEj0rBA;AACE;AACA;AACA;AACE;AACD;AtEm0rBH;AsEj0rBE;AACE;AACD;AAGD;AACA;AACA;AACA;AtEi0rBF;AACA;AsEj0rBE;AACD;AAED;AtEk0rBA;AACA;AACA;AACA;AACA;AACA;AACA;AsEl0rBO;AACL;AACD;AAED;AtEm0rBA;AACA;AsEn0rBO;AACL;AACD;AtEq0rBD;AACA;AACA;AACA;AACA;AACA;AACA;AuE9+rBA;AvEg/rBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuE9+rBA;AvEg/rBA;AACA;AACA;AACA;AACA;AACA;AACA;AuEh/rBE;AvEk/rBF;AACA;AuEh/rBE;AACE;AACA;AACD;AAED;AvEi/rBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuEp/rBe;AvEs/rBf;AuEr/rBI;AACE;AACD;AvEu/rBL;AuEt/rBI;AACA;AACE;AACD;AACF;AAED;AvEu/rBF;AACA;AACA;AACA;AACA;AACA;AuEv/rBI;AACE;AACD;AvEy/rBL;AuEx/rBI;AvE0/rBJ;AuEz/rBI;AACE;AACD;AACF;AAED;AvE0/rBF;AACA;AACA;AACA;AACA;AuE1/rBI;AACE;AACD;AvE4/rBL;AuE3/rBI;AACD;AAED;AvE4/rBF;AACA;AACA;AACA;AACA;AACA;AuE5/rBI;AACE;AACD;AvE8/rBL;AuE7/rBI;AvE+/rBJ;AuE9/rBI;AACE;AACA;AACD;AACF;AAED;AvE+/rBF;AACA;AACA;AACA;AACA;AACA;AuE//rBI;AACE;AACD;AvEigsBL;AuEhgsBI;AACD;AvEkgsBH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwE1lsBA;AxE4lsBA;AwE5msBA;AxE8msBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwE1msBA;AxE4msBA;AACA;AACA;AACA;AACA;AACA;AACA;AwE5msBE;AxE8msBF;AACA;AACA;AACA;AACA;AACA;AwE5msBE;AAA4C;AxE+msB9C;AwE9msBI;AAEA;AxE+msBJ;AwE9msBI;AAEA;AxE+msBJ;AwE9msBI;AAEA;AxE+msBJ;AwE9msBI;AAEA;AxE+msBJ;AwE9msBI;AAEA;AxE+msBJ;AwE9msBI;AAEA;AxE+msBJ;AACA;AACA;AACA;AwE9msBI;AACE;AACD;AACF;AAED;AxE+msBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwEjnsBI;AACD;AAED;AxEknsBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwElnsBI;AxEonsBJ;AwEnnsBI;AACE;AACA;AACA;AACD;AxEqnsBL;AwEnnsBI;AAEA;AxEonsBJ;AwEnnsBI;AACE;AACA;AACA;AAEA;AACD;AxEonsBL;AwElnsBI;AACD;AAED;AxEmnsBF;AACA;AACA;AACA;AACA;AwEnnsBI;AACA;AACA;AACA;AACA;AACD;AAED;AxEonsBF;AACA;AACA;AACA;AACA;AwEpnsBI;AACE;AACA;AACD;AACF;AxEsnsBH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyEzusBA;AzE2usBA;AyE1usBA;AzE4usBA;AyE3usBA;AzE6usBA;AyE5usBA;AzE8usBA;AyEjwsBA;AzEmwsBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyE5vsBA;AACA;AAEA;AzE6vsBA;AACA;AACA;AACA;AACA;AACA;AyE5vsBO;AACL;AACE;AACD;AzE8vsBH;AyE5vsBE;AAGD;AAED;AzE2vsBA;AACA;AACA;AACA;AACA;AACA;AyE3vsBA;AACE;AACE;AACD;AACC;AACA;AACA;AACE;AAA0B;AAGxB;AACA;AAFG;AAKP;AACA;AACA;AACD;AACF;AAED;AzE0vsBA;AACA;AACA;AACA;AACA;AACA;AACA;AyE1vsBA;AAAwD;AAApB;AAAoB;AzE+vsBxD;AyE9vsBE;AzEgwsBF;AyE/vsBE;AzEiwsBF;AyEhwsBE;AACE;AACD;AzEkwsBH;AyEjwsBE;AACA;AACD;AAED;AzEkwsBA;AACA;AACA;AACA;AACA;AACA;AACA;AyElwsBA;AACE;AACD;AzEowsBD;AACA;AACA;AACA;AACA;AACA;AACA;A0En2sBA;A1Eq2sBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0En2sBA;A1Eq2sBA;AACA;AACA;AACA;AACA;A0En2sBA;AAEA;A1Eo2sBA;AACA;AACA;A0En2sBA;AAEA;A1Eo2sBA;AACA;AACA;AACA;AACA;AACA;A0En2sBA;AAEA;A1Eo2sBA;AACA;AACA;AACA;AACA;A0En2sBA;AACA;AAWA;A1E21sBA;AACA;AACA;A0E11sBA;AACE;AACA;AAFoB;AAKtB;A1E21sBA;AACA;AACA;AACA;AACA;AACA;A0E11sBA;AACE;AACE;AACD;AACF;AAED;A1E21sBA;AACA;AACA;AACA;AACA;AACA;AACA;A0E31sBA;AAAgC;AAG9B;AAMD;AAED;A1Es1sBA;AACA;AACA;AACA;AACA;AACA;AACA;A0Et1sBA;AACE;AACA;AACD;AAED;A1Eu1sBA;AACA;AACA;AACA;AACA;AACA;A0Ev1sBA;AACE;AAAI;AAAO;AACT;AACD;AACF;AAED;A1E01sBA;AACA;AACA;AACA;AACA;AACA;AACA;A0E51sBE;A1E81sBF;AACA;AACA;A0E51sBE;AACE;A1E81sBJ;AACA;A0E51sBI;AAEA;A1E61sBJ;AACA;AACA;A0E51sBI;AAEA;A1E61sBJ;AACA;AACA;AACA;AACA;A0E51sBI;AACD;AAED;A1E61sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0E/1sBI;AAGA;A1E+1sBJ;A0E91sBI;AACA;A1Eg2sBJ;A0E/1sBI;AACE;AACA;AACD;AACF;AAED;A1Eg2sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Eh2sBI;A1Ek2sBJ;A0Ej2sBI;AACE;AACD;AACF;AAED;A1Ek2sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0En2sBoB;AAAA;AAAA;AAEhB;A1Es2sBJ;A0Ep2sBI;AACE;AACD;A1Es2sBL;A0Ep2sBI;AACA;A1Es2sBJ;A0Er2sBI;AACE;AACD;A1Eu2sBL;A0Er2sBI;AACA;AAAoB;AAAO;AAAW;AAAA;AACtC;AACE;AACA;AAFc;AAKhB;AACD;AAED;A1Ey2sBF;AACA;AACA;AACA;AACA;AACA;AACA;A0Ez2sBI;AACD;A1E22sBH;AACA;AACA;A0E12sBA;A1E42sBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0E92sBE;A1Eg3sBF;AACA;A0E92sBE;AACE;A1Eg3sBJ;AACA;A0E92sBI;AAEA;A1E+2sBJ;AACA;AACA;A0E92sBI;AAEA;A1E+2sBJ;AACA;AACA;AACA;AACA;A0E92sBI;AAEA;A1E+2sBJ;AACA;AACA;AACA;A0E92sBI;AAEA;A1E+2sBJ;AACA;AACA;AACA;A0E92sBI;AAEA;A1E+2sBJ;AACA;AACA;AACA;AACA;AACA;A0E92sBI;AAEA;A1E+2sBJ;AACA;AACA;AACA;AACA;AACA;A0E92sBI;AACD;AAED;A1E+2sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ej3sBI;AACA;AACA;AACD;AAED;A1Ek3sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0El3sBI;A1Eo3sBJ;A0En3sBI;AACE;AACD;AACF;AAED;A1Eo3sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ep3sBI;A1Es3sBJ;A0Ep3sBI;AACE;A1Es3sBN;A0Er3sBM;AACE;AACD;AACF;AACF;AAED;A1Es3sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ev3sB8B;AAAA;AAAA;A1E23sB9B;A0Ex3sBI;AACE;AACD;A1E03sBL;A0Ex3sBI;A1E03sBJ;A0Ex3sBI;AACE;AACD;AAGD;AACA;A1Ew3sBJ;AACA;A0Ex3sBI;AACE;AACA;AAFwB;AAK1B;AACA;AACD;AAED;A1Ew3sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ex3sBI;AACA;AACA;AACA;AACA;AACA;A1E03sBJ;A0Ex3sBI;AACE;A1E03sBN;A0Ez3sBM;AACE;AACD;AACC;AACD;AACF;AACF;AAED;A1E03sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0E13sBI;A1E43sBJ;A0E33sBI;AACE;AACD;A1E63sBL;A0E33sBI;AAAkB;AAAyB;AAC5C;AAED;A1E83sBF;AACA;AACA;AACA;AACA;AACA;AACA;A0E93sBI;AACE;AACA;AACD;A1Eg4sBL;A0E93sBI;AACD;AAED;A1E+3sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Eh4sB0B;A1Ek4sB1B;A0Eh4sBI;AACE;AACD;AAGD;AACA;AACA;AACA;A1Eg4sBJ;AACA;A0Eh4sBI;A1Ek4sBJ;A0Ej4sBI;AACE;A1Em4sBN;A0Ej4sBM;AACE;AAGD;AACF;AACC;AACD;AACF;AAED;A1Eg4sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Eh4sBI;A1Ek4sBJ;A0Ej4sBI;AACE;AACD;A1Em4sBL;A0El4sBI;AAAkB;AAAyB;AAE3C;AACA;AACA;A1Eq4sBJ;A0Ep4sBI;AACE;AACE;AACD;AACC;AACD;AACF;AACF;AAED;A1Eq4sBF;AACA;AACA;AACA;AACA;AACA;AACA;A0Er4sBI;AACA;AACA;AACE;AACE;AACD;AACC;AACD;AACF;AACF;AAED;A1Es4sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ev4sBiB;A1Ey4sBjB;A0Ex4sBI;AACE;AACA;AACD;A1E04sBL;A0Ex4sBI;A1E04sBJ;A0Ev4sBI;AACE;AACE;AACD;AACF;AACD;AAEA;AACE;AACD;AACD;AAEA;AACD;AAED;A1Es4sBF;AACA;AACA;AACA;AACA;AACA;AACA;A0Et4sBI;AACE;AACD;AACC;AACD;AACF;AAED;A1Eu4sBF;AACA;AACA;AACA;AACA;AACA;AACA;A0Ev4sBI;AACE;AACD;AACF;AAED;A1Ew4sBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ex4sBI;AACE;A1E04sBN;A0Ez4sBM;AACE;AACD;A1E24sBP;A0E/4sB6C;AAAA;A1Ek5sB7C;A0E34sBM;AACE;AACA;AACA;A1E64sBR;A0E54sBQ;AACE;AACD;AACF;A1E84sBP;A0E54sBM;AACE;AACA;AACA;A1E84sBR;A0E74sBQ;AACE;AACD;AACF;AACF;AACF;A1E+4sBH;AACA;AACA;A0E94sBA;A1Eg5sBA;AACA;AACA;AACA;AACA;AACA;A0Eh5sBA;AAAuC;AAAA;AAAA;AAAA;AAAA;AAErC;AACA;AACA;AAJqC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAerC;AACA;A1Em5sBF;A0El5sBE;AACE;A1Eo5sBJ;A0En5sBI;AACE;AACD;A1Eq5sBL;A0Ep5sBI;AACD;AAGD;A1Eo5sBF;AACA;A0Ep5sBE;AACE;AAGA;AACA;AACA;AACA;AACA;A1Eo5sBJ;A0En5sBI;AACE;AACA;AACD;A1Eq5sBL;A0Ep5sBI;AACD;A1Es5sBH;AACA;A0Ep5sBE;AACE;AACA;AACA;AACD;A1Es5sBH;AACA;A0Ep5sBE;AACE;AACA;AACA;AACD;A1Es5sBH;AACA;A0Ep5sBE;AACE;AACA;AACA;AACD;A1Es5sBH;AACA;A0Ep5sBE;AACE;AACA;AACA;AACD;A1Es5sBH;AACA;A0Ep5sBE;AACE;AAGA;AACA;A1Eo5sBJ;A0En5sBI;AACE;AACA;AACD;A1Eq5sBL;A0Ep5sBI;AACD;AAGD;AACA;A1Eo5sBF;AACA;A0Ep5sBE;AACA;A1Es5sBF;A0El5sBE;AACE;AACA;AACA;AACE;AAAwB;AAC1B;AAID;A1Ek5sBH;A0Ej5sBE;A1Em5sBF;A0El5sBE;AACE;AACA;AACD;A1Eo5sBH;A0En5sBE;AACD;AAED;A1Eo5sBA;AACA;AACA;AACA;AACA;A0Ep5sBA;AAAuB;AAAA;AAAA;AAAA;AAAA;AAIrB;AACA;AAGA;AACA;A1Es5sBF;A0Er5sBE;AACE;AACA;AACA;AACA;AAJ2C;AAQ7C;A1Eq5sBF;A0Ep5sBE;AAnBqB;AAAA;A1E26sBvB;A0Et5sBE;AACE;A1Ew5sBJ;AACA;AACA;A0Et5sBI;AACE;AACA;AACA;AACD;A1Ew5sBL;AACA;A0Ev5sBI;AACE;AACD;AACF;A1Ey5sBH;A0Ex5sBE;AACE;A1E05sBJ;AACA;A0Ex5sBI;AACE;AACA;AACA;AACD;A1E05sBL;AACA;A0Ez5sBI;AACE;AACD;AACF;AAED;A1E05sBF;AACA;AACA;AACA;AACA;AACA;AACA;A0E15sBE;AAA+B;AAI7B;A1E05sBJ;A0Ez5sBI;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A1Ey5sBJ;A0Ex5sBI;AACE;AACA;AACA;AACA;AACA;AACA;AACD;AAGD;AACA;AACA;A1Ew5sBJ;AACA;A0Ex5sBI;AACA;AACD;A1E05sBH;A0Ez5sBE;A1E25sBF;A0Ex5sBE;AACD;AAED;A1Ey5sBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ez5sBA;AAA8B;AAAA;AAAA;AAE5B;A1E65sBF;AACA;AACA;A0E55sBE;AACE;AAAa;AAA2C;AAGxD;AACA;A1E85sBJ;A0E75sBI;AACD;A1E+5sBH;A0E95sBE;A1Eg6sBF;A0E75sBE;AACD;AAED;A1E85sBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0E95sBA;AACE;AACA;AACA;AACE;AACE;AACA;AACA;AACA;AAJW;AAD0C;AAQzD;AACD;AAED;A1E+5sBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0E/5sBO;AACL;AACA;AACA;A1Ei6sBF;A0Eh6sBE;AACE;AACD;A1Ek6sBH;A0Eh6sBE;AACA;A1Ek6sBF;A0Eh6sBE;AACE;AACA;AACA;AACA;AAAI;AAAA;A1Eo6sBR;A0Eh6sBM;A1Ek6sBN;A0Ej6sBM;AAGA;A1Ei6sBN;A0Eh6sBM;AACD;AACC;AACA;AACA;AACD;AACF;A1Ek6sBH;A0Eh6sBE;AACE;AACD;AACC;AACD;AACF;A1Ek6sBD;AACA;AACA;AACA;AACA;AACA;AACA;A2E9yuBA;A3EgzuBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2E9yuBA;A3EgzuBA;AACA;AACA;AACA;AACA;AACA;AACA;A2E9yuBA;AACE;AACA;AACA;AACA;AACD;AAED;A3E+yuBA;AACA;AACA;AACA;AACA;A2E/yuBO;AACL;AACA;AACA;A3EizuBF;A2EhzuBE;AACE;AACE;AACA;AACA;AACA;AAJ6D;AAMhE;AACF;A3EkzuBD;AACA;AACA;AACA;AACA;AACA;AACA;A4Ev2uBA;A5Ey2uBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4Ev2uBA;A5Ey2uBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4Ev2uBA;AACE;A5Ey2uBF;A4Ex2uBE;AACE;AACA;AACD;AACC;AACA;AACD;AACF;AAED;A5Ey2uBA;AACA;AACA;AACA;AACA;AACA;A4Ez2uBO;AACL;AACE;AACE;AACA;AACA;AACA;AAJ8D;AAD/B;A5Ek3uBrC;A4Ez2uBI;AACE;AACE;AACD;AACF;AACF;AACF;AAED;A5E02uBA;AACA;AACA;AACA;AACA;AACA;A4E12uBA;AACE;AACD;A5E42uBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6El6uBA;A7Eo6uBA;A6En6uBA;A7Eq6uBA;A6Ep6uBA;A7Es6uBA;A6Er6uBA;A7Eu6uBA;A6Et6uBA;A7Ew6uBA;A6Ev6uBA;A7Ey6uBA;A6Ex6uBA;A7E06uBA;A6Ez6uBA;A7E26uBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Er7uBA;AACA;AAEA;A7Es7uBA;AACA;AACA;AACA;AACA;AACA;A6Er7uBA;AAEA;A7Es7uBA;A6Er7uBA;AAEA;A7Es7uBA;AACA;AACA;AACA;AACA;AACA;A6Er7uBA;AACE;AACE;AACA;AACA;A7Eu7uBJ;A6Et7uBI;AACE;AACD;A7Ew7uBL;A6Ev7uBI;AACE;AACA;AACA;AAHmB;AAKtB;A7Ey7uBH;A6Ex7uBE;AACD;AAED;A7Ey7uBA;AACA;AACA;AACA;A6Ez7uBO;AACL;AACD;A7E27uBD;AACA;AACA;AACA;A6E37uBE;A7E67uBF;AACA;A6E37uBE;AACE;AACA;AAEA;A7E47uBJ;A6E37uBI;AACA;A7E67uBJ;AACA;AACA;AACA;AACA;A6E57uBI;AACA;A7E87uBJ;AACA;AACA;AACA;A6E77uBI;AACA;A7E+7uBJ;A6E97uBI;A7Eg8uBJ;A6E97uBI;AAEA;A7E+7uBJ;AACA;AACA;AACA;AACA;AACA;A6E97uBI;AAEA;A7E+7uBJ;A6E97uBI;AACD;AAED;A7E+7uBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6El8uBuC;A7Eo8uBvC;A6En8uBI;AACE;AACD;AACF;AAED;A7Eo8uBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Ep8uBI;AACE;AACD;A7Es8uBL;A6Ez8uBwC;AAAA;A7E48uBxC;A6Ev8uBI;AACA;A7Ey8uBJ;A6Ex8uBI;AACE;AACE;AACD;A7E08uBP;A6Ez8uBM;AACD;AAED;A7E08uBJ;AACA;A6E18uBI;AAGA;AAEA;A7Ey8uBJ;A6Ex8uBI;A7E08uBJ;A6Ez8uBI;AACE;AACA;AACA;AACA;AACD;A7E28uBL;A6E18uBI;AACA;AACA;AACA;AACA;A7E48uBJ;A6Ez8uBI;AACE;AACE;AACD;A7E28uBP;A6E18uBM;AACE;AACD;AACF;AAED;AACD;AAED;A7E08uBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6E38uBsC;A7E68uBtC;A6E58uBI;AACE;AACD;A7E88uBL;A6E78uBI;AACE;AACD;A7E+8uBL;A6E98uBI;AACA;AAAsB;AAAyB;A7Ek9uBnD;A6Ej9uBI;AACE;AACD;A7Em9uBL;A6El9uBI;AACE;AACA;AACA;AACA;AACA;AACA;AACD;A7Eo9uBL;A6En9uBI;AACE;AACD;AACF;AAED;A7Eo9uBF;AACA;AACA;AACA;AACA;AACA;AACA;A6Ep9uBI;AAEA;AAEA;AACA;AACA;AACA;AACA;AACA;A7Eo9uBJ;A6En9uBI;AACE;AACD;AACC;AACD;A7Eq9uBL;A6Ep9uBI;AAEA;AACD;AAED;A7Eo9uBF;AACA;AACA;AACA;AACA;AACA;AACA;A6Ep9uBI;AACE;AACD;A7Es9uBL;A6Er9uBI;AACD;AAED;A7Es9uBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Et9uBI;AACA;AACA;AACA;AAIE;AACD;AAGD;AACA;A7Em9uBJ;AACA;A6En9uBI;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;A7Eo9uBJ;A6En9uBI;AACA;AAIA;AACA;A7Ek9uBJ;A6Eh9uBI;AAEA;AACD;A7Ei9uBH;AACA;AACA;AACA;AACA;AACA;AACA;A6En9uBE;A7Eq9uBF;AACA;AACA;A6En9uBE;AACE;AACA;AAEA;A7Eo9uBJ;A6En9uBI;AAEA;A7Eo9uBJ;A6En9uBI;AACD;AAED;A7Eo9uBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Et9uBI;AACE;AACD;A7Ew9uBL;A6Ev9uBI;AACD;AAED;A7Ew9uBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Ex9uBI;AACD;AAED;A7Ey9uBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Ez9uBI;AACD;A7E29uBH;AACA;AACA;A6E19uBA;A7E49uBA;AACA;AACA;AACA;AACA;AACA;AACA;A6E99uBO;AACL;AACA;AACA;AACA;AACD;AAED;A7E+9uBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6E/9uBO;AACL;AACE;AACA;A7Ei+uBJ;A6Eh+uBI;A7Ek+uBJ;A6Ej+uBI;AACA;AACD;AACF;A7Em+uBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8E/2vBA;A9Ei3vBA;A8Eh3vBA;A9Ek3vBA;A8Ej3vBA;A9Em3vBA;A8Er4vBA;A9Eu4vBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Ej4vBA;A9Em4vBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Ej4vBA;AACE;AACA;AACA;AAHe;AAMjB;A9Ek4vBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Ev4vBE;A9Ey4vBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Ex4vBA;A9E04vBA;AACA;AACA;AACA;AACA;AACA;A8E34vBA;AAEA;A9E44vBA;AACA;AACA;AACA;AACA;AACA;AACA;A8E34vBO;AACL;AACE;AAEI;AACE;AACE;AACD;AACF;A9E44vBT;A8E34vBQ;AACD;AAGH;AAKD;AACD;AACD;AAED;A9Es4vBA;AACA;AACA;AACA;AACA;AACA;A8Et4vBO;AACL;AACD;AAED;A9Eu4vBA;AACA;AACA;AACA;AACA;AACA;AACA;A8Ev4vBO;AACL;AAAmC;AAAsC;AACzE;AACD;AAED;A9E04vBA;AACA;AACA;AACA;AACA;AACA;A8E14vBO;AACL;AACA;AACA;AAEA;AACE;AACD;AACF;A9E24vBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EthwBA;A/EwhwBA;A+EvhwBA;A/EyhwBA;A+ExhwBA;A/E0hwBA;A+EzhwBA;A/E2hwBA;A+EpjwBA;A/EsjwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EpjwBA;A/EsjwBA;AACA;AACA;AACA;AACA;A+E/iwBA;A/EijwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+E/iwBA;AAEA;A/EgjwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+ErjwBE;A/EujwBF;AACA;AACA;AACA;AACA;AACA;AACA;A+EtjwBA;A/EwjwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+E9jwBE;A/EgkwBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+E/jwBA;A/EikwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EnkwBO;AACL;AACA;AACA;AACA;A/EqkwBF;A+EnkwBE;AACA;A/EqkwBF;A+EpkwBE;AACE;AACE;AACD;A/EskwBL;AACA;A+ErkwBI;AACD;AACC;AACA;AACD;AACF;AAED;A/EskwBA;AACA;AACA;AACA;AACA;AACA;AACA;A+EtkwBO;AACL;AACA;AAKA;AAKA;A/EgkwBF;A+E/jwBE;AACE;AACA;AAIE;AAAA;AACA;AAAe;AAElB;AACC;AAAgD;AAAA;AAChD;AACD;AACF;AAED;A/EgkwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EhkwBO;AACL;AACA;A/EkkwBF;A+EjkwBE;AACE;AACD;AACF;AAED;A/EkkwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+ElkwBO;AAML;AACA;AACA;A/E+jwBF;A+E9jwBE;AACE;AACD;AACF;AAED;A/E+jwBA;AACA;AACA;AACA;AACA;AACA;AACA;A+E/jwBO;AACL;AACA;AACA;AACD;AAED;A/EgkwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EhkwBO;AACL;AACA;AACD;AAED;A/EikwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EjkwBO;AACL;AACD;AAED;A/EkkwBA;AACA;AACA;AACA;AACA;AACA;AACA;A+ElkwBO;AACL;A/EokwBF;A+EnkwBE;AACE;AACD;AACC;AACD;AACF;AAED;A/EokwBA;AACA;AACA;AACA;AACA;AACA;AACA;A+EpkwBO;AACL;AACD;AAED;A/EqkwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+ErkwBO;AACL;AACA;AACA;AACD;AAED;A/EskwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EtkwBA;AACE;AACA;A/EwkwBF;A+EvkwBE;AACE;AACD;AACC;AACD;AACF;AAED;A/EwkwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+ExkwBO;AACL;AACD;AAED;A/EykwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EzkwBO;AACL;AAID;AAED;A/EukwBA;AACA;AACA;AACA;AACA;AACA;A+EvkwBO;AACL;AACA;AACD;AAED;A/EwkwBA;AACA;AACA;AACA;AACA;AACA;A+ExkwBO;AACL;AACD;AAED;A/EykwBA;AACA;AACA;AACA;AACA;AACA;AACA;A+EzkwBO;AACL;AACD;AAED;A/E0kwBA;AACA;AACA;AACA;AACA;AACA;AACA;A+E1kwBO;AACL;AACA;A/E4kwBF;A+E3kwBE;AACE;AACE;AAAO;AAAmC;AAA1C;AACD;AAEA;AACF;A/E+kwBH;A+E9kwBE;AACD;AAED;A/E+kwBA;AACA;AACA;AACA;AACA;A+E/kwBO;AACL;AACE;AACE;AAAyB;AAG3B;AAAuC;AAAsB;AAC9D;A/EklwBH;A+EjlwBE;AAAO;AAA8C;AAArD;AACD;AAED;A/EqlwBA;AACA;AACA;AACA;AACA;A+ErlwBA;AACE;AACA;AACD;AAED;A/EslwBA;AACA;AACA;AACA;AACA;AACA;AACA;A+EtlwBA;AACE;AAAO;AAAqD;AAA5D;AAID;AAED;A/EulwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EvlwBA;AACE;AAIA;AACA;A/EslwBF;A+ErlwBE;AACE;AACA;AACA;AACA;AACA;AACA;AAEA;A/EslwBJ;A+ErlwBI;AACE;AACD;AACF;A/EulwBH;A+EtlwBE;AACD;AAED;A/EulwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+EvlwBA;AACE;AACA;A/EylwBF;A+EvlwBE;AACE;AACE;AACA;AACA;AACA;AACA;AACA;AANiB;AAQpB;A/EylwBH;A+EvlwBE;AACE;AACA;AACD;A/EylwBH;A+EvlwBE;AACA;AAGA;A/EulwBF;A+EtlwBE;AACE;AACA;AACD;AACF;AAED;A/EulwBA;AACA;AACA;AACA;AACA;AACA;A+EvlwBA;AACE;A/EylwBF;A+ExlwBE;AACE;AACD;AAGD;AACA;A/EwlwBF;AACA;A+ExlwBE;AACA;AACA;AAAO;AAAkC;AAAzC;AACD;AAED;A/E4lwBA;AACA;AACA;AACA;AACA;AACA;A+E5lwBA;AACE;AACA;A/E8lwBF;A+E7lwBE;AACE;AACE;AACD;A/E+lwBL;A+E9lwBI;AACD;A/EgmwBH;A+E9lwBE;AACA;AACD;AAED;A/E+lwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+E/lwBA;AACE;AACA;A/EimwBF;A+EhmwBE;AACE;AACE;AACD;AACC;AACA;AACA;AAAoC;AAAwB;AAC7D;AACF;A/EomwBH;A+EnmwBE;AACD;AAED;A/EomwBA;AACA;AACA;AACA;AACA;AACA;A+EpmwBA;AACE;A/EsmwBF;A+ErmwBE;AACE;AACD;A/EumwBH;A+EtmwBE;AACD;AAED;A/EumwBA;AACA;AACA;AACA;AACA;AACA;A+EvmwBO;AACL;AACD;AAED;A/EwmwBA;AACA;AACA;AACA;AACA;AACA;AACA;A+ExmwBO;AACL;AACA;AAAO;AAA4B;AAAnC;AACD;AAED;A/E4mwBA;AACA;AACA;AACA;AACA;AACA;A+E5mwBO;AACL;AACD;AAED;A/E6mwBA;AACA;AACA;AACA;AACA;AACA;A+E7mwBO;AACL;AACD;AAED;A/E8mwBA;AACA;AACA;AACA;A+E9mwBA;AACE;AACA;AACA;A/EgnwBF;A+EnnwByC;AAKrC;AACE;AACD;A/EinwBL;A+EhnwBI;A/EknwBJ;A+EjnwBI;AACE;AACD;AACC;AAAmC;AAAA;AAGpC;AAfoC;A/EmowBzC;A+E/nwBE;AAA2B;A/EkowB7B;A+ElowB6B;AAY1B;AACF;AAED;A/EwnwBA;AACA;AACA;AACA;AACA;A+ExnwBA;AACE;AACE;AACD;A/E0nwBH;A+EznwBE;AACE;AACD;AACC;AACA;AACA;AACD;AACF;AAED;A/E0nwBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+E1nwBO;AACL;A/E4nwBF;A+E1nwBE;AACE;AACD;A/E4nwBH;A+E3nwBE;AAIA;AACA;AACA;AACD;AAED;A/EynwBA;AACA;AACA;AACA;AACA;A+EznwBO;AACL;AAIA;AAIE;AAAA;AAEH;AAED;A/EonwBA;AACA;AACA;AACA;AACA;AACA;A+EpnwBO;AACL;AACE;AACD;AACF;AAED;A/EqnwBA;AACA;AACA;AACA;AACA;AACA;A+ErnwBA;AACE;A/EunwBF;A+ErnwBE;AACD;AAED;A/EsnwBA;AACA;A+EtnwBA;AACE;AADuC;AAAA;AAAA;AAGvC;A/E0nwBF;A+EznwBE;AACE;AACA;AACA;AACA;AACA;AACA;AANK;AAQR;A/E2nwBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFrxxBA;AhFuxxBA;AgFlxxBA;AhFoxxBA;AgFnxxBA;AhFqxxBA;AgFpxxBA;AhFsxxBA;AgFrxxBA;AhFuxxBA;AgFtxxBA;AhFwxxBA;AgFvxxBA;AhFyxxBA;AgFxxxBA;AhF0xxBA;AgFzxxBA;AhF2xxBA;AgF1xxBA;AhF4xxBA;AgFxxxBA;AhF0xxBA;AgFzxxBA;AhF2xxBA;AgF1xxBA;AhF4xxBA;AgF/zxBA;AhFi0xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF1yxBA;AACA;AAEA;AhF2yxBA;AgF1yxBA;AAEA;AhF2yxBA;AgF1yxBA;AAEA;AhF2yxBA;AgF1yxBA;AAEA;AhF2yxBA;AgF1yxBA;AhF4yxBA;AgF1yxBA;AhF4yxBA;AgF3yxBA;AhF6yxBA;AgF3yxBA;AhF6yxBA;AgF5yxBA;AACE;AADgC;AAIlC;AhF6yxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF5yxBO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAfiC;AAkBnC;AhF6yxBA;AACA;AACA;AACA;AACA;AgF7yxBA;AAEA;AhF8yxBA;AACA;AACA;AACA;AgF7yxBA;AAEA;AhF8yxBA;AACA;AACA;AACA;AgF7yxBA;AAEA;AhF8yxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF7yxBO;AAEP;AhF8yxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF9yxBA;AAEA;AhF+yxBA;AACA;AACA;AgF9yxBO;AAEP;AhF+yxBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFlzxBE;AhFozxBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFlzxBE;AAWE;AAHA;AAGA;AhF4yxBJ;AgF5yxBI;AAFA;AAEA;AhFgzxBJ;AgFhzxBI;AADA;AACA;AhFozxBJ;AgFnzxBI;AACA;AACA;AhFqzxBJ;AgFpzxBI;AACA;AhFszxBJ;AgFrzxBI;AACA;AhFuzxBJ;AgFtzxBI;AACA;AhFwzxBJ;AgFvzxBI;AACA;AhFyzxBJ;AgFxzxBI;AACA;AhF0zxBJ;AgFzzxBI;AACA;AhF2zxBJ;AgF1zxBI;AACA;AhF4zxBJ;AgF3zxBI;AACA;AhF6zxBJ;AgF5zxBI;AACD;AAED;AhF6zxBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF/zxBI;AACA;AACE;AACA;AACD;AhFi0xBL;AgFh0xBI;AACE;AAKA;AACD;AhF8zxBL;AgF7zxBI;AACD;AhF+zxBH;AACA;AACA;AgF9zxBA;AhFg0xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFp0xBE;AhFs0xBF;AACA;AACA;AgFp0xBE;AACE;AACA;AAEA;AhFq0xBJ;AgFp0xBI;AAEA;AhFq0xBJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFp0xBI;AAEA;AhFq0xBJ;AgFp0xBI;AAEA;AhFq0xBJ;AACA;AACA;AgFp0xBI;AhFs0xBJ;AgFn0xBI;AACA;AACA;AACA;AACA;AACA;AACA;AACD;AAED;AhFo0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AgFp0xBI;AAKD;AAED;AhFi0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFp0xBiB;AhFs0xBjB;AgFr0xBI;AACE;AACA;AACA;AACE;AACE;AhFu0xBV;AgFt0xBU;AACD;AACF;AACD;AAAgD;AAAA;AAE9C;AhFy0xBR;AgFx0xBQ;AACE;AACA;AhF00xBV;AgFx0xBU;AACE;AAOA;AACA;AhFo0xBZ;AACA;AgFp0xBY;AACE;AACD;AACF;AACF;AACF;AACF;AACC;AACE;AAEA;AhFq0xBR;AgFp0xBQ;AACD;AACF;AACC;AACE;AhFs0xBR;AgFr0xBQ;AhFu0xBR;AgFt0xBQ;AACD;AACF;AACC;AAGI;AhFs0xBV;AgFr0xBU;AAGE;AAAgC;AAGnC;AAIH;AACE;AACA;AACA;AhFi0xBR;AgFh0xBQ;AhFk0xBR;AgFj0xBQ;AACD;AACF;AACC;AAGI;AhFi0xBV;AgFh0xBU;AAGE;AAAgC;AAGnC;AAIH;AACE;AhF4zxBR;AgF3zxBQ;AhF6zxBR;AgF5zxBQ;AACD;AACF;AACC;AACE;AhF8zxBR;AgF7zxBQ;AACD;AACF;AACF;AAED;AhF8zxBF;AACA;AACA;AACA;AACA;AACA;AACA;AgF9zxBI;AACD;AAED;AhF+zxBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFh0xBqE;AAA7B;AAA6B;AhFo0xBrE;AgFn0xBI;AAAoC;AAAS;AAAV;AACpC;AAED;AhFu0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFv0xBI;AACD;AAED;AhFw0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFx0xBI;AASA;AACD;AAED;AhFi0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFj0xBI;AACA;AAEA;AhFk0xBJ;AgF3zxBI;AACE;AACA;AACD;AhF6zxBL;AgF5zxBI;AAEA;AhF6zxBJ;AgF5zxBI;AhF8zxBJ;AgF7zxBI;AACE;AACA;AACE;AACA;AACE;AACE;AACD;AACC;AACD;AACF;AACD;AACD;AACF;AACF;AAED;AhF8zxBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF9zxBI;AACD;AAED;AhF+zxBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFh0xB4D;AhFk0xB5D;AgFj0xBI;AhFm0xBJ;AgFl0xBI;AACE;AACD;AhFo0xBL;AgFn0xBI;AAA+B;AAAA;AAAA;AAChC;AAED;AhFu0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFn0xBI;AhFq0xBJ;AgFp0xBI;AhFs0xBJ;AgFr0xBI;AACE;AACD;AhFu0xBL;AgFt0xBI;AAA6C;AAC3C;AACD;AACF;AAED;AhFw0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFx0xBI;AAGD;AAED;AhFu0xBF;AACA;AACA;AACA;AACA;AACA;AgFv0xBI;AACD;AAED;AhFw0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFx0xBI;AACE;AACD;AhF00xBL;AgFz0xBI;AAAsB;AAAa;AAAd;AACtB;AAED;AhF60xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF90xB2D;AhFg1xB3D;AgF/0xBI;AhFi1xBJ;AgFh1xBI;AACE;AACD;AAED;AhFi1xBJ;AACA;AgFj1xBI;AAEA;AhFk1xBJ;AgFj1xBI;AhFm1xBJ;AgFl1xBI;AACA;AAA4D;AAAA;AAAA;AAAA;AAC1D;AhFw1xBN;AgFv1xBM;AACE;AhFy1xBR;AgFx1xBQ;AACE;AhF01xBV;AgFz1xBU;AACD;AhF21xBT;AgF11xBQ;AAYA;AACD;AhFi1xBP;AACA;AgFh1xBM;AAGD;AAED;AACD;AAED;AhF80xBF;AACA;AACA;AACA;AACA;AACA;AACA;AgF90xBI;AACE;AACA;AACA;AACA;AACD;AACC;AACD;AACF;AAED;AhF+0xBF;AACA;AACA;AACA;AACA;AACA;AACA;AgFh1xBsB;AAAA;AhFm1xBtB;AgF/0xBI;AACE;AACE;AAKA;AACD;AACF;AhF60xBL;AACA;AgF30xBI;AhF60xBJ;AgF50xBI;AACE;AACD;AhF80xBL;AACA;AgF50xBI;AhF80xBJ;AgF30xBI;AhF60xBJ;AgF50xBI;AACE;AACD;AhF80xBL;AACA;AgF50xBI;AhF80xBJ;AgF70xBI;AACE;AACE;AACD;AACC;AACD;AhF+0xBP;AgF90xBM;AACD;AhFg1xBL;AACA;AgF90xBI;AhFg1xBJ;AgF90xBI;AhFg1xBJ;AgF/0xBI;AAIE;AhF80xBN;AgF70xBM;AACE;AACD;AACC;AACA;AACD;AhF+0xBP;AgF90xBM;AACD;AhFg1xBL;AACA;AgF90xBI;AAKA;AACD;AAED;AhF20xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF30xBI;AACA;AhF60xBJ;AgF50xBI;AACE;AACE;AACD;AhF80xBP;AgF70xBM;AhF+0xBN;AgF90xBM;AACE;AAAQ;AAAS;AAAV;AACR;AhFm1xBP;AgFl1xBM;AACD;AhFo1xBL;AgFn1xBI;AACD;AAED;AhFo1xBF;AACA;AACA;AACA;AACA;AACA;AACA;AgFp1xBI;AhFs1xBJ;AgFr1xBI;AACE;AACD;AhFu1xBL;AgFt1xBI;AACD;AAED;AhFu1xBF;AACA;AACA;AACA;AACA;AACA;AACA;AgFv1xBI;AhFy1xBJ;AgFx1xBI;AACE;AhF01xBN;AgFz1xBM;AACE;AACA;AACA;AACD;AACC;AhF21xBR;AgF11xBQ;AACA;AACD;AACF;AhF41xBL;AgF31xBI;AACD;AAED;AhF41xBF;AACA;AACA;AACA;AACA;AACA;AACA;AgF51xBI;AhF81xBJ;AgF31xBI;AACD;AAED;AhF41xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF71xBoB;AhF+1xBpB;AgF/1xBoB;AAAA;AhFk2xBpB;AgFh2xBI;AACE;AACD;AhFk2xBL;AgFj2xBI;AhFm2xBJ;AgFl2xBI;AACE;AACD;AhFo2xBL;AgFn2xBI;AAKI;AAJF;AAKgB;AAAA;AAEZ;AhFk2xBV;AgFj2xBU;AACE;AhFm2xBZ;AgFl2xBY;AACD;AhFo2xBX;AgFn2xBU;AACA;AACA;AAAQ;AAAa;AAAd;AACR;AAfH;AAiBgB;AAAA;AAEnB;AAED;AhFu2xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFv2xBI;AAAe;AAA4B;AADT;AhF62xBtC;AgFz2xBI;AACE;AACD;AhF22xBL;AACA;AgFz2xBI;AACE;AACA;AACD;AhF22xBL;AgFz2xBI;AACE;AACD;AhF22xBL;AgFz2xBI;AACE;AACA;AACD;AhF22xBL;AgFz2xBI;AACE;AACD;AACF;AhF22xBH;AACA;AACA;AgF12xBA;AhF42xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF92xBA;AACE;AACD;AAED;AhF+2xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF/2xBA;AAAoD;AAAA;AAAA;AhFo3xBpD;AgFh3xBE;AAIE;AACD;AhF+2xBH;AgF92xBE;AACA;AACA;AACE;AAIE;AACE;AACD;AACF;AhF62xBL;AgF52xBI;AACD;AACF;AAED;AhF62xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF72xBE;AhF+2xBF;AACA;AgF72xBE;AACE;AACA;AAEA;AACD;AAGH;AhF42xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF92xBA;AACE;AhFg3xBF;AgF/2xBE;AACE;AhFi3xBJ;AgFh3xBI;AACE;AACD;AACC;AACD;AACF;AhFk3xBH;AgFj3xBE;AACD;AAED;AhFk3xBA;AACA;AgFl3xBA;AACE;AACD;AAED;AhFm3xBA;AACA;AACA;AACA;AACA;AACA;AACA;AgFn3xBO;AACL;AACA;AAEA;AAEA;AACA;AACA;AhFm3xBF;AgFl3xBE;AACE;AhFo3xBJ;AgFn3xBI;AAKC;AACC;AAEA;AACA;AhFg3xBN;AgF72xBM;AAEA;AhF82xBN;AgF32xBM;AACE;AhF62xBR;AgFv2xBQ;AACA;AAEA;AhFw2xBR;AgFv2xBQ;AACE;AhFy2xBV;AgFx2xBU;AhF02xBV;AgFr2xBU;AhFu2xBV;AgFt2xBU;AACE;AhFw2xBZ;AgFv2xBY;AACD;AACF;AhFy2xBT;AgFv2xBQ;AACE;AACA;AACA;AACA;AAIA;AARW;AAWb;AACD;AhFq2xBP;AACA;AgFh2xBM;AACE;AACD;AhFk2xBP;AgFh2xBM;AACD;AACC;AACA;AACD;AACF;AhFk2xBH;AgFh2xBE;AACD;AAED;AhFi2xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFj2xBA;AACE;AACA;AACA;AhFm2xBF;AgFj2xBE;AACE;AACA;AACA;AhFm2xBJ;AgFt2xBqC;AAAA;AhFy2xBrC;AgFp2xBI;AACA;AACD;AACC;AACA;AACE;AADC;AAAA;AAAA;AhF02xBP;AgFv2xBM;AAEC;AACC;AACA;AhFw2xBR;AgFt2xBQ;AAA4B;AAAmB;AAI/C;AhFu2xBR;AgFr2xBQ;AACE;AAKE;AhFm2xBZ;AgFl2xBY;AACA;AACD;AACF;AhFo2xBT;AgFn2xBQ;AhFq2xBR;AgFp2xBQ;AACE;AACD;AhFs2xBT;AgFr2xBQ;AACA;AACA;AAKD;AACC;AACA;AACD;AACF;AACF;AhFm2xBH;AgFl2xBE;AACD;AAED;AhFm2xBA;AACA;AACA;AACA;AACA;AACA;AgFn2xBA;AACE;AACE;AACD;AACC;AAAO;AAAwC;AAA/C;AACD;AACC;AAA+B;AAAA;AAC/B;AACA;AAAO;AAA2C;AAAC;AAAD;AAAlD;AACD;AACF;AAED;AhF82xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgF92xBO;AACL;AACE;AACD;AhFg3xBH;AgF/2xBE;AhFi3xBF;AgFh3xBE;AACE;AAAyB;AAAuB;AhFo3xBpD;AgFn3xBI;AACE;AACD;AACF;AhFq3xBH;AgFp3xBE;AACA;AACE;AAEA;AACA;AACA;AhFq3xBJ;AgFp3xBI;AACE;AAAa;AAA2C;AACxD;AhFw3xBN;AgFt3xBM;AACD;AhFw3xBL;AgFv3xBI;AACE;AACD;AACC;AACD;AACF;AACD;AACD;AAED;AhFw3xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFx3xBA;AACE;AAOD;AAED;AhFm3xBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFn3xBA;AACE;AACE;AAMD;AACC;AACD;AhFg3xBH;AgF/2xBE;AACD;AAED;AhFg3xBA;AACA;AACA;AACA;AgFh3xBA;AACE;AACA;AACA;AACA;AACA;AACA;AANgB;AASlB;AhFi3xBA;AACA;AACA;AgFh3xBA;AAEA;AhFi3xBA;AgFh3xBA;AAEA;AhFi3xBA;AgFh3xBA;AAEA;AhFi3xBA;AgFh3xBA;AAEA;AhFi3xBA;AgFh3xBA;AAEA;AhFi3xBA;AgFh3xBA;AAEA;AhFi3xBA;AACA;AACA;AACA;AgFl3xBE;AhFo3xBF;AACA;AgFl3xBE;AACE;AACA;AAEA;AhFm3xBJ;AgFl3xBI;AACD;AAED;AhFm3xBF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgFr3xBI;AACA;AACA;AACD;AAED;AhFs3xBF;AACA;AACA;AACA;AACA;AACA;AACA;AgFt3xBI;AACD;AAED;AhFu3xBF;AACA;AACA;AACA;AACA;AACA;AgFv3xBI;AhFy3xBJ;AgFx3xBI;AACE;AAAQ;AAAqB;AAAtB;AACR;AhF63xBL;AgF33xBI;AhF63xBJ;AgF13xBI;AACE;AhF43xBN;AgF33xBM;AACE;AACE;AACD;AACF;AhF63xBP;AgF53xBM;AACE;AAAQ;AAAqB;AAAtB;AACR;AhFi4xBP;AgFh4xBM;AACD;AhFk4xBL;AACA;AgFh4xBI;AAOE;AhF43xBN;AgF33xBM;AhF63xBN;AgF53xBM;AACE;AhF83xBR;AgF73xBQ;AACE;AACA;AACD;AhF+3xBT;AgF93xBQ;AACE;AACD;AACF;AhFg4xBP;AgF/3xBM;AhFi4xBN;AgFh4xBM;AACA;AACA;AAAQ;AAAyB;AAAO;AAAjC;AACR;AhFs4xBL;AACA;AgFp4xBI;AACE;AAAQ;AAA2B;AAAU;AAAtC;AACR;AhF04xBL;AACA;AgFx4xBI;AACE;AhF04xBN;AgFz4xBM;AACE;AACE;AACA;AACD;AACF;AhF24xBP;AgF14xBM;AACE;AAAQ;AAAyB;AAA1B;AACR;AhF+4xBP;AgF94xBM;AhFg5xBN;AgF/4xBM;AACA;AAAQ;AAAyB;AAAO;AAAjC;AACR;AhFq5xBL;AACA;AgFn5xBI;AACE;AhFq5xBN;AgFp5xBM;AhFs5xBN;AgFr5xBM;AACE;AhFu5xBR;AgFt5xBQ;AACE;AACD;AACC;AACD;AhFw5xBT;AgFv5xBQ;AACE;AACA;AACD;AACF;AhFy5xBP;AgFx5xBM;AACE;AAAQ;AAAyB;AAA1B;AACR;AhF65xBP;AgF55xBM;AhF85xBN;AgF75xBM;AACA;AAAQ;AAAwB;AAAO;AAAhC;AACR;AhFm6xBL;AACA;AgFj6xBI;AhFm6xBJ;AgFl6xBI;AACE;AACE;AACD;AACF;AhFo6xBL;AgFn6xBI;AACA;AhFq6xBJ;AgFl6xBI;AACE;AhFo6xBN;AgFn6xBM;AAAQ;AAAyB;AAAO;AAAjC;AACR;AhFy6xBL;AACA;AgFv6xBI;AACE;AAAQ;AAAoB;AAAU;AAA/B;AACR;AhF66xBL;AACA;AgF36xBI;AAAQ;AAAyB;AAAU;AAApC;AACR;AhFi7xBH;AACA;AACA;AgFh7xBA;AhFk7xBA;AACA;AACA;AACA;AACA;AACA;AgFl7xBA;AACE;AACD;AAED;AhFm7xBA;AACA;AACA;AACA;AgFn7xBO;AACL;AAIE;AAAsB;AAEzB;AhFk7xBD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiFzz0BA;AjF2z0BA;AiF1z0BA;AjF4z0BA;AiF3z0BA;AjF6z0BA;AiF5z0BA;AjF8z0BA;AACA;AACA;AiF9z0BA;AjFg00BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiFl00BE;AjFo00BF;AACA;AiFl00BE;AAAiB;AjFq00BnB;AiFp00BI;AAEA;AjFq00BJ;AiFp00BI;AAJe;AAKhB;AAED;AjFs00BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiFz00ByB;AjF200BzB;AiF100BI;AAEA;AAEA;AACA;AjF000BJ;AiFx00BI;AACE;AAA6C;AAAA;AAC9C;AjF400BL;AiF100BI;AjF400BJ;AiF100BI;AACE;AAEI;AACA;AACD;AAEC;AACA;AACD;AAEJ;AjFy00BL;AiFv00BI;AACD;AAED;AjFw00BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiFx00BI;AACD;AjF000BH;AACA;AACA;AiFz00BA;AjF200BA;AACA;AACA;AACA;AACA;AACA;AACA;AiF700BO;AACL;AACA;AACD;AAED;AjF800BA;AACA;AACA;AACA;AiF900BO;AACL;AACD;AjFg10BD;AACA;AACA;AACA;AACA;AACA;AACA;AkF760BA;AlF+60BA;AkF960BA;AlFg70BA;AkF/60BA;AlFi70BA;AkFh70BA;AlFk70BA;AkFr80BA;AlFu80BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkFh80BA;AlFk80BA;AACA;AACA;AkFh80BA;AAEA;AlFi80BA;AACA;AACA;AACA;AkFh80BA;AAEA;AlFi80BA;AACA;AACA;AACA;AkFh80BA;AAEA;AlFi80BA;AACA;AACA;AACA;AkFh80BA;AAEA;AlFi80BA;AACA;AACA;AACA;AACA;AACA;AkFl80BE;AACA;AACE;AACA;AAEA;AlFm80BJ;AkFl80BI;AAEA;AlFm80BJ;AkFl80BI;AAEA;AlFm80BJ;AkFl80BI;AACD;AAED;AlFm80BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkFr80BI;AACD;AAED;AlFs80BF;AACA;AACA;AACA;AACA;AACA;AACA;AkFv80BsB;AlFy80BtB;AkFx80BI;AACE;AAAO;AAAkC;AAAzC;AACD;AlF680BL;AkF380BI;AACE;AACA;AACD;AlF680BL;AkF380BI;AACE;AACD;AACF;AAED;AlF480BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkF780BsC;AlF+80BtC;AkF/80BsC;AAArB;AAAqB;AlFm90BtC;AkFl90BI;AACE;AADmB;AlFs90BzB;AkFj90BI;AACA;AAIM;AACA;AACA;AACA;AACA;AAL+C;AAUjD;AACE;AACE;AACD;AlF680BX;AkF580BU;AlF880BV;AkF780BU;AACE;AACA;AACA;AACA;AACD;AlF+80BX;AkF980BU;AACD;AACF;AAEC;AACE;AACE;AACD;AACF;AACC;AlF+80BV;AkF980BU;AACE;AACD;AACC;AACD;AACF;AlFg90BT;AkF/80BQ;AACD;AACJ;AAED;AlFg90BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkFh90BI;AACA;AAGI;AACD;AACJ;AlFg90BH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmF7m1BA;AnF+m1BA;AmF9m1BA;AnFgn1BA;AmF/m1BA;AnFin1BA;AmFhn1BA;AnFkn1BA;AmFjn1BA;AnFmn1BA;AmFln1BA;AnFon1BA;AmFzo1BA;AnF2o1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmFjo1BA;AAGA;AACA;AAEA;AnFgo1BA;AmF/n1BO;AACL;AACA;AACA;AACA;AAJyB;AnFso1B3B;AmF/n1BA;AACA;AACA;AACA;AAEA;AnFgo1BA;AACA;AACA;AACA;AACA;AACA;AmFjo1BE;AACA;AACE;AnFmo1BJ;AACA;AmFjo1BI;AACA;AnFmo1BJ;AACA;AACA;AmFlo1BI;AAEA;AnFmo1BJ;AACA;AACA;AmFlo1BI;AnFoo1BJ;AmFjp1BsB;AAAA;AAiBlB;AnFoo1BJ;AACA;AmFpo1BI;AAGD;AAED;AnFmo1BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmFto1B8B;AnFwo1B9B;AmFvo1BI;AACE;AACD;AnFyo1BL;AmFxo1BI;AAEA;AnFyo1BJ;AmFxo1BI;AAEI;AACA;AACD;AAEC;AACE;AACD;AAED;AnFuo1BR;AACA;AmFvo1BQ;AnFyo1BR;AACA;AmFto1BQ;AACE;AACD;AnFwo1BT;AmFto1BQ;AACE;AACD;AnFwo1BT;AmFto1BQ;AACA;AAEI;AnFuo1BZ;AmFto1BY;AACE;AACA;AACA;AACA;AACA;AAKD;AnFoo1Bb;AmFno1BY;AACD;AAEC;AnFoo1BZ;AmFno1BY;AACE;AACE;AACD;AACF;AACC;AACD;AnFqo1Bb;AmFpo1BY;AACD;AACJ;AACJ;AAED;AnFqo1BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmFro1BI;AACE;AACA;AAFmB;AnF0o1BzB;AmFto1BI;AACE;AACD;AnFwo1BL;AmFvo1BI;AAIM;AACA;AACA;AACA;AACA;AALc;AAOP;AAAA;AAEd;AAED;AnFqo1BF;AACA;AACA;AACA;AACA;AACA;AmFro1BI;AACE;AACA;AACD;AnFuo1BL;AmFto1BI;AACE;AACA;AACD;AnFwo1BL;AmFvo1BI;AACE;AACD;AnFyo1BL;AmFxo1BI;AACA;AACD;AAED;AnFyo1BF;AACA;AACA;AACA;AACA;AACA;AmFzo1BI;AACE;AACE;AADoE;AAGvE;AACF;AAED;AnF0o1BF;AACA;AACA;AACA;AACA;AACA;AmF1o1BI;AACD;AAED;AnF2o1BF;AACA;AACA;AACA;AACA;AmF3o1BI;AACD;AAED;AnF4o1BF;AACA;AACA;AACA;AACA;AACA;AmF5o1BI;AAAO;AAAwB;AAA/B;AACD;AnFip1BH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFp21BA;ApFs21BA;AoFr21BA;ApFu21BA;AoFt21BA;ApFw21BA;AoFv21BA;ApFy21BA;AoFx21BA;ApF021BA;AoFz21BA;ApF221BA;AoFz21BA;ApF221BA;AoF121BA;ApF421BA;AoF321BA;ApF621BA;AoF521BA;ApF821BA;AoF721BA;ApF+21BA;AoF921BA;ApFg31BA;AoF/21BA;ApFi31BA;AoFh31BA;ApFk31BA;AoFx51BA;ApF051BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFx51BA;ApF051BA;AACA;AACA;AACA;AACA;AACA;AoFv41BA;AAEA;ApFw41BA;AACA;AACA;AoFv41BO;ApFy41BP;AoFv41BA;AAEA;AAEA;AAEA;ApFs41BA;AACA;AACA;AACA;AoFr41BA;AAEA;ApFs41BA;AACA;AACA;AACA;AoFr41BA;AAEA;ApFs41BA;AACA;AACA;AACA;AoFr41BA;AACE;AAD8B;AAIhC;ApFs41BA;AACA;AACA;AACA;AoFr41BA;AACE;AADe;AAIjB;ApFs41BA;AACA;AACA;AACA;AoFr41BA;AAEA;ApFs41BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFr41BA;AAEA;ApFs41BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF341BE;ApF641BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF141BE;ApF441BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF741BA;ApF+41BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFn51BE;AACA;AACE;AACA;AAEA;ApFo51BJ;AACA;AACA;AACA;AACA;AACA;AoFn51BI;AAEA;ApFo51BJ;AACA;AACA;AACA;AACA;AACA;AoFn51BI;AAEA;ApFo51BJ;AACA;AACA;AoFn51BI;AAEA;ApFo51BJ;AACA;AACA;AoFn51BI;AAEA;AAEA;ApFm51BJ;AoFl51BI;AACD;AAED;ApFm51BF;AACA;AACA;AACA;AACA;AoFt51BqD;ApFw51BrD;AoFv51BI;AAOA;AAEI;AACD;AAEC;AACA;AACA;AACD;AAEC;AACE;AACD;ApFg51BT;AoF/41BQ;ApFi51BR;AACA;AoF741BQ;AAOI;AACD;AACJ;AACJ;AAED;ApFw41BF;AACA;AACA;AoFx41BI;AACD;AAED;ApFy41BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF141BoD;ApF441BpD;AoF541BoD;AAEhD;ApF641BJ;AoF541BI;ApF841BJ;AoF741BI;AACE;ApF+41BN;AoF941BM;AACE;AACE;AACE;AACD;ApFg51BX;AoF/41BU;AACE;AACA;AACA;AACD;ApFi51BX;AoFh51BU;AACD;AACF;ApFk51BP;AoFj51BM;AACD;ApFm51BL;AoFj51BI;AACE;AACE;ApFm51BR;AoFl51BQ;AACD;ApFo51BP;AoFl51BM;AACE;AACE;AACE;AACD;ApFo51BX;AoFn51BU;AACD;AACF;ApFq51BP;AoFp51BM;AACD;AACF;AAED;ApFq51BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFt51BgD;ApFw51BhD;AoFv51BI;AACE;AAGD;AACF;AAED;ApFs51BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFt51BI;AACE;AACD;ApFw51BL;AoFv51BI;AACD;AAED;ApFw51BF;AACA;AACA;AACA;AACA;AACA;AACA;AoFx51BI;AACA;AAAgD;AAAO;ApF451B3D;AoFz51BI;AACE;AACA;AACE;ApF251BR;AoF151BQ;AACE;AACA;AACA;AACD;AACC;AACA;ApF451BV;AoF351BU;AACE;AACD;AACC;AAG0C;AAAO;AAElD;AACF;AACF;AACF;ApF251BL;AoF151BI;AACD;ApF451BH;AACA;AACA;AoF351BA;ApF651BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF751BO;AACL;AACA;AAA8B;AAAO;ApFi61BvC;AACA;AoF551BE;AACE;AACD;AACF;AAED;ApF651BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF751BO;AACL;AAEI;AAAmD;AAAA;AACpD;AAEC;AACA;AACD;AACJ;AAED;ApF851BA;AACA;AACA;AACA;AACA;AACA;AACA;AoF951BA;AACE;AACA;AACE;AADwC;AAG3C;AAED;ApF+51BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF/51BA;AAAkE;AAAA;AAGhE;AACA;ApFi61BF;AoF/51BE;AACE;AAAO;AAAkC;AAAzC;AACD;ApFo61BH;AoFl61BE;AACE;AAAO;AAAkC;AAAzC;AACD;ApFu61BH;AoFr61BE;AACE;AACA;AACE;AACD;ApFu61BL;AoFt61BI;AAAO;AAAkC;AAAzC;AACD;ApF261BH;AoFz61BE;AAEE;AAFuB;AAGR;AAAA;ApF461BnB;AoFz61BE;AACE;AACA;AACA;AACA;ApF261BJ;AoF161BI;AACE;AACD;AACF;AACD;AACD;AAED;ApF261BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF361BO;AACL;AACA;AACD;AAED;ApF461BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF561BA;AACE;AACE;AACD;ApF861BH;AoFj71B6C;AAM3C;AACE;AACA;AAGA;ApF461BJ;AoF361BI;AACE;ApF661BN;AoF561BM;AACE;AACD;AACF;AACC;AACA;AACA;AACD;ApF861BL;AoF561BI;AACE;AACE;AACD;AACF;ApF861BL;AoF561BI;AACD;AACF;AAED;ApF661BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoF761BA;AAAsD;ApFg71BtD;AoF961BE;AACE;AACA;AACD;AACC;AACA;AACE;AACE;AACD;AAEC;AACA;AACA;AACD;AACF;AACF;AACF;AAED;ApF861BA;AACA;AACA;AACA;AACA;AACA;AACA;AoF961BO;AACL;ApFg71BF;AoF/61BE;AACE;AACE;AACD;ApFi71BL;AACA;AoFh71BI;AACA;AACE;AACA;AACE;AACA;AACA;AAEI;AAAoB;AACpB;AAFG;AAKR;ApFi71BP;AoFh71BM;AACD;AACF;AACF;AAED;ApFi71BA;AACA;AACA;AACA;AACA;AACA;AACA;AoFj71BA;AACE;AAEI;AACA;AAFG;AAKR;AAED;ApFg71BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFh71BA;AAAsB;AAEpB;ApFk71BF;AoFj71BE;AACE;AACD;AAEA;ApFk71BH;AoFj71BE;ApFm71BF;AoFl71BE;AACE;AACA;AACD;ApFo71BH;AoFn71BE;AACE;AACE;AACD;ApFq71BL;AoFp71BI;AACA;AACE;AACA;AAFK;AAIR;AACF;AAED;ApFq71BA;AACA;AACA;AACA;AACA;AACA;AoFr71BA;AACE;AACA;AACA;AACD;AAED;ApFs71BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFt71BA;AACE;AACA;AACA;AACD;AAED;ApFu71BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoFv71BA;AACE;AACA;ApFy71BF;AoFx71BE;AACE;AACD;ApF071BH;AACA;AoFx71BE;AAOD;AAED;ApFm71BA;AACA;AACA;AACA;AACA;AACA;AoFn71BO;AACL;ApFq71BF;AoFp71BE;AACE;AACD;AACC;AACA;AACA;AAAa;AAA4B;AACzC;AAAkB;AAChB;AADgB;AAKnB;AACF;AAED;ApFs71BA;AACA;AACA;AACA;AACA;AoFt71BO;AACL;AACD;AAED;ApFu71BA;AACA;AACA;AACA;AACA;AACA;AoFv71BO;AACL;AACA;AACD;ApFy71BD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqF5l3BA;ArF8l3BA;AqF7l3BA;ArF+l3BA;AqF9l3BA;ArFgm3BA;AqF/l3BA;ArFim3BA;AqFhm3BA;ArFkm3BA;AqFjm3BA;ArFmm3BA;AqFlm3BA;ArFom3BA;AqFnm3BA;ArFqm3BA;AqFpm3BA;ArFsm3BA;AqFrm3BA;ArFum3BA;AqFtm3BA;ArFwm3BA;AqFvm3BA;ArFym3BA;AqFxm3BA;ArF0m3BA;AqFzm3BA;ArF2m3BA;AqF1m3BA;ArF4m3BA;AqF3m3BA;ArF6m3BA;AqF5m3BA;ArF8m3BA;AqF7m3BA;ArF+m3BA;AqF9m3BA;ArFgn3BA;AqF/m3BA;ArFin3BA;AqFhn3BA;ArFkn3BA;AqFjn3BA;ArFmn3BA;AqFln3BA;ArFon3BA;AqFnn3BA;ArFqn3BA;AqFpn3BA;ArFsn3BA;AqFrn3BA;ArFun3BA;AqFtn3BA;ArFwn3BA;AqFlq3BA;ArFoq3BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqFto3BA;ArFwo3BA;AACA;AACA;AACA;AqFto3BO;AACL;AACA;AACA;AACD;AAED;ArFuo3BA;AACA;AACA;AACA;AACA;AACA;AqFvo3BO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;AAED;ArFwo3BA;AACA;AACA;AACA;AACA;AACA;AqFxo3BO;AACL;AAGA;AACA;ArFwo3BF;AqFvo3BE;AACA;ArFyo3BF;AqFro3BE;AAGA;AAGA;AAGA;AACA;AAGA;AAGA;AAGA;AAGA;AACA;AACA;AAGA;AACA;AACD;ArFun3BD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsFlu3BA;AtFou3BA;AsFnu3BA;AtFqu3BA;AsFpu3BA;AtFsu3BA;AsFru3BA;AtFuu3BA;AsFtu3BA;AtFwu3BA;AsF5v3BA;AtF8v3BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsFtv3BA;AACA;AAEA;AtFuv3BA;AACA;AACA;AsFtv3BA;AtFwv3BA;AACA;AACA;AACA;AsFxv3BE;AtF0v3BF;AACA;AACA;AsFxv3BE;AACE;AACA;AAEA;AACA;AtFyv3BJ;AsFxv3BI;AACE;AACE;AACD;AACC;AACA;AACD;AACF;AAED;AtFyv3BJ;AACA;AsFzv3BI;AACE;AACA;AAAO;AAAD;AAFQ;AAKhB;AtF4v3BJ;AsF3v3BI;AAEA;AtF4v3BJ;AsF3v3BI;AAEA;AtF4v3BJ;AsF3v3BI;AACD;AAED;AtF4v3BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsF/v3BgB;AtFiw3BhB;AsFhw3BI;AACE;AACD;AtFkw3BL;AsFhw3BI;AACE;AACA;AACgB;AAAA;AAEjB;AtFkw3BL;AsFhw3BI;AACE;AAEa;AAAD;AACR;AAFF;AAIU;AAAA;AAEJ;AACA;AACA;AACE;AACA;AAKD;AtF8v3Bf;AsF7v3Bc;AAAiC;AAAA;AAClC;AAGR;AACC;AACA;AAAiC;AAAA;AAClC;AACF;AAED;AtFgw3BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsFhw3BI;AAAqC;AAAA;AACtC;AAED;AtFmw3BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsFnw3BI;AACE;AACA;AACA;AtFqw3BN;AsFpw3BM;AACE;AACA;AACD;AtFsw3BP;AsFrw3BM;AACD;AACF;AAED;AtFsw3BF;AACA;AACA;AACA;AACA;AACA;AACA;AsFvw3BkB;AtFyw3BlB;AsFxw3BI;AACE;AACD;AtF0w3BL;AsFzw3BI;AAEQ;AAAA;AACT;AAED;AtF0w3BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsF1w3BI;AACD;AAED;AtF2w3BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsF3w3BI;AtF6w3BJ;AsF3w3BI;AAC8B;AAA4B;AACtD;AAAsC;AAC1C;AAAO;AAA+C;AAAtD;AAOD;AAED;AtF2w3BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsF3w3BI;AACA;AAAO;AAAkC;AAAzC;AAMD;AtF2w3BH;AACA;AACA;AsF1w3BA;AtF4w3BA;AACA;AACA;AACA;AACA;AACA;AACA;AsF9w3BO;AACL;AACD;AtFgx3BD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuF5+3BA;AvF8+3BA;AuF7+3BA;AvF++3BA;AuF9+3BA;AvFg/3BA;AuF/+3BA;AvFi/3BA;AuFh/3BA;AvFk/3BA;AuFtg4BA;AvFwg4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuFhg4BA;AvFkg4BA;AACA;AACA;AuFhg4BA;AACE;AACE;AACD;AvFkg4BH;AuFjg4BE;AACD;AAED;AvFkg4BA;AACA;AACA;AACA;AACA;AACA;AACA;AuFlg4BO;AACL;AvFog4BF;AuFng4BE;AACE;AAA2B;AAA0B;AACrD;AACD;AvFug4BH;AuFtg4BE;AACE;AACA;AACD;AvFwg4BH;AuFvg4BE;AAOA;AvFmg4BF;AuFlg4BE;AACE;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AvFmg4BJ;AuF5g4BmD;AvF8g4BnD;AuFng4BI;AAIE;AvFkg4BN;AuFhg4BM;AACD;AACF;AACF;AAED;AvFig4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuFjg4BA;AACE;AACE;AACD;AACC;AACD;AACF;AAED;AvFkg4BA;AACA;AACA;AACA;AACA;AACA;AACA;AuFlg4BO;AACL;AACA;AACE;AACA;AACD;AACF;AAED;AvFmg4BA;AACA;AACA;AACA;AACA;AACA;AuFng4BO;AACL;AvFqg4BF;AuFpg4BE;AACE;AACD;AACF;AAED;AvFqg4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuFrg4BO;AACL;AACA;AACD;AAED;AvFsg4BA;AACA;AACA;AACA;AACA;AACA;AACA;AuFtg4BO;AACL;AACA;AACA;AACA;AACD;AAED;AvFug4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuFvg4BO;AACL;AvFyg4BF;AuFxg4BE;AACE;AACD;AACF;AAED;AvFyg4BA;AACA;AACA;AACA;AACA;AACA;AACA;AuFzg4BO;AACL;AACE;AACD;AACF;AAED;AvF0g4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuF1g4BO;AACL;AACA;AACD;AvF4g4BD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwF1r4BA;AxF4r4BA;AwFrr4BA;AxFur4BA;AwFtr4BA;AxFwr4BA;AwFvr4BA;AxFyr4BA;AwFxr4BA;AxF0r4BA;AwFpt4BA;AxFst4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwFxs4BA;AACA;AAEA;AxFys4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwFxs4BO;AAEP;AxFys4BA;AACA;AACA;AACA;AACA;AACA;AwF1s4BO;AACL;AACD;AxF4s4BD;AACA;AACA;AACA;AwF5s4BE;AxF8s4BF;AACA;AwF5s4BE;AACE;AACA;AACA;AxF8s4BJ;AwF7s4BI;AACA;AxF+s4BJ;AwF9s4BI;AACD;AAED;AxF+s4BF;AACA;AACA;AACA;AACA;AwFjt4BI;AACE;AACD;AxFmt4BL;AwFlt4BI;AACA;AACA;AACA;AACA;AxFot4BJ;AwFnt4BI;AACE;AACA;AAGD;AxFmt4BL;AwFlt4BI;AACA;AACA;AACA;AAEA;AACE;AACA;AACE;AACD;AxFmt4BP;AwFlt4BM;AACA;AxFot4BN;AwFnt4BM;AACE;AACA;AACA;AACA;AACE;AACD;AxFqt4BT;AwFpt4BQ;AACD;AxFst4BP;AwFrt4BM;AACA;AACA;AAlBmB;AAoBtB;AxFut4BH;AACA;AACA;AwFtt4BA;AxFwt4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwF1t4BA;AACE;AACD;AAED;AxF2t4BA;AACA;AACA;AACA;AACA;AACA;AACA;AwF3t4BA;AACE;AxF6t4BF;AwF5t4BE;AACE;AxF8t4BJ;AwF/t4BgB;AAGV;AAHU;AAKV;AxF+t4BN;AwF9t4BM;AACE;AACD;AxFgu4BP;AwF9t4BM;AACE;AACE;AACD;AxFgu4BT;AwF9t4BQ;AxFgu4BR;AwF/t4BQ;AACE;AACA;AACE;AACD;AxFiu4BX;AwFhu4BU;AACD;AACC;AACD;AACF;AAzBS;AxF4v4BhB;AwF1v4BI;AAAuC;AxF6v4B3C;AwF7v4B2C;AAwBtC;AACF;AxFwu4BH;AwFvu4BE;AACD;AAED;AxFwu4BA;AACA;AACA;AACA;AACA;AACA;AACA;AwFxu4BA;AACE;AxF0u4BF;AwFzu4BE;AACE;AxF2u4BJ;AwF1u4BI;AACE;AACA;AACA;AxF4u4BN;AwF3u4BM;AACE;AACD;AxF6u4BP;AwF3u4BM;AxF6u4BN;AwF5u4BM;AACE;AACA;AACE;AACD;AxF8u4BT;AwF7u4BQ;AACD;AACC;AACD;AACF;AACF;AxF+u4BH;AwF9u4BE;AACD;AAED;AxF+u4BA;AACA;AACA;AACA;AACA;AACA;AACA;AwF/u4BA;AACE;AACA;AAIE;AACD;AxF8u4BH;AwF7u4BE;AACA;AxF+u4BF;AwF9u4BE;AACE;AACA;AACD;AxFgv4BH;AwF/u4BE;AACD;AxFiv4BD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyF784BA;AzF+84BA;AyF984BA;AzFg94BA;AyFj+4BA;AzFm+4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyF994BA;AzFg+4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyF994BA;AAEA;AzF+94BA;AACA;AACA;AACA;AACA;AACA;AyF994BO;AACL;AACE;AzFg+4BJ;AyF/94BI;AACE;AACD;AzFi+4BL;AyFh+4BI;AACD;AzFk+4BH;AyFj+4BE;AACD;AAED;AzFk+4BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyFl+4BO;AAML;AACA;AzF+94BF;AyF994BE;AACE;AACD;AzFg+4BH;AyF/94BE;AAGA;AACD;AAED;AzF894BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyF994BO;AAML;AzF294BF;AyF194BE;AACE;AACD;AzF494BH;AyF394BE;AACD;AAED;AzF494BA;AACA;AACA;AACA;AACA;AACA;AyF594BO;AACL;AACA;AAEA;AACE;AACA;AAFK;AAIR;AzF694BD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fjk5BA;A1Fmk5BA;A0Flk5BA;A1Fok5BA;A0Fnk5BA;A1Fqk5BA;A0Fjk5BA;A1Fmk5BA;A0Flk5BA;A1Fok5BA;A0Fnk5BA;A1Fqk5BA;A0Fpk5BA;A1Fsk5BA;A0Frk5BA;A1Fuk5BA;A0Ftk5BA;A1Fwk5BA;A0Fvk5BA;A1Fyk5BA;A0Frm5BA;A1Fum5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fnl5BO;A1Fql5BP;A0Fpl5BA;AACA;AACA;AACA;AAEA;A1Fql5BA;AACA;AACA;AACA;AACA;A0Fpl5BA;AAEA;A1Fql5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fpl5BA;AAEA;A1Fql5BA;AACA;AACA;AACA;AACA;A0Fpl5BA;AAEA;A1Fql5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fpl5BA;AAEA;A1Fql5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fpl5BA;AAEA;A1Fql5BA;AACA;AACA;AACA;A0Fpl5BO;AACL;AACD;AAED;A1Fql5BA;AACA;AACA;AACA;AACA;A0Frl5BA;AACE;AACD;AAED;A1Fsl5BA;AACA;AACA;AACA;AACA;AACA;A0Ftl5BO;AACL;AACD;AAED;A1Ful5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fzl5BE;A1F2l5BF;AACA;A0Fzl5BE;AACE;AACA;AAEA;A1F0l5BJ;A0Fzl5BI;AAEA;A1F0l5BJ;A0Fzl5BI;AAEA;A1F0l5BJ;A0Fzl5BI;AACD;AAED;A1F0l5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0F5l5BI;AAAqD;AAAW;A1Fgm5BpE;A0F/l5BI;AACE;AACA;A1Fim5BN;A0Fhm5BM;AACE;AACE;AACA;AACA;AACD;AACF;A1Fkm5BP;A0Fjm5BM;A1Fmm5BN;A0Flm5BM;AACE;AACD;AACF;AACC;A1Fom5BN;A0Fnm5BM;AACE;AACD;A1Fqm5BP;A0Fpm5BM;AACD;AACC;AACD;AACF;AAED;A1Fqm5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Frm5BI;AAAO;AAAwC;AAIO;AAAW;AAJjE;AAOD;AAED;A1Fqm5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Frm5BI;AACE;AACD;A1Fum5BL;A0Ftm5BI;AAAqD;AAAW;AAChE;AAKA;AACD;AAED;A1Fqm5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ftm5BoE;A1Fwm5BpE;A0Fvm5BI;AACA;A1Fym5BJ;A0Fxm5BI;AACE;AACD;A1F0m5BL;A0Fzm5BI;AACE;AACD;A1F2m5BL;A0F1m5BI;AACA;AAGO;AAAA;AACR;AAED;A1F0m5BF;AACA;AACA;AACA;AACA;AACA;AACA;A0F1m5BI;AACA;AAEE;AAAsB;AAExB;A1F2m5BJ;A0Fzm5BI;A1F2m5BJ;A0F1m5BI;AACE;AACA;AACD;A1F4m5BL;A0F3m5BI;AACA;AACA;AACD;AAED;A1F4m5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0F7m5B2D;AAAxB;AAAwB;A1Fin5B3D;A0Fhn5BI;AACA;AAGA;AAA8B;AAAO;AAGtC;AAED;A1F+m5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0F/m5BI;AACE;AAKA;AACD;AACF;AAED;A1F4m5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0F7m5B6C;A1F+m5B7C;A0F9m5BI;AACA;AAAmC;AAAqB;AAAtB;AAClC;AACE;AACD;AACF;AAED;A1Fkn5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fnn5B0D;A1Fqn5B1D;A0Fpn5BI;AACE;AAII;AACD;AACD;AAAmB;AAGtB;AACC;AACD;AACF;AAED;A1Fin5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fjn5BI;AACA;A1Fmn5BJ;A0Fjn5BI;AACD;AAED;A1Fkn5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fln5BI;AACA;AACE;AAAqC;AACnC;AACA;AAFmC;AAKvC;AACE;AAIE;AAAkB;AAErB;AACF;AAED;A1Fgn5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fhn5BI;AACA;A1Fkn5BJ;A0F/m5BI;AACE;AACA;AAEA;A1Fgn5BN;A0F/m5BM;AACE;AACD;AACF;AACF;AAED;A1Fgn5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fjn5B+C;A1Fmn5B/C;A0Fln5BI;AACA;AACE;AACD;AACD;AACD;AAED;A1Fmn5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fnn5BI;AAAqD;AAAW;AAChE;AACE;AACA;AACE;AACE;AACD;AACC;AACD;AACF;AACF;AACF;AAED;A1Fsn5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Ftn5BI;A1Fwn5BJ;A0Fvn5BI;AACE;AAAkB;AAA6B;AAC7C;AACA;AAF6C;AAI/C;AAAS;AAAmC;AAC1C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAT0C;AAW5C;AACD;A1F6n5BL;A0F5n5BI;AACD;AAED;A1F6n5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0F7n5BI;AACE;AACD;A1F+n5BL;A0F9n5BI;AAEE;AAAW;AAEd;AAED;A1F8n5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0F9n5BI;AACE;AACE;AACD;AACC;AACD;AACC;AACA;AACA;AACA;AACD;AACF;A1Fgo5BL;A0F/n5BI;AACD;AAED;A1Fgo5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fho5BI;AACE;AAIA;AACA;AACD;AACF;AAED;A1F8n5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0F9n5BI;AACE;AACD;A1Fgo5BL;A0F/n5BI;AACE;AACA;AACD;A1Fio5BL;A0Fho5BI;AACD;AAED;A1Fio5BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Fjo5BI;AACA;A1Fmo5BJ;A0Flo5BI;AACE;AACD;AACC;AAID;A1Fio5BL;A0Fho5BI;AACA;AACA;A1Fko5BJ;A0Fjo5BI;AACE;AACD;A1Fmo5BL;A0Flo5BI;AAMA;AACA;AACD;AAED;A1F8n5BF;AACA;AACA;AACA;AACA;AACA;AACA;A0F9n5BI;AAGD;A1F8n5BH;AACA;AACA;A0F7n5BA;A1F+n5BA;AACA;AACA;AACA;AACA;AACA;A0Fjo5BO;AACL;AACE;AACD;AACF;AAED;A1Fko5BA;AACA;AACA;AACA;A0Flo5BA;AACE;AACA;AACD;A1Foo5BD;AACA;AACA;AACA;AACA;AACA;AACA;A2Frt6BA;A3Fut6BA;A2Ftt6BA;A3Fwt6BA;A2Fvt6BA;A3Fyt6BA;A2F9s6BA;A3Fgt6BA;A2F/s6BA;A3Fit6BA;A2Fht6BA;A3Fkt6BA;A2Fjt6BA;A3Fmt6BA;A2Flt6BA;A3Fot6BA;A2Frv6BA;A3Fuv6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fju6BA;AAEA;AACA;AAEA;AACA;AAEA;A3Fgu6BA;AACA;AACA;AACA;A2F/t6BA;AACE;AACD;AAED;A3Fgu6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Flu6BE;A3Fou6BF;AACA;AACA;AACA;AACA;AACA;A2Flu6BE;AAA4D;A3Fqu6B9D;A2Fpu6BI;AACA;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AACE;AACD;AAED;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AAEA;A3Fqu6BJ;A2Fpu6BI;AACD;AAED;A3Fqu6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fxu6B8C;A3F0u6B9C;A2Fzu6BI;A3F2u6BJ;A2F1u6BI;AACE;AACD;A3F4u6BL;A2F1u6BI;AACE;AACE;AAEE;AAAmB;AAEtB;AACF;AACF;AAED;A3F0u6BF;AACA;AACA;AACA;AACA;A2F1u6BI;A3F4u6BJ;A2F3u6BI;AACE;AACD;A3F6u6BL;A2F3u6BI;AAAqC;AAAA;AACrC;A3F+u6BJ;A2F9u6BI;AACE;AACD;AACF;AAED;A3F+u6BF;AACA;AACA;AACA;AACA;A2F/u6BI;AACA;A3Fiv6BJ;A2Fhv6BI;AACE;AACD;A3Fkv6BL;A2Fhv6BI;AACA;A3Fkv6BJ;A2Fhv6BI;AACE;A3Fkv6BN;A2Fhv6BM;AACE;AACA;AACD;A3Fkv6BP;A2Fxv6BiD;AAAA;A3F2v6BjD;A2Fnv6BM;AAQE;AACD;AAED;A3F6u6BN;AACA;A2F7u6BM;AACD;A3F+u6BL;A2F7u6BI;A3F+u6BJ;A2F7u6BI;AACE;AACD;A3F+u6BL;A2F7u6BI;A3F+u6BJ;A2F9u6BI;AACE;AAMD;AACF;AAED;A3F0u6BF;AACA;AACA;AACA;AACA;AACA;AACA;A2F1u6BI;A3F4u6BJ;A2Fzu6BI;AAEA;AACD;AAED;A3Fyu6BF;AACA;AACA;AACA;AACA;AACA;A2Fzu6BI;AACE;AACD;A3F2u6BL;A2F1u6BI;AACD;AAED;A3F2u6BF;AACA;AACA;AACA;AACA;A2F3u6BI;AACA;A3F6u6BJ;A2F5u6BI;AACE;AACA;AACD;AACF;AAED;A3F6u6BF;AACA;AACA;AACA;AACA;AACA;A2F9u6BwB;A3Fgv6BxB;A2F/u6BI;AACE;AACD;A3Fiv6BL;A2F/u6BI;AACA;A3Fiv6BJ;A2Fhv6BI;A3Fkv6BJ;A2Fjv6BI;AACE;AACE;AACA;AACD;AACF;AACF;AAED;A3Fkv6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Flv6BI;A3Fov6BJ;A2Fnv6BI;AACE;AACD;A3Fqv6BL;A2Fpv6BI;AACD;AAED;A3Fqv6BF;AACA;AACA;AACA;AACA;AACA;AACA;A2Frv6BI;AACA;AACA;AACA;AACE;AACA;AACE;AACE;A3Fuv6BV;A2Ftv6BU;AACE;AACD;AACC;AACD;AACF;AACF;AACF;AACC;AACA;AACE;AACE;AACE;AACA;AAFmB;AAItB;AACF;AACF;AACF;AAED;A3Fuv6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fvv6BI;AAEE;AAAe;AACf;AAAe;A3F0v6BrB;A2Fvv6BI;AACE;AACD;A3Fyv6BL;A2Fxv6BI;AAGA;A3Fwv6BJ;A2Fvv6BI;AAEA;AACD;AAED;A3Fuv6BF;AACA;AACA;AACA;AACA;AACA;A2Fvv6BI;AACA;AACD;AAED;A3Fwv6BF;AACA;AACA;AACA;AACA;AACA;AACA;A2Fzv6B4B;A3F2v6B5B;A2F1v6BI;AACE;AACE;AACE;A3F4v6BV;A2F3v6BU;AACE;AACD;AACF;AACF;AACF;AACF;AAED;A3F4v6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2F5v6BI;AACD;AAED;A3F6v6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2F7v6BI;AACD;AAED;A3F8v6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2F/v6BW;A3Fiw6BX;A2Fhw6BI;A3Fkw6BJ;A2Fjw6BI;AACA;AACI;AAAA;AAEJ;AAAmB;AAAA;A3Fqw6BvB;A2Fnw6BI;AACE;AACD;A3Fqw6BL;AACA;A2Fnw6BI;AAGA;AACA;A3Fmw6BJ;A2Flw6BI;AACA;AAGM;AACE;AACA;AAFgB;AAMhB;AACA;AACA;AACA;AACA;AACA;AACA;A3Fgw6BZ;A2F/v6BY;AACE;AACE;AACA;AACA;AAHsC;AAKzC;AAED;AACA;A3Fgw6BZ;AACA;A2Fhw6BY;AACE;AACD;A3Fkw6Bb;AACA;A2Fjw6BY;AACE;AACD;A3Fmw6Bb;A2Fjw6BY;AACE;AADwC;AAAA;AAGxC;AAHwC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOxC;AACA;AARwC;AAYxC;AAGA;AACA;A3Fsw6Bd;A2Fpw6Bc;AACE;AACE;AACA;AACA;AACA;AACA;AALa;AAOf;AACD;A3Fsw6Bf;A2Fpw6Bc;AACE;AAIE;AACD;AACC;AACD;AACF;AAGD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A3Fiw6Bd;AACA;A2Fjw6Bc;A3Fmw6Bd;A2Flw6Bc;AACE;AACE;AACD;AACC;AACD;AACC;AAED;AACF;A3Fmw6Bf;A2Flw6Bc;AACE;AACD;A3Fow6Bf;A2Fnw6Bc;AACE;AACA;AACA;AACA;AACA;AACA;AANa;AAQhB;AACF;AACD;AACE;AACE;AACD;A3Fqw6Bb;A2Fpw6BY;A3Fsw6BZ;A2Frw6BY;AACE;AACA;AAGA;AACA;A3Fqw6Bd;A2Fpw6Bc;AAEA;AACA;AACA;A3Fqw6Bd;A2Fpw6Bc;A3Fsw6Bd;A2Fpw6Bc;AACE;AACD;AACF;AACF;AAnIH;AAwIA;AACA;AACD;AACJ;AAED;A3Fkw6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Flw6BI;AACE;AACD;AACC;AACA;AACD;AACF;AAED;A3Fmw6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fnw6BI;AACE;AACA;A3Fqw6BN;A2Fpw6BM;AACE;AACE;AACA;AACD;A3Fsw6BT;A2Frw6BQ;AAIE;AAAwB;AAG3B;AACF;A3Fmw6BL;A2Flw6BI;AACE;A3Fow6BN;A2Fnw6BM;A3Fqw6BN;A2Fpw6BM;AACE;AAIE;AAAwB;AAG3B;AACF;AACF;AAED;A3Fiw6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fjw6BI;AAIE;AAOD;AACF;AAED;A3Fyv6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fnv6BI;AACA;AACE;AACD;AAGD;A3Fmv6BJ;AACA;A2Fnv6BI;AACE;AACD;A3Fqv6BL;A2Fpv6BI;A3Fsv6BJ;A2Frv6BI;AACE;AACD;A3Fuv6BL;A2Frv6BI;AAGA;A3Fqv6BJ;A2Fpv6BI;A3Fsv6BJ;A2Frv6BI;AACE;A3Fuv6BN;A2Ftv6BM;AACE;AACD;A3Fwv6BP;AACA;A2Fvv6BM;AACE;AACD;AAED;A3Fwv6BN;AACA;A2Fxv6BM;AACE;AACD;AACF;A3F0v6BL;A2Fzv6BI;AACE;AACD;A3F2v6BL;A2Fzv6BI;A3F2v6BJ;A2F1v6BI;AACE;A3F4v6BN;A2F3v6BM;AACE;AACA;AACD;AACF;A3F6v6BL;A2F5v6BI;A3F8v6BJ;A2F7v6BI;AACE;AACE;AACA;AACD;AACF;AACC;AACA;AACA;A3F+v6BN;A2F9v6BM;AACE;AACD;AACC;AACD;A3Fgw6BP;A2F/v6BM;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AAPG;AASL;AACD;A3Fiw6BL;A2F/v6BI;AACA;AACD;AAED;A3Fgw6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fhw6BI;A3Fkw6BJ;A2Fjw6BI;AACE;A3Fmw6BN;A2Flw6BM;AACE;AACE;AACE;AACD;AACF;A3Fow6BT;A2Fnw6BQ;AACA;AACD;AACF;A3Fqw6BL;A2Fpw6BI;AACE;AACD;A3Fsw6BL;A2Frw6BI;AACD;AAED;A3Fsw6BF;AACA;AACA;AACA;AACA;A2Ftw6BI;AACE;AACD;AACF;AAED;A3Fuw6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fxw6BmC;AAAA;AAG/B;AACA;AACA;AACA;A3Fyw6BJ;A2Ftw6BI;AAKE;AACD;AAGD;A3Fkw6BJ;AACA;A2Flw6BI;AACE;AACE;AACA;AACA;AACD;AACC;AACA;AACA;AACE;AACA;AACD;AACC;AACA;AAKD;AACF;AACF;A3Fgw6BL;AACA;A2F9v6BI;AACE;AACD;AACF;AAED;A3F+v6BF;AACA;AACA;AACA;AACA;A2F/v6BI;AACA;AACE;AACD;A3Fiw6BL;A2Fhw6BI;AACA;AAGA;AACD;AAED;A3F+v6BF;AACA;AACA;AACA;AACA;AACA;AACA;A2F/v6BI;AACE;A3Fiw6BN;A2Fhw6BM;AACe;AAAmB;AACnB;AAAsB;AAEnC;AACA;AACD;A3Fmw6BP;A2Fjw6BM;AAAiB;AAAmB;AAAG;AAAA;A3Fuw6B7C;A2Fpw6BQ;AACE;AACD;A3Fsw6BT;A2Frw6BQ;AACE;AACD;AACC;AACD;AACF;AACF;AACF;A3Fuw6BH;AACA;AACA;A2Ftw6BA;A3Fww6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fzw6BA;AAEA;A3F0w6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fzw6BA;AAEA;A3F0w6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2F/w6BE;A3Fix6BF;AACA;AACA;A2F9w6BE;A3Fgx6BF;AACA;AACA;AACA;AACA;A2F/w6BE;A3Fix6BF;AACA;AACA;AACA;AACA;AACA;A2Fhx6BE;A3Fkx6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fjx6BE;A3Fmx6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fpx6BA;A3Fsx6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Fxx6BE;A3F0x6BF;AACA;AACA;A2Fxx6BE;AACE;AACA;AAEA;A3Fyx6BJ;A2Fxx6BI;AAEA;A3Fyx6BJ;A2Fxx6BI;AAAiC;AAAW;AAC5C;AACA;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AArBa;AAuBf;AACA;AACA;AACD;AAED;A3F2x6BF;AACA;AACA;AACA;AACA;A2F7x6BI;AACD;AAED;A3F8x6BF;AACA;AACA;A2F/x6BsB;A3Fiy6BtB;A2Fhy6BI;AACE;A3Fky6BN;A2Fjy6BM;AACE;AACD;AACC;AACD;AACF;AACF;AAED;A3Fky6BF;AACA;AACA;AACA;AACA;AACA;AACA;A2Fny6BW;AAEP;AACA;AACA;A3Foy6BJ;A2Fny6BI;AACE;AAEA;A3Foy6BN;A2Fny6BM;AACE;AACD;A3Fqy6BP;AACA;A2Fpy6BM;AACD;A3Fsy6BL;A2Fry6BI;AAA4C;A3Fwy6BhD;A2Fty6BM;AAKE;AACD;A3Foy6BP;A2Fny6BM;AACA;AACD;AACF;AAED;A3Foy6BF;AACA;AACA;A2Fry6B+B;A3Fuy6B/B;A2Fvy6B+B;A3Fyy6B/B;A2Fvy6BI;AACE;AACD;A3Fyy6BL;A2Fvy6BI;AACA;A3Fyy6BJ;A2Fly6BI;AACE;AACA;AACA;AAGA;AACA;AACD;A3Fky6BL;AACA;A2Fhy6BI;AAOA;A3F4x6BJ;A2F3x6BI;AACE;AACD;A3F6x6BL;A2F3x6BI;AACA;AAGA;A3F2x6BJ;A2F1x6BI;AAA0C;AAAA;A3F8x6B9C;A2F3x6BI;AACE;AAMA;AACD;AACF;AAED;A3Fux6BF;AACA;AACA;A2Fvx6BI;AACE;AACD;A3Fyx6BL;A2F5x6BiB;AAAA;AAKb;A3F2x6BJ;A2Fzx6BI;AACE;AACD;A3F2x6BL;A2Fzx6BI;AACE;AACA;AACD;AACC;AACD;AACF;AAED;A3F0x6BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2F1x6BI;AACE;AACD;AACC;AACA;AACA;AACD;AACF;A3F4x6BH;AACA;AACA;AACA;A2F5x6BA;AAEA;A3F6x6BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2F9x6BE;A3Fgy6BF;AACA;AACA;A2F9x6BE;AACE;AACA;AAEA;A3F+x6BJ;A2F9x6BI;AACA;AACA;AACE;AACA;AACA;AACA;AACA;AACA;AAN8B;A3Fuy6BpC;A2F7x6BI;AACA;AACA;AAEA;AACD;AAED;A3F6x6BF;AACA;AACA;AACA;AACA;A2F/x6BI;AACD;AAED;A3Fgy6BF;AACA;AACA;A2Fjy6BsB;A3Fmy6BtB;A2Fly6BI;AACE;AACD;AACF;AAED;A3Fmy6BF;AACA;AACA;AACA;A2Fjy6BE;A3Fmy6BF;AACA;AACA;A2Fpy6BiB;AAGb;AACA;A3Foy6BJ;A2F5x6BI;AACD;AAED;A3F6x6BF;AACA;AACA;A2F7x6BI;AACA;AACD;A3F+x6BH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4Fz98BA;A5F298BA;A4F198BA;A5F498BA;A4F398BA;A5F698BA;A4F/+8BA;A5Fi/8BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4Fx+8BA;A5F0+8BA;AACA;AACA;A4Fx+8BA;AACE;AACA;AACA;AAHuB;AAMzB;A5Fy+8BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4F1+8BE;A5F4+8BF;AACA;AACA;A4F1+8BE;AACE;A5F4+8BJ;A4F1+8BI;AACA;AACA;AAEA;A5F2+8BJ;A4F1+8BI;AAAY;AAAwB;AAEpC;A5F6+8BJ;A4F5+8BI;AAEA;A5F6+8BJ;A4F5+8BI;AACD;AAED;A5F6+8BF;AACA;AACA;AACA;AACA;AACA;AACA;A4F7+8BI;AAKD;AAED;A5F0+8BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4F7+8Be;A5F++8Bf;A4F9+8BI;AAEA;AACA;AACE;A5F++8BN;A4F9+8BM;AACE;AACD;AACF;AACF;AAED;A5F++8BF;AACA;AACA;AACA;AACA;A4Fh/8BU;A5Fk/8BV;A4Fj/8BI;AACE;AACD;A5Fm/8BL;A4Fl/8BI;AAEA;AACE;AACE;AACD;AACF;AACD;AACA;AACD;AAED;A5Fk/8BF;AACA;AACA;AACA;AACA;AACA;A4Fl/8BI;AACE;AACD;A5Fo/8BL;A4Fn/8BI;AACA;AACA;AACA;AACD;A5Fq/8BH;AACA;AACA;A4Fp/8BA;A5Fs/8BA;AACA;AACA;AACA;AACA;AACA;A4Fx/8BO;AACL;AACD;A5F0/8BD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fnn9BA;A7Fqn9BA;A6Fpn9BA;A7Fsn9BA;A6Frn9BA;A7Fun9BA;A6Ftn9BA;A7Fwn9BA;A6Fvn9BA;A7Fyn9BA;A6Fxn9BA;A7F0n9BA;A6Frn9BA;A7Fun9BA;A6Fjp9BA;A7Fmp9BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fro9BA;AACA;AAEA;A7Fso9BA;A6Fro9BA;AAEA;A7Fso9BA;A6Fro9BA;AAEA;A7Fso9BA;AACA;AACA;A6Fro9BA;AAEA;A7Fso9BA;AACA;AACA;A6Fro9BA;AAEA;A7Fso9BA;AACA;AACA;AACA;AACA;AACA;A6Fvo9BE;A7Fyo9BF;AACA;AACA;A6Fvo9BE;AACE;AACA;AAEA;A7Fwo9BJ;A6Fvo9BI;AAEA;A7Fwo9BJ;A6Fvo9BI;AAEA;A7Fwo9BJ;A6Fvo9BI;AAEA;A7Fwo9BJ;A6Fvo9BI;AAEA;A7Fwo9BJ;AACA;AACA;AACA;AACA;AACA;AACA;A6Fvo9BI;AAEA;AACD;AAED;A7Fuo9BF;AACA;AACA;AACA;AACA;A6Fzo9BI;AACD;AAED;A7F0o9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F3o9BmC;A7F6o9BnC;A6F5o9BI;AACE;AACE;A7F8o9BR;A6F7o9BQ;AACE;AACD;A7F+o9BT;A6F9o9BQ;AACD;AACF;AACF;AAED;A7F+o9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fhp9Be;A7Fkp9Bf;A6Fjp9BI;AACE;AACE;AACD;AACF;AACF;AAED;A7Fkp9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fnp9B2B;A7Fqp9B3B;A6Fpp9BI;AAAmB;AAAA;AACpB;AAED;A7Fup9BF;AACA;AACA;AACA;AACA;AACA;AACA;A6Fxp9BQ;A7F0p9BR;A6Fzp9BI;AAAmB;AAAA;AACpB;AAED;A7F4p9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F7p9BW;A7F+p9BX;A6F9p9BI;AACE;AACE;AACA;AACD;AAED;A7F+p9BN;AACA;A6F/p9BM;AACE;AACD;AACF;AACF;AAED;A7Fgq9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fjq9BgC;A7Fmq9BhC;A6Flq9BI;AACA;AACA;AACE;AACD;AACC;AACD;AACF;AAED;A7Fmq9BF;AACA;AACA;AACA;AACA;AACA;AACA;A6Fnq9BI;AACD;AAED;A7Foq9BF;AACA;AACA;AACA;AACA;AACA;AACA;A6Fpq9BI;AACE;AACD;A7Fsq9BL;A6Frq9BI;AACD;AAED;A7Fsq9BF;AACA;AACA;AACA;AACA;AACA;A6Ftq9BI;AACA;AACD;AAED;A7Fuq9BF;AACA;AACA;AACA;AACA;AACA;A6Fxq9BuB;A7F0q9BvB;A6Fzq9BI;AACE;AACD;A7F2q9BL;A6Fzq9BI;A7F2q9BJ;A6F1q9BI;AACE;AACE;AACA;AACD;AACF;A7F4q9BL;A6F3q9BI;A7F6q9BJ;A6F3q9BI;AAAsB;AAElB;AACA;AACA;AAAkB;AAAA;AAJA;A7For9B1B;A6Fnr9BM;AAAuC;AAItC;AACF;AACF;AAED;A7Fkr9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Flr9BI;AADqB;AAAA;AAAA;A7Fwr9BzB;A6Fnr9BI;AACA;AAAkB;AAAU;AAAS;AAAQ;AAA5B;A7F0r9BrB;A6Fzr9BI;AACE;AACD;A7F2r9BL;A6F1r9BI;AACD;AAED;A7F2r9BF;AACA;AACA;AACA;AACA;A6F5r9BW;A7F8r9BX;A6F7r9BI;AACE;AACD;A7F+r9BL;A6F7r9BI;AACA;A7F+r9BJ;A6F9r9BI;AACE;AACD;AACC;AACD;A7Fgs9BL;A6F9r9BI;AAGM;AACD;AAEC;A7F6r9BV;A6F3r9BU;AACE;AACA;AACD;A7F6r9BX;A6F5r9BU;AACD;AAGD;A7F4r9BR;A6F3r9BQ;AACD;AACJ;A7F6r9BH;AACA;AACA;A6F5r9BA;A7F8r9BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fts9BE;A7Fws9BF;A6Frs9BE;A7Fus9BF;AACA;AACA;AACA;AACA;AACA;AACA;A6Fts9BE;A7Fws9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fvs9BE;A7Fys9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fxs9BE;A7F0s9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fzs9BE;A7F2s9BF;AACA;AACA;AACA;AACA;AACA;AACA;A6F1s9BE;A7F4s9BF;AACA;AACA;AACA;AACA;AACA;A6F3s9BE;A7F6s9BF;AACA;AACA;AACA;AACA;AACA;AACA;A6F5s9BE;A7F8s9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F/s9BA;A7Fit9BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fnt9BE;A7Fqt9BF;AACA;A6Fnt9BE;AAAiB;A7Fst9BnB;A6Frt9BI;AACA;AAEA;A7Fst9BJ;A6Frt9BI;AALe;AASf;A7Fqt9BJ;A6Fpt9BI;AACA;A7Fst9BJ;A6Frt9BI;AACE;AACD;AAED;A7Fst9BJ;AACA;A6Ftt9BI;AAEA;A7Fut9BJ;AACA;AACA;AACA;A6Ftt9BI;AAEA;A7Fut9BJ;A6Ftt9BI;AAGA;A7Fst9BJ;A6Frt9BI;A7Fut9BJ;A6Ftt9BI;AAEA;A7Fut9BJ;A6Ftt9BI;A7Fwt9BJ;A6Frt9BI;A7Fut9BJ;A6Ftt9BI;AACE;AACA;AAEA;A7Fut9BN;A6Ftt9BM;A7Fwt9BN;A6Ftt9BM;AACE;A7Fwt9BR;A6Fvt9BQ;AAIE;AACA;AAEH;A7Fqt9BP;A6Fpt9BM;AACE;AAEA;A7Fqt9BR;A6Fpt9BQ;AACE;AACD;AACC;AACD;AACF;A7Fst9BP;A6Frt9BM;AACE;AACD;A7Fut9BP;A6Ftt9BM;AACE;AACD;AACF;AACC;AACE;AACD;A7Fwt9BP;A6Fvt9BM;AACE;AACD;AACF;AAED;A7Fwt9BJ;AACA;A6Fxt9BI;AAEA;A7Fyt9BJ;A6Fxt9BI;A7F0t9BJ;A6Fxt9BI;AACE;AACuC;AAAc;AAEtD;AACC;AACD;A7F0t9BL;A6Fxt9BI;AACA;A7F0t9BJ;A6Fxt9BI;AACE;AAAc;AAA+B;AAC7C;AAAc;AAA4B;AAC1C;A7F8t9BN;A6Fvt9BM;AACD;A7Fyt9BL;A6Fxt9BI;AACD;AAED;A7Fyt9BF;AACA;AACA;AACA;AACA;A6F3t9BI;AACE;AACD;A7F6t9BL;A6F5t9BI;AACE;AACD;A7F8t9BL;A6F7t9BI;AACD;AAED;A7F8t9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F9t9BI;AACA;AACA;AACD;AAED;A7F+t9BF;AACA;AACA;A6F/t9BI;AACD;AAED;A7Fgu9BF;AACA;AACA;A6Fju9BwB;A7Fmu9BxB;A6Flu9BI;AACE;A7Fou9BN;A6Fhu9BM;AAEE;AAAY;A7Fku9BpB;A6F/t9BM;AAAkB;AACkB;AAAD;AADjB;AAGnB;AACF;AAED;A7Fku9BF;AACA;AACA;A6Fnu9BkB;A7Fqu9BlB;A6Fpu9BI;AACA;AACA;AACE;AACD;AACC;AACE;AAD8C;AAGjD;AACF;AAED;A7Fqu9BF;AACA;AACA;A6Ftu9BgC;A7Fwu9BhC;A6Fxu9BgC;AAAtB;AAAsB;A7F4u9BhC;A6F3u9BI;AACE;A7F6u9BN;A6Fzu9BM;AACA;A7F2u9BN;A6F1u9BM;A7F4u9BN;A6Fvu9BM;AAAkB;AACkB;AAAD;AADjB;AAGnB;AACF;AAED;A7F0u9BF;AACA;AACA;A6F3u9BQ;A7F6u9BR;A6F5u9BI;AAAkB;AAEd;AADuC;AADzB;AAKnB;AAED;A7F6u9BF;AACA;AACA;AACA;AACA;AACA;A6F9u9BqB;A7Fgv9BrB;A6F/u9BI;AACA;AACA;AACE;AACD;AACF;AAED;A7Fgv9BF;AACA;AACA;A6Fhv9BI;AACA;AAIA;AACA;AACA;AACA;A7F+u9BJ;A6F7u9BI;AACE;AACA;AACA;AACA;AACiC;AAAD;AAEjC;A7F+u9BL;A6F7u9BI;AACE;AACA;AACD;AACC;AACA;AACD;AACC;AACA;AACD;A7F+u9BL;AACA;A6F7u9BI;AACE;AACD;A7F+u9BL;A6F9u9BI;AACA;A7Fgv9BJ;A6F7u9BI;AACE;AACiC;AAAD;AAEjC;AAGD;A7F6u9BJ;AACA;A6F7u9BI;AACE;AACD;A7F+u9BL;A6F7u9BI;AACE;AACD;AACF;AAED;A7F8u9BF;AACA;AACA;A6F9u9BI;AACE;AACD;A7Fgv9BL;A6F/u9BI;AACD;AAED;A7Fgv9BF;AACA;AACA;A6Fhv9BI;AAID;AAED;A7F8u9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F9u9BI;AACE;AACD;A7Fgv9BL;A6F/u9BI;AACD;AAED;A7Fgv9BF;AACA;AACA;AACA;AACA;AACA;A6Fhv9BI;AACA;AAFM;AAAA;AAIN;AACA;AAAsB;AAAS;AAAS;AAAnB;AACrB;AACD;AAED;A7Fsv9BF;AACA;AACA;AACA;AACA;AACA;A6Fvv9Be;A7Fyv9Bf;A6Fxv9BI;A7F0v9BJ;A6Fzv9BI;AACE;AACD;A7F2v9BL;A6F1v9BI;AACA;AACA;AACA;AACE;AACD;AACF;AAED;A7F2v9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F3v9BI;A7F6v9BJ;A6F5v9BI;AACE;AACD;A7F8v9BL;A6F7v9BI;AACA;AACA;A7F+v9BJ;A6F9v9BI;AACE;AACA;AACA;AACD;A7Fgw9BL;A6F/v9BI;AACE;AAAiC;AAChC;AAAD;AAEF;AACD;AAED;A7Fiw9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Flw9BgC;A7Fow9BhC;A6Fnw9BI;AACA;AACE;AACA;AACA;AACA;AACA;AACA;A7Fqw9BN;A6Fpw9BM;AACE;AACA;AACA;AACD;AACC;AACD;A7Fsw9BP;A6Frw9BM;A7Fuw9BN;A6Ftw9BM;AACD;AACF;AAED;A7Fuw9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fvw9BI;A7Fyw9BJ;A6Fxw9BI;AACE;AACD;A7F0w9BL;A6Fzw9BI;AACA;AACA;AACA;AACE;AAAiC;AAChC;AAAD;AAEF;AACD;AAED;A7F2w9BF;AACA;AACA;AACA;AACA;AACA;A6F3w9BI;AACA;A7F6w9BJ;A6Fzw9BI;AACE;AAOA;A7Fqw9BN;A6Fpw9BM;AACE;AACD;AACF;AACF;AAED;A7Fqw9BF;AACA;AACA;A6Ftw9BgB;AAEZ;A7Fuw9BJ;A6Ftw9BI;AACA;AACD;AAED;A7Fuw9BF;AACA;AACA;A6Fvw9BI;AAAqB;AAAD;AACrB;AAED;A7F0w9BF;AACA;AACA;AACA;AACA;AACA;AACA;A6F1w9BI;AAAmB;AAA4B;AAK/C;AAAO;AAAiC;AAIrC;AAAD;AAJF;AAMD;A7F0w9BH;AACA;AACA;A6Fzw9BA;A7F2w9BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F/w9BE;A7Fix9BF;AACA;AACA;A6F/w9BE;AAAyB;A7Fkx9B3B;A6Fjx9BI;AACA;AAEA;A7Fkx9BJ;A6Fjx9BI;AAEA;A7Fkx9BJ;A6Fjx9BI;AAEA;A7Fkx9BJ;A6Fjx9BI;AAEA;A7Fkx9BJ;A6Fjx9BI;AAEM;AAAA;AAEP;AAED;A7Fix9BF;AACA;AACA;AACA;AACA;A6Fnx9BI;AACA;AACD;AAED;A7Fox9BF;AACA;AACA;A6Fpx9BI;AACD;AAED;A7Fqx9BF;AACA;AACA;A6Frx9BI;AACD;AAED;A7Fsx9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Ftx9BI;AACE;AAAO;AAAiC;AAAxC;AACD;AACC;AAMD;A7Fsx9BL;A6Frx9BI;AACD;AAED;A7Fsx9BF;AACA;AACA;AACA;AACA;AACA;A6Ftx9BI;AACD;AAED;A7Fux9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fxx9BwB;A7F0x9BxB;A6Fzx9BI;AAAgB;AAA4B;AACzC;AAAD;AAGF;AACA;AAGI;AAAsB;AAAiC;A7F4x9B/D;A6F3x9BQ;A7F6x9BR;A6F5x9BQ;A7F8x9BR;A6F7x9BQ;AACD;AACJ;AAED;A7F8x9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F/x9BkB;A7Fiy9BlB;A6Fhy9BI;AACE;AACD;A7Fky9BL;A6Fjy9BI;AAAsB;AAAD;AACrB;AACA;AAGI;AAAsB;AAAiC;AACrD;AAD0D;A7Fuy9BpE;A6Fpy9BQ;A7Fsy9BR;A6Fry9BQ;A7Fuy9BR;A6Fty9BQ;AACD;AACJ;AAED;A7Fuy9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fxy9B2B;A7F0y9B3B;A6Fzy9BI;AACE;AACE;AACA;AACA;AAAiB;AAAiC;AAChD;AADqD;AAGvD;AACD;A7F6y9BP;AACA;A6F3y9BM;AACA;AACD;A7F6y9BL;A6F3y9BI;AAAgB;AAA4B;AACzC;AAAD;AAGF;AACA;AAC8C;AAAmB;AAE7D;AAAsB;AAAiC;A7Fgz9B/D;A6F/y9BQ;A7Fiz9BR;A6Fhz9BQ;A7Fkz9BR;A6Fjz9BQ;AACD;AACJ;AAED;A7Fkz9BF;AACA;AACA;AACA;AACA;AACA;A6Flz9BI;AACA;AACE;AAAiC;AAC/B;AACA;AACA;AACA;AAJ+B;AAOpC;AAED;A7Fmz9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fnz9BI;AACE;AACD;A7Fqz9BL;A6Fpz9BI;AACE;AAAyB;AAAiC;AAC3D;AACC;AACD;AACF;AAED;A7Fuz9BF;AACA;AACA;AACA;AACA;AACA;A6Fxz9B6B;A7F0z9B7B;A6Fxz9BI;AACE;AACA;A7F0z9BN;A6Fzz9BM;AACE;AACD;AACF;AACF;AAED;A7F0z9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F1z9BI;AACE;AACD;A7F4z9BL;A6F3z9BI;AAII;AAAmB;AAGnB;AACE;AACD;A7Fyz9BT;A6Fxz9BQ;AACA;A7F0z9BR;A6Fzz9BQ;AACE;AACD;A7F2z9BT;A6F1z9BQ;AACD;AACJ;AAED;A7F2z9BF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6F3z9BI;AACE;AACD;A7F6z9BL;A6F5z9BI;AAAO;AAAyB;AAExB;AAAD;AACL;AAAmB;AAHrB;AAKD;A7Fi09BH;AACA;AACA;A6Fh09BA;A7Fk09BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Fp09BA;AACE;A7Fs09BF;A6Fr09BE;A7Fu09BF;A6Ft09BE;AAKE;AACD;AACC;AACA;AACA;AAKA;AACD;A7Fg09BH;A6F/z9BE;AACD;AAED;A7Fg09BA;AACA;AACA;AACA;A6Fh09BO;AACL;AACD;A7Fk09BD;AACA;AACA;AACA;AACA;AACA;AACA;A8Ft7/BA;A9Fw7/BA;A8Fv7/BA;A9Fy7/BA;A8F18/BA;A9F48/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Ft8/BA;AAEA;A9Fu8/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Ft8/BO;AACL;A9Fw8/BF;A8Fv8/BE;AACE;AACD;A9Fy8/BH;AACA;A8Fv8/BE;AACE;AACA;AACA;A9Fy8/BJ;A8Fx8/BI;AACE;AACA;A9F08/BN;A8Fz8/BM;AACE;AACA;A9F28/BR;A8F18/BQ;AACE;AACD;AACF;AACF;AACF;AACF;AAED;A9F28/BA;AACA;AACA;AACA;AACA;AACA;A8F38/BA;AACE;AACA;AACA;AACA;AACA;AACqB;AAAO;AACF;AAAO;A9F+8/BnC;A8F98/BE;AACE;AACD;AACC;A9Fg9/BJ;A8F98/BI;AACD;AACF;A9Fg9/BD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+FlhgCA;A/FohgCA;A+FnhgCA;A/FqhgCA;A+FphgCA;A/FshgCA;A+FrhgCA;A/FuhgCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+FjigCA;AACA;A/FmigCA;AACA;AACA;AACA;A+FnigCE;A/FqigCF;AACA;A+FnigCE;AACE;AACA;AACA;A/FqigCJ;A+FpigCI;AACA;A/FsigCJ;A+FrigCI;AACA;A/FuigCJ;A+FtigCI;AACA;A/FwigCJ;A+FvigCI;AACA;A/FyigCJ;A+FxigCI;AACA;A/F0igCJ;A+FzigCI;AAEA;A/F0igCJ;A+FzigCI;AACA;A/F2igCJ;A+F1igCI;AACA;AAEA;A/F2igCJ;A+F1igCI;AACA;AACD;AAED;A/F2igCF;AACA;AACA;AACA;AACA;AACA;AACA;A+F7igCI;AACE;AACD;A/F+igCL;AACA;A+F9igCI;AACE;AACD;AACF;AAED;A/F+igCF;AACA;AACA;AACA;AACA;A+F/igCI;AACE;AACD;A/FijgCL;A+FhjgCI;AACA;AACA;A/FkjgCJ;A+FjjgCI;AACE;AACA;AACD;A/FmjgCL;AACA;A+FjjgCI;AACE;AACA;AACA;A/FmjgCN;A+FjjgCM;A/FmjgCN;A+FljgCM;AACE;AACA;A/FojgCR;A+FljgCQ;AACA;AACA;AACD;A/FojgCP;A+FnjgCM;A/FqjgCN;A+FpjgCM;AACE;A/FsjgCR;A+F/igCQ;AACD;A/FijgCP;A+FhjgCM;A/FkjgCN;A+FjjgCM;AACE;AACD;AACF;AACF;AAED;A/FkjgCF;AACA;AACA;AACA;AACA;AACA;AACA;A+FljgCI;AAMD;AAED;A/F8igCF;AACA;AACA;AACA;AACA;AACA;A+F9igCI;AACA;AAEA;AAGA;AACD;AAED;A/F4igCF;AACA;AACA;AACA;AACA;AACA;AACA;A+F5igCI;AAGD;AAED;A/F2igCF;AACA;AACA;AACA;AACA;A+F5igCgC;A/F8igChC;A+F7igCI;AACE;AACD;A/F+igCL;A+F9igCI;AACE;A/FgjgCN;A+F/igCM;AACE;AACE;AACA;AACA;A/FijgCV;A+FhjgCU;AACE;AACA;AAID;AACC;AACA;AACD;AACF;AACF;AACF;AACD;AAAgC;AAAD;AAChC;AAED;A/FgjgCF;AACA;AACA;AACA;AACA;A+FjjgC8B;A/FmjgC9B;A+FljgCI;AACE;AACE;AACA;AACD;AACF;AACF;A/FojgCH;AACA;AACA;A+FnjgCA;A/FqjgCA;AACA;AACA;AACA;AACA;AACA;AACA;A+FvjgCA;AACE;AACD;AAED;A/FwjgCA;AACA;AACA;AACA;AACA;A+FxjgCO;AACL;AAKD;AAED;A/FqjgCA;AACA;AACA;AACA;AACA;A+FrjgCA;AACE;AACA;AACD;A/FujgCD;AACA;AACA;AACA;AACA;AACA;AACA;AgG9xgCA;AhGgygCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgG9xgCA;AhGgygCA;AgG/xgCA;AhGiygCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgGrygCE;AhGuygCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgGpygCE;AhGsygCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgGrygCE;AhGuygCF;AACA;AACA;AACA;AACA;AACA;AgGtygCE;AhGwygCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgGvygCE;AhGyygCF;AACA;AACA;AACA;AACA;AACA;AACA;AgGxygCE;AhG0ygCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgGzygCE;AhG2ygCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgG1ygCE;AhG4ygCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgG9ygCA;AhGgzgCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGj6gCA;AjGm6gCA;AiGl6gCA;AjGo6gCA;AiG95gCA;AjGg6gCA;AiG/5gCA;AjGi6gCA;AiGh6gCA;AjGk6gCA;AiGj6gCA;AjGm6gCA;AiGl6gCA;AjGo6gCA;AiGn6gCA;AjGq6gCA;AiGj6gCA;AjGm6gCA;AiGl6gCA;AjGo6gCA;AACA;AACA;AiGv8gCA;AjGy8gCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGn7gCA;AACA;AjGq7gCA;AiGp7gCA;AACA;AjGs7gCA;AiGr7gCA;AACA;AAEA;AjGs7gCA;AiGr7gCA;AAEA;AjGs7gCA;AACA;AACA;AACA;AiGr7gCA;AAEA;AjGs7gCA;AACA;AACA;AACA;AiGr7gCO;AACL;AACA;AAFsB;AAKxB;AjGs7gCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGv7gCO;AACL;AAIE;AAAsB;AAEzB;AAED;AjGq7gCA;AACA;AACA;AACA;AACA;AACA;AiGr7gCO;AACL;AACD;AAED;AjGs7gCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGx7gCE;AjG07gCF;AACA;AACA;AiGx7gCE;AAAkC;AjG27gCpC;AiG17gCI;AjG47gCJ;AiG17gCI;AACA;AAEA;AjG27gCJ;AiG17gCI;AAEA;AjG27gCJ;AiG17gCI;AAEA;AjG27gCJ;AiG17gCI;AAEA;AjG27gCJ;AiG17gCI;AAEA;AjG27gCJ;AiG17gCI;AAEA;AjG27gCJ;AiG17gCI;AAEA;AjG27gCJ;AiG17gCI;AAGA;AjG07gCJ;AiGz7gCI;AAGA;AjGy7gCJ;AiGx7gCI;AAEA;AjGy7gCJ;AACA;AACA;AACA;AiGx7gCI;AACE;AAAqC;AAKvC;AjGu7gCJ;AiGt7gCI;AACA;AACA;AACA;AjGw7gCJ;AiGv7gCI;AACA;AACE;AACD;AAED;AjGw7gCJ;AACA;AACA;AACA;AiGv7gCI;AAEA;AjGw7gCJ;AACA;AACA;AACA;AACA;AiGv7gCI;AAEA;AjGw7gCJ;AACA;AACA;AACA;AACA;AiGv7gCI;AACD;AAED;AjGw7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGx7gCI;AAGE;AAAc;AAEjB;AAED;AjGu7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AiGv7gCI;AAKD;AAED;AjGo7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AiGt7gCI;AACE;AACA;AAID;AACF;AAED;AjGo7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGp7gCI;AAEA;AACA;AACA;AACA;AjGq7gCJ;AiGp7gCI;AACE;AACD;AjGs7gCL;AiGp7gCI;AjGs7gCJ;AiGp7gCI;AACE;AACD;AACF;AAED;AjGq7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGj7gCI;AAAA;AAAA;AAAA;AAAA;AjGu7gCJ;AiGt7gCI;AjGw7gCJ;AiGv7gCI;AjGy7gCJ;AiGx7gCI;AACE;AACA;AACD;AjG07gCL;AiGx7gCI;AjG07gCJ;AiGp7gCI;AAGA;AACA;AjGo7gCJ;AiGn7gCI;AACE;AACA;AACD;AAGD;AjGm7gCJ;AACA;AiGn7gCI;AACE;AACE;AACD;AjGq7gCP;AiGp7gCM;AACE;AACE;AACD;AACF;AACF;AjGs7gCL;AACA;AiGp7gCI;AACD;AAED;AjGq7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGr7gCI;AACE;AAGI;AACA;AAFG;AAKP;AACD;AjGo7gCL;AiGn7gCI;AACD;AAED;AjGo7gCF;AACA;AACA;AACA;AACA;AACA;AiGp7gCI;AjGs7gCJ;AiGn7gCI;AACE;AAGQ;AAAA;AACT;AjGo7gCL;AiGn7gCI;AACD;AAED;AjGo7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGp7gCI;AACE;AACD;AjGs7gCL;AiGr7gCI;AAGA;AjGq7gCJ;AiGp7gCI;AACE;AACD;AjGs7gCL;AiGp7gCI;AACE;AACD;AACC;AACD;AACF;AAED;AjGq7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AiGr7gCI;AAEA;AjGs7gCJ;AiGn7gCI;AACE;AACD;AjGq7gCL;AACA;AiGn7gCI;AACE;AACD;AAGD;AjGm7gCJ;AACA;AiGn7gCI;AAEA;AACA;AACA;AjGo7gCJ;AiGl7gCI;AACE;AACA;AACA;AACD;AjGo7gCL;AACA;AiGl7gCI;AACD;AAED;AjGm7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AiGn7gCI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;AAED;AjGo7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AiGp7gCI;AACE;AACD;AACF;AAED;AjGq7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AiGr7gCI;AACE;AACD;AACD;AACD;AAED;AjGs7gCF;AACA;AACA;AACA;AACA;AACA;AiGt7gCI;AACA;AjGw7gCJ;AiGv7gCI;AACE;AACA;AACD;AjGy7gCL;AiGv7gCI;AjGy7gCJ;AiGx7gCI;AACD;AAED;AjGy7gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGz7gCI;AACA;AACE;AACD;AAED;AjG07gCJ;AACA;AiG17gCI;AACA;AAR8C;AAY9C;AACA;AjG07gCJ;AiGz7gCI;AjG27gCJ;AiGx7gCI;AACE;AACA;AACA;AACD;AjG07gCL;AiGx7gCI;AjG07gCJ;AiGz7gCI;AACE;AAEA;AjG07gCN;AiGz7gCM;AACA;AACD;AjG27gCL;AiGz7gCI;AACD;AAED;AjG07gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiG17gCI;AACE;AACD;AjG47gCL;AiG37gCI;AAGQ;AAAA;AjG47gCZ;AiG37gCI;AACE;AACD;AjG67gCL;AACA;AiG57gCI;AACE;AACA;AACD;AjG87gCL;AiG77gCI;AACD;AAED;AjG87gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiG97gCI;AACA;AAGA;AACA;AjG87gCJ;AiG77gCI;AACE;AACE;AACA;AACA;AjG+7gCR;AiG97gCQ;AACE;AACD;AjGg8gCT;AiG/7gCQ;AACD;AAGD;AACA;AACA;AACA;AACA;AjG+7gCN;AACA;AiG/7gCM;AACE;AACA;AjGi8gCR;AiGh8gCQ;AACE;AAGE;AACD;AjGg8gCX;AiG/7gCU;AACD;AACF;AjGi8gCP;AiGh8gCM;AACD;AjGk8gCL;AiGh8gCI;AACD;AAED;AjGi8gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGl8gC+C;AjGo8gC/C;AiGn8gCI;AACA;AACA;AACA;AAGA;AjGm8gCJ;AiGl8gCI;AACE;AACD;AjGo8gCL;AACA;AiGl8gCI;AACA;AjGo8gCJ;AiGn8gCI;AACE;AACA;AAGE;AACA;AAAe;AAAO;AACzB;AAGD;AjGm8gCJ;AACA;AiGn8gCI;AACE;AACE;AACD;AACF;AACC;AACA;AACD;AACF;AAED;AjGo8gCF;AACA;AACA;AACA;AACA;AACA;AiGp8gCI;AACD;AAED;AjGq8gCF;AACA;AACA;AACA;AACA;AACA;AiGr8gCI;AACD;AAED;AjGs8gCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiGv8gC+B;AjGy8gC/B;AiGx8gCI;AACA;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAe;AAAO;AjG48gC5B;AiG38gCM;AACE;AAAqB;AAAO;AAA5B;AAGH;AACC;AAID;AACF;AAED;AjG08gCF;AACA;AACA;AACA;AACA;AACA;AACA;AiG18gCI;AACD;AjG48gCH;AACA;AACA;AiG38gCA;AjG68gCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiG/8gCA;AACE;AjGi9gCF;AiG78gCE;AACE;AACA;AACD;AjG+8gCH;AiG98gCE;AjGg9gCF;AiG98gCE;AACE;AACD;AjGg9gCH;AiG/8gCE;AACE;AACE;AACD;AACD;AACE;AACD;AANU;AjGw9gCf;AiGh9gCE;AAIE;AAAoB;AAClB;AACA;AACA;AACA;AACA;AALkB;AjGs9gCxB;AiG98gCE;AACE;AACA;AACA;AACE;AACD;AjGg9gCL;AiG/8gCI;AACD;AACF;AAED;AjGg9gCA;AACA;AACA;AACA;AACA;AACA;AiGh9gCA;AACE;AACD;AjGk9gCD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkG7qiCA;AlG+qiCA;AkG9qiCA;AlGgriCA;AkG/qiCA;AlGiriCA;AkGhriCA;AlGkriCA;AkGjriCA;AlGmriCA;AkGlriCA;AlGoriCA;AkG5siCA;AlG8siCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkG3siCA;AACA;AACA;AlG6siCA;AkGrsiCA;AlGusiCA;AACA;AACA;AkGrsiCA;AACE;AAAO;AAAiC;AAAxC;AAGD;AAED;AlGusiCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkGzsiCE;AlG2siCF;AACA;AkGzsiCE;AACE;AACA;AACD;AAED;AlG0siCF;AACA;AACA;AACA;AACA;AkG5siCI;AACD;AAED;AlG6siCF;AACA;AACA;AkG7siCI;AAEE;AAAa;AAGhB;AAED;AlG4siCF;AACA;AACA;AkG5siCI;AAEE;AAAa;AAGhB;AAED;AlG2siCF;AACA;AACA;AkG3siCI;AACA;AAEA;AACE;AACD;AACF;AAED;AlG2siCF;AACA;AACA;AkG3siCI;AACA;AAEA;AACE;AACD;AACF;AAED;AlG2siCF;AACA;AACA;AkG3siCI;AACA;AAEA;AACE;AACD;AACF;AAED;AlG2siCF;AACA;AACA;AkG3siCI;AAKD;AAED;AlGwsiCF;AACA;AACA;AkGzsiC6C;AlG2siC7C;AkG1siCI;AACA;AACE;AACE;AACD;AlG4siCP;AkG3siCM;AACE;AAEI;AlG4siCZ;AkG3siCY;AACE;AACD;AlG6siCb;AkG5siCY;AAEE;AAAa;AAEb;AAA2B;AlG8siCzC;AkG5siCY;AACD;AAEJ;AACC;AACD;AACF;AACD;AACD;AAED;AlG4siCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkG7siC+D;AlG+siC/D;AkG9siCI;AACE;AlGgtiCN;AkG/siCM;AACD;AACF;AAED;AlGgtiCF;AACA;AACA;AACA;AACA;AACA;AkGhtiCI;AACA;AACE;AlGktiCN;AkGhtiCM;AlGktiCN;AkGjtiCM;AACE;AACD;AACF;AACC;AACA;AlGmtiCN;AkGltiCM;AACE;AACA;AlGotiCR;AkGntiCQ;AACE;AACE;AACA;AACD;AACF;AlGqtiCT;AkGptiCQ;AACE;AACA;AACD;AACF;AACF;AACF;AAED;AlGqtiCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkGttiC+E;AlGwtiC/E;AkGvtiCI;AACE;AACE;AACE;AAKD;AACF;AACC;AAKD;AACF;AACF;AAED;AlGgtiCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkGhtiCI;AlGktiCJ;AkGjtiCI;AAIE;AAKD;AACF;AAED;AlG2siCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkGvsiCI;AACA;AACE;AACD;AACF;AlGysiCH;AACA;AACA;AkGxsiCA;AlG0siCA;AACA;AACA;AACA;AACA;AACA;AkG5siCO;AACL;AACD;AlG8siCD;AACA;AACA;AACA;AACA;AACA;AACA;AmGx9iCA;AnG09iCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmGx9iCA;AnG09iCA;AmGz9iCA;AnG29iCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmG/9iCE;AnGi+iCF;AACA;AACA;AACA;AACA;AACA;AACA;AmG99iCE;AnGg+iCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmG/9iCE;AnGi+iCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmGh+iCE;AnGk+iCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmGj+iCE;AnGm+iCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmGl+iCE;AnGo+iCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmGn+iCE;AnGq+iCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmGp+iCE;AnGs+iCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmGx+iCA;AnG0+iCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoGvkjCA;ApGykjCA;AoGzljCA;ApG2ljCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoGvljCA;ApGyljCA;AACA;AACA;AACA;AACA;AACA;AoGzljCE;ApG2ljCF;AACA;AoGzljCE;AACE;AACA;AAAkB;AAA2B;AAE7C;ApG4ljCJ;AoG3ljCI;AACD;AAED;ApG4ljCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoG9ljCI;AACD;AAED;ApG+ljCF;AACA;AACA;AACA;AACA;AACA;AoG/ljCI;AACD;AAED;ApGgmjCF;AACA;AACA;AACA;AACA;AACA;AoGhmjCI;AAQD;AAED;ApG0ljCF;AACA;AACA;AACA;AACA;AACA;AoG1ljCI;AACA;AAKD;AAED;ApGuljCF;AACA;AACA;AACA;AACA;AACA;AoGvljCI;AACD;AAED;ApGwljCF;AACA;AACA;AACA;AACA;AACA;AoGxljCI;AACA;AACA;AACA;AACD;AAED;ApGyljCF;AACA;AACA;AACA;AACA;AACA;AoGzljCI;AACD;AAED;ApG0ljCF;AACA;AACA;AACA;AACA;AACA;AoG1ljCI;AACD;AAED;ApG2ljCF;AACA;AACA;AACA;AACA;AACA;AoG3ljCI;AACD;AAED;ApG4ljCF;AACA;AACA;AACA;AACA;AACA;AoG5ljCI;AACD;AAED;ApG6ljCF;AACA;AACA;AACA;AACA;AACA;AoG7ljCI;AAKD;AAED;ApG0ljCF;AACA;AACA;AACA;AACA;AACA;AoG1ljCI;AACD;AAED;ApG2ljCF;AACA;AACA;AACA;AACA;AACA;AoG3ljCI;AACE;AAGD;ApG2ljCL;AoG1ljCI;AACE;AACD;ApG4ljCL;AoG3ljCI;AACE;AACD;ApG6ljCL;AoG5ljCI;AACE;AACD;ApG8ljCL;AoG7ljCI;AACE;AACD;ApG+ljCL;AoG9ljCI;AACE;AACD;ApGgmjCL;AoG/ljCI;AACD;AAED;ApGgmjCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoGhmjCI;AACE;AACD;ApGkmjCL;AoGjmjCI;ApGmmjCJ;AoGlmjCI;AACE;AACD;ApGomjCL;AoGnmjCI;AACD;AAED;ApGomjCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoGpmjCI;AACE;AACD;ApGsmjCL;AoGrmjCI;AACE;AACD;ApGumjCL;AoGtmjCI;ApGwmjCJ;AoGrmjCI;AACE;AACD;ApGumjCL;AoGtmjCI;AACA;AACD;AAED;ApGumjCF;AACA;AACA;AACA;AACA;AACA;AoGvmjCI;ApGymjCJ;AoGxmjCI;AACE;AACD;ApG0mjCL;AoGzmjCI;AACD;ApG2mjCH;AACA;AACA;AoG1mjCA;ApG4mjCA;AACA;AACA;AACA;AACA;AACA;AACA;AoG9mjCO;AACL;AACD;ApGgnjCD;AACA;AACA;AACA;AACA;AACA;AACA;AqGl1jCA;ArGo1jCA;AqGn1jCA;ArGq1jCA;AqGp1jCA;ArGs1jCA;AqGr1jCA;ArGu1jCA;AqGt1jCA;ArGw1jCA;AqGv1jCA;ArGy1jCA;AqGx1jCA;ArG01jCA;AqGp1jCA;ArGs1jCA;AqGr1jCA;ArGu1jCA;AqGp3jCA;ArGs3jCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqGp2jCA;AACA;AACA;AAEA;ArGq2jCA;AACA;AACA;AACA;AACA;AqGp2jCO;AACL;ArGs2jCF;AACA;AACA;AqGp2jCE;ArGs2jCF;AqGp2jCE;ArGs2jCF;AACA;AACA;AqGp2jCE;ArGs2jCF;AqGp2jCE;ArGs2jCF;AACA;AqGp2jCE;ArGs2jCF;AqGp2jCE;ArGs2jCF;AACA;AqGp2jCE;ArGs2jCF;AqGp2jCE;ArGs2jCF;AACA;AqGp2jCE;ArGs2jCF;AqGp2jCE;ArGs2jCF;AACA;AqGp2jCE;AA/B2B;AAkC7B;ArGq2jCA;AACA;AACA;AACA;AACA;AACA;AqGr2jCA;AAEA;ArGs2jCA;AACA;AACA;AACA;AACA;AACA;AACA;AqGv2jCE;ArGy2jCF;AACA;AACA;AACA;AqGv2jCI;AAAO;AAA0B;AAAjC;AAKD;AAED;ArGu2jCF;AACA;AACA;AACA;AACA;AACA;AqGv2jCI;AAAO;AAAyB;AAAhC;AACD;AAED;ArG22jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqG32jCI;ArG62jCJ;AqG52jCI;AACE;AACD;ArG82jCL;AqG72jCI;ArG+2jCJ;AqG52jCI;ArG82jCJ;AqG72jCI;AACE;ArG+2jCN;AqG92jCM;AACE;AACD;AACF;AACF;AAED;ArG+2jCF;AACA;AACA;AACA;AACA;AACA;AqG/2jCE;AACE;AAEA;ArGg3jCJ;AqG/2jCI;AAEA;ArGg3jCJ;AqG/2jCI;AAEA;ArGg3jCJ;AqG/2jCI;AAEA;ArGg3jCJ;AqG/2jCI;AAEA;ArGg3jCJ;AqG/2jCI;AAEA;ArGg3jCJ;AqG/2jCI;AAEA;ArGg3jCJ;AqG/2jCI;AAEA;ArGg3jCJ;AqG/2jCI;AAEA;ArGg3jCJ;AqG/2jCI;AAIA;ArG82jCJ;AqG72jCI;AAEA;ArG82jCJ;AqG72jCI;AAEA;ArG82jCJ;AqG72jCI;AAEA;ArG82jCJ;AqG72jCI;AAEA;ArG82jCJ;AqG72jCI;AAEA;ArG82jCJ;AqG72jCI;AAEA;ArG82jCJ;AqG72jCI;AAEA;ArG82jCJ;AACA;AACA;AACA;AACA;AqG72jCI;AAEA;ArG82jCJ;AqG72jCI;AAEA;ArG82jCJ;AACA;AACA;AACA;AqG72jCI;AAEA;ArG82jCJ;AqG72jCI;AAEA;AAEA;ArG62jCJ;AqG52jCI;AAEA;ArG62jCJ;AqG52jCI;AACD;AAED;ArG62jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqG/2jCI;AACD;AAED;ArGg3jCF;AACA;AACA;AACA;AACA;AACA;AqGh3jCI;AACD;AAED;ArGi3jCF;AACA;AACA;AACA;AACA;AACA;AqGj3jCI;AACE;AACE;AACE;AACA;AACD;AACF;ArGm3jCP;AqGl3jCM;AACE;AACD;AACF;ArGo3jCL;AqGn3jCI;AACD;AAED;ArGo3jCF;AACA;AACA;AACA;AACA;AACA;AqGp3jCI;AACD;AAED;ArGq3jCF;AACA;AACA;AACA;AACA;AACA;AqGr3jCI;AACE;AACD;ArGu3jCL;AqGt3jCI;AACD;AAED;ArGu3jCF;AACA;AACA;AACA;AACA;AACA;AqGv3jCI;AACD;AAED;ArGw3jCF;AACA;AACA;AACA;AACA;AACA;AqGx3jCI;AACD;AAED;ArGy3jCF;AACA;AACA;AACA;AACA;AACA;AqGz3jCI;AACD;AAED;ArG03jCF;AACA;AACA;AACA;AACA;AACA;AqG13jCI;AACD;AAED;ArG23jCF;AACA;AACA;AACA;AACA;AACA;AqG33jCI;AACA;AACD;AAED;ArG43jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqG73jCU;ArG+3jCV;AqG93jCI;AACE;AACD;ArGg4jCL;AqG/3jCI;AACA;AAEI;AACA;ArGg4jCR;AqG93jCQ;AACD;AAEC;ArG+3jCR;AqG93jCQ;ArGg4jCR;AqG/3jCQ;ArGi4jCR;AqGh4jCQ;AACD;AAEJ;AAED;ArGg4jCF;AACA;AACA;AACA;AACA;AACA;AqGh4jCI;AACE;AACD;AACF;AAED;ArGi4jCF;AACA;AACA;AACA;AACA;AqGj4jCI;AACD;AAED;ArGk4jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqGl4jCI;AAAa;AAAO;ArGs4jCxB;AqGn4jCI;AACD;AAED;ArGo4jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqG/3jCI;AACE;AACE;AACA;AACA;AAHwB;AAK3B;ArGi4jCL;AqGh4jCI;AAMD;AAED;ArG43jCF;AACA;AACA;AqG53jCI;AACD;AAED;ArG63jCF;AACA;AACA;AACA;AACA;AqG73jCI;AACD;AAED;ArG83jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqG93jCI;AACD;AAED;ArG+3jCF;AACA;AACA;AACA;AACA;AACA;AqG/3jCI;AACA;AACA;AACA;AACA;AACA;AACA;AAIE;AACA;AAGA;AACD;ArG43jCL;AqG13jCI;ArG43jCJ;AqGz3jCI;AACA;AACA;ArG23jCJ;AqGx3jCI;ArG03jCJ;AqGz3jCI;AAKE;AAME;AACD;AACF;ArGk3jCL;AqGh3jCI;AACE;AACD;ArGk3jCL;AqGh3jCI;AACD;AAED;ArGi3jCF;AACA;AACA;AqGj3jCI;ArGm3jCJ;AqGl3jCI;AACA;ArGo3jCJ;AqGj3jCI;ArGm3jCJ;AqGl3jCI;AAA4D;AAAA;ArGs3jChE;AqGt3jCgE;ArGw3jChE;AqGr3jCM;AAAiD;AAAO;AACtD;AACE;AACA;AACD;ArGy3jCT;AqGx3jCQ;AAIE;AACA;AACD;AACF;AACF;ArGu3jCL;AqGt3jCI;ArGw3jCJ;AqGt3jCI;AACE;AACA;AACA;AACA;AAKD;AACF;AAED;ArGm3jCF;AACA;AACA;AACA;AACA;AACA;AqGn3jCI;AACA;AAMA;AACA;AACA;ArGg3jCJ;AqG/2jCI;AACE;AACD;AACF;AAED;ArGg3jCF;AACA;AACA;AACA;AACA;AACA;AqGh3jCI;AACA;AACD;AAED;ArGi3jCF;AACA;AACA;AACA;AACA;AqGj3jCI;AACD;AAED;ArGk3jCF;AACA;AACA;AACA;AACA;AACA;AqGl3jCI;AACD;AAED;ArGm3jCF;AACA;AACA;AACA;AACA;AqGn3jCI;AACD;AAED;ArGo3jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqGp3jCI;AACE;AACD;ArGs3jCL;AqGr3jCI;ArGu3jCJ;AqGt3jCI;AAKD;AAED;ArGm3jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqGn3jCI;AACD;AAED;ArGo3jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqGr3jC0B;ArGu3jC1B;AqGt3jCI;AACE;AAAkB;AAAA;AACnB;ArG03jCL;AqGz3jCI;AACE;ArG23jCN;AqG13jCM;AACD;AACF;AAED;ArG23jCF;AACA;AACA;AACA;AACA;AACA;AqG33jCI;AACA;AACA;AACD;AAED;ArG43jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqG53jCI;ArG83jCJ;AACA;AqG73jCI;AACA;AACA;AAKD;AAED;ArG03jCF;AACA;AACA;AACA;AACA;AACA;AqG13jCI;AACD;AAED;ArG23jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqG33jCI;AACD;AAED;ArG43jCF;AACA;AACA;AACA;AACA;AACA;AqG53jCI;AACD;AAED;ArG63jCF;AACA;AACA;AACA;AACA;AACA;AqG73jCI;AACD;AAED;ArG83jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqG93jCI;ArGg4jCJ;AqG93jCI;AACE;AACD;ArGg4jCL;AACA;AqG/3jCI;AACA;ArGi4jCJ;AqGh4jCI;AACE;AACD;ArGk4jCL;AACA;AqGj4jCI;AACE;AACD;ArGm4jCL;AACA;AqGl4jCI;AACA;AACA;AACD;AAED;ArGm4jCF;AACA;AACA;AqGn4jCI;AACE;AACD;ArGq4jCL;AqGp4jCI;ArGs4jCJ;AqGr4jCI;AACE;AACE;AACA;AACD;AACF;AACF;AAED;ArGs4jCF;AACA;AACA;AqGt4jCI;AACA;AACA;ArGw4jCJ;AqGv4jCI;AACA;AACA;AACA;AACA;ArGy4jCJ;AqGv4jCI;AAIE;AACA;AACA;AAAQ;AAAD;AACR;ArGw4jCL;AqGt4jCI;AACE;AACA;ArGw4jCN;AqGr4jCM;AACE;AACD;AACF;AACC;AACA;ArGu4jCN;AqGp4jCM;AACE;AACD;AACF;AACC;AACA;AAAQ;AAAD;AACR;ArGw4jCL;AqGv4jCI;AAAQ;AAAU;AAAe;AAA1B;AACR;AAED;ArG44jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqG54jCI;AACE;AACD;ArG84jCL;AqGj5jCuD;AAAA;AAAA;AAAA;ArGs5jCvD;AqGh5jCI;AACE;AACD;ArGk5jCL;AqGj5jCI;AACD;AAED;ArGk5jCF;AACA;AACA;AACA;AACA;AACA;AqGl5jCI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAID;AAED;ArGg5jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqGh5jCI;AACD;AAED;ArGi5jCF;AACA;AACA;AACA;AACA;AACA;AqGj5jCI;AACA;AACD;AAED;ArGk5jCF;AACA;AACA;AACA;AACA;AqGl5jCI;AAGD;AAED;ArGi5jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqGl5jCgB;ArGo5jChB;AqGn5jCI;AACE;AACD;ArGq5jCL;AqGp5jCI;AACE;AACD;ArGs5jCL;AqGr5jCI;AACE;AACD;ArGu5jCL;AqGr5jCI;AAMA;ArGk5jCJ;AqG/4jCI;AACE;AAMA;AACA;AACD;ArG44jCL;AqG14jCI;AACA;AACA;AAEA;AACE;AACE;AACE;AACD;AACC;AACD;AACF;AACF;AAED;AACE;AAAA;AACM;AAAA;AAER;AACD;AAED;ArG04jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqG14jCI;AACE;AACA;AACD;ArG44jCL;AqG34jCI;AACA;AACA;AAGA;ArG24jCJ;AqG14jCI;AACE;AACD;AACC;AACA;AACD;AACF;AAED;ArG24jCF;AACA;AACA;AACA;AACA;AACA;AqG34jCI;AAID;AAED;ArGy4jCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqGz4jCI;AACD;AAED;ArG04jCF;AACA;AACA;AACA;AACA;AqG14jCI;AACD;AAED;ArG24jCF;AACA;AACA;AACA;AACA;AACA;AqG34jCI;ArG64jCJ;AqG54jCI;AACE;AACD;ArG84jCL;AqG74jCI;AACD;AAED;ArG84jCF;AACA;AACA;AACA;AACA;AACA;AqG94jCI;AACD;AAED;ArG+4jCF;AACA;AACA;AACA;AACA;AACA;AqG/4jCI;AAIE;AACD;ArG84jCL;AqG74jCI;ArG+4jCJ;AqG94jCI;AACE;AACA;AACA;AACA;AACD;AACF;AAED;ArG+4jCF;AACA;AACA;AACA;AACA;AACA;AACA;AqG/4jCI;AACD;AAED;ArGg5jCF;AACA;AACA;AACA;AACA;AqGh5jCI;ArGk5jCJ;AqGj5jCI;AACE;AACD;AACF;AAED;ArGk5jCF;AACA;AACA;AACA;AACA;AqGl5jCI;AACD;AAED;ArGm5jCF;AACA;AACA;AACA;AACA;AqGn5jCI;AACD;AAED;ArGo5jCF;AACA;AACA;AACA;AACA;AqGp5jCI;AACA;AACD;AAED;ArGq5jCF;AACA;AACA;AACA;AACA;AACA;AqGr5jCI;AACA;AAAwB;AAA8B;AACvD;ArGy5jCH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGt4lCA;AtGw4lCA;AsGv4lCA;AtGy4lCA;AsGx4lCA;AtG04lCA;AsGz4lCA;AtG24lCA;AsG14lCA;AtG44lCA;AsG34lCA;AtG64lCA;AsG54lCA;AtG84lCA;AsG74lCA;AtG+4lCA;AsG94lCA;AtGg5lCA;AsG/4lCA;AtGi5lCA;AsGh5lCA;AtGk5lCA;AsGj5lCA;AtGm5lCA;AsGl5lCA;AtGo5lCA;AsGn5lCA;AtGq5lCA;AsGp5lCA;AtGs5lCA;AsGr5lCA;AtGu5lCA;AsGt5lCA;AtGw5lCA;AsGv5lCA;AtGy5lCA;AsGx5lCA;AtG05lCA;AsGz5lCA;AtG25lCA;AsG15lCA;AtG45lCA;AsG35lCA;AtG65lCA;AsGl8lCA;AtGo8lCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsG16lCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AtG46lCA;AsG36lCA;AAEA;AtG46lCA;AACA;AACA;AACA;AACA;AACA;AACA;AsG36lCA;AAEA;AtG46lCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsG36lCA;AAEA;AtG46lCA;AACA;AACA;AACA;AACA;AACA;AsG76lCE;AtG+6lCF;AACA;AsG76lCE;AAAoB;AtGg7lCtB;AsG/6lCI;AACA;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AACA;AACA;AACA;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AACA;AACA;AACA;AACA;AsG/6lCI;AAEA;AtGg7lCJ;AACA;AACA;AACA;AsG/6lCI;AAEA;AtGg7lCJ;AACA;AACA;AACA;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AACA;AACA;AACA;AACA;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAEA;AtGg7lCJ;AsG/6lCI;AAAgC;AAAA;AAEhC;AtGk7lCJ;AsGj7lCI;AACE;AtGm7lCN;AsGl7lCM;AACD;AAED;AtGm7lCJ;AsGl7lCI;AAEA;AtGm7lCJ;AsGl7lCI;AAEA;AtGm7lCJ;AsGl7lCI;AAEA;AtGm7lCJ;AACA;AACA;AsGl7lCI;AAEA;AtGm7lCJ;AsGl7lCI;AAEA;AtGm7lCJ;AsGl7lCI;AAEA;AtGm7lCJ;AsGl7lCI;AAEA;AtGm7lCJ;AsGl7lCI;AAAuB;AAAO;AAE9B;AtGq7lCJ;AsGp7lCI;AAEA;AtGq7lCJ;AsGp7lCI;AAEA;AtGq7lCJ;AsGp7lCI;AAEA;AtGq7lCJ;AsGp7lCI;AAEA;AtGq7lCJ;AsGp7lCI;AAEA;AtGq7lCJ;AsGp7lCI;AAEA;AtGq7lCJ;AsGp7lCI;AtGs7lCJ;AsGj7lCI;AACE;AACA;AtGm7lCN;AsGl7lCM;AACE;AACA;AACD;AtGo7lCP;AsGn7lCM;AACD;AACD;AACE;AACD;AAGD;AtGm7lCJ;AsGl7lCI;AACE;AACE;AACD;AtGo7lCP;AsGn7lCM;AACD;AAED;AACE;AACA;AtGo7lCN;AsGn7lCM;AACD;AAED;AACE;AACD;AAGD;AtGk7lCJ;AsGj7lCI;AACE;AtGm7lCN;AsGl7lCM;AACD;AAED;AACD;AAED;AtGk7lCF;AACA;AACA;AACA;AACA;AsGr7lCyB;AtGu7lCzB;AsGt7lCI;AACA;AACE;AtGw7lCN;AsGv7lCM;AtGy7lCN;AsGx7lCM;AACA;AtG07lCN;AsGz7lCM;AAAkB;AAAA;AtG67lCxB;AsG57lCM;AACE;AACD;AACC;AACA;AACD;AtG87lCP;AsG77lCM;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AtG67lCN;AACA;AsG77lCM;AtG+7lCN;AsGz7lCM;AAIE;AACD;AACF;AACF;AAED;AtGu7lCF;AACA;AACA;AsGv7lCI;AACD;AAED;AtGw7lCF;AACA;AACA;AsGx7lCI;AACD;AAED;AtGy7lCF;AACA;AACA;AsG17lCkB;AtG47lClB;AsG37lCI;AtG67lCJ;AsG57lCI;AACE;AACD;AACD;AACE;AACD;AACD;AACE;AACD;AACF;AAED;AtG67lCF;AACA;AACA;AACA;AACA;AACA;AACA;AsG97lC+B;AtGg8lC/B;AsG/7lCI;AACE;AACE;AACD;AACF;AACF;AAED;AtGg8lCF;AACA;AACA;AsGh8lCI;AACD;AAED;AtGi8lCF;AACA;AACA;AsGj8lCI;AACD;AAED;AtGk8lCF;AACA;AACA;AsGl8lCI;AACD;AAED;AtGm8lCF;AACA;AACA;AsGn8lCI;AACA;AtGq8lCJ;AsGp8lCI;AACE;AACD;AAGD;AtGo8lCJ;AACA;AsGp8lCI;AtGs8lCJ;AsGr8lCI;AAKE;AACA;AACD;AACC;AACA;AACA;AACD;AtGm8lCL;AsGl8lCI;AACA;AACD;AAED;AtGm8lCF;AACA;AACA;AACA;AACA;AACA;AACA;AsGn8lCI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;AAED;AtGo8lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGh8lCI;AAHA;AAGA;AtGo8lCJ;AsGp8lCI;AAFA;AAEA;AtGw8lCJ;AsGx8lCI;AADA;AACA;AtG48lCJ;AsG38lCI;AAGA;AACA;AtG28lCJ;AsG18lCI;AtG48lCJ;AsGx8lCI;AACE;AACE;AACA;AACD;AACC;AACE;AACA;AACA;AACD;AACF;AACF;AACF;AAED;AtGy8lCF;AACA;AACA;AACA;AACA;AACA;AACA;AsG18lCiD;AAA1B;AAA0B;AtG88lCjD;AsG78lCI;AACA;AACA;AACE;AACD;AtG+8lCL;AsG98lCI;AACE;AACA;AACD;AACC;AACD;AACF;AAED;AtG+8lCF;AACA;AACA;AACA;AACA;AACA;AsGh9lCuD;AAA1B;AAA0B;AtGo9lCvD;AsGn9lCI;AACA;AACA;AACA;AACE;AtGq9lCN;AsGp9lCM;AAIE;AACA;AACA;AACA;AACD;AACF;AACF;AAED;AtGk9lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGn9lC8D;AtGq9lC9D;AsGr9lC8D;AAAf;AAAe;AtGy9lC9D;AsGx9lCI;AAKE;AACD;AtGs9lCL;AsGr9lCI;AtGu9lCJ;AsGt9lCI;AACE;AACD;AtGw9lCL;AsGv9lCI;AtGy9lCJ;AsGx9lCI;AACE;AACD;AtG09lCL;AsGz9lCI;AACE;AAAA;AAEE;AACA;AACA;AtG29lCR;AsG19lCQ;AACE;AACD;AACF;AAEJ;AAED;AtG09lCF;AACA;AACA;AsG19lCI;AtG49lCJ;AsG39lCI;AACE;AACD;AtG69lCL;AsG59lCI;AACD;AAED;AtG69lCF;AACA;AACA;AACA;AACA;AACA;AsG79lCI;AtG+9lCJ;AsG99lCI;AACE;AACD;AtGg+lCL;AsG/9lCI;AACE;AACD;AtGi+lCL;AsGh+lCI;AAA6B;AAAwB;AACrD;AACD;AAED;AtGm+lCF;AACA;AACA;AsGn+lCI;AtGq+lCJ;AsGp+lCI;AACA;AACD;AAED;AtGq+lCF;AACA;AACA;AsGr+lCI;AtGu+lCJ;AsGr+lCI;AtGu+lCJ;AsGp+lCI;AACE;AACE;AACD;AACF;AAED;AACD;AAED;AtGo+lCF;AACA;AACA;AsGp+lCI;AAKE;AAAY;AACZ;AAAY;AAGf;AAED;AtGi+lCF;AACA;AACA;AsGl+lC6E;AtGo+lC7E;AsGn+lCI;AACE;AAME;AAAY;AAEV;AACE;AACD;AACC;AACD;AACF;AAEJ;AACF;AAED;AtG89lCF;AACA;AACA;AsG99lCI;AACD;AAED;AtG+9lCF;AACA;AACA;AsG/9lCI;AACD;AAED;AtGg+lCF;AACA;AACA;AsGh+lCI;AACD;AAED;AtGi+lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGl+lC6D;AtGo+lC7D;AsGn+lCI;AACE;AtGq+lCN;AsGp+lCM;AACE;AACD;AtGs+lCP;AsGr+lCM;AACD;AtGu+lCL;AsGt+lCI;AtGw+lCJ;AsGt+lCI;AACE;AACE;AACE;AACD;AtGw+lCT;AsGv+lCQ;AACD;AACD;AACE;AtGy+lCR;AsGv+lCQ;AACE;AtGy+lCV;AsGx+lCU;AACD;AtG0+lCT;AsGz+lCQ;AtG2+lCR;AsG1+lCQ;AACE;AtG4+lCV;AsG3+lCU;AACD;AtG6+lCT;AsG5+lCQ;AACE;AACD;AtG8+lCT;AsG7+lCQ;AAGA;AtG6+lCR;AACA;AsG7+lCQ;AACE;AtG++lCV;AsG9+lCU;AACE;AtGg/lCZ;AsG/+lCY;AACD;AtGi/lCX;AsGh/lCU;AACD;AACF;AAlC2B;AAoC/B;AAED;AtGi/lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGj/lCI;AACA;AtGm/lCJ;AsGl/lCI;AACE;AtGo/lCN;AsGn/lCM;AACD;AACC;AACD;AtGq/lCL;AsGp/lCI;AACD;AAED;AtGq/lCF;AACA;AACA;AsGt/lC2B;AtGw/lC3B;AsGv/lCI;AACE;AAIE;AAAgB;AAChB;AAAY;AACZ;AAAY;AAEV;AACE;AtGw/lCZ;AsGv/lCY;AACA;AACD;AACC;AACD;AACF;AAEJ;AACF;AAED;AtGu/lCF;AACA;AACA;AsGv/lCI;AtGy/lCJ;AsGx/lCI;AtG0/lCJ;AsGz/lCI;AACE;AACE;AACD;AACC;AACD;AACF;AtG2/lCL;AsG1/lCI;AACA;AACD;AAED;AtG2/lCF;AACA;AACA;AsG3/lCI;AtG6/lCJ;AsG5/lCI;AAEA;AtG6/lCJ;AsG5/lCI;AACE;AACD;AtG8/lCL;AsG5/lCI;AACD;AAED;AtG6/lCF;AACA;AACA;AsG7/lCI;AACE;AACD;AtG+/lCL;AsG9/lCI;AACD;AAED;AtG+/lCF;AACA;AACA;AACA;AACA;AACA;AsGhgmCuB;AtGkgmCvB;AsGjgmCI;AACE;AACD;AtGmgmCL;AsGlgmCI;AACA;AAAmB;AAAA;AACpB;AAED;AtGqgmCF;AACA;AACA;AsGrgmCI;AACA;AACD;AAED;AtGsgmCF;AACA;AACA;AsGtgmCI;AACD;AAED;AtGugmCF;AACA;AACA;AACA;AACA;AACA;AACA;AsGxgmCW;AtG0gmCX;AsGzgmCI;AACE;AACA;AACD;AtG2gmCL;AsGzgmCI;AACA;AAEA;AtG0gmCJ;AsGxgmCI;AACE;AACA;AtG0gmCN;AsGzgmCM;AtG2gmCN;AsG1gmCM;AAGI;AACA;AACA;AACA;AACA;AALG;AAOL;AAAmB;AAGrB;AACA;AAEQ;AAAD;AACL;AAAmB;AAErB;AACD;AtGygmCL;AsGvgmCI;AACA;AAcA;AACA;AAEA;AtG2/lCJ;AsG1/lCI;AAKE;AACA;AACA;AACA;AACA;AACA;AACD;AtGw/lCL;AsGt/lCI;AACE;AACA;AACE;AtGw/lCR;AsGv/lCQ;AACE;AAEQ;AAAD;AACL;AAAmB;AtG0/lC/B;AsGx/lCU;AACA;AtG0/lCV;AsGz/lCU;AACD;AACF;AACF;AtG2/lCL;AsGz/lCI;AACE;AACA;AACD;AtG2/lCL;AsG1/lCI;AACD;AAED;AtG2/lCF;AACA;AACA;AACA;AACA;AACA;AACA;AsG3/lCI;AACD;AAED;AtG4/lCF;AACA;AACA;AACA;AACA;AACA;AsG7/lCgB;AtG+/lChB;AsG9/lCI;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AtGggmCJ;AsG1/lCI;AACE;AAKA;AACA;AtGw/lCN;AsGr/lCM;AACA;AACA;AtGu/lCN;AsGt/lCM;AACE;AADkD;AAK9C;AAAsC;AALQ;AAMlD;AAEA;AACA;AACA;AACA;AAXkD;AAAA;AAalD;AtGw/lCR;AsGv/lCQ;AACE;AACA;AtGy/lCV;AsGx/lCU;AACE;AACD;AtG0/lCX;AsGz/lCU;AACE;AACD;AtG2/lCX;AsG1/lCU;AACE;AACD;AtG4/lCX;AsG3/lCU;AACE;AACD;AtG6/lCX;AsG5/lCU;AACE;AACD;AtG8/lCX;AsG7/lCU;AACE;AACA;AACA;AACA;AACA;AACD;AACF;AtG+/lCT;AsG9/lCQ;AACA;AAGA;AtG8/lCR;AsG7/lCQ;AtG+/lCR;AsG9/lCQ;AASC;AACC;AACA;AACD;AAIC;AACA;AACA;AACD;AAMC;AACA;AACA;AACA;AACD;AAIC;AACA;AACA;AACA;AACA;AACA;AAIE;AACA;AACA;AACD;AAED;AtGy+lCV;AACA;AsGz+lCU;AACE;AACA;AACA;AACA;AACD;AACC;AACA;AACD;AtG2+lCX;AsG1+lCU;AACD;AACC;AACA;AACA;AACD;AAMC;AACD;AAOC;AACA;AACA;AACD;AACC;AACA;AACA;AACE;AAAgB;AAKnB;AtG89lCT;AsG59lCQ;AACE;AACE;AACD;AtG89lCX;AsG79lCU;AAAiB;AAAO;AAKxB;AACE;AAAgB;AAKlB;AACD;AtG09lCT;AsGx9lCQ;AACE;AAAiB;AAAqB;AACvC;AACF;AtG49lCP;AsG19lCM;AACE;AACD;AtG49lCP;AACA;AsG19lCM;AACE;AAEI;AACE;AAAM;AAAO;AAA8B;AAAO;AAClD;AAAM;AAAO;AAA2B;AAAO;AAChD;AACD;AACE;AACA;AACE;AACA;AACA;AAAiB;AAAO;AtGq+lCxC;AsG99lCgB;AACE;AAAiB;AAAqB;AACvC;AACF;AtGk+lCf;AsGj+lCc;AACE;AACD;AtGm+lCf;AACA;AsGl+lCc;AAAuC;AAAO;AtGs+lC5D;AsGr+lCc;AAA6B;AAAO;AAClC;AACQ;AAAO;AACc;AAAO;AAErC;AtG0+lCf;AsGz+lCc;AACD;AAjCH;AAqCH;AACF;AACF;AAED;AtGw+lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGx+lCI;AAEA;AtGy+lCJ;AsGx+lCI;AACE;AACD;AtG0+lCL;AsGz+lCI;AAGA;AtGy+lCJ;AsGx+lCI;AACD;AAED;AtGy+lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGz+lCI;AACA;AAEA;AACA;AACA;AACD;AAED;AtGy+lCF;AACA;AACA;AACA;AACA;AACA;AsGz+lCI;AACE;AACD;AACC;AACD;AACF;AAED;AtG0+lCF;AACA;AACA;AACA;AACA;AACA;AACA;AsG1+lCI;AAEI;AAAA;AtG4+lCR;AsG1+lCI;AACE;AACD;AtG4+lCL;AsG3+lCI;AtG6+lCJ;AsG5+lCI;AtG8+lCJ;AsG7+lCI;AACE;AAKE;AAAY;AACZ;AAAY;AAEf;AACF;AAED;AtG2+lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsG5+lCkB;AtG8+lClB;AsG7+lCI;AAEA;AAGA;AtG4+lCJ;AsG3+lCI;AACA;AACA;AACA;AtG6+lCJ;AsG1+lCI;AACA;AtG4+lCJ;AsG3+lCI;AACE;AtG6+lCN;AsG5+lCM;AACE;AAAyC;AAAoB;AAC9D;AtGg/lCP;AsG/+lCM;AAKE;AACA;AACD;AtG6+lCP;AsG5+lCM;AACE;AACD;AACF;AAGD;AtG4+lCJ;AACA;AsG5+lCI;AtG8+lCJ;AsG7+lCI;AAME;AACE;AtG0+lCR;AsGz+lCQ;AACE;AACA;AACD;AtG2+lCT;AsG1+lCQ;AAOE;AtGs+lCV;AsGr+lCU;AtGu+lCV;AsGt+lCU;AACE;AACE;AACD;AtGw+lCb;AsGv+lCY;AACD;AACF;AACF;AACF;AtGy+lCL;AACA;AsGv+lCI;AACE;AACE;AACE;AtGy+lCV;AsGx+lCU;AACD;AACF;AACF;AtG0+lCL;AsGx+lCI;AAEA;AtGy+lCJ;AsGx+lCI;AtG0+lCJ;AsGz+lCI;AACE;AACD;AACC;AACD;AACC;AACD;AtG2+lCL;AsGz+lCI;AAEI;AACA;AACA;AtG0+lCR;AsGt+lCI;AACE;AtGw+lCN;AsGv+lCM;AACE;AACD;AAED;AACA;AACA;AACA;AtGw+lCN;AACA;AsGx+lCM;AtG0+lCN;AsGx+lCM;AACD;AAGD;AtGw+lCJ;AACA;AsGx+lCI;AACE;AACE;AAEA;AACA;AtGy+lCR;AsGx+lCQ;AAOE;AAEE;AAAoB;AACpB;AAAwB;AACxB;AAAY;AAEf;AtGq+lCT;AsGp+lCQ;AACE;AACD;AAED;AACA;AtGq+lCR;AACA;AsGr+lCQ;AACE;AAAgC;AAAa;AAC9C;AACF;AACF;AtGy+lCL;AsGv+lCI;AAME;AACA;AACA;AtGo+lCN;AsGn+lCM;AAKE;AtGi+lCR;AsGh+lCQ;AAME;AACA;AAAgC;AAAa;AAC7C;AACD;AACF;AAED;AtG89lCN;AACA;AsG99lCM;AAKE;AtG49lCR;AsG39lCQ;AAKE;AACA;AAAgC;AAAa;AAC7C;AACD;AACF;AACF;AACF;AAED;AtG09lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsG19lCI;AAEA;AACA;AACA;AtG29lCJ;AsG19lCI;AACE;AACA;AtG49lCN;AsGj9lCM;AACE;AACD;AtGm9lCP;AsGj9lCM;AAGA;AtGi9lCN;AsGh9lCM;AtGk9lCN;AsGj9lCM;AACE;AACA;AACA;AACD;AACC;AtGm9lCR;AsGl9lCQ;AACE;AACA;AACA;AACA;AACA;AAKS;AAA6B;AACvC;AACC;AACA;AACD;AACF;AtGi9lCP;AsG/8lCM;AACA;AACD;AtGi9lCL;AsG/8lCI;AACA;AtGi9lCJ;AsG/8lCI;AACE;AACA;AACA;AACD;AAGD;AtG+8lCJ;AACA;AsG/8lCI;AACA;AACA;AACD;AAED;AtGg9lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGh9lCI;AACA;AACA;AACA;AACA;AACA;AACA;AtGk9lCJ;AsGj9lCI;AACE;AACD;AtGm9lCL;AsGl9lCI;AACA;AACD;AAED;AtGm9lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGn9lCI;AtGq9lCJ;AsGn9lCI;AACE;AACA;AACA;AACE;AACD;AAGD;AACA;AtGm9lCN;AACA;AsGn9lCM;AACA;AACD;AtGq9lCL;AsGn9lCI;AACA;AACE;AACA;AACA;AtGq9lCN;AsGh9lCM;AACD;AAED;AACD;AAED;AtGg9lCF;AACA;AACA;AACA;AACA;AACA;AsGh9lCI;AACE;AACD;AACF;AAED;AtGi9lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGj9lCI;AACA;AtGm9lCJ;AsGl9lCI;AACE;AAOA;AACD;AACF;AAED;AtG68lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGt8lCI;AtGw8lCJ;AsGv8lCI;AACE;AASD;AACC;AACA;AACA;AACA;AACA;AACA;AACE;AACE;AACD;AtGi8lCT;AsGh8lCQ;AAEM;AACA;AAFF;AtGo8lCZ;AsG/7lCQ;AASD;AACF;AACF;AAED;AtGw7lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGx7lCI;AACA;AACE;AACA;AACA;AACA;AAJK;AAMR;AAED;AtGy7lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGj7lCI;AACA;AtGm7lCJ;AsGl7lCI;AASE;AAKE;AAKD;AtGo6lCP;AACA;AsGn6lCM;AACE;AAAa;AAAc;AAC5B;AtGu6lCP;AsGt6lCM;AACD;AtGw6lCL;AsGt6lCI;AtGw6lCJ;AsGv6lCI;AACE;AACE;AACA;AACD;AACF;AtGy6lCL;AsGv6lCI;AACE;AACA;AACA;AACA;AACA;AACA;AACD;AACC;AACE;AAA+B;AAC7B;AACA;AACA;AACA;AACA;AACA;AACA;AAP6B;AAUlC;AtGy6lCL;AsGx6lCI;AACD;AAED;AtGy6lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGz6lCI;AACA;AAIE;AACD;AAGD;AtGs6lCJ;AACA;AsGt6lCI;AACE;AAIE;AACD;AACF;AtGq6lCL;AACA;AsGn6lCI;AAME;AACD;AtGg6lCL;AsG95lCI;AACD;AAED;AtG+5lCF;AACA;AACA;AsG15lCI;AAMA;AtGu5lCJ;AsGt5lCI;AACE;AACD;AtGw5lCL;AsGt5lCI;AACE;AAQD;AACC;AAQD;AACF;AAED;AtGy4lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGl4lCI;AAEA;AACE;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AATW;AAWb;AAGA;AtGg4lCJ;AsG/3lCI;AtGi4lCJ;AsGh4lCI;AACE;AACE;AACD;AtGk4lCP;AsGj4lCM;AACA;AACD;AtGm4lCL;AsGl4lCI;AACD;AAED;AtGm4lCF;AACA;AACA;AACA;AACA;AsGn4lCI;AACD;AAED;AtGo4lCF;AACA;AACA;AACA;AACA;AACA;AsGr4lCoC;AtGu4lCpC;AsGv4lCoC;AAAA;AAAA;AAAA;AAAA;AtG64lCpC;AsGr4lCI;AACE;AACA;AtGu4lCN;AsGt4lCM;AACE;AACE;AACD;AtGw4lCT;AsGv4lCQ;AtGy4lCR;AsGx4lCQ;AtG04lCR;AsGz4lCQ;AACE;AACA;AACD;AtG24lCT;AsG14lCQ;AACE;AACE;AACD;AACC;AACD;AACF;AACC;AACD;AtG44lCT;AsG34lCQ;AACD;AACF;AtG64lCL;AsG54lCI;AtG84lCJ;AsG74lCI;AACE;AAAyB;AAAA;AAC1B;AtGi5lCL;AsGh5lCI;AACE;AACE;AtGk5lCR;AsGj5lCQ;AACD;AtGm5lCP;AsGl5lCM;AACD;AtGo5lCL;AsGn5lCI;AACE;AAAyB;AAAA;AtGu5lC/B;AsGt5lCM;AACD;AtGw5lCL;AsGt5lCI;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACD;AAED;AtGm5lCF;AACA;AACA;AACA;AACA;AACA;AsGn5lCI;AACE;AACD;AAEA;AACF;AAED;AtGm5lCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGn5lCI;AACE;AACA;AACA;AACA;AACA;AACA;AACE;AACD;AACD;AACE;AACD;AACD;AACE;AACD;AACF;AtGq5lCL;AsGn5lCI;AAKE;AtGi5lCN;AsGh5lCM;AACE;AACD;AACF;AACF;AtGk5lCH;AACA;AACA;AsGj5lCA;AtGm5lCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsGp5lCO;AAEP;AtGq5lCA;AACA;AACA;AACA;AACA;AsGt5lCO;AACL;AACD;AtGw5lCD;AACA;AACA;AACA;AACA;AACA;AACA;AuGj4pCA;AvGm4pCA;AACA;AACA;AuGn4pCA;AACO;AAEP;AvGo4pCA;AuGn4pCA;AvGq4pCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuGh5pCE;AvGk5pCF;AACA;AACA;AACA;AACA;AuG/4pCE;AvGi5pCF;AACA;AACA;AACA;AACA;AuGh5pCE;AvGk5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuGj5pCE;AvGm5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuGl5pCE;AvGo5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuGn5pCE;AvGq5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AuGp5pCE;AvGs5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AuGr5pCE;AvGu5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AuGt5pCE;AvGw5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuGl5pCE;AvGo5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuGn5pCE;AvGq5pCF;AACA;AACA;AACA;AACA;AACA;AuGp5pCE;AvGs5pCF;AACA;AACA;AACA;AACA;AuGr5pCE;AvGu5pCF;AACA;AACA;AACA;AACA;AACA;AuGt5pCE;AvGw5pCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuG15pCA;AvG45pCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwG5hqCA;AxG8hqCA;AwG7hqCA;AxG+hqCA;AwG9hqCA;AxGgiqCA;AwG/hqCA;AxGiiqCA;AwGhiqCA;AxGkiqCA;AwGjiqCA;AxGmiqCA;AwG9hqCA;AxGgiqCA;AwG/hqCA;AxGiiqCA;AwGhiqCA;AxGkiqCA;AwG9jqCA;AxGgkqCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGhjqCA;AxGkjqCA;AACA;AACA;AwGhjqCA;AACE;AACD;AAED;AxGijqCA;AACA;AACA;AACA;AACA;AACA;AwGjjqCO;AACL;AACE;AACD;AxGmjqCH;AwGljqCE;AACD;AAED;AxGmjqCA;AACA;AwGnjqCA;AAEA;AxGojqCA;AACA;AACA;AACA;AwGnjqCA;AAEA;AxGojqCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGrjqCE;AxGujqCF;AACA;AACA;AwGrjqCE;AACE;AxGujqCJ;AwGrjqCI;AACA;AAEA;AAIA;AxGmjqCJ;AwGljqCI;AAEA;AxGmjqCJ;AwGljqCI;AAGA;AxGkjqCJ;AwGjjqCI;AACD;AAED;AxGkjqCF;AACA;AACA;AACA;AACA;AACA;AACA;AwGljqCI;AAKD;AAED;AxG+iqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGjjqCI;AAGA;AxGijqCJ;AwG/iqCI;AAEA;AAEA;AAKA;AAKA;AAEA;AAID;AAED;AxGkiqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGliqCI;AACA;AACE;AACD;AxGoiqCL;AwGxiqC+B;AAAA;AAAA;AAM3B;AxGuiqCJ;AwGtiqCI;AACE;AACA;AACE;AAEA;AACE;AACA;AACD;AxGuiqCT;AwGriqCM;AACE;AxGuiqCR;AwGriqCM;AACE;AxGuiqCR;AwGriqCM;AACE;AACA;AAIA;AxGoiqCR;AwGliqCM;AACE;AxGoiqCR;AwGniqCQ;AxGqiqCR;AwGniqCM;AACE;AACA;AxGqiqCR;AwGniqCM;AACE;AACW;AAAA;AAEP;AACD;AArCP;AxG2kqCJ;AwGpiqCI;AACD;AAED;AxGqiqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGtiqCgC;AxGwiqChC;AwGxiqCgC;AAAA;AAAA;AAAA;AAE5B;AxG4iqCJ;AwG1iqCI;AxG4iqCJ;AwG3iqCI;AACE;AACE;AACE;AACD;AACF;AACF;AxG6iqCL;AwG5iqCI;AAEI;AAIG;AAAwB;AAAzB;AAEH;AACD;AAAiB;AACf;AACD;AAEJ;AAED;AxG0iqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwG3iqCuC;AAEnC;AAGA;AACA;AACA;AxG0iqCJ;AwGziqCI;AACA;AAEA;AxG0iqCJ;AwGziqCI;AACE;AACA;AACA;AACA;AACD;AxG2iqCL;AwGziqCI;AACE;AACD;AxG2iqCL;AwGziqCI;AACD;AACD;AxG2iqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwG3iqCI;AAD0B;AAK1B;AACA;AxG2iqCJ;AwG1iqCI;AACA;AxG4iqCJ;AwG1iqCI;AACE;AACD;AxG4iqCL;AwG1iqCI;AACE;AACD;AAGD;AxG0iqCJ;AACA;AwG1iqCI;AAKD;AAED;AxGuiqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGviqCI;AxGyiqCJ;AwGtiqCI;AAEA;AACD;AAED;AxGsiqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGtiqCI;AAEA;AACE;AACE;AAAO;AAAO;AACf;AACC;AACD;AACF;AAED;AACD;AAED;AxGuiqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGxiqCsB;AxG0iqCtB;AwG1iqCsB;AAClB;AACA;AxG4iqCJ;AwG1iqCI;AACE;AAKA;AACD;AxGwiqCL;AwGtiqCI;AACE;AAIE;AAMD;AACF;AAED;AxG+hqCJ;AwG5hqCI;AACE;AACD;AACC;AACE;AACD;AACF;AxG8hqCL;AwG5hqCI;AACD;AAED;AxG6hqCF;AACA;AACA;AACA;AACA;AACA;AACA;AwG7hqCI;AACE;AAAO;AAAO;AACf;AACC;AACD;AxGiiqCL;AwGhiqCI;AACE;AACD;AACF;AAED;AxGiiqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGjiqCI;AACE;AACD;AxGmiqCL;AwGliqCI;AACD;AAED;AxGmiqCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwGniqCI;AAD6B;AAG7B;AxGqiqCJ;AwGhiqCI;AACE;AACD;AxGkiqCL;AwGhiqCI;AACE;AACE;AACA;AAIA;AACD;AACC;AACD;AACF;AAED;AACD;AxG8hqCH;AACA;AACA;AwG7hqCA;AxG+hqCA;AACA;AACA;AACA;AACA;AACA;AwGjiqCO;AACL;AAIE;AAAsB;AAEzB;AxGgiqCD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyG79qCA;AzG+9qCA;AyG99qCA;AzGg+qCA;AyG/9qCA;AzGi+qCA;AyGh+qCA;AzGk+qCA;AyGj+qCA;AzGm+qCA;AyGl+qCA;AzGo+qCA;AyGz/qCA;AzG2/qCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGl/qCA;AACA;AAEA;AzGm/qCA;AyGl/qCA;AAEA;AzGm/qCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGp/qCE;AzGs/qCF;AACA;AACA;AACA;AyGp/qCE;AACE;AACA;AAEA;AzGq/qCJ;AyGp/qCI;AAEA;AzGq/qCJ;AyGp/qCI;AAEA;AzGq/qCJ;AyGp/qCI;AAEA;AzGq/qCJ;AyGp/qCI;AACD;AAED;AzGq/qCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGv/qCI;AACA;AACD;AAED;AzGw/qCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGx/qCI;AAAkC;AAAA;AACnC;AAED;AzG2/qCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyG3/qCI;AACA;AACD;AAED;AzG4/qCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyG5/qCI;AAA4B;AAAA;AAC7B;AAED;AzG+/qCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyG//qCI;AAA4B;AAAA;AAC7B;AAED;AzGkgrCF;AACA;AACA;AACA;AACA;AACA;AyGlgrCI;AACE;AAEY;AAAA;AAER;AACA;AACD;AACQ;AAAA;AACZ;AzGogrCL;AyGngrCI;AACD;AAED;AzGogrCF;AACA;AACA;AACA;AACA;AACA;AACA;AyGrgrCsB;AzGugrCtB;AyGtgrCI;AAEI;AAEA;AACA;AzGsgrCR;AyGrgrCQ;AACA;AACD;AAEJ;AAED;AzGqgrCF;AACA;AACA;AyGtgrCwB;AzGwgrCxB;AyGvgrCI;AACE;AAIE;AACA;AACD;AACF;AACF;AAED;AzGqgrCF;AACA;AACA;AyGrgrCI;AACA;AACE;AAA4B;AAC1B;AACA;AAF0B;AAK/B;AzGugrCH;AACA;AACA;AyGtgrCA;AzGwgrCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyG5grCE;AzG8grCF;AACA;AACA;AyG5grCE;AACE;AACA;AAAW;AAA4B;AAEvC;AzG+grCJ;AyG9grCI;AAEA;AzG+grCJ;AyG9grCI;AzGghrCJ;AyG/grCI;AACE;AACD;AACF;AAED;AzGghrCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGlhrCI;AACA;AACA;AACD;AAED;AzGmhrCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGnhrCI;AzGqhrCJ;AyG/grCI;AACE;AACA;AzGihrCN;AyGhhrCM;AACE;AACA;AACD;AzGkhrCP;AyGjhrCM;AACA;AACD;AACC;AACE;AACA;AAFwB;AAI3B;AzGmhrCL;AACA;AyGjhrCI;AzGmhrCJ;AyGlhrCI;AACE;AACA;AzGohrCN;AyGnhrCM;AACE;AzGqhrCR;AyGphrCQ;AACE;AACA;AACD;AACF;AzGshrCP;AyGrhrCM;AACE;AACD;AACF;AACF;AAED;AzGshrCF;AACA;AACA;AACA;AACA;AyGthrCI;AACA;AACD;AzGwhrCH;AACA;AACA;AyGvhrCA;AzGyhrCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGjirCE;AzGmirCF;AACA;AACA;AACA;AACA;AyGhirCE;AzGkirCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGnirCA;AzGqirCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyGvirCE;AzGyirCF;AACA;AyGvirCE;AACE;AACA;AAEA;AzGwirCJ;AyGvirCI;AzGyirCJ;AyGvirCI;AACE;AACA;AACD;AACF;AAED;AzGwirCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyG1irCI;AACE;AACE;AACD;AAGD;AACA;AzG0irCN;AACA;AyG1irCM;AACA;AACD;AACC;AACD;AACF;AAED;AzG2irCF;AACA;AACA;AACA;AACA;AACA;AACA;AyG3irCI;AACD;AAED;AzG4irCF;AACA;AACA;AyG7irCmB;AzG+irCnB;AyG9irCI;AACE;AACE;AACA;AACD;AzGgjrCP;AyG/irCM;AACD;AACF;AAED;AzGgjrCF;AACA;AACA;AyGjjrCyB;AzGmjrCzB;AyGljrCI;AACE;AACE;AACA;AACD;AzGojrCP;AyGnjrCM;AzGqjrCN;AyGpjrCM;AACD;AACF;AzGsjrCH;AACA;AACA;AyGrjrCA;AzGujrCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyG3jrCE;AzG6jrCF;AACA;AyG3jrCE;AACE;AACA;AACD;AAED;AzG4jrCF;AACA;AACA;AACA;AACA;AyG9jrCI;AAC+C;AAAD;AAC9B;AAAA;AACjB;AAED;AzGikrCF;AACA;AACA;AyGjkrCI;AAAO;AAAyB;AAExB;AAAkB;AAAnB;AAFP;AAID;AzGskrCH;AACA;AACA;AyGrkrCA;AzGukrCA;AACA;AACA;AACA;AACA;AACA;AyGzkrCO;AACL;AAII;AzGwkrCN;AyGvkrCM;AACA;AAGA;AACD;AACD;AAAsB;AAEzB;AzGukrCD;AACA;AACA;AACA;AACA;AACA;AACA;A0Gv+rCA;A1Gy+rCA;A0Gz/rCA;A1G2/rCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Gv/rCA;A1Gy/rCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Gv/rCO;AAEP;A1Gw/rCA;AACA;AACA;AACA;A0Gx/rCA;AAEA;A1Gy/rCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0G1/rCE;A1G4/rCF;AACA;A0G1/rCE;AACE;AACA;AAEA;A1G2/rCJ;A0G1/rCI;AAEA;A1G2/rCJ;A0G1/rCI;AAEA;A1G2/rCJ;A0G1/rCI;AACD;AAED;A1G2/rCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0G7/rCI;AACD;AAED;A1G8/rCF;AACA;AACA;AACA;AACA;AACA;A0G9/rCI;AACD;AAED;A1G+/rCF;AACA;AACA;AACA;AACA;AACA;A0G//rCI;AACD;AAED;A1GggsCF;AACA;AACA;AACA;AACA;AACA;AACA;A0GhgsCI;AACD;AAED;A1GigsCF;AACA;AACA;AACA;AACA;AACA;AACA;A0GjgsCI;AACA;AACA;AACA;AACD;AAED;A1GkgsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0GlgsCI;AACA;A1GogsCJ;A0GngsCI;AACE;AACD;A1GqgsCL;A0GpgsCI;AACA;AACD;AAED;A1GqgsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0GrgsCI;AACA;A1GugsCJ;A0GtgsCI;AACE;AACA;A1GwgsCN;A0GvgsCM;AACE;AACA;AACD;AACF;A1GygsCL;A0GxgsCI;AACD;AAED;A1GygsCF;AACA;AACA;AACA;AACA;AACA;A0GzgsCI;AACD;AAED;A1G0gsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0G1gsCI;A1G4gsCJ;A0G3gsCI;AACE;AACD;A1G6gsCL;A0G5gsCI;AACA;AACA;AACD;AAED;A1G6gsCF;AACA;AACA;AACA;AACA;AACA;A0G7gsCI;A1G+gsCJ;A0G9gsCI;AACE;AACE;AACD;AACF;AACF;A1GghsCH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GhssCA;A3GkssCA;A2GjssCA;A3GmssCA;A2GlssCA;A3GossCA;A2GnssCA;A3GqssCA;A2GpssCA;A3GsssCA;A2G1tsCA;A3G4tsCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GptsCA;A3GstsCA;AACA;AACA;AACA;AACA;A2GptsCA;A3GstsCA;AACA;A2GptsCA;AAEA;A3GqtsCA;A2GptsCA;AAEA;A3GqtsCA;A2GptsCA;AAEA;A3GqtsCA;AACA;AACA;AACA;AACA;AACA;A2GttsCE;A3GwtsCF;AACA;AACA;A2GttsCE;AACE;AACA;AAEA;A3GutsCJ;A2GttsCI;AAEA;A3GutsCJ;A2GttsCI;AAEA;AACD;AAED;A3GstsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GttsCE;A3GwtsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GxtsCI;AACD;AAED;A3GytsCF;AACA;AACA;AACA;AACA;AACA;AACA;A2GztsCI;AACD;AAED;A3G0tsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2G1tsCI;A3G4tsCJ;A2G3tsCI;AACE;AAAkB;AAAW;AAC3B;AACE;AACA;AACA;AACD;AACF;AAAwB;AAAc;AAEtC;AAAwB;AAAc;AACrC;AACE;AACD;AACC;AACA;AACA;AACD;AACF;AACC;AACD;AACF;A3GkusCL;A2GjusCI;AACD;AAED;A3GkusCF;AACA;AACA;AACA;AACA;AACA;A2GlusCI;AACD;A3GousCH;AACA;AACA;A2GnusCA;A3GqusCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GzusCE;AACA;AACE;AACA;AAEA;A3G0usCJ;AACA;AACA;AACA;A2GzusCI;AAEA;A3G0usCJ;AACA;AACA;AACA;AACA;A2GzusCI;AACD;AAED;A3G0usCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2G7usC4C;A3G+usC5C;A2G9usCI;AACE;AACD;AACF;AAED;A3G+usCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GhvsCwC;A3GkvsCxC;A2GjvsCI;AACE;AACD;AACF;AAED;A3GkvsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GnvsC8C;A3GqvsC9C;A2GpvsCI;AACE;AACD;A3GsvsCL;A2GrvsCI;AACE;AACE;AACD;AACF;AACF;AAED;A3GsvsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GtvsCI;AAID;AAED;A3GovsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GpvsCI;AAID;AAED;A3GkvsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GlvsCI;AAID;AAED;A3GgvsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GhvsCI;AACD;AAED;A3GivsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GjvsCI;AACA;AACA;AACA;AAOA;AACD;AAED;A3G4usCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2G5usCI;A3G8usCJ;A2G7usCI;AACE;AACD;AACC;AACD;AACC;AACD;AACF;AAED;A3G8usCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2G/usC8B;A3GivsC9B;A2GhvsCI;AACA;A3GkvsCJ;A2GjvsCI;AACE;AACD;A3GmvsCL;A2GjvsCI;AAP0B;A3G2vsC9B;A2GlvsCI;AACE;AACD;AACC;AACD;A3GovsCL;A2GnvsCI;AAEA;A3GovsCJ;A2GnvsCI;AACE;AACD;A3GqvsCL;A2GnvsCI;AACE;AACA;AACA;AACD;AACD;AACA;AACD;AAED;A3GovsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GpvsCI;AACE;AACD;A3GsvsCL;A2GpvsCI;AALmC;AAAA;AAQnC;AACA;AACA;AACD;AAED;A3GqvsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GrvsCI;AACE;AACD;AACC;AACA;AACA;AACA;AACD;AACF;AAED;A3GsvsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GtvsCI;AACD;AAED;A3GuvsCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2GvvsCI;AACD;A3GyvsCH;AACA;AACA;A2GxvsCA;A3G0vsCA;AACA;AACA;AACA;AACA;AACA;A2G5vsCO;AACL;AACD;AAED;A3G6vsCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2G7vsCO;AACL;AACA;AACD;A3G+vsCD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4GtptCA;A5GwptCA;A4GvptCA;A5GyptCA;A4GxptCA;A5G0ptCA;A4GzptCA;A5G2ptCA;A4G9qtCA;A5GgrtCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4GxqtCA;AACA;AAEA;A5GyqtCA;AACA;AACA;AACA;AACA;AACA;A4G1qtCE;A5G4qtCF;AACA;A4G1qtCE;AACE;AACA;AAEA;A5G2qtCJ;A4G1qtCI;AAEA;AAEA;AAEA;A5GyqtCJ;A4GxqtCI;AACD;AAED;A5GyqtCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4G3qtCI;AACD;AAED;A5G4qtCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4G7qtC6B;A5G+qtC7B;A4G9qtCI;AACE;AACA;AACA;AACA;AAEI;AACE;AACA;AACD;A5G+qtCX;A4G9qtCU;AACD;AAEH;AACD;A5G+qtCL;A4G9qtCI;AACE;AACE;AACD;AACC;AACA;AACD;AACF;A5GgrtCL;A4G/qtCI;A5GirtCJ;A4GhrtCI;AACE;AACE;AACD;A5GkrtCP;A4GjrtCM;AACD;A5GmrtCL;A4GlrtCI;AACD;AAED;A5GmrtCF;AACA;AACA;AACA;AACA;AACA;A4GnrtCI;AACE;AACA;AACD;A5GqrtCL;A4GprtCI;AACD;AAED;A5GqrtCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4GtrtCqB;A5GwrtCrB;A4GvrtCI;AACE;AACA;A5GyrtCN;A4GxrtCM;AACE;AACD;AACF;AACF;AAED;A5GyrtCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4G1rtCsD;A5G4rtCtD;A4G3rtCI;AACA;AACE;AACE;AACD;A5G6rtCP;A4G3rtCM;AACE;AACD;AACF;A5G6rtCL;A4G5rtCI;AACE;AACD;A5G8rtCL;A4G7rtCI;AACE;AACD;A5G+rtCL;A4G9rtCI;AACA;AACD;AAED;A5G+rtCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4GhstCyB;A5GkstCzB;A4GjstCI;AACE;AACE;AACE;A5GmstCV;A4GlstCU;AACD;AACF;AACF;AACF;A5GostCH;AACA;AACA;A4GnstCA;A5GqstCA;AACA;AACA;AACA;AACA;AACA;A4GvstCO;AACL;AACD;AAED;A5GwstCA;AACA;AACA;AACA;A4GxstCO;AACL;AACD;AAED;A5GystCA;AACA;AACA;AACA;A4GzstCO;AACL;AACE;AACD;A5G2stCH;A4G1stCE;AACA;AACD;A5G4stCD;AACA;AACA;AACA;AACA;AACA;AACA;A6G14tCA;A7G44tCA;A6G34tCA;A7G64tCA;A6G54tCA;A7G84tCA;A6G74tCA;A7G+4tCA;A6Gl6tCA;A7Go6tCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6G75tCA;AACA;AAEA;A7G85tCA;A6G75tCA;AAEA;A7G85tCA;A6G75tCA;A7G+5tCA;A6G95tCO;AAA4B;AAAD;AAElC;A7Gi6tCA;AACA;AACA;AACA;AACA;AACA;A6Gp6tCE;A7Gs6tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gp6tCE;AAQE;AACA;AAEA;A7G85tCJ;A6G75tCI;A7G+5tCJ;A6G55tCI;A7G85tCJ;A6G75tCI;AAEA;A7G85tCJ;A6G75tCI;AAEA;A7G85tCJ;A6G75tCI;AAEA;A7G85tCJ;A6G75tCI;AACD;AAED;A7G85tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gh6tCI;AACE;AACD;A7Gk6tCL;A6Gj6tCI;AAEA;A7Gk6tCJ;A6Gh6tCI;AACE;AACD;A7Gk6tCL;A6Gj6tCI;AACD;AAED;A7Gk6tCF;AACA;AACA;AACA;AACA;AACA;AACA;A6Gl6tCI;AACA;A7Go6tCJ;A6Gn6tCI;AACE;AACD;A7Gq6tCL;A6Gp6tCI;AACD;AAED;A7Gq6tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gr6tCI;AACA;AAAwD;AAEtD;AACA;AACE;AACA;AACA;AACA;AAJW;AAMb;AACD;AACD;AACD;AAED;A7Gs6tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gv6tCqC;A7Gy6tCrC;A6Gx6tCI;AACA;AACA;AACA;AACA;AACA;AACA;A7G06tCJ;A6Gx6tCI;AACE;AACA;AACA;A7G06tCN;A6Gx6tCM;AACE;AACE;AACA;AACA;AACE;AACD;AAGD;A7Gw6tCV;AACA;A6Gx6tCU;AAEA;A7Gy6tCV;A6Gx6tCU;AACE;AACA;AACE;AACA;AACA;AACA;AACA;AALQ;AAOX;AACC;AACA;AACE;AACA;AAFgE;AAInE;A7G06tCX;A6Gx6tCU;AACA;A7G06tCV;A6Gx6tCU;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AAA+B;AAAa;AAC7C;AACC;AACA;AACA;AACD;A7G46tCX;A6G16tCU;AACD;AACC;AACE;AACA;AACA;AAKA;AACD;AACC;AACD;A7Gw6tCX;A6Gv6tCU;AACD;AAKC;AACA;AACA;AACA;AACA;AACE;AACA;AACA;AACD;A7Gq6tCX;A6Gp6tCU;AACA;AAEA;A7Gq6tCV;A6Gp6tCU;AACE;AACA;AACD;A7Gs6tCX;A6Gr6tCU;AACA;AACD;AAGD;AACA;AACA;AACA;AA9BO;AAgCL;AACA;A7Gq6tCV;A6Gp6tCU;A7Gs6tCV;A6Gr6tCU;A7Gu6tCV;A6Gt6tCU;AACE;AACD;A7Gw6tCX;A6Gv6tCU;AACA;A7Gy6tCV;A6Gx6tCU;AAA6C;AAAe;A7G46tCtE;A6G36tCU;AACD;AACC;AACA;AACA;AACA;AACD;A7G66tCT;AACA;A6G36tCQ;AACE;AACD;AACF;AAGD;A7G26tCN;AACA;A6G36tCM;AACE;AACD;A7G66tCP;A6G36tCM;AACoB;AAAA;AAEhB;AACA;AACD;AACJ;A7G66tCL;A6G36tCI;AACD;AAED;A7G46tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6G76tC0C;AAAA;AAEtC;A7G+6tCJ;A6G96tCI;AACE;AACA;AACA;AACA;AACA;AACD;AACC;AACA;AACD;AACC;AACA;AACA;AACD;AACC;AACA;AACD;A7Gg7tCL;AACA;A6G96tCI;A7Gg7tCJ;A6G/6tCI;AACE;AACA;AACD;AACC;AAAsE;AAAA;AAGvE;AACF;AAED;A7Gg7tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gj7tCiD;A7Gm7tCjD;A6Gl7tCI;A7Go7tCJ;A6Gn7tCI;AACE;AACE;AACE;AAAkD;AAAA;AAGnD;AACC;AACD;AACF;AACC;AACD;A7Gq7tCP;A6Gp7tCM;AAEI;A7Gq7tCV;A6Gn7tCU;A7Gq7tCV;A6Gn7tCU;AACE;AACD;AACC;AACD;A7Gq7tCX;A6Gp7tCU;AACD;AAEC;A7Gq7tCV;A6Gp7tCU;A7Gs7tCV;A6Gr7tCU;AACD;AACJ;AACC;AACA;AACA;AACA;AACA;AACD;AACF;AAED;A7Gs7tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gt7tCI;AAEI;AAA0C;AAAA;AAC3C;AAEJ;AAED;A7Gu7tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gv7tCI;AACE;A7Gy7tCN;A6Gx7tCM;AACE;AACD;A7G07tCP;A6Gx7tCM;A7G07tCN;A6Gx7tCM;AACE;AACA;AACA;AACA;AACA;AACD;AAKC;AACA;A7Gs7tCR;A6Gp7tCQ;AACD;AACC;AACA;AACA;AACD;A7Gs7tCP;A6Gp7tCM;AACD;AACC;AACA;AACA;AACA;AACA;AACD;AACF;AAED;A7Gq7tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gr7tCI;AACE;AACD;A7Gu7tCL;A6Gt7tCI;AACE;AACD;AACF;AAED;A7Gu7tCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Gv7tCI;AACE;AACD;A7Gy7tCL;A6Gv7tCI;A7Gy7tCJ;A6Gx7tCI;AACE;AAAmC;AAAA;AACnC;AACD;A7G47tCL;A6G37tCI;AACD;A7G67tCH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Gn5uCA;A9Gq5uCA;A8Gp5uCA;A9Gs5uCA;A8G54uCA;A9G84uCA;A8G14uCA;A9G44uCA;A8G36uCA;A9G66uCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Gz5uCA;AAEA;A9G05uCA;AACA;AACA;AACA;AACA;AACA;A8G35uCE;A9G65uCF;AACA;AACA;A8G35uCE;AACE;AAEA;AACA;AAEA;A9G25uCJ;A8G15uCI;AAAe;AAAmC;AAElD;A9G65uCJ;A8G55uCI;AACD;AAED;A9G65uCF;AACA;AACA;AACA;AACA;AACA;AACA;A8G75uCI;AAKD;AAED;A9G05uCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8G55uCI;AACD;AAED;A9G65uCF;AACA;AACA;AACA;AACA;AACA;AACA;A8G75uCI;AACE;AACD;A9G+5uCL;A8G95uCI;AACD;AAED;A9G+5uCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8G/5uCI;AACD;AAED;A9Gg6uCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Gh6uCI;AACD;AAED;A9Gi6uCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Gj6uCI;AACD;AAED;A9Gk6uCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Gn6uCmE;AAAvB;AAAuB;A9Gu6uCnE;A8Gt6uCI;AACD;AAED;A9Gu6uCF;AACA;AACA;AACA;AACA;AACA;AACA;A8Gv6uCI;AACD;AAED;A9Gw6uCF;AACA;AACA;AACA;AACA;AACA;AACA;A8Gx6uCI;AACD;AAED;A9Gy6uCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Gz6uCI;AACD;AAED;A9G06uCF;AACA;AACA;AACA;AACA;AACA;AACA;A8G16uCI;AACD;AAED;A9G26uCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8G36uCI;AACE;AACD;A9G66uCL;A8Gh7uCiC;AAAA;AAAA;AAAA;AAAA;A9Gs7uCjC;A8Gh7uCI;AACA;AACD;A9Gk7uCH;AACA;AACA;A8Gj7uCA;A9Gm7uCA;AACA;AACA;AACA;AACA;AACA;A8Gr7uCO;AACL;AAIE;AAAsB;AAEzB;A9Go7uCD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GtnvCA;A/GwnvCA;A+G/mvCA;A/GinvCA;A+GvmvCA;A/GymvCA;A+GxmvCA;A/G0mvCA;A+GrmvCA;A/GumvCA;A+GtmvCA;A/GwmvCA;A+GvmvCA;A/GymvCA;A+GxmvCA;A/G0mvCA;A+GzmvCA;A/G2mvCA;A+G1mvCA;A/G4mvCA;A+G3mvCA;A/G6mvCA;AACA;AACA;A+G7mvCA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;A/G8mvCA;AACA;AACA;AACA;AACA;AACA;AACA;A+G7mvCA;AACE;AAAO;AAAA;AACR;AAED;A/GgnvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GhnvCA;AACE;AAAO;AAAA;AACR;AAED;A/GmnvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GvnvCE;A/GynvCF;AACA;A+GvnvCE;AAAoB;A/G0nvCtB;A+GznvCI;AAEA;A/G0nvCJ;A+GznvCI;AAJkB;AAKnB;AAED;A/G2nvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G9nvCoD;A/GgovCpD;A+G/nvCI;AAGI;AACD;AAEC;AACD;AAEJ;AAED;A/G4nvCF;AACA;AACA;A+G7nvCe;A/G+nvCf;A+G/nvCe;AAEX;AAEA;A/G+nvCJ;A+G9nvCI;A/GgovCJ;AACA;A+G9nvCI;AAAmB;AAAA;A/GkovCvB;A+G/nvCI;AACA;AACE;AACD;A/GiovCL;A+G9nvCI;AAA0B;AAAA;A/GkovC9B;A+G/nvCI;AAEE;AAAA;A/GiovCN;A+G7nvCI;AAEE;AAAA;A/G+nvCN;A+G3nvCI;AAEE;AAAA;A/G6nvCN;A+GznvCI;AAEE;AAAiC;AAC/B;AACD;AAIH;A/GwnvCJ;A+GvnvCI;AAEE;AAAiC;AAC/B;AAGI;AACE;AACD;A/GunvCb;A+GtnvCY;A/GwnvCZ;A+GtnvCY;A/GwnvCZ;A+GvnvCY;AACD;AACJ;A/GynvCP;A+GrnvCI;AACE;AACA;AACA;AACA;AACD;A/GunvCL;A+GpnvCI;AACE;AACD;A/GsnvCL;A+GnnvCI;AACE;AACA;AACD;A/GqnvCL;A+GlnvCI;AACE;AACA;AACD;A/GonvCL;A+GjnvCI;AACE;A/GmnvCN;A+GlnvCM;AACD;A/GonvCL;A+GnnvCI;AAEE;AAAA;AACA;AAAuC;AAAA;AAAvC;A/GwnvCN;A+GpnvCI;AAEE;AAAA;A/GsnvCN;A+GlnvCI;AAEE;AAAA;A/GonvCN;A+GhnvCI;AAEE;AAAA;AAIF;AACA;A/G+mvCJ;A+G9mvCI;AAAyB;AAAA;AAGzB;AACA;A/GgnvCJ;A+G/mvCI;AAAiC;AAAA;AAEjC;AAEgC;AAAtB;AAAsB;A/GmnvCpC;A+GlnvCQ;AACD;AAC6B;AAAtB;AAAsB;A/GsnvCpC;A+GrnvCQ;AACE;AACD;AACF;AAIH;AACA;AACA;A/GonvCJ;A+GnnvCI;AAAyD;AAAtB;AAAsB;A/GwnvC7D;A+GvnvCM;AACD;A/GynvCL;A+GtnvCI;AAKA;A/GonvCJ;AACA;AACA;AACA;AACA;A+GnnvCI;AAEA;A/GonvCJ;A+GnnvCI;AAGI;AACE;AACD;A/GmnvCT;A+GlnvCQ;AACD;AAEC;AAGI;AAAO;AAGX;AAGA;A/G8mvCR;A+G7mvCQ;AACE;AAEI;AACD;AAEJ;A/G6mvCT;A+G5mvCQ;AAEI;AAEI;AAAsB;AACtB;AACA;AAHF;AAOH;AAEC;AACE;AACD;AAGD;A/GwmvCZ;AACA;A+GxmvCY;A/G0mvCZ;A+GzmvCY;AACE;AACE;AACD;AACC;AACA;AACA;AAKD;AACF;A/GumvCb;A+GrmvCY;AACA;AACD;AACJ;A/GumvCP;A+GnmvCI;AAEE;AAAiC;AAC/B;AACE;AAAyB;AAAuB;AAChD;A/GumvCV;A+GjmvCU;AAAmC;AAAuB;AAC3D;AACF;A/GqmvCP;A+GjmvCI;AAEE;AAAiC;AAC/B;AACE;A/GmmvCV;A+GlmvCU;AACE;AACA;AAGD;A/GkmvCX;A+GjmvCU;AACD;AACF;A/GmmvCP;A+G/lvCI;AAEE;AAAiC;AAC/B;AACE;AACE;AAIA;AAAO;AAAuB;AAA9B;AACD;A/GimvCX;A+GhmvCU;AAAO;AAAuB;AAA9B;AAGD;AACF;A/GmmvCP;A+G/lvCI;AAEE;AAAiC;AAC/B;AACA;AACE;AAID;AACF;AAIH;A/G2lvCJ;A+G1lvCI;AAEE;AAAiC;AAC/B;AACA;AACE;AAGE;AAAa;AAEhB;AACF;A/G0lvCP;A+GtlvCI;AAEE;AAAiC;AAC/B;AACE;AACD;AACF;A/GwlvCP;A+GplvCI;AAEE;AAAiC;AAC/B;AACE;AACD;AACF;A/GslvCP;A+GllvCI;AAGA;A/GklvCJ;A+GjlvCI;A/GmlvCJ;A+GhlvCI;A/GklvCJ;A+G/kvCI;AACE;A/GilvCN;A+GhlvCM;AACE;AACA;AACD;A/GklvCP;A+GhlvCM;AACD;A/GklvCL;A+G/kvCI;AAAuB;AAAA;A/GmlvC3B;A+GhlvCI;AAAwB;AAAA;A/GolvC5B;A+GjlvCI;AAA0B;AAAA;A/GqlvC9B;A+GllvCI;AAAyB;AAAA;A/GslvC7B;A+GnlvCI;AAA4B;AAAA;A/GulvChC;A+GplvCI;AAA2B;AAAA;AA/WhB;A/Gw8vCf;A+GrlvCI;A/GulvCJ;A+GplvCI;A/GslvCJ;A+GnlvCI;A/GqlvCJ;A+GllvCI;A/GolvCJ;A+GjlvCI;A/GmlvCJ;A+GhlvCI;AACE;AACA;AACD;A/GklvCL;A+G/kvCI;AACE;AACA;AAMD;A/G4kvCL;A+GzkvCI;AACE;AACD;AAGD;A/GykvCJ;A+GxkvCI;A/G0kvCJ;A+GnkvCI;A/GqkvCJ;A+G9jvCI;AAGA;A/G8jvCJ;A+G7jvCI;A/G+jvCJ;A+GxjvCI;A/G0jvCJ;A+GnjvCI;A/GqjvCJ;A+GljvCI;A/GojvCJ;A+G7ivCI;A/G+ivCJ;A+GxivCI;AAEE;AAAiC;AAC/B;AACE;AACD;AACF;A/G0ivCP;A+GtivCI;AAEE;AAAiC;AAC/B;AAIA;AACE;AACD;AACF;A/GqivCP;A+GjivCI;AACE;AAGI;AACD;AACJ;A/GiivCL;A+G9hvCI;AACE;AACE;AACD;AACF;AAGD;A/G8hvCJ;A+G7hvCI;AACE;AACE;AACE;AAAuB;AAG1B;AACF;AAED;AACE;AAKA;AAEE;AAAqB;AACrB;AAAqB;AAExB;AACD;AACE;AAKA;AAEE;AAAqB;AACrB;AAAqB;AAExB;AAED;AACE;AACD;AAED;AACE;AACD;A/GmhvCL;A+GhhvCI;AAAwB;AAAA;AAExB;AACE;AACD;AAED;AACE;A/GkhvCN;A+GjhvCM;AACsB;AAAuB;AAG7C;AAEe;AAAA;AAChB;AAED;AAKA;AAKA;AACE;AAAkB;AAAA;AAGnB;AAED;AACE;AAAkB;AAAA;AAGnB;AAED;AACE;AAAkB;AAAA;AAGnB;AAED;AACE;AACA;A/GsgvCN;A+GrgvCM;AACE;AAAqC;AACvC;AACE;AACE;AACD;A/GwgvCT;A+GvgvCQ;AAA0B;AAAuB;AAClD;AACF;AACF;AAED;A/G0gvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G3gvCmC;AACP;AAAwB;AADjB;A/GghvCnC;A+G9gvCI;AACE;AACD;A/GghvCL;A+G/gvCI;AACD;AAED;A/GghvCF;AACA;AACA;AACA;AACA;AACA;A+GhhvCI;AACD;AAED;A/GihvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GjhvCI;AACA;AAIE;AACE;AAAwE;A/GihvChF;A+G/gvCM;AACE;AACA;AAKA;AACD;A/G6gvCP;A+G5gvCM;AACD;AACF;AAED;A/G6gvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G7gvCI;AAKA;AAGA;A/GygvCJ;A+GlhvC0C;AAAA;A/GqhvC1C;A+G1gvCI;AACE;AACD;A/G4gvCL;A+G3gvCI;AACE;AAAO;AAAuB;AAA9B;AACD;A/GghvCL;A+G/gvCI;AACD;AAED;A/GghvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GhhvCI;AAKA;AACA;AACA;AACA;AACD;AAED;A/G6gvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G7gvCI;AAEI;AAKA;AACD;AACgB;AAAA;AACpB;AAED;A/G0gvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G1gvCI;AACA;AACE;AACA;AACD;AACF;AAED;A/G2gvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G3gvCI;AACA;AAEI;AAKA;AACD;AAEJ;AAED;A/GsgvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GtgvCI;AACE;AAGD;A/GsgvCL;A+GrgvCI;AACE;AAKA;AAAc;AAA2C;AAC1D;AACF;AAED;A/GogvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GrgvCiC;A/GugvCjC;A+GtgvCI;AACE;A/GwgvCN;A+GvgvCM;AACE;AAKA;AACD;AACF;AACF;AAED;A/GogvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GrgvC6C;A/GugvC7C;A+GtgvCI;AAAO;AAAkC;AAA8B;AAAtB;AAAsB;A/G6gvC3E;A+G5gvCM;A/G8gvCN;A+G3gvCM;AACE;AAKA;AACD;AACF;AAZD;AAaD;A/G0gvCH;AACA;AACA;A+GzgvCA;A/G2gvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G/gvCE;A/GihvCF;AACA;AACA;A+G/gvCE;AACE;AACA;AAEA;A/GghvCJ;A+G/gvCI;AACD;AAED;A/GghvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GlhvCI;AAAO;AAAuB;AAI5B;AAAe;AAEf;AAAmB;AACnB;AAAO;AAPT;AAQD;AAED;A/GqhvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GrhvCI;AAAO;AAAiC;AAGtC;AAAsB;AACtB;AAAe;AAEf;AAAmB;AACnB;AAAO;AAPT;AAQD;AAED;A/G0hvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G1hvCI;AAEE;AAAuB;AAIrB;AAAe;AAEf;AAAO;AAEZ;AAED;A/GwhvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GzhvCiE;A/G2hvCjE;A+G1hvCI;AAAO;AAAiC;AAGtC;AAAsB;AACtB;AAAe;AAId;AAAO;AACS;AAAA;AATnB;AAUD;AAED;A/G6hvCF;AACA;AACA;AACA;AACA;AACA;AACA;A+G7hvCI;AAAO;AAAiC;AAEtC;AAAa;AAFf;AAID;AAED;A/GgivCF;AACA;AACA;AACA;AACA;AACA;AACA;A+GhivCI;AAAO;AAAuB;AAE5B;AAAa;AAFf;AAID;AAED;A/GmivCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GnivCI;AAOA;A/G+hvCJ;A+G9hvCI;AACE;AACD;A/GgivCL;A+G/hvCI;AACE;AACD;A/GiivCL;A+GhivCI;AAEE;AAAmB;AACnB;AAAsB;AACtB;AAAe;AACf;AAAoB;AACpB;AAAO;A/GsivCb;A+GpivCI;AACE;AACD;A/GsivCL;A+GrivCI;AACE;AACA;AACD;AACF;AAED;A/GsivCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GtivCI;A/GwivCJ;A+GvivCI;AACE;AACD;A/GyivCL;A+GxivCI;AACA;AAII;AAIE;AACD;AACC;AACD;AACF;AACH;AACD;AAED;A/GmivCF;AACA;AACA;AACA;AACA;AACA;AACA;A+GnivCI;A/GqivCJ;A+GpivCI;AAIE;AACD;A/GmivCL;A+GjivCI;A/GmivCJ;A+G/hvCI;AACE;A/GiivCN;A+G7hvCM;AACE;AACE;AACD;AACF;AACF;A/G+hvCL;A+G7hvCI;AACD;AAED;A/G8hvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G9hvCI;AACA;AACE;AACA;AACA;AACA;AACA;AAL4B;AAO9B;AAEA;A/G+hvCJ;A+G1hvCI;AACE;AACD;AAED;AACA;A/G2hvCJ;AACA;A+G3hvCI;AAGA;A/G2hvCJ;A+G1hvCI;AACE;AACD;A/G4hvCL;A+G3hvCI;AACE;AACD;A/G6hvCL;A+G3hvCI;A/G6hvCJ;A+G5hvCI;AACE;AACE;AAOD;A/GwhvCP;A+GvhvCM;AACD;AAGD;AACA;AACA;AACA;AACA;AACA;A/GuhvCJ;AACA;A+GvhvCI;AACE;AACE;AACA;AAA2B;AAAD;AAC1B;AAEE;AAAmB;AACnB;AAAsB;AACtB;AAAoB;AAEvB;A/G4hvCP;A+G3hvCM;AACD;A/G6hvCL;A+G3hvCI;AACE;AAEE;AAAmB;AACnB;AAAsB;AACtB;AAAoB;AAEvB;A/G8hvCL;A+G5hvCI;AACD;AAED;A/G6hvCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+G7hvCI;AACA;AACG;AAAO;AACF;AAAA;AACT;AAED;A/GgivCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GhivCI;AACA;AACA;A/GkivCJ;A+GjivCI;AACE;AAA0B;AAAA;AAC3B;AACC;AACA;AACD;AACF;AAED;A/GoivCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GpivCI;AAAoD;AAAkB;AAEtE;AAA4C;AAAkB;A/GyivClE;A+GvivCI;AACE;AACA;AACD;A/GyivCL;A+GxivCI;AAMA;AACD;AAED;A/GoivCF;AACA;AACA;AACA;AACA;A+GpivCI;AACD;A/GsivCH;AACA;AACA;A+GrivCA;A/GuivCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+GzivCO;AACL;AACD;AAED;A/G0ivCA;AACA;AACA;AACA;A+G1ivCO;AACL;AACE;AACD;AACF;AAED;A/G2ivCA;AACA;AACA;AACA;AACA;AACA;A+G3ivCO;AACL;AAKD;AAED;A/GwivCA;AACA;AACA;AACA;A+GxivCA;A/G0ivCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgH33xCA;AhH63xCA;AgH53xCA;AhH83xCA;AgH73xCA;AhH+3xCA;AgH93xCA;AhHg4xCA;AgH/3xCA;AhHi4xCA;AgHp5xCA;AhHs5xCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgH/4xCA;AACO;AAEP;AhHg5xCA;AACA;AgHh5xCO;AAEP;AhHi5xCA;AACA;AgHj5xCO;AAEP;AhHk5xCA;AACA;AgHl5xCA;AAEA;AhHm5xCA;AACA;AACA;AACA;AACA;AgHl5xCA;AACE;AACA;AACA;AACA;AAJqB;AAOvB;AhHm5xCA;AACA;AACA;AACA;AgHl5xCA;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAtBgC;AAyBlC;AhHm5xCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgHl5xCO;AACL;AACA;AAEA;AAIA;AhHg5xCF;AgH74xCE;AhH+4xCF;AgH94xCE;AACE;AACD;AACC;AACD;AACC;AACD;AACC;AACA;AACA;AACA;AACA;AhHg5xCJ;AgH/4xCI;AAAqC;AAAA;AACtC;AhHm5xCH;AgHj5xCE;AAEA;AACE;AACD;AACF;AAED;AhHi5xCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgHj5xCO;AACL;AhHm5xCF;AgHl5xCE;AACE;AACA;AACD;AhHo5xCH;AgHl5xCE;AhHo5xCF;AgH/4xCE;AACE;AACA;AACD;AACC;AACD;AACF;AAED;AhHg5xCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgHh5xCO;AACL;AhHk5xCF;AgHj5xCE;AACE;AACA;AACA;AACD;AhHm5xCH;AgHl5xCE;AACD;AAED;AhHm5xCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgHr5xCE;AhHu5xCF;AACA;AgHr5xCE;AACE;AACA;AAEA;AhHs5xCJ;AgHr5xCI;AAEA;AhHs5xCJ;AgHr5xCI;AAEA;AACD;AAED;AhHq5xCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgHv5xCI;AACA;AACD;AAED;AhHw5xCF;AACA;AACA;AACA;AACA;AACA;AgHt5xCE;AhHw5xCF;AACA;AACA;AACA;AACA;AACA;AACA;AgHx5xCI;AACE;AACD;AhH05xCL;AgHx5xCI;AACD;AAED;AhHy5xCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgHz5xCI;AACA;AACE;AACA;AAF2D;AAI7D;AACA;AACD;AAED;AhH05xCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgH15xCI;AACA;AACE;AACA;AAF2D;AAI7D;AACA;AACD;AAED;AhH25xCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgH35xCI;AACD;AAED;AhH45xCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgH55xCI;AACE;AACD;AhH85xCL;AgH75xCI;AACA;AACD;AAED;AhH85xCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgH/5xCkC;AhHi6xClC;AgHh6xCI;AACA;AACA;AACA;AACE;AAAsB;AAAA;AACvB;AAED;AhHm6xCJ;AACA;AgHn6xCI;AACE;AAAsB;AAAA;AACvB;AhHu6xCL;AgHt6xCI;AACE;AhHw6xCN;AgHv6xCM;AACD;AAED;AhHw6xCJ;AACA;AgHx6xCI;AAAU;AAAA;AAEV;AhH26xCJ;AgH16xCI;AACE;AACE;AACD;AhH46xCP;AgH36xCM;AACD;AAED;AAEA;AACA;AACA;AACA;AACA;AACA;AhH26xCJ;AgH16xCI;AACA;AACD;AAED;AhH26xCF;AACA;AACA;AACA;AACA;AACA;AACA;AgH36xCI;AACE;AACD;AhH66xCL;AgHh7xC0B;AAAA;AhHm7xC1B;AgH76xCI;AACE;AACD;AAGD;AhH66xCJ;AACA;AgH76xCI;AhH+6xCJ;AgH96xCI;AACE;AACD;AAED;AhH+6xCJ;AACA;AACA;AACA;AACA;AgH/6xCI;AAGe;AAAA;AACf;AACD;AhHg7xCH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiHtxyCA;AjHwxyCA;AiHvxyCA;AjHyxyCA;AiHxxyCA;AjH0xyCA;AiH5yyCA;AjH8yyCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiHxyyCA;AjH0yyCA;AACA;AACA;AACA;AACA;AiH1yyCE;AjH4yyCF;AACA;AACA;AiH1yyCE;AACE;AACA;AAEA;AjH2yyCJ;AiH1yyCI;AjH4yyCJ;AiHjzyCsB;AAAA;AASlB;AjH4yyCJ;AACA;AiH5yyCI;AAGD;AAED;AjH2yyCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiH7yyCI;AACE;AACD;AjH+yyCL;AiH9yyCI;AACD;AAED;AjH+yyCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiH/yyCI;AACE;AACA;AACA;AAHmB;AjHqzyCzB;AiHhzyCI;AACE;AACD;AjHkzyCL;AiHjzyCI;AACD;AjHmzyCH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkHr3yCA;AlHu3yCA;AkHt3yCA;AlHw3yCA;AkHv3yCA;AlHy3yCA;AkHx3yCA;AlH03yCA;AkHz3yCA;AlH23yCA;AkH13yCA;AlH43yCA;AkH33yCA;AlH63yCA;AkH53yCA;AlH83yCA;AkHt3yCA;AlHw3yCA;AkHv3yCA;AlHy3yCA;AkHx3yCA;AlH03yCA;AkHz3yCA;AlH23yCA;AkH13yCA;AlH43yCA;AkH33yCA;AlH63yCA;AkHj6yCA;AlHm6yCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH14yCA;AAEA;AlH24yCA;AkH14yCO;AACL;AADwB;AAI1B;AlH24yCA;AACA;AACA;AACA;AACA;AACA;AACA;AkH34yCA;AAEA;AlH44yCA;AACA;AACA;AACA;AACA;AkH34yCA;AAEA;AlH44yCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH74yCE;AlH+4yCF;AACA;AkH74yCE;AAAoB;AlHg5yCtB;AkH/4yCI;AACA;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AACA;AACA;AACA;AkH/4yCI;AAEA;AlHg5yCJ;AkH/4yCI;AAEA;AlHg5yCJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH/4yCI;AAEA;AlHg5yCJ;AACA;AACA;AACA;AACA;AkH/4yCI;AlHi5yCJ;AkH/4yCI;AACE;AACD;AlHi5yCL;AkH/4yCI;AACA;AAEA;AAGA;AAEA;AAEA;AAEA;AAEA;AlH04yCJ;AACA;AACA;AACA;AkHz4yCI;AAEA;AlH04yCJ;AACA;AACA;AACA;AkHz4yCI;AAIA;AACA;AlHw4yCJ;AkHv4yCI;AACA;AlHy4yCJ;AkHx4yCI;AAIA;AlHu4yCJ;AkHt4yCI;AAEA;AlHu4yCJ;AkHt4yCI;AAEA;AACA;AlHu4yCJ;AkHt4yCI;AAOA;AlHk4yCJ;AkHj4yCI;AACE;AACE;AACA;AACA;AACE;AACE;AACD;AACC;AlHm4yCZ;AkHl4yCY;AACE;AAOA;AACD;AACF;AACF;AACF;AACC;AACD;AACF;AAED;AlH63yCJ;AkH53yCI;AAEA;AlH63yCJ;AkH53yCI;AACE;AACA;AlH83yCN;AkH73yCM;AACE;AACA;AACA;AACE;AACE;AACD;AACC;AAOD;AlHy3yCX;AkHx3yCU;AACD;AACF;AACC;AACD;AACF;AAGD;AlHw3yCJ;AkHv3yCI;AACE;AlHy3yCN;AkHx3yCM;AACE;AACA;AACA;AACE;AACD;AlH03yCT;AkHz3yCQ;AACA;AACA;AACD;AACF;AAGD;AlHy3yCJ;AACA;AkHz3yCI;AACE;AACD;AACF;AAED;AlH03yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH53yCI;AAII;AACA;AACA;AACA;AACA;AACA;AACA;AACC;AAGC;AlHy3yCV;AkHn3yCI;AACE;AACD;AlHq3yCL;AkHp3yCI;AAGI;AACE;AAAwC;AAE1C;AACA;AACD;AACJ;AAED;AlHm3yCF;AACA;AACA;AkHn3yCI;AACD;AAED;AlHo3yCF;AACA;AACA;AkHp3yCI;AACD;AAED;AlHq3yCF;AACA;AACA;AkHr3yCI;AlHu3yCJ;AkHt3yCI;AACE;AACD;AlHw3yCL;AACA;AkHv3yCI;AACD;AAED;AlHw3yCF;AACA;AACA;AkHx3yCI;AACD;AAED;AlHy3yCF;AACA;AACA;AkHz3yCI;AACD;AAED;AlH03yCF;AACA;AACA;AkH13yCI;AACE;AACD;AlH43yCL;AkH33yCI;AlH63yCJ;AkH53yCI;AACE;AACA;AAGD;AlH43yCL;AkH33yCI;AACD;AAED;AlH43yCF;AACA;AACA;AkH53yCI;AACD;AAED;AlH63yCF;AACA;AACA;AkH73yCI;AACE;AACD;AlH+3yCL;AACA;AkH93yCI;AACE;AACD;AlHg4yCL;AkH/3yCI;AlHi4yCJ;AkHz4yC8B;AAAA;AlH44yC9B;AkHl4yCI;AlHo4yCJ;AkHn4yCI;AACE;AACA;AAIyB;AAA4B;AAEtD;AACF;AAED;AlHi4yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkHj4yCI;AACE;AACE;AACD;AlHm4yCP;AkHl4yCM;AACD;AlHo4yCL;AkHn4yCI;AACD;AAED;AlHo4yCF;AACA;AACA;AkHp4yCI;AACD;AAED;AlHq4yCF;AACA;AACA;AkHr4yCI;AACA;AACA;AACD;AAED;AlHs4yCF;AACA;AACA;AkHt4yCI;AACD;AAED;AlHu4yCF;AACA;AACA;AkHv4yCI;AACD;AAED;AlHw4yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkHx4yCI;AACD;AAED;AlHy4yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkHz4yCI;AACD;AAED;AlH04yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH14yCI;AACD;AAED;AlH24yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH34yCI;AACD;AAED;AlH44yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH54yCI;AACD;AAED;AlH64yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH74yCI;AACD;AAED;AlH84yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH94yCI;AACD;AAED;AlH+4yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH/4yCI;AACD;AAED;AlHg5yCF;AACA;AACA;AACA;AACA;AACA;AACA;AkHh5yCI;AACE;AACD;AlHk5yCL;AkHj5yCI;AAGA;AACA;AACA;AlHi5yCJ;AkHh5yCI;AACE;AAID;AlH+4yCL;AkH74yCI;AACA;AAKD;AAED;AlH04yCF;AACA;AACA;AkH14yCI;AACD;AAED;AlH24yCF;AACA;AACA;AkH34yCI;AACD;AAED;AlH44yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH54yCI;AACD;AAED;AlH64yCF;AACA;AACA;AkH74yCI;AACD;AAED;AlH84yCF;AACA;AACA;AkH94yCI;AACD;AAED;AlH+4yCF;AACA;AACA;AkH/4yCI;AACD;AAED;AlHg5yCF;AACA;AACA;AkHj5yCoB;AlHm5yCpB;AkHl5yCI;AACE;AACA;AAIQ;AACD;AACR;AlHi5yCL;AkHh5yCI;AAAO;AAAkC;AAAzC;AACD;AAED;AlHo5yCF;AACA;AACA;AACA;AACA;AACA;AACA;AkHp5yCI;AACE;AACA;AACD;AAKC;AACA;AACA;AACA;AAID;AACF;AAED;AlH84yCF;AACA;AACA;AkH94yCI;AACE;AlHg5yCN;AkH/4yCM;AACE;AACA;AACD;AAIC;AACD;AlH84yCP;AkH74yCM;AAQe;AAAA;AAChB;AlHy4yCL;AkHx4yCI;AAAO;AAAiC;AAAxC;AACD;AAED;AlH44yCF;AACA;AACA;AACA;AACA;AACA;AACA;AkH54yCI;AACA;AAFgC;AlHi5yCpC;AkH54yCI;AACE;AACD;AlH84yCL;AkH74yCI;AACE;AACA;AACD;AlH+4yCL;AkH94yCI;AAAsC;AAAA;AACvC;AAED;AlHi5yCF;AACA;AACA;AkHj5yCI;AlHm5yCJ;AkHl5yCI;AACE;AACA;AACD;AlHo5yCL;AkHn5yCI;AACD;AAED;AlHo5yCF;AACA;AACA;AkHr5yCyC;AlHu5yCzC;AkHt5yCI;AACA;AACE;AACE;AACD;AACF;AACF;AAED;AlHu5yCF;AACA;AACA;AkHv5yCI;AACE;AACE;AACA;AACD;AlHy5yCP;AkHx5yCM;AACA;AACD;AlH05yCL;AkHz5yCI;AACE;AACE;AAAsC;AAExC;AACD;AlH25yCL;AkH15yCI;AlH45yCJ;AkH35yCI;AACE;AACD;AlH65yCL;AkH55yCI;AlH85yCJ;AkH75yCI;AACE;AACD;AACC;AACD;AlH+5yCL;AkH95yCI;AACA;AACD;AAED;AlH+5yCF;AACA;AACA;AkHh6yCyC;AlHk6yCzC;AkHj6yCI;AACE;AACD;AlHm6yCL;AkHl6yCI;AACE;AACD;AlHo6yCL;AkHn6yCI;AACA;AACA;AACA;AlHq6yCJ;AkHn6yCI;AACE;AACA;AACA;AACE;AlHq6yCR;AkH/5yCQ;AACE;AACD;AACF;AACF;AACF;AAED;AlHg6yCF;AACA;AACA;AkHj6yCqD;AAAtB;AAAsB;AlHq6yCrD;AkHp6yCI;AACD;AAED;AlHq6yCF;AACA;AACA;AkHt6yCkE;AAAtB;AAAsB;AlH06yClE;AkHz6yCI;AACD;AAED;AlH06yCF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkH36yCqE;AlH66yCrE;AkH56yCI;AACE;AACA;AACA;AACA;AAAO;AAAuD;AAC5D;AAGI;AAA6C;AAHjD;AADF;AAQD;AlH86yCL;AkH56yCI;AACE;AACE;AACD;AACC;AACD;AACF;AlH86yCL;AkH56yCI;AACE;AACE;AACD;AACF;AlH86yCL;AkH56yCI;AAA6C;AAAA;AAE7C;AlH+6yCJ;AkH96yCI;AACE;AACA;AACA;AACD;AACC;AADK;AAAA;AAIL;AACE;AACA;AACA;AACA;AACA;AALQ;AAOX;AlHg7yCL;AkH/6yCI;AACA;AACD;AAED;AlHg7yCF;AACA;AACA;AkHh7yCI;AACE;AACA;AACD;AlHk7yCL;AkHh7yCI;AACE;AAAA;AACA;AAAA;AAEH;AAED;AlHk7yCF;AACA;AACA;AkHl7yCI;AACD;AAED;AlHm7yCF;AACA;AACA;AkHn7yCI;AACD;AAED;AlHo7yCF;AACA;AACA;AkHp7yCI;AAKE;AACD;AlHk7yCL;AkHh7yCI;AACE;AACA;AACA;AlHk7yCN;AkH/6yCM;AAIE;AACA;AACA;AACD;AACF;AACC;AACD;AACF;AlH86yCH;AACA;AACA;AkH76yCA;AlH+6yCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkHj7yCA;AACE;AACE;AACA;AACA;AACD;AlHm7yCH;AkHl7yCE;AACD;AAED;AlHm7yCA;AACA;AACA;AACA;AkHn7yCO;AACL;AAIE;AAAsB;AAEzB;AlHk7yCD;AACA;AACA;AACA;AACA;AACA;AACA;AmHzy0CA;AnH2y0CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHzy0CA;AnH2y0CA;AACA;AmHzy0CO;AAEP;AnH0y0CA;AmHzy0CA;AnH2y0CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHlz0CE;AnHoz0CF;AACA;AACA;AmHjz0CE;AnHmz0CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHlz0CE;AnHoz0CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHnz0CE;AnHqz0CF;AACA;AACA;AACA;AACA;AACA;AmHpz0CE;AnHsz0CF;AACA;AACA;AACA;AACA;AACA;AmHrz0CE;AnHuz0CF;AACA;AACA;AACA;AACA;AACA;AmHtz0CE;AnHwz0CF;AACA;AACA;AACA;AACA;AACA;AmHvz0CE;AnHyz0CF;AACA;AACA;AACA;AACA;AACA;AmHxz0CE;AnH0z0CF;AACA;AACA;AACA;AACA;AmHzz0CE;AnH2z0CF;AACA;AACA;AACA;AmH1z0CE;AnH4z0CF;AACA;AACA;AACA;AACA;AACA;AmH3z0CE;AnH6z0CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmH5z0CE;AnH8z0CF;AACA;AACA;AACA;AACA;AACA;AACA;AmH7z0CE;AnH+z0CF;AACA;AACA;AACA;AACA;AACA;AACA;AmH9z0CE;AnHg00CF;AACA;AACA;AACA;AACA;AACA;AACA;AmH/z0CE;AnHi00CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHh00CE;AnHk00CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHj00CE;AnHm00CF;AACA;AACA;AACA;AACA;AACA;AACA;AmHl00CE;AnHo00CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHn00CE;AnHq00CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHp00CE;AnHs00CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHr00CE;AnHu00CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHt00CE;AnHw00CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHv00CE;AnHy00CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmH100CqD;AAAtB;AAAsB;AAAE;AAErD;AnH800CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmH/00CkE;AAAtB;AAAsB;AAAE;AAElE;AnHm10CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHl10CE;AnHo10CF;AACA;AACA;AACA;AACA;AACA;AACA;AmHn10CE;AnHq10CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHp10CE;AnHs10CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmHx10CA;AnH010CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoH9l1CA;ApHgm1CA;AoH9l1CA;ApHgm1CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoH9l1CA;ApHgm1CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoHpm1CE;ApHsm1CF;AACA;AACA;AACA;AoHnm1CE;ApHqm1CF;AACA;AACA;AACA;AACA;AoHpm1CE;ApHsm1CF;AACA;AACA;AACA;AACA;AoHrm1CE;ApHum1CF;AACA;AACA;AACA;AACA;AACA;AACA;AoHtm1CE;ApHwm1CF;AACA;AACA;AACA;AACA;AACA;AACA;AoHvm1CE;ApHym1CF;AACA;AACA;AACA;AACA;AACA;AACA;AoHxm1CE;ApH0m1CF;AACA;AACA;AACA;AACA;AACA;AoHzm1CE;ApH2m1CF;AACA;AACA;AACA;AACA;AACA;AoH1m1CE;ApH4m1CF;AACA;AACA;AACA;AACA;AACA;AoH3m1CE;ApH6m1CF;AACA;AACA;AACA;AACA;AACA;AoH5m1CE;ApH8m1CF;AACA;AACA;AACA;AACA;AACA;AACA;AoH7m1CE;ApH+m1CF;AACA;AACA;AACA;AACA;AACA;AACA;AoH9m1CE;ApHgn1CF;AACA;AACA;AACA;AACA;AACA;AoH/m1CE;ApHin1CF;AACA;AACA;AACA;AACA;AoHhn1CE;ApHkn1CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoHjn1CE;ApHmn1CF;AACA;AACA;AACA;AACA;AACA;AoHln1CE;ApHon1CF;AACA;AACA;AACA;AACA;AACA;AoHnn1CE;ApHqn1CF;AACA;AACA;AACA;AACA;AACA;AoHpn1CE;ApHsn1CF;AACA;AACA;AACA;AACA;AACA;AoHrn1CE;ApHun1CF;AACA;AACA;AACA;AACA;AACA;AoHtn1CE;ApHwn1CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoHvn1CE;ApHyn1CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoHxn1CE;ApH0n1CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoHzn1CE;ApH2n1CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoH1n1CE;ApH4n1CF;AACA;AACA;AACA;AACA;AACA;AoH3n1CE;ApH6n1CF;AACA;AACA;AACA;AACA;AACA;AoH5n1CE;ApH8n1CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoH/n1CA;ApHio1CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoHno1CO;AACL;ApHqo1CF;AoHpo1CE;AACE;AAAY;AAAO;ApHwo1CvB;AoHvo1CI;AACE;ApHyo1CN;AoHxo1CM;AACE;AACA;AACD;AACF;AACF;ApH0o1CH;AoHzo1CE;AACD;ApH2o1CD;AACA;AACA;AACA;AACA;AACA;AACA;AqHv21CA;ArHy21CA;AqHx21CA;ArH021CA;AqHz21CA;ArH221CA;AqHv21CA;ArHy21CA;AqHx21CA;ArH021CA;AqHz21CA;ArH221CA;AqH121CA;ArH421CA;AqH321CA;ArH621CA;AqH521CA;ArH821CA;AqHz41CA;ArH241CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqH331CA;AAEA;ArH431CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqH731CE;ArH+31CF;AACA;AqH731CE;AAAiB;ArHg41CnB;AqH/31CI;AACA;AAEA;ArHg41CJ;AqH/31CI;AAEA;AAPe;AASf;AACA;AAEA;AACA;ArH+31CJ;AqH931CI;AACA;AACA;AAEA;ArH+31CJ;AqH931CI;AAEA;ArH+31CJ;AqH931CI;AAEA;ArH+31CJ;AqH931CI;ArHg41CJ;AqH731CI;ArH+31CJ;AqH931CI;AAAiC;AAAA;AAEjC;ArHi41CJ;AACA;AqHj41CI;ArHm41CJ;AqHh41CI;ArHk41CJ;AqHj41CI;AACA;AAGA;ArHi41CJ;AqHh41CI;AACE;AACD;AAED;AACD;AAED;ArHg41CF;AACA;AACA;AACA;AACA;AqHl41CI;AACD;AAED;ArHm41CF;AACA;AACA;AqHn41CI;AACE;AACD;ArHq41CL;AqHp41CI;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ArHo41CJ;AqHn41CI;AACA;AACA;AACA;ArHq41CJ;AqHn41CI;AACE;AAAK;AAAA;AAD4B;ArHy41CvC;AqHp41CI;AACD;AAED;ArHq41CF;AACA;AACA;AqHr41CI;AACA;AACD;AAED;ArHs41CF;AACA;AACA;AqHt41CI;AACA;AACD;AAED;ArHu41CF;AACA;AACA;AqHv41CI;AACA;AACD;AAED;ArHw41CF;AACA;AACA;AqHx41CI;AACE;AACD;ArH041CL;AACA;AqHz41CI;AAGA;AACD;AAED;ArHw41CF;AACA;AACA;AqHx41CI;AACD;AAED;ArHy41CF;AACA;AACA;AqHz41CI;AACD;AAED;ArH041CF;AACA;AACA;AqH141CI;AACD;AAED;ArH241CF;AACA;AACA;AqH341CI;AACD;AAED;ArH441CF;AACA;AACA;AqH541CI;AACA;AACE;AADgC;AAGnC;AAED;ArH641CF;AACA;AACA;AqH741CI;AACE;AACD;AACF;AAED;ArH841CF;AACA;AACA;AqH941CI;AACE;AACD;AACF;AAED;ArH+41CF;AACA;AACA;AqH/41CI;AACA;AACD;AAED;ArHg51CF;AACA;AACA;AqHh51CI;AACA;AACD;AAED;ArHi51CF;AACA;AACA;AqHj51CI;AACA;AACD;AAED;ArHk51CF;AACA;AACA;AqHl51CI;AACE;AAAgB;AAAO;AACvB;AAAiB;AAAO;AAFnB;AAIR;AAED;ArHu51CF;AACA;AACA;AqHv51CI;AAAqB;AAAO;AAC7B;AAED;ArH051CF;AACA;AACA;AqH151CI;AACA;AACA;AACD;AAED;ArH251CF;AACA;AACA;AqH351CI;AAAqB;AAAO;AAC7B;AAED;ArH851CF;AACA;AACA;AqH951CI;AAAqB;AAAO;AAC7B;AAED;ArHi61CF;AACA;AACA;AqHj61CI;AACA;ArHm61CJ;AqHr61CqB;AAGQ;AAAO;AAHf;AAMjB;AACA;AAEA;AACA;ArHo61CJ;AACA;AqHp61CI;AAEA;AACA;AAOD;AAED;ArH851CF;AACA;AACA;AqH751CE;ArH+51CF;AACA;AACA;AqH/51CI;AAAa;AAAO;AACpB;AAEA;AAEA;AAMD;AAED;ArH251CF;AACA;AACA;AqH351CI;AACD;AAED;ArH451CF;AACA;AACA;AqH551CI;AACA;AACA;AAAc;AAAO;AACtB;AAED;ArH+51CF;AACA;AACA;AACA;AACA;AACA;AqH/51CI;AACA;AACA;AACA;AACA;AACA;AAAkB;AAAO;AACvB;AAAc;AAAO;ArHq61C3B;AqHp61CM;AACE;AACD;AACF;ArHs61CL;AqHr61CI;AACE;AACD;AACF;AAED;ArHs61CF;AACA;AACA;AqHt61CI;AACD;AAED;ArHu61CF;AACA;AACA;AqHv61CI;AACD;ArHy61CH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsH9u2CA;AtHgv2CA;AsH/u2CA;AtHiv2CA;AsHhv2CA;AtHkv2CA;AsH9u2CA;AtHgv2CA;AsH/u2CA;AtHiv2CA;AsHhv2CA;AtHkv2CA;AsH1w2CA;AtH4w2CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsH/v2CA;AAEA;AtHgw2CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsHjw2CE;AtHmw2CF;AACA;AsHjw2CE;AAAoB;AtHow2CtB;AsHnw2CI;AACA;AAEA;AtHow2CJ;AsHnw2CI;AAEA;AtHow2CJ;AsHnw2CI;AAEA;AtHow2CJ;AsHnw2CI;AAEA;AtHow2CJ;AsHnw2CI;AAEA;AtHow2CJ;AACA;AACA;AACA;AsHnw2CI;AAEA;AtHow2CJ;AsHnw2CI;AtHqw2CJ;AsHlw2CI;AtHow2CJ;AsHnw2CI;AAAiC;AAAA;AtHuw2CrC;AsHrw2CI;AACD;AAED;AtHsw2CF;AACA;AACA;AACA;AACA;AsHxw2CI;AAE6B;AAAO;AAElC;AACA;AACA;AACA;AACA;AAA2B;AAAO;AACnC;AtH2w2CL;AsH1w2CI;AACD;AAED;AtH2w2CF;AACA;AACA;AsH3w2CI;AACA;AACD;AAED;AtH4w2CF;AACA;AACA;AsH5w2CI;AACA;AACD;AAED;AtH6w2CF;AACA;AACA;AACA;AsH3w2CE;AtH6w2CF;AACA;AACA;AsH7w2CI;AACD;AAED;AtH8w2CF;AACA;AACA;AsH9w2CI;AACD;AAED;AtH+w2CF;AACA;AACA;AsH/w2CI;AACD;AAED;AtHgx2CF;AACA;AACA;AsHhx2CI;AACD;AAED;AtHix2CF;AACA;AACA;AsHjx2CI;AACD;AAED;AtHkx2CF;AACA;AACA;AsHlx2CI;AACD;AAED;AtHmx2CF;AACA;AACA;AsHnx2CI;AACE;AADoD;AAGvD;AAED;AtHox2CF;AACA;AACA;AsHpx2CI;AACE;AACD;AACF;AAED;AtHqx2CF;AACA;AACA;AsHrx2CI;AACE;AACD;AACF;AAED;AtHsx2CF;AACA;AACA;AsHtx2CI;AACA;AAGD;AAED;AtHqx2CF;AACA;AACA;AsHrx2CI;AACA;AAGD;AAED;AtHox2CF;AACA;AACA;AsHpx2CI;AACA;AACD;AAED;AtHqx2CF;AACA;AACA;AsHrx2CI;AACA;AACA;AACA;AACA;AAA0B;AAAO;AACjC;AAA2B;AAAO;AtH2x2CtC;AsH1x2CI;AACE;AAAQ;AAAiB;AAAlB;AACR;AtH+x2CL;AsH9x2CI;AACA;AAAQ;AAAU;AAAO;AAAa;AAAW;AAAO;AAAjD;AACR;AAED;AtHsy2CF;AACA;AACA;AsHty2CI;AAC6B;AAAO;AACzB;AAAO;AtH0y2CtB;AsH7y2CiB;AAAA;AtHgz2CjB;AsH3y2CI;AAAmC;AAAO;AAC3C;AAED;AtH8y2CF;AACA;AACA;AsH9y2CI;AACA;AACA;AACD;AAED;AtH+y2CF;AACA;AACA;AsH/y2CI;AAAkC;AAAO;AAC1C;AAED;AtHkz2CF;AACA;AACA;AsHlz2CI;AAAkC;AAAO;AAC1C;AAED;AtHqz2CF;AACA;AACA;AsHrz2CI;AACA;AACA;AACA;AACA;AACA;AAAqB;AAAO;AAG5B;AACA;AACA;AACA;AtHuz2CJ;AsHtz2CI;AAGA;AtHsz2CJ;AsHrz2CI;AAIA;AACA;AAOD;AAED;AtH6y2CF;AACA;AACA;AACA;AsH3y2CE;AtH6y2CF;AACA;AACA;AsH7y2CI;AAAa;AAAO;AACpB;AAEA;AAEA;AAMD;AAED;AtHyy2CF;AACA;AACA;AsHzy2CI;AACD;AAED;AtH0y2CF;AACA;AACA;AsH1y2CI;AAA2B;AAAO;AACnC;AAED;AtH6y2CF;AACA;AACA;AsH7y2CI;AtH+y2CJ;AsH9y2CI;AAAQ;AAAO;AACb;AAAW;AAAO;AACnB;AtHoz2CL;AsHnz2CI;AAGE;AACA;AACA;AACA;AACA;AAEA;AACD;AtHkz2CL;AsHjz2CI;AACD;AAED;AtHkz2CF;AACA;AACA;AsHlz2CI;AACD;AtHoz2CH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuHpm3CA;AvHsm3CA;AuHrm3CA;AvHum3CA;AuHtm3CA;AvHwm3CA;AuHvm3CA;AvHym3CA;AuHxm3CA;AvH0m3CA;AuHzm3CA;AvH2m3CA;AuH1m3CA;AvH4m3CA;AuH3m3CA;AvH6m3CA;AuH5m3CA;AvH8m3CA;AuH7m3CA;AvH+m3CA;AuH9m3CA;AvHgn3CA;AuH3m3CA;AvH6m3CA;AuH5m3CA;AvH8m3CA;AuH7m3CA;AvH+m3CA;AuH9m3CA;AvHgn3CA;AuH/m3CA;AvHin3CA;AuHhn3CA;AvHkn3CA;AuH9m3CA;AvHgn3CA;AuH/m3CA;AvHin3CA;AuH5m3CA;AvH8m3CA;AuH7m3CA;AvH+m3CA;AuH9p3CA;AvHgq3CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuH5n3CA;AAEA;AvH6n3CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuH9n3CE;AvHgo3CF;AACA;AACA;AACA;AuH9n3CE;AAAqC;AvHio3CvC;AuHjo3CuC;AAGnC;AvHio3CJ;AuHho3CI;AAEA;AvHio3CJ;AACA;AACA;AACA;AuHho3CI;AAEA;AvHio3CJ;AuHho3CI;AAEA;AvHio3CJ;AuHho3CI;AAEA;AvHio3CJ;AACA;AACA;AACA;AuHho3CI;AAEA;AvHio3CJ;AACA;AACA;AACA;AACA;AACA;AuHho3CI;AAEA;AvHio3CJ;AuHho3CI;AAAK;AAAO;AAEZ;AvHmo3CJ;AuHlo3CI;AAEA;AvHmo3CJ;AuHlo3CI;AAAK;AAAO;AAEZ;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAEA;AvHqo3CJ;AuHpo3CI;AAOA;AAAwB;AAAA;AAExB;AACA;AACA;AAIA;AAEA;AACA;AAEA;AAEA;AvH2n3CJ;AuH1n3CI;AACA;AACA;AvH4n3CJ;AuHzn3CI;AvH2n3CJ;AuH1n3CI;AACE;AACD;AvH4n3CL;AuH3n3CI;AACE;AACD;AACC;AACD;AvH6n3CL;AuH5n3CI;AACE;AACD;AvH8n3CL;AuH7n3CI;AACE;AACD;AvH+n3CL;AACA;AuH7n3CI;AACE;AACD;AvH+n3CL;AACA;AuH7n3CI;AACE;AACE;AACE;AAAO;AAAA;AAD8B;AAGvC;AACE;AACE;AAAK;AAAA;AAD0B;AAGlC;AACF;AAEA;AACF;AACF;AAED;AvHio3CF;AACA;AACA;AACA;AACA;AuHno3CI;AACD;AAED;AvHoo3CF;AACA;AACA;AuHpo3CI;AACD;AAED;AvHqo3CF;AACA;AACA;AuHro3CI;AvHuo3CJ;AuHto3CI;AACE;AvHwo3CN;AuHvo3CM;AACE;AvHyo3CR;AuHxo3CQ;AACE;AACA;AACA;AACD;AACF;AACC;AACD;AACF;AACF;AAED;AvHyo3CF;AACA;AACA;AuHzo3CI;AACD;AAED;AvH0o3CF;AACA;AACA;AuH1o3CI;AAAS;AAAO;AACd;AAAK;AAAO;AACb;AvHgp3CL;AuH/o3CI;AAAY;AAAO;AACpB;AAED;AvHkp3CF;AACA;AACA;AuHlp3CI;AAAS;AAAO;AACd;AAAK;AAAO;AACb;AvHwp3CL;AuHvp3CI;AAAY;AAAO;AACpB;AAED;AvH0p3CF;AACA;AACA;AuH1p3CI;AAAK;AAAO;AACZ;AACD;AAED;AvH6p3CF;AACA;AACA;AuH7p3CI;AACE;AACD;AACF;AAED;AvH8p3CF;AACA;AACA;AuH9p3CI;AACE;AACD;AvHgq3CL;AuH/p3CI;AvHiq3CJ;AuHhq3CI;AACE;AACA;AvHkq3CN;AuHjq3CM;AAIE;AACE;AACD;AACF;AACF;AvHgq3CL;AuH/p3CI;AACD;AAED;AvHgq3CF;AACA;AACA;AuHhq3CI;AACD;AAED;AvHiq3CF;AACA;AACA;AuHjq3CI;AACD;AAED;AvHkq3CF;AACA;AACA;AuHlq3CI;AACD;AAED;AvHmq3CF;AACA;AACA;AuHnq3CI;AACD;AAED;AvHoq3CF;AACA;AACA;AuHpq3CI;AACD;AAED;AvHqq3CF;AACA;AACA;AuHrq3CI;AACD;AAED;AvHsq3CF;AACA;AACA;AuHtq3CI;AACE;AACA;AACA;AACA;AAMD;AvHmq3CL;AuHlq3CI;AACD;AAED;AvHmq3CF;AACA;AACA;AuHnq3CI;AACA;AvHqq3CJ;AuHlq3CI;AvHoq3CJ;AuHnq3CI;AACE;AACA;AAKA;AAMD;AvH4p3CL;AuH1p3CI;AACD;AAED;AvH2p3CF;AACA;AACA;AuH3p3CI;AACE;AAAU;AAAO;AAClB;AAED;AACA;AvH8p3CJ;AuH7p3CI;AACE;AACE;AAAoB;AAAO;AAC5B;AACF;AvHiq3CL;AuH/p3CI;AACE;AACA;AvHiq3CN;AuHhq3CM;AACE;AACD;AvHkq3CP;AuHjq3CM;AACD;AACF;AAED;AvHkq3CF;AACA;AACA;AuHlq3CI;AACD;AAED;AvHmq3CF;AACA;AACA;AuHnq3CI;AACD;AAED;AvHoq3CF;AACA;AACA;AuHrq3C0B;AvHuq3C1B;AuHtq3CI;AAA0D;AAAA;AAG3D;AAED;AvHuq3CF;AACA;AACA;AACA;AACA;AACA;AuHxq3C2C;AvH0q3C3C;AuHzq3CI;AACA;AAAuC;AAAA;AAIvC;AAAqC;AAAA;AAGtC;AAED;AvHyq3CF;AACA;AACA;AuH1q3CuE;AvH4q3CvE;AuH5q3CuE;AAAtC;AAAsC;AvHgr3CvE;AuH/q3CI;AAKA;AAA0D;AAAA;AAS3D;AAED;AvHsq3CF;AACA;AACA;AuHvq3C2E;AvHyq3C3E;AuHxq3CI;AAKA;AvHsq3CJ;AuH5q3C2E;AAAA;AvH+q3C3E;AuHnq3CI;AvHqq3CJ;AuHpq3CI;AACE;AACE;AACA;AvHsq3CR;AuHrq3CM;AACE;AACA;AvHuq3CR;AuHtq3CM;AACE;AACA;AATJ;AvHkr3CJ;AuHtq3CI;AACE;AACA;AvHwq3CN;AuHvq3CM;AACE;AACD;AvHyq3CP;AuHxq3CM;AAOD;AACF;AAED;AvHmq3CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuH9p3CI;AvHgq3CJ;AuHhq3CI;AADA;AACA;AvHoq3CJ;AuHnq3CI;AAKA;AvHiq3CJ;AuHhq3CI;AACA;AAGI;AACD;AAID;AACD;AACF;AAED;AvH4p3CF;AACA;AACA;AACA;AACA;AACA;AuH7p3CqC;AvH+p3CrC;AuH9p3CI;AACE;AAAA;AAIH;AAED;AvH6p3CF;AACA;AACA;AACA;AACA;AACA;AuH7p3CI;AACE;AACA;AACD;AvH+p3CL;AuH9p3CI;AACE;AAAQ;AAAO;AAChB;AACF;AAED;AvHiq3CF;AACA;AACA;AACA;AACA;AACA;AuHlq3CgC;AvHoq3ChC;AuHnq3CI;AACE;AAAkB;AAAA;AACnB;AvHuq3CL;AuHtq3CI;AAAkC;AAAc;AAAO;AAArB;AACnC;AAED;AvH2q3CF;AACA;AACA;AACA;AACA;AACA;AuH3q3CI;AACD;AAED;AvH4q3CF;AACA;AACA;AuH5q3CI;AACD;AAED;AvH6q3CF;AACA;AACA;AuH7q3CI;AACD;AAED;AvH8q3CF;AACA;AACA;AuH9q3CI;AACD;AAED;AvH+q3CF;AACA;AACA;AuH/q3CI;AACD;AAED;AvHgr3CF;AACA;AACA;AuHhr3CI;AAGE;AAAmB;AAGrB;AACA;AvH+q3CJ;AuH7q3CI;AACE;AAGD;AvH6q3CL;AuH3q3CI;AACD;AAED;AvH4q3CF;AACA;AACA;AuH5q3CI;AAGE;AAAmB;AAGrB;AACA;AvH2q3CJ;AuHzq3CI;AACE;AAGD;AvHyq3CL;AuHvq3CI;AACD;AAED;AvHwq3CF;AACA;AACA;AACA;AACA;AACA;AuHxq3CI;AACD;AAED;AvHyq3CF;AACA;AACA;AACA;AACA;AACA;AACA;AuHzq3CI;AvH2q3CJ;AuHzq3CI;AACE;AAMA;AACD;AACF;AAED;AvHqq3CF;AACA;AACA;AACA;AACA;AACA;AACA;AuHrq3CI;AvHuq3CJ;AuHrq3CI;AACE;AACD;AACF;AAED;AvHsq3CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuHtq3CI;AAKA;AAGI;AACC;AAGN;AAED;AvH+p3CF;AACA;AACA;AuH/p3CI;AACA;AACD;AAED;AvHgq3CF;AACA;AACA;AuHhq3CI;AACA;AACD;AAED;AvHiq3CF;AACA;AACA;AuHlq3CkB;AvHoq3ClB;AuHpq3CkB;AAAA;AAGd;AAGA;AACA;AvHmq3CJ;AuHlq3CI;AACE;AACA;AAEA;AACD;AAED;AACE;AvHkq3CN;AuHjq3CM;AACD;AACF;AAED;AvHkq3CF;AACA;AACA;AuHnq3CgB;AvHqq3ChB;AuHrq3CgB;AAAA;AAIZ;AACE;AvHqq3CN;AuHpq3CM;AACD;AACF;AAED;AvHqq3CF;AACA;AACA;AuHtq3CmB;AvHwq3CnB;AuHvq3CI;AAAqC;AAAO;AAC5C;AAAuD;AAAO;AvH6q3ClE;AuH5q3CI;AACE;AACA;AACA;AACA;AACD;AvH8q3CL;AuH7q3CI;AACE;AACE;AACD;AACF;AACF;AAED;AvH8q3CF;AACA;AACA;AuH9q3CI;AvHgr3CJ;AuH/q3CI;AACE;AACA;AACD;AAED;AvHgr3CJ;AACA;AuHhr3CI;AACE;AACA;AAF8D;AAIhE;AACD;AAED;AvHir3CF;AACA;AACA;AuHjr3CI;AACE;AACD;AvHmr3CL;AuHlr3CI;AACD;AAED;AvHmr3CF;AACA;AACA;AuHnr3CI;AACD;AAED;AvHor3CF;AACA;AACA;AuHpr3CI;AACD;AAED;AvHqr3CF;AACA;AACA;AuHrr3CI;AACD;AAED;AvHsr3CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuHtr3CI;AvHwr3CJ;AuHvr3CI;AACE;AACA;AACA;AACD;AvHyr3CL;AuHxr3CI;AACD;AAED;AvHyr3CF;AACA;AACA;AACA;AACA;AACA;AuHzr3CI;AACE;AACA;AACD;AvH2r3CL;AuH1r3CI;AACE;AAAqB;AAAiC;AvH8r3C5D;AuH3r3CM;AACE;AACD;AACF;AvH6r3CL;AuH5r3CI;AACD;AAED;AvH6r3CF;AACA;AACA;AACA;AACA;AACA;AuH7r3CI;AACA;AACD;AAED;AvH8r3CF;AACA;AACA;AACA;AACA;AACA;AuH/r3C+B;AvHis3C/B;AuHhs3CI;AACA;AACA;AACA;AvHks3CJ;AuHjs3CI;AvHms3CJ;AuHjs3CI;AACE;AACD;AvHms3CL;AuHjs3CI;AACA;AAEA;AvHks3CJ;AuHjs3CI;AACE;AACA;AACD;AvHms3CL;AuHls3CI;AACE;AACD;AACF;AAED;AvHms3CF;AACA;AACA;AACA;AACA;AACA;AuHns3CI;AACE;AACD;AACC;AACD;AACF;AAED;AvHos3CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuHrs3CoD;AvHus3CpD;AuHts3CI;AvHws3CJ;AuHvs3CI;AACE;AACD;AvHys3CL;AACA;AuHxs3CI;AACA;AAGI;AvHws3CR;AuHvs3CQ;AACD;AAID;AACD;AACF;AAED;AvHqs3CF;AACA;AACA;AACA;AACA;AACA;AACA;AuHrs3CI;AACA;AACA;AACA;AAcA;AACE;AACA;AACA;AACA;AACA;AACA;AAN0B;AAQ7B;AAED;AvHyr3CF;AACA;AACA;AuH1r3CY;AvH4r3CZ;AuH3r3CI;AACA;AACA;AACA;AvH6r3CJ;AuH5r3CI;AACE;AACA;AACA;AACA;AACD;AvH8r3CL;AuH7r3CI;AvH+r3CJ;AuH9r3CI;AACE;AACA;AvHgs3CN;AuH9r3CM;AACE;AACE;AACD;AACF;AACF;AvHgs3CL;AuH/r3CI;AACD;AAED;AvHgs3CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuHjs3CgD;AvHms3ChD;AuHls3CI;AACA;AvHos3CJ;AuHns3CI;AACA;AACA;AvHqs3CJ;AuHps3CI;AACE;AACD;AvHss3CL;AuHrs3CI;AvHus3CJ;AuHns3CI;AACE;AAAc;AAAkB;AAChC;AACD;AACC;AACE;AAAA;AAMH;AACF;AAED;AvHks3CF;AACA;AACA;AACA;AACA;AACA;AuHns3CuB;AvHqs3CvB;AuHps3CI;AACE;AACA;AACE;AvHss3CR;AuHrs3CQ;AAEQ;AAAD;AACL;AAAmB;AAEtB;AACF;AACF;AAED;AvHss3CF;AACA;AACA;AuHvs3CY;AvHys3CZ;AuHxs3CI;AACA;AACA;AvH0s3CJ;AuHzs3CI;AACA;AACE;AvH2s3CN;AuH1s3CM;AAAc;AAAgB;AvH8s3CpC;AuH7s3CM;AvH+s3CN;AuH9s3CM;AACE;AACE;AACA;AACA;AAH0B;AAK7B;AACF;AACF;AvHgt3CH;AACA;AACA;AuH/s3CA;AvHit3CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuHnt3CO;AACL;AACA;AvHqt3CF;AuHpt3CE;AACE;AACD;AvHst3CH;AuHrt3CE;AvHut3CF;AuHtt3CE;AACE;AACA;AACA;AACA;AACA;AvHwt3CJ;AuHvt3CI;AACE;AACD;AACF;AvHyt3CH;AuHxt3CE;AACD;AAED;AvHyt3CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuHzt3CO;AACL;AACA;AvH2t3CF;AuH1t3CE;AACE;AACE;AACD;AvH4t3CL;AuH3t3CI;AACE;AACD;AACC;AACD;AACF;AvH6t3CH;AuH5t3CE;AACD;AAED;AvH6t3CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuH7t3CO;AACL;AACA;AvH+t3CF;AuH9t3CE;AACE;AACE;AvHgu3CN;AuH/t3CM;AACE;AAAY;AAAuB;AACpC;AACC;AACD;AACF;AACF;AvHmu3CH;AuHlu3CE;AACE;AACD;AvHou3CH;AuHnu3CE;AACD;AAED;AvHou3CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuHpu3CA;AAA8E;AAAX;AAAW;AvHyu3C9E;AuHxu3CE;AACA;AACD;AAED;AvHyu3CA;AACA;AACA;AACA;AACA;AACA;AuHzu3CA;AACE;AvH2u3CF;AuH5u3CgC;AAG9B;AvH4u3CF;AuH3u3CE;AAIE;AACD;AACC;AACD;AvH0u3CH;AuHzu3CE;AACD;AAED;AvH0u3CA;AACA;AACA;AACA;AACA;AuH1u3CA;AACE;AvH4u3CF;AACA;AuH1u3CE;AvH4u3CF;AuH1u3CE;AvH4u3CF;AACA;AACA;AACA;AACA;AACA;AuH1u3CE;AAbmB;AAgBrB;AvH2u3CA;AACA;AACA;AACA;AACA;AuH1u3CA;AACE;AvH4u3CF;AuH3u3CE;AAIE;AACD;AvH0u3CH;AuHzu3CE;AAEA;AvH0u3CF;AuHzu3CE;AAKE;AACD;AvHuu3CH;AACA;AuHru3CE;AACE;AACD;AvHuu3CH;AACA;AuHru3CE;AACE;AACD;AvHuu3CH;AuHtu3CE;AACD;AAED;AvHuu3CA;AACA;AACA;AACA;AuHvu3CO;AACL;AAIE;AAAsB;AAEzB;AvHsu3CD;AACA;AACA;AACA;AACA;AACA;AACA;AwH/45CA;AxHi55CA;AACA;AACA;AwHj55CA;AxHm55CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHj55CO;AAEP;AxHk55CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHl55CO;AAEP;AxHm55CA;AwHl55CA;AxHo55CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwH/55CE;AxHi65CF;AACA;AACA;AACA;AwH955CE;AxHg65CF;AACA;AACA;AACA;AACA;AACA;AwH/55CE;AxHi65CF;AACA;AACA;AACA;AACA;AACA;AwHh65CE;AxHk65CF;AACA;AACA;AACA;AACA;AACA;AwHj65CE;AxHm65CF;AACA;AACA;AACA;AACA;AACA;AwHl65CE;AxHo65CF;AACA;AACA;AACA;AACA;AACA;AwHn65CE;AxHq65CF;AACA;AACA;AACA;AACA;AACA;AwHp65CE;AxHs65CF;AACA;AACA;AACA;AACA;AACA;AwHr65CE;AxHu65CF;AACA;AACA;AACA;AACA;AACA;AwHt65CE;AxHw65CF;AACA;AACA;AACA;AACA;AACA;AACA;AwHv65CE;AxHy65CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHx65CE;AxH065CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHz65CE;AxH265CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwH165CE;AxH465CF;AACA;AACA;AACA;AACA;AACA;AwH365CE;AxH665CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwH565CE;AxH865CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwH765CE;AxH+65CF;AACA;AACA;AACA;AACA;AACA;AwH965CE;AxHg75CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwH/65CE;AxHi75CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHh75CE;AxHk75CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHn75CuE;AAAtC;AAAsC;AAAE;AAEvE;AxHu75CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHt75CE;AxHw75CF;AACA;AACA;AACA;AACA;AwHv75CE;AxHy75CF;AACA;AACA;AACA;AACA;AACA;AACA;AwHx75CE;AxH075CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHz75CE;AxH275CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwH175CE;AxH475CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwH375CE;AxH675CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwH575CE;AxH875CF;AACA;AACA;AACA;AACA;AwH775CE;AxH+75CF;AACA;AACA;AACA;AACA;AwH975CE;AxHg85CF;AACA;AACA;AACA;AACA;AACA;AwH/75CE;AxHi85CF;AACA;AACA;AACA;AACA;AwHh85CE;AxHk85CF;AACA;AACA;AACA;AACA;AwHj85CE;AxHm85CF;AACA;AACA;AACA;AACA;AACA;AACA;AwHl85CE;AxHo85CF;AACA;AACA;AACA;AACA;AACA;AACA;AwHn85CE;AxHq85CF;AACA;AACA;AACA;AACA;AwHp85CE;AxHs85CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHr85CE;AxHu85CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwHz85CA;AxH285CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHnw6CA;AzHqw6CA;AyHpw6CA;AzHsw6CA;AyHrw6CA;AzHuw6CA;AyHtw6CA;AzHww6CA;AyHvw6CA;AzHyw6CA;AyHpw6CA;AzHsw6CA;AyHrw6CA;AzHuw6CA;AyHtw6CA;AzHww6CA;AyHvw6CA;AzHyw6CA;AyHry6CA;AzHuy6CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHvx6CA;AACA;AAEA;AzHwx6CA;AACA;AACA;AyHvx6CA;AAEA;AzHwx6CA;AACA;AACA;AACA;AACA;AACA;AyHvx6CA;AAEA;AzHwx6CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHzx6CE;AzH2x6CF;AACA;AyHzx6CE;AACE;AACA;AAEA;AzH0x6CJ;AyHzx6CI;AAEA;AzH0x6CJ;AyHzx6CI;AAEA;AzH0x6CJ;AACA;AACA;AACA;AyHzx6CI;AAEA;AzH0x6CJ;AACA;AACA;AACA;AyHzx6CI;AAEA;AzH0x6CJ;AACA;AACA;AACA;AyHzx6CI;AAEA;AzH0x6CJ;AACA;AACA;AACA;AyHzx6CI;AAEA;AzH0x6CJ;AACA;AACA;AACA;AyHzx6CI;AAEA;AzH0x6CJ;AyHzx6CI;AAEA;AzH0x6CJ;AyHzx6CI;AAEA;AzH0x6CJ;AyHzx6CI;AAEA;AzH0x6CJ;AACA;AACA;AACA;AACA;AACA;AACA;AyHzx6CI;AAMA;AzHsx6CJ;AACA;AACA;AACA;AACA;AACA;AACA;AyHrx6CI;AAIE;AACA;AAIF;AzHix6CJ;AyHhx6CI;AzHkx6CJ;AyHjx6CI;AzHmx6CJ;AyHlx6CI;AACE;AACA;AACA;AAGD;AACC;AACA;AACA;AAID;AAED;AzH8w6CJ;AACA;AyH9w6CI;AACD;AAED;AzH+w6CF;AACA;AACA;AACA;AACA;AyHjx6CI;AAID;AAED;AzH+w6CF;AACA;AACA;AyH/w6CI;AACE;AACD;AACF;AAED;AzHgx6CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHhx6CI;AACA;AACA;AACD;AAED;AzHix6CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHjx6CI;AzHmx6CJ;AyHlx6CI;AACE;AACD;AzHox6CL;AyHnx6CI;AACA;AACA;AACD;AAED;AzHox6CF;AACA;AACA;AACA;AACA;AACA;AACA;AyHrx6CmB;AzHux6CnB;AyHtx6CI;AAAO;AAA0C;AAC/C;AACD;AAFD;AAGD;AAED;AzH0x6CF;AACA;AACA;AACA;AACA;AACA;AyH1x6CI;AACE;AAAoB;AACpB;AAFO;AAIV;AAED;AzH4x6CF;AACA;AACA;AACA;AACA;AACA;AACA;AyH5x6CI;AACE;AACA;AAFqB;AAIxB;AAED;AzH6x6CF;AACA;AACA;AACA;AACA;AACA;AyH7x6CI;AACE;AACA;AzH+x6CN;AyHjy6Ca;AAIV;AAED;AzH+x6CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHhy6C2B;AzHky6C3B;AyHjy6CI;AACE;AACE;AACD;AACF;AACF;AAED;AzHky6CF;AACA;AACA;AACA;AACA;AACA;AACA;AyHly6CI;AACD;AAED;AzHmy6CF;AACA;AACA;AACA;AACA;AACA;AACA;AyHny6CI;AACA;AACE;AACD;AzHqy6CL;AACA;AyHny6CI;AACE;AACD;AzHqy6CL;AACA;AyHny6CI;AACE;AACA;AACD;AzHqy6CL;AyHny6CI;AACD;AAED;AzHoy6CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHpy6CI;AACA;AACE;AAIA;AACD;AzHmy6CL;AyHly6CI;AACA;AACD;AAED;AzHmy6CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHpy6CoC;AzHsy6CpC;AyHry6CI;AAAO;AAAkD;AACvD;AACD;AAFD;AAGD;AAED;AzHyy6CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyH1y6CyD;AzH4y6CzD;AyH3y6CI;AACE;AACD;AzH6y6CL;AyH5y6CI;AACE;AACA;AzH8y6CN;AyH7y6CM;AACE;AACE;AACA;AzH+y6CV;AyH9y6CU;AACE;AACD;AACC;AACD;AACC;AACA;AACD;AACF;AAZ2C;AzH6z6CpD;AyH/y6CM;AACD;AACF;AAED;AzHgz6CF;AACA;AACA;AyHhz6CI;AACE;AACD;AzHkz6CL;AACA;AyHjz6CI;AACA;AACA;AACD;AAED;AzHkz6CF;AACA;AACA;AyHlz6CI;AACE;AACA;AACD;AACC;AACD;AACF;AAED;AzHmz6CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHnz6CI;AACA;AACA;AAHmB;AAAA;AAAA;AAMnB;AACA;AzHsz6CJ;AyHpz6CI;AACA;AzHsz6CJ;AyHrz6CI;AACE;AACE;AACE;AACA;AACD;AACF;AACF;AzHuz6CL;AyHtz6CI;AACE;AACE;AACD;AACF;AzHwz6CL;AACA;AyHvz6CI;AACA;AACA;AACA;AzHyz6CJ;AyHxz6CI;AACE;AACD;AACF;AAED;AzHyz6CF;AACA;AACA;AACA;AACA;AyH1z6CY;AzH4z6CZ;AyH3z6CI;AzH6z6CJ;AyH3z6CI;AACE;AACD;AzH6z6CL;AyH5z6CI;AACA;AACE;AAEA;AzH6z6CN;AyH5z6CM;AACA;AzH8z6CN;AyH7z6CM;AACD;AACF;AzH+z6CH;AACA;AACA;AyH9z6CA;AzHg06CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyHl06CA;AACE;AzHo06CF;AyHn06CE;AACE;AzHq06CJ;AyHp06CI;AACE;AAKD;AACF;AACC;AACA;AACD;AzHk06CH;AyHj06CE;AACD;AAED;AzHk06CA;AACA;AACA;AACA;AACA;AyHl06CO;AACL;AACA;AACD;AAED;AzHm06CA;AACA;AACA;AACA;AyHn06CO;AACL;AACA;AACD;AzHq06CD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Hhz7CA;A1Hkz7CA;A0Hjz7CA;A1Hmz7CA;A0H3y7CA;A1H6y7CA;A0H5y7CA;A1H8y7CA;A0H7y7CA;A1H+y7CA;A0H9y7CA;A1Hgz7CA;A0H507CA;A1H807CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0H9z7CA;A1Hg07CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Hh07CE;A1Hk07CF;AACA;A0Hh07CE;AACE;AACA;A1Hk07CJ;A0Hh07CI;AAGA;AACA;AACA;AACA;AACA;A1Hg07CJ;A0H/z7CI;A1Hi07CJ;AACA;A0Hj07CI;AAGD;AAED;A1Hg07CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Hn07CsB;AAAA;A1Hs07CtB;A0Hr07CI;AAME;AACE;AACD;AAED;AACA;A1Hi07CN;AACA;A0Hj07CM;AACE;AACE;AAA0C;AAC5C;AACD;A1Ho07CP;A0Hn07CM;AACD;AACF;AAED;A1Ho07CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Hr07CkC;AAAX;AAAW;A1Hy07ClC;A0Hx07CI;AACA;AACA;AACU;AAAA;AAEN;AACA;AAKD;AAEJ;AAED;A1Ho07CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Hp07CI;AACD;AAED;A1Hq07CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Hr07CI;AACD;AAED;A1Hs07CF;AACA;AACA;AACA;AACA;AACA;AACA;A0Ht07CI;AACA;AAAoD;AAAA;AAGrD;AAED;A1Hu07CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Hv07CI;AAAwD;AAAA;AAGzD;AAED;A1Hw07CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0Hx07CI;AACD;A1H007CH;AACA;AACA;A0Hz07CA;A1H207CA;AACA;AACA;AACA;AACA;AACA;AACA;A0H707CO;AACL;AACA;AACD;AAED;A1H807CA;AACA;AACA;AACA;A0H907CO;AACL;AACD;A1Hg17CD;AACA;AACA;AACA;AACA;AACA;AACA;A2Hnh8CA;A3Hqh8CA;A2H7g8CA;A3H+g8CA;A2Hvi8CA;A3Hyi8CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Hxh8CA;AACO;A3H0h8CP;AACA;AACA;AACA;AACA;AACA;AACA;A2H7h8CE;A3H+h8CF;AACA;AACA;AACA;A2H7h8CE;A3H+h8CF;AACA;AACA;AACA;AACA;A2H7h8CI;AAAO;AAAiF;AAAxF;AAKD;AAED;A3H6h8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2H7h8CI;AAAO;AAAiF;AAAxF;AAKD;AAED;A3H6h8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2H7h8CI;AAAO;AAA+C;AAAtD;AAKD;AAED;A3H6h8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2H7h8CI;AAAO;AAA+C;AAAtD;AAKD;AAED;A3H6h8CF;AACA;AACA;AACA;AACA;AACA;A2H7h8CI;AAAO;AAAqD;AAA5D;AAID;AAED;A3H8h8CF;AACA;AACA;AACA;AACA;AACA;A2H9h8CI;AAAO;AAAiE;AAAxE;AAID;AAED;A3H+h8CF;AACA;AACA;AACA;AACA;AACA;A2H/h8CI;AAAO;AAAkF;AAAzF;AAKD;AAED;A3H+h8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2H/h8CI;AAAO;AAAqD;AAA5D;AAID;AAED;A3Hgi8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2Hhi8CI;AACD;AAED;A3Hii8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2Hli8CyD;AAAvB;AAAuB;A3Hsi8CzD;A2Hri8CI;AACE;AACA;AACA;AAAmC;AAAO;AAI3C;A3Hsi8CL;A2Hri8CI;AAAO;AAAkG;AAAzG;AAKD;AAED;A3Hqi8CF;AACA;AACA;AACA;AACA;AACA;A2Hri8CI;AAAO;AAAkG;AAAzG;AAKD;AAED;A3Hqi8CF;AACA;AACA;AACA;AACA;AACA;A2Hri8CI;AAAO;AAAuD;AAA9D;AAID;AAED;A3Hsi8CF;AACA;AACA;AACA;AACA;AACA;A2Hti8CI;AAAO;AAAqE;AAA5E;AAKD;AAED;A3Hsi8CF;AACA;AACA;AACA;AACA;AACA;A2Hti8CI;AAAO;AAAqD;AAA5D;AAID;AAED;A3Hui8CF;AACA;AACA;AACA;AACA;AACA;A2Hvi8CI;AAAO;AAAiD;AAAxD;AAID;AAED;A3Hwi8CF;AACA;AACA;AACA;AACA;AACA;A2Hxi8CI;AAAO;AAAiF;AAAxF;AAKD;AAED;A3Hwi8CF;AACA;AACA;AACA;AACA;AACA;A2Hxi8CI;AAAO;AAA6F;AAApG;AAKD;AAED;A3Hwi8CF;AACA;AACA;AACA;AACA;AACA;A2Hxi8CI;AAAO;AAA8C;AAArD;AAID;AAED;A3Hyi8CF;AACA;AACA;AACA;AACA;AACA;A2Hzi8CI;AAAO;AAAsD;AAA7D;AAID;AAED;A3H0i8CF;AACA;AACA;AACA;AACA;AACA;A2H1i8CI;AAAO;AAAsD;AAA7D;AAID;AAED;A3H2i8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2H3i8CI;AAAO;AAA2F;AAAlG;AAID;AAED;A3H4i8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2H5i8CI;AAAO;AAA+D;AAAtE;AAID;AAED;A3H6i8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2H7i8CI;AAAO;AAAgD;AAAvD;AAID;AAED;A3H8i8CF;AACA;AACA;AACA;AACA;AACA;A2H9i8CI;AACD;AAED;A3H+i8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2H/i8CI;AAAO;AAA6F;AAApG;AAKD;AAED;A3H+i8CF;AACA;AACA;AACA;AACA;AACA;A2H/i8CI;AAAO;AAA4D;AAAnE;AAID;AAED;A3Hgj8CF;AACA;AACA;AACA;AACA;AACA;A2Hhj8CI;AAAO;AAAuD;AAA9D;AAID;AAED;A3Hij8CF;AACA;AACA;AACA;AACA;AACA;A2Hjj8CI;AAAO;AAAuD;AAA9D;AAID;AAED;A3Hkj8CF;AACA;AACA;AACA;AACA;AACA;A2Hlj8CI;AAAO;AAAkD;AAAzD;AAID;AAED;A3Hmj8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Hnj8CI;AAAO;AAAqF;AAA5F;AAID;AAED;A3Hoj8CF;AACA;AACA;AACA;AACA;AACA;A2Hpj8CI;AAAO;AAAkE;AAAzE;AAID;AAED;A3Hqj8CF;AACA;AACA;AACA;AACA;AACA;A2Hrj8CI;AAAO;AAA4E;AAAnF;AAID;AAED;A3Hsj8CF;AACA;AACA;AACA;AACA;AACA;A2Htj8CI;AAAO;AAAgF;AAAvF;AAMD;AAED;A3Hqj8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2Hrj8CI;AACE;AACC;AAFH;AAID;AAED;A3Hsj8CF;AACA;AACA;AACA;AACA;AACA;A2Htj8CI;AACE;AACC;AAFH;AAID;AAED;A3Huj8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Hvj8CI;AACE;AACC;AAFH;AAID;AAED;A3Hwj8CF;AACA;AACA;AACA;AACA;AACA;A2Hxj8CI;AACE;AACC;AAFH;AAID;AAED;A3Hyj8CF;AACA;AACA;AACA;AACA;AACA;A2Hzj8CI;AACE;AACC;AAFH;AAID;AAED;A3H0j8CF;AACA;AACA;AACA;AACA;AACA;A2H1j8CI;AACE;AACC;AAFH;AAID;AAED;A3H2j8CF;AACA;AACA;AACA;AACA;AACA;A2H3j8CI;AACE;AACC;AAFH;AAID;AAED;A3H4j8CF;AACA;AACA;AACA;AACA;AACA;A2H5j8CI;AACE;AACC;AAFH;AAID;AAED;A3H6j8CF;AACA;AACA;AACA;AACA;AACA;A2H7j8CI;AACD;AAED;A3H8j8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2H9j8CI;AACE;AACC;AAFH;AAID;AAED;A3H+j8CF;AACA;AACA;AACA;AACA;AACA;A2H/j8CI;AACE;AACC;AAFH;AAID;AAED;A3Hgk8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2Hhk8CI;AACD;AAED;A3Hik8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2Hjk8CI;AACD;AAED;A3Hkk8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2Hlk8CI;AACE;AACC;AAFH;AAID;AAED;A3Hmk8CF;AACA;AACA;AACA;AACA;AACA;AACA;A2Hnk8CI;AACD;AAED;A3Hok8CF;AACA;AACA;AACA;AACA;AACA;A2Hpk8CI;AACE;AACC;AAFH;AASD;AAED;A3Hgk8CF;AACA;AACA;AACA;AACA;AACA;A2Hhk8CI;AACE;AACC;AAFH;AAID;AAED;A3Hik8CF;AACA;AACA;AACA;AACA;AACA;A2Hjk8CI;AAAO;AAA0D;AAAjE;AAID;AAED;A3Hkk8CF;AACA;AACA;AACA;AACA;AACA;A2Hlk8CI;AAAO;AAAmD;AAA1D;AAID;AAED;A3Hmk8CF;AACA;AACA;AACA;AACA;AACA;A2Hnk8CI;AACA;AAAO;AAA4C;AAAnD;AAID;AAED;A3Hok8CF;AACA;AACA;AACA;AACA;AACA;A2Hpk8CI;AAAO;AAAiE;AAAxE;AAID;AAED;A3Hqk8CF;AACA;AACA;AACA;AACA;AACA;A2Hrk8CI;AACE;AACC;AAFH;AAQD;AAED;A3Hkk8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Hlk8CI;AACE;AACC;AAFH;AAQD;AAED;A3H+j8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2H/j8CI;AAAO;AAAoE;AAA3E;AAMD;AAED;A3H8j8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2H9j8CI;AAAO;AAAyG;AAAhH;AAMD;AAED;A3H6j8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2H7j8CI;AAAO;AAAwC;AAA/C;AAID;AAED;A3H8j8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2H9j8CI;AAAO;AAA6E;AAApF;AAMD;AAED;A3H6j8CF;AACA;AACA;AACA;AACA;AACA;A2H7j8CI;AAAO;AAA2D;AAAlE;AAID;AAED;A3H8j8CF;AACA;AACA;AACA;AACA;AACA;A2H9j8CI;AACE;AACC;AAFH;AAQD;AAED;A3H2j8CF;AACA;AACA;AACA;AACA;AACA;A2H3j8CI;AAAO;AAA4D;AAAnE;AAID;AAED;A3H4j8CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2H5j8CI;AAAO;AAAsE;AAA7E;AAID;AAED;A3H6j8CF;AACA;AACA;AACA;AACA;AACA;A2H7j8CI;AAAO;AAA4C;AAAnD;AAID;AAED;A3H8j8CF;AACA;AACA;AACA;AACA;AACA;A2H9j8CI;AAAO;AAAyE;AAAhF;AAID;AAED;A3H+j8CF;AACA;AACA;AACA;AACA;AACA;A2H/j8CI;AAAO;AAAwC;AAA/C;AACD;A3Hok8CH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4Hr49CA;A5Hu49CA;A4Ht49CA;A5Hw49CA;A4Hz59CA;A5H259CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4Ht59CA;A5Hw59CA;AACA;AACA;AACA;AACA;AACA;A4Ht59CA;AAEA;A5Hu59CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4Ht59CO;AACL;AACA;AACA;AACA;AACE;A5Hw59CJ;A4Hv59CI;AACE;AACD;A5Hy59CL;A4Hv59CI;AACA;A5Hy59CJ;A4Ht59CI;AACA;AACA;A5Hw59CJ;A4Hv59CI;AACE;AACA;A5Hy59CN;A4Ht59CM;AACA;A5Hw59CN;A4Hv59CM;AACE;A5Hy59CR;A4Hx59CQ;AACE;AACD;AACC;AACD;A5H059CT;A4Hz59CQ;AACE;AACD;AACF;A5H259CP;AACA;A4Hz59CM;A5H259CN;A4H159CM;AACE;A5H459CR;A4H359CQ;AACE;A5H659CV;A4H559CU;AAUE;AACD;AACF;AACF;A5Hq59CP;A4Hp59CM;AACD;AACC;AACA;AACA;AACA;A5Hs59CN;A4Hr59CM;AACE;A5Hu59CR;A4Ht59CQ;AASE;AACD;AACF;AACF;A5Hg59CL;A4H/49CI;AACE;AACA;AACD;AACC;AACA;AACD;A5Hi59CL;A4Hh59CI;AACE;AACA;AAFS;AAQZ;AACD;AACD;AAED;A5H649CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4H/49CE;A5Hi59CF;AACA;A4H/49CE;AACE;AACA;A5Hi59CJ;A4Hh59CI;AAGA;A5Hg59CJ;A4H/49CI;AACE;A5Hi59CN;A4Hh59CM;AACE;AAID;AACC;AAID;AACF;AACF;AAED;A5H249CF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4H749CI;AACA;A5H+49CJ;A4H549CI;AACE;AAEA;A5H649CN;A4H549CM;AAAc;AAAuB;A5Hg59C3C;A4H/49CM;AACE;AACD;AACF;A5Hi59CL;AACA;A4H/49CI;AACD;A5Hi59CH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Hrl+CA;A7Hul+CA;A6Htl+CA;A7Hwl+CA;A6Hzm+CA;A7H2m+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Hrm+CA;AACA;AAEA;A7Hsm+CA;AACA;AACA;AACA;AACA;AACA;A6Hrm+CO;AACL;A7Hum+CF;A6Htm+CE;AACE;AACD;A7Hwm+CH;A6Htm+CE;AACD;AAED;A7Hum+CA;AACA;AACA;AACA;AACA;AACA;AACA;A6Hvm+CO;AACL;A7Hym+CF;A6Hxm+CE;AACE;AACD;A7H0m+CH;A6Hxm+CE;AACD;AAED;A7Hym+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6Hzm+CA;AACE;AACD;AAED;A7H0m+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6H1m+CA;AACE;AACD;AAED;A7H2m+CA;AACA;AACA;AACA;AACA;AACA;AACA;A6H3m+CA;AACE;AACA;AAAU;AAAO;AAEjB;AACA;AACA;A7H8m+CF;A6H3m+CE;AAEA;AACD;AAED;A7H2m+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6H3m+CO;AACL;AACA;A7H6m+CF;A6H3m+CE;AACE;AACA;AACA;AACA;AACA;AACD;A7H6m+CH;A6H3m+CE;AACD;A7H6m+CD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8H9v+CA;A9Hgw+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8H9v+CA;A9Hgw+CA;AACA;AACA;AACA;A8H9v+CA;AACE;AACD;AAED;A9H+v+CA;AACA;AACA;AACA;AACA;A8H/v+CA;AACE;AACD;AAED;A9Hgw+CA;AACA;AACA;AACA;AACA;AACA;A8Hhw+CO;AACL;AACD;AAED;A9Hiw+CA;AACA;AACA;AACA;AACA;AACA;AACA;A8Hjw+CO;AACL;AACD;AAED;A9Hkw+CA;AACA;AACA;AACA;AACA;A8Hlw+CO;AACL;AACD;AAED;A9Hmw+CA;AACA;AACA;AACA;AACA;AACA;AACA;A8Hnw+CO;AACL;AACA;AACD;AAED;A9How+CA;AACA;AACA;AACA;AACA;AACA;AACA;A8Hpw+CO;AACL;AACE;AACD;A9Hsw+CH;A8Hrw+CE;AACD;AAED;A9Hsw+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Htw+CO;AACL;AACE;AACD;A9Hww+CH;A8Hvw+CE;AACE;AACD;A9Hyw+CH;A8Hxw+CE;AACD;AAED;A9Hyw+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Hzw+CO;AACL;A9H2w+CF;A8H5w+CoE;AAGhE;AACA;AACE;AACA;AACD;A9H4w+CL;A8H3w+CI;AACE;AACD;AAV+D;A9Hwx+CpE;A8Htx+CE;AAAwC;A9Hyx+C1C;A8Hzx+C0C;AASvC;A9Hmx+CH;A8Hlx+CE;AACD;AAED;A9Hmx+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Hnx+CO;AAA2B;AAEhC;A9Hqx+CF;A8Hpx+CE;AACE;AACD;A9Hsx+CH;AACA;A8Hrx+CE;AACD;AAED;A9Hsx+CA;AACA;AACA;AACA;AACA;AACA;A8Htx+CO;AACL;AACA;AACE;AACD;A9Hwx+CH;A8Htx+CE;AACD;AAED;A9Hux+CA;AACA;AACA;AACA;AACA;AACA;A8Hvx+CO;AACL;AACE;AACD;A9Hyx+CH;A8Hvx+CE;AACD;AAED;A9Hwx+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8Hxx+CO;AACL;AACE;AACD;A9H0x+CH;A8Hzx+CE;AACA;A9H2x+CF;A8H1x+CE;AACE;AACD;A9H4x+CH;A8H3x+CE;AACD;A9H6x+CD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Hz9+CA;A/H29+CA;A+H19+CA;A/H49+CA;A+H39+CA;A/H69+CA;A+H59+CA;A/H89+CA;A+H79+CA;A/H+9+CA;A+H99+CA;A/Hg++CA;A+H/9+CA;A/Hi++CA;A+Hh++CA;A/Hk++CA;A+Hz/+CA;A/H2/+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+H/++CA;AACA;AAEA;A/Hg/+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+H/++CO;AAOL;AACA;A/H2++CF;A+Hp++CE;AACE;AAEA;AACA;AACA;AACA;A/Hq++CJ;A+Hp++CI;AACE;AACA;AACD;A/Hs++CL;AACA;A+Hr++CI;AACE;AACE;AACA;AACD;AACF;AACF;A/Hu++CH;A+Ht++CE;AACD;AAED;A/Hu++CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+Hv++CO;AAOL;A/Hm++CF;A+H59+CE;AACE;AACA;AACA;AACA;AACA;AACA;AACE;AACA;AACD;A/H89+CL;AACA;A+H79+CI;AACE;AACE;AACA;AACD;AACF;AACF;A/H+9+CH;A+H99+CE;AACD;AAED;A/H+9+CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+H/9+CA;AACE;A/Hi++CF;A+Hh++CE;AACE;AACD;A/Hk++CH;A+Hh++CE;AAEA;A/Hi++CF;A+H19+CE;AACE;A/H49+CJ;A+H39+CI;AACE;AACE;AACD;A/H69+CP;A+H59+CM;AACD;AACF;A/H89+CH;AACA;A+H59+CE;AACA;AACA;AAAM;AAAO;AACb;AAEA;A/H+9+CF;A+H99+CE;AACE;AACD;AACC;AACA;AAGD;AACC;AACE;AACD;A/H89+CL;A+H79+CI;AACD;A/H+9+CH;A+H99+CE;A/Hg++CF;A+H/9+CE;AACE;AACD;A/Hi++CH;A+Hh++CE;AACD;AAED;A/Hi++CA;AACA;AACA;AACA;AACA;AACA;AACA;A+Hj++CA;AACE;AACA;AACE;AACD;A/Hm++CH;AACA;A+Hl++CE;AAAyB;AAAO;A/Hs++ClC;A+Hr++CE;AACE;AACA;AACD;A/Hu++CH;AACA;A+Ht++CE;AACD;AAED;A/Hu++CA;AACA;AACA;AACA;AACA;AACA;A+Hv++CO;AACL;AACD;AAED;A/Hw++CA;AACA;AACA;AACA;AACA;AACA;AACA;A+Hx++CA;AACE;AACA;AACD;AAED;A/Hy++CA;AACA;A+Hz++CA;AAEA;A/H0++CA;AACA;AACA;AACA;A+Hz++CO;AACL;AACD;AAED;A/H0++CA;AACA;AACA;AACA;AACA;AACA;AACA;A+H1++CO;AACL;AACA;AAAY;AAAwB;AACpC;AAEI;AACD;AAEC;AACA;AACD;AAEC;AACA;AACA;AACA;A/H2++CN;A+H1++CM;AACE;A/H4++CR;A+H3++CQ;AAAU;AAAO;AAAgB;AAAkB;AACpD;A/Hi/+CP;A+Hh/+CM;AACE;A/Hk/+CR;A+Hj/+CQ;AACA;AACD;AACF;AACJ;AAED;A/Hk/+CA;AACA;AACA;AACA;AACA;A+Hl/+CO;AACL;A/Ho/+CF;A+Hn/+CE;AACE;AACD;A/Hq/+CH;A+Hp/+CE;AACA;AACD;AAED;A/Hq/+CA;AACA;AACA;AACA;AACA;A+Hr/+CA;AACE;AACE;AACA;AACA;AAHuC;AAK1C;AAED;A/Hs/+CA;AACA;AACA;AACA;AACA;AACA;AACA;A+Ht/+CO;AACL;AACD;AAED;A/Hu/+CA;AACA;AACA;AACA;AACA;AACA;AACA;A+Hv/+CA;AACE;A/Hy/+CF;A+Hx/+CE;AACE;A/H0/+CJ;A+Hz/+CI;AACE;AACD;AACF;A/H2/+CH;A+H1/+CE;AACD;A/H4/+CD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgI90/CA;AhIg1/CA;AgI/0/CA;AhIi1/CA;AgIh1/CA;AhIk1/CA;AgIr2/CA;AhIu2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgIp2/CA;AhIs2/CA;AgIj2/CA;AACA;AAEA;AhIk2/CA;AgIj2/CA;AAEA;AhIk2/CA;AACA;AACA;AACA;AACA;AgIj2/CO;AACL;AACD;AAED;AhIk2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgIl2/CA;AACE;AACE;AhIo2/CJ;AgIn2/CI;AACE;AACD;AACF;AhIq2/CH;AgIp2/CE;AACD;AAED;AhIq2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgIr2/CO;AACL;AACE;AACA;AACD;AhIu2/CH;AgIt2/CE;AACE;AACD;AhIw2/CH;AgIv2/CE;AhIy2/CF;AgIx2/CE;AACE;AhI02/CJ;AgIz2/CI;AACE;AACA;AhI22/CN;AgIz2/CM;AACE;AACD;AACF;AhI22/CL;AgI12/CI;AACE;AACD;AACF;AhI42/CH;AgI32/CE;AACD;AAED;AhI42/CA;AACA;AACA;AACA;AACA;AACA;AACA;AgI52/CO;AAA6C;AhI+2/CpD;AgI72/CE;AACE;AAKD;AACF;AAED;AhI02/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgI12/CO;AACL;AhI42/CF;AgIv2/CE;AACE;AAA8B;AAAuB;AAGtD;AACF;AAED;AhIw2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgIx2/CO;AACL;AhI02/CF;AgIr2/CE;AACE;AACD;AhIu2/CH;AgIt2/CE;AACD;AAED;AhIu2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AgIv2/CO;AACL;AACE;AACD;AACF;AAED;AhIw2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgIx2/CO;AACL;AACE;AAID;AhIu2/CH;AgIt2/CE;AACD;AAED;AhIu2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgIv2/CO;AACL;AACE;AAID;AhIs2/CH;AgIr2/CE;AACD;AAED;AhIs2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgIt2/CO;AAAsC;AAE3C;AAIA;AAMA;AACD;AAED;AhI+1/CA;AACA;AACA;AACA;AACA;AACA;AgI/1/CO;AACL;AACE;AACD;AhIi2/CH;AgIh2/CE;AACE;AACD;AACC;AACD;AACF;AAED;AhIi2/CA;AACA;AACA;AACA;AACA;AACA;AgIj2/CO;AACL;AACD;AAED;AhIk2/CA;AACA;AACA;AACA;AACA;AACA;AgIl2/CO;AACL;AACD;AAED;AhIm2/CA;AACA;AACA;AACA;AACA;AACA;AgIn2/CO;AACL;AACE;AACD;AhIq2/CH;AgIp2/CE;AACD;AAED;AhIq2/CA;AACA;AACA;AACA;AACA;AACA;AACA;AgIr2/CO;AACL;AACE;AACD;AhIu2/CH;AgIt2/CE;AACE;AACD;AhIw2/CH;AgIv2/CE;AACE;AACD;AhIy2/CH;AgIx2/CE;AACD;AAED;AhIy2/CA;AACA;AACA;AACA;AACA;AACA;AgIz2/CO;AACL;AACD;AAED;AhI02/CA;AACA;AACA;AACA;AACA;AACA;AgI12/CO;AACL;AACE;AACD;AhI42/CH;AgI32/CE;AACD;AAED;AhI42/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgI52/CO;AACL;AAID;AAED;AhI02/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgI12/CO;AACL;AAAc;AAAqC;AACnD;AAAO;AAAwC;AAA/C;AACD;AAED;AhIg3/CA;AACA;AACA;AACA;AACA;AACA;AgIh3/CO;AACL;AACE;AACD;AACF;AAED;AhIi3/CA;AACA;AACA;AACA;AACA;AACA;AgIj3/CO;AACL;AACE;AACD;AhIm3/CH;AgIj3/CE;AACE;AACD;AACF;AhIm3/CD;AACA;AACA;AACA;AACA;AACA;AACA;AiIlugDA;AjIougDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiIlugDA;AjIougDA;AACA;AACA;AiIlugDO;AAEP;AjImugDA;AACA;AACA;AACA;AACA;AACA;AiInugDO;AjIqugDP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkIlwgDA;AlIowgDA;AkIlwgDA;AlIowgDA;AACA;AACA;AACA;AACA;AkI1xgDA;AlI4xgDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkIrxgDO;AACL;AACD;AAED;AlIsxgDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkIxxgDO;AACL;AACE;AACE;AACA;AACD;AACF;AACF;AAED;AlIyxgDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkIzxgDO;AAAkD;AAArB;AAAqB;AlI8xgDzD;AkI7xgDE;AACE;AlI+xgDJ;AkI9xgDI;AACE;AACA;AlIgygDN;AkI/xgDM;AACE;AACD;AACF;AlIiygDL;AkIhygDI;AACD;AACF;AAED;AlIiygDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkIjygDO;AACL;AACA;AACA;AACE;AACD;AACF;AAED;AlIkygDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkIlygDO;AACL;AACE;AACE;AACD;AACF;AACF;AAED;AlImygDA;AACA;AACA;AACA;AACA;AACA;AACA;AkInygDO;AACL;AACE;AACD;AACF;AAED;AlIoygDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkIpygDO;AACL;AACE;AACE;AACD;AACF;AlIsygDH;AkIrygDE;AACE;AACE;AACD;AlIuygDL;AkItygDI;AACD;AACF;AAED;AlIuygDA;AACA;AACA;AACA;AACA;AACA;AkIvygDO;AACL;AACE;AACD;AACF;AAED;AlIwygDA;AACA;AACA;AACA;AACA;AACA;AkIxygDO;AACL;AACE;AlI0ygDJ;AkIzygDI;AACE;AACD;AlI2ygDL;AkI1ygDI;AACD;AACF;AAED;AlI2ygDA;AACA;AACA;AACA;AACA;AACA;AkI3ygDO;AACL;AACE;AlI6ygDJ;AkI5ygDI;AACE;AACD;AlI8ygDL;AkI7ygDI;AACD;AACF;AAED;AlI8ygDA;AACA;AACA;AACA;AACA;AACA;AACA;AkI9ygDO;AACL;AACE;AlIgzgDJ;AkI/ygDI;AACE;AACD;AlIizgDL;AkIhzgDI;AACE;AACD;AlIkzgDL;AkIhzgDI;AlIkzgDJ;AkIjzgDI;AACE;AACD;AlImzgDL;AkIlzgDI;AACD;AACF;AAED;AlImzgDA;AACA;AACA;AACA;AACA;AACA;AkInzgDO;AACL;AACE;AACD;AACF;AlIqzgDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmIxghDA;AnI0ghDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmIxghDA;AACA;AAEA;AnIyghDA;AACA;AACA;AACA;AACA;AmIxghDA;AACE;AACD;AAED;AnIyghDA;AACA;AACA;AACA;AACA;AACA;AmIzghDO;AACL;AACD;AAED;AnI0ghDA;AACA;AACA;AACA;AACA;AACA;AACA;AmI1ghDO;AACL;AACD;AAED;AnI2ghDA;AACA;AACA;AACA;AACA;AACA;AmI3ghDO;AACL;AACD;AAED;AnI4ghDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmI5ghDO;AACL;AACD;AAED;AnI6ghDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmI7ghDO;AACL;AACE;AACE;AACD;AACF;AnI+ghDH;AmI9ghDE;AACD;AAED;AnI+ghDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmI/ghDO;AACL;AAAO;AAAwB;AAA/B;AACD;AnIohhDD;AACA;AACA;AACA;AACA;AACA;AACA;AoI1mhDA;ApI4mhDA;AoI5nhDA;ApI8nhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoIznhDA;AAEA;ApI0nhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoIznhDO;AACL;AAAe;AAA4B;ApI6nhD7C;AoI5nhDE;AACE;AACD;ApI8nhDH;AoI5nhDE;ApI8nhDF;AoI7nhDE;AACE;AACA;AAGA;AACD;ApI6nhDH;AoI5nhDE;AACD;ApI8nhDD;AACA;AACA;AACA;AACA;AACA;AACA;AqIjrhDA;ArImrhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqIjrhDA;ArImrhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqIjrhDO;AAA0D;AAAf;AAAe;ArIsrhDjE;AqIrrhDE;AACE;AACD;AACC;AACD;AACF;ArIurhDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsI1uhDA;AtI4uhDA;AsI3uhDA;AtI6uhDA;AsI5uhDA;AtI8uhDA;AsI7uhDA;AtI+uhDA;AsI9uhDA;AtIgvhDA;AsI/uhDA;AtIivhDA;AsIhvhDA;AtIkvhDA;AsIjvhDA;AtImvhDA;AsIlvhDA;AtIovhDA;AsI5whDA;AtI8whDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsIlwhDA;AtIowhDA;AACA;AsIlwhDA;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAV+B;AAajC;AtImwhDA;AACA;AACA;AACA;AsIlwhDA;AAEA;AtImwhDA;AACA;AACA;AACA;AACA;AACA;AsIlwhDA;AAEA;AtImwhDA;AsIlwhDA;AAEA;AtImwhDA;AsIlwhDA;AAEA;AtImwhDA;AsIlwhDA;AAEA;AtImwhDA;AsIlwhDA;AAEA;AtImwhDA;AsIlwhDA;AAEA;AACE;AAA4B;AAC5B;AAA4B;AAC5B;AAA4B;AAG9B;AtIowhDA;AsInwhDO;AAEP;AtIowhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsIrwhDO;AACL;AACD;AAED;AtIswhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsItwhDO;AACL;AACE;AAAI;AAAmC;AACvC;AACD;AtI0whDH;AsIxwhDE;AACD;AAED;AtIywhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsIzwhDO;AACL;AACE;AACD;AtI2whDH;AsIzwhDE;AAGA;AtIywhDF;AsIxwhDE;AACE;AACD;AtI0whDH;AsIxwhDE;AAAa;AAA0B;AACrC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AtI4whDJ;AsIrxhDyC;AAavC;AtI2whDF;AsI1whDE;AACE;AACD;AAGD;AtI0whDF;AACA;AsI1whDE;AAIE;AACA;AACD;AAGD;AtIuwhDF;AACA;AsIvwhDE;AtIywhDF;AsIxwhDE;AACE;AACD;AACC;AACD;AACC;AACD;AtI0whDH;AsIzwhDE;AtI2whDF;AsIxwhDE;AtI0whDF;AsIxwhDE;AACE;AACD;AtI0whDH;AsIxwhDE;AACD;AAED;AtIywhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsIzwhDO;AAKL;AACE;AACD;AtIuwhDH;AsItwhDE;AACA;AAEA;AAOA;AACA;AACD;AACD;AtIiwhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsIjwhDO;AACL;AACA;AACD;AAED;AtIkwhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsIlwhDO;AACL;AACD;AAED;AtImwhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsInwhDO;AACL;AACA;AACA;AACA;AtIqwhDF;AsIpwhDE;AACE;AACE;AACD;AACF;AtIswhDH;AsIrwhDE;AACD;AAED;AtIswhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsItwhDO;AACL;AtIwwhDF;AsIvwhDE;AACE;AtIywhDJ;AsIxwhDI;AACE;AACD;AACC;AACE;AAAW;AAAuB;AAClC;AACD;AACF;AACC;AAAW;AAAuB;AAClC;AACD;AACF;AtI8whDH;AsI7whDE;AACD;AAED;AtI8whDA;AACA;AACA;AACA;AACA;AACA;AsI9whDO;AACL;AACE;AACD;AtIgxhDH;AsI/whDE;AAMD;AAED;AtI2whDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsI3whDO;AAIL;AADA;AACA;AtI4whDF;AsI3whDE;AtI6whDF;AsItwhDE;AAAqB;AAAuB;AAC5C;AASA;AACD;AAED;AtIiwhDA;AACA;AACA;AACA;AACA;AACA;AsIjwhDO;AACL;AAKA;AACD;AAED;AtI8vhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsI9vhDO;AACL;AACD;AAED;AtI+vhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsI/vhDO;AACL;AtIiwhDF;AsIhwhDE;AACE;AACD;AtIkwhDH;AsIjwhDE;AACD;AAED;AtIkwhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsIlwhDO;AACL;AtIowhDF;AsInwhDE;AACE;AACD;AtIqwhDH;AsIpwhDE;AACD;AAED;AtIqwhDA;AACA;AACA;AACA;AACA;AACA;AsIrwhDO;AACL;AACE;AACD;AtIuwhDH;AsItwhDE;AACD;AAED;AtIuwhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsIvwhDO;AACL;AACE;AACD;AtIywhDH;AsIxwhDE;AACE;AACD;AtI0whDH;AsIzwhDE;AACA;AACD;AAED;AtI0whDA;AACA;AACA;AACA;AACA;AACA;AsI1whDO;AACL;AACE;AACD;AtI4whDH;AsI3whDE;AACD;AAED;AtI4whDA;AACA;AACA;AACA;AACA;AACA;AACA;AsI5whDO;AACL;AACE;AACD;AtI8whDH;AsI7whDE;AACE;AACD;AtI+whDH;AsI9whDE;AACD;AAED;AtI+whDA;AACA;AACA;AACA;AACA;AACA;AsI/whDO;AACL;AACA;AACA;AACD;AAED;AtIgxhDA;AACA;AACA;AACA;AACA;AACA;AsIhxhDO;AACL;AtIkxhDF;AsIjxhDE;AACE;AACD;AtImxhDH;AsIlxhDE;AACA;AACD;AAED;AtImxhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsInxhDA;AACE;AACE;AACD;AtIqxhDH;AsIpxhDE;AtIsxhDF;AsI/whDE;AACD;AAED;AtIgxhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsIhxhDO;AACL;AACA;AACA;AACE;AACD;AtIkxhDH;AsIjxhDE;AACA;AACA;AACD;AAED;AtIkxhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsIlxhDO;AACL;AACE;AACD;AtIoxhDH;AACA;AsIlxhDE;AACE;AACD;AAGD;AACA;AACA;AtIkxhDF;AACA;AsIlxhDE;AACA;AACA;AAKA;AACA;AtIgxhDF;AsI3whDE;AACA;AACA;AAMD;AAED;AtIuwhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsIvwhDO;AACL;AACD;AAED;AtIwwhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsIxwhDO;AACL;AACE;AACD;AtI0whDH;AsIzwhDE;AACE;AACD;AtI2whDH;AsI1whDE;AACD;AAED;AtI2whDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsI3whDO;AACL;AACE;AACD;AtI6whDH;AsI5whDE;AACA;AtI8whDF;AsI3whDE;AACE;AACD;AtI6whDH;AACA;AsI3whDE;AACE;AACD;AtI6whDH;AACA;AsI3whDE;AACE;AACD;AtI6whDH;AACA;AsI3whDE;AAKD;AAED;AtIwwhDA;AACA;AACA;AACA;AACA;AACA;AACA;AsIxwhDO;AACL;AACA;AACA;AACD;AAED;AtIywhDA;AACA;AACA;AACA;AACA;AsIzwhDO;AACL;AACA;AACA;AAKD;AAED;AtIswhDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsItwhDO;AACL;AACD;AtIwwhDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuI95iDA;AvIg6iDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuI95iDA;AvIg6iDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuI95iDO;AACL;AACE;AACD;AvIg6iDH;AuI/5iDE;AACE;AACE;AACD;AACF;AvIi6iDH;AuIh6iDE;AACD;AAED;AvIi6iDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuIj6iDO;AACL;AACA;AvIm6iDF;AuIl6iDE;AACE;AvIo6iDJ;AuIn6iDI;AACE;AACD;AACC;AACE;AACD;AvIq6iDP;AuIp6iDM;AACD;AACF;AvIs6iDH;AuIr6iDE;AACE;AACD;AvIu6iDH;AuIt6iDE;AACD;AAED;AvIu6iDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuIv6iDO;AACL;AACE;AACE;AACD;AACF;AvIy6iDH;AuIx6iDE;AACD;AAED;AvIy6iDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuIz6iDO;AACL;AvI26iDF;AuI16iDE;AACE;AACD;AvI46iDH;AuI36iDE;AACD;AAED;AvI46iDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuI56iDO;AACL;AACE;AACD;AACF;AAED;AvI66iDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuI76iDO;AACL;AACD;AvI+6iDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwIlijDA;AxIoijDA;AwIpjjDA;AxIsjjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwIljjDA;AxIojjDA;AACA;AACA;AwIljjDA;AAA6B;AAAU;AAAU;AAArB;AAE5B;AxIujjDA;AACA;AACA;AACA;AwItjjDA;AAA6B;AAAU;AAAU;AAArB;AAE5B;AxI2jjDA;AACA;AACA;AACA;AACA;AACA;AwI1jjDO;AACL;AAA6C;AAAA;AAC7C;AACD;AAED;AxI6jjDA;AACA;AACA;AACA;AACA;AACA;AACA;AwI7jjDO;AACL;AACD;AAED;AxI8jjDA;AACA;AACA;AACA;AACA;AACA;AACA;AwI9jjDO;AACL;AACA;AAAqC;AAAA;AACtC;AAED;AxIikjDA;AACA;AACA;AACA;AACA;AACA;AACA;AwIjkjDO;AACL;AACA;AACD;AAED;AxIkkjDA;AACA;AACA;AACA;AACA;AACA;AwIlkjDO;AACL;AACA;AACD;AAED;AxImkjDA;AACA;AACA;AACA;AACA;AACA;AwInkjDO;AACL;AACD;AxIqkjDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyI1pjDA;AzI4pjDA;AyI5qjDA;AzI8qjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyI1qjDA;AzI4qjDA;AACA;AACA;AACA;AyI1qjDO;AACL;AACE;AACD;AzI4qjDH;AyI3qjDE;AACA;AACD;AAED;AzI4qjDA;AACA;AACA;AACA;AACA;AACA;AyI5qjDO;AACL;AACE;AACD;AzI8qjDH;AyI7qjDE;AACD;AAED;AzI8qjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyI9qjDO;AACL;AzIgrjDF;AyI/qjDE;AACE;AACA;AACA;AACD;AzIirjDH;AyIhrjDE;AACD;AAED;AzIirjDA;AACA;AACA;AACA;AACA;AACA;AyIjrjDO;AACL;AACA;AACA;AzImrjDF;AyIlrjDE;AACE;AACD;AzIorjDH;AyInrjDE;AACD;AAED;AzIorjDA;AACA;AACA;AACA;AACA;AACA;AACA;AyIprjDO;AACL;AACE;AACD;AzIsrjDH;AyIrrjDE;AzIurjDF;AyIjrjDE;AACD;AAED;AzIkrjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyIlrjDO;AACL;AACE;AACD;AAGD;AzIkrjDF;AACA;AyIlrjDE;AACA;AACA;AACD;AzIorjDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0I5xjDA;A1I8xjDA;A0I7xjDA;A1I+xjDA;A0IhzjDA;A1IkzjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0I7yjDA;A1I+yjDA;AACA;AACA;A0I7yjDO;AACL;AACA;A1I+yjDF;A0I1yjDE;AACE;AACD;A1I4yjDH;AACA;A0I1yjDE;A1I4yjDF;A0I3yjDE;AACE;AACD;A1I6yjDH;A0I3yjDE;AACD;AAED;A1I4yjDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A0I5yjDO;AACL;AACD;AAED;A1I6yjDA;AACA;AACA;AACA;AACA;A0I7yjDO;AACL;AACE;AACD;A1I+yjDH;A0I9yjDE;A1IgzjDF;A0I/yjDE;AACE;AACD;AACF;AAED;A1IgzjDA;AACA;AACA;AACA;AACA;A0IhzjDO;AACL;AACE;AACD;A1IkzjDH;A0IjzjDE;A1ImzjDF;A0IlzjDE;AACE;AACD;AACF;AAED;A1ImzjDA;AACA;AACA;AACA;AACA;A0InzjDA;AACE;AACA;AACA;AAGD;A1ImzjDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2It4jDA;A3Iw4jDA;A2Ix5jDA;A3I05jDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2It5jDA;A3Iw5jDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2It5jDO;AACL;AACA;A3Iw5jDF;A2Iv5jDE;AAAsC;AAAc;AAClD;A3I25jDJ;A2I15jDI;AACE;AACD;A3I45jDL;A2I35jDI;AACA;AACA;AACA;AACD;A3I65jDH;A2I55jDE;AACD;A3I85jDD;AACA;AACA;AACA;AACA;AACA;A2Ih6jDE;A3Ik6jDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Ih6jDI;AACD;A3Ik6jDH;AACA;AACA;A2Ij6jDA;A3Im6jDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A2Ir6jDA;AAAoC;A3Iw6jDpC;A2Ir6jDE;AACA;AACA;AAEA;AACA;AACA;A3Is6jDF;A2Ir6jDE;AACE;AACE;AACD;A3Iu6jDL;A2It6jDI;AACA;AACD;A3Iw6jDH;AACA;A2Iv6jDE;AACD;A3Iy6jDD;AACA;AACA;AACA;AACA;AACA;AACA;A4IzhkDA;A5I2hkDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4IxhkDA;A5I0hkDA;A4IzhkDA;A5I2hkDA;A4IzhkDA;A5I2hkDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A4IzhkDO;AACL;AACA;AACA;AACA;AACE;AAAgB;AADP;AACO;A5I8hkDpB;A4I7hkDM;AACA;AACA;AACD;A5I+hkDL;A4I9hkDI;AACD;AACF;A5IgikDD;AACA;AACA;AACA;AACA;AACA;AACA;A6IjlkDA;A7ImlkDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A6IjlkDA;A7ImlkDA;AACA;AACA;AACA;A6IjlkDO;AACL;AACA;AACE;AACA;A7ImlkDJ;A6IllkDI;AACE;AACD;A7IolkDL;A6InlkDI;AACA;AACD;AACF;A7IqlkDD;AACA;AACA;AACA;AACA;AACA;AACA;A8I3nkDA;A9I6nkDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A8I3nkDA;A9I6nkDA;AACA;A8I3nkDO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AAPsB;AAUxB;A9I4nkDA;AACA;AACA;AACA;A8I5nkDO;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAXkB;A9I0okDpB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+IjqkDA;A/ImqkDA;A+InrkDA;A/IqrkDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+IjrkDA;AACA;AAEA;A/IkrkDA;AACA;AACA;AACA;AACA;AACA;A+InrkDE;A/IqrkDF;AACA;A+InrkDE;AACE;AACA;AAEA;A/IorkDJ;A+InrkDI;AAEA;A/IorkDJ;AACA;AACA;AACA;A+InrkDI;AAEA;A/IorkDJ;A+InrkDI;AACD;AAED;A/IorkDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;A+ItrkDI;AACD;AAED;A/IurkDF;AACA;AACA;AACA;AACA;AACA;A+IvrkDI;A/IyrkDJ;A+IxrkDI;AACE;AACA;AACD;A/I0rkDL;A+IzrkDI;AACD;AAED;A/I0rkDF;AACA;AACA;AACA;AACA;AACA;A+I1rkDI;AACE;AACD;A/I4rkDL;A+I3rkDI;AAAoB;AAAS;AAAV;AACnB;AACD;AAED;A/I+rkDF;AACA;AACA;AACA;AACA;A+I/rkDI;AACE;AACD;A/IiskDL;A+I/rkDI;AACA;AACA;AACA;A/IiskDJ;A+IhskDI;AAAyB;A/ImskD7B;A+IjskDM;AACE;AACA;AACD;AACF;A/ImskDL;A+IjskDI;AACE;AACA;AACD;AACF;A/ImskDH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgJ7ykDA;AhJ+ykDA;AgJ/zkDA;AhJi0kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgJ7zkDA;AhJ+zkDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgJ7zkDO;AACL;AACA;AhJ+zkDF;AgJ9zkDE;AACE;AACA;AACD;AhJg0kDH;AgJ9zkDE;AACE;AACD;AACC;AACD;AhJg0kDH;AgJ9zkDE;AACD;AAED;AhJ+zkDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgJ/zkDO;AACL;AACD;AAED;AhJg0kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgJh0kDO;AACL;AACA;AACD;AAED;AhJi0kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgJj0kDO;AACL;AACA;AACD;AAED;AhJk0kDA;AACA;AACA;AACA;AACA;AACA;AACA;AgJl0kDO;AACL;AACD;AAED;AhJm0kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgJn0kDO;AACL;AACD;AAED;AhJo0kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AgJp0kDO;AACL;AAEA;AACE;AACA;AAFK;AAIR;AAED;AhJo0kDA;AACA;AACA;AACA;AACA;AACA;AgJp0kDO;AACL;AACE;AACD;AACF;AhJs0kDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiJt+kDA;AjJw+kDA;AiJx/kDA;AjJ0/kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiJt/kDA;AACA;AAEA;AjJu/kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiJt/kDO;AACL;AjJw/kDF;AiJv/kDE;AACE;AACD;AjJy/kDH;AiJx/kDE;AACD;AAED;AjJy/kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiJz/kDO;AACL;AACA;AACA;AAAO;AAA4B;AAAnC;AACD;AAED;AjJ6/kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiJ7/kDO;AACL;AACD;AAED;AjJ8/kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiJ9/kDO;AACL;AACE;AACD;AACC;AACD;AACF;AAED;AjJ+/kDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AiJ//kDO;AAA+C;AAAZ;AAAY;AjJoglDtD;AiJnglDE;AACA;AAEA;AjJoglDF;AiJnglDE;AACA;AAAY;AAAW;AAAW;AAAvB;AjJyglDb;AiJ/glDsD;AAAA;AAAA;AAAA;AAAA;AjJqhlDtD;AiJ1glDI;AACE;AACD;AjJ4glDL;AiJ3glDI;AjJ6glDJ;AiJ5glDI;AACE;AACD;AjJ8glDL;AiJ7glDI;AACE;AACA;AACD;AjJ+glDL;AiJ9glDI;AACE;AAEA;AjJ+glDN;AiJ9glDM;AACE;AjJghlDR;AiJ/glDQ;AACE;AAAY;AAAa;AAAa;AAA3B;AACX;AACD;AACF;AjJqhlDP;AiJphlDM;AACD;AAlCiD;AjJyjlDtD;AiJhjlDE;AAAyB;AjJmjlD3B;AiJnjlD2B;AA0BxB;AjJ4hlDH;AiJ3hlDE;AACD;AAED;AjJ4hlDA;AACA;AACA;AACA;AACA;AACA;AiJ5hlDO;AACL;AACE;AACE;AACD;AjJ8hlDL;AiJ7hlDI;AACD;AACF;AjJ+hlDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkJzrlDA;AlJ2rlDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkJzrlDA;AlJ2rlDA;AACA;AACA;AACA;AACA;AACA;AkJ3rlDE;AlJ6rlDF;AACA;AkJ3rlDE;AACE;AACA;AACD;AAED;AlJ4rlDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkJ9rlDI;AlJgslDJ;AkJ/rlDI;AACE;AACD;AlJislDL;AkJhslDI;AACD;AAED;AlJislDF;AACA;AACA;AACA;AACA;AACA;AACA;AkJjslDI;AACE;AACD;AlJmslDL;AkJlslDI;AACA;AAA0B;AAAM;AAAP;AAC1B;AAED;AlJsslDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkJtslDI;AACA;AACA;AlJwslDJ;AkJvslDI;AACE;AlJyslDN;AkJvslDM;AACE;AACD;AAED;AACA;AlJwslDN;AACA;AkJxslDM;AACE;AACD;AACC;AACD;AACC;AACD;AACF;AlJ0slDL;AkJzslDI;AACD;AAED;AlJ0slDF;AACA;AACA;AACA;AACA;AkJ1slDI;AlJ4slDJ;AkJ3slDI;AACE;AACD;AACF;AAED;AlJ4slDF;AACA;AACA;AACA;AACA;AACA;AACA;AkJ5slDI;AACE;AACD;AlJ8slDL;AkJ7slDI;AACD;AAED;AlJ8slDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AkJhtlDI;AACD;AlJktlDH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmJh1lDA;AnJk1lDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmJh1lDA;AnJk1lDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmJh1lDE;AnJk1lDF;AACA;AmJh1lDE;AACE;AAEA;AnJi1lDJ;AACA;AACA;AmJh1lDI;AAAmB;AAAO;AACxB;AACA;AACD;AAED;AnJm1lDJ;AACA;AACA;AmJl1lDI;AAEA;AnJm1lDJ;AACA;AACA;AmJl1lDI;AACD;AAGH;AnJk1lDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmJp1lDO;AACL;AACE;AACD;AACF;AAED;AnJq1lDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmJr1lDO;AAAmC;AAAX;AAAW;AnJ01lD1C;AmJz1lDE;AACE;AACA;AnJ21lDJ;AmJ11lDI;AACE;AACD;AnJ41lDL;AmJ31lDI;AACE;AACD;AnJ61lDL;AmJ51lDI;AACA;AnJ81lDJ;AmJ51lDI;AACE;AACE;AACD;AnJ81lDP;AmJ71lDM;AACE;AACD;AACF;AnJ+1lDL;AmJ91lDI;AACE;AACE;AACD;AnJg2lDP;AmJ/1lDM;AACE;AACD;AACF;AnJi2lDL;AmJh2lDI;AACE;AACD;AACF;AACF;AAED;AnJi2lDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmJn2lDE;AnJq2lDF;AACA;AmJn2lDE;AACE;AACA;AnJq2lDJ;AmJp2lDI;AACE;AACA;AACD;AAED;AnJq2lDJ;AmJp2lDI;AAEA;AnJq2lDJ;AmJp2lDI;AAEA;AnJq2lDJ;AmJp2lDI;AnJs2lDJ;AmJp2lDI;AACE;AACE;AACD;AACF;AACF;AAED;AnJq2lDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AmJx2lDe;AnJ02lDf;AmJz2lDI;AACA;AAEI;AACE;AACD;AACF;AAEC;AACA;AACA;AACE;AACD;AACF;AAEH;AACD;AAED;AnJu2lDF;AACA;AACA;AmJv2lDI;AACD;AnJy2lDH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoJ1imDA;ApJ4imDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoJ1imDA;ApJ4imDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoJ1imDO;AACL;AACA;AAEA;ApJ2imDF;AACA;AACA;AoJ1imDE;AACE;ApJ4imDJ;AoJ1imDI;AAEA;AACD;AAED;ApJ0imDF;AACA;AACA;AACA;AoJ1imDE;AACE;ApJ4imDJ;AoJ1imDI;AACE;AACD;AACF;ApJ4imDH;AoJ1imDE;AAAyB;AAAN;AAAM;ApJ+imD3B;AoJ9imDI;AACE;AACD;AACC;AACD;AACF;AACF;AAED;ApJ+imDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AoJ/imDO;AACL;AACA;AACA;AAEA;ApJgjmDF;AACA;AACA;AoJ/imDE;AACE;AACA;AACD;AAED;ApJgjmDF;AACA;AACA;AACA;AoJhjmDE;AACE;AACA;ApJkjmDJ;AoJjjmDI;AACE;AACD;AACC;AACD;AACF;ApJmjmDH;AoJjjmDE;AACE;ApJmjmDJ;AoJpjmD2B;AAAN;AAAM;ApJwjmD3B;AoJtjmDI;ApJwjmDJ;AoJvjmDI;AACE;AACD;AACF;AACF;ApJyjmDD;AACA;AACA;AACA;AACA;AACA;AACA;AqJvpmDA;ArJypmDA;AqJxpmDA;ArJ0pmDA;AqJ3qmDA;ArJ6qmDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqJxqmDA;ArJ0qmDA;AACA;AACA;AACA;AACA;AACA;AqJ1qmDE;ArJ4qmDF;AACA;AqJ1qmDE;AACE;ArJ4qmDJ;AACA;AACA;AACA;AqJ1qmDI;AAEA;ArJ2qmDJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqJ1qmDI;AACD;AAED;ArJ2qmDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqJ7qmDI;AACA;AACD;AAED;ArJ8qmDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqJ9qmDI;ArJgrmDJ;AqJ/qmDI;AACE;ArJirmDN;AqJhrmDM;AACE;AACA;AAIA;AAAiB;AAAD;AACjB;AACC;AACA;AACA;AAHK;AAAA;AAAA;AAML;AAAiB;AAAS;AAAS;AAAnB;AACjB;ArJsrmDP;AqJrrmDM;AACE;AACD;ArJurmDP;AqJtrmDM;AACD;ArJwrmDL;AqJvrmDI;AACD;AAED;ArJwrmDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqJxrmDI;AACE;AACA;AACD;ArJ0rmDL;AqJzrmDI;AACA;AACA;ArJ2rmDJ;AqJ1rmDI;AACE;AACA;AACA;AACD;AACF;AAED;ArJ2rmDF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AqJ3rmDI;AACE;AACA;AACD;ArJ6rmDL;AqJ5rmDI;AACA;ArJ8rmDJ;AqJ7rmDI;AACE;AACA;AACA;AACD;AACF;AAED;ArJ8rmDF;AACA;AACA;AACA;AACA;AACA;AqJ9rmDI;AACE;AACD;ArJgsmDL;AACA;AqJ/rmDI;ArJismDJ;AqJhsmDI;AACE;AACD;AACF;ArJksmDH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJv1mDA;AtJy1mDA;AsJx1mDA;AtJ01mDA;AsJz1mDA;AtJ21mDA;AsJ11mDA;AtJ41mDA;AsJ31mDA;AtJ61mDA;AsJt1mDA;AtJw1mDA;AsJv1mDA;AtJy1mDA;AsJx1mDA;AtJ01mDA;AsJz1mDA;AtJ21mDA;AsJz3mDA;AtJ23mDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJz2mDA;AACA;AAEA;AtJ02mDA;AsJz2mDA;AAEA;AtJ02mDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJz2mDO;AACL;AtJ22mDF;AsJ12mDE;AACE;AAAgB;AAA0C;AAC1D;AACA;AACD;AtJ82mDH;AsJ72mDE;AAAQ;AAAO;AAAR;AACR;AAED;AtJi3mDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJj3mDO;AACL;AAEA;AtJk3mDF;AsJj3mDE;AACE;AACA;AACA;AACA;AACA;AACD;AtJm3mDH;AsJj3mDE;AACA;AACE;AACA;AtJm3mDJ;AsJl3mDI;AtJo3mDJ;AACA;AACA;AsJl3mDI;AACE;AACD;AATU;AtJ83mDf;AsJl3mDE;AACE;AtJo3mDJ;AsJn3mDI;AACE;AACE;AACA;AACA;AAGD;AACF;AtJm3mDL;AsJl3mDI;AACE;AACD;AtJo3mDL;AsJn3mDI;AACE;AACD;AACF;AtJq3mDH;AsJn3mDE;AACD;AAED;AtJo3mDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJp3mDO;AACL;AACE;AACD;AtJs3mDH;AsJp3mDE;AtJs3mDF;AsJn3mDE;AtJq3mDF;AsJp3mDE;AACA;AACA;AtJs3mDF;AsJp3mDE;AACE;AACD;AtJs3mDH;AsJp3mDE;AACA;AtJs3mDF;AsJr3mDE;AACE;AACD;AtJu3mDH;AsJr3mDE;AACQ;AAAA;AAEJ;AAOE;AACD;AtJi3mDP;AsJh3mDM;AACE;AAD0B;AAG5B;AAEgB;AAAA;AACjB;AACJ;AAED;AtJi3mDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJj3mDO;AACL;AtJm3mDF;AsJl3mDE;AACE;AACD;AtJo3mDH;AsJn3mDE;AACD;AAED;AtJo3mDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJp3mDO;AACL;AAGA;AtJo3mDF;AsJn3mDE;AACA;AAMA;AACA;AtJg3mDF;AsJ/2mDE;AACE;AACD;AtJi3mDH;AACA;AsJ/2mDE;AAEA;AACD;AAED;AtJ+2mDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJ/2mDO;AACL;AAEA;AtJg3mDF;AsJ/2mDE;AACA;AtJi3mDF;AsJh3mDE;AACE;AACA;AACD;AtJk3mDH;AsJj3mDE;AACD;AAED;AtJk3mDA;AACA;AACA;AACA;AACA;AsJl3mDO;AACL;AtJo3mDF;AsJn3mDE;AACE;AACA;AACA;AACiC;AAAA;AtJs3mDrC;AsJh3mDI;AAEA;AtJi3mDJ;AsJ/2mDI;AACE;AACE;AAA4B;AAE/B;AACC;AACE;AAA4B;AAE/B;AACF;AtJi3mDH;AsJh3mDE;AACD;AAED;AtJi3mDA;AACA;AACA;AACA;AACA;AACA;AACA;AsJj3mDA;AACE;AACE;AACD;AtJm3mDH;AsJl3mDE;AACA;AAMA;AACD;AAED;AtJ82mDA;AACA;AACA;AACA;AACA;AACA;AsJ92mDA;AACE;AACD;AAED;AtJ+2mDA;AACA;AACA;AACA;AACA;AACA;AACA;AsJ/2mDO;AACL;AACE;AACE;AACD;AtJi3mDL;AsJp3mDgC;AAM5B;AACA;AAEA;AtJg3mDJ;AsJ/2mDI;AACA;AACD;AACF;AAED;AtJg3mDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AsJh3mDO;AACL;AtJk3mDF;AsJj3mDE;AAIE;AAGM;AAKA;AACD;AARH;AAUa;AAAA;AACJ;AAAA;AAEZ;AtJ22mDH;AACA;AsJ12mDE;AACD;AtJ42mDD;AACA;AACA;AACA;AACA;AACA;AACA;AuJzxnDA;AvJ2xnDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AuJzxnDA;AvJ2xnDA;AACA;AACA;AuJzxnDO;AACL;AvJ2xnDF;AACA;AuJzxnDE;AvJ2xnDF;AuJzxnDE;AvJ2xnDF;AACA;AuJzxnDE;AvJ2xnDF;AuJzxnDE;AvJ2xnDF;AACA;AuJzxnDE;AvJ2xnDF;AuJzxnDE;AvJ2xnDF;AACA;AACA;AuJzxnDE;AvJ2xnDF;AuJzxnDE;AvJ2xnDF;AACA;AACA;AuJzxnDE;AA1B6B;AvJsznD/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwJj1nDA;AxJm1nDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwJj1nDA;AxJm1nDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AwJr1nDE;AxJu1nDF;AACA;AACA;AACA;AACA;AwJr1nDI;AACD;AAED;AxJs1nDF;AACA;AACA;AACA;AACA;AACA;AACA;AwJt1nDI;AACD;AAED;AxJu1nDF;AACA;AACA;AACA;AACA;AACA;AACA;AwJv1nDI;AACD;AAED;AxJw1nDF;AACA;AACA;AACA;AACA;AACA;AACA;AwJx1nDI;AACD;AAED;AxJy1nDF;AACA;AACA;AACA;AACA;AACA;AACA;AwJz1nDI;AACD;AAED;AxJ01nDF;AACA;AACA;AACA;AACA;AACA;AwJ11nDI;AACA;AACD;AAED;AxJ21nDF;AACA;AACA;AACA;AACA;AACA;AACA;AwJ31nDI;AACE;AACD;AxJ61nDL;AwJ51nDI;AACD;AAED;AxJ61nDF;AACA;AACA;AACA;AACA;AACA;AACA;AwJ71nDI;AACD;AAED;AxJ81nDF;AACA;AACA;AACA;AACA;AACA;AACA;AwJ91nDI;AACD;AxJg2nDH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyJn9nDA;AzJq9nDA;AyJl9nDA;AzJo9nDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AyJl9nDA;AzJo9nDA;AyJl9nDA;AACE;AACA;AACE;AACD;AzJo9nDH;AACA;AyJn9nDE;AACE;AACD;AAED;AACA;AzJo9nDF;AACA;AyJp9nDE;AACE;AACD;AAED;AzJq9nDF;AACA;AyJr9nDE;AACD;AAED;AzJs9nDA;AACA;AACA;AACA;AACA;AACA;AyJt9nDO;AACL;AACD;AzJw9nDD;AACA;AACA;AF1goDA;AACA","file":"amp-ad-network-fake-impl-0.1.max.js","sourcesContent":["(self.AMP=self.AMP||[]).push({n:\"amp-ad-network-fake-impl\",v:\"1910212059210\",f:(function(AMP,_){\n$1\n})});","(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()","(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getA4ARegistry = getA4ARegistry;\nexports.signingServerURLs = void 0;\n\nvar _cloudflareA4aConfig = require(\"../extensions/amp-ad-network-cloudflare-impl/0.1/cloudflare-a4a-config\");\n\nvar _gmosspA4aConfig = require(\"../extensions/amp-ad-network-gmossp-impl/0.1/gmossp-a4a-config\");\n\nvar _object = require(\"../src/utils/object\");\n\nvar _tripleliftA4aConfig = require(\"../extensions/amp-ad-network-triplelift-impl/0.1/triplelift-a4a-config\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Registry for A4A (AMP Ads for AMPHTML pages) \"is supported\" predicates.\n * If an ad network, {@code ${NETWORK}}, is registered in this object, then the\n * {@code <amp-ad type=\"${NETWORK}\">} implementation will look up its predicate\n * here. If there is a predicate and it and returns {@code true}, then\n * {@code amp-ad} will attempt to render the ad via the A4A pathway (fetch\n * ad creative via early XHR CORS request; verify that it is validated AMP;\n * and then render directly in the host page by splicing into the host DOM).\n * Otherwise, it will attempt to render the ad via the existing \"3p iframe\"\n * pathway (delay load into a cross-domain iframe).\n *\n * @type {!Object<string, function(!Window, !Element): boolean>}\n */\nvar a4aRegistry;\n/**\n * Returns the a4a registry map\n * @return {Object}\n */\n\nfunction getA4ARegistry() {\n  if (!a4aRegistry) {\n    a4aRegistry = (0, _object.map)({\n      'adsense': function adsense() {\n        return true;\n      },\n      'adzerk': function adzerk() {\n        return true;\n      },\n      'doubleclick': function doubleclick() {\n        return true;\n      },\n      'triplelift': _tripleliftA4aConfig.tripleliftIsA4AEnabled,\n      'cloudflare': _cloudflareA4aConfig.cloudflareIsA4AEnabled,\n      'gmossp': _gmosspA4aConfig.gmosspIsA4AEnabled,\n      'fake': function fake() {\n        return true;\n      } // TODO: Add new ad network implementation \"is enabled\" functions here.\n      // Note: if you add a function here that requires a new \"import\", above,\n      // you'll probably also need to add a whitelist exception to\n      // build-system/test-configs/dep-check-config.js in the\n      // \"filesMatching: 'ads/**/*.js'\" rule.\n\n    });\n  }\n\n  return a4aRegistry;\n}\n/**\n * An object mapping signing server names to their corresponding URLs.\n * @type {!Object<string, string>}\n */\n\n\nvar signingServerURLs = {\n  'google': 'https://cdn.ampproject.org/amp-ad-verifying-keyset.json',\n  'google-dev': 'https://cdn.ampproject.org/amp-ad-verifying-keyset-dev.json',\n  'cloudflare': 'https://amp.cloudflare.com/amp-ad-verifying-keyset.json',\n  'cloudflare-dev': 'https://amp.cloudflare.com/amp-ad-verifying-keyset-dev.json'\n};\nexports.signingServerURLs = signingServerURLs;\n\n},{\"../extensions/amp-ad-network-cloudflare-impl/0.1/cloudflare-a4a-config\":14,\"../extensions/amp-ad-network-gmossp-impl/0.1/gmossp-a4a-config\":18,\"../extensions/amp-ad-network-triplelift-impl/0.1/triplelift-a4a-config\":19,\"../src/utils/object\":145}],2:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.adConfig = void 0;\n\nvar _json = require(\"../src/json\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @typedef {{\n *   prefetch: (string|undefined),\n *   preconnect: (string|undefined),\n *   renderStartImplemented: (boolean|undefined),\n *   clientIdScope: (string|undefined),\n *   clientIdCookieName: (string|undefined),\n *   consentHandlingOverride: (boolean|undefined),\n *   remoteHTMLDisabled: (boolean|undefined),\n *   fullWidthHeightRatio: (number|undefined),\n * }}\n */\nvar AdNetworkConfigDef;\n/**\n * The config of each ad network.\n * Please keep the list alphabetic order.\n *\n * yourNetworkName: {  // This is the \"type\" attribute of <amp-ad>\n *\n *   // List of URLs for prefetch\n *   prefetch: string|array\n *\n *   // List of hosts for preconnect\n *   preconnect: string|array\n *\n *   // The scope used to provide CIDs to ads\n *   clientIdScope: string\n *\n *   // The cookie name to store the CID. In absence, `clientIdScope` is used.\n *   clientIdCookieName: string\n *\n *   // If the ad network is willing to override the consent handling, which\n *   // by default is blocking ad load until the consent is accepted.\n *   consentHandlingOverride: boolean\n *\n *   // Whether render-start API has been implemented\n *   // We highly recommend all networks to implement the API,\n *   // see details in the README.md\n *   renderStartImplemented: boolean\n *\n *   // The width / height ratio for full width ad units.\n *   // If absent, it means the network does not support full width ad units.\n *   // Example value: 1.2\n *   fullWidthHeightRatio: number\n * }\n *\n * @const {!Object<string, !JsonObject>}\n */\n\nvar adConfig = JSON.parse(\"{\\\"_ping_\\\":{\\\"renderStartImplemented\\\":true,\\\"clientIdScope\\\":\\\"_PING_\\\",\\\"consentHandlingOverride\\\":true},\\\"1wo\\\":{},\\\"24smi\\\":{\\\"prefetch\\\":\\\"https://jsn.24smi.net/smi.js\\\",\\\"preconnect\\\":\\\"https://data.24smi.net\\\"},\\\"a8\\\":{\\\"prefetch\\\":\\\"https://statics.a8.net/amp/ad.js\\\",\\\"renderStartImplemented\\\":true},\\\"a9\\\":{\\\"prefetch\\\":\\\"https://z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US\\\"},\\\"accesstrade\\\":{\\\"prefetch\\\":\\\"https://h.accesstrade.net/js/amp/amp.js\\\"},\\\"adagio\\\":{\\\"prefetch\\\":\\\"https://js-ssl.neodatagroup.com/adagio_amp.js\\\",\\\"preconnect\\\":[\\\"https://ad-aws-it.neodatagroup.com\\\",\\\"https://tracker.neodatagroup.com\\\"],\\\"renderStartImplemented\\\":true},\\\"adblade\\\":{\\\"prefetch\\\":\\\"https://web.adblade.com/js/ads/async/show.js\\\",\\\"preconnect\\\":[\\\"https://staticd.cdn.adblade.com\\\",\\\"https://static.adblade.com\\\"],\\\"renderStartImplemented\\\":true},\\\"adbutler\\\":{\\\"prefetch\\\":\\\"https://servedbyadbutler.com/app.js\\\"},\\\"adform\\\":{},\\\"adfox\\\":{\\\"prefetch\\\":\\\"https://yastatic.net/pcode/adfox/loader.js\\\",\\\"renderStartImplemented\\\":true},\\\"adgeneration\\\":{\\\"prefetch\\\":\\\"https://i.socdm.com/sdk/js/adg-script-loader.js\\\"},\\\"adglare\\\":{\\\"renderStartImplemented\\\":true},\\\"adhese\\\":{\\\"renderStartImplemented\\\":true},\\\"adincube\\\":{\\\"renderStartImplemented\\\":true},\\\"adition\\\":{},\\\"adman\\\":{},\\\"admanmedia\\\":{\\\"renderStartImplemented\\\":true},\\\"admixer\\\":{\\\"renderStartImplemented\\\":true,\\\"preconnect\\\":[\\\"https://inv-nets.admixer.net\\\",\\\"https://cdn.admixer.net\\\"]},\\\"adocean\\\":{\\\"consentHandlingOverride\\\":true},\\\"adop\\\":{},\\\"adpicker\\\":{\\\"renderStartImplemented\\\":true},\\\"adplugg\\\":{\\\"prefetch\\\":\\\"https://www.adplugg.com/serve/js/ad.js\\\",\\\"renderStartImplemented\\\":true},\\\"adpon\\\":{\\\"prefetch\\\":\\\"https://ad.adpon.jp/amp.js\\\",\\\"clientIdScope\\\":\\\"AMP_ECID_ADPON\\\"},\\\"adreactor\\\":{},\\\"adsensor\\\":{\\\"prefetch\\\":\\\"https://wfpscripts.webspectator.com/amp/adsensor-amp.js\\\",\\\"clientIdScope\\\":\\\"amp_ecid_adensor\\\",\\\"renderStartImplemented\\\":true},\\\"adsloom\\\":{\\\"clientIdScope\\\":\\\"AMP_ECID_ADSLOOM\\\"},\\\"adsnative\\\":{\\\"prefetch\\\":\\\"https://static.adsnative.com/static/js/render.v1.js\\\",\\\"preconnect\\\":\\\"https://api.adsnative.com\\\"},\\\"adspeed\\\":{\\\"preconnect\\\":\\\"https://g.adspeed.net\\\",\\\"renderStartImplemented\\\":true},\\\"adspirit\\\":{},\\\"adstir\\\":{\\\"prefetch\\\":\\\"https://js.ad-stir.com/js/adstir_async.js\\\",\\\"preconnect\\\":\\\"https://ad.ad-stir.com\\\"},\\\"adstyle\\\":{\\\"prefetch\\\":\\\"https://widgets.ad.style/amp.js\\\",\\\"preconnect\\\":[\\\"https://w.ad.style\\\"]},\\\"adtech\\\":{\\\"prefetch\\\":\\\"https://s.aolcdn.com/os/ads/adsWrapper3.js\\\",\\\"preconnect\\\":[\\\"https://mads.at.atwola.com\\\",\\\"https://aka-cdn.adtechus.com\\\"]},\\\"adthrive\\\":{\\\"prefetch\\\":[\\\"https://www.googletagservices.com/tag/js/gpt.js\\\"],\\\"preconnect\\\":[\\\"https://partner.googleadservices.com\\\",\\\"https://securepubads.g.doubleclick.net\\\",\\\"https://tpc.googlesyndication.com\\\"],\\\"renderStartImplemented\\\":true},\\\"adunity\\\":{\\\"preconnect\\\":[\\\"https://content.adunity.com\\\"],\\\"renderStartImplemented\\\":true},\\\"aduptech\\\":{\\\"prefetch\\\":\\\"https://s.d.adup-tech.com/jsapi\\\",\\\"preconnect\\\":[\\\"https://d.adup-tech.com\\\",\\\"https://m.adup-tech.com\\\"],\\\"renderStartImplemented\\\":true},\\\"adventive\\\":{\\\"preconnect\\\":[\\\"https://ads.adventive.com\\\",\\\"https://amp.adventivedev.com\\\"],\\\"renderStartImplemented\\\":true},\\\"adverline\\\":{\\\"prefetch\\\":\\\"https://ads.adverline.com/richmedias/amp.js\\\",\\\"preconnect\\\":[\\\"https://adnext.fr\\\"],\\\"renderStartImplemented\\\":true},\\\"adverticum\\\":{},\\\"advertserve\\\":{\\\"renderStartImplemented\\\":true},\\\"adyoulike\\\":{\\\"consentHandlingOverride\\\":true,\\\"prefetch\\\":\\\"https://fo-static.omnitagjs.com/amp.js\\\",\\\"renderStartImplemented\\\":true},\\\"adzerk\\\":{},\\\"affiliateb\\\":{\\\"prefetch\\\":\\\"https://track.affiliate-b.com/amp/a.js\\\",\\\"renderStartImplemented\\\":true},\\\"aja\\\":{\\\"prefetch\\\":[\\\"https://cdn.as.amanad.adtdp.com/sdk/asot-amp.js\\\",\\\"https://cdn.as.amanad.adtdp.com/sdk/asot-v2.js\\\"],\\\"preconnect\\\":[\\\"https://ad.as.amanad.adtdp.com\\\"]},\\\"appvador\\\":{\\\"prefetch\\\":[\\\"https://cdn.apvdr.com/js/VastAdUnit.min.js\\\",\\\"https://cdn.apvdr.com/js/VideoAd.min.js\\\",\\\"https://cdn.apvdr.com/js/VideoAd3PAS.min.js\\\",\\\"https://cdn.apvdr.com/js/VideoAdAutoPlay.min.js\\\",\\\"https://cdn.apvdr.com/js/VideoAdNative.min.js\\\"],\\\"renderStartImplemented\\\":true},\\\"amoad\\\":{\\\"prefetch\\\":[\\\"https://j.amoad.com/js/a.js\\\",\\\"https://j.amoad.com/js/n.js\\\"],\\\"preconnect\\\":[\\\"https://d.amoad.com\\\",\\\"https://i.amoad.com\\\",\\\"https://m.amoad.com\\\",\\\"https://v.amoad.com\\\"]},\\\"aniview\\\":{\\\"renderStartImplemented\\\":true},\\\"appnexus\\\":{\\\"prefetch\\\":\\\"https://acdn.adnxs.com/ast/ast.js\\\",\\\"preconnect\\\":\\\"https://ib.adnxs.com\\\",\\\"renderStartImplemented\\\":true},\\\"atomx\\\":{\\\"prefetch\\\":\\\"https://s.ato.mx/p.js\\\"},\\\"beaverads\\\":{\\\"renderStartImplemented\\\":true},\\\"beopinion\\\":{\\\"prefetch\\\":\\\"https://widget.beopinion.com/sdk.js\\\",\\\"preconnect\\\":[\\\"https://t.beopinion.com\\\",\\\"https://s.beopinion.com\\\",\\\"https://data.beopinion.com\\\"],\\\"renderStartImplemented\\\":true},\\\"bidtellect\\\":{},\\\"blade\\\":{\\\"prefetch\\\":\\\"https://sdk.streamrail.com/blade/sr.blade.js\\\",\\\"renderStartImplemented\\\":true},\\\"brainy\\\":{},\\\"bringhub\\\":{\\\"renderStartImplemented\\\":true,\\\"preconnect\\\":[\\\"https://static.bh-cdn.com\\\",\\\"https://core-api.bringhub.io\\\"]},\\\"broadstreetads\\\":{\\\"prefetch\\\":\\\"https://cdn.broadstreetads.com/init-2.min.js\\\"},\\\"caajainfeed\\\":{\\\"prefetch\\\":[\\\"https://cdn.amanad.adtdp.com/sdk/ajaamp.js\\\"],\\\"preconnect\\\":[\\\"https://ad.amanad.adtdp.com\\\"]},\\\"capirs\\\":{\\\"renderStartImplemented\\\":true},\\\"caprofitx\\\":{\\\"prefetch\\\":[\\\"https://cdn.caprofitx.com/pfx.min.js\\\",\\\"https://cdn.caprofitx.com/tags/amp/profitx_amp.js\\\"],\\\"preconnect\\\":\\\"https://ad.caprofitx.adtdp.com\\\"},\\\"cedato\\\":{\\\"renderStartImplemented\\\":true},\\\"chargeads\\\":{},\\\"colombia\\\":{\\\"prefetch\\\":\\\"https://static.clmbtech.com/ad/commons/js/colombia-amp.js\\\"},\\\"conative\\\":{\\\"renderStartImplemented\\\":true},\\\"connatix\\\":{\\\"renderStartImplemented\\\":true},\\\"contentad\\\":{},\\\"criteo\\\":{\\\"prefetch\\\":\\\"https://static.criteo.net/js/ld/publishertag.js\\\",\\\"preconnect\\\":\\\"https://cas.criteo.com\\\"},\\\"csa\\\":{\\\"prefetch\\\":\\\"https://www.google.com/adsense/search/ads.js\\\"},\\\"dable\\\":{\\\"preconnect\\\":[\\\"https://static.dable.io\\\",\\\"https://api.dable.io\\\",\\\"https://images.dable.io\\\"],\\\"renderStartImplemented\\\":true},\\\"directadvert\\\":{\\\"renderStartImplemented\\\":true},\\\"distroscale\\\":{\\\"preconnect\\\":[\\\"https://c.jsrdn.com\\\",\\\"https://s.jsrdn.com\\\",\\\"https://i.jsrdn.com\\\"],\\\"renderStartImplemented\\\":true},\\\"dotandads\\\":{\\\"prefetch\\\":\\\"https://amp.ad.dotandad.com/dotandadsAmp.js\\\",\\\"preconnect\\\":\\\"https://bal.ad.dotandad.com\\\"},\\\"dynad\\\":{\\\"preconnect\\\":[\\\"https://t.dynad.net\\\",\\\"https://tm.jsuol.com.br\\\"]},\\\"eadv\\\":{\\\"renderStartImplemented\\\":true,\\\"clientIdScope\\\":\\\"AMP_ECID_EADV\\\",\\\"prefetch\\\":[\\\"https://www.eadv.it/track/esr.min.js\\\",\\\"https://www.eadv.it/track/ead.min.js\\\"]},\\\"eas\\\":{\\\"prefetch\\\":\\\"https://amp.emediate.eu/amp.v0.js\\\",\\\"renderStartImplemented\\\":true},\\\"empower\\\":{\\\"prefetch\\\":\\\"https://cdn.empower.net/sdk/amp-ad.min.js\\\",\\\"renderStartImplemented\\\":true},\\\"engageya\\\":{},\\\"epeex\\\":{},\\\"eplanning\\\":{\\\"prefetch\\\":\\\"https://us.img.e-planning.net/layers/epl-amp.js\\\"},\\\"ezoic\\\":{\\\"prefetch\\\":[\\\"https://www.googletagservices.com/tag/js/gpt.js\\\",\\\"https://g.ezoic.net/ezoic/ampad.js\\\"],\\\"clientIdScope\\\":\\\"AMP_ECID_EZOIC\\\",\\\"consentHandlingOverride\\\":true},\\\"f1e\\\":{\\\"prefetch\\\":\\\"https://img.ak.impact-ad.jp/util/f1e_amp.min.js\\\"},\\\"f1h\\\":{\\\"preconnect\\\":\\\"https://img.ak.impact-ad.jp\\\",\\\"renderStartImplemented\\\":true},\\\"fake\\\":{},\\\"felmat\\\":{\\\"prefetch\\\":\\\"https://t.felmat.net/js/fmamp.js\\\",\\\"renderStartImplemented\\\":true},\\\"flite\\\":{},\\\"fluct\\\":{\\\"preconnect\\\":[\\\"https://cdn-fluct.sh.adingo.jp\\\",\\\"https://s.sh.adingo.jp\\\",\\\"https://i.adingo.jp\\\"]},\\\"forkmedia\\\":{\\\"prefetch\\\":\\\"https://delivery.forkcdn.com/rappio/inread/v1.1/amp/inread.js\\\",\\\"renderStartImplemented\\\":true},\\\"freewheel\\\":{\\\"prefetch\\\":\\\"https://cdn.stickyadstv.com/prime-time/fw-amp.min.js\\\",\\\"renderStartImplemented\\\":true},\\\"fusion\\\":{\\\"prefetch\\\":\\\"https://assets.adtomafusion.net/fusion/latest/fusion-amp.min.js\\\"},\\\"genieessp\\\":{\\\"prefetch\\\":\\\"https://js.gsspcln.jp/l/amp.js\\\"},\\\"giraff\\\":{\\\"renderStartImplemented\\\":true},\\\"gmossp\\\":{\\\"prefetch\\\":\\\"https://cdn.gmossp-sp.jp/ads/amp.js\\\"},\\\"gumgum\\\":{\\\"prefetch\\\":\\\"https://js.gumgum.com/slot.js\\\",\\\"renderStartImplemented\\\":true},\\\"holder\\\":{\\\"prefetch\\\":\\\"https://i.holder.com.ua/js2/holder/ajax/ampv1.js\\\",\\\"preconnect\\\":\\\"https://h.holder.com.ua\\\",\\\"renderStartImplemented\\\":true},\\\"ibillboard\\\":{},\\\"idealmedia\\\":{\\\"renderStartImplemented\\\":true,\\\"preconnect\\\":[\\\"https://jsc.idealmedia.io\\\",\\\"https://servicer.idealmedia.io\\\",\\\"https://s-img.idealmedia.io/\\\"]},\\\"imedia\\\":{\\\"prefetch\\\":\\\"https://i.imedia.cz/js/im3.js\\\",\\\"renderStartImplemented\\\":true},\\\"imobile\\\":{\\\"prefetch\\\":\\\"https://spamp.i-mobile.co.jp/script/amp.js\\\",\\\"preconnect\\\":\\\"https://spad.i-mobile.co.jp\\\"},\\\"imonomy\\\":{\\\"renderStartImplemented\\\":true},\\\"improvedigital\\\":{},\\\"industrybrains\\\":{\\\"prefetch\\\":\\\"https://web.industrybrains.com/js/ads/async/show.js\\\",\\\"preconnect\\\":[\\\"https://staticd.cdn.industrybrains.com\\\",\\\"https://static.industrybrains.com\\\"],\\\"renderStartImplemented\\\":true},\\\"inmobi\\\":{\\\"prefetch\\\":\\\"https://cf.cdn.inmobi.com/ad/inmobi.secure.js\\\",\\\"renderStartImplemented\\\":true},\\\"innity\\\":{\\\"prefetch\\\":\\\"https://cdn.innity.net/admanager.js\\\",\\\"preconnect\\\":\\\"https://as.innity.com\\\",\\\"renderStartImplemented\\\":true},\\\"insticator\\\":{\\\"preconnect\\\":\\\"https://d3lcz8vpax4lo2.cloudfront.net\\\",\\\"renderStartImplemented\\\":true},\\\"invibes\\\":{\\\"prefetch\\\":\\\"https://k.r66net.com/GetAmpLink\\\",\\\"renderStartImplemented\\\":true,\\\"consentHandlingOverride\\\":true},\\\"ix\\\":{\\\"prefetch\\\":[\\\"https://js-sec.indexww.com/apl/amp.js\\\"],\\\"preconnect\\\":\\\"https://as-sec.casalemedia.com\\\",\\\"renderStartImplemented\\\":true},\\\"jubna\\\":{},\\\"kargo\\\":{},\\\"kiosked\\\":{\\\"renderStartImplemented\\\":true},\\\"kixer\\\":{\\\"prefetch\\\":\\\"https://cdn.kixer.com/ad/load.js\\\",\\\"renderStartImplemented\\\":true},\\\"kuadio\\\":{},\\\"lentainform\\\":{\\\"renderStartImplemented\\\":true,\\\"preconnect\\\":[\\\"https://jsc.lentainform.com\\\",\\\"https://servicer.lentainform.com\\\",\\\"https://s-img.lentainform.com\\\"]},\\\"ligatus\\\":{\\\"prefetch\\\":\\\"https://ssl.ligatus.com/render/ligrend.js\\\",\\\"renderStartImplemented\\\":true},\\\"lockerdome\\\":{\\\"prefetch\\\":\\\"https://cdn2.lockerdomecdn.com/_js/amp.js\\\",\\\"renderStartImplemented\\\":true},\\\"logly\\\":{\\\"preconnect\\\":[\\\"https://l.logly.co.jp\\\",\\\"https://cdn.logly.co.jp\\\"],\\\"renderStartImplemented\\\":true},\\\"loka\\\":{\\\"prefetch\\\":\\\"https://loka-cdn.akamaized.net/scene/amp.js\\\",\\\"preconnect\\\":[\\\"https://scene-front.lokaplatform.com\\\",\\\"https://loka-materials.akamaized.net\\\"],\\\"renderStartImplemented\\\":true},\\\"mads\\\":{\\\"prefetch\\\":\\\"https://eu2.madsone.com/js/tags.js\\\"},\\\"mantis-display\\\":{\\\"prefetch\\\":\\\"https://assets.mantisadnetwork.com/mantodea.min.js\\\",\\\"preconnect\\\":[\\\"https://mantodea.mantisadnetwork.com\\\",\\\"https://res.cloudinary.com\\\",\\\"https://resize.mantisadnetwork.com\\\"]},\\\"mantis-recommend\\\":{\\\"prefetch\\\":\\\"https://assets.mantisadnetwork.com/recommend.min.js\\\",\\\"preconnect\\\":[\\\"https://mantodea.mantisadnetwork.com\\\",\\\"https://resize.mantisadnetwork.com\\\"]},\\\"mediaimpact\\\":{\\\"prefetch\\\":\\\"https://ec-ns.sascdn.com/diff/251/pages/amp_default.js\\\",\\\"preconnect\\\":[\\\"https://ww251.smartadserver.com\\\",\\\"https://static.sascdn.com/\\\"],\\\"renderStartImplemented\\\":true},\\\"medianet\\\":{\\\"preconnect\\\":\\\"https://contextual.media.net\\\",\\\"renderStartImplemented\\\":true},\\\"mediavine\\\":{\\\"prefetch\\\":\\\"https://amp.mediavine.com/wrapper.min.js\\\",\\\"preconnect\\\":[\\\"https://partner.googleadservices.com\\\",\\\"https://securepubads.g.doubleclick.net\\\",\\\"https://tpc.googlesyndication.com\\\"],\\\"renderStartImplemented\\\":true,\\\"consentHandlingOverride\\\":true},\\\"medyanet\\\":{\\\"renderStartImplemented\\\":true},\\\"meg\\\":{\\\"renderStartImplemented\\\":true},\\\"mgid\\\":{\\\"renderStartImplemented\\\":true,\\\"preconnect\\\":[\\\"https://jsc.mgid.com\\\",\\\"https://servicer.mgid.com\\\",\\\"https://s-img.mgid.com\\\"]},\\\"microad\\\":{\\\"prefetch\\\":\\\"https://j.microad.net/js/camp.js\\\",\\\"preconnect\\\":[\\\"https://s-rtb.send.microad.jp\\\",\\\"https://s-rtb.send.microadinc.com\\\",\\\"https://cache.send.microad.jp\\\",\\\"https://cache.send.microadinc.com\\\",\\\"https://deb.send.microad.jp\\\"]},\\\"miximedia\\\":{\\\"renderStartImplemented\\\":true},\\\"mixpo\\\":{\\\"prefetch\\\":\\\"https://cdn.mixpo.com/js/loader.js\\\",\\\"preconnect\\\":[\\\"https://player1.mixpo.com\\\",\\\"https://player2.mixpo.com\\\"]},\\\"monetizer101\\\":{\\\"renderStartImplemented\\\":true},\\\"mox\\\":{\\\"prefetch\\\":[\\\"https://ad.mox.tv/js/amp.min.js\\\",\\\"https://ad.mox.tv/mox/mwayss_invocation.min.js\\\"],\\\"renderStartImplemented\\\":true},\\\"mytarget\\\":{\\\"prefetch\\\":\\\"https://ad.mail.ru/static/ads-async.js\\\",\\\"renderStartImplemented\\\":true},\\\"mywidget\\\":{\\\"preconnect\\\":\\\"https://likemore-fe.go.mail.ru\\\",\\\"prefetch\\\":\\\"https://likemore-go.imgsmail.ru/widget_amp.js\\\",\\\"renderStartImplemented\\\":true},\\\"nativeroll\\\":{\\\"prefetch\\\":\\\"https://cdn01.nativeroll.tv/js/seedr-player.min.js\\\"},\\\"nativo\\\":{\\\"prefetch\\\":\\\"https://s.ntv.io/serve/load.js\\\"},\\\"navegg\\\":{\\\"renderStartImplemented\\\":true},\\\"nend\\\":{\\\"prefetch\\\":\\\"https://js1.nend.net/js/amp.js\\\",\\\"preconnect\\\":[\\\"https://output.nend.net\\\",\\\"https://img1.nend.net\\\"]},\\\"netletix\\\":{\\\"preconnect\\\":[\\\"https://call.netzathleten-media.de\\\"],\\\"renderStartImplemented\\\":true},\\\"noddus\\\":{\\\"prefetch\\\":\\\"https://noddus.com/amp_loader.js\\\",\\\"renderStartImplemented\\\":true},\\\"nokta\\\":{\\\"prefetch\\\":\\\"https://static.virgul.com/theme/mockups/noktaamp/ampjs.js\\\",\\\"renderStartImplemented\\\":true},\\\"nws\\\":{},\\\"onead\\\":{\\\"prefetch\\\":\\\"https://ad-specs.guoshipartners.com/static/js/onead-amp.min.js\\\",\\\"renderStartImplemented\\\":true},\\\"onnetwork\\\":{\\\"renderStartImplemented\\\":true},\\\"openadstream\\\":{},\\\"openx\\\":{\\\"prefetch\\\":\\\"https://www.googletagservices.com/tag/js/gpt.js\\\",\\\"preconnect\\\":[\\\"https://partner.googleadservices.com\\\",\\\"https://securepubads.g.doubleclick.net\\\",\\\"https://tpc.googlesyndication.com\\\"],\\\"renderStartImplemented\\\":true},\\\"opinary\\\":{},\\\"outbrain\\\":{\\\"renderStartImplemented\\\":true,\\\"prefetch\\\":\\\"https://widgets.outbrain.com/widgetAMP/outbrainAMP.min.js\\\",\\\"preconnect\\\":[\\\"https://odb.outbrain.com\\\"],\\\"consentHandlingOverride\\\":true},\\\"pixels\\\":{\\\"prefetch\\\":\\\"https://cdn.adsfactor.net/amp/pixels-amp.min.js\\\",\\\"clientIdCookieName\\\":\\\"__AF\\\",\\\"renderStartImplemented\\\":true},\\\"plista\\\":{},\\\"polymorphicads\\\":{\\\"prefetch\\\":\\\"https://www.polymorphicads.jp/js/amp.js\\\",\\\"preconnect\\\":[\\\"https://img.polymorphicads.jp\\\",\\\"https://ad.polymorphicads.jp\\\"],\\\"renderStartImplemented\\\":true},\\\"popin\\\":{\\\"renderStartImplemented\\\":true},\\\"postquare\\\":{},\\\"pressboard\\\":{\\\"renderStartImplemented\\\":true},\\\"promoteiq\\\":{},\\\"pubexchange\\\":{},\\\"pubguru\\\":{\\\"renderStartImplemented\\\":true},\\\"pubmatic\\\":{\\\"prefetch\\\":\\\"https://ads.pubmatic.com/AdServer/js/amp.js\\\"},\\\"pubmine\\\":{\\\"prefetch\\\":[\\\"https://s.pubmine.com/head.js\\\"],\\\"preconnect\\\":\\\"https://delivery.g.switchadhub.com\\\",\\\"renderStartImplemented\\\":true},\\\"puffnetwork\\\":{\\\"prefetch\\\":\\\"https://static.puffnetwork.com/amp_ad.js\\\",\\\"renderStartImplemented\\\":true},\\\"pulsepoint\\\":{\\\"prefetch\\\":\\\"https://ads.contextweb.com/TagPublish/getjs.static.js\\\",\\\"preconnect\\\":\\\"https://tag.contextweb.com\\\"},\\\"purch\\\":{\\\"prefetch\\\":\\\"https://ramp.purch.com/serve/creative_amp.js\\\",\\\"renderStartImplemented\\\":true},\\\"quoraad\\\":{\\\"prefetch\\\":\\\"https://a.quora.com/amp_ad.js\\\",\\\"preconnect\\\":\\\"https://ampad.quora.com\\\",\\\"renderStartImplemented\\\":true},\\\"rbinfox\\\":{\\\"renderStartImplemented\\\":true},\\\"readmo\\\":{\\\"renderStartImplemented\\\":true},\\\"realclick\\\":{\\\"renderStartImplemented\\\":true},\\\"recomad\\\":{\\\"renderStartImplemented\\\":true},\\\"relap\\\":{\\\"renderStartImplemented\\\":true},\\\"revcontent\\\":{\\\"prefetch\\\":\\\"https://labs-cdn.revcontent.com/build/amphtml/revcontent.amp.min.js\\\",\\\"preconnect\\\":[\\\"https://trends.revcontent.com\\\",\\\"https://cdn.revcontent.com\\\",\\\"https://img.revcontent.com\\\"],\\\"renderStartImplemented\\\":true},\\\"revjet\\\":{\\\"prefetch\\\":\\\"https://cdn.revjet.com/~cdn/JS/03/amp.js\\\",\\\"renderStartImplemented\\\":true},\\\"rfp\\\":{\\\"prefetch\\\":\\\"https://js.rfp.fout.jp/rfp-amp.js\\\",\\\"preconnect\\\":\\\"https://ad.rfp.fout.jp\\\",\\\"renderStartImplemented\\\":true},\\\"rnetplus\\\":{},\\\"rubicon\\\":{},\\\"runative\\\":{\\\"prefetch\\\":\\\"https://cdn.run-syndicate.com/sdk/v1/n.js\\\",\\\"renderStartImplemented\\\":true},\\\"sas\\\":{\\\"renderStartImplemented\\\":true},\\\"seedingalliance\\\":{},\\\"sekindo\\\":{\\\"renderStartImplemented\\\":true},\\\"sharethrough\\\":{\\\"renderStartImplemented\\\":true},\\\"shemedia\\\":{\\\"prefetch\\\":[\\\"https://securepubads.g.doubleclick.net/tag/js/gpt.js\\\",\\\"https://ads.shemedia.com/static/amp.js\\\"],\\\"preconnect\\\":[\\\"https://partner.googleadservices.com\\\",\\\"https://tpc.googlesyndication.com\\\",\\\"https://ads.blogherads.com\\\"],\\\"renderStartImplemented\\\":true},\\\"sklik\\\":{\\\"prefetch\\\":\\\"https://c.imedia.cz/js/amp.js\\\"},\\\"slimcutmedia\\\":{\\\"preconnect\\\":[\\\"https://sb.freeskreen.com\\\",\\\"https://static.freeskreen.com\\\",\\\"https://video.freeskreen.com\\\"],\\\"renderStartImplemented\\\":true},\\\"smartadserver\\\":{\\\"prefetch\\\":\\\"https://ec-ns.sascdn.com/diff/js/amp.v0.js\\\",\\\"preconnect\\\":\\\"https://static.sascdn.com\\\",\\\"renderStartImplemented\\\":true},\\\"smartclip\\\":{\\\"prefetch\\\":\\\"https://cdn.smartclip.net/amp/amp.v0.js\\\",\\\"preconnect\\\":\\\"https://des.smartclip.net\\\",\\\"renderStartImplemented\\\":true},\\\"smi2\\\":{\\\"renderStartImplemented\\\":true},\\\"smilewanted\\\":{\\\"prefetch\\\":\\\"https://prebid.smilewanted.com/amp/amp.js\\\",\\\"preconnect\\\":\\\"https://static.smilewanted.com\\\",\\\"renderStartImplemented\\\":true},\\\"sogouad\\\":{\\\"prefetch\\\":\\\"https://theta.sogoucdn.com/wap/js/aw.js\\\",\\\"renderStartImplemented\\\":true},\\\"sortable\\\":{\\\"prefetch\\\":\\\"https://www.googletagservices.com/tag/js/gpt.js\\\",\\\"preconnect\\\":[\\\"https://tags-cdn.deployads.com\\\",\\\"https://partner.googleadservices.com\\\",\\\"https://securepubads.g.doubleclick.net\\\",\\\"https://tpc.googlesyndication.com\\\"],\\\"renderStartImplemented\\\":true},\\\"sovrn\\\":{\\\"prefetch\\\":\\\"https://ap.lijit.com/www/sovrn_amp/sovrn_ads.js\\\"},\\\"speakol\\\":{\\\"renderStartImplemented\\\":true},\\\"spotx\\\":{\\\"preconnect\\\":\\\"https://js.spotx.tv\\\",\\\"renderStartImplemented\\\":true},\\\"strossle\\\":{\\\"preconnect\\\":[\\\"https://amp.spklw.com\\\",\\\"https://widgets.sprinklecontent.com\\\",\\\"https://images.sprinklecontent.com\\\"]},\\\"sunmedia\\\":{\\\"prefetch\\\":\\\"https://vod.addevweb.com/sunmedia/amp/ads/sunmedia.js\\\",\\\"preconnect\\\":\\\"https://static.addevweb.com\\\",\\\"renderStartImplemented\\\":true},\\\"svknative\\\":{\\\"renderStartImplemented\\\":true,\\\"prefetch\\\":\\\"https://widget.svk-native.ru/js/embed.js\\\"},\\\"swoop\\\":{\\\"prefetch\\\":\\\"https://www.swoop-amp.com/amp.js\\\",\\\"preconnect\\\":[\\\"https://www.swpsvc.com\\\",\\\"https://client.swpcld.com\\\"],\\\"renderStartImplemented\\\":true},\\\"taboola\\\":{},\\\"tcsemotion\\\":{\\\"prefetch\\\":\\\"https://ads.tcsemotion.com/www/delivery/amphb.js\\\",\\\"renderStartImplemented\\\":true},\\\"teads\\\":{\\\"prefetch\\\":\\\"https://a.teads.tv/media/format/v3/teads-format.min.js\\\",\\\"preconnect\\\":[\\\"https://cdn2.teads.tv\\\",\\\"https://t.teads.tv\\\",\\\"https://r.teads.tv\\\"],\\\"consentHandlingOverride\\\":true},\\\"torimochi\\\":{\\\"renderStartImplemented\\\":true},\\\"tracdelight\\\":{\\\"prefetch\\\":\\\"https://scripts.tracdelight.io/amp.js\\\",\\\"renderStartImplemented\\\":true},\\\"triplelift\\\":{},\\\"trugaze\\\":{\\\"clientIdScope\\\":\\\"__tg_amp\\\",\\\"renderStartImplemented\\\":true},\\\"uas\\\":{\\\"prefetch\\\":\\\"https://ads.pubmatic.com/AdServer/js/phoenix.js\\\"},\\\"ucfunnel\\\":{\\\"renderStartImplemented\\\":true},\\\"uzou\\\":{\\\"preconnect\\\":[\\\"https://speee-ad.akamaized.net\\\"],\\\"renderStartImplemented\\\":true},\\\"unruly\\\":{\\\"prefetch\\\":\\\"https://video.unrulymedia.com/native/native-loader.js\\\",\\\"renderStartImplemented\\\":true},\\\"valuecommerce\\\":{\\\"prefetch\\\":\\\"https://amp.valuecommerce.com/amp_bridge.js\\\",\\\"preconnect\\\":[\\\"https://ad.jp.ap.valuecommerce.com\\\"],\\\"renderStartImplemented\\\":true},\\\"videointelligence\\\":{\\\"preconnect\\\":\\\"https://s.vi-serve.com\\\",\\\"renderStartImplemented\\\":true},\\\"videonow\\\":{\\\"renderStartImplemented\\\":true},\\\"viralize\\\":{\\\"renderStartImplemented\\\":true},\\\"vmfive\\\":{\\\"prefetch\\\":\\\"https://man.vm5apis.com/dist/adn-web-sdk.js\\\",\\\"preconnect\\\":[\\\"https://vawpro.vm5apis.com\\\",\\\"https://vahfront.vm5apis.com\\\"],\\\"renderStartImplemented\\\":true},\\\"webediads\\\":{\\\"prefetch\\\":\\\"https://eu1.wbdds.com/amp.min.js\\\",\\\"preconnect\\\":[\\\"https://goutee.top\\\",\\\"https://mediaathay.org.uk\\\"],\\\"renderStartImplemented\\\":true},\\\"weborama-display\\\":{\\\"prefetch\\\":[\\\"https://cstatic.weborama.fr/js/advertiserv2/adperf_launch_1.0.0_scrambled.js\\\",\\\"https://cstatic.weborama.fr/js/advertiserv2/adperf_core_1.0.0_scrambled.js\\\"]},\\\"widespace\\\":{},\\\"wisteria\\\":{\\\"renderStartImplemented\\\":true},\\\"wpmedia\\\":{\\\"prefetch\\\":\\\"https://std.wpcdn.pl/wpjslib/wpjslib-amp.js\\\",\\\"preconnect\\\":[\\\"https://www.wp.pl\\\",\\\"https://v.wpimg.pl\\\"],\\\"renderStartImplemented\\\":true},\\\"xlift\\\":{\\\"prefetch\\\":\\\"https://cdn.x-lift.jp/resources/common/xlift_amp.js\\\",\\\"renderStartImplemented\\\":true},\\\"yahoo\\\":{\\\"prefetch\\\":\\\"https://s.yimg.com/os/ampad/display.js\\\",\\\"preconnect\\\":\\\"https://us.adserver.yahoo.com\\\"},\\\"yahoojp\\\":{\\\"prefetch\\\":[\\\"https://s.yimg.jp/images/listing/tool/yads/ydn/amp/amp.js\\\",\\\"https://yads.c.yimg.jp/js/yads.js\\\"],\\\"preconnect\\\":\\\"https://yads.yahoo.co.jp\\\"},\\\"yahoonativeads\\\":{\\\"renderStartImplemented\\\":true},\\\"yandex\\\":{\\\"prefetch\\\":\\\"https://yastatic.net/partner-code/loaders/context_amp.js\\\",\\\"renderStartImplemented\\\":true},\\\"yengo\\\":{\\\"renderStartImplemented\\\":true},\\\"yieldbot\\\":{\\\"prefetch\\\":[\\\"https://cdn.yldbt.com/js/yieldbot.intent.amp.js\\\",\\\"https://msg.yldbt.com/js/ybmsg.html\\\"],\\\"preconnect\\\":\\\"https://i.yldbt.com\\\"},\\\"yieldmo\\\":{\\\"prefetch\\\":\\\"https://static.yieldmo.com/ym.1.js\\\",\\\"preconnect\\\":[\\\"https://s.yieldmo.com\\\",\\\"https://ads.yieldmo.com\\\"],\\\"renderStartImplemented\\\":true},\\\"yieldone\\\":{\\\"prefetch\\\":\\\"https://img.ak.impact-ad.jp/ic/pone/commonjs/yone-amp.js\\\"},\\\"yieldpro\\\":{\\\"preconnect\\\":\\\"https://creatives.yieldpro.eu\\\",\\\"renderStartImplemented\\\":true},\\\"zedo\\\":{\\\"prefetch\\\":\\\"https://ss3.zedo.com/gecko/tag/Gecko.amp.min.js\\\",\\\"renderStartImplemented\\\":true},\\\"zen\\\":{\\\"prefetch\\\":\\\"https://zen.yandex.ru/widget-loader\\\",\\\"preconnect\\\":[\\\"https://yastatic.net/\\\"],\\\"renderStartImplemented\\\":true},\\\"zergnet\\\":{},\\\"zucks\\\":{\\\"preconnect\\\":[\\\"https://j.zucks.net.zimg.jp\\\",\\\"https://sh.zucks.net\\\",\\\"https://k.zucks.net\\\",\\\"https://static.zucks.net.zimg.jp\\\"]},\\\"baidu\\\":{\\\"prefetch\\\":\\\"https://dup.baidustatic.com/js/dm.js\\\",\\\"renderStartImplemented\\\":true}}\");\nexports.adConfig = adConfig;\n\n},{\"../src/json\":63}],3:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.buildUrl = buildUrl;\nexports.QueryParameterDef = void 0;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @typedef {{name: string, value: (string|number|null)}} */\nvar QueryParameterDef;\n/**\n * Builds a URL from query parameters, truncating to a maximum length if\n * necessary.\n * @param {string} baseUrl scheme, domain, and path for the URL.\n * @param {!Object<string,string|number|null>} queryParams query parameters for\n *     the URL.\n * @param {number} maxLength length to truncate the URL to if necessary.\n * @param {?QueryParameterDef=} opt_truncationQueryParam query parameter to\n *     append to the URL iff any query parameters were truncated.\n * @return {string} the fully constructed URL.\n */\n\nexports.QueryParameterDef = QueryParameterDef;\n\nfunction buildUrl(baseUrl, queryParams, maxLength, opt_truncationQueryParam) {\n  var encodedParams = [];\n  var encodedTruncationParam = opt_truncationQueryParam && !(opt_truncationQueryParam.value == null || opt_truncationQueryParam.value === '') ? encodeURIComponent(opt_truncationQueryParam.name) + '=' + encodeURIComponent(String(opt_truncationQueryParam.value)) : null;\n  var capacity = maxLength - baseUrl.length;\n\n  if (encodedTruncationParam) {\n    capacity -= encodedTruncationParam.length + 1;\n  }\n\n  var keys = Object.keys(queryParams);\n\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n    var value = queryParams[key];\n\n    if (value == null || value === '') {\n      continue;\n    }\n\n    var encodedNameAndSep = encodeURIComponent(key) + '=';\n    var encodedValue = encodeURIComponent(String(value));\n    var fullLength = encodedNameAndSep.length + encodedValue.length + 1;\n\n    if (fullLength > capacity) {\n      var truncatedValue = encodedValue.substr(0, capacity - encodedNameAndSep.length - 1) // Don't end with a partially truncated escape sequence\n      .replace(/%\\w?$/, '');\n\n      if (truncatedValue) {\n        encodedParams.push(encodedNameAndSep + truncatedValue);\n      }\n\n      if (encodedTruncationParam) {\n        encodedParams.push(encodedTruncationParam);\n      }\n\n      break;\n    }\n\n    encodedParams.push(encodedNameAndSep + encodedValue);\n    capacity -= fullLength;\n  }\n\n  if (!encodedParams.length) {\n    return baseUrl;\n  }\n\n  return baseUrl + '?' + encodedParams.join('&');\n}\n\n},{}],4:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.extractUrlExperimentId = extractUrlExperimentId;\nexports.parseExperimentIds = parseExperimentIds;\nexports.isInExperiment = isInExperiment;\nexports.isInManualExperiment = isInManualExperiment;\nexports.validateExperimentIds = validateExperimentIds;\nexports.addExperimentIdToElement = addExperimentIdToElement;\nexports.SINGLE_PASS_EXPERIMENT_IDS = exports.MANUAL_EXPERIMENT_ID = exports.A4aExperimentBranches = void 0;\n\nvar _utils = require(\"./utils\");\n\nvar _experiments = require(\"../../../src/experiments\");\n\nvar _services = require(\"../../../src/services\");\n\nvar _url = require(\"../../../src/url\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Machinery for doing \"traffic-level\" experiments.  That is, rather than\n * a single user choosing to opt-in to an experimental version of a module,\n * this framework allows you to do randomized, controlled experiments on all\n * AMP page loads to, for example, test relative performance or look for\n * impacts on click-throughs.\n */\n\n/** @typedef {{\n *    control: string,\n *    experiment: string\n *  }} */\nvar A4aExperimentBranches;\n/** @type {string} @private */\n\nexports.A4aExperimentBranches = A4aExperimentBranches;\nvar MANUAL_EXPERIMENT_ID = '117152632';\n/**\n * Experiment IDs used to identify single pass experiments.\n *\n * @enum {string}\n */\n\nexports.MANUAL_EXPERIMENT_ID = MANUAL_EXPERIMENT_ID;\nvar SINGLE_PASS_EXPERIMENT_IDS = {\n  MULTI_PASS: '21063529',\n  SINGLE_PASS: '21063530'\n};\n/**\n * @param {!Window} win\n * @param {!Element} element Ad tag Element.\n * @return {?string} experiment extracted from page url.\n */\n\nexports.SINGLE_PASS_EXPERIMENT_IDS = SINGLE_PASS_EXPERIMENT_IDS;\n\nfunction extractUrlExperimentId(win, element) {\n  var expParam = _services.Services.ampdoc(element).getParam('exp') || (0, _url.parseQueryString)(win.location.search)['exp'];\n\n  if (!expParam) {\n    return null;\n  } // Allow for per type experiment control with Doubleclick key set for 'da'\n  // and AdSense using 'aa'.  Fallback to 'a4a' if type specific is missing.\n\n\n  var expKeys = [(element.getAttribute('type') || '').toLowerCase() == 'doubleclick' ? 'da' : 'aa', 'a4a'];\n  var arg;\n  var match;\n  expKeys.forEach(function (key) {\n    return arg = arg || (match = new RegExp(\"(?:^|,)\" + key + \":(-?\\\\d+)\").exec(expParam)) && match[1];\n  });\n  return arg || null;\n}\n/**\n * Sets of experiment IDs can be attached to Elements via attributes.  In\n * that case, we encode them as a string containing a comma-separated list\n * of experiment IDs.  This parses a comma-separated list from a string into\n * a list of ID strings.  If the input string is empty or null, this returns\n * the empty list.  This does no validity checking on the ID formats -- for\n * that, use validateExperimentIds.\n *\n * @param {?string} idString  String to parse.\n * @return {!Array<string>}  List of experiment IDs (possibly empty).\n * @see validateExperimentIds\n */\n\n\nfunction parseExperimentIds(idString) {\n  if (idString) {\n    return idString.split(',');\n  }\n\n  return [];\n}\n/**\n * Checks whether the given element is a member of the given experiment branch.\n * I.e., whether the element's data-experiment-id attribute contains the id\n * value (possibly because the host page URL contains a 'exp=a4a:X' parameter\n * and #maybeSetExperimentFromUrl has added the appropriate EID).\n *\n * @param {!Element} element Element to check for membership in a specific\n *   experiment.\n * @param {?string} id Experiment ID to check for on `element`.\n * @return {boolean}\n */\n\n\nfunction isInExperiment(element, id) {\n  return parseExperimentIds(element.getAttribute(_utils.EXPERIMENT_ATTRIBUTE)).some(function (x) {\n    return x === id;\n  });\n}\n/**\n * Checks whether the given element is a member of the 'manually triggered\n * \"experiment\" branch'.  I.e., whether the element's data-experiment-id\n * attribute contains the MANUAL_EXPERIMENT_ID value (hopefully because the\n * user has manually specified 'exp=a4a:-1' in the host page URL and\n * #maybeSetExperimentFromUrl has added it).\n *\n * @param {!Element} element  Element to check for manual experiment membership.\n * @return {boolean}\n */\n\n\nfunction isInManualExperiment(element) {\n  return isInExperiment(element, MANUAL_EXPERIMENT_ID);\n}\n/**\n * Checks that all string experiment IDs in a list are syntactically valid\n * (integer base 10).\n *\n * @param {!Array<string>} idList  List of experiment IDs.  Can be empty.\n * @return {boolean} Whether all list elements are valid experiment IDs.\n */\n\n\nfunction validateExperimentIds(idList) {\n  return idList.every(function (id) {\n    return !isNaN(parseInt(id, 10));\n  });\n}\n/**\n * Adds a single experimentID to an element iff it's a valid experiment ID.\n * No-ops if the experimentId is undefined.\n *\n * @param {string|undefined} experimentId  ID to add to the element.\n * @param {Element} element to add the experiment ID to.\n */\n\n\nfunction addExperimentIdToElement(experimentId, element) {\n  if (!experimentId) {\n    return;\n  }\n\n  var currentEids = element.getAttribute(_utils.EXPERIMENT_ATTRIBUTE);\n\n  if (currentEids && validateExperimentIds(parseExperimentIds(currentEids))) {\n    element.setAttribute(_utils.EXPERIMENT_ATTRIBUTE, (0, _utils.mergeExperimentIds)([experimentId], currentEids));\n  } else {\n    element.setAttribute(_utils.EXPERIMENT_ATTRIBUTE, experimentId);\n  }\n}\n\n},{\"../../../src/experiments\":47,\"../../../src/services\":123,\"../../../src/url\":134,\"./utils\":5}],5:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.isGoogleAdsA4AValidEnvironment = isGoogleAdsA4AValidEnvironment;\nexports.supportsNativeCrypto = supportsNativeCrypto;\nexports.isReportingEnabled = isReportingEnabled;\nexports.googleBlockParameters = googleBlockParameters;\nexports.groupAmpAdsByType = groupAmpAdsByType;\nexports.googlePageParameters = googlePageParameters;\nexports.googleAdUrl = googleAdUrl;\nexports.truncAndTimeUrl = truncAndTimeUrl;\nexports.extractHost = extractHost;\nexports.getCorrelator = getCorrelator;\nexports.additionalDimensions = additionalDimensions;\nexports.getCsiAmpAnalyticsConfig = getCsiAmpAnalyticsConfig;\nexports.getCsiAmpAnalyticsVariables = getCsiAmpAnalyticsVariables;\nexports.extractAmpAnalyticsConfig = extractAmpAnalyticsConfig;\nexports.mergeExperimentIds = mergeExperimentIds;\nexports.addCsiSignalsToAmpAnalyticsConfig = addCsiSignalsToAmpAnalyticsConfig;\nexports.getEnclosingContainerTypes = getEnclosingContainerTypes;\nexports.maybeAppendErrorParameter = maybeAppendErrorParameter;\nexports.getBinaryTypeNumericalCode = getBinaryTypeNumericalCode;\nexports.getIdentityToken = getIdentityToken;\nexports.getIdentityTokenRequestUrl = getIdentityTokenRequestUrl;\nexports.isCdnProxy = isCdnProxy;\nexports.setNameframeExperimentConfigs = setNameframeExperimentConfigs;\nexports.getAmpRuntimeTypeParameter = getAmpRuntimeTypeParameter;\nexports.IdentityToken = exports.TRUNCATION_PARAM = exports.NameframeExperimentConfig = exports.AmpAnalyticsConfigDef = exports.EXPERIMENT_ATTRIBUTE = exports.SANDBOX_HEADER = exports.QQID_HEADER = exports.ValidAdContainerTypes = void 0;\n\nvar _consentState = require(\"../../../src/consent-state\");\n\nvar _domFingerprint = require(\"../../../src/utils/dom-fingerprint\");\n\nvar _services = require(\"../../../src/services\");\n\nvar _urlBuilder = require(\"./shared/url-builder\");\n\nvar _log = require(\"../../../src/log\");\n\nvar _object = require(\"../../../src/utils/object\");\n\nvar _experiments = require(\"../../../src/experiments\");\n\nvar _consent = require(\"../../../src/consent\");\n\nvar _iniLoad = require(\"../../../src/ini-load\");\n\nvar _mode = require(\"../../../src/mode\");\n\nvar _adCid = require(\"../../../src/ad-cid\");\n\nvar _variableSource = require(\"../../../src/service/variable-source\");\n\nvar _internalVersion = require(\"../../../src/internal-version\");\n\nvar _json = require(\"../../../src/json\");\n\nvar _dom = require(\"../../../src/dom\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @type {string}  */\nvar AMP_ANALYTICS_HEADER = 'X-AmpAnalytics';\n/** @const {number} */\n\nvar MAX_URL_LENGTH = 15360;\n/** @enum {string} */\n\nvar AmpAdImplementation = {\n  AMP_AD_XHR_TO_IFRAME: '2',\n  AMP_AD_XHR_TO_IFRAME_OR_AMP: '3',\n  AMP_AD_IFRAME_GET: '5'\n};\n/** @const {!Object} */\n\nvar ValidAdContainerTypes = {\n  'AMP-CAROUSEL': 'ac',\n  'AMP-FX-FLYING-CARPET': 'fc',\n  'AMP-LIGHTBOX': 'lb',\n  'AMP-STICKY-AD': 'sa'\n};\n/**\n * See `VisibilityState` enum.\n * @const {!Object<string, string>}\n */\n\nexports.ValidAdContainerTypes = ValidAdContainerTypes;\nvar visibilityStateCodes = {\n  'visible': '1',\n  'hidden': '2',\n  'prerender': '3',\n  'unloaded': '5'\n};\n/** @const {string} */\n\nvar QQID_HEADER = 'X-QQID';\n/** @type {string} */\n\nexports.QQID_HEADER = QQID_HEADER;\nvar SANDBOX_HEADER = 'amp-ff-sandbox';\n/**\n * Element attribute that stores experiment IDs.\n *\n * Note: This attribute should be used only for tracking experimental\n * implementations of AMP tags, e.g., by AMPHTML implementors.  It should not be\n * added by a publisher page.\n *\n * @const {string}\n * @visibleForTesting\n */\n\nexports.SANDBOX_HEADER = SANDBOX_HEADER;\nvar EXPERIMENT_ATTRIBUTE = 'data-experiment-id';\n/** @typedef {{urls: !Array<string>}}\n */\n\nexports.EXPERIMENT_ATTRIBUTE = EXPERIMENT_ATTRIBUTE;\nvar AmpAnalyticsConfigDef;\n/**\n * @typedef {{instantLoad: boolean, writeInBody: boolean}}\n */\n\nexports.AmpAnalyticsConfigDef = AmpAnalyticsConfigDef;\nvar NameframeExperimentConfig;\n/**\n * @const {!./shared/url-builder.QueryParameterDef}\n * @visibleForTesting\n */\n\nexports.NameframeExperimentConfig = NameframeExperimentConfig;\nvar TRUNCATION_PARAM = {\n  name: 'trunc',\n  value: '1'\n};\n/** @const {Object} */\n\nexports.TRUNCATION_PARAM = TRUNCATION_PARAM;\nvar CDN_PROXY_REGEXP = /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org((\\/.*)|($))+/;\n/**\n * Returns the value of some navigation timing parameter.\n * Feature detection is used for safety on browsers that do not support the\n * performance API.\n * @param {!Window} win\n * @param {string} timingEvent The name of the timing event, e.g.\n *     'navigationStart' or 'domContentLoadEventStart'.\n * @return {number}\n */\n\nfunction getNavigationTiming(win, timingEvent) {\n  return win['performance'] && win['performance']['timing'] && win['performance']['timing'][timingEvent] || 0;\n}\n/**\n * Check whether Google Ads supports the A4A rendering pathway is valid for the\n * environment by ensuring native crypto support and page originated in the\n * {@code cdn.ampproject.org} CDN <em>or</em> we must be running in local\n * dev mode.\n *\n * @param {!Window} win  Host window for the ad.\n * @return {boolean}  Whether Google Ads should attempt to render via the A4A\n *   pathway.\n */\n\n\nfunction isGoogleAdsA4AValidEnvironment(win) {\n  return supportsNativeCrypto(win) && (!!isCdnProxy(win) || (0, _mode.getMode)(win).localDev || (0, _mode.getMode)(win).test);\n}\n/**\n * Checks whether native crypto is supported for win.\n * @param {!Window} win  Host window for the ad.\n * @return {boolean} Whether native crypto is supported.\n */\n\n\nfunction supportsNativeCrypto(win) {\n  return win.crypto && (win.crypto.subtle || win.crypto.webkitSubtle);\n}\n/**\n * @param {!AMP.BaseElement} ampElement The element on whose lifecycle this\n *    reporter will be reporting.\n * @return {boolean} whether reporting is enabled for this element\n */\n\n\nfunction isReportingEnabled(ampElement) {\n  // Carve-outs: We only want to enable profiling pingbacks when:\n  //   - The ad is from one of the Google networks (AdSense or Doubleclick).\n  //   - The ad slot is in the A4A-vs-3p amp-ad control branch (either via\n  //     internal, client-side selection or via external, Google Search\n  //     selection).\n  //   - We haven't turned off profiling via the rate controls in\n  //     build-system/global-config/{canary,prod}-config.json\n  // If any of those fail, we use the `BaseLifecycleReporter`, which is a\n  // a no-op (sends no pings).\n  var type = ampElement.element.getAttribute('type');\n  var win = ampElement.win; // In local dev mode, neither the canary nor prod config files is available,\n  // so manually set the profiling rate, for testing/dev.\n\n  if ((0, _mode.getMode)(ampElement.win).localDev && !(0, _mode.getMode)(ampElement.win).test) {\n    (0, _experiments.toggleExperiment)(win, 'a4aProfilingRate', true, true);\n  }\n\n  return (type == 'doubleclick' || type == 'adsense') && (0, _experiments.isExperimentOn)(win, 'a4aProfilingRate');\n}\n/**\n * Has side-effect of incrementing ifi counter on window.\n * @param {!../../../extensions/amp-a4a/0.1/amp-a4a.AmpA4A} a4a\n * @param {!Array<string>=} opt_experimentIds Any experiments IDs (in addition\n *     to those specified on the ad element) that should be included in the\n *     request.\n * @return {!Object<string,null|number|string>} block level parameters\n */\n\n\nfunction googleBlockParameters(a4a, opt_experimentIds) {\n  var adElement = a4a.element,\n      win = a4a.win;\n  var slotRect = a4a.getPageLayoutBox();\n  var iframeDepth = iframeNestingDepth(win);\n  var enclosingContainers = getEnclosingContainerTypes(adElement);\n  var eids = adElement.getAttribute('data-experiment-id');\n\n  if (opt_experimentIds) {\n    eids = mergeExperimentIds(opt_experimentIds, eids);\n  }\n\n  return {\n    'adf': _domFingerprint.DomFingerprint.generate(adElement),\n    'nhd': iframeDepth,\n    'eid': eids,\n    'adx': slotRect.left,\n    'ady': slotRect.top,\n    'oid': '2',\n    'act': enclosingContainers.length ? enclosingContainers.join() : null\n  };\n}\n/**\n * @param {!Window} win\n * @param {string} type matching typing attribute.\n * @param {function(!Element):string} groupFn\n * @return {!Promise<!Object<string,!Array<!Promise<!../../../src/base-element.BaseElement>>>>}\n */\n\n\nfunction groupAmpAdsByType(win, type, groupFn) {\n  // Look for amp-ad elements of correct type or those contained within\n  // standard container type.  Note that display none containers will not be\n  // included as they will never be measured.\n  // TODO(keithwrightbos): what about slots that become measured due to removal\n  // of display none (e.g. user resizes viewport and media selector makes\n  // visible).\n  var ampAdSelector = function ampAdSelector(r) {\n    return r.element.\n    /*OK*/\n    querySelector(\"amp-ad[type=\" + type + \"]\");\n  };\n\n  var documentElement = win.document.documentElement;\n\n  var ampdoc = _services.Services.ampdoc(documentElement);\n\n  return (0, _iniLoad.getMeasuredResources)(ampdoc, win, function (r) {\n    var isAmpAdType = r.element.tagName == 'AMP-AD' && r.element.getAttribute('type') == type;\n\n    if (isAmpAdType) {\n      return true;\n    }\n\n    var isAmpAdContainerElement = Object.keys(ValidAdContainerTypes).includes(r.element.tagName) && !!ampAdSelector(r);\n    return isAmpAdContainerElement;\n  }) // Need to wait on any contained element resolution followed by build\n  // of child ad.\n  .then(function (resources) {\n    return Promise.all(resources.map(function (resource) {\n      if (resource.element.tagName == 'AMP-AD') {\n        return resource.element;\n      } // Must be container element so need to wait for child amp-ad to\n      // be upgraded.\n\n\n      return (0, _dom.whenUpgradedToCustomElement)((0, _log.dev)().assertElement(ampAdSelector(resource)));\n    }));\n  }) // Group by networkId.\n  .then(function (elements) {\n    return elements.reduce(function (result, element) {\n      var groupId = groupFn(element);\n      (result[groupId] || (result[groupId] = [])).push(element.getImpl());\n      return result;\n    }, {});\n  });\n}\n/**\n * @param {! ../../../extensions/amp-a4a/0.1/amp-a4a.AmpA4A} a4a\n * @param {number} startTime\n * @return {!Promise<!Object<string,null|number|string>>}\n */\n\n\nfunction googlePageParameters(a4a, startTime) {\n  var win = a4a.win;\n  var ampDoc = a4a.getAmpDoc(); // Do not wait longer than 1 second to retrieve referrer to ensure\n  // viewer integration issues do not cause ad requests to hang indefinitely.\n\n  var referrerPromise = _services.Services.timerFor(win).timeoutPromise(1000, _services.Services.viewerForDoc(ampDoc).getReferrerUrl()).catch(function () {\n    (0, _log.dev)().expectedError('AMP-A4A', 'Referrer timeout!');\n    return '';\n  });\n\n  var domLoading = getNavigationTiming(win, 'domLoading');\n  return Promise.all([(0, _adCid.getOrCreateAdCid)(ampDoc, 'AMP_ECID_GOOGLE', '_ga'), referrerPromise]).then(function (promiseResults) {\n    var clientId = promiseResults[0];\n    var referrer = promiseResults[1];\n\n    var _Services$documentInf = _services.Services.documentInfoForDoc(ampDoc),\n        pageViewId = _Services$documentInf.pageViewId,\n        canonicalUrl = _Services$documentInf.canonicalUrl; // Read by GPT for GA/GPT integration.\n\n\n    win.gaGlobal = win.gaGlobal || {\n      cid: clientId,\n      hid: pageViewId\n    };\n    var screen = win.screen;\n\n    var viewport = _services.Services.viewportForDoc(ampDoc);\n\n    var viewportRect = viewport.getRect();\n    var viewportSize = viewport.getSize();\n    var visibilityState = ampDoc.getVisibilityState();\n    return {\n      'is_amp': a4a.isXhrAllowed() ? AmpAdImplementation.AMP_AD_XHR_TO_IFRAME_OR_AMP : AmpAdImplementation.AMP_AD_IFRAME_GET,\n      'amp_v': (0, _internalVersion.internalRuntimeVersion)(),\n      'd_imp': '1',\n      'c': getCorrelator(win, ampDoc, clientId),\n      'ga_cid': win.gaGlobal.cid || null,\n      'ga_hid': win.gaGlobal.hid || null,\n      'dt': startTime,\n      'biw': viewportRect.width,\n      'bih': viewportRect.height,\n      'u_aw': screen ? screen.availWidth : null,\n      'u_ah': screen ? screen.availHeight : null,\n      'u_cd': screen ? screen.colorDepth : null,\n      'u_w': screen ? screen.width : null,\n      'u_h': screen ? screen.height : null,\n      'u_tz': -new Date().getTimezoneOffset(),\n      'u_his': getHistoryLength(win),\n      'isw': win != win.top ? viewportSize.width : null,\n      'ish': win != win.top ? viewportSize.height : null,\n      'art': getAmpRuntimeTypeParameter(win),\n      'vis': visibilityStateCodes[visibilityState] || '0',\n      'scr_x': viewport.getScrollLeft(),\n      'scr_y': viewport.getScrollTop(),\n      'bc': getBrowserCapabilitiesBitmap(win) || null,\n      'debug_experiment_id': (/(?:#|,)deid=([\\d,]+)/i.exec(win.location.hash) || [])[1] || null,\n      'url': canonicalUrl || null,\n      'top': win != win.top ? topWindowUrlOrDomain(win) : null,\n      'loc': win.location.href == canonicalUrl ? null : win.location.href,\n      'ref': referrer || null,\n      'bdt': domLoading ? startTime - domLoading : null\n    };\n  });\n}\n/**\n * @param {!../../../extensions/amp-a4a/0.1/amp-a4a.AmpA4A} a4a\n * @param {string} baseUrl\n * @param {number} startTime\n * @param {!Object<string,null|number|string>} parameters\n * @param {!Array<string>=} opt_experimentIds Any experiments IDs (in addition\n *     to those specified on the ad element) that should be included in the\n *     request.\n * @return {!Promise<string>}\n */\n\n\nfunction googleAdUrl(a4a, baseUrl, startTime, parameters, opt_experimentIds) {\n  // TODO: Maybe add checks in case these promises fail.\n  var blockLevelParameters = googleBlockParameters(a4a, opt_experimentIds);\n  return googlePageParameters(a4a, startTime).then(function (pageLevelParameters) {\n    Object.assign(parameters, blockLevelParameters, pageLevelParameters);\n    return truncAndTimeUrl(baseUrl, parameters, startTime);\n  });\n}\n/**\n * @param {string} baseUrl\n * @param {!Object<string,null|number|string>} parameters\n * @param {number} startTime\n * @return {string}\n */\n\n\nfunction truncAndTimeUrl(baseUrl, parameters, startTime) {\n  return (0, _urlBuilder.buildUrl)(baseUrl, parameters, MAX_URL_LENGTH - 10, TRUNCATION_PARAM) + '&dtd=' + elapsedTimeWithCeiling(Date.now(), startTime);\n}\n/**\n * @param {!Window} win\n * @return {number}\n */\n\n\nfunction iframeNestingDepth(win) {\n  var w = win;\n  var depth = 0;\n\n  while (w != w.parent && depth < 100) {\n    w = w.parent;\n    depth++;\n  }\n\n  (0, _log.devAssert)(w == win.top);\n  return depth;\n}\n/**\n * @param {!Window} win\n * @return {number}\n */\n\n\nfunction getHistoryLength(win) {\n  // We have seen cases where accessing history length causes errors.\n  try {\n    return win.history.length;\n  } catch (e) {\n    return 0;\n  }\n}\n/**\n * @param {string} url\n * @return {string} hostname portion of url\n * @visibleForTesting\n */\n\n\nfunction extractHost(url) {\n  return (/^(?:https?:\\/\\/)?([^\\/\\?:]+)/i.exec(url) || [])[1] || url;\n}\n/**\n * @param {!Window} win\n * @return {?string}\n */\n\n\nfunction topWindowUrlOrDomain(win) {\n  var ancestorOrigins = win.location.ancestorOrigins;\n\n  if (ancestorOrigins) {\n    var origin = win.location.origin;\n    var topOrigin = ancestorOrigins[ancestorOrigins.length - 1];\n\n    if (origin == topOrigin) {\n      return win.top.location.hostname;\n    }\n\n    var secondFromTop = secondWindowFromTop(win);\n\n    if (secondFromTop == win || origin == ancestorOrigins[ancestorOrigins.length - 2]) {\n      return extractHost(secondFromTop.\n      /*OK*/\n      document.referrer);\n    }\n\n    return extractHost(topOrigin);\n  } else {\n    try {\n      return win.top.location.hostname;\n    } catch (e) {}\n\n    var _secondFromTop = secondWindowFromTop(win);\n\n    try {\n      return extractHost(_secondFromTop.\n      /*OK*/\n      document.referrer);\n    } catch (e) {}\n\n    return null;\n  }\n}\n/**\n * @param {!Window} win\n * @return {!Window}\n */\n\n\nfunction secondWindowFromTop(win) {\n  var secondFromTop = win;\n  var depth = 0;\n\n  while (secondFromTop.parent != secondFromTop.parent.parent && depth < 100) {\n    secondFromTop = secondFromTop.parent;\n    depth++;\n  }\n\n  (0, _log.devAssert)(secondFromTop.parent == win.top);\n  return secondFromTop;\n}\n/**\n * @param {number} time\n * @param {number} start\n * @return {(number|string)}\n */\n\n\nfunction elapsedTimeWithCeiling(time, start) {\n  var duration = time - start;\n\n  if (duration >= 1e6) {\n    return 'M';\n  } else if (duration >= 0) {\n    return duration;\n  }\n\n  return '-M';\n}\n/**\n * `nodeOrDoc` must be passed for correct behavior in shadow AMP (PWA) case.\n * @param {!Window} win\n * @param {!Element|!../../../src/service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string=} opt_cid\n * @return {number} The correlator.\n */\n\n\nfunction getCorrelator(win, elementOrAmpDoc, opt_cid) {\n  if (!win.ampAdPageCorrelator) {\n    win.ampAdPageCorrelator = (0, _experiments.isExperimentOn)(win, 'exp-new-correlator') ? Math.floor(4503599627370496 * Math.random()) : makeCorrelator(_services.Services.documentInfoForDoc(elementOrAmpDoc).pageViewId, opt_cid);\n  }\n\n  return win.ampAdPageCorrelator;\n}\n/**\n * @param {string} pageViewId\n * @param {string=} opt_clientId\n * @return {number}\n */\n\n\nfunction makeCorrelator(pageViewId, opt_clientId) {\n  var pageViewIdNumeric = Number(pageViewId || 0);\n\n  if (opt_clientId) {\n    return pageViewIdNumeric + opt_clientId.replace(/\\D/g, '') % 1e6 * 1e6;\n  } else {\n    // In this case, pageViewIdNumeric is only 4 digits => too low entropy\n    // to be useful as a page correlator.  So synthesize one from scratch.\n    // 4503599627370496 == 2^52.  The guaranteed range of JS Number is at least\n    // 2^53 - 1.\n    return Math.floor(4503599627370496 * Math.random());\n  }\n}\n/**\n * Collect additional dimensions for the brdim parameter.\n * @param {!Window} win The window for which we read the browser dimensions.\n * @param {{width: number, height: number}|null} viewportSize\n * @return {string}\n * @visibleForTesting\n */\n\n\nfunction additionalDimensions(win, viewportSize) {\n  // Some browsers throw errors on some of these.\n  var screenX, screenY, outerWidth, outerHeight, innerWidth, innerHeight;\n\n  try {\n    screenX = win.screenX;\n    screenY = win.screenY;\n  } catch (e) {}\n\n  try {\n    outerWidth = win.outerWidth;\n    outerHeight = win.outerHeight;\n  } catch (e) {}\n\n  try {\n    innerWidth = viewportSize.width;\n    innerHeight = viewportSize.height;\n  } catch (e) {}\n\n  return [win.screenLeft, win.screenTop, screenX, screenY, win.screen ? win.screen.availWidth : undefined, win.screen ? win.screen.availTop : undefined, outerWidth, outerHeight, innerWidth, innerHeight].join();\n}\n/**\n * Returns amp-analytics config for a new CSI trigger.\n * @param {string} on The name of the analytics trigger.\n * @param {!Object<string, string>} params Params to be included on the ping.\n * @return {!JsonObject}\n */\n\n\nfunction csiTrigger(on, params) {\n  return (0, _object.dict)({\n    'on': on,\n    'request': 'csi',\n    'sampleSpec': {\n      // Pings are sampled on a per-pageview basis. A prefix is included in the\n      // sampleOn spec so that the hash is orthogonal to any other sampling in\n      // amp.\n      'sampleOn': 'a4a-csi-${pageViewId}',\n      'threshold': 1 // 1% sample\n\n    },\n    'selector': 'amp-ad',\n    'selectionMethod': 'closest',\n    'extraUrlParams': params\n  });\n}\n/**\n * Returns amp-analytics config for Google ads network impls.\n * @return {!JsonObject}\n */\n\n\nfunction getCsiAmpAnalyticsConfig() {\n  return (0, _object.dict)({\n    'requests': {\n      'csi': 'https://csi.gstatic.com/csi?'\n    },\n    'transport': {\n      'xhrpost': false\n    },\n    'triggers': {\n      'adRequestStart': csiTrigger('ad-request-start', {\n        // afs => ad fetch start\n        'met.a4a': 'afs_lvt.${viewerLastVisibleTime}~afs.${time}'\n      }),\n      'adResponseEnd': csiTrigger('ad-response-end', {\n        // afe => ad fetch end\n        'met.a4a': 'afe.${time}'\n      }),\n      'adRenderStart': csiTrigger('ad-render-start', {\n        // ast => ad schedule time\n        // ars => ad render start\n        'met.a4a': 'ast.${scheduleTime}~ars_lvt.${viewerLastVisibleTime}~ars.${time}',\n        'qqid': '${qqid}'\n      }),\n      'adIframeLoaded': csiTrigger('ad-iframe-loaded', {\n        // ail => ad iframe loaded\n        'met.a4a': 'ail.${time}'\n      })\n    },\n    'extraUrlParams': {\n      's': 'ampad',\n      'ctx': '2',\n      'c': '${correlator}',\n      'slotId': '${slotId}',\n      // Time that the beacon was actually sent. Note that there can be delays\n      // between the time at which the event is fired and when ${nowMs} is\n      // evaluated when the URL is built by amp-analytics.\n      'puid': '${requestCount}~${timestamp}'\n    }\n  });\n}\n/**\n * Returns variables to be included in the amp-analytics event for A4A.\n * @param {string} analyticsTrigger The name of the analytics trigger.\n * @param {!AMP.BaseElement} a4a The A4A element.\n * @param {?string} qqid The query ID or null if the query ID has not been set\n *     yet.\n * @return {!JsonObject}\n */\n\n\nfunction getCsiAmpAnalyticsVariables(analyticsTrigger, a4a, qqid) {\n  var win = a4a.win;\n  var ampdoc = a4a.getAmpDoc();\n  var navStart = getNavigationTiming(win, 'navigationStart');\n  var vars =\n  /** @type {!JsonObject} */\n  {\n    'correlator': getCorrelator(win, ampdoc),\n    'slotId': a4a.element.getAttribute('data-amp-slot-index'),\n    'viewerLastVisibleTime': ampdoc.getLastVisibleTime() - navStart\n  };\n\n  if (qqid) {\n    vars['qqid'] = qqid;\n  }\n\n  if (analyticsTrigger == 'ad-render-start') {\n    vars['scheduleTime'] = a4a.element.layoutScheduleTime - navStart;\n  }\n\n  return vars;\n}\n/**\n * Extracts configuration used to build amp-analytics element for active view.\n *\n * @param {!../../../extensions/amp-a4a/0.1/amp-a4a.AmpA4A} a4a\n * @param {!Headers} responseHeaders\n *   XHR service FetchResponseHeaders object containing the response\n *   headers.\n * @return {?JsonObject} config or null if invalid/missing.\n */\n\n\nfunction extractAmpAnalyticsConfig(a4a, responseHeaders) {\n  if (!responseHeaders.has(AMP_ANALYTICS_HEADER)) {\n    return null;\n  }\n\n  try {\n    var analyticsConfig = (0, _json.parseJson)(responseHeaders.get(AMP_ANALYTICS_HEADER));\n    (0, _log.devAssert)(Array.isArray(analyticsConfig['url']));\n    var urls = analyticsConfig['url'];\n\n    if (!urls.length) {\n      return null;\n    }\n\n    var config =\n    /** @type {JsonObject}*/\n    {\n      'transport': {\n        'beacon': false,\n        'xhrpost': false\n      },\n      'triggers': {\n        'continuousVisible': {\n          'on': 'visible',\n          'visibilitySpec': {\n            'selector': 'amp-ad',\n            'selectionMethod': 'closest',\n            'visiblePercentageMin': 50,\n            'continuousTimeMin': 1000\n          }\n        }\n      }\n    }; // Discover and build visibility endpoints.\n\n    var requests = (0, _object.dict)();\n\n    for (var idx = 1; idx <= urls.length; idx++) {\n      // TODO: Ensure url is valid and not freeform JS?\n      requests[\"visibility\" + idx] = \"\" + urls[idx - 1];\n    } // Security review needed here.\n\n\n    config['requests'] = requests;\n    config['triggers']['continuousVisible']['request'] = Object.keys(requests);\n    return config;\n  } catch (err) {\n    (0, _log.dev)().error('AMP-A4A', 'Invalid analytics', err, responseHeaders.get(AMP_ANALYTICS_HEADER));\n  }\n\n  return null;\n}\n/**\n * Add new experiment IDs to a (possibly empty) existing set of experiment IDs.\n * The {@code currentIdString} may be {@code null} or {@code ''}, but if it is\n * populated, it must contain a comma-separated list of integer experiment IDs\n * (per {@code parseExperimentIds()}).  Returns the new set of IDs, encoded\n * as a comma-separated list.  Does not de-duplicate ID entries.\n *\n * @param {!Array<string>} newIds IDs to merge in. Should contain stringified\n *     integer (base 10) experiment IDs.\n * @param {?string} currentIdString  If present, a string containing a\n *   comma-separated list of integer experiment IDs.\n * @return {string}  New experiment list string, including newId iff it is\n *   a valid (integer) experiment ID.\n * @see parseExperimentIds, validateExperimentIds\n */\n\n\nfunction mergeExperimentIds(newIds, currentIdString) {\n  var newIdString = newIds.filter(function (newId) {\n    return Number(newId);\n  }).join(',');\n  currentIdString = currentIdString || '';\n  return currentIdString + (currentIdString && newIdString ? ',' : '') + newIdString;\n}\n/**\n * Adds two CSI signals to the given amp-analytics configuration object, one\n * for render-start, and one for ini-load.\n *\n * @param {!Window} win\n * @param {!Element} element The ad slot.\n * @param {!JsonObject} config The original config object.\n * @param {?string} qqid\n * @param {boolean} isVerifiedAmpCreative\n * @return {?JsonObject} config or null if invalid/missing.\n */\n\n\nfunction addCsiSignalsToAmpAnalyticsConfig(win, element, config, qqid, isVerifiedAmpCreative) {\n  // Add CSI pingbacks.\n  var correlator = getCorrelator(win, element);\n  var slotId = Number(element.getAttribute('data-amp-slot-index'));\n  var eids = encodeURIComponent(element.getAttribute(EXPERIMENT_ATTRIBUTE));\n  var adType = element.getAttribute('type');\n  var initTime = Number((0, _variableSource.getTimingDataSync)(win, 'navigationStart') || Date.now());\n  var deltaTime = Math.round(win.performance && win.performance.now ? win.performance.now() : Date.now() - initTime);\n  var baseCsiUrl = 'https://csi.gstatic.com/csi?s=a4a' + (\"&c=\" + correlator + \"&slotId=\" + slotId + \"&qqid.\" + slotId + \"=\" + qqid) + (\"&dt=\" + initTime) + (eids != 'null' ? \"&e.\" + slotId + \"=\" + eids : '') + (\"&rls=\" + (0, _internalVersion.internalRuntimeVersion)() + \"&adt.\" + slotId + \"=\" + adType);\n  var isAmpSuffix = isVerifiedAmpCreative ? 'Friendly' : 'CrossDomain';\n  config['triggers']['continuousVisibleIniLoad'] = {\n    'on': 'ini-load',\n    'selector': 'amp-ad',\n    'selectionMethod': 'closest',\n    'request': 'iniLoadCsi'\n  };\n  config['triggers']['continuousVisibleRenderStart'] = {\n    'on': 'render-start',\n    'selector': 'amp-ad',\n    'selectionMethod': 'closest',\n    'request': 'renderStartCsi'\n  };\n  config['requests']['iniLoadCsi'] = baseCsiUrl + (\"&met.a4a.\" + slotId + \"=iniLoadCsi\" + isAmpSuffix + \".\" + deltaTime);\n  config['requests']['renderStartCsi'] = baseCsiUrl + (\"&met.a4a.\" + slotId + \"=renderStartCsi\" + isAmpSuffix + \".\" + deltaTime); // Add CSI ping for visibility.\n\n  config['requests']['visibilityCsi'] = baseCsiUrl + (\"&met.a4a.\" + slotId + \"=visibilityCsi.\" + deltaTime);\n  config['triggers']['continuousVisible']['request'].push('visibilityCsi');\n  return config;\n}\n/**\n * Returns an array of two-letter codes representing the amp-ad containers\n * enclosing the given ad element.\n *\n * @param {!Element} adElement\n * @return {!Array<string>}\n */\n\n\nfunction getEnclosingContainerTypes(adElement) {\n  var containerTypeSet = {};\n\n  for (var el = adElement.parentElement, counter = 0; el && counter < 20; el = el.parentElement, counter++) {\n    var tagName = el.tagName.toUpperCase();\n\n    if (ValidAdContainerTypes[tagName]) {\n      containerTypeSet[ValidAdContainerTypes[tagName]] = true;\n    }\n  }\n\n  return Object.keys(containerTypeSet);\n}\n/**\n * Appends parameter to ad request indicating error state so long as error\n * parameter is not already present or url has been truncated.\n * @param {string} adUrl used for network request\n * @param {string} parameterValue to be appended\n * @return {string|undefined} potentially modified url, undefined\n */\n\n\nfunction maybeAppendErrorParameter(adUrl, parameterValue) {\n  (0, _log.devAssert)(!!adUrl && !!parameterValue); // Add parameter indicating error so long as the url has not already been\n  // truncated and error parameter is not already present.  Note that we assume\n  // that added, error parameter length will be less than truncation parameter\n  // so adding will not cause length to exceed maximum.\n\n  if (new RegExp(\"[?|&](\" + encodeURIComponent(TRUNCATION_PARAM.name) + \"=\" + (encodeURIComponent(String(TRUNCATION_PARAM.value)) + \"|aet=[^&]*)$\")).test(adUrl)) {\n    return;\n  }\n\n  var modifiedAdUrl = adUrl + (\"&aet=\" + parameterValue);\n  (0, _log.devAssert)(modifiedAdUrl.length <= MAX_URL_LENGTH);\n  return modifiedAdUrl;\n}\n/**\n * Returns a numerical code representing the binary type.\n * @param {string} type\n * @return {?string}\n */\n\n\nfunction getBinaryTypeNumericalCode(type) {\n  return {\n    'production': '0',\n    'control': '1',\n    'canary': '2',\n    'rc': '3',\n    'experimentA': '10',\n    'experimentB': '11',\n    'experimentC': '12',\n    'nomod': '42',\n    'mod': '43'\n  }[type] || null;\n}\n/** @const {!RegExp} */\n\n\nvar IDENTITY_DOMAIN_REGEXP_ = /\\.google\\.(?:com?\\.)?[a-z]{2,3}$/;\n/** @typedef {{\n      token: (string|undefined),\n      jar: (string|undefined),\n      pucrd: (string|undefined),\n      freshLifetimeSecs: (number|undefined),\n      validLifetimeSecs: (number|undefined),\n      fetchTimeMs: (number|undefined)\n   }} */\n\nvar IdentityToken;\n/**\n * @param {!Window} win\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampDoc\n * @param {?string} consentPolicyId\n * @return {!Promise<!IdentityToken>}\n */\n\nexports.IdentityToken = IdentityToken;\n\nfunction getIdentityToken(win, ampDoc, consentPolicyId) {\n  // If configured to use amp-consent, delay request until consent state is\n  // resolved.\n  win['goog_identity_prom'] = win['goog_identity_prom'] || (consentPolicyId ? (0, _consent.getConsentPolicyState)(ampDoc.getHeadNode(), consentPolicyId) : Promise.resolve(_consentState.CONSENT_POLICY_STATE.UNKNOWN_NOT_REQUIRED)).then(function (consentState) {\n    return consentState == _consentState.CONSENT_POLICY_STATE.INSUFFICIENT || consentState == _consentState.CONSENT_POLICY_STATE.UNKNOWN ?\n    /** @type {!IdentityToken} */\n    {} : executeIdentityTokenFetch(win, ampDoc);\n  });\n  return (\n    /** @type {!Promise<!IdentityToken>} */\n    win['goog_identity_prom']\n  );\n}\n/**\n * @param {!Window} win\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampDoc\n * @param {number=} redirectsRemaining (default 1)\n * @param {string=} domain\n * @param {number=} startTime\n * @return {!Promise<!IdentityToken>}\n */\n\n\nfunction executeIdentityTokenFetch(win, ampDoc, redirectsRemaining, domain, startTime) {\n  if (redirectsRemaining === void 0) {\n    redirectsRemaining = 1;\n  }\n\n  if (domain === void 0) {\n    domain = undefined;\n  }\n\n  if (startTime === void 0) {\n    startTime = Date.now();\n  }\n\n  var url = getIdentityTokenRequestUrl(win, ampDoc, domain);\n  return _services.Services.xhrFor(win).fetchJson(url, {\n    mode: 'cors',\n    method: 'GET',\n    ampCors: false,\n    credentials: 'include'\n  }).then(function (res) {\n    return res.json();\n  }).then(function (obj) {\n    var token = obj['newToken'];\n    var jar = obj['1p_jar'] || '';\n    var pucrd = obj['pucrd'] || '';\n    var freshLifetimeSecs = parseInt(obj['freshLifetimeSecs'] || '', 10);\n    var validLifetimeSecs = parseInt(obj['validLifetimeSecs'] || '', 10);\n    var altDomain = obj['altDomain'];\n    var fetchTimeMs = Date.now() - startTime;\n\n    if (IDENTITY_DOMAIN_REGEXP_.test(altDomain)) {\n      if (!redirectsRemaining--) {\n        // Max redirects, log?\n        return {\n          fetchTimeMs: fetchTimeMs\n        };\n      }\n\n      return executeIdentityTokenFetch(win, ampDoc, redirectsRemaining, altDomain, startTime);\n    } else if (freshLifetimeSecs > 0 && validLifetimeSecs > 0 && typeof token == 'string') {\n      return {\n        token: token,\n        jar: jar,\n        pucrd: pucrd,\n        freshLifetimeSecs: freshLifetimeSecs,\n        validLifetimeSecs: validLifetimeSecs,\n        fetchTimeMs: fetchTimeMs\n      };\n    } // returning empty\n\n\n    return {\n      fetchTimeMs: fetchTimeMs\n    };\n  }).catch(function (unusedErr) {\n    // TODO log?\n    return {};\n  });\n}\n/**\n * @param {!Window} win\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampDoc\n * @param {string=} domain\n * @return {string} url\n * @visibleForTesting\n */\n\n\nfunction getIdentityTokenRequestUrl(win, ampDoc, domain) {\n  if (domain === void 0) {\n    domain = undefined;\n  }\n\n  if (!domain && win != win.top && win.location.ancestorOrigins) {\n    var matches = IDENTITY_DOMAIN_REGEXP_.exec(win.location.ancestorOrigins[win.location.ancestorOrigins.length - 1]);\n    domain = matches && matches[0] || undefined;\n  }\n\n  domain = domain || '.google.com';\n  var canonical = extractHost(_services.Services.documentInfoForDoc(ampDoc).canonicalUrl);\n  return \"https://adservice\" + domain + \"/adsid/integrator.json?domain=\" + canonical;\n}\n/**\n * Returns whether we are running on the AMP CDN.\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nfunction isCdnProxy(win) {\n  return CDN_PROXY_REGEXP.test(win.location.origin);\n}\n/**\n * Populates the fields of the given Nameframe experiment config object.\n * @param {!Headers} headers\n * @param {!NameframeExperimentConfig} nameframeConfig\n */\n\n\nfunction setNameframeExperimentConfigs(headers, nameframeConfig) {\n  var nameframeExperimentHeader = headers.get('amp-nameframe-exp');\n\n  if (nameframeExperimentHeader) {\n    nameframeExperimentHeader.split(';').forEach(function (config) {\n      if (config == 'instantLoad' || config == 'writeInBody') {\n        nameframeConfig[config] = true;\n      }\n    });\n  }\n}\n/**\n * Enum for browser capabilities. NOTE: Since JS is 32-bit, do not add anymore\n * than 32 capabilities to this enum.\n * @enum {number}\n */\n\n\nvar Capability = {\n  SVG_SUPPORTED: 1 << 0,\n  SANDBOXING_ALLOW_TOP_NAVIGATION_BY_USER_ACTIVATION_SUPPORTED: 1 << 1,\n  SANDBOXING_ALLOW_POPUPS_TO_ESCAPE_SANDBOX_SUPPORTED: 1 << 2\n};\n/**\n * Returns a bitmap representing what features are supported by this browser.\n * @param {!Window} win\n * @return {number}\n */\n\nfunction getBrowserCapabilitiesBitmap(win) {\n  var browserCapabilities = 0;\n  var doc = win.document;\n\n  if (win.SVGElement && doc.createElementNS) {\n    browserCapabilities |= Capability.SVG_SUPPORTED;\n  }\n\n  var iframeEl = doc.createElement('iframe');\n\n  if (iframeEl.sandbox && iframeEl.sandbox.supports) {\n    if (iframeEl.sandbox.supports('allow-top-navigation-by-user-activation')) {\n      browserCapabilities |= Capability.SANDBOXING_ALLOW_TOP_NAVIGATION_BY_USER_ACTIVATION_SUPPORTED;\n    }\n\n    if (iframeEl.sandbox.supports('allow-popups-to-escape-sandbox')) {\n      browserCapabilities |= Capability.SANDBOXING_ALLOW_POPUPS_TO_ESCAPE_SANDBOX_SUPPORTED;\n    }\n  }\n\n  return browserCapabilities;\n}\n/**\n * Returns an enum value representing the AMP binary type, or null if this is a\n * canonical page.\n * @param {!Window} win\n * @return {?string} The binary type enum.\n * @visibleForTesting\n */\n\n\nfunction getAmpRuntimeTypeParameter(win) {\n  var art = getBinaryTypeNumericalCode((0, _experiments.getBinaryType)(win));\n  return isCdnProxy(win) && art != '0' ? art : null;\n}\n\n},{\"../../../src/ad-cid\":24,\"../../../src/consent\":34,\"../../../src/consent-state\":33,\"../../../src/dom\":41,\"../../../src/experiments\":47,\"../../../src/ini-load\":59,\"../../../src/internal-version\":61,\"../../../src/json\":63,\"../../../src/log\":68,\"../../../src/mode\":70,\"../../../src/service/variable-source\":112,\"../../../src/services\":123,\"../../../src/utils/dom-fingerprint\":139,\"../../../src/utils/object\":145,\"./shared/url-builder\":3}],6:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.cssText = void 0;\n\n/** @noinline */\nvar cssText = \"html{overflow-x:hidden!important}html.i-amphtml-fie{height:100%!important;width:100%!important}html:not([amp4ads]),html:not([amp4ads]) body{height:auto!important}html:not([amp4ads]) body{margin:0!important}body{-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%}html.i-amphtml-singledoc.i-amphtml-embedded{-ms-touch-action:pan-y;touch-action:pan-y}html.i-amphtml-fie>body,html.i-amphtml-singledoc>body{overflow:visible!important}html.i-amphtml-fie:not(.i-amphtml-inabox)>body,html.i-amphtml-singledoc:not(.i-amphtml-inabox)>body{position:relative!important}html.i-amphtml-webview>body{overflow-x:hidden!important;overflow-y:visible!important;min-height:100vh!important}html.i-amphtml-ios-embed-legacy>body{overflow-x:hidden!important;overflow-y:auto!important;position:absolute!important}html.i-amphtml-ios-embed{overflow-y:auto!important;position:static}#i-amphtml-wrapper{overflow-x:hidden!important;overflow-y:auto!important;position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;margin:0!important;display:block!important}html.i-amphtml-ios-embed.i-amphtml-ios-overscroll,html.i-amphtml-ios-embed.i-amphtml-ios-overscroll>#i-amphtml-wrapper{-webkit-overflow-scrolling:touch!important}#i-amphtml-wrapper>body{position:relative!important;border-top:1px solid transparent!important}#i-amphtml-wrapper+body{visibility:visible}#i-amphtml-wrapper+body .i-amphtml-lightbox-element,#i-amphtml-wrapper+body[i-amphtml-lightbox]{visibility:hidden}#i-amphtml-wrapper+body[i-amphtml-lightbox] .i-amphtml-lightbox-element{visibility:visible}#i-amphtml-wrapper.i-amphtml-scroll-disabled,.i-amphtml-scroll-disabled{overflow-x:hidden!important;overflow-y:hidden!important}amp-instagram{padding:54px 0px 0px!important;background-color:#fff}amp-iframe iframe{box-sizing:border-box!important}[amp-access][amp-access-hide]{display:none}[subscriptions-dialog],body:not(.i-amphtml-subs-ready) [subscriptions-action],body:not(.i-amphtml-subs-ready) [subscriptions-section]{display:none!important}amp-experiment,amp-live-list>[update],amp-share-tracking{display:none}.i-amphtml-jank-meter{position:fixed;background-color:rgba(232,72,95,0.5);bottom:0;right:0;color:#fff;font-size:16px;z-index:1000;padding:5px}amp-list[resizable-children]>.i-amphtml-loading-container.amp-hidden{display:none!important}amp-list[load-more] [load-more-button],amp-list[load-more] [load-more-end],amp-list[load-more] [load-more-failed],amp-list[load-more] [load-more-loading]{display:none}amp-story-page,amp-story[standalone]{min-height:1px!important;display:block!important;height:100%!important;margin:0!important;padding:0!important;overflow:hidden!important;width:100%!important}amp-story[standalone]{background-color:#202125!important;position:relative!important}amp-story-page{background-color:#757575}amp-story .amp-active>div{display:none!important}amp-story-page:not(:first-of-type):not([distance]):not([active]){transform:translateY(1000vh)!important}amp-autocomplete{position:relative!important;display:inline-block!important}amp-autocomplete>input{padding:.5rem;border:1px solid rgba(0,0,0,0.33)}.i-amphtml-autocomplete-results,amp-autocomplete>input{font-size:1rem;line-height:1.5rem}[amp-fx^=fly-in]{visibility:hidden}\\n/*# sourceURL=/css/ampdoc.css*/\";\nexports.cssText = cssText;\n\n},{}],7:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.cssText = void 0;\n\n/** @noinline */\nvar cssText = \"[hidden]{display:none!important}.i-amphtml-element{display:inline-block}.i-amphtml-blurry-placeholder{transition:opacity 0.3s cubic-bezier(0.0,0.0,0.2,1)!important}[layout=nodisplay]:not(.i-amphtml-element){display:none!important}.i-amphtml-layout-fixed,[layout=fixed][width][height]:not(.i-amphtml-layout-fixed){display:inline-block;position:relative}.i-amphtml-layout-responsive,[layout=responsive][width][height]:not(.i-amphtml-layout-responsive),[width][height][sizes]:not(.i-amphtml-layout-responsive){display:block;position:relative}.i-amphtml-layout-intrinsic{display:inline-block;position:relative;max-width:100%}.i-amphtml-intrinsic-sizer{max-width:100%;display:block!important}.i-amphtml-layout-container,.i-amphtml-layout-fixed-height,[layout=container],[layout=fixed-height][height]{display:block;position:relative}.i-amphtml-layout-fill,[layout=fill]:not(.i-amphtml-layout-fill){display:block;overflow:hidden!important;position:absolute;top:0;left:0;bottom:0;right:0}.i-amphtml-layout-flex-item,[layout=flex-item]:not(.i-amphtml-layout-flex-item){display:block;position:relative;-ms-flex:1 1 auto;flex:1 1 auto}.i-amphtml-layout-fluid{position:relative}.i-amphtml-layout-size-defined{overflow:hidden!important}.i-amphtml-layout-awaiting-size{position:absolute!important;top:auto!important;bottom:auto!important}i-amphtml-sizer{display:block!important}.i-amphtml-blurry-placeholder,.i-amphtml-fill-content{display:block;height:0;max-height:100%;max-width:100%;min-height:100%;min-width:100%;width:0;margin:auto}.i-amphtml-layout-size-defined .i-amphtml-fill-content{position:absolute;top:0;left:0;bottom:0;right:0}.i-amphtml-layout-intrinsic .i-amphtml-sizer{max-width:100%}.i-amphtml-replaced-content,.i-amphtml-screen-reader{padding:0!important;border:none!important}.i-amphtml-screen-reader{position:fixed!important;top:0px!important;left:0px!important;width:4px!important;height:4px!important;opacity:0!important;overflow:hidden!important;margin:0!important;display:block!important;visibility:visible!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:8px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:12px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:16px!important}.i-amphtml-unresolved{position:relative;overflow:hidden!important}.i-amphtml-select-disabled{-webkit-user-select:none!important;-moz-user-select:none!important;-ms-user-select:none!important;user-select:none!important}.i-amphtml-notbuilt,[layout]:not(.i-amphtml-element){position:relative;overflow:hidden!important;color:transparent!important}.i-amphtml-notbuilt:not(.i-amphtml-layout-container)>*,[layout]:not([layout=container]):not(.i-amphtml-element)>*{display:none}.i-amphtml-ghost{visibility:hidden!important}.i-amphtml-element>[placeholder],[layout]:not(.i-amphtml-element)>[placeholder]{display:block}.i-amphtml-element>[placeholder].amp-hidden,.i-amphtml-element>[placeholder].hidden{visibility:hidden}.i-amphtml-element:not(.amp-notsupported)>[fallback],.i-amphtml-layout-container>[placeholder].amp-hidden,.i-amphtml-layout-container>[placeholder].hidden{display:none}.i-amphtml-layout-size-defined>[fallback],.i-amphtml-layout-size-defined>[placeholder]{position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;z-index:1}.i-amphtml-notbuilt>[placeholder]{display:block!important}.i-amphtml-hidden-by-media-query{display:none!important}.i-amphtml-element-error{background:red!important;color:#fff!important;position:relative!important}.i-amphtml-element-error:before{content:attr(error-message)}i-amp-scroll-container,i-amphtml-scroll-container{position:absolute;top:0;left:0;right:0;bottom:0;display:block}i-amp-scroll-container.amp-active,i-amphtml-scroll-container.amp-active{overflow:auto;-webkit-overflow-scrolling:touch}.i-amphtml-loading-container{display:block!important;pointer-events:none;z-index:1}.i-amphtml-notbuilt>.i-amphtml-loading-container{display:block!important}.i-amphtml-loading-container.amp-hidden{visibility:hidden}.i-amphtml-element>[overflow]{cursor:pointer;position:relative;z-index:2;visibility:hidden}.i-amphtml-element>[overflow].amp-visible{visibility:visible}template{display:none!important}.amp-border-box,.amp-border-box *,.amp-border-box :after,.amp-border-box :before{box-sizing:border-box}amp-pixel{display:none!important}amp-analytics,amp-story-auto-ads{position:fixed!important;top:0!important;width:1px!important;height:1px!important;overflow:hidden!important;visibility:hidden}html.i-amphtml-fie>amp-analytics{position:initial!important}[visible-when-invalid]:not(.visible),amp-list [fetch-error],form [submit-error],form [submit-success],form [submitting]{display:none}amp-accordion{display:block!important}amp-accordion>section{float:none!important}amp-accordion>section>*{float:none!important;display:block!important;overflow:hidden!important;position:relative!important}amp-accordion,amp-accordion>section{margin:0}amp-accordion>section>:last-child{display:none!important}amp-accordion>section[expanded]>:last-child{display:block!important}\\n/*# sourceURL=/css/ampshared.css*/\";\nexports.cssText = cssText;\n\n},{}],8:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installImg = installImg;\nexports.AmpImg = void 0;\n\nvar _baseElement = require(\"../src/base-element\");\n\nvar _layout = require(\"../src/layout\");\n\nvar _log = require(\"../src/log\");\n\nvar _img = require(\"../src/utils/img\");\n\nvar _experiments = require(\"../src/experiments\");\n\nvar _eventHelper = require(\"../src/event-helper\");\n\nvar _style = require(\"../src/style\");\n\nvar _customElementRegistry = require(\"../src/service/custom-element-registry\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/** @const {string} */\nvar TAG = 'amp-img';\n/**\n * Attributes to propagate to internal image when changed externally.\n * @type {!Array<string>}\n */\n\nvar ATTRIBUTES_TO_PROPAGATE = ['alt', 'title', 'referrerpolicy', 'aria-label', 'aria-describedby', 'aria-labelledby', 'srcset', 'src', 'sizes'];\n\nvar AmpImg =\n/*#__PURE__*/\nfunction (_BaseElement) {\n  _inheritsLoose(AmpImg, _BaseElement);\n\n  /** @param {!AmpElement} element */\n  function AmpImg(element) {\n    var _this;\n\n    _this = _BaseElement.call(this, element) || this;\n    /** @private {boolean} */\n\n    _this.allowImgLoadFallback_ = true;\n    /** @private {boolean} */\n\n    _this.prerenderAllowed_ = true;\n    /** @private {?Element} */\n\n    _this.img_ = null;\n    /** @private {?UnlistenDef} */\n\n    _this.unlistenLoad_ = null;\n    /** @private {?UnlistenDef} */\n\n    _this.unlistenError_ = null;\n    /**\n     * The current width used by the automatically generated sizes attribute\n     * @private {number}\n     * */\n\n    _this.sizesWidth_ = 0;\n    return _this;\n  }\n  /** @override */\n\n\n  var _proto = AmpImg.prototype;\n\n  _proto.mutatedAttributesCallback = function mutatedAttributesCallback(mutations) {\n    if (this.img_) {\n      var attrs = ATTRIBUTES_TO_PROPAGATE.filter(function (value) {\n        return mutations[value] !== undefined;\n      }); // Mutating src should override existing srcset, so remove the latter.\n\n      if (mutations['src'] && !mutations['srcset'] && this.element.hasAttribute('srcset')) {\n        // propagateAttributes() will remove [srcset] from this.img_.\n        this.element.removeAttribute('srcset');\n        attrs.push('srcset');\n        this.user().warn(TAG, 'Removed [srcset] since [src] was mutated. Recommend adding a ' + '[srcset] binding to support responsive images.', this.element);\n      }\n\n      this.propagateAttributes(attrs, this.img_,\n      /* opt_removeMissingAttrs */\n      true);\n      (0, _img.guaranteeSrcForSrcsetUnsupportedBrowsers)(this.img_);\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.onMeasureChanged = function onMeasureChanged() {\n    this.maybeGenerateSizes_(\n    /* sync */\n    false);\n  }\n  /** @override */\n  ;\n\n  _proto.preconnectCallback = function preconnectCallback(onLayout) {\n    // NOTE(@wassgha): since parseSrcset is computationally expensive and can\n    // not be inside the `buildCallback`, we went with preconnecting to the\n    // `src` url if it exists or the first srcset url.\n    var src = this.element.getAttribute('src');\n\n    if (src) {\n      this.preconnect.url(src, onLayout);\n    } else {\n      var srcset = this.element.getAttribute('srcset');\n\n      if (!srcset) {\n        return;\n      } // We try to find the first url in the srcset\n\n\n      var srcseturl = /\\S+/.exec(srcset); // Connect to the first url if it exists\n\n      if (srcseturl) {\n        this.preconnect.url(srcseturl[0], onLayout);\n      }\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.firstAttachedCallback = function firstAttachedCallback() {\n    if (this.element.hasAttribute('noprerender')) {\n      this.prerenderAllowed_ = false;\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.isLayoutSupported = function isLayoutSupported(layout) {\n    return (0, _layout.isLayoutSizeDefined)(layout);\n  }\n  /**\n   * Create the actual image element and set up instance variables.\n   * Called lazily in the first `#layoutCallback`.\n   */\n  ;\n\n  _proto.initialize_ = function initialize_() {\n    if (this.img_) {\n      return;\n    } // If this amp-img IS the fallback then don't allow it to have its own\n    // fallback to stop from nested fallback abuse.\n\n\n    this.allowImgLoadFallback_ = !this.element.hasAttribute('fallback'); // For inabox SSR, image will have been written directly to DOM so no need\n    // to recreate.  Calling appendChild again will have no effect.\n\n    if (this.element.hasAttribute('i-amphtml-ssr')) {\n      this.img_ = this.element.querySelector('img');\n    }\n\n    this.img_ = this.img_ || new Image();\n    this.img_.setAttribute('decoding', 'async');\n\n    if (this.element.id) {\n      this.img_.setAttribute('amp-img-id', this.element.id);\n    } // Remove role=img otherwise this breaks screen-readers focus and\n    // only read \"Graphic\" when using only 'alt'.\n\n\n    if (this.element.getAttribute('role') == 'img') {\n      this.element.removeAttribute('role');\n      this.user().error(TAG, 'Setting role=img on amp-img elements breaks ' + 'screen readers please just set alt or ARIA attributes, they will ' + 'be correctly propagated for the underlying <img> element.');\n    } // It is important to call this before setting `srcset` attribute.\n\n\n    this.maybeGenerateSizes_(\n    /* sync setAttribute */\n    true);\n    this.propagateAttributes(ATTRIBUTES_TO_PROPAGATE, this.img_);\n    (0, _img.guaranteeSrcForSrcsetUnsupportedBrowsers)(this.img_);\n    this.applyFillContent(this.img_, true);\n    (0, _style.propagateObjectFitStyles)(this.element, this.img_);\n    this.element.appendChild(this.img_);\n  }\n  /**\n   * This function automatically generates sizes for amp-imgs without\n   * the sizes attribute.\n   * @param {boolean} sync Whether to immediately make the change or schedule\n   *     via mutateElement.\n   * @private\n   */\n  ;\n\n  _proto.maybeGenerateSizes_ = function maybeGenerateSizes_(sync) {\n    var _this2 = this;\n\n    if (!this.img_) {\n      return;\n    } // No need to generate sizes if already present.\n\n\n    var sizes = this.element.getAttribute('sizes');\n\n    if (sizes) {\n      return;\n    } // Sizes is useless without the srcset attribute or if the srcset\n    // attribute uses the x descriptor.\n\n\n    var srcset = this.element.getAttribute('srcset');\n\n    if (!srcset || /[0-9]+x(?:,|$)/.test(srcset)) {\n      return;\n    }\n\n    var width = this.getLayoutWidth();\n\n    if (!this.shouldSetSizes_(width)) {\n      return;\n    }\n\n    var viewportWidth = this.getViewport().getWidth();\n    var entry = \"(max-width: \" + viewportWidth + \"px) \" + width + \"px, \";\n    var defaultSize = width + 'px';\n\n    if (this.getLayout() !== _layout.Layout.FIXED) {\n      var ratio = Math.round(width * 100 / viewportWidth);\n      defaultSize = Math.max(ratio, 100) + 'vw';\n    }\n\n    var generatedSizes = entry + defaultSize;\n\n    if (sync) {\n      this.img_.setAttribute('sizes', generatedSizes);\n    } else {\n      this.mutateElement(function () {\n        _this2.img_.setAttribute('sizes', generatedSizes);\n      });\n    }\n\n    this.sizesWidth_ = width;\n  }\n  /**\n   * @param {number} newWidth\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.shouldSetSizes_ = function shouldSetSizes_(newWidth) {\n    if (!this.img_.hasAttribute('sizes')) {\n      return true;\n    }\n\n    return newWidth > this.sizesWidth_;\n  }\n  /** @override */\n  ;\n\n  _proto.prerenderAllowed = function prerenderAllowed() {\n    return this.prerenderAllowed_;\n  }\n  /** @override */\n  ;\n\n  _proto.reconstructWhenReparented = function reconstructWhenReparented() {\n    return false;\n  }\n  /** @override */\n  ;\n\n  _proto.layoutCallback = function layoutCallback() {\n    var _this3 = this;\n\n    this.initialize_();\n    var img = (0, _log.dev)().assertElement(this.img_);\n    this.unlistenLoad_ = (0, _eventHelper.listen)(img, 'load', function () {\n      return _this3.hideFallbackImg_();\n    });\n    this.unlistenError_ = (0, _eventHelper.listen)(img, 'error', function () {\n      return _this3.onImgLoadingError_();\n    });\n\n    if (this.getLayoutWidth() <= 0) {\n      return Promise.resolve();\n    }\n\n    return this.loadPromise(img);\n  }\n  /** @override */\n  ;\n\n  _proto.unlayoutCallback = function unlayoutCallback() {\n    if (this.unlistenError_) {\n      this.unlistenError_();\n      this.unlistenError_ = null;\n    }\n\n    if (this.unlistenLoad_) {\n      this.unlistenLoad_();\n      this.unlistenLoad_ = null;\n    }\n\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.firstLayoutCompleted = function firstLayoutCompleted() {\n    var placeholder = this.getPlaceholder();\n\n    if (placeholder && placeholder.classList.contains('i-amphtml-blurry-placeholder') && (0, _experiments.isExperimentOn)(this.win, 'blurry-placeholder')) {\n      (0, _style.setImportantStyles)(placeholder, {\n        'opacity': 0\n      });\n    } else {\n      this.togglePlaceholder(false);\n    }\n  }\n  /**\n   * @private\n   */\n  ;\n\n  _proto.hideFallbackImg_ = function hideFallbackImg_() {\n    var _this4 = this;\n\n    if (!this.allowImgLoadFallback_ && this.img_.classList.contains('i-amphtml-ghost')) {\n      this.getVsync().mutate(function () {\n        _this4.img_.classList.remove('i-amphtml-ghost');\n\n        _this4.toggleFallback(false);\n      });\n    }\n  }\n  /**\n   * If the image fails to load, show a fallback or placeholder instead.\n   * @private\n   */\n  ;\n\n  _proto.onImgLoadingError_ = function onImgLoadingError_() {\n    var _this5 = this;\n\n    if (this.allowImgLoadFallback_) {\n      this.getVsync().mutate(function () {\n        _this5.img_.classList.add('i-amphtml-ghost');\n\n        _this5.toggleFallback(true); // Hide placeholders, as browsers that don't support webp\n        // Would show the placeholder underneath a transparent fallback\n\n\n        _this5.togglePlaceholder(false);\n      });\n      this.allowImgLoadFallback_ = false;\n    }\n  };\n\n  return AmpImg;\n}(_baseElement.BaseElement);\n/**\n * @param {!Window} win Destination window for the new element.\n * @this {undefined}  // Make linter happy\n */\n\n\nexports.AmpImg = AmpImg;\n\nfunction installImg(win) {\n  (0, _customElementRegistry.registerElement)(win, TAG, AmpImg);\n}\n\n},{\"../src/base-element\":29,\"../src/event-helper\":46,\"../src/experiments\":47,\"../src/layout\":66,\"../src/log\":68,\"../src/service/custom-element-registry\":87,\"../src/style\":128,\"../src/utils/img\":141}],9:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installLayout = installLayout;\n\nvar _baseElement = require(\"../src/base-element\");\n\nvar _layout = require(\"../src/layout\");\n\nvar _customElementRegistry = require(\"../src/service/custom-element-registry\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\nvar AmpLayout =\n/*#__PURE__*/\nfunction (_BaseElement) {\n  _inheritsLoose(AmpLayout, _BaseElement);\n\n  function AmpLayout() {\n    return _BaseElement.apply(this, arguments) || this;\n  }\n\n  var _proto = AmpLayout.prototype;\n\n  /** @override */\n  _proto.isLayoutSupported = function isLayoutSupported(layout) {\n    return layout == _layout.Layout.CONTAINER || (0, _layout.isLayoutSizeDefined)(layout);\n  }\n  /** @override */\n  ;\n\n  _proto.buildCallback = function buildCallback() {\n    if (this.getLayout() == _layout.Layout.CONTAINER) {\n      return;\n    }\n\n    var container = this.win.document.createElement('div');\n    this.applyFillContent(container);\n    this.getRealChildNodes().forEach(function (child) {\n      container.appendChild(child);\n    });\n    this.element.appendChild(container);\n  }\n  /** @override */\n  ;\n\n  _proto.prerenderAllowed = function prerenderAllowed() {\n    // Allow amp-layout to be built in prerender mode.\n    return true;\n  };\n\n  return AmpLayout;\n}(_baseElement.BaseElement);\n/**\n * @param {!Window} win Destination window for the new element.\n */\n\n\nfunction installLayout(win) {\n  (0, _customElementRegistry.registerElement)(win, 'amp-layout', AmpLayout);\n}\n\n},{\"../src/base-element\":29,\"../src/layout\":66,\"../src/service/custom-element-registry\":87}],10:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installPixel = installPixel;\nexports.AmpPixel = void 0;\n\nvar _baseElement = require(\"../src/base-element\");\n\nvar _services = require(\"../src/services\");\n\nvar _pixel = require(\"../src/pixel\");\n\nvar _log = require(\"../src/log\");\n\nvar _customElementRegistry = require(\"../src/service/custom-element-registry\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\nvar TAG = 'amp-pixel';\n/**\n * A simple analytics instrument. Fires as an impression signal.\n */\n\nvar AmpPixel =\n/*#__PURE__*/\nfunction (_BaseElement) {\n  _inheritsLoose(AmpPixel, _BaseElement);\n\n  /** @override */\n  function AmpPixel(element) {\n    var _this;\n\n    _this = _BaseElement.call(this, element) || this;\n    /** @private {?Promise<!Image>} */\n\n    _this.triggerPromise_ = null;\n    return _this;\n  }\n  /** @override */\n\n\n  var _proto = AmpPixel.prototype;\n\n  _proto.isLayoutSupported = function isLayoutSupported(unusedLayout) {\n    // No matter what layout is: the pixel is always non-displayed.\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.buildCallback = function buildCallback() {\n    // Element is invisible.\n    this.element.setAttribute('aria-hidden', 'true');\n    /** @private {?string} */\n\n    this.referrerPolicy_ = this.element.getAttribute('referrerpolicy');\n\n    if (this.referrerPolicy_) {\n      // Safari doesn't support referrerPolicy yet. We're using an\n      // iframe based trick to remove referrer, which apparently can\n      // only do \"no-referrer\".\n      (0, _log.userAssert)(this.referrerPolicy_ == 'no-referrer', TAG + \": invalid \\\"referrerpolicy\\\" value \\\"\" + this.referrerPolicy_ + \"\\\".\" + ' Only \"no-referrer\" is supported');\n    }\n\n    if (this.element.hasAttribute('i-amphtml-ssr') && this.element.querySelector('img')) {\n      (0, _log.dev)().info(TAG, 'inabox img already present');\n      return;\n    } // Trigger, but only when visible.\n\n\n    this.getAmpDoc().whenFirstVisible().then(this.trigger_.bind(this));\n  }\n  /**\n   * Triggers the signal.\n   * @return {*} TODO(#23582): Specify return type\n   * @private\n   */\n  ;\n\n  _proto.trigger_ = function trigger_() {\n    var _this2 = this;\n\n    if (this.triggerPromise_) {\n      // TODO(dvoytenko, #8780): monitor, confirm if there's a bug and remove.\n      (0, _log.dev)().error(TAG, 'duplicate pixel');\n      return this.triggerPromise_;\n    } // Delay(1) provides a rudimentary \"idle\" signal.\n    // TODO(dvoytenko): use an improved idle signal when available.\n\n\n    this.triggerPromise_ = _services.Services.timerFor(this.win).promise(1).then(function () {\n      var src = _this2.element.getAttribute('src');\n\n      if (!src) {\n        return;\n      }\n\n      return _services.Services.urlReplacementsForDoc(_this2.element).expandUrlAsync(_this2.assertSource_(src)).then(function (src) {\n        var pixel = (0, _pixel.createPixel)(_this2.win, src, _this2.referrerPolicy_);\n        (0, _log.dev)().info(TAG, 'pixel triggered: ', src);\n        return pixel;\n      });\n    });\n  }\n  /**\n   * @param {?string} src\n   * @return {string}\n   * @private\n   */\n  ;\n\n  _proto.assertSource_ = function assertSource_(src) {\n    (0, _log.userAssert)(/^(https\\:\\/\\/|\\/\\/)/i.test(src), 'The <amp-pixel> src attribute must start with ' + '\"https://\" or \"//\". Invalid value: ' + src);\n    return (\n      /** @type {string} */\n      src\n    );\n  };\n\n  return AmpPixel;\n}(_baseElement.BaseElement);\n/**\n * @param {!Window} win Destination window for the new element.\n */\n\n\nexports.AmpPixel = AmpPixel;\n\nfunction installPixel(win) {\n  (0, _customElementRegistry.registerElement)(win, TAG, AmpPixel);\n}\n\n},{\"../src/base-element\":29,\"../src/log\":68,\"../src/pixel\":73,\"../src/service/custom-element-registry\":87,\"../src/services\":123}],11:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.A4AVariableSource = void 0;\n\nvar _services = require(\"../../../src/services\");\n\nvar _variableSource = require(\"../../../src/service/variable-source\");\n\nvar _log = require(\"../../../src/log\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\nvar WHITELISTED_VARIABLES = ['AMPDOC_HOST', 'AMPDOC_HOSTNAME', 'AMPDOC_URL', 'AMP_VERSION', 'AVAILABLE_SCREEN_HEIGHT', 'AVAILABLE_SCREEN_WIDTH', 'BACKGROUND_STATE', 'BROWSER_LANGUAGE', 'CANONICAL_HOST', 'CANONICAL_HOSTNAME', 'CANONICAL_PATH', 'CANONICAL_URL', 'COUNTER', 'DOCUMENT_CHARSET', 'DOCUMENT_REFERRER', 'FIRST_CONTENTFUL_PAINT', 'FIRST_VIEWPORT_READY', 'MAKE_BODY_VISIBLE', 'PAGE_VIEW_ID', 'RANDOM', 'SCREEN_COLOR_DEPTH', 'SCREEN_HEIGHT', 'SCREEN_WIDTH', 'SCROLL_HEIGHT', 'SCROLL_LEFT', 'SCROLL_TOP', 'SCROLL_WIDTH', 'SHARE_TRACKING_INCOMING', 'SHARE_TRACKING_OUTGOING', 'SOURCE_HOST', 'SOURCE_HOSTNAME', 'SOURCE_PATH', 'SOURCE_URL', 'TIMESTAMP', 'TIMEZONE', 'TIMEZONE_CODE', 'TITLE', 'TOTAL_ENGAGED_TIME', 'USER_AGENT', 'VARIANT', 'VARIANTS', 'VIEWER', 'VIEWPORT_HEIGHT', 'VIEWPORT_WIDTH'];\n/** Provides A4A specific variable substitution. */\n\nvar A4AVariableSource =\n/*#__PURE__*/\nfunction (_VariableSource) {\n  _inheritsLoose(A4AVariableSource, _VariableSource);\n\n  /**\n   * @param  {!../../../src/service/ampdoc-impl.AmpDoc} parentAmpdoc\n   * @param  {!Window} embedWin\n   */\n  function A4AVariableSource(parentAmpdoc, embedWin) {\n    var _this;\n\n    _this = _VariableSource.call(this, parentAmpdoc) || this; // Use parent URL replacements service for fallback.\n\n    var headNode = parentAmpdoc.getHeadNode();\n\n    var urlReplacements = _services.Services.urlReplacementsForDoc(headNode);\n    /** @private {VariableSource} global variable source for fallback. */\n\n\n    _this.globalVariableSource_ = urlReplacements.getVariableSource();\n    /** @private {!Window} */\n\n    _this.win_ = embedWin;\n    return _this;\n  }\n  /** @override */\n\n\n  var _proto = A4AVariableSource.prototype;\n\n  _proto.initialize = function initialize() {\n    var _this2 = this;\n\n    // Initiate whitelisted varaibles first in case the resolver function needs\n    // to be overwritten.\n    for (var v = 0; v < WHITELISTED_VARIABLES.length; v++) {\n      var varName = WHITELISTED_VARIABLES[v];\n      var resolvers = this.globalVariableSource_.get(varName);\n      this.set(varName, resolvers.sync).setAsync(varName, resolvers.async);\n    }\n\n    this.set('NAV_TIMING', function (startAttribute, endAttribute) {\n      (0, _log.userAssert)(startAttribute, 'The first argument to NAV_TIMING, the' + ' start attribute name, is required');\n      return (0, _variableSource.getTimingDataSync)(_this2.win_,\n      /**@type {string}*/\n      startAttribute,\n      /**@type {string}*/\n      endAttribute);\n    }).setAsync('NAV_TIMING', function (startAttribute, endAttribute) {\n      (0, _log.userAssert)(startAttribute, 'The first argument to NAV_TIMING, the' + ' start attribute name, is required');\n      return (0, _variableSource.getTimingDataAsync)(_this2.win_,\n      /**@type {string}*/\n      startAttribute,\n      /**@type {string}*/\n      endAttribute);\n    });\n    this.set('NAV_TYPE', function () {\n      return (0, _variableSource.getNavigationData)(_this2.win_, 'type');\n    });\n    this.set('NAV_REDIRECT_COUNT', function () {\n      return (0, _variableSource.getNavigationData)(_this2.win_, 'redirectCount');\n    });\n    this.set('HTML_ATTR',\n    /** @type {function(...*)} */\n    this.htmlAttributeBinding_.bind(this));\n    this.set('CLIENT_ID', function () {\n      return null;\n    });\n  }\n  /**\n   * Provides a binding for getting attributes from the DOM.\n   * Most such bindings are provided in src/service/url-replacements-impl, but\n   * this one needs access to this.win_.document, which if the amp-analytics\n   * tag is contained within an amp-ad tag will NOT be the parent/publisher\n   * page. Hence the need to put it here.\n   * @param {string} cssSelector Elements matching this selector will be\n   *     included, provided they have at least one of the attributeNames\n   *     set, up to a max of 10. May be URI encoded.\n   * @param {...string} var_args Additional params will be the names of\n   *     attributes whose values will be returned. There should be at least 1.\n   * @return {string} A stringified JSON array containing one member for each\n   *     matching element. Each member will contain the names and values of the\n   *     specified attributes, if the corresponding element has that attribute.\n   *     Note that if an element matches the cssSelected but has none of the\n   *     requested attributes, then nothing will be included in the array\n   *     for that element.\n   */\n  ;\n\n  _proto.htmlAttributeBinding_ = function htmlAttributeBinding_(cssSelector, var_args) {\n    // Generate an error if cssSelector matches more than this many elements\n    var HTML_ATTR_MAX_ELEMENTS_TO_TRAVERSE = 20; // Of the elements matched by cssSelector, see which contain one or more\n    // of the specified attributes, and return an array of at most this many.\n\n    var HTML_ATTR_MAX_ELEMENTS_TO_RETURN = 10; // Only allow at most this many attributeNames to be specified.\n\n    var HTML_ATTR_MAX_ATTRS = 10;\n    var TAG = 'A4AVariableSource';\n    var attributeNames = Array.prototype.slice.call(arguments, 1);\n\n    if (!cssSelector || !attributeNames.length) {\n      return '[]';\n    }\n\n    if (attributeNames.length > HTML_ATTR_MAX_ATTRS) {\n      (0, _log.user)().error(TAG, \"At most \" + HTML_ATTR_MAX_ATTRS + \" may be requested.\");\n      return '[]';\n    }\n\n    cssSelector = decodeURI(cssSelector);\n    var elements;\n\n    try {\n      elements = this.win_.document.querySelectorAll(cssSelector);\n    } catch (e) {\n      (0, _log.user)().error(TAG, \"Invalid selector: \" + cssSelector);\n      return '[]';\n    }\n\n    if (elements.length > HTML_ATTR_MAX_ELEMENTS_TO_TRAVERSE) {\n      (0, _log.user)().error(TAG, 'CSS selector may match at most ' + (HTML_ATTR_MAX_ELEMENTS_TO_TRAVERSE + \" elements.\"));\n      return '[]';\n    }\n\n    var result = [];\n\n    for (var i = 0; i < elements.length && result.length < HTML_ATTR_MAX_ELEMENTS_TO_RETURN; ++i) {\n      var currentResult = {};\n      var foundAtLeastOneAttr = false;\n\n      for (var j = 0; j < attributeNames.length; ++j) {\n        var attributeName = attributeNames[j];\n\n        if (elements[i].hasAttribute(attributeName)) {\n          currentResult[attributeName] = elements[i].getAttribute(attributeName);\n          foundAtLeastOneAttr = true;\n        }\n      }\n\n      if (foundAtLeastOneAttr) {\n        result.push(currentResult);\n      }\n    }\n\n    return JSON.stringify(result);\n  };\n\n  return A4AVariableSource;\n}(_variableSource.VariableSource);\n\nexports.A4AVariableSource = A4AVariableSource;\n\n},{\"../../../src/log\":68,\"../../../src/service/variable-source\":112,\"../../../src/services\":123}],12:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.protectFunctionWrapper = protectFunctionWrapper;\nexports.assignAdUrlToError = assignAdUrlToError;\nexports.signatureVerifierFor = signatureVerifierFor;\nexports.AmpA4A = exports.AnalyticsTrigger = exports.CreativeMetaDataDef = exports.SizeInfoDef = exports.XORIGIN_MODE = exports.IFRAME_GET = exports.INVALID_SPSA_RESPONSE = exports.NETWORK_FAILURE = exports.NO_CONTENT_RESPONSE = exports.EXPERIMENT_FEATURE_HEADER_NAME = exports.SAFEFRAME_VERSION_HEADER = exports.RENDERING_TYPE_HEADER = exports.CREATIVE_SIZE_HEADER = exports.DEFAULT_SAFEFRAME_VERSION = void 0;\n\nvar _a4aVariableSource = require(\"./a4a-variable-source\");\n\nvar _consentState = require(\"../../../src/consent-state\");\n\nvar _layout = require(\"../../../src/layout\");\n\nvar _trafficExperiments = require(\"../../../ads/google/a4a/traffic-experiments\");\n\nvar _services = require(\"../../../src/services\");\n\nvar _signatureVerifier = require(\"./signature-verifier\");\n\nvar _pFrame = require(\"../../../src/3p-frame\");\n\nvar _url = require(\"../../../src/url\");\n\nvar _error = require(\"../../../src/error\");\n\nvar _dom = require(\"../../../src/dom\");\n\nvar _log = require(\"../../../src/log\");\n\nvar _object = require(\"../../../src/utils/object\");\n\nvar _concurrentLoad = require(\"../../amp-ad/0.1/concurrent-load\");\n\nvar _consent = require(\"../../../src/consent\");\n\nvar _iframeAttributes = require(\"../../../src/iframe-attributes\");\n\nvar _mode = require(\"../../../src/mode\");\n\nvar _extensionAnalytics = require(\"../../../src/extension-analytics\");\n\nvar _friendlyIframeEmbed = require(\"../../../src/friendly-iframe-embed\");\n\nvar _urlReplacementsImpl = require(\"../../../src/service/url-replacements-impl\");\n\nvar _adHelper = require(\"../../../src/ad-helper\");\n\nvar _types = require(\"../../../src/types\");\n\nvar _json = require(\"../../../src/json\");\n\nvar _style = require(\"../../../src/style\");\n\nvar _a4aConfig = require(\"../../../ads/_a4a-config\");\n\nvar _analytics = require(\"../../../src/analytics\");\n\nvar _promise = require(\"../../../src/utils/promise\");\n\nvar _bytes = require(\"../../../src/utils/bytes\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/** @type {Array<string>} */\nvar METADATA_STRINGS = ['<script amp-ad-metadata type=application/json>', '<script type=\"application/json\" amp-ad-metadata>', '<script type=application/json amp-ad-metadata>']; // TODO(tdrl): Temporary, while we're verifying whether SafeFrame is an\n// acceptable solution to the 'Safari on iOS doesn't fetch iframe src from\n// cache' issue.  See https://github.com/ampproject/amphtml/issues/5614\n\n/** @type {string} */\n\nvar DEFAULT_SAFEFRAME_VERSION = '1-0-23';\n/** @const {string} */\n\nexports.DEFAULT_SAFEFRAME_VERSION = DEFAULT_SAFEFRAME_VERSION;\nvar CREATIVE_SIZE_HEADER = 'X-CreativeSize';\n/** @type {string} @visibleForTesting */\n\nexports.CREATIVE_SIZE_HEADER = CREATIVE_SIZE_HEADER;\nvar RENDERING_TYPE_HEADER = 'X-AmpAdRender';\n/** @type {string} @visibleForTesting */\n\nexports.RENDERING_TYPE_HEADER = RENDERING_TYPE_HEADER;\nvar SAFEFRAME_VERSION_HEADER = 'X-AmpSafeFrameVersion';\n/** @type {string} @visibleForTesting */\n\nexports.SAFEFRAME_VERSION_HEADER = SAFEFRAME_VERSION_HEADER;\nvar EXPERIMENT_FEATURE_HEADER_NAME = 'amp-ff-exps';\n/** @type {string} */\n\nexports.EXPERIMENT_FEATURE_HEADER_NAME = EXPERIMENT_FEATURE_HEADER_NAME;\nvar TAG = 'amp-a4a';\n/** @type {string} */\n\nvar NO_CONTENT_RESPONSE = 'NO-CONTENT-RESPONSE';\n/** @type {string} */\n\nexports.NO_CONTENT_RESPONSE = NO_CONTENT_RESPONSE;\nvar NETWORK_FAILURE = 'NETWORK-FAILURE';\n/** @type {string} */\n\nexports.NETWORK_FAILURE = NETWORK_FAILURE;\nvar INVALID_SPSA_RESPONSE = 'INVALID-SPSA-RESPONSE';\n/** @type {string} */\n\nexports.INVALID_SPSA_RESPONSE = INVALID_SPSA_RESPONSE;\nvar IFRAME_GET = 'IFRAME-GET';\n/** @enum {string} */\n\nexports.IFRAME_GET = IFRAME_GET;\nvar XORIGIN_MODE = {\n  CLIENT_CACHE: 'client_cache',\n  SAFEFRAME: 'safeframe',\n  NAMEFRAME: 'nameframe',\n  IFRAME_GET: 'iframe_get'\n};\n/** @type {!Object} @private */\n\nexports.XORIGIN_MODE = XORIGIN_MODE;\nvar SHARED_IFRAME_PROPERTIES = (0, _object.dict)({\n  'frameborder': '0',\n  'allowfullscreen': '',\n  'allowtransparency': '',\n  'scrolling': 'no',\n  'marginwidth': '0',\n  'marginheight': '0'\n});\n/** @typedef {{width: number, height: number}} */\n\nvar SizeInfoDef;\n/** @typedef {{\n      minifiedCreative: string,\n      customElementExtensions: !Array<string>,\n      customStylesheets: !Array<{href: string}>,\n      images: (Array<string>|undefined),\n      ctaType: (string|undefined),\n      ctaUrl: (string|undefined),\n    }} */\n\nexports.SizeInfoDef = SizeInfoDef;\nvar CreativeMetaDataDef;\n/**\n * Name of A4A lifecycle triggers.\n * @enum {string}\n */\n\nexports.CreativeMetaDataDef = CreativeMetaDataDef;\nvar AnalyticsTrigger = {\n  AD_REQUEST_START: 'ad-request-start',\n  AD_RESPONSE_END: 'ad-response-end',\n  AD_RENDER_START: 'ad-render-start',\n  AD_RENDER_END: 'ad-render-end',\n  AD_IFRAME_LOADED: 'ad-iframe-loaded',\n  // This trigger is not part of the normal ads lifecycle and only fires when an\n  // ad is refreshed.\n  AD_REFRESH: 'ad-refresh'\n};\n/**\n * Maps the names of lifecycle events to analytics triggers.\n * @const {!Object<string, !AnalyticsTrigger>}\n */\n\nexports.AnalyticsTrigger = AnalyticsTrigger;\nvar LIFECYCLE_STAGE_TO_ANALYTICS_TRIGGER = {\n  'adRequestStart': AnalyticsTrigger.AD_REQUEST_START,\n  'adRequestEnd': AnalyticsTrigger.AD_RESPONSE_END,\n  'renderFriendlyStart': AnalyticsTrigger.AD_RENDER_START,\n  'renderCrossDomainStart': AnalyticsTrigger.AD_RENDER_START,\n  'renderSafeFrameStart': AnalyticsTrigger.AD_RENDER_START,\n  'renderFriendlyEnd': AnalyticsTrigger.AD_RENDER_END,\n  'renderCrossDomainEnd': AnalyticsTrigger.AD_RENDER_END,\n  'friendlyIframeIniLoad': AnalyticsTrigger.AD_IFRAME_LOADED,\n  'crossDomainIframeLoaded': AnalyticsTrigger.AD_IFRAME_LOADED\n};\n/**\n * Utility function that ensures any error thrown is handled by optional\n * onError handler (if none provided or handler throws, error is swallowed and\n * undefined is returned).\n * @param {!Function} fn to protect\n * @param {T=} inThis An optional object to use as the 'this' object\n *    when calling the function.  If not provided, undefined is bound as this\n *    when calling function.\n * @param {function(this:T, !Error, ...*):?=} onError function given error\n *    and arguments provided to function call.\n * @return {!Function} protected function\n * @template T\n * @visibleForTesting\n */\n\nfunction protectFunctionWrapper(fn, inThis, onError) {\n  if (inThis === void 0) {\n    inThis = undefined;\n  }\n\n  if (onError === void 0) {\n    onError = undefined;\n  }\n\n  return function () {\n    for (var _len = arguments.length, fnArgs = new Array(_len), _key = 0; _key < _len; _key++) {\n      fnArgs[_key] = arguments[_key];\n    }\n\n    try {\n      return fn.apply(inThis, fnArgs);\n    } catch (err) {\n      if (onError) {\n        try {\n          // Ideally we could use [err, ...var_args] but linter disallows\n          // spread so instead using unshift :(\n          fnArgs.unshift(err);\n          return onError.apply(inThis, fnArgs);\n        } catch (captureErr) {// swallow error if error handler throws.\n        }\n      } // In the event of no optional on error function or its execution throws,\n      // return undefined.\n\n\n      return undefined;\n    }\n  };\n}\n/** Abstract class for AMP Ad Fast Fetch enabled networks */\n\n\nvar AmpA4A =\n/*#__PURE__*/\nfunction (_AMP$BaseElement) {\n  _inheritsLoose(AmpA4A, _AMP$BaseElement);\n\n  // TODO: Add more error handling throughout code.\n  // TODO: Handle creatives that do not fill.\n\n  /**\n   * @param {!Element} element\n   */\n  function AmpA4A(element) {\n    var _this;\n\n    _this = _AMP$BaseElement.call(this, element) || this;\n    (0, _log.devAssert)(AMP.AmpAdUIHandler);\n    (0, _log.devAssert)(AMP.AmpAdXOriginIframeHandler);\n    /** @private {?Promise<undefined>} */\n\n    _this.keysetPromise_ = null;\n    /** @private {?Promise<?CreativeMetaDataDef>} */\n\n    _this.adPromise_ = null;\n    /**\n     * @private {number} unique ID of the currently executing promise to allow\n     * for cancellation.\n     */\n\n    _this.promiseId_ = 0;\n    /** @private {?string} */\n\n    _this.adUrl_ = null;\n    /** @private {?../../../src/friendly-iframe-embed.FriendlyIframeEmbed} */\n\n    _this.friendlyIframeEmbed_ = null;\n    /** @type {?AMP.AmpAdUIHandler} */\n\n    _this.uiHandler = null;\n    /** @private {?AMP.AmpAdXOriginIframeHandler} */\n\n    _this.xOriginIframeHandler_ = null;\n    /** @private {boolean} whether creative has been verified as AMP */\n\n    _this.isVerifiedAmpCreative_ = false;\n    /** @private {?ArrayBuffer} */\n\n    _this.creativeBody_ = null;\n    /**\n     * Initialize this with the slot width/height attributes, and override\n     * later with what the network implementation returns via extractSize.\n     * Note: Either value may be 'auto' (i.e., non-numeric).\n     *\n     * @private {?({width, height}|../../../src/layout-rect.LayoutRectDef)}\n     */\n\n    _this.creativeSize_ = null;\n    /** @private {?../../../src/layout-rect.LayoutRectDef} */\n\n    _this.originalSlotSize_ = null;\n    /**\n     * Note(keithwrightbos) - ensure the default here is null so that ios\n     * uses safeframe when response header is not specified.\n     * @private {?XORIGIN_MODE}\n     */\n\n    _this.experimentalNonAmpCreativeRenderMethod_ = _this.getNonAmpCreativeRenderingMethod();\n    /**\n     * Gets a notion of current time, in ms.  The value is not necessarily\n     * absolute, so should be used only for computing deltas.  When available,\n     * the performance system will be used; otherwise Date.now() will be\n     * returned.\n     *\n     * @const {function():number}\n     */\n\n    _this.getNow_ = _this.win.performance && _this.win.performance.now ? _this.win.performance.now.bind(_this.win.performance) : Date.now;\n    /** @const {string} */\n\n    _this.sentinel = (0, _pFrame.generateSentinel)(window);\n    /**\n     * Used to indicate whether this slot should be collapsed or not. Marked\n     * true if the ad response has status 204, is null, or has a null\n     * arrayBuffer.\n     * @private {boolean}\n     */\n\n    _this.isCollapsed_ = false;\n    /**\n     * Frame in which the creative renders (friendly if validated AMP, xdomain\n     * otherwise).\n     * @type {?HTMLIFrameElement}\n     */\n\n    _this.iframe = null;\n    /**\n     * TODO(keithwrightbos) - remove once resume behavior is verified.\n     * {boolean} whether most recent ad request was generated as part\n     *    of resume callback.\n     */\n\n    _this.fromResumeCallback = false;\n    /** @type {string} */\n\n    _this.safeframeVersion = DEFAULT_SAFEFRAME_VERSION;\n    /**\n     * @protected {boolean} Indicates whether the ad is currently in the\n     *    process of being refreshed.\n     */\n\n    _this.isRefreshing = false;\n    /** @protected {boolean} */\n\n    _this.isRelayoutNeededFlag = false;\n    /**\n     * Mapping of feature name to value extracted from ad response header\n     * amp-ff-exps with comma separated pairs of '=' separated key/value.\n     * @type {!Object<string,string>}\n     */\n\n    _this.postAdResponseExperimentFeatures = {};\n    /**\n     * The configuration for amp-analytics. If null, no amp-analytics element\n     * will be inserted and no analytics events will be fired.\n     * This will be initialized inside of buildCallback.\n     * @private {?JsonObject}\n     */\n\n    _this.a4aAnalyticsConfig_ = null;\n    /**\n     * The amp-analytics element that for this impl's analytics config. It will\n     * be null before buildCallback() executes or if the impl does not provide\n     * an analytice config.\n     * @private {?Element}\n     * @visibleForTesting\n     */\n\n    _this.a4aAnalyticsElement_ = null;\n    /**\n     * Indicates that this slot is a single page ad within an AMP story.\n     * @type {boolean}\n     */\n\n    _this.isSinglePageStoryAd = false;\n    return _this;\n  }\n  /** @override */\n\n\n  var _proto = AmpA4A.prototype;\n\n  _proto.getLayoutPriority = function getLayoutPriority() {\n    // Priority used for scheduling preload and layout callback.  Because\n    // AMP creatives will be injected as part of the promise chain created\n    // within onLayoutMeasure, this is only relevant to non-AMP creatives\n    // therefore we want this to match the 3p priority.\n    var isPWA = !this.element.getAmpDoc().isSingleDoc(); // give the ad higher priority if it is inside a PWA\n\n    return isPWA ? _layout.LayoutPriority.METADATA : _layout.LayoutPriority.ADS;\n  }\n  /** @override */\n  ;\n\n  _proto.isLayoutSupported = function isLayoutSupported(layout) {\n    return (0, _layout.isLayoutSizeDefined)(layout);\n  }\n  /** @override */\n  ;\n\n  _proto.isRelayoutNeeded = function isRelayoutNeeded() {\n    return this.isRelayoutNeededFlag;\n  }\n  /** @override\n      @return {!Promise|undefined}\n  */\n  ;\n\n  _proto.buildCallback = function buildCallback() {\n    var _this2 = this;\n\n    this.creativeSize_ = {\n      width: this.element.getAttribute('width'),\n      height: this.element.getAttribute('height')\n    };\n    var upgradeDelayMs = Math.round(this.getResource().getUpgradeDelayMs());\n    (0, _log.dev)().info(TAG, \"upgradeDelay \" + this.element.getAttribute('type') + \": \" + upgradeDelayMs);\n    this.uiHandler = new AMP.AmpAdUIHandler(this);\n    var verifier = signatureVerifierFor(this.win);\n    this.keysetPromise_ = this.getAmpDoc().whenFirstVisible().then(function () {\n      _this2.getSigningServiceNames().forEach(function (signingServiceName) {\n        verifier.loadKeyset(signingServiceName);\n      });\n    });\n    this.a4aAnalyticsConfig_ = this.getA4aAnalyticsConfig();\n\n    if (this.a4aAnalyticsConfig_) {\n      // TODO(warrengm): Consider having page-level singletons for networks that\n      // use the same config for all ads.\n      this.a4aAnalyticsElement_ = (0, _extensionAnalytics.insertAnalyticsElement)(this.element, this.a4aAnalyticsConfig_, true\n      /* loadAnalytics */\n      );\n    }\n\n    this.isSinglePageStoryAd = this.element.hasAttribute('amp-story');\n  }\n  /** @override */\n  ;\n\n  _proto.renderOutsideViewport = function renderOutsideViewport() {\n    // Ensure non-verified AMP creatives are throttled.\n    if (!this.isVerifiedAmpCreative_ && (0, _concurrentLoad.is3pThrottled)(this.win) && !this.inNonAmpPreferenceExp()) {\n      return false;\n    } // Otherwise the ad is good to go.\n\n\n    var elementCheck = (0, _concurrentLoad.getAmpAdRenderOutsideViewport)(this.element);\n    return elementCheck !== null ? elementCheck : _AMP$BaseElement.prototype.renderOutsideViewport.call(this);\n  }\n  /**\n   * To be overridden by network specific implementation indicating if element\n   * (and environment generally) are valid for sending XHR queries.\n   * @return {boolean} whether element is valid and ad request should be\n   *    sent.  If false, no ad request is sent and slot will be collapsed if\n   *    possible.\n   */\n  ;\n\n  _proto.isValidElement = function isValidElement() {\n    return true;\n  }\n  /**\n   * Returns the creativeSize, which is the size extracted from the ad response.\n   * @return {?({width, height}|../../../src/layout-rect.LayoutRectDef)}\n   */\n  ;\n\n  _proto.getCreativeSize = function getCreativeSize() {\n    return this.creativeSize_;\n  }\n  /**\n   * @return {boolean|number} whether ad request should be delayed until\n   *    renderOutsideViewport is met or if number, the amount of viewports.\n   */\n  ;\n\n  _proto.delayAdRequestEnabled = function delayAdRequestEnabled() {\n    return false;\n  }\n  /**\n   * Returns preconnect urls for A4A. Ad network should overwrite in their\n   * Fast Fetch implementation and return an array of urls for the runtime to\n   * preconnect to.\n   * @return {!Array<string>}\n   */\n  ;\n\n  _proto.getPreconnectUrls = function getPreconnectUrls() {\n    return [];\n  }\n  /**\n   * Returns prefetch urls for A4A. Ad network should overwrite in their\n   * Fast Fetch implementation and return an array of urls for the runtime to\n   * prefetch.\n   * @return {!Array<string>}\n   */\n  ;\n\n  _proto.getPrefetchUrls = function getPrefetchUrls() {\n    return [];\n  }\n  /**\n   * Returns true if this element was loaded from an amp-ad element.  For use by\n   * network-specific implementations that don't want to allow themselves to be\n   * embedded directly into a page.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isAmpAdElement = function isAmpAdElement() {\n    return this.element.tagName == 'AMP-AD' || this.element.tagName == 'AMP-EMBED';\n  }\n  /**\n   * Prefetches and preconnects URLs related to the ad using adPreconnect\n   * registration which assumes ad request domain used for 3p is applicable.\n   * @param {boolean=} unusedOnLayout\n   * @override\n   */\n  ;\n\n  _proto.preconnectCallback = function preconnectCallback(unusedOnLayout) {\n    var _this3 = this;\n\n    var preconnect = this.getPreconnectUrls(); // NOTE(keithwrightbos): Does not take isValidElement into account so could\n    // preconnect unnecessarily, however it is assumed that isValidElement\n    // matches amp-ad loader predicate such that A4A impl does not load.\n\n    if (preconnect) {\n      preconnect.forEach(function (p) {\n        _this3.preconnect.url(p,\n        /*opt_preloadAs*/\n        true);\n      });\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.resumeCallback = function resumeCallback() {\n    // FIE that was not destroyed on unlayoutCallback does not require a new\n    // ad request.\n    if (this.friendlyIframeEmbed_) {\n      return;\n    }\n\n    this.fromResumeCallback = true; // If layout of page has not changed, onLayoutMeasure will not be called\n    // so do so explicitly.\n\n    var resource = this.getResource();\n\n    if (resource.hasBeenMeasured() && !resource.isMeasureRequested()) {\n      this.onLayoutMeasure();\n    }\n  }\n  /**\n   * @return {!../../../src/service/resource.Resource}\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.getResource = function getResource() {\n    return this.element.getResources().getResourceForElement(this.element);\n  }\n  /**\n   * @return {boolean} whether adPromise was initialized (indicator of\n   *    element validity).\n   * @protected\n   */\n  ;\n\n  _proto.hasAdPromise = function hasAdPromise() {\n    return !!this.adPromise_;\n  }\n  /**\n   * Should only be called after XHR response headers have been processed and\n   * postAdResponseExperimentFeatures is populated.\n   * @return {boolean} whether in experiment giving non-AMP creatives same\n   *    benefits as AMP (increased priority, no throttle)\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.inNonAmpPreferenceExp = function inNonAmpPreferenceExp() {\n    return !!this.postAdResponseExperimentFeatures['pref_neutral_enabled'] && ['adsense', 'doubleclick'].includes(this.element.getAttribute('type'));\n  }\n  /**\n   * @return {boolean} whether environment/element should initialize ad request\n   *    promise chain.\n   * @private\n   */\n  ;\n\n  _proto.shouldInitializePromiseChain_ = function shouldInitializePromiseChain_() {\n    var slotRect = this.getIntersectionElementLayoutBox();\n\n    if (this.getLayout() != _layout.Layout.FLUID && (slotRect.height == 0 || slotRect.width == 0)) {\n      (0, _log.dev)().fine(TAG, 'onLayoutMeasure canceled due height/width 0', this.element);\n      return false;\n    }\n\n    if (!(0, _adHelper.isAdPositionAllowed)(this.element, this.win)) {\n      (0, _log.user)().warn(TAG, \"<\" + this.element.tagName + \"> is not allowed to be \" + (\"placed in elements with position:fixed: \" + this.element));\n      return false;\n    } // OnLayoutMeasure can be called when page is in prerender so delay until\n    // visible.  Assume that it is ok to call isValidElement as it should\n    // only being looking at window, immutable properties (i.e. location) and\n    // its element ancestry.\n\n\n    if (!this.isValidElement()) {\n      // TODO(kjwright): collapse?\n      (0, _log.user)().warn(TAG, this.element.getAttribute('type'), 'Amp ad element ignored as invalid', this.element);\n      return false;\n    }\n\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.onLayoutMeasure = function onLayoutMeasure() {\n    this.initiateAdRequest();\n  }\n  /**\n   * This is the entry point into the ad promise chain.\n   *\n   * Calling this function will initiate the following sequence of events: ad\n   * url construction, ad request issuance, creative verification, and metadata\n   * parsing.\n   *\n   * @protected\n   */\n  ;\n\n  _proto.initiateAdRequest = function initiateAdRequest() {\n    var _this4 = this;\n\n    if (this.xOriginIframeHandler_) {\n      this.xOriginIframeHandler_.onLayoutMeasure();\n    }\n\n    if (this.adPromise_ || !this.shouldInitializePromiseChain_()) {\n      return;\n    } // Increment unique promise ID so that if its value changes within the\n    // promise chain due to cancel from unlayout, the promise will be rejected.\n\n\n    ++this.promiseId_; // Shorthand for: reject promise if current promise chain is out of date.\n\n    var checkStillCurrent = this.verifyStillCurrent(); // Return value from this chain: True iff rendering was \"successful\"\n    // (i.e., shouldn't try to render later via iframe); false iff should\n    // try to render later in iframe.\n    // Cases to handle in this chain:\n    //   - Everything ok  => Render; return true\n    //   - Empty network response returned => Don't render; return true\n    //   - Can't parse creative out of response => Don't render; return false\n    //   - Can parse, but creative is empty => Don't render; return true\n    //   - Validation fails => return false\n    //   - Rendering fails => return false\n    //   - Chain cancelled => don't return; drop error\n    //   - Uncaught error otherwise => don't return; percolate error up\n\n    this.adPromise_ = this.getAmpDoc().whenFirstVisible().then(function () {\n      checkStillCurrent(); // See if experiment that delays request until slot is within\n      // renderOutsideViewport. Within render outside viewport will not\n      // resolve if already within viewport thus the check for already\n      // meeting the definition as opposed to waiting on the promise.\n\n      var delay = _this4.delayAdRequestEnabled();\n\n      if (delay) {\n        return _this4.getResource().whenWithinViewport(typeof delay == 'number' ? delay : _this4.renderOutsideViewport());\n      }\n    }) // Possibly block on amp-consent.\n\n    /** @return {!Promise<Array<Promise>>} */\n    .then(function () {\n      checkStillCurrent();\n\n      var consentPolicyId = _AMP$BaseElement.prototype.getConsentPolicy.call(_this4);\n\n      if (consentPolicyId) {\n        var consentStatePromise = (0, _consent.getConsentPolicyState)(_this4.element, consentPolicyId).catch(function (err) {\n          (0, _log.user)().error(TAG, 'Error determining consent state', err);\n          return _consentState.CONSENT_POLICY_STATE.UNKNOWN;\n        });\n        var consentStringPromise = (0, _consent.getConsentPolicyInfo)(_this4.element, consentPolicyId).catch(function (err) {\n          (0, _log.user)().error(TAG, 'Error determining consent string', err);\n          return null;\n        });\n        return Promise.all([consentStatePromise, consentStringPromise]);\n      }\n\n      return Promise.resolve([null, null]);\n    }) // This block returns the ad URL, if one is available.\n\n    /** @return {!Promise<?string>} */\n    .then(function (consentResponse) {\n      checkStillCurrent();\n      var consentState = consentResponse[0];\n      var consentString = consentResponse[1];\n      return (\n        /** @type {!Promise<?string>} */\n        _this4.getAdUrl(consentState, _this4.tryExecuteRealTimeConfig_(consentState, consentString))\n      );\n    }) // This block returns the (possibly empty) response to the XHR request.\n\n    /** @return {!Promise<?Response>} */\n    .then(function (adUrl) {\n      checkStillCurrent();\n      _this4.adUrl_ = adUrl; // If we should skip the XHR, we will instead request and render\n      // by simply writing a frame into the page using\n      // renderViaIframeGet\n\n      if (!_this4.isXhrAllowed() && !!_this4.adUrl_) {\n        _this4.experimentalNonAmpCreativeRenderMethod_ = XORIGIN_MODE.IFRAME_GET;\n        return Promise.reject(IFRAME_GET);\n      }\n\n      return adUrl && _this4.sendXhrRequest(adUrl);\n    }) // The following block returns either the response (as a\n    // {bytes, headers} object), or null if no response is available /\n    // response is empty.\n\n    /** @return {?Promise<?{bytes: !ArrayBuffer, headers: !Headers}>} */\n    .then(function (fetchResponse) {\n      checkStillCurrent();\n\n      _this4.maybeTriggerAnalyticsEvent_('adRequestEnd'); // If the response is null (can occur for non-200 responses)  or\n      // arrayBuffer is null, force collapse.\n\n\n      if (!fetchResponse || !fetchResponse.arrayBuffer || fetchResponse.headers.has('amp-ff-empty-creative')) {\n        _this4.forceCollapse();\n\n        return Promise.reject(NO_CONTENT_RESPONSE);\n      }\n\n      if (fetchResponse.headers && fetchResponse.headers.has(EXPERIMENT_FEATURE_HEADER_NAME)) {\n        _this4.populatePostAdResponseExperimentFeatures_(fetchResponse.headers.get(EXPERIMENT_FEATURE_HEADER_NAME));\n      }\n\n      if ((0, _mode.getMode)().localDev && _this4.win.location && _this4.win.location.search) {\n        // Allow for setting experiment features via query param which\n        // will potentially override values returned in response.\n        var match = /(?:\\?|&)a4a_feat_exp=([^&]+)/.exec(_this4.win.location.search);\n\n        if (match && match[1]) {\n          (0, _log.dev)().info(TAG, \"Using debug exp features: \" + match[1]);\n\n          _this4.populatePostAdResponseExperimentFeatures_((0, _url.tryDecodeUriComponent)(match[1]));\n        }\n      } // TODO(tdrl): Temporary, while we're verifying whether SafeFrame is\n      // an acceptable solution to the 'Safari on iOS doesn't fetch\n      // iframe src from cache' issue.  See\n      // https://github.com/ampproject/amphtml/issues/5614\n\n\n      var method = _this4.getNonAmpCreativeRenderingMethod(fetchResponse.headers.get(RENDERING_TYPE_HEADER));\n\n      _this4.experimentalNonAmpCreativeRenderMethod_ = method;\n\n      if (_this4.experimentalNonAmpCreativeRenderMethod_ == XORIGIN_MODE.NAMEFRAME) {\n        _this4.preconnect.preload((0, _pFrame.getDefaultBootstrapBaseUrl)(_this4.win, 'nameframe'));\n      }\n\n      var safeframeVersionHeader = fetchResponse.headers.get(SAFEFRAME_VERSION_HEADER);\n\n      if (/^[0-9-]+$/.test(safeframeVersionHeader) && safeframeVersionHeader != DEFAULT_SAFEFRAME_VERSION) {\n        _this4.safeframeVersion = safeframeVersionHeader;\n\n        _this4.preconnect.preload(_this4.getSafeframePath());\n      } // Note: Resolving a .then inside a .then because we need to capture\n      // two fields of fetchResponse, one of which is, itself, a promise,\n      // and one of which isn't.  If we just return\n      // fetchResponse.arrayBuffer(), the next step in the chain will\n      // resolve it to a concrete value, but we'll lose track of\n      // fetchResponse.headers.\n\n\n      return fetchResponse.arrayBuffer().then(function (bytes) {\n        if (bytes.byteLength == 0) {\n          // The server returned no content. Instead of displaying a blank\n          // rectangle, we collapse the slot instead.\n          _this4.forceCollapse();\n\n          return Promise.reject(NO_CONTENT_RESPONSE);\n        }\n\n        return {\n          bytes: bytes,\n          headers: fetchResponse.headers\n        };\n      });\n    })\n    /** @return {!Promise<?ArrayBuffer>} */\n    .then(function (responseParts) {\n      checkStillCurrent(); // Keep a handle to the creative body so that we can render into\n      // SafeFrame or NameFrame later, if necessary.  TODO(tdrl): Temporary,\n      // while we\n      // assess whether this is the right solution to the Safari+iOS iframe\n      // src cache issue.  If we decide to keep a SafeFrame-like solution,\n      // we should restructure the promise chain to pass this info along\n      // more cleanly, without use of an object variable outside the chain.\n\n      if (!responseParts) {\n        return Promise.resolve();\n      }\n\n      var bytes = responseParts.bytes,\n          headers = responseParts.headers;\n\n      var size = _this4.extractSize(responseParts.headers);\n\n      _this4.creativeSize_ = size || _this4.creativeSize_;\n\n      if (_this4.experimentalNonAmpCreativeRenderMethod_ != XORIGIN_MODE.CLIENT_CACHE && bytes) {\n        _this4.creativeBody_ = bytes;\n      }\n\n      return _this4.maybeValidateAmpCreative(bytes, headers);\n    }).then(function (creative) {\n      checkStillCurrent(); // Need to know if creative was verified as part of render outside\n      // viewport but cannot wait on promise.  Sadly, need a state a\n      // variable.\n\n      _this4.isVerifiedAmpCreative_ = !!creative;\n      return creative && (0, _bytes.utf8Decode)(creative);\n    }) // This block returns CreativeMetaDataDef iff the creative was verified\n    // as AMP and could be properly parsed for friendly iframe render.\n\n    /** @return {?CreativeMetaDataDef} */\n    .then(function (creativeDecoded) {\n      checkStillCurrent(); // Note: It's critical that #getAmpAdMetadata be called\n      // on precisely the same creative that was validated\n      // via #validateAdResponse_.  See GitHub issue\n      // https://github.com/ampproject/amphtml/issues/4187\n\n      var creativeMetaDataDef;\n\n      if (!creativeDecoded || !(creativeMetaDataDef = _this4.getAmpAdMetadata(creativeDecoded))) {\n        if (_this4.inNonAmpPreferenceExp()) {\n          // Experiment to give non-AMP creatives same benefits as AMP so\n          // update priority.\n          _this4.updateLayoutPriority(_layout.LayoutPriority.CONTENT);\n        }\n\n        return null;\n      } // Update priority.\n\n\n      _this4.updateLayoutPriority(_layout.LayoutPriority.CONTENT); // Load any extensions; do not wait on their promises as this\n      // is just to prefetch.\n\n\n      var extensions = _services.Services.extensionsFor(_this4.win);\n\n      creativeMetaDataDef.customElementExtensions.forEach(function (extensionId) {\n        return extensions.preloadExtension(extensionId);\n      }); // Preload any fonts.\n\n      (creativeMetaDataDef.customStylesheets || []).forEach(function (font) {\n        return _this4.preconnect.preload(font.href);\n      });\n\n      var urls = _services.Services.urlForDoc(_this4.element); // Preload any AMP images.\n\n\n      (creativeMetaDataDef.images || []).forEach(function (image) {\n        return urls.isSecure(image) && _this4.preconnect.preload(image);\n      });\n      return creativeMetaDataDef;\n    }).catch(function (error) {\n      switch (error.message || error) {\n        case IFRAME_GET:\n        case NETWORK_FAILURE:\n          return null;\n\n        case INVALID_SPSA_RESPONSE:\n        case NO_CONTENT_RESPONSE:\n          return {\n            minifiedCreative: '',\n            customElementExtensions: [],\n            customStylesheets: []\n          };\n      } // If error in chain occurs, report it and return null so that\n      // layoutCallback can render via cross domain iframe assuming ad\n      // url or creative exist.\n\n\n      _this4.promiseErrorHandler_(error);\n\n      return null;\n    });\n  }\n  /**\n   * This block returns the ad creative if it exists and validates as AMP;\n   * null otherwise.\n   * @param {!ArrayBuffer} bytes\n   * @param {!Headers} headers\n   * @return {!Promise<?ArrayBuffer>}\n   */\n  ;\n\n  _proto.maybeValidateAmpCreative = function maybeValidateAmpCreative(bytes, headers) {\n    var _this5 = this;\n\n    var checkStillCurrent = this.verifyStillCurrent();\n    return this.keysetPromise_.then(function () {\n      if (_this5.element.getAttribute('type') == 'fake' && !_this5.element.getAttribute('checksig')) {\n        // do not verify signature for fake type ad, unless the ad\n        // specfically requires via 'checksig' attribute\n        return Promise.resolve(_signatureVerifier.VerificationStatus.OK);\n      }\n\n      return signatureVerifierFor(_this5.win).verify(bytes, headers);\n    }).then(function (status) {\n      checkStillCurrent();\n      var result = null;\n\n      switch (status) {\n        case _signatureVerifier.VerificationStatus.OK:\n          result = bytes;\n          break;\n\n        case _signatureVerifier.VerificationStatus.CRYPTO_UNAVAILABLE:\n          result = _this5.shouldPreferentialRenderWithoutCrypto() ? bytes : null;\n          break;\n        // TODO(@taymonbeal, #9274): differentiate between these\n\n        case _signatureVerifier.VerificationStatus.ERROR_KEY_NOT_FOUND:\n        case _signatureVerifier.VerificationStatus.ERROR_SIGNATURE_MISMATCH:\n          (0, _log.user)().error(TAG, _this5.element.getAttribute('type'), 'Signature verification failed');\n\n        case _signatureVerifier.VerificationStatus.UNVERIFIED:\n      }\n\n      if (_this5.isSinglePageStoryAd && !result) {\n        throw new Error(INVALID_SPSA_RESPONSE);\n      }\n\n      return result;\n    });\n  }\n  /**\n   * Populates object mapping of feature to value used for post ad response\n   * behavior experimentation.  Assumes comma separated, = delimited key/value\n   * pairs.  If key appears more than once, last value wins.\n   * @param {string} input\n   * @private\n   */\n  ;\n\n  _proto.populatePostAdResponseExperimentFeatures_ = function populatePostAdResponseExperimentFeatures_(input) {\n    var _this6 = this;\n\n    input.split(',').forEach(function (line) {\n      if (!line) {\n        return;\n      }\n\n      var parts = line.split('=');\n\n      if (parts.length != 2 || !parts[0]) {\n        (0, _log.dev)().warn(TAG, \"invalid experiment feature \" + line);\n        return;\n      }\n\n      _this6.postAdResponseExperimentFeatures[parts[0]] = parts[1];\n    });\n  }\n  /**\n   * Refreshes ad slot by fetching a new creative and rendering it. This leaves\n   * the current creative displayed until the next one is ready.\n   *\n   * @param {function()} refreshEndCallback When called, this function will\n   *   restart the refresh cycle.\n   * @return {Promise} A promise that resolves when all asynchronous portions of\n   *   the refresh function complete. This is particularly handy for testing.\n   */\n  ;\n\n  _proto.refresh = function refresh(refreshEndCallback) {\n    var _this7 = this;\n\n    (0, _log.devAssert)(!this.isRefreshing);\n    this.isRefreshing = true;\n    this.tearDownSlot();\n    this.initiateAdRequest();\n\n    if (!this.adPromise_) {\n      // For whatever reasons, the adPromise has been nullified, and we will be\n      // unable to proceed. The current creative will continue to be displayed.\n      return Promise.resolve();\n    }\n\n    var promiseId = this.promiseId_;\n    return (0, _log.devAssert)(this.adPromise_).then(function () {\n      if (!_this7.isRefreshing || promiseId != _this7.promiseId_) {\n        // If this refresh cycle was canceled, such as in a no-content\n        // response case, keep showing the old creative.\n        refreshEndCallback();\n        return;\n      }\n\n      return _this7.mutateElement(function () {\n        // Fire an ad-refresh event so that 3rd parties can track when an ad\n        // has changed.\n        (0, _analytics.triggerAnalyticsEvent)(_this7.element, AnalyticsTrigger.AD_REFRESH);\n\n        _this7.togglePlaceholder(true); // This delay provides a 1 second buffer where the ad loader is\n        // displayed in between the creatives.\n\n\n        return _services.Services.timerFor(_this7.win).promise(1000).then(function () {\n          _this7.isRelayoutNeededFlag = true;\n\n          _this7.getResource().layoutCanceled(); // Only Require relayout after page visible\n\n\n          _this7.getAmpDoc().whenNextVisible().then(function () {\n            _services.Services.ownersForDoc(_this7.getAmpDoc()).\n            /*OK*/\n            requireLayout(_this7.element);\n          });\n        });\n      });\n    });\n  }\n  /**\n   * Handles uncaught errors within promise flow.\n   * @param {*} error\n   * @param {boolean=} opt_ignoreStack\n   * @private\n   */\n  ;\n\n  _proto.promiseErrorHandler_ = function promiseErrorHandler_(error, opt_ignoreStack) {\n    if ((0, _error.isCancellation)(error)) {\n      // Rethrow if cancellation.\n      throw error;\n    }\n\n    if (error && error.message) {\n      error = (0, _log.duplicateErrorIfNecessary)(\n      /** @type {!Error} */\n      error);\n    } else {\n      error = new Error('unknown error ' + error);\n    }\n\n    if (opt_ignoreStack) {\n      error.ignoreStack = opt_ignoreStack;\n    } // Add `type` to the message. Ensure to preserve the original stack.\n\n\n    var type = this.element.getAttribute('type') || 'notype';\n\n    if (error.message.indexOf(TAG + \": \" + type + \":\") != 0) {\n      error.message = TAG + \": \" + type + \": \" + error.message;\n    } // Additional arguments.\n\n\n    assignAdUrlToError(\n    /** @type {!Error} */\n    error, this.adUrl_);\n\n    if ((0, _mode.getMode)().development || (0, _mode.getMode)().localDev || (0, _mode.getMode)().log) {\n      (0, _log.user)().error(TAG, error);\n    } else {\n      (0, _log.user)().warn(TAG, error); // Report with 1% sampling as an expected dev error.\n\n      if (Math.random() < 0.01) {\n        (0, _log.dev)().expectedError(TAG, error);\n      }\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.layoutCallback = function layoutCallback() {\n    if (this.isRefreshing) {\n      this.destroyFrame(true);\n    }\n\n    return this.attemptToRenderCreative();\n  }\n  /**\n   * Attemps to render the returned creative following the resolution of the\n   * adPromise.\n   *\n   * @return {!Promise<boolean>|!Promise<undefined>} A promise that resolves\n   *   when the rendering attempt has finished.\n   * @protected\n   */\n  ;\n\n  _proto.attemptToRenderCreative = function attemptToRenderCreative() {\n    var _this8 = this;\n\n    // Promise may be null if element was determined to be invalid for A4A.\n    if (!this.adPromise_) {\n      if (this.shouldInitializePromiseChain_()) {\n        (0, _log.dev)().error(TAG, 'Null promise in layoutCallback');\n      }\n\n      return Promise.resolve();\n    }\n\n    var checkStillCurrent = this.verifyStillCurrent(); // Promise chain will have determined if creative is valid AMP.\n\n    return this.adPromise_.then(function (creativeMetaData) {\n      checkStillCurrent();\n\n      if (_this8.isCollapsed_) {\n        return Promise.resolve();\n      } // If this.iframe already exists, and we're not currently in the middle\n      // of refreshing, bail out here. This should only happen in\n      // testing context, not in production.\n\n\n      if (_this8.iframe && !_this8.isRefreshing) {\n        return Promise.resolve();\n      }\n\n      if (!creativeMetaData) {\n        // Non-AMP creative case, will verify ad url existence.\n        return _this8.renderNonAmpCreative();\n      } // Must be an AMP creative.\n\n\n      return _this8.renderAmpCreative_(creativeMetaData).catch(function (err) {\n        checkStillCurrent(); // Failed to render via AMP creative path so fallback to non-AMP\n        // rendering within cross domain iframe.\n\n        (0, _log.user)().warn(TAG, _this8.element.getAttribute('type'), 'Error injecting creative in friendly frame', err);\n        return _this8.renderNonAmpCreative();\n      });\n    }).catch(function (error) {\n      _this8.promiseErrorHandler_(error);\n\n      throw (0, _error.cancellation)();\n    });\n  }\n  /**\n   * Returns whether or not the ad request may be sent using XHR.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isXhrAllowed = function isXhrAllowed() {\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.attemptChangeSize = function attemptChangeSize(newHeight, newWidth) {\n    // Store original size of slot in order to allow re-expansion on\n    // unlayoutCallback so that it is reverted to original size in case\n    // of resumeCallback.\n    this.originalSlotSize_ = this.originalSlotSize_ || this.getLayoutBox();\n    return _AMP$BaseElement.prototype.attemptChangeSize.call(this, newHeight, newWidth);\n  }\n  /** @override  */\n  ;\n\n  _proto.unlayoutCallback = function unlayoutCallback() {\n    this.tearDownSlot();\n    return true;\n  }\n  /**\n   * Attempts to tear down and set all state variables to initial conditions.\n   * @protected\n   */\n  ;\n\n  _proto.tearDownSlot = function tearDownSlot() {\n    var _this9 = this;\n\n    // Increment promiseId to cause any pending promise to cancel.\n    this.promiseId_++;\n    this.uiHandler.applyUnlayoutUI();\n\n    if (this.originalSlotSize_) {\n      _AMP$BaseElement.prototype.attemptChangeSize.call(this, this.originalSlotSize_.height, this.originalSlotSize_.width).then(function () {\n        _this9.originalSlotSize_ = null;\n      }).catch(function (err) {\n        // TODO(keithwrightbos): if we are unable to revert size, on next\n        // trigger of promise chain the ad request may fail due to invalid\n        // slot size.  Determine how to handle this case.\n        (0, _log.dev)().warn(TAG, 'unable to revert to original size', err);\n      });\n    }\n\n    this.isCollapsed_ = false; // Remove rendering frame, if it exists.\n\n    this.destroyFrame();\n    this.adPromise_ = null;\n    this.adUrl_ = null;\n    this.creativeBody_ = null;\n    this.isVerifiedAmpCreative_ = false;\n    this.fromResumeCallback = false;\n    this.experimentalNonAmpCreativeRenderMethod_ = this.getNonAmpCreativeRenderingMethod();\n    this.postAdResponseExperimentFeatures = {};\n  }\n  /** @override */\n  ;\n\n  _proto.detachedCallback = function detachedCallback() {\n    _AMP$BaseElement.prototype.detachedCallback.call(this);\n\n    this.destroyFrame(true);\n  }\n  /**\n   * Attempts to remove the current frame and free any associated resources.\n   * This function will no-op if this ad slot is currently in the process of\n   * being refreshed.\n   *\n   * @param {boolean=} force Forces the removal of the frame, even if\n   *   this.isRefreshing is true.\n   * @protected\n   */\n  ;\n\n  _proto.destroyFrame = function destroyFrame(force) {\n    if (force === void 0) {\n      force = false;\n    }\n\n    if (!force && this.isRefreshing) {\n      return;\n    } // Allow embed to release its resources.\n\n\n    if (this.friendlyIframeEmbed_) {\n      this.friendlyIframeEmbed_.destroy();\n      this.friendlyIframeEmbed_ = null;\n    }\n\n    if (this.iframe && this.iframe.parentElement) {\n      this.iframe.parentElement.removeChild(this.iframe);\n      this.iframe = null;\n    }\n\n    if (this.xOriginIframeHandler_) {\n      this.xOriginIframeHandler_.freeXOriginIframe();\n      this.xOriginIframeHandler_ = null;\n    }\n  }\n  /** @override  */\n  ;\n\n  _proto.viewportCallback = function viewportCallback(inViewport) {\n    if (this.friendlyIframeEmbed_) {\n      (0, _friendlyIframeEmbed.setFriendlyIframeEmbedVisible)(this.friendlyIframeEmbed_, inViewport);\n    }\n\n    if (this.xOriginIframeHandler_) {\n      this.xOriginIframeHandler_.viewportCallback(inViewport);\n    }\n  }\n  /**\n   * Gets the Ad URL to send an XHR Request to.  To be implemented\n   * by network.\n   * @param {?CONSENT_POLICY_STATE} unusedConsentState\n   * @param {Promise<!Array<rtcResponseDef>>=} opt_rtcResponsesPromise\n   * @return {!Promise<string>|string}\n   */\n  ;\n\n  _proto.getAdUrl = function getAdUrl(unusedConsentState, opt_rtcResponsesPromise) {\n    throw new Error('getAdUrl not implemented!');\n  }\n  /**\n   * Resets ad url state to null, used to prevent frame get fallback if error\n   * is thrown after url construction but prior to layoutCallback.\n   */\n  ;\n\n  _proto.resetAdUrl = function resetAdUrl() {\n    this.adUrl_ = null;\n  }\n  /**\n   * @return {function()} function that when called will verify if current\n   *    ad retrieval is current (meaning unlayoutCallback was not executed).\n   *    If not, will throw cancellation exception;\n   * @throws {Error}\n   */\n  ;\n\n  _proto.verifyStillCurrent = function verifyStillCurrent() {\n    var _this10 = this;\n\n    var promiseId = this.promiseId_;\n    return function () {\n      if (promiseId != _this10.promiseId_) {\n        throw (0, _error.cancellation)();\n      }\n    };\n  }\n  /**\n   * Determine the desired size of the creative based on the HTTP response\n   * headers. Must be less than or equal to the original size of the ad slot\n   * along each dimension. May be overridden by network.\n   *\n   * @param {!Headers} responseHeaders\n   * @return {?SizeInfoDef}\n   */\n  ;\n\n  _proto.extractSize = function extractSize(responseHeaders) {\n    var headerValue = responseHeaders.get(CREATIVE_SIZE_HEADER);\n\n    if (!headerValue) {\n      return null;\n    }\n\n    var match = /^([0-9]+)x([0-9]+)$/.exec(headerValue);\n\n    if (!match) {\n      // TODO(@taymonbeal, #9274): replace this with real error reporting\n      (0, _log.user)().error(TAG, \"Invalid size header: \" + headerValue);\n      return null;\n    }\n\n    return (\n      /** @type {?SizeInfoDef} */\n      {\n        width: Number(match[1]),\n        height: Number(match[2])\n      }\n    );\n  }\n  /**\n   * Forces the UI Handler to collapse this slot.\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.forceCollapse = function forceCollapse() {\n    if (this.isRefreshing) {\n      // If, for whatever reason, the new creative would collapse this slot,\n      // stick with the old creative until the next refresh cycle.\n      this.isRefreshing = false;\n      return;\n    }\n\n    (0, _log.devAssert)(this.uiHandler); // Store original size to allow for reverting on unlayoutCallback so that\n    // subsequent pageview allows for ad request.\n\n    this.originalSlotSize_ = this.originalSlotSize_ || this.getLayoutBox();\n    this.uiHandler.applyNoContentUI();\n    this.isCollapsed_ = true;\n  }\n  /**\n   * Callback executed when creative has successfully rendered within the\n   * publisher page but prior to load (or ini-load for friendly frame AMP\n   * creative render).  To be overridden by network implementations as needed.\n   *\n   * @param {?CreativeMetaDataDef} creativeMetaData metadata if AMP creative,\n   *    null otherwise.\n   * @param {!Promise=} opt_onLoadPromise Promise that resolves when the FIE's\n   *    child window fires the `onload` event.\n   */\n  ;\n\n  _proto.onCreativeRender = function onCreativeRender(creativeMetaData, opt_onLoadPromise) {\n    this.maybeTriggerAnalyticsEvent_(creativeMetaData ? 'renderFriendlyEnd' : 'renderCrossDomainEnd');\n  }\n  /**\n   * @param {!Element} iframe that was just created.  To be overridden for\n   * testing.\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.onCrossDomainIframeCreated = function onCrossDomainIframeCreated(iframe) {\n    (0, _log.dev)().info(TAG, this.element.getAttribute('type'), \"onCrossDomainIframeCreated \" + iframe);\n  }\n  /** @return {boolean} whether html creatives should be sandboxed. */\n  ;\n\n  _proto.sandboxHTMLCreativeFrame = function sandboxHTMLCreativeFrame() {\n    return true;\n  }\n  /**\n   * Send ad request, extract the creative and signature from the response.\n   * @param {string} adUrl Request URL to send XHR to.\n   * @return {!Promise<?Response>}\n   * @protected\n   */\n  ;\n\n  _proto.sendXhrRequest = function sendXhrRequest(adUrl) {\n    var _this11 = this;\n\n    this.maybeTriggerAnalyticsEvent_('adRequestStart');\n    var xhrInit = {\n      mode: 'cors',\n      method: 'GET',\n      credentials: 'include'\n    };\n    return _services.Services.xhrFor(this.win).fetch(adUrl, xhrInit).catch(function (error) {\n      if (error.response && error.response.status > 200) {\n        // Invalid server response code so we should collapse.\n        return null;\n      } // If an error occurs, let the ad be rendered via iframe after delay.\n      // TODO(taymonbeal): Figure out a more sophisticated test for deciding\n      // whether to retry with an iframe after an ad request failure or just\n      // give up and render the fallback content (or collapse the ad slot).\n\n\n      var networkFailureHandlerResult = _this11.onNetworkFailure(error,\n      /** @type {string} */\n      _this11.adUrl_);\n\n      (0, _log.devAssert)(!!networkFailureHandlerResult);\n\n      if (networkFailureHandlerResult.frameGetDisabled) {\n        // Reset adUrl to null which will cause layoutCallback to not\n        // fetch via frame GET.\n        (0, _log.dev)().info(TAG, 'frame get disabled as part of network failure handler');\n\n        _this11.resetAdUrl();\n      } else {\n        _this11.adUrl_ = networkFailureHandlerResult.adUrl || _this11.adUrl_;\n        return Promise.reject(NETWORK_FAILURE);\n      }\n\n      return null;\n    });\n  }\n  /**\n   * Called on network failure sending XHR CORS ad request allowing for\n   * modification of ad url and prevent frame GET request on layoutCallback.\n   * By default, GET frame request will be executed with same ad URL as used\n   * for XHR CORS request.\n   * @param {*} unusedError from network failure\n   * @param {string} unusedAdUrl used for network request\n   * @return {!{adUrl: (string|undefined), frameGetDisabled: (boolean|undefined)}}\n   */\n  ;\n\n  _proto.onNetworkFailure = function onNetworkFailure(unusedError, unusedAdUrl) {\n    return {};\n  }\n  /**\n   * To be overridden by network specific implementation indicating which\n   * signing service(s) is to be used.\n   * @return {!Array<string>} A list of signing services.\n   */\n  ;\n\n  _proto.getSigningServiceNames = function getSigningServiceNames() {\n    return (0, _mode.getMode)().localDev ? ['google', 'google-dev'] : ['google'];\n  }\n  /**\n   * Render non-AMP creative within cross domain iframe.\n   * @param {boolean=} throttleApplied Whether incrementLoadingAds has already\n   *    been called\n   * @return {Promise<boolean>} Whether the creative was successfully rendered.\n   */\n  ;\n\n  _proto.renderNonAmpCreative = function renderNonAmpCreative(throttleApplied) {\n    var _this12 = this;\n\n    if (this.element.getAttribute('disable3pfallback') == 'true') {\n      (0, _log.user)().warn(TAG, this.element.getAttribute('type'), 'fallback to 3p disabled');\n      return Promise.resolve(false);\n    } // TODO(keithwrightbos): remove when no longer needed.\n\n\n    (0, _log.dev)().warn(TAG, 'fallback to 3p'); // Haven't rendered yet, so try rendering via one of our\n    // cross-domain iframe solutions.\n\n    var method = this.experimentalNonAmpCreativeRenderMethod_;\n    var renderPromise = Promise.resolve(false);\n\n    if ((method == XORIGIN_MODE.SAFEFRAME || method == XORIGIN_MODE.NAMEFRAME) && this.creativeBody_) {\n      renderPromise = this.renderViaNameAttrOfXOriginIframe_(this.creativeBody_);\n      this.creativeBody_ = null; // Free resources.\n    } else if (this.adUrl_) {\n      (0, _url.assertHttpsUrl)(this.adUrl_, this.element);\n      renderPromise = this.renderViaIframeGet_(this.adUrl_);\n    } else {\n      // Ad URL may not exist if buildAdUrl throws error or returns empty.\n      // If error occurred, it would have already been reported but let's\n      // report to user in case of empty.\n      (0, _log.user)().warn(TAG, this.element.getAttribute('type'), \"No creative or URL available -- A4A can't render any ad\");\n    }\n\n    if (!throttleApplied && !this.inNonAmpPreferenceExp()) {\n      (0, _concurrentLoad.incrementLoadingAds)(this.win, renderPromise);\n    }\n\n    return renderPromise.then(function (result) {\n      _this12.maybeTriggerAnalyticsEvent_('crossDomainIframeLoaded'); // Pass on the result to the next value in the promise change.\n\n\n      return result;\n    });\n  }\n  /**\n   * Render a validated AMP creative directly in the parent page.\n   * @param {!CreativeMetaDataDef} creativeMetaData Metadata required to render\n   *     AMP creative.\n   * @return {!Promise} Whether the creative was successfully rendered.\n   * @private\n   */\n  ;\n\n  _proto.renderAmpCreative_ = function renderAmpCreative_(creativeMetaData) {\n    var _this13 = this;\n\n    (0, _log.devAssert)(creativeMetaData.minifiedCreative, 'missing minified creative');\n    (0, _log.devAssert)(!!this.element.ownerDocument, 'missing owner document?!');\n    this.maybeTriggerAnalyticsEvent_('renderFriendlyStart'); // Create and setup friendly iframe.\n\n    this.iframe =\n    /** @type {!HTMLIFrameElement} */\n    (0, _dom.createElementWithAttributes)(\n    /** @type {!Document} */\n    this.element.ownerDocument, 'iframe', (0, _object.dict)({\n      // NOTE: It is possible for either width or height to be 'auto',\n      // a non-numeric value.\n      'height': this.creativeSize_.height,\n      'width': this.creativeSize_.width,\n      'frameborder': '0',\n      'allowfullscreen': '',\n      'allowtransparency': '',\n      'scrolling': 'no'\n    }));\n    this.applyFillContent(this.iframe);\n    var fontsArray = [];\n\n    if (creativeMetaData.customStylesheets) {\n      creativeMetaData.customStylesheets.forEach(function (s) {\n        var href = s['href'];\n\n        if (href) {\n          fontsArray.push(href);\n        }\n      });\n    }\n\n    var checkStillCurrent = this.verifyStillCurrent();\n    return (0, _friendlyIframeEmbed.installFriendlyIframeEmbed)(this.iframe, this.element, {\n      host: this.element,\n      // Need to guarantee that this is no longer null\n      url:\n      /** @type {string} */\n      this.adUrl_,\n      html: creativeMetaData.minifiedCreative,\n      extensionIds: creativeMetaData.customElementExtensions || [],\n      fonts: fontsArray\n    }, function (embedWin, ampdoc) {\n      var parentAmpdoc = _this13.getAmpDoc();\n\n      (0, _urlReplacementsImpl.installUrlReplacementsForEmbed)( // TODO(#22733): Cleanup `parentAmpdoc` once ampdoc-fie is launched.\n      ampdoc || parentAmpdoc, embedWin, new _a4aVariableSource.A4AVariableSource(parentAmpdoc, embedWin));\n    }).then(function (friendlyIframeEmbed) {\n      checkStillCurrent();\n      _this13.friendlyIframeEmbed_ = friendlyIframeEmbed;\n      (0, _friendlyIframeEmbed.setFriendlyIframeEmbedVisible)(friendlyIframeEmbed, _this13.isInViewport()); // Ensure visibility hidden has been removed (set by boilerplate).\n\n      var frameDoc = friendlyIframeEmbed.iframe.contentDocument || friendlyIframeEmbed.win.document;\n      (0, _style.setStyle)(frameDoc.body, 'visibility', 'visible');\n      protectFunctionWrapper(_this13.onCreativeRender, _this13, function (err) {\n        (0, _log.dev)().error(TAG, _this13.element.getAttribute('type'), 'Error executing onCreativeRender', err);\n      })(creativeMetaData, friendlyIframeEmbed.whenWindowLoaded());\n      friendlyIframeEmbed.whenIniLoaded().then(function () {\n        checkStillCurrent();\n\n        _this13.maybeTriggerAnalyticsEvent_('friendlyIframeIniLoad');\n      }); // There's no need to wait for all resources to load.\n      // StartRender is enough\n    });\n  }\n  /**\n   * Shared functionality for cross-domain iframe-based rendering methods.\n   * @param {!JsonObject<string, string>} attributes The attributes of the iframe.\n   * @return {!Promise} awaiting load event for ad frame\n   * @private\n   */\n  ;\n\n  _proto.iframeRenderHelper_ = function iframeRenderHelper_(attributes) {\n    var _this14 = this;\n\n    var mergedAttributes = Object.assign(attributes, (0, _object.dict)({\n      'height': this.creativeSize_.height,\n      'width': this.creativeSize_.width\n    }));\n\n    if (this.sentinel) {\n      mergedAttributes['data-amp-3p-sentinel'] = this.sentinel;\n    } // Block synchronous XHR in ad. These are very rare, but super bad for UX\n    // as they block the UI thread for the arbitrary amount of time until the\n    // request completes.\n\n\n    mergedAttributes['allow'] = \"sync-xhr 'none';\";\n    this.iframe =\n    /** @type {!HTMLIFrameElement} */\n    (0, _dom.createElementWithAttributes)(\n    /** @type {!Document} */\n    this.element.ownerDocument, 'iframe',\n    /** @type {!JsonObject} */\n    Object.assign(mergedAttributes, SHARED_IFRAME_PROPERTIES));\n\n    if (this.sandboxHTMLCreativeFrame()) {\n      (0, _pFrame.applySandbox)(this.iframe);\n    } // TODO(keithwrightbos): noContentCallback?\n\n\n    this.xOriginIframeHandler_ = new AMP.AmpAdXOriginIframeHandler(this); // Iframe is appended to element as part of xorigin frame handler init.\n    // Executive onCreativeRender after init to ensure it can get reference\n    // to frame but prior to load to allow for earlier access.\n\n    var frameLoadPromise = this.xOriginIframeHandler_.init(this.iframe,\n    /* opt_isA4A */\n    true, this.letCreativeTriggerRenderStart());\n    protectFunctionWrapper(this.onCreativeRender, this, function (err) {\n      (0, _log.dev)().error(TAG, _this14.element.getAttribute('type'), 'Error executing onCreativeRender', err);\n    })(null);\n    return frameLoadPromise;\n  }\n  /**\n   * Creates iframe whose src matches that of the ad URL. For standard\n   * Fast Fetch running on the AMP cdn, an XHR request will typically have\n   * already been sent to the same adUrl, and the response should\n   * have been cached causing the browser to render without callout.  However,\n   * it is possible for cache miss to occur which can be detected server-side\n   * by missing ORIGIN header.\n   *\n   * Additionally, this method is also used in certain cases to send the only\n   * request, i.e. the initial XHR is skipped.\n   *\n   * Note: As of 2016-10-18, the fill-from-cache assumption appears to fail on\n   * Safari-on-iOS, which issues a fresh network request, even though the\n   * content is already in cache.\n   *\n   * @param {string} adUrl  Ad request URL, as sent to #sendXhrRequest (i.e.,\n   *    before any modifications that XHR module does to it.)\n   * @return {!Promise} awaiting ad completed insertion.\n   * @private\n   */\n  ;\n\n  _proto.renderViaIframeGet_ = function renderViaIframeGet_(adUrl) {\n    this.maybeTriggerAnalyticsEvent_('renderCrossDomainStart');\n    return this.iframeRenderHelper_((0, _object.dict)({\n      'src': _services.Services.xhrFor(this.win).getCorsUrl(this.win, adUrl),\n      'name': JSON.stringify((0, _iframeAttributes.getContextMetadata)(this.win, this.element, this.sentinel))\n    }));\n  }\n  /**\n   * Whether AMP Ad Xorigin Iframe handler should wait for the creative to\n   * call render-start, rather than triggering it itself. Example use case\n   * is that amp-sticky-ad should trigger render-start itself so that the\n   * sticky container isn't shown before an ad is ready.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.letCreativeTriggerRenderStart = function letCreativeTriggerRenderStart() {\n    return false;\n  }\n  /**\n   * Render the creative via some \"cross domain iframe that accepts the creative\n   * in the name attribute\".  This could be SafeFrame or the AMP-native\n   * NameFrame.\n   *\n   * @param {!ArrayBuffer} creativeBody\n   * @return {!Promise} awaiting load event for ad frame\n   * @private\n   */\n  ;\n\n  _proto.renderViaNameAttrOfXOriginIframe_ = function renderViaNameAttrOfXOriginIframe_(creativeBody) {\n    var _this15 = this;\n\n    /** @type {?string} */\n    var method = this.experimentalNonAmpCreativeRenderMethod_;\n    (0, _log.devAssert)(method == XORIGIN_MODE.SAFEFRAME || method == XORIGIN_MODE.NAMEFRAME, 'Unrecognized A4A cross-domain rendering mode: %s', method);\n    this.maybeTriggerAnalyticsEvent_('renderSafeFrameStart');\n    var checkStillCurrent = this.verifyStillCurrent();\n    return (0, _promise.tryResolve)(function () {\n      return (0, _bytes.utf8Decode)(creativeBody);\n    }).then(function (creative) {\n      checkStillCurrent();\n      var srcPath;\n      var name = '';\n\n      switch (method) {\n        case XORIGIN_MODE.SAFEFRAME:\n          srcPath = _this15.getSafeframePath() + '?n=0';\n          break;\n\n        case XORIGIN_MODE.NAMEFRAME:\n          srcPath = (0, _pFrame.getDefaultBootstrapBaseUrl)(_this15.win, 'nameframe'); // Name will be set for real below in nameframe case.\n\n          break;\n\n        default:\n          // Shouldn't be able to get here, but...  Because of the assert,\n          // above, we can only get here in non-dev mode, so give user feedback.\n          (0, _log.user)().error('A4A', 'A4A received unrecognized cross-domain name' + ' attribute iframe rendering mode request: %s.  Unable to' + ' render a creative for' + ' slot %s.', method, _this15.element.getAttribute('id'));\n          return Promise.reject('Unrecognized rendering mode request');\n      } // TODO(bradfrizzell): change name of function and var\n\n\n      var contextMetadata = (0, _iframeAttributes.getContextMetadata)(_this15.win, _this15.element, _this15.sentinel, _this15.getAdditionalContextMetadata(method == XORIGIN_MODE.SAFEFRAME)); // TODO(bradfrizzell) Clean up name assigning.\n\n      if (method == XORIGIN_MODE.NAMEFRAME) {\n        contextMetadata['creative'] = creative;\n        name = JSON.stringify(contextMetadata);\n      } else if (method == XORIGIN_MODE.SAFEFRAME) {\n        contextMetadata = JSON.stringify(contextMetadata);\n        name = _this15.safeframeVersion + \";\" + creative.length + \";\" + creative + (\"\" + contextMetadata);\n      }\n\n      return _this15.iframeRenderHelper_((0, _object.dict)({\n        'src': srcPath,\n        'name': name\n      }));\n    });\n  }\n  /**\n   *\n   * Throws {@code SyntaxError} if the metadata block delimiters are missing\n   * or corrupted or if the metadata content doesn't parse as JSON.\n   * @param {string} creative from which CSS is extracted\n   * @return {?CreativeMetaDataDef} Object result of parsing JSON data blob inside\n   *     the metadata markers on the ad text, or null if no metadata markers are\n   *     found.\n   * TODO(keithwrightbos@): report error cases\n   */\n  ;\n\n  _proto.getAmpAdMetadata = function getAmpAdMetadata(creative) {\n    var metadataStart = -1;\n    var metadataString;\n\n    for (var i = 0; i < METADATA_STRINGS.length; i++) {\n      metadataString = METADATA_STRINGS[i];\n      metadataStart = creative.lastIndexOf(metadataString);\n\n      if (metadataStart >= 0) {\n        break;\n      }\n    }\n\n    if (metadataStart < 0) {\n      // Couldn't find a metadata blob.\n      (0, _log.dev)().warn(TAG, this.element.getAttribute('type'), 'Could not locate start index for amp meta data in: %s', creative);\n      return null;\n    }\n\n    var metadataEnd = creative.lastIndexOf('</script>');\n\n    if (metadataEnd < 0) {\n      // Couldn't find a metadata blob.\n      (0, _log.dev)().warn(TAG, this.element.getAttribute('type'), 'Could not locate closing script tag for amp meta data in: %s', creative);\n      return null;\n    }\n\n    try {\n      var metaDataObj = (0, _json.parseJson)(creative.slice(metadataStart + metadataString.length, metadataEnd));\n      var ampRuntimeUtf16CharOffsets = metaDataObj['ampRuntimeUtf16CharOffsets'];\n\n      if (!(0, _types.isArray)(ampRuntimeUtf16CharOffsets) || ampRuntimeUtf16CharOffsets.length != 2 || typeof ampRuntimeUtf16CharOffsets[0] !== 'number' || typeof ampRuntimeUtf16CharOffsets[1] !== 'number') {\n        throw new Error('Invalid runtime offsets');\n      }\n\n      var metaData = {};\n\n      if (metaDataObj['customElementExtensions']) {\n        metaData.customElementExtensions = metaDataObj['customElementExtensions'];\n\n        if (!(0, _types.isArray)(metaData.customElementExtensions)) {\n          throw new Error('Invalid extensions', metaData.customElementExtensions);\n        }\n      } else {\n        metaData.customElementExtensions = [];\n      }\n\n      if (metaDataObj['customStylesheets']) {\n        // Expect array of objects with at least one key being 'href' whose\n        // value is URL.\n        metaData.customStylesheets = metaDataObj['customStylesheets'];\n        var errorMsg = 'Invalid custom stylesheets';\n\n        if (!(0, _types.isArray)(metaData.customStylesheets)) {\n          throw new Error(errorMsg);\n        }\n\n        var urls = _services.Services.urlForDoc(this.element);\n\n        metaData.customStylesheets.forEach(function (stylesheet) {\n          if (!(0, _types.isObject)(stylesheet) || !stylesheet['href'] || typeof stylesheet['href'] !== 'string' || !urls.isSecure(stylesheet['href'])) {\n            throw new Error(errorMsg);\n          }\n        });\n      }\n\n      if ((0, _types.isArray)(metaDataObj['images'])) {\n        // Load maximum of 5 images.\n        metaData.images = metaDataObj['images'].splice(0, 5);\n      }\n\n      if (this.isSinglePageStoryAd) {\n        // CTA Type is a required meta tag. CTA Url can come from meta tag, or\n        // (temporarily) amp-ad-exit config.\n        // TODO(#24080): maybe rerequire cta url?\n        if (!metaDataObj['ctaType']) {\n          throw new Error(INVALID_SPSA_RESPONSE);\n        }\n\n        this.element.setAttribute('data-vars-ctatype', metaDataObj['ctaType']);\n        this.element.setAttribute('data-vars-ctaurl', metaDataObj['ctaUrl']);\n      } // TODO(keithwrightbos): OK to assume ampRuntimeUtf16CharOffsets is before\n      // metadata as its in the head?\n\n\n      metaData.minifiedCreative = creative.slice(0, ampRuntimeUtf16CharOffsets[0]) + creative.slice(ampRuntimeUtf16CharOffsets[1], metadataStart) + creative.slice(metadataEnd + '</script>'.length);\n      return metaData;\n    } catch (err) {\n      (0, _log.dev)().warn(TAG, this.element.getAttribute('type'), 'Invalid amp metadata: %s', creative.slice(metadataStart + metadataString.length, metadataEnd));\n\n      if (this.isSinglePageStoryAd) {\n        throw err;\n      }\n\n      return null;\n    }\n  }\n  /**\n   * @return {string} full url to safeframe implementation.\n   */\n  ;\n\n  _proto.getSafeframePath = function getSafeframePath() {\n    return 'https://tpc.googlesyndication.com/safeframe/' + (this.safeframeVersion + \"/html/container.html\");\n  }\n  /**\n   * Checks if the given lifecycle event has a corresponding amp-analytics event\n   * and fires the analytics trigger if so.\n   * @param {string} lifecycleStage\n   * @private\n   */\n  ;\n\n  _proto.maybeTriggerAnalyticsEvent_ = function maybeTriggerAnalyticsEvent_(lifecycleStage) {\n    if (!this.a4aAnalyticsConfig_) {\n      // No config exists that will listen to this event.\n      return;\n    }\n\n    var analyticsEvent = (0, _log.devAssert)(LIFECYCLE_STAGE_TO_ANALYTICS_TRIGGER[lifecycleStage]);\n    var analyticsVars =\n    /** @type {!JsonObject} */\n    Object.assign((0, _object.dict)({\n      'time': Math.round(this.getNow_())\n    }), this.getA4aAnalyticsVars(analyticsEvent));\n    (0, _analytics.triggerAnalyticsEvent)(this.element, analyticsEvent, analyticsVars);\n  }\n  /**\n   * Returns variables to be included on an analytics event. This can be\n   * overridden by specific network implementations.\n   * Note that this function is called for each time an analytics event is\n   * fired.\n   * @param {string} unusedAnalyticsEvent The name of the analytics event.\n   * @return {!JsonObject}\n   */\n  ;\n\n  _proto.getA4aAnalyticsVars = function getA4aAnalyticsVars(unusedAnalyticsEvent) {\n    return (0, _object.dict)({});\n  }\n  /**\n   * Returns network-specific config for amp-analytics. It should overridden\n   * with network-specific configurations.\n   * This function may return null. If so, no amp-analytics element will be\n   * added to this A4A element and no A4A triggers will be fired.\n   * @return {?JsonObject}\n   */\n  ;\n\n  _proto.getA4aAnalyticsConfig = function getA4aAnalyticsConfig() {\n    return null;\n  }\n  /**\n   * Attempts to execute Real Time Config, if the ad network has enabled it.\n   * If it is not supported by the network, but the publisher has included\n   * the rtc-config attribute on the amp-ad element, warn.\n   * @param {?CONSENT_POLICY_STATE} consentState\n   * @param {?string} consentString\n   * @return {Promise<!Array<!rtcResponseDef>>|undefined}\n   */\n  ;\n\n  _proto.tryExecuteRealTimeConfig_ = function tryExecuteRealTimeConfig_(consentState, consentString) {\n    if (!!AMP.RealTimeConfigManager) {\n      try {\n        return new AMP.RealTimeConfigManager(this).maybeExecuteRealTimeConfig(this.getCustomRealTimeConfigMacros_(), consentState, consentString);\n      } catch (err) {\n        (0, _log.user)().error(TAG, 'Could not perform Real Time Config.', err);\n      }\n    } else if (this.element.getAttribute('rtc-config')) {\n      (0, _log.user)().error(TAG, 'RTC not supported for ad network ' + (\"\" + this.element.getAttribute('type')));\n    }\n  }\n  /**\n   * To be overriden by network impl. Should return a mapping of macro keys\n   * to values for substitution in publisher-specified URLs for RTC.\n   * @return {!Object<string,\n   *   !../../../src/service/variable-source.AsyncResolverDef>}\n   */\n  ;\n\n  _proto.getCustomRealTimeConfigMacros_ = function getCustomRealTimeConfigMacros_() {\n    return {};\n  }\n  /**\n   * Whether preferential render should still be utilized if web crypto is\n   * unavailable, and crypto signature header is present.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.shouldPreferentialRenderWithoutCrypto = function shouldPreferentialRenderWithoutCrypto() {\n    return false;\n  }\n  /**\n   * @param {string=} headerValue Method as given in header.\n   * @return {?XORIGIN_MODE}\n   */\n  ;\n\n  _proto.getNonAmpCreativeRenderingMethod = function getNonAmpCreativeRenderingMethod(headerValue) {\n    if (headerValue) {\n      if (!(0, _types.isEnumValue)(XORIGIN_MODE, headerValue)) {\n        (0, _log.dev)().error('AMP-A4A', \"cross-origin render mode header \" + headerValue);\n      } else {\n        return (\n          /** @type {XORIGIN_MODE} */\n          headerValue\n        );\n      }\n    }\n\n    return _services.Services.platformFor(this.win).isIos() ? XORIGIN_MODE.NAMEFRAME : null;\n  }\n  /**\n   * Returns base object that will be written to cross-domain iframe name\n   * attribute.\n   * @param {boolean=} opt_isSafeframe Whether creative is rendering into\n   *   a safeframe.\n   * @return {!JsonObject|undefined}\n   */\n  ;\n\n  _proto.getAdditionalContextMetadata = function getAdditionalContextMetadata(opt_isSafeframe) {}\n  /**\n   * Returns whether the received creative is verified AMP.\n   * @return {boolean} True if the creative is verified AMP, false otherwise.\n   */\n  ;\n\n  _proto.isVerifiedAmpCreative = function isVerifiedAmpCreative() {\n    return this.isVerifiedAmpCreative_;\n  }\n  /**\n   * Adds single pass experiment IDs if the javascript binary has\n   * \"singlePassType\" mode.\n   */\n  ;\n\n  _proto.maybeAddSinglePassExperiment = function maybeAddSinglePassExperiment() {\n    var type = (0, _mode.getMode)().singlePassType;\n\n    if (type === 'sp') {\n      (0, _trafficExperiments.addExperimentIdToElement)(_trafficExperiments.SINGLE_PASS_EXPERIMENT_IDS.SINGLE_PASS, this.element);\n    } else if (type === 'mp') {\n      (0, _trafficExperiments.addExperimentIdToElement)(_trafficExperiments.SINGLE_PASS_EXPERIMENT_IDS.MULTI_PASS, this.element);\n    }\n  };\n\n  return AmpA4A;\n}(AMP.BaseElement);\n/**\n * Attachs query string portion of ad url to error.\n * @param {!Error} error\n * @param {?string} adUrl\n */\n\n\nexports.AmpA4A = AmpA4A;\n\nfunction assignAdUrlToError(error, adUrl) {\n  if (!adUrl || error.args && error.args['au']) {\n    return;\n  }\n\n  var adQueryIdx = adUrl.indexOf('?');\n\n  if (adQueryIdx == -1) {\n    return;\n  }\n\n  (error.args || (error.args = {}))['au'] = adUrl.substring(adQueryIdx + 1, adQueryIdx + 251);\n}\n/**\n * Returns the signature verifier for the given window. Lazily creates it if it\n * doesn't already exist.\n *\n * This ensures that only one signature verifier exists per window, which allows\n * multiple Fast Fetch ad slots on a page (even ones from different ad networks)\n * to share the same cached public keys.\n *\n * @param {!Window} win\n * @return {!SignatureVerifier}\n * @visibleForTesting\n */\n\n\nfunction signatureVerifierFor(win) {\n  var propertyName = 'AMP_FAST_FETCH_SIGNATURE_VERIFIER_';\n  return win[propertyName] || (win[propertyName] = new _signatureVerifier.SignatureVerifier(win, _a4aConfig.signingServerURLs));\n}\n\n},{\"../../../ads/_a4a-config\":1,\"../../../ads/google/a4a/traffic-experiments\":4,\"../../../src/3p-frame\":22,\"../../../src/ad-helper\":25,\"../../../src/analytics\":27,\"../../../src/consent\":34,\"../../../src/consent-state\":33,\"../../../src/dom\":41,\"../../../src/error\":44,\"../../../src/extension-analytics\":49,\"../../../src/friendly-iframe-embed\":54,\"../../../src/iframe-attributes\":56,\"../../../src/json\":63,\"../../../src/layout\":66,\"../../../src/log\":68,\"../../../src/mode\":70,\"../../../src/service/url-replacements-impl\":111,\"../../../src/services\":123,\"../../../src/style\":128,\"../../../src/types\":131,\"../../../src/url\":134,\"../../../src/utils/bytes\":137,\"../../../src/utils/object\":145,\"../../../src/utils/promise\":147,\"../../amp-ad/0.1/concurrent-load\":20,\"./a4a-variable-source\":11,\"./signature-verifier\":13}],13:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.SignatureVerifier = exports.VerificationStatus = exports.AMP_SIGNATURE_HEADER = void 0;\n\nvar _services = require(\"../../../src/services\");\n\nvar _base = require(\"../../../src/utils/base64\");\n\nvar _log = require(\"../../../src/log\");\n\nvar _types = require(\"../../../src/types\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @visibleForTesting */\nvar AMP_SIGNATURE_HEADER = 'AMP-Fast-Fetch-Signature';\n/**\n * The result of an attempt to verify a Fast Fetch signature. The different\n * error statuses are used for reporting errors to the ad network.\n *\n * @enum {number}\n */\n\nexports.AMP_SIGNATURE_HEADER = AMP_SIGNATURE_HEADER;\nvar VerificationStatus = {\n  /** The ad was successfully verified as AMP. */\n  OK: 0,\n\n  /**\n   * Verification failed because of a factor beyond the ad network's control,\n   * such as a network connectivity failure, unavailability of Web Cryptography\n   * in the current browsing context, or a misbehaving signing service.\n   */\n  UNVERIFIED: 1,\n\n  /**\n   * Verification failed because the keypair ID provided by the ad network did\n   * not correspond to any public key offered by the signing service.\n   */\n  ERROR_KEY_NOT_FOUND: 2,\n\n  /**\n   * Verification failed because the signature provided by the ad network was\n   * not the correct cryptographic signature for the given creative data and\n   * public key.\n   */\n  ERROR_SIGNATURE_MISMATCH: 3,\n\n  /**\n   * Verification failed because the page does not have web crypto available,\n   * i.e. is not SSL.\n   */\n  CRYPTO_UNAVAILABLE: 4\n};\n/**\n * A window-level object that encapsulates the logic for obtaining public keys\n * from Fast Fetch signing services and cryptographically verifying signatures\n * of AMP creatives.\n *\n * Unlike an AMP service, a signature verifier is **stateful**. It maintains a\n * cache of all public keys that it has previously downloaded and imported, and\n * also keeps track of which keys and signing services have already had\n * unsuccessful download or import attempts and should not be attempted again.\n *\n * This entire class is currently dead code in production, but will soon be\n * introduced as an experiment.\n */\n\nexports.VerificationStatus = VerificationStatus;\n\nvar SignatureVerifier =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   * @param {!Object<string, string>} signingServerURLs a map from the name of\n   *    each trusted signing service to the URL of its public key endpoint\n   */\n  function SignatureVerifier(win, signingServerURLs) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n    /** @private @const {!Object<string, string>} */\n\n    this.signingServerURLs_ = signingServerURLs;\n    /**\n     * The cache where all the public keys are stored.\n     *\n     * This field has a lot of internal structure and its type's a little hairy,\n     * so here's a rundown of what each piece means:\n     *  - If Web Cryptography isn't available in the current browsing context,\n     *    then the entire field is null. Since the keys are of no use, we don't\n     *    fetch them.\n     *  - Otherwise, it's a map-like `Object` from signing service names (as\n     *    defined in the Fast Fetch config registry) to \"signer\" objects.\n     *  - The `promise` property of each signer resolves to a boolean indicating\n     *    whether the most recent attempt to fetch and import that signing\n     *    service's public keys was successful. If the promise is still pending,\n     *    then an attempt is currently in progress. This property is mutable;\n     *    its value is replaced with a new promise when a new attempt is made.\n     *    Invariant: only one attempt may be in progress at a time, so this\n     *    property may not be mutated while the current promise is pending.\n     *  - The `keys` property of each signer is a map-like `Object` from keypair\n     *    IDs to nullable key promises. (This means that a property access on\n     *    this object may evaluate to `undefined`, `null`, or a `Promise`\n     *    object.) The `keys` object is internally mutable; new keys are added\n     *    to it as they are fetched. Invariant: the `keys` object may be mutated\n     *    only while the corresponding `promise` object is pending; this ensures\n     *    that callbacks chained to `promise` may observe `keys` without being\n     *    subject to race conditions.\n     *  - If a key promise (i.e., the value of a property access on the `keys`\n     *    object) is absent (i.e., `undefined`), then no key with that keypair\n     *    ID is present (but this could be because of a stale cache). If it's\n     *    null, then no key with that keypair ID could be found even after\n     *    cachebusting. If it's a `Promise` that resolves to `null`, then key\n     *    data for that keypair ID was found but could not be imported\n     *    successfully; this most likely indicates signing service misbehavior.\n     *    The success case is a `Promise` that resolves to a `CryptoKey`.\n     *\n     * @private @const {?Object<string, {promise: !Promise<boolean>, keys: !Object<string, ?Promise<?webCrypto.CryptoKey>>}>}\n     */\n\n    this.signers_ = _services.Services.cryptoFor(win).isPkcsAvailable() ? {} : null;\n    /**\n     * Gets a notion of current time, in ms.  The value is not necessarily\n     * absolute, so should be used only for computing deltas.  When available,\n     * the performance system will be used; otherwise Date.now() will be\n     * returned.\n     *\n     * @protected @const {function(): number}\n     */\n\n    this.getNow_ = win.performance && win.performance.now ? win.performance.now.bind(win.performance) : Date.now;\n  }\n  /**\n   * Fetches and imports the public keyset for the named signing service,\n   * without any cachebusting. Hopefully, this will hit cache in many cases\n   * and not make an actual network round-trip. This method should be called\n   * as early as possible, once it's known which signing service is likely to\n   * be used, so that the network request and key imports can execute in\n   * parallel with other operations.\n   *\n   * @param {string} signingServiceName\n   */\n\n\n  var _proto = SignatureVerifier.prototype;\n\n  _proto.loadKeyset = function loadKeyset(signingServiceName) {\n    if (this.signers_ && !this.signers_[signingServiceName]) {\n      var keys = {};\n      var promise = this.fetchAndAddKeys_(keys, signingServiceName, null);\n      this.signers_[signingServiceName] = {\n        promise: promise,\n        keys: keys\n      };\n    }\n  }\n  /**\n   * Extracts a cryptographic signature from `headers` and attempts to verify\n   * that it's the correct cryptographic signature for `creative`.\n   *\n   * As a precondition, `loadKeyset(signingServiceName)` must have already been\n   * called.\n   *\n   * @param {!ArrayBuffer} creative\n   * @param {!Headers} headers\n   * @return {!Promise<!VerificationStatus>}\n   */\n  ;\n\n  _proto.verify = function verify(creative, headers) {\n    var signatureFormat = /^([A-Za-z0-9._-]+):([A-Za-z0-9._-]+):([A-Za-z0-9+/]{341}[AQgw]==)$/;\n\n    if (!headers.has(AMP_SIGNATURE_HEADER)) {\n      return Promise.resolve(VerificationStatus.UNVERIFIED);\n    }\n\n    var headerValue = headers.get(AMP_SIGNATURE_HEADER);\n    var match = signatureFormat.exec(headerValue);\n\n    if (!match) {\n      // TODO(@taymonbeal, #9274): replace this with real error reporting\n      (0, _log.user)().error('AMP-A4A', \"Invalid signature header: \" + headerValue.split(':')[0]);\n      return Promise.resolve(VerificationStatus.ERROR_SIGNATURE_MISMATCH);\n    }\n\n    return this.verifyCreativeAndSignature(match[1], match[2], (0, _base.base64DecodeToBytes)(match[3]), creative);\n  }\n  /**\n   * Verifies that `signature` is the correct cryptographic signature for\n   * `creative`, with the public key from the named signing service identified\n   * by `keypairId`.\n   *\n   * As a precondition, `loadKeyset(signingServiceName)` must have already been\n   * called.\n   *\n   * If the keyset for the named signing service was imported successfully but\n   * did not include a key for `keypairId`, this may be the result of a stale\n   * browser cache. To work around this, `keypairId` is added to the public key\n   * endpoint URL as a query parameter and the keyset is re-fetched. Other kinds\n   * of failures, including network connectivity failures, are not retried.\n   *\n   * @param {string} signingServiceName\n   * @param {string} keypairId\n   * @param {!Uint8Array} signature\n   * @param {!ArrayBuffer} creative\n   * @return {!Promise<!VerificationStatus>}\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.verifyCreativeAndSignature = function verifyCreativeAndSignature(signingServiceName, keypairId, signature, creative) {\n    var _this = this;\n\n    if (!this.signers_) {\n      // Web Cryptography isn't available.\n      return Promise.resolve(VerificationStatus.CRYPTO_UNAVAILABLE);\n    }\n\n    var signer = this.signers_[signingServiceName];\n    (0, _log.devAssert)(signer, 'Keyset for service %s not loaded before verification', signingServiceName);\n    return signer.promise.then(function (success) {\n      if (!success) {\n        // The public keyset couldn't be fetched and imported. Probably a\n        // network connectivity failure.\n        return VerificationStatus.UNVERIFIED;\n      }\n\n      var keyPromise = signer.keys[keypairId];\n\n      if (keyPromise === undefined) {\n        // We don't have this key, but maybe the cache is stale; try\n        // cachebusting.\n        signer.promise = _this.fetchAndAddKeys_(signer.keys, signingServiceName, keypairId).then(function (success) {\n          if (signer.keys[keypairId] === undefined) {\n            // We still don't have this key; make sure we never try\n            // again.\n            signer.keys[keypairId] = null;\n          }\n\n          return success;\n        }); // This \"recursive\" call can recurse at most once.\n\n        return _this.verifyCreativeAndSignature(signingServiceName, keypairId, signature, creative);\n      } else if (keyPromise === null) {\n        // We don't have this key and we already tried cachebusting.\n        return VerificationStatus.ERROR_KEY_NOT_FOUND;\n      } else {\n        return keyPromise.then(function (key) {\n          if (!key) {\n            // This particular public key couldn't be imported. Probably the\n            // signing service's fault.\n            return VerificationStatus.UNVERIFIED;\n          }\n\n          var crypto = _services.Services.cryptoFor(_this.win_);\n\n          return crypto.verifyPkcs(key, signature, creative).then(function (result) {\n            return result ? VerificationStatus.OK : VerificationStatus.ERROR_SIGNATURE_MISMATCH;\n          }, function (err) {\n            // Web Cryptography rejected the verification attempt. This\n            // hopefully won't happen in the wild, but browsers can be weird\n            // about this, so we need to guard against the possibility.\n            // Phone home to the AMP Project so that we can understand why\n            // this occurred.\n            var message = err && err.message;\n            (0, _log.dev)().error('AMP-A4A', \"Failed to verify signature: \" + message);\n            return VerificationStatus.UNVERIFIED;\n          });\n        });\n      }\n    });\n  }\n  /**\n   * Try to download the keyset for the named signing service and add a promise\n   * for each key to the `keys` object.\n   *\n   * @param {!Object<string, ?Promise<?webCrypto.CryptoKey>>} keys the object to\n   *     add each key promise to. This is mutated while the returned promise is\n   *     pending.\n   * @param {string} signingServiceName\n   * @param {?string} keypairId the keypair ID to include in the query string\n   *     for cachebusting purposes, or `null` if no cachebusting is needed\n   * @return {!Promise<boolean>} resolves after the mutation of `keys` is\n   *     complete, to `true` if the keyset was downloaded and parsed\n   *     successfully (even if some keys were malformed), or `false` if a\n   *     keyset-level failure occurred\n   * @private\n   */\n  ;\n\n  _proto.fetchAndAddKeys_ = function fetchAndAddKeys_(keys, signingServiceName, keypairId) {\n    var _this2 = this;\n\n    var url = this.signingServerURLs_[signingServiceName];\n\n    if (keypairId != null) {\n      url += '?kid=' + encodeURIComponent(keypairId);\n    } // TODO(@taymonbeal, #11088): consider a timeout on this fetch\n\n\n    return _services.Services.xhrFor(this.win_).fetchJson(url, {\n      mode: 'cors',\n      method: 'GET',\n      // This should be cached across publisher domains, so don't append\n      // __amp_source_origin to the URL.\n      ampCors: false,\n      credentials: 'omit'\n    }).then(function (response) {\n      // These are assertions on signing service behavior required by\n      // the spec. However, nothing terrible happens if they aren't met\n      // and there's no meaningful error recovery to be done if they\n      // fail, so we don't need to do them at runtime in production.\n      // They're included in dev mode as a debugging aid.\n      (0, _log.devAssert)(response.status === 200, 'Fast Fetch keyset spec requires status code 200');\n      (0, _log.devAssert)(response.headers.get('Content-Type') == 'application/jwk-set+json', 'Fast Fetch keyset spec requires Content-Type: ' + 'application/jwk-set+json');\n      return response.json().then(function (jsonResponse) {\n        var jwkSet =\n        /** @type {!JsonObject} */\n        jsonResponse; // This is supposed to be a JSON Web Key Set, as defined in\n        // Section 5 of RFC 7517. However, the signing service could\n        // misbehave and send an arbitrary JSON value, so we have to\n        // type-check at runtime.\n\n        if (!jwkSet || !(0, _types.isArray)(jwkSet['keys'])) {\n          signingServiceError(signingServiceName, \"Key set (\" + JSON.stringify(jwkSet) + \") has no \\\"keys\\\"\");\n          return false;\n        }\n\n        jwkSet['keys'].forEach(function (jwk) {\n          if (!jwk || typeof jwk['kid'] != 'string') {\n            signingServiceError(signingServiceName, \"Key (\" + JSON.stringify(jwk) + \") has no \\\"kid\\\"\");\n          } else if (keys[jwk['kid']] === undefined) {\n            // We haven't seen this keypair ID before.\n            keys[jwk['kid']] = _services.Services.cryptoFor(_this2.win_).importPkcsKey(jwk).catch(function (err) {\n              // Web Cryptography rejected the key\n              // import attempt. Either the signing\n              // service sent a malformed key or the\n              // browser is doing something weird.\n              var jwkData = JSON.stringify(jwk);\n              var message = err && err.message;\n              signingServiceError(signingServiceName, \"Failed to import key (\" + jwkData + \"): \" + message);\n              return null;\n            });\n          }\n        });\n        return true;\n      }, function (err) {\n        // The signing service didn't send valid JSON.\n        signingServiceError(signingServiceName, \"Failed to parse JSON: \" + (err && err.response));\n        return false;\n      });\n    }, function (err) {\n      // Some kind of error occurred during the XHR. This could be a lot\n      // of things (and we have no type information), but if there's no\n      // `response` it's probably a network connectivity failure, so we\n      // ignore it. Unfortunately, we can't distinguish this from a CORS\n      // problem.\n      if (err && err.response) {\n        // This probably indicates a non-2xx HTTP status code.\n        signingServiceError(signingServiceName, \"Status code \" + err.response.status);\n      }\n\n      return false;\n    });\n  };\n\n  return SignatureVerifier;\n}();\n/**\n * Report an error caused by a signing service. Since signing services currently\n * don't have their own error logging URLs, we just send everything to the AMP\n * Project.\n *\n * @param {string} signingServiceName\n * @param {string} message\n * @private\n */\n\n\nexports.SignatureVerifier = SignatureVerifier;\n\nfunction signingServiceError(signingServiceName, message) {\n  (0, _log.dev)().error('AMP-A4A', \"Signing service error for \" + signingServiceName + \": \" + message);\n}\n\n},{\"../../../src/log\":68,\"../../../src/services\":123,\"../../../src/types\":131,\"../../../src/utils/base64\":136}],14:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.cloudflareIsA4AEnabled = cloudflareIsA4AEnabled;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Determines which tags desire A4A handling\n * @param {!Window} win\n * @param {!Element} element\n * @param {boolean} useRemoteHtml\n * @return {boolean}\n */\nfunction cloudflareIsA4AEnabled(win, element, useRemoteHtml) {\n  // We assume fast fetch for all content, but this will gracefully degrade,\n  // when non-a4a content is delivered\n  return !useRemoteHtml;\n}\n\n},{}],15:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.AmpAdMetadataTransformer = void 0;\n\nvar _object = require(\"../../../src/utils/object\");\n\nvar _json = require(\"../../../src/json\");\n\nvar _log = require(\"../../../src/log\");\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar AmpAdMetadataTransformer =\n/*#__PURE__*/\nfunction () {\n  /** constructor */\n  function AmpAdMetadataTransformer() {\n    /** @public {JsonObject} */\n    this.metadata = (0, _object.dict)({});\n    /** @private {!Array<Object>} */\n\n    this.styles_ = [];\n    /** @private {!Array<Object>} */\n\n    this.extensions_ = [];\n    /** @private {Element} */\n\n    this.firstRuntimeElement_ = null;\n    /** @private {Element} */\n\n    this.lastRuntimeElement_ = null;\n    /** @private {string} */\n\n    this.ctaType_ = '';\n    /** @private {string} */\n\n    this.ctaUrl_ = '';\n    /** @private {!Array<string>} */\n\n    this.jsonMetadata_ = [];\n    /** @private {!Array<Object>} */\n\n    this.imgMetadata_ = [];\n    /** @private {Element} */\n\n    this.ampAnalytics_ = null;\n  }\n  /**\n   * Creates a JSON metadata in which custom stylesheets, extensions\n   * and runtime offsets are recorded. This is used by AMP4ADS at runtime\n   * for embedding an ad into an enclosing document.\n   * Please note: once runtime offsets are computed the document must not\n   * change.\n   *\n   * https://cs.corp.google.com/piper///depot/google3/search/amphtml/transformers/amp_ad_metadata_transformer.cc\n   * @param {Document} doc\n   * @return {string}\n   */\n\n\n  var _proto = AmpAdMetadataTransformer.prototype;\n\n  _proto.generateMetadata = function generateMetadata(doc) {\n    var head = doc.head;\n    this.generateHeadMetadata_(head);\n    this.generateImageMetadata_(doc);\n    this.generateJsonMetadata_(doc); // Creating json object from all of the components\n\n    var creative = doc.documentElement.\n    /*OK*/\n    outerHTML;\n    this.generateRuntimeOffsets_(creative);\n    this.generateJsonOffsets_(creative);\n    this.generateAmpAnalyticsOffsets_(doc, creative);\n    this.addExtensionsMetadata_();\n\n    if (this.styles_.length > 0) {\n      this.metadata['customStyleSheets'] = this.styles_;\n    }\n\n    if (this.imgMetadata_.length > 0) {\n      this.metadata['images'] = [];\n\n      for (var i = 0; i < this.imgMetadata_.length; i++) {\n        var img = this.imgMetadata_[i];\n        this.metadata['images'].push(img.src);\n      }\n    }\n\n    if (this.ctaType_) {\n      this.metadata['ctaType'] = this.ctaType_;\n    }\n\n    if (this.ctaUrl_) {\n      this.metadata['ctaUrl'] = this.ctaUrl_;\n    }\n\n    return JSON.stringify(this.metadata);\n  }\n  /**\n   * Generates metadata from document head, including\n   * runtime offsets, custom extensions, styles, and CTA\n   * @param {Element} head\n   */\n  ;\n\n  _proto.generateHeadMetadata_ = function generateHeadMetadata_(head) {\n    if (head == null) {\n      return;\n    }\n\n    for (var i = 0; i < head.children.length; i++) {\n      var child = head.children.item(i);\n\n      if (child.tagName == 'SCRIPT' && child.hasAttribute('src')) {\n        if (this.firstRuntimeElement_ == null) {\n          this.firstRuntimeElement_ = child;\n        }\n\n        this.lastRuntimeElement_ = child;\n\n        if (child.hasAttribute('custom-element')) {\n          this.extensions_.push({\n            'custom-element': child.getAttribute('custom-element'),\n            'src': child.getAttribute('src')\n          });\n        }\n\n        if (child.hasAttribute('custom-template')) {\n          this.extensions_.push({\n            'custom-template': child.getAttribute('custom-template'),\n            'src': child.getAttribute('src')\n          });\n        }\n      }\n\n      if (child.tagName == 'LINK' && child.getAttribute('rel') == 'stylesheet' && child.hasAttribute('href')) {\n        this.generateStyleMetadata_(child);\n      }\n\n      if (child.tagName == 'META' && child.hasAttribute('name') && child.hasAttribute('content')) {\n        this.generateCtaMetadata_(child);\n      }\n    }\n  }\n  /**\n   * Generates custom style metadata\n   * @param {Element} element\n   */\n  ;\n\n  _proto.generateStyleMetadata_ = function generateStyleMetadata_(element) {\n    var styleObject = {\n      href: element.getAttribute('href')\n    };\n\n    if (element.hasAttribute('media')) {\n      styleObject.media = element.getAttribute('media');\n    }\n\n    this.styles_.push(styleObject);\n  }\n  /**\n   * Generates CTA metadata for story ads\n   * @param {Element} element\n   */\n  ;\n\n  _proto.generateCtaMetadata_ = function generateCtaMetadata_(element) {\n    if (element.getAttribute('name') == 'amp-cta-type') {\n      this.ctaType_ = element.getAttribute('content');\n    }\n\n    if (element.getAttribute('name') == 'amp-cta-url') {\n      this.ctaUrl_ = element.getAttribute('content');\n    }\n  }\n  /**\n   * Generates image metadata\n   * @param {Document} doc\n   */\n  ;\n\n  _proto.generateImageMetadata_ = function generateImageMetadata_(doc) {\n    var imgs = doc.querySelectorAll('amp-img[src]');\n\n    for (var i = 0; i < imgs.length; i++) {\n      var img = imgs[i];\n      var width = void 0;\n      var height = void 0;\n      var area = -1;\n\n      if (img.hasAttribute('width')) {\n        width = img.getAttribute('width');\n      }\n\n      if (img.hasAttribute('height')) {\n        height = img.getAttribute('height');\n      }\n\n      if (height && width) {\n        area = height * width;\n      }\n\n      this.imgMetadata_.push({\n        src: img.getAttribute('src'),\n        area: area\n      });\n    }\n  }\n  /**\n   * Finds all <script type=application/json> tags and parses\n   * existing <amp-ad-metadata> script, if it exists\n   * @param {Document} doc\n   */\n  ;\n\n  _proto.generateJsonMetadata_ = function generateJsonMetadata_(doc) {\n    var json = doc.querySelectorAll('script[type]');\n\n    for (var i = 0; i < json.length; i++) {\n      var script = json[i];\n      var type = script.getAttribute('type');\n\n      if (type != 'application/json') {\n        (0, _log.user)().warn('SCRIPT', 'Type is invalid, must be `application/json`');\n        continue;\n      }\n\n      if (script.hasAttribute('amp-ad-metadata')) {\n        var parsed = (0, _json.parseJson)(script.textContent);\n\n        for (var attribute in parsed) {\n          this.metadata[attribute] = parsed[attribute];\n        }\n      }\n\n      if (script.hasAttribute('id') && !this.jsonMetadata_.includes(script.getAttribute('id'))) {\n        this.jsonMetadata_.push(script.getAttribute('id'));\n      }\n    }\n  }\n  /**\n   * Generates start and end of all runtime scripts,\n   * so they can be extracted by amp-a4a.js\n   * @param {string} creative\n   */\n  ;\n\n  _proto.generateRuntimeOffsets_ = function generateRuntimeOffsets_(creative) {\n    var start = 0;\n    var end = 0;\n\n    if (this.firstRuntimeElement_ != null) {\n      var firstRuntimeElementString = this.firstRuntimeElement_.\n      /*OK*/\n      outerHTML;\n      var lastRuntimeElementString = this.lastRuntimeElement_.\n      /*OK*/\n      outerHTML;\n      start = creative.indexOf(firstRuntimeElementString);\n      end = creative.indexOf(lastRuntimeElementString) + lastRuntimeElementString.length;\n    }\n\n    this.metadata['ampRuntimeUtf16CharOffsets'] = [start, end];\n  }\n  /**\n   * Generates start and end of all json scripts,\n   * not including <amp-analytics> json\n   * @param {string} creative\n   */\n  ;\n\n  _proto.generateJsonOffsets_ = function generateJsonOffsets_(creative) {\n    if (this.jsonMetadata_.length > 0) {\n      this.metadata['jsonUtf16CharOffsets'] = {};\n\n      for (var i = 0; i < this.jsonMetadata_.length; i++) {\n        var name = this.jsonMetadata_[i];\n        var nameElementString = this.ampAnalytics_.\n        /*OK*/\n        innerHTML;\n        var jsonStart = creative.indexOf(nameElementString);\n        var jsonEnd = jsonStart + nameElementString.length;\n        this.metadata['jsonUtf16CharOffsets'][name] = [jsonStart, jsonEnd];\n      }\n    }\n  }\n  /**\n   * Generates start and end of all json scripts\n   * within <amp-analytics> tags\n   * @param {Document} doc\n   * @param {string} creative\n   */\n  ;\n\n  _proto.generateAmpAnalyticsOffsets_ = function generateAmpAnalyticsOffsets_(doc, creative) {\n    var ampAnalytics = doc.querySelectorAll('amp-analytics');\n\n    if (ampAnalytics.length > 0) {\n      if (!this.metadata['jsonUtf16CharOffsets']) {\n        this.metadata['jsonUtf16CharOffsets'] = {};\n      }\n\n      this.metadata['jsonUtf16CharOffsets']['amp-analytics'] = [];\n\n      for (var i = 0; i < ampAnalytics.length; i++) {\n        var element = ampAnalytics[i];\n        var nameElementString = element.\n        /*OK*/\n        innerHTML;\n        var jsonStart = creative.indexOf(nameElementString);\n        var jsonEnd = jsonStart + nameElementString.length;\n        this.metadata['jsonUtf16CharOffsets']['amp-analytics'].push(jsonStart);\n        this.metadata['jsonUtf16CharOffsets']['amp-analytics'].push(jsonEnd);\n      }\n    }\n  }\n  /**\n   * Adds \"customElementExtensions\" and \"extensions\" objects to metadata\n   */\n  ;\n\n  _proto.addExtensionsMetadata_ = function addExtensionsMetadata_() {\n    if (this.extensions_.length > 0) {\n      this.metadata['customElementExtensions'] = [];\n      this.metadata['extensions'] = [];\n\n      for (var i = 0; i < this.extensions_.length; i++) {\n        var extension = this.extensions_[i];\n        var custom = void 0;\n\n        if (extension['custom-element'] != null) {\n          custom = extension['custom-element'];\n        } else {\n          custom = extension['custom-template'];\n        }\n\n        if (this.metadata['customElementExtensions'].indexOf(custom) == -1) {\n          this.metadata['customElementExtensions'].push(custom);\n          this.metadata['extensions'].push({\n            'custom-element': custom,\n            'src': extension['src']\n          });\n        }\n      }\n    }\n  };\n\n  return AmpAdMetadataTransformer;\n}();\n\nexports.AmpAdMetadataTransformer = AmpAdMetadataTransformer;\n\n},{\"../../../src/json\":63,\"../../../src/log\":68,\"../../../src/utils/object\":145}],16:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.AmpAdNetworkFakeImpl = void 0;\n\nvar _ampA4a = require(\"../../amp-a4a/0.1/amp-a4a\");\n\nvar _ampAdMetadataTransformer = require(\"./amp-ad-metadata-transformer\");\n\nvar _externalReorderHeadTransformer = require(\"./external-reorder-head-transformer\");\n\nvar _string = require(\"../../../src/string\");\n\nvar _log = require(\"../../../src/log\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\nvar TAG = 'AMP-AD-NETWORK-FAKE-IMPL';\n\nvar AmpAdNetworkFakeImpl =\n/*#__PURE__*/\nfunction (_AmpA4A) {\n  _inheritsLoose(AmpAdNetworkFakeImpl, _AmpA4A);\n\n  /**\n   * @param {!Element} element\n   */\n  function AmpAdNetworkFakeImpl(element) {\n    var _this;\n\n    _this = _AmpA4A.call(this, element) || this;\n    /** @private {!./external-reorder-head-transformer.ExternalReorderHeadTransformer} */\n\n    _this.reorderHeadTransformer_ = new _externalReorderHeadTransformer.ExternalReorderHeadTransformer();\n    /** @private {!./amp-ad-metadata-transformer.AmpAdMetadataTransformer} */\n\n    _this.metadataTransformer_ = new _ampAdMetadataTransformer.AmpAdMetadataTransformer();\n    return _this;\n  }\n  /** @override */\n\n\n  var _proto = AmpAdNetworkFakeImpl.prototype;\n\n  _proto.buildCallback = function buildCallback() {\n    (0, _log.userAssert)(this.element.hasAttribute('src'), 'Attribute src required for <amp-ad type=\"fake\">: %s', this.element);\n\n    _AmpA4A.prototype.buildCallback.call(this);\n  }\n  /** @override */\n  ;\n\n  _proto.isValidElement = function isValidElement() {\n    // To send out ad request, ad type='fake' requires the id set to an invalid\n    // value start with `i-amphtml-demo-`. So that fake ad can only be used in\n    // invalid AMP pages.\n    var id = this.element.getAttribute('id');\n\n    if (!id || !(0, _string.startsWith)(id, 'i-amphtml-demo-')) {\n      (0, _log.user)().warn(TAG, 'Only works with id starts with i-amphtml-demo-');\n      return false;\n    }\n\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.getAdUrl = function getAdUrl() {\n    return this.element.getAttribute('src');\n  }\n  /** @override */\n  ;\n\n  _proto.sendXhrRequest = function sendXhrRequest(adUrl) {\n    var _this2 = this;\n\n    return _AmpA4A.prototype.sendXhrRequest.call(this, adUrl).then(function (response) {\n      if (!response) {\n        return null;\n      }\n\n      var status =\n      /** @type {{status: number, headers: !Headers}} */\n      response.status,\n          headers = response.headers; // In the convert creative mode the content is the plain AMP HTML.\n      // This mode is primarily used for A4A Envelop for testing.\n      // See DEVELOPING.md for more info.\n\n      if (_this2.element.getAttribute('a4a-conversion') == 'true') {\n        return response.text().then(function (responseText) {\n          return new Response(_this2.transformCreative_(responseText), {\n            status: status,\n            headers: headers\n          });\n        });\n      } // Normal mode: Expect the creative is written in AMP4ADS doc.\n\n\n      return response;\n    });\n  }\n  /**\n   * Converts a general AMP doc to a AMP4ADS doc.\n   * @param {string} source\n   * @return {string}\n   */\n  ;\n\n  _proto.transformCreative_ = function transformCreative_(source) {\n    var doc = new DOMParser().parseFromString(source, 'text/html');\n    var root = doc.documentElement; // <html > -> <html 4ads>\n\n    if (root.hasAttribute('')) {\n      root.removeAttribute('');\n    } else if (root.hasAttribute('amp')) {\n      root.removeAttribute('amp');\n    } else if (root.hasAttribute('AMP')) {\n      root.removeAttribute('AMP');\n    }\n\n    if (!root.hasAttribute('4ads') && !root.hasAttribute('4ADS')) {\n      root.setAttribute('amp4ads', '');\n    }\n\n    this.reorderHeadTransformer_.reorderHead(doc.head);\n    var metadata = this.metadataTransformer_.generateMetadata(doc); //Removes <amp-ad-metadata> tag if it exists\n\n    var oldMetadata = doc.querySelector('script[amp-ad-metadata]');\n\n    if (oldMetadata) {\n      oldMetadata.parentNode.removeChild(oldMetadata);\n    }\n\n    var creative = root.\n    /*OK*/\n    outerHTML;\n    var creativeSplit = creative.split('</body>');\n    var docWithMetadata = creativeSplit[0] + \"<script type=\\\"application/json\\\" amp-ad-metadata>\" + metadata + '</script></body>' + creativeSplit[1];\n    return docWithMetadata;\n  };\n\n  return AmpAdNetworkFakeImpl;\n}(_ampA4a.AmpA4A);\n\nexports.AmpAdNetworkFakeImpl = AmpAdNetworkFakeImpl;\nAMP.extension('amp-ad-network-fake-impl', '0.1', function (AMP) {\n  AMP.registerElement('amp-ad-network-fake-impl', AmpAdNetworkFakeImpl);\n});\n\n},{\"../../../src/log\":68,\"../../../src/string\":126,\"../../amp-a4a/0.1/amp-a4a\":12,\"./amp-ad-metadata-transformer\":15,\"./external-reorder-head-transformer\":17}],17:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ExternalReorderHeadTransformer = void 0;\n\nvar _string = require(\"../../../src/string\");\n\nvar _config = require(\"../../../src/config\");\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar ExternalReorderHeadTransformer =\n/*#__PURE__*/\nfunction () {\n  /** constructor */\n  function ExternalReorderHeadTransformer() {\n    /** @private {!Object} */\n    this.headComponents_ = {\n      metaOther: [],\n      scriptNonRenderDelayingExtensions: [],\n      scriptRenderDelayingExtensions: [],\n      linkIcons: [],\n      linkResourceHints: [],\n      linkStylesheetBeforeAmpCustom: [],\n      other: [],\n      otherScripts: [],\n      styleAmpRuntime: null,\n      metaCharset: null,\n      scriptAmpEngine: null,\n      scriptAmpViewer: null,\n      scriptGmailAmpViewer: null,\n      styleAmpCustom: null,\n      linkStylesheetRuntimeCss: null,\n      styleAmpBoilerplate: null,\n      noscript: null\n    };\n  }\n  /**\n   * Appends child to parent, if child is not null\n   * @param {Element} parent\n   * @param {Element} element\n   */\n\n\n  var _proto = ExternalReorderHeadTransformer.prototype;\n\n  _proto.appendIfNotNull_ = function appendIfNotNull_(parent, element) {\n    if (element != null) {\n      parent.appendChild(element);\n    }\n  }\n  /**\n   * Appends all children to parent\n   * @param {Element} parent\n   * @param {Array<Element>} element\n   */\n  ;\n\n  _proto.appendAll_ = function appendAll_(parent, element) {\n    for (var i = 0; i < element.length; i++) {\n      var child = element[i];\n      parent.appendChild(child);\n    }\n  }\n  /**\n   * Reorders head like so:\n   * (0) <meta charset> tag\n   * (1) <style amp-runtime>\n   * (2) remaining <meta> tags (those other than <meta charset>)\n   * (3) AMP runtime .js <script> tag\n   * (4) AMP viewer runtime .js <script> tag\n   * (5) Gmail AMP viewer runtime .js <script> tag\n   * (6) <script> tags for render delaying extensions\n   * (7) <script> tags for remaining extensions\n   * (8) <link> tag for favicon\n   * (9) <link> tag for resource hints\n   * (10) <link rel=stylesheet> tags before <style amp-custom>\n   * (11) <style amp-custom>\n   * (12) any other tags allowed in <head>\n   * (13) amp boilerplate (first style amp-boilerplate, then noscript)\n   *\n   * http://g3doc/search/amphtml/transformers/g3doc/t/ExternalReorderHead.md\n   * @param {Element} head\n   * @return {Element}\n   */\n  ;\n\n  _proto.reorderHead = function reorderHead(head) {\n    if (head != null) {\n      for (var i = 0; i < head.children.length; i++) {\n        var child = head.children.item(i);\n\n        switch (child.tagName) {\n          case 'META':\n            this.registerMeta_(child);\n            break;\n\n          case 'SCRIPT':\n            this.registerScript_(child);\n            break;\n\n          case 'STYLE':\n            this.registerStyle_(child);\n            break;\n\n          case 'LINK':\n            this.registerLink_(child);\n            break;\n\n          case 'NOSCRIPT':\n            this.headComponents_.noscript = child;\n            break;\n\n          default:\n            if (this.headComponents_.other.indexOf(child) == -1) {\n              this.headComponents_.other.push(child);\n            }\n\n        }\n      }\n\n      for (var _i = 0; _i < head.childNodes.length; _i++) {\n        head.removeChild(head.childNodes.item(_i));\n      }\n\n      this.repopulate_(head);\n    }\n\n    return head;\n  }\n  /**\n   * Classifies all elements with meta tags\n   * @param {Element} element\n   *\n   */\n  ;\n\n  _proto.registerMeta_ = function registerMeta_(element) {\n    if (element.hasAttribute('charset')) {\n      this.headComponents_.metaCharset = element;\n      return;\n    }\n\n    if (this.headComponents_.metaOther.indexOf(element) == -1) {\n      this.headComponents_.metaOther.push(element);\n      return;\n    }\n  }\n  /**\n   * Classifies all elements with script tags\n   * @param {Element} element\n   *\n   */\n  ;\n\n  _proto.registerScript_ = function registerScript_(element) {\n    var src = element.getAttribute('src');\n    var isAsync = element.hasAttribute('async');\n    var isExtension = element.hasAttribute('custom-element') || element.hasAttribute('custom-template') || element.hasAttribute('host-service');\n\n    if (isExtension) {\n      var custom = element.getAttribute('custom-element');\n\n      if (custom == 'amp-story' || custom == 'amp-experiment' || custom == 'amp-dynamic-css-classes') {\n        this.headComponents_.scriptRenderDelayingExtensions.push(element);\n        return;\n      }\n\n      this.headComponents_.scriptNonRenderDelayingExtensions.push(element);\n      return;\n    }\n\n    if (isAsync && ((0, _string.startsWith)(src, _config.urls.cdn) && ((0, _string.endsWith)(src, '/v0.js') || (0, _string.endsWith)(src, '/v0.js.br') || (0, _string.endsWith)(src, '/amp4ads-v0.js') || (0, _string.endsWith)(src, '/amp4ads-v0.js.br')) || (0, _string.endsWith)(src, '/dist/amp.js') || (0, _string.endsWith)(src, '/dist/amp-inabox.js') || (0, _string.endsWith)(src, '/dist/v0.js') || (0, _string.endsWith)(src, '/dist/amp4ads-v0.js'))) {\n      this.headComponents_.scriptAmpEngine = element;\n      return;\n    }\n\n    if (isAsync && (0, _string.startsWith)(src, _config.urls.cdn + '/v0/amp-viewer-integration-gmail-') && (0, _string.endsWith)(src, '.js')) {\n      this.headComponents_.scriptGmailAmpViewer = element;\n      return;\n    }\n\n    if (isAsync && ((0, _string.startsWith)(src, _config.urls.cdn + '/v0/amp-viewer-integration-') || (0, _string.startsWith)(src, _config.urls.cdn + '/viewer/google/v') && (0, _string.endsWith)(src, '.js'))) {\n      this.headComponents_.scriptAmpViewer = element;\n      return;\n    }\n\n    if (this.headComponents_.other.indexOf(element) == -1) {\n      this.headComponents_.other.push(element);\n    }\n  }\n  /**\n   * Classifies all elements with style tags\n   * @param {Element} element\n   *\n   */\n  ;\n\n  _proto.registerStyle_ = function registerStyle_(element) {\n    if (element.hasAttribute('amp-runtime')) {\n      this.headComponents_.styleAmpRuntime = element;\n      return;\n    }\n\n    if (element.hasAttribute('amp-custom')) {\n      this.headComponents_.styleAmpCustom = element;\n      return;\n    }\n\n    if (element.hasAttribute('amp-boilerplate') || element.hasAttribute('amp4ads-boilerplate')) {\n      this.headComponents_.styleAmpBoilerplate = element;\n      return;\n    }\n\n    if (this.headComponents_.other.indexOf(element) == -1) {\n      this.headComponents_.other.push(element);\n    }\n  }\n  /**\n   * Classifies all links\n   * @param {Element} element\n   *\n   */\n  ;\n\n  _proto.registerLink_ = function registerLink_(element) {\n    var rel = element.getAttribute('rel');\n\n    if (rel == 'stylesheet') {\n      if ((0, _string.startsWith)(element.getAttribute('href'), _config.urls.cdn) && (0, _string.endsWith)(element.getAttribute('href'), '/v0.css')) {\n        this.headComponents_.linkStylesheetRuntimeCss = element;\n        return;\n      }\n\n      if (this.headComponents_.styleAmpCustom == null) {\n        this.headComponents_.linkStylesheetBeforeAmpCustom.push(element);\n        return;\n      }\n\n      return;\n    }\n\n    if (rel == 'icon' || rel == 'icon shortcut' || rel == 'shortcut icon') {\n      this.headComponents_.linkIcons.push(element);\n      return;\n    }\n\n    if (rel == 'dns-prefetch preconnect') {\n      this.headComponents_.linkResourceHints.push(element);\n      return;\n    }\n\n    if (this.headComponents_.other.indexOf(element) == -1) {\n      this.headComponents_.other.push(element);\n    }\n  }\n  /**\n   * Add components back to head in specified order\n   * @param {Element} head\n   * @return {Element}\n   */\n  ;\n\n  _proto.repopulate_ = function repopulate_(head) {\n    this.appendIfNotNull_(head, this.headComponents_.metaCharset);\n    this.appendIfNotNull_(head, this.headComponents_.linkStylesheetRuntimeCss);\n    this.appendIfNotNull_(head, this.headComponents_.styleAmpRuntime);\n    this.appendAll_(head, this.headComponents_.metaOther);\n    this.appendIfNotNull_(head, this.headComponents_.scriptAmpEngine);\n    this.appendIfNotNull_(head, this.headComponents_.scriptAmpViewer);\n    this.appendIfNotNull_(head, this.headComponents_.scriptGmailAmpViewer);\n    this.appendAll_(head, this.headComponents_.scriptRenderDelayingExtensions);\n    this.appendAll_(head, this.headComponents_.scriptNonRenderDelayingExtensions);\n    this.appendAll_(head, this.headComponents_.otherScripts);\n    this.appendAll_(head, this.headComponents_.linkIcons);\n    this.appendAll_(head, this.headComponents_.linkResourceHints);\n    this.appendAll_(head, this.headComponents_.linkStylesheetBeforeAmpCustom);\n    this.appendIfNotNull_(head, this.headComponents_.styleAmpCustom);\n    this.appendAll_(head, this.headComponents_.other);\n    this.appendIfNotNull_(head, this.headComponents_.styleAmpBoilerplate);\n    this.appendIfNotNull_(head, this.headComponents_.noscript);\n    return head;\n  };\n\n  return ExternalReorderHeadTransformer;\n}();\n\nexports.ExternalReorderHeadTransformer = ExternalReorderHeadTransformer;\n\n},{\"../../../src/config\":32,\"../../../src/string\":126}],18:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.gmosspIsA4AEnabled = gmosspIsA4AEnabled;\n\nvar _string = require(\"../../../src/string\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const @private {string} */\nvar GMOSSP_SRC_PREFIX_ = 'https://sp.gmossp-sp.jp/';\n/** @const @private {string} */\n\nvar GMOSSP_SRC_A4A_PREFIX_ = 'https://amp.sp.gmossp-sp.jp/_a4a/';\n/**\n * @param {!Window} win\n * @param {!Element} element\n * @param {boolean} useRemoteHtml\n * @return {boolean}\n */\n\nfunction gmosspIsA4AEnabled(win, element, useRemoteHtml) {\n  var src;\n  return !useRemoteHtml && !!(src = element.getAttribute('src')) && !!element.getAttribute('data-use-a4a') && ((0, _string.startsWith)(src, GMOSSP_SRC_PREFIX_) || (0, _string.startsWith)(src, GMOSSP_SRC_A4A_PREFIX_));\n}\n\n},{\"../../../src/string\":126}],19:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.tripleliftIsA4AEnabled = tripleliftIsA4AEnabled;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const @private {string} */\nvar SRC_PREFIX_ = 'https://ib.3lift.com/';\n/**\n * @param {!Window} win\n * @param {!Element} element\n * @param {boolean} useRemoteHtml\n * @return {boolean}\n */\n\nfunction tripleliftIsA4AEnabled(win, element, useRemoteHtml) {\n  var src;\n  return !useRemoteHtml && !!element.getAttribute('data-use-a4a') && !!(src = element.getAttribute('src')) && src.indexOf(SRC_PREFIX_) == 0;\n}\n\n},{}],20:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.is3pThrottled = is3pThrottled;\nexports.waitFor3pThrottle = waitFor3pThrottle;\nexports.getAmpAdRenderOutsideViewport = getAmpAdRenderOutsideViewport;\nexports.incrementLoadingAds = incrementLoadingAds;\n\nvar _promise = require(\"../../../src/utils/promise\");\n\nvar _services = require(\"../../../src/services\");\n\nvar _log = require(\"../../../src/log\");\n\n/* Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Store loading ads info within window to ensure it can be properly stored\n * across separately compiled binaries that share load throttling.\n * @const ID of window variable used to track 3p ads waiting to load.\n */\nvar LOADING_ADS_WIN_ID_ = '3pla';\n/** @private {?Promise} resolves when no 3p throttle */\n\nvar throttlePromise_ = null;\n/** @private {?Function} resolver for throttle promise */\n\nvar throttlePromiseResolver_ = null;\n/**\n * @param {!Window} win\n * @return {boolean} Whether 3p is currently throttled.\n */\n\nfunction is3pThrottled(win) {\n  return !!win[LOADING_ADS_WIN_ID_];\n}\n/** @return {!Promise} resolves when no 3p throttle */\n\n\nfunction waitFor3pThrottle() {\n  return throttlePromise_ || Promise.resolve();\n}\n/**\n * @param {!Element} element\n * @return {?number} number if explicit value should be used otherwise super\n *    default should be used.\n */\n\n\nfunction getAmpAdRenderOutsideViewport(element) {\n  var rawValue = element.getAttribute('data-loading-strategy');\n\n  if (rawValue == null) {\n    return null;\n  } // Ad opts into lazier loading strategy where we only load ads that are\n  // at closer given number of viewports away.\n\n\n  if (rawValue == 'prefer-viewability-over-views' || rawValue == '') {\n    return 1.25;\n  }\n\n  var errorMessage = 'Value of data-loading-strategy should be a float number in range ' + 'of [0, 3], but got ' + rawValue;\n  var viewportNumber = (0, _log.user)().assertNumber(parseFloat(rawValue), errorMessage);\n  (0, _log.userAssert)(viewportNumber >= 0 && viewportNumber <= 3, errorMessage);\n  return viewportNumber;\n}\n/**\n * Increments loading ads count for throttling.\n * @param {!Window} win\n * @param {!Promise=} opt_loadingPromise\n */\n\n\nfunction incrementLoadingAds(win, opt_loadingPromise) {\n  if (win[LOADING_ADS_WIN_ID_] === undefined) {\n    win[LOADING_ADS_WIN_ID_] = 0;\n  }\n\n  win[LOADING_ADS_WIN_ID_]++;\n\n  if (!throttlePromise_) {\n    var deferred = new _promise.Deferred();\n    throttlePromise_ = deferred.promise;\n    throttlePromiseResolver_ = deferred.resolve;\n  }\n\n  _services.Services.timerFor(win).timeoutPromise(1000, opt_loadingPromise).catch(function () {}).then(function () {\n    if (! --win[LOADING_ADS_WIN_ID_]) {\n      throttlePromiseResolver_();\n      throttlePromise_ = null;\n      throttlePromiseResolver_ = null;\n    }\n  });\n}\n\n},{\"../../../src/log\":68,\"../../../src/services\":123,\"../../../src/utils/promise\":147}],21:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.listen = listen;\nexports.serializeMessage = serializeMessage;\nexports.deserializeMessage = deserializeMessage;\nexports.isAmpMessage = isAmpMessage;\nexports.IframeTransportEvent = exports.MessageType = exports.CONSTANTS = void 0;\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object\");\n\nvar _eventHelperListen = require(\"./event-helper-listen\");\n\nvar _json = require(\"./json\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const */\nvar AMP_MESSAGE_PREFIX = 'amp-';\nvar CONSTANTS = {\n  responseTypeSuffix: '-result',\n  messageIdFieldName: 'messageId',\n  payloadFieldName: 'payload',\n  contentFieldName: 'content'\n};\n/** @enum {string} */\n\nexports.CONSTANTS = CONSTANTS;\nvar MessageType = {\n  // For amp-ad\n  SEND_EMBED_STATE: 'send-embed-state',\n  EMBED_STATE: 'embed-state',\n  SEND_EMBED_CONTEXT: 'send-embed-context',\n  EMBED_CONTEXT: 'embed-context',\n  SEND_INTERSECTIONS: 'send-intersections',\n  INTERSECTION: 'intersection',\n  EMBED_SIZE: 'embed-size',\n  EMBED_SIZE_CHANGED: 'embed-size-changed',\n  EMBED_SIZE_DENIED: 'embed-size-denied',\n  NO_CONTENT: 'no-content',\n  GET_HTML: 'get-html',\n  GET_CONSENT_STATE: 'get-consent-state',\n  // For the frame to be placed in full overlay mode for lightboxes\n  FULL_OVERLAY_FRAME: 'full-overlay-frame',\n  FULL_OVERLAY_FRAME_RESPONSE: 'full-overlay-frame-response',\n  CANCEL_FULL_OVERLAY_FRAME: 'cancel-full-overlay-frame',\n  CANCEL_FULL_OVERLAY_FRAME_RESPONSE: 'cancel-full-overlay-frame-response',\n  // For amp-inabox\n  SEND_POSITIONS: 'send-positions',\n  POSITION: 'position',\n  // For amp-analytics' iframe-transport\n  SEND_IFRAME_TRANSPORT_EVENTS: 'send-iframe-transport-events',\n  IFRAME_TRANSPORT_EVENTS: 'iframe-transport-events',\n  IFRAME_TRANSPORT_RESPONSE: 'iframe-transport-response',\n  // For user-error-in-iframe\n  USER_ERROR_IN_IFRAME: 'user-error-in-iframe'\n};\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\n\nexports.MessageType = MessageType;\n\nfunction listen(element, eventType, listener, opt_evtListenerOpts) {\n  return (0, _eventHelperListen.internalListenImplementation)(element, eventType, listener, opt_evtListenerOpts);\n}\n/**\n * Serialize an AMP post message. Output looks like:\n * 'amp-011481323099490{\"type\":\"position\",\"sentinel\":\"12345\",\"foo\":\"bar\"}'\n * @param {string} type\n * @param {string} sentinel\n * @param {JsonObject=} data\n * @param {?string=} rtvVersion\n * @return {string}\n */\n\n\nfunction serializeMessage(type, sentinel, data, rtvVersion) {\n  if (data === void 0) {\n    data = (0, _object.dict)();\n  }\n\n  if (rtvVersion === void 0) {\n    rtvVersion = null;\n  }\n\n  // TODO: consider wrap the data in a \"data\" field. { type, sentinal, data }\n  var message = data;\n  message['type'] = type;\n  message['sentinel'] = sentinel;\n  return AMP_MESSAGE_PREFIX + (rtvVersion || '') + JSON.stringify(message);\n}\n/**\n * Deserialize an AMP post message.\n * Returns null if it's not valid AMP message format.\n *\n * @param {*} message\n * @return {?JsonObject|undefined}\n */\n\n\nfunction deserializeMessage(message) {\n  if (!isAmpMessage(message)) {\n    return null;\n  }\n\n  var startPos = message.indexOf('{');\n  (0, _log.devAssert)(startPos != -1, 'JSON missing in %s', message);\n\n  try {\n    return (0, _json.parseJson)(message.substr(startPos));\n  } catch (e) {\n    (0, _log.dev)().error('MESSAGING', 'Failed to parse message: ' + message, e);\n    return null;\n  }\n}\n/**\n *  Returns true if message looks like it is an AMP postMessage\n *  @param {*} message\n *  @return {boolean}\n */\n\n\nfunction isAmpMessage(message) {\n  return typeof message == 'string' && message.indexOf(AMP_MESSAGE_PREFIX) == 0 && message.indexOf('{') != -1;\n}\n/** @typedef {{creativeId: string, message: string}} */\n\n\nvar IframeTransportEvent; // An event, and the transport ID of the amp-analytics tags that\n// generated it. For instance if the creative with transport\n// ID 2 sends \"hi\", then an IframeTransportEvent would look like:\n// { creativeId: \"2\", message: \"hi\" }\n// If the creative with transport ID 2 sent that, and also sent \"hello\",\n// and the creative with transport ID 3 sends \"goodbye\" then an *array* of 3\n// AmpAnalyticsIframeTransportEvent would be sent to the 3p frame like so:\n// [\n//   { creativeId: \"2\", message: \"hi\" }, // An AmpAnalyticsIframeTransportEvent\n//   { creativeId: \"2\", message: \"hello\" }, // Another\n//   { creativeId: \"3\", message: \"goodbye\" } // And another\n// ]\n\nexports.IframeTransportEvent = IframeTransportEvent;\n\n},{\"./event-helper-listen\":45,\"./json\":63,\"./log\":68,\"./utils/object\":145}],22:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getIframe = getIframe;\nexports.addDataAndJsonAttributes_ = addDataAndJsonAttributes_;\nexports.preloadBootstrap = preloadBootstrap;\nexports.getBootstrapBaseUrl = getBootstrapBaseUrl;\nexports.setDefaultBootstrapBaseUrlForTesting = setDefaultBootstrapBaseUrlForTesting;\nexports.resetBootstrapBaseUrlForTesting = resetBootstrapBaseUrlForTesting;\nexports.getDefaultBootstrapBaseUrl = getDefaultBootstrapBaseUrl;\nexports.getDevelopmentBootstrapBaseUrl = getDevelopmentBootstrapBaseUrl;\nexports.getSubDomain = getSubDomain;\nexports.getRandom = getRandom;\nexports.applySandbox = applySandbox;\nexports.generateSentinel = generateSentinel;\nexports.resetCountForTesting = resetCountForTesting;\n\nvar _url = require(\"./url\");\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object\");\n\nvar _iframeAttributes = require(\"../src/iframe-attributes\");\n\nvar _mode = require(\"./mode\");\n\nvar _internalVersion = require(\"./internal-version\");\n\nvar _style = require(\"./style\");\n\nvar _string = require(\"./string\");\n\nvar _json = require(\"./json\");\n\nvar _config = require(\"./config\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @type {!Object<string,number>} Number of 3p frames on the for that type. */\nvar count = {};\n/** @type {string} */\n\nvar overrideBootstrapBaseUrl;\n/** @const {string} */\n\nvar TAG = '3p-frame';\n/**\n * Produces the attributes for the ad template.\n * @param {!Window} parentWindow\n * @param {!AmpElement} element\n * @param {string=} opt_type\n * @param {Object=} opt_context\n * @return {!JsonObject} Contains\n *     - type, width, height, src attributes of <amp-ad> tag. These have\n *       precedence over the data- attributes.\n *     - data-* attributes of the <amp-ad> tag with the \"data-\" removed.\n *     - A _context object for internal use.\n */\n\nfunction getFrameAttributes(parentWindow, element, opt_type, opt_context) {\n  var type = opt_type || element.getAttribute('type');\n  (0, _log.userAssert)(type, 'Attribute type required for <amp-ad>: %s', element);\n  var sentinel = generateSentinel(parentWindow);\n  var attributes = (0, _object.dict)(); // Do these first, as the other attributes have precedence.\n\n  addDataAndJsonAttributes_(element, attributes);\n  attributes = (0, _iframeAttributes.getContextMetadata)(parentWindow, element, sentinel, attributes);\n  attributes['type'] = type;\n  Object.assign(attributes['_context'], opt_context);\n  return attributes;\n}\n/**\n * Creates the iframe for the embed. Applies correct size and passes the embed\n * attributes to the frame via JSON inside the fragment.\n * @param {!Window} parentWindow\n * @param {!AmpElement} parentElement\n * @param {string=} opt_type\n * @param {Object=} opt_context\n * @param {!{\n *   disallowCustom,\n *   allowFullscreen,\n * }=} opt_options Options for the created iframe.\n * @return {!HTMLIFrameElement} The iframe.\n */\n\n\nfunction getIframe(parentWindow, parentElement, opt_type, opt_context, _temp) {\n  var _ref = _temp === void 0 ? {} : _temp,\n      disallowCustom = _ref.disallowCustom,\n      allowFullscreen = _ref.allowFullscreen;\n\n  // Check that the parentElement is already in DOM. This code uses a new and\n  // fast `isConnected` API and thus only used when it's available.\n  (0, _log.devAssert)(parentElement['isConnected'] === undefined || parentElement['isConnected'] === true, 'Parent element must be in DOM');\n  var attributes = getFrameAttributes(parentWindow, parentElement, opt_type, opt_context);\n  var iframe =\n  /** @type {!HTMLIFrameElement} */\n  parentWindow.document.createElement('iframe');\n\n  if (!count[attributes['type']]) {\n    count[attributes['type']] = 0;\n  }\n\n  count[attributes['type']] += 1;\n  var baseUrl = getBootstrapBaseUrl(parentWindow, undefined, disallowCustom);\n  var host = (0, _url.parseUrlDeprecated)(baseUrl).hostname; // This name attribute may be overwritten if this frame is chosen to\n  // be the master frame. That is ok, as we will read the name off\n  // for our uses before that would occur.\n  // @see https://github.com/ampproject/amphtml/blob/master/3p/integration.js\n\n  var name = JSON.stringify((0, _object.dict)({\n    'host': host,\n    'type': attributes['type'],\n    // https://github.com/ampproject/amphtml/pull/2955\n    'count': count[attributes['type']],\n    'attributes': attributes\n  }));\n  iframe.src = baseUrl;\n  iframe.ampLocation = (0, _url.parseUrlDeprecated)(baseUrl);\n  iframe.name = name; // Add the check before assigning to prevent IE throw Invalid argument error\n\n  if (attributes['width']) {\n    iframe.width = attributes['width'];\n  }\n\n  if (attributes['height']) {\n    iframe.height = attributes['height'];\n  }\n\n  if (attributes['title']) {\n    iframe.title = attributes['title'];\n  }\n\n  if (allowFullscreen) {\n    iframe.setAttribute('allowfullscreen', 'true');\n  }\n\n  iframe.setAttribute('scrolling', 'no');\n  (0, _style.setStyle)(iframe, 'border', 'none');\n  /** @this {!Element} */\n\n  iframe.onload = function () {\n    // Chrome does not reflect the iframe readystate.\n    this.readyState = 'complete';\n  }; // Block synchronous XHR in ad. These are very rare, but super bad for UX\n  // as they block the UI thread for the arbitrary amount of time until the\n  // request completes.\n\n\n  iframe.setAttribute('allow', \"sync-xhr 'none';\");\n  var excludeFromSandbox = ['facebook'];\n\n  if (!excludeFromSandbox.includes(opt_type)) {\n    applySandbox(iframe);\n  }\n\n  iframe.setAttribute('data-amp-3p-sentinel', attributes['_context']['sentinel']);\n  return iframe;\n}\n/**\n * Copies data- attributes from the element into the attributes object.\n * Removes the data- from the name and capitalizes after -. If there\n * is an attribute called json, parses the JSON and adds it to the\n * attributes.\n * @param {!Element} element\n * @param {!JsonObject} attributes The destination.\n * visibleForTesting\n */\n\n\nfunction addDataAndJsonAttributes_(element, attributes) {\n  var dataset = element.dataset;\n\n  for (var name in dataset) {\n    // data-vars- is reserved for amp-analytics\n    // see https://github.com/ampproject/amphtml/blob/master/extensions/amp-analytics/analytics-vars.md#variables-as-data-attribute\n    if (!(0, _string.startsWith)(name, 'vars')) {\n      attributes[name] = dataset[name];\n    }\n  }\n\n  var json = element.getAttribute('json');\n\n  if (json) {\n    var obj = (0, _json.tryParseJson)(json);\n\n    if (obj === undefined) {\n      throw (0, _log.user)().createError('Error parsing JSON in json attribute in element %s', element);\n    }\n\n    for (var key in obj) {\n      attributes[key] = obj[key];\n    }\n  }\n}\n/**\n * Preloads URLs related to the bootstrap iframe.\n * @param {!Window} win\n * @param {!./preconnect.Preconnect} preconnect\n * @param {boolean=} opt_disallowCustom whether 3p url should not use meta tag.\n */\n\n\nfunction preloadBootstrap(win, preconnect, opt_disallowCustom) {\n  var url = getBootstrapBaseUrl(win, undefined, opt_disallowCustom);\n  preconnect.preload(url, 'document'); // While the URL may point to a custom domain, this URL will always be\n  // fetched by it.\n\n  var scriptUrl = (0, _mode.getMode)().localDev ? getAdsLocalhost(win) + '/dist.3p/current/integration.js' : _config.urls.thirdParty + \"/\" + (0, _internalVersion.internalRuntimeVersion)() + \"/f.js\";\n  preconnect.preload(scriptUrl, 'script');\n}\n/**\n * Returns the base URL for 3p bootstrap iframes.\n * @param {!Window} parentWindow\n * @param {boolean=} opt_strictForUnitTest\n * @param {boolean=} opt_disallowCustom whether 3p url should not use meta tag.\n * @return {string}\n * @visibleForTesting\n */\n\n\nfunction getBootstrapBaseUrl(parentWindow, opt_strictForUnitTest, opt_disallowCustom) {\n  var customBootstrapBaseUrl = opt_disallowCustom ? null : getCustomBootstrapBaseUrl(parentWindow, opt_strictForUnitTest);\n  return customBootstrapBaseUrl || getDefaultBootstrapBaseUrl(parentWindow);\n}\n/**\n * @param {string} url\n */\n\n\nfunction setDefaultBootstrapBaseUrlForTesting(url) {\n  overrideBootstrapBaseUrl = url;\n}\n/**\n * @param {*} win\n */\n\n\nfunction resetBootstrapBaseUrlForTesting(win) {\n  win.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN = undefined;\n}\n/**\n * Returns the default base URL for 3p bootstrap iframes.\n * @param {!Window} parentWindow\n * @param {string=} opt_srcFileBasename\n * @return {string}\n */\n\n\nfunction getDefaultBootstrapBaseUrl(parentWindow, opt_srcFileBasename) {\n  var srcFileBasename = opt_srcFileBasename || 'frame';\n\n  if ((0, _mode.getMode)().localDev || (0, _mode.getMode)().test) {\n    return getDevelopmentBootstrapBaseUrl(parentWindow, srcFileBasename);\n  } // Ensure same sub-domain is used despite potentially different file.\n\n\n  parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN = parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN || getSubDomain(parentWindow);\n  return 'https://' + parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN + (\".\" + _config.urls.thirdPartyFrameHost + \"/\" + (0, _internalVersion.internalRuntimeVersion)() + \"/\") + (srcFileBasename + \".html\");\n}\n/**\n * Function to return the development boostrap base URL\n * @param {!Window} parentWindow\n * @param {string} srcFileBasename\n * @return {string}\n */\n\n\nfunction getDevelopmentBootstrapBaseUrl(parentWindow, srcFileBasename) {\n  return overrideBootstrapBaseUrl || getAdsLocalhost(parentWindow) + '/dist.3p/' + ((0, _mode.getMode)().minified ? (0, _internalVersion.internalRuntimeVersion)() + \"/\" + srcFileBasename : \"current/\" + srcFileBasename + \".max\") + '.html';\n}\n/**\n * @param {!Window} win\n * @return {string}\n */\n\n\nfunction getAdsLocalhost(win) {\n  var adsUrl = _config.urls.thirdParty; // local dev with a non-localhost server\n\n  if (adsUrl == 'https://3p.ampproject.net') {\n    adsUrl = 'http://ads.localhost'; // local dev with a localhost server\n  }\n\n  return adsUrl + ':' + (win.location.port || win.parent.location.port);\n}\n/**\n * Sub domain on which the 3p iframe will be hosted.\n * Because we only calculate the URL once per page, this function is only\n * called once and hence all frames on a page use the same URL.\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\n\n\nfunction getSubDomain(win) {\n  return 'd-' + getRandom(win);\n}\n/**\n * Generates a random non-negative integer.\n * @param {!Window} win\n * @return {string}\n */\n\n\nfunction getRandom(win) {\n  var rand;\n\n  if (win.crypto && win.crypto.getRandomValues) {\n    // By default use 2 32 bit integers.\n    var uint32array = new Uint32Array(2);\n    win.crypto.getRandomValues(uint32array);\n    rand = String(uint32array[0]) + uint32array[1];\n  } else {\n    // Fall back to Math.random.\n    rand = String(win.Math.random()).substr(2) + '0';\n  }\n\n  return rand;\n}\n/**\n * Returns the custom base URL for 3p bootstrap iframes if it exists.\n * Otherwise null.\n * @param {!Window} parentWindow\n * @param {boolean=} opt_strictForUnitTest\n * @return {?string}\n */\n\n\nfunction getCustomBootstrapBaseUrl(parentWindow, opt_strictForUnitTest) {\n  var meta = parentWindow.document.querySelector('meta[name=\"amp-3p-iframe-src\"]');\n\n  if (!meta) {\n    return null;\n  }\n\n  var url = (0, _url.assertHttpsUrl)(meta.getAttribute('content'), meta);\n  (0, _log.userAssert)(url.indexOf('?') == -1, '3p iframe url must not include query string %s in element %s.', url, meta); // This is not a security primitive, we just don't want this to happen in\n  // practice. People could still redirect to the same origin, but they cannot\n  // redirect to the proxy origin which is the important one.\n\n  var parsed = (0, _url.parseUrlDeprecated)(url);\n  (0, _log.userAssert)(parsed.hostname == 'localhost' && !opt_strictForUnitTest || parsed.origin != (0, _url.parseUrlDeprecated)(parentWindow.location.href).origin, '3p iframe url must not be on the same origin as the current document ' + '%s (%s) in element %s. See https://github.com/ampproject/amphtml' + '/blob/master/spec/amp-iframe-origin-policy.md for details.', url, parsed.origin, meta);\n  return url + \"?\" + (0, _internalVersion.internalRuntimeVersion)();\n}\n/**\n * Applies a sandbox to the iframe, if the required flags can be allowed.\n * @param {!Element} iframe\n * @visibleForTesting\n */\n\n\nfunction applySandbox(iframe) {\n  if (!iframe.sandbox || !iframe.sandbox.supports) {\n    return; // Can't feature detect support\n  } // If these flags are not supported by the UA we don't apply any\n  // sandbox.\n\n\n  var requiredFlags = [// This only allows navigation when user interacts and thus prevents\n  // ads from auto navigating the user.\n  'allow-top-navigation-by-user-activation', // Crucial because otherwise even target=_blank opened links are\n  // still sandboxed which they may not expect.\n  'allow-popups-to-escape-sandbox']; // These flags are not feature detected. Put stuff here where either\n  // they have always been supported or support is not crucial.\n\n  var otherFlags = ['allow-forms', // We should consider turning this off! But since the top navigation\n  // issue is the big one, we'll leave this allowed for now.\n  'allow-modals', // Give access to raw mouse movements.\n  'allow-pointer-lock', // This remains subject to popup blocking, it just makes it supported\n  // at all.\n  'allow-popups', // This applies inside the iframe and is crucial to not break the web.\n  'allow-same-origin', 'allow-scripts']; // Not allowed\n  // - allow-top-navigation\n  // - allow-orientation-lock\n  // - allow-pointer-lock\n  // - allow-presentation\n\n  for (var i = 0; i < requiredFlags.length; i++) {\n    var flag = requiredFlags[i];\n\n    if (!iframe.sandbox.supports(flag)) {\n      (0, _log.dev)().info(TAG, \"Iframe doesn't support %s\", flag);\n      return;\n    }\n  }\n\n  iframe.sandbox = requiredFlags.join(' ') + ' ' + otherFlags.join(' ');\n}\n/**\n * Returns a randomized sentinel value for 3p iframes.\n * The format is \"%d-%d\" with the first value being the depth of current\n * window in the window hierarchy and the second a random integer.\n * @param {!Window} parentWindow\n * @return {string}\n * @visibleForTesting\n */\n\n\nfunction generateSentinel(parentWindow) {\n  var windowDepth = 0;\n\n  for (var win = parentWindow; win && win != win.parent; win = win.parent) {\n    windowDepth++;\n  }\n\n  return String(windowDepth) + '-' + getRandom(parentWindow);\n}\n/**\n * Resets the count of each 3p frame type\n * @visibleForTesting\n */\n\n\nfunction resetCountForTesting() {\n  count = {};\n}\n\n},{\"../src/iframe-attributes\":56,\"./config\":32,\"./internal-version\":61,\"./json\":63,\"./log\":68,\"./mode\":70,\"./string\":126,\"./style\":128,\"./url\":134,\"./utils/object\":145}],23:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ActionTrust = exports.DEFAULT_ACTION = exports.RAW_OBJECT_ARGS_KEY = void 0;\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Key string in an action arguments map for an unparsed object literal string.\n *\n * E.g. for the action in <p on=\"tap:AMP.setState({foo: 'bar'})\",\n * then `args[RAW_OBJECT_ARGS_KEY]` is the string \"{foo: 'bar'}\".\n *\n * The action service delegates parsing of object literals to the corresponding\n * extension (in the example above, amp-bind).\n *\n * @see ./service/action-impl.ActionInfoDef\n * @const {string}\n */\nvar RAW_OBJECT_ARGS_KEY = '__AMP_OBJECT_STRING__';\n/** @const {string} Identifier for an element's default action. */\n\nexports.RAW_OBJECT_ARGS_KEY = RAW_OBJECT_ARGS_KEY;\nvar DEFAULT_ACTION = 'activate';\n/**\n * Trust level of an action.\n *\n * Corresponds to degree of user intent, i.e. events triggered with strong\n * user intent have high trust.\n *\n * @enum {number}\n */\n\nexports.DEFAULT_ACTION = DEFAULT_ACTION;\nvar ActionTrust = {\n  LOW: 1,\n  HIGH: 100\n};\nexports.ActionTrust = ActionTrust;\n\n},{}],24:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getAdCid = getAdCid;\nexports.getOrCreateAdCid = getOrCreateAdCid;\n\nvar _services = require(\"./services\");\n\nvar _config = require(\"../ads/_config\");\n\nvar _log = require(\"../src/log\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {AMP.BaseElement} adElement\n * @return {!Promise<string|undefined>} A promise for a CID or undefined if\n *     - the ad network does not request one or\n *     - `amp-analytics` which provides the CID service was not installed.\n */\nfunction getAdCid(adElement) {\n  var config = _config.adConfig[adElement.element.getAttribute('type')];\n\n  if (!config || !config['clientIdScope']) {\n    return Promise.resolve();\n  }\n\n  return getOrCreateAdCid(adElement.getAmpDoc(), config['clientIdScope'], config['clientIdCookieName']);\n}\n/**\n * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n * @param {string} clientIdScope\n * @param {string=} opt_clientIdCookieName\n * @param {number=} opt_timeout\n * @return {!Promise<string|undefined>} A promise for a CID or undefined.\n */\n\n\nfunction getOrCreateAdCid(ampDoc, clientIdScope, opt_clientIdCookieName, opt_timeout) {\n  var timeout = isNaN(opt_timeout) || opt_timeout == null ? 1000 : opt_timeout;\n\n  var cidPromise = _services.Services.cidForDoc(ampDoc).then(function (cidService) {\n    if (!cidService) {\n      return;\n    }\n\n    return cidService.get({\n      scope: (0, _log.dev)().assertString(clientIdScope),\n      createCookieIfNotPresent: true,\n      cookieName: opt_clientIdCookieName\n    }, Promise.resolve(undefined)).catch(function (error) {\n      // Not getting a CID is not fatal.\n      (0, _log.dev)().error('AD-CID', error);\n      return undefined;\n    });\n  }); // The CID should never be crucial for an ad. If it does not come within\n  // 1 second, assume it will never arrive.\n\n\n  return _services.Services.timerFor(ampDoc.win).timeoutPromise(timeout, cidPromise, 'cid timeout').catch(function (error) {\n    // Timeout is not fatal.\n    (0, _log.dev)().warn('AD-CID', error);\n    return undefined;\n  });\n}\n\n},{\"../ads/_config\":2,\"../src/log\":68,\"./services\":123}],25:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.isAdPositionAllowed = isAdPositionAllowed;\nexports.getAdContainer = getAdContainer;\nexports.getAmpAdResourceId = getAmpAdResourceId;\n\nvar _style = require(\"./style\");\n\nvar _log = require(\"./log\");\n\nvar _service = require(\"./service\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar AD_CONTAINER_PROP = '__AMP__AD_CONTAINER';\n/**\n * Tags that are allowed to have fixed positioning\n * @const {!Object<string, boolean>}\n */\n\nvar CONTAINERS = {\n  'AMP-FX-FLYING-CARPET': true,\n  'AMP-LIGHTBOX': true,\n  'AMP-STICKY-AD': true,\n  'AMP-LIGHTBOX-GALLERY': true\n};\n/**\n * Determines if an element is fixed-positioned.\n * OK to use, because it's only called from onLayoutMeasure\n * @param {!Element} el\n * @param {!Window} win\n * @return {boolean}\n */\n\nfunction isPositionFixed(el, win) {\n  var _computedStyle = (0, _style.computedStyle)(win, el),\n      position = _computedStyle.position; // We consider sticky positions as fixed, since they can be fixed.\n\n\n  return position == 'fixed' || position == 'sticky';\n}\n/**\n * @param {!Element} element\n * @param {!Window} win\n * @return {boolean} whether the element position is allowed. If the element\n * belongs to CONTAINERS, it is allowed to be position fixed.\n * If the element has a position fixed ancestor, it is not allowed.\n * This should only be called when a layout on the page was just forced\n * anyway.\n */\n\n\nfunction isAdPositionAllowed(element, win) {\n  var hasFixedAncestor = false;\n  var containers = 0;\n  var el = element;\n\n  do {\n    if (CONTAINERS[el.tagName]) {\n      // The containers must not themselves be contained in a fixed-position\n      // element. Continue the search.\n      containers++;\n      hasFixedAncestor = false;\n    } else if (isPositionFixed((0, _log.dev)().assertElement(el), win)) {\n      // Because certain blessed elements may contain a position fixed\n      // container (which contain an ad), we continue to search the\n      // ancestry tree.\n      hasFixedAncestor = true;\n    }\n\n    el = el.parentElement;\n  } while (el && el.tagName != 'BODY');\n\n  return !hasFixedAncestor && containers <= 1;\n}\n/**\n * Returns the blessed container element tagName if the ad is contained by one.\n * This is called during layout measure.\n * @param {!Element} element\n * @return {?string}\n */\n\n\nfunction getAdContainer(element) {\n  if (element[AD_CONTAINER_PROP] === undefined) {\n    var el = element.parentElement;\n\n    while (el && el.tagName != 'BODY') {\n      if (CONTAINERS[el.tagName]) {\n        return element[AD_CONTAINER_PROP] = el.tagName;\n      }\n\n      el = el.parentElement;\n    }\n\n    element[AD_CONTAINER_PROP] = null;\n  }\n\n  return element[AD_CONTAINER_PROP];\n}\n/**\n * Gets the resource ID of the amp-ad element containing the passed node.\n * If there is no containing amp-ad tag, then null will be returned.\n * TODO(jonkeller): Investigate whether non-A4A use case is needed. Issue 11436\n * @param {!Element} node\n * @param {!Window} topWin\n * @return {?string}\n */\n\n\nfunction getAmpAdResourceId(node, topWin) {\n  try {\n    var frameParent = (0, _service.getParentWindowFrameElement)(node, topWin).parentElement;\n\n    if (frameParent.nodeName == 'AMP-AD') {\n      return String(frameParent.getResourceId());\n    }\n  } catch (e) {} // Whether we entered the catch above (e.g. due to attempt to access\n  // across xdomain boundary), or failed to enter the if further above, the\n  // node is not within a friendly amp-ad tag. So, there is no amp-ad\n  // resource ID. How to handle that is up to the caller, but see TODO above.\n\n\n  return null;\n}\n\n},{\"./log\":68,\"./service\":79,\"./style\":128}],26:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.AmpEvents = void 0;\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Common AMP events.\n * @enum {string}\n */\nvar AmpEvents = {\n  DOM_UPDATE: 'amp:dom-update',\n  FORM_DIRTINESS_CHANGE: 'amp:form-dirtiness-change',\n  FORM_VALUE_CHANGE: 'amp:form-value-change',\n  VISIBILITY_CHANGE: 'amp:visibilitychange',\n  // https://github.com/ampproject/amphtml/blob/master/ads/README.md#page-visibility\n  // The following codes are only used for testing.\n  // TODO(choumx): Move these to a separate enum so they can be DCE'd.\n  ATTACHED: 'amp:attached',\n  STUBBED: 'amp:stubbed',\n  LOAD_START: 'amp:load:start',\n  LOAD_END: 'amp:load:end',\n  ERROR: 'amp:error',\n  SIZE_CHANGED: 'amp:size-changed'\n};\nexports.AmpEvents = AmpEvents;\n\n},{}],27:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.triggerAnalyticsEvent = triggerAnalyticsEvent;\n\nvar _services = require(\"./services\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Helper method to trigger analytics event if amp-analytics is available.\n * TODO: Do not expose this function\n * @param {!Element} target\n * @param {string} eventType\n * @param {!JsonObject=} opt_vars A map of vars and their values.\n */\nfunction triggerAnalyticsEvent(target, eventType, opt_vars) {\n  _services.Services.analyticsForDocOrNull(target).then(function (analytics) {\n    if (!analytics) {\n      return;\n    }\n\n    analytics.triggerEventForTarget(target, eventType, opt_vars);\n  });\n}\n\n},{\"./services\":123}],28:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.Animation = void 0;\n\nvar _promise = require(\"./utils/promise\");\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _curve = require(\"./curve\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG_ = 'Animation';\n\nvar NOOP_CALLBACK = function NOOP_CALLBACK() {};\n/**\n * The animation class allows construction of arbitrary animation processes.\n * The main method is \"add\" that adds a segment of animation at particular\n * time offset (delay) and duration. All animation segments are simply functions\n * of type Transition which are iterated from 0 to 1 in animation frames to\n * achieve the desired effect.\n */\n\n\nvar Animation =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates and starts animation with a single segment. Returns AnimationPlayer\n   * object that can be used to monitor or control animation.\n   *\n   * @param {!Node} contextNode The context node.\n   * @param {!TransitionDef<?>} transition Transition to animate.\n   * @param {./time.timeDef} duration Duration in milliseconds.\n   * @param {(!./curve.CurveDef|string)=} opt_curve Optional curve to use for\n   *   animation. Default is the linear animation.\n   * @return {!AnimationPlayer}\n   */\n  Animation.animate = function animate(contextNode, transition, duration, opt_curve) {\n    return new Animation(contextNode).setCurve(opt_curve).add(0, transition, 1).start(duration);\n  }\n  /**\n   * @param {!Node} contextNode\n   * @param {!./service/vsync-impl.Vsync=} opt_vsync\n   */\n  ;\n\n  function Animation(contextNode, opt_vsync) {\n    /** @private @const {!Node} */\n    this.contextNode_ = contextNode;\n    /** @private @const {!./service/vsync-impl.Vsync} */\n\n    this.vsync_ = opt_vsync || _services.Services.vsyncFor(self);\n    /** @private {?./curve.CurveDef} */\n\n    this.curve_ = null;\n    /**\n     * @private @const {!Array<!SegmentDef>}\n     */\n\n    this.segments_ = [];\n  }\n  /**\n   * Sets the default curve for the animation. Each segment is allowed to have\n   * its own curve, but this curve will be used if a segment doesn't specify\n   * its own.\n   * @param {!./curve.CurveDef|string|undefined} curve\n   * @return {!Animation}\n   */\n\n\n  var _proto = Animation.prototype;\n\n  _proto.setCurve = function setCurve(curve) {\n    if (curve) {\n      this.curve_ = (0, _curve.getCurve)(curve);\n    }\n\n    return this;\n  }\n  /**\n   * Adds a segment to the animation. Each segment starts at offset (delay) and\n   * runs for a portion of the overall animation (duration). Note that both\n   * delay and duration and normtimeDef types which accept values from 0 to 1.\n   * Optionally, the time is pushed through a curve. If curve is not specified,\n   * the default animation curve will be used. The specified transition is\n   * animated over the specified duration from 0 to 1.\n   *\n   * @param {./time.normtimeDef} delay\n   * @param {!TransitionDef<?>} transition\n   * @param {./time.normtimeDef} duration\n   * @param {(!./curve.CurveDef|string)=} opt_curve\n   * @return {!Animation}\n   */\n  ;\n\n  _proto.add = function add(delay, transition, duration, opt_curve) {\n    this.segments_.push({\n      delay: delay,\n      func: transition,\n      duration: duration,\n      curve: (0, _curve.getCurve)(opt_curve)\n    });\n    return this;\n  }\n  /**\n   * Starts the animation and returns the AnimationPlayer object that can be\n   * used to monitor and control the animation.\n   *\n   * @param {./time.timeDef} duration Absolute time in milliseconds.\n   * @return {!AnimationPlayer}\n   */\n  ;\n\n  _proto.start = function start(duration) {\n    var player = new AnimationPlayer(this.vsync_, this.contextNode_, this.segments_, this.curve_, duration);\n    return player;\n  };\n\n  return Animation;\n}();\n/**\n * AnimationPlayer allows tracking and monitoring of the running animation.\n * Most importantly it exposes methods \"then\" and \"thenAlways\" that have the\n * semantics of a Promise and signal when the animation completed or failed.\n * Additionally, it exposes the method \"halt\" which allows to stop/reset the\n * animation.\n * // TODO(@cramforce) Actually fully implement.\n * implements {IThenable}\n */\n\n\nexports.Animation = Animation;\n\nvar AnimationPlayer =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./service/vsync-impl.Vsync} vsync\n   * @param {!Node} contextNode\n   * @param {!Array<!SegmentDef>} segments\n   * @param {?./curve.CurveDef} defaultCurve\n   * @param {./time.timeDef} duration\n   */\n  function AnimationPlayer(vsync, contextNode, segments, defaultCurve, duration) {\n    /** @private @const {!./service/vsync-impl.Vsync} */\n    this.vsync_ = vsync;\n    /** @private @const {!Node} */\n\n    this.contextNode_ = contextNode;\n    /** @private @const {!Array<!SegmentRuntimeDef>} */\n\n    this.segments_ = [];\n\n    for (var i = 0; i < segments.length; i++) {\n      var segment = segments[i];\n      this.segments_.push({\n        delay: segment.delay,\n        func: segment.func,\n        duration: segment.duration,\n        curve: segment.curve || defaultCurve,\n        started: false,\n        completed: false\n      });\n    }\n    /** @private @const */\n\n\n    this.duration_ = duration;\n    /** @private {./time.timeDef} */\n\n    this.startTime_ = Date.now();\n    /** @private {./time.normtimeDef} */\n    // this.normLinearTime_ = 0;\n\n    /** @private {./time.normtimeDef} */\n    // this.normTime_ = 0;\n\n    /** @private {boolean} */\n\n    this.running_ = true;\n    /** @private {!Object<string, *>} */\n\n    this.state_ = {};\n    var deferred = new _promise.Deferred();\n    /** @const @private */\n\n    this.promise_ = deferred.promise;\n    /** @const @private */\n\n    this.resolve_ = deferred.resolve;\n    /** @const @private */\n\n    this.reject_ = deferred.reject;\n    /** @const */\n\n    this.task_ = this.vsync_.createAnimTask(this.contextNode_, {\n      mutate: this.stepMutate_.bind(this)\n    });\n\n    if (this.vsync_.canAnimate(this.contextNode_)) {\n      this.task_(this.state_);\n    } else {\n      (0, _log.dev)().warn(TAG_, 'cannot animate');\n      this.complete_(\n      /* success */\n      false,\n      /* dir */\n      0);\n    }\n  }\n  /**\n   * Chains to the animation's promise that will resolve when the animation has\n   * completed or will reject if animation has failed or was interrupted.\n   * @param {!Function=} opt_resolve\n   * @param {!Function=} opt_reject\n   * @return {!Promise}\n   */\n\n\n  var _proto2 = AnimationPlayer.prototype;\n\n  _proto2.then = function then(opt_resolve, opt_reject) {\n    if (!opt_resolve && !opt_reject) {\n      return this.promise_;\n    }\n\n    return this.promise_.then(opt_resolve, opt_reject);\n  }\n  /**\n   * Callback for regardless whether the animation succeeds or fails.\n   * @param {!Function=} opt_callback\n   * @return {!Promise}\n   */\n  ;\n\n  _proto2.thenAlways = function thenAlways(opt_callback) {\n    var callback = opt_callback || NOOP_CALLBACK;\n    return this.then(callback, callback);\n  }\n  /**\n   * Halts the animation. Depending on the opt_dir value, the following actions\n   * can be performed:\n   * 0: No action. The state will be as at the moment of halting (default)\n   * 1: Final state. Transitionable will be set to state = 1.\n   * -1: Reset state. Transitionable will be reset to state = 0.\n   * The animation's promise will be rejected since the transition has been\n   * interrupted.\n   * @param {number=} opt_dir\n   */\n  ;\n\n  _proto2.halt = function halt(opt_dir) {\n    this.complete_(\n    /* success */\n    false,\n    /* dir */\n    opt_dir || 0);\n  }\n  /**\n   * @param {boolean} success\n   * @param {number} dir\n   * @private\n   */\n  ;\n\n  _proto2.complete_ = function complete_(success, dir) {\n    if (!this.running_) {\n      return;\n    }\n\n    this.running_ = false;\n\n    if (dir != 0) {\n      // Sort in the completion order.\n      if (this.segments_.length > 1) {\n        this.segments_.sort(function (s1, s2) {\n          return s1.delay + s1.duration - (s2.delay + s2.duration);\n        });\n      }\n\n      try {\n        if (dir > 0) {\n          // Natural order - all set to 1.\n          for (var i = 0; i < this.segments_.length; i++) {\n            this.segments_[i].func(1, true);\n          }\n        } else {\n          // Reverse order - all set to 0.\n          for (var _i = this.segments_.length - 1; _i >= 0; _i--) {\n            this.segments_[_i].func(0, false);\n          }\n        }\n      } catch (e) {\n        (0, _log.dev)().error(TAG_, 'completion failed: ' + e, e);\n        success = false;\n      }\n    }\n\n    if (success) {\n      this.resolve_();\n    } else {\n      this.reject_();\n    }\n  }\n  /**\n   * @param {!Object<string, *>} unusedState\n   * @private\n   */\n  ;\n\n  _proto2.stepMutate_ = function stepMutate_(unusedState) {\n    if (!this.running_) {\n      return;\n    }\n\n    var currentTime = Date.now();\n    var normLinearTime = Math.min((currentTime - this.startTime_) / this.duration_, 1); // Start segments due to be started\n\n    for (var i = 0; i < this.segments_.length; i++) {\n      var segment = this.segments_[i];\n\n      if (!segment.started && normLinearTime >= segment.delay) {\n        segment.started = true;\n      }\n    } // Execute all pending segments.\n\n\n    for (var _i2 = 0; _i2 < this.segments_.length; _i2++) {\n      var _segment = this.segments_[_i2];\n\n      if (!_segment.started || _segment.completed) {\n        continue;\n      }\n\n      this.mutateSegment_(_segment, normLinearTime);\n    } // Complete or start next cycle.\n\n\n    if (normLinearTime == 1) {\n      this.complete_(\n      /* success */\n      true,\n      /* dir */\n      0);\n    } else {\n      if (this.vsync_.canAnimate(this.contextNode_)) {\n        this.task_(this.state_);\n      } else {\n        (0, _log.dev)().warn(TAG_, 'cancel animation');\n        this.complete_(\n        /* success */\n        false,\n        /* dir */\n        0);\n      }\n    }\n  }\n  /**\n   * @param {!SegmentRuntimeDef} segment\n   * @param {number} totalLinearTime\n   */\n  ;\n\n  _proto2.mutateSegment_ = function mutateSegment_(segment, totalLinearTime) {\n    var normLinearTime;\n    var normTime;\n\n    if (segment.duration > 0) {\n      normLinearTime = Math.min((totalLinearTime - segment.delay) / segment.duration, 1);\n      normTime = normLinearTime;\n\n      if (segment.curve && normTime != 1) {\n        try {\n          normTime = segment.curve(normLinearTime);\n        } catch (e) {\n          (0, _log.dev)().error(TAG_, 'step curve failed: ' + e, e);\n          this.complete_(\n          /* success */\n          false,\n          /* dir */\n          0);\n          return;\n        }\n      }\n    } else {\n      normLinearTime = 1;\n      normTime = 1;\n    }\n\n    if (normLinearTime == 1) {\n      segment.completed = true;\n    }\n\n    try {\n      segment.func(normTime, segment.completed);\n    } catch (e) {\n      (0, _log.dev)().error(TAG_, 'step mutate failed: ' + e, e);\n      this.complete_(\n      /* success */\n      false,\n      /* dir */\n      0);\n      return;\n    }\n  };\n\n  return AnimationPlayer;\n}();\n/**\n * @typedef {{\n *   delay: ./time.normtimeDef,\n *   func: !TransitionDef,\n *   duration: ./time.normtimeDef,\n *   curve: ?./curve.CurveDef\n * }}\n */\n\n\nvar SegmentDef;\n/**\n * @typedef {{\n *   delay: ./time.normtimeDef,\n *   func: !TransitionDef,\n *   duration: ./time.normtimeDef,\n *   curve: ?./curve.CurveDef,\n *   started: boolean,\n *   completed: boolean\n * }}\n */\n\nvar SegmentRuntimeDef;\n\n},{\"./curve\":37,\"./log\":68,\"./services\":123,\"./utils/promise\":147}],29:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.BaseElement = void 0;\n\nvar _actionConstants = require(\"./action-constants\");\n\nvar _layout = require(\"./layout\");\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _eventHelper = require(\"./event-helper\");\n\nvar _mode = require(\"./mode\");\n\nvar _types = require(\"./types\");\n\nvar _preconnect = require(\"./preconnect\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Base class for all custom element implementations. Instead of inheriting\n * from Element this class has an Element. Among other things this allows\n * switching the element implementation when going from a stub to the full\n * implementation.\n *\n * The base class implements a set of lifecycle methods that are called by\n * the runtime as appropriate. These are mostly based on the custom element\n * lifecycle (See\n * https://developers.google.com/web/fundamentals/getting-started/primers/customelements)\n * and adding AMP style late loading to the mix.\n *\n * The complete lifecycle of a custom DOM element is:\n *\n *           ||\n *           || createdCallback\n *           ||\n *           \\/\n *    State: <NOT BUILT> <NOT UPGRADED> <NOT ATTACHED>\n *           ||\n *           || upgrade\n *           ||\n *           \\/\n *    State: <NOT BUILT> <NOT ATTACHED>\n *           ||\n *           || firstAttachedCallback\n *           ||\n *           \\/\n *    State: <NOT BUILT>\n *           ||\n *           || buildCallback\n *           || !getPlaceholder() => createPlaceholderCallback\n *           || preconnectCallback may be called N times after this, but only\n *           || after the doc becomes visible.\n *           || pauseCallback may be called N times after this.\n *           || resumeCallback may be called N times after this.\n *           ||\n *           \\/\n *    State: <BUILT>\n *           ||\n *           || layoutCallback        <==\n *           || (firstLayoutCompleted)  ||\n *           ||                         ||\n *           \\/                         || isRelayoutNeeded?\n *    State: <LAID OUT>                 ||\n *           ||                         ||\n *           ||                 =========\n *           ||\n *           || viewportCallback\n *           || unlayoutCallback may be called N times after this.\n *           ||\n *           \\/\n *    State: <IN VIEWPORT>\n *\n * The preconnectCallback is called when the systems thinks it is good\n * to preconnect to hosts needed by an element. It will never be called\n * before buildCallback and it might be called multiple times including\n * after layoutCallback.\n *\n * The pauseCallback is called when when the document becomes inactive, e.g.\n * when the user swipes away from the document, or when the element is no\n * longer being displayed, e.g. when the carousel slide slides out of view.\n * In these situations, any actively playing media should pause.\n *\n * The resumeCallback is called when when the document becomes active again\n * after becoming inactive, e.g. when the user swipes away from the document\n * and swipes back. In these situations, any paused media may begin playing\n * again, if user interaction is not required.\n * TODO(jridgewell) slide slides into view\n *\n * The createPlaceholderCallback is called if AMP didn't detect a provided\n * placeholder for the element, subclasses can override this to build and\n * return a dynamically created placeholder that AMP would append to the\n * element.\n *\n * The unlayoutCallback is called when the document becomes inactive, e.g.\n * when the user swipes away from the document, or another tab is focused.\n * In these situations, expensive memory and CPU resources should be freed.\n *\n * Additionally whenever the dimensions of an element might have changed\n * AMP remeasures its dimensions and calls `onLayoutMeasure` on the\n * element instance. This can be used to do additional style calculations\n * without triggering style recalculations.\n *\n * When the dimensions of an element has changed, the 'onMeasureChanged'\n * callback is called.\n *\n * For more details, see {@link custom-element.js}.\n *\n * Each method is called exactly once and overriding them in subclasses\n * is optional.\n */\nvar BaseElement =\n/*#__PURE__*/\nfunction () {\n  /** @param {!AmpElement} element */\n  function BaseElement(element) {\n    /** @public @const {!Element} */\n    this.element = element;\n    /*\n    \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  /  ____|\n     \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n      \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n       \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n        \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n     Any private property for BaseElement should be declared in\n    build-system/externs/amp.multipass.extern.js. This is so closure compiler\n    doesn't reuse the same symbol it would use in the core compilation unit for\n    the private property in the extensions compilation unit's private\n    properties.\n    */\n\n    /** @package {!Layout} */\n\n    this.layout_ = _layout.Layout.NODISPLAY;\n    /** @package {number} */\n\n    this.layoutWidth_ = -1;\n    /** @package {boolean} */\n\n    this.inViewport_ = false;\n    /** @public @const {!Window} */\n\n    this.win = (0, _types.toWin)(element.ownerDocument.defaultView);\n    /**\n     * Maps action name to struct containing the action handler and minimum\n     * trust required to invoke the handler.\n     * @private {?Object<string, {\n     *   handler: function(!./service/action-impl.ActionInvocation),\n     *   minTrust: ActionTrust,\n     * }>} */\n\n    this.actionMap_ = null;\n    /** @private {?string} */\n\n    this.defaultActionAlias_ = null;\n    /** @public {!./preconnect.Preconnect} */\n\n    this.preconnect = (0, _preconnect.preconnectForElement)(this.element);\n  }\n  /**\n   * The element's signal tracker.\n   * @return {!./utils/signals.Signals}\n   */\n\n\n  var _proto = BaseElement.prototype;\n\n  _proto.signals = function signals() {\n    return this.element.signals();\n  }\n  /**\n   * The element's default action alias.\n   * @return {?string}\n   */\n  ;\n\n  _proto.getDefaultActionAlias = function getDefaultActionAlias() {\n    return this.defaultActionAlias_;\n  }\n  /**\n   * This is the priority of loading elements (layoutCallback). Used only to\n   * determine layout timing and preloading priority. Does not affect build time,\n   * etc.\n   *\n   * The lower the number, the higher the priority.\n   *\n   * The default priority for base elements is LayoutPriority.CONTENT.\n   * @return {number}\n   */\n  ;\n\n  _proto.getLayoutPriority = function getLayoutPriority() {\n    return _layout.LayoutPriority.CONTENT;\n  }\n  /**\n   * Updates the priority of the resource. If there are tasks currently\n   * scheduled, their priority is updated as well.\n   *\n   * This method can be called any time when the new priority value is\n   * available. It's a restricted API and special review is required to\n   * allow individual extensions to request priority upgrade.\n   *\n   * @param {number} newLayoutPriority\n   * @restricted\n   */\n  ;\n\n  _proto.updateLayoutPriority = function updateLayoutPriority(newLayoutPriority) {\n    this.element.getResources().updateLayoutPriority(this.element, newLayoutPriority);\n  }\n  /** @return {!Layout} */\n  ;\n\n  _proto.getLayout = function getLayout() {\n    return this.layout_;\n  }\n  /**\n   * Returns a previously measured layout box adjusted to the viewport. This\n   * mainly affects fixed-position elements that are adjusted to be always\n   * relative to the document position in the viewport.\n   * @return {!./layout-rect.LayoutRectDef}\n   */\n  ;\n\n  _proto.getLayoutBox = function getLayoutBox() {\n    return this.element.getLayoutBox();\n  }\n  /**\n   * Returns a previously measured layout box relative to the page. The\n   * fixed-position elements are relative to the top of the document.\n   * @return {!./layout-rect.LayoutRectDef}\n   */\n  ;\n\n  _proto.getPageLayoutBox = function getPageLayoutBox() {\n    return this.element.getPageLayoutBox();\n  }\n  /**\n   * DO NOT CALL. Retained for backward compat during rollout.\n   * @public\n   * @return {!Window}\n   */\n  ;\n\n  _proto.getWin = function getWin() {\n    return this.win;\n  }\n  /**\n   * Returns the associated ampdoc. Only available when `buildCallback` and\n   * going forward. It throws an exception before `buildCallback`.\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  ;\n\n  _proto.getAmpDoc = function getAmpDoc() {\n    return this.element.getAmpDoc();\n  }\n  /**\n   * @public\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  ;\n\n  _proto.getVsync = function getVsync() {\n    return _services.Services.vsyncFor(this.win);\n  }\n  /**\n   * Returns the layout width for this element. A `-1` value indicates that the\n   * layout is not yet known. A `0` value indicates that the element is not\n   * visible.\n   * @return {number}\n   * @public\n   */\n  ;\n\n  _proto.getLayoutWidth = function getLayoutWidth() {\n    return this.layoutWidth_;\n  }\n  /**\n   * Returns the consent policy id that this element should wait for before\n   * buildCallback.\n   * A `null` value indicates to not be blocked by consent.\n   * Subclasses may override.\n   * @return {?string}\n   */\n  ;\n\n  _proto.getConsentPolicy = function getConsentPolicy() {\n    var policyId = null;\n\n    if (this.element.hasAttribute('data-block-on-consent')) {\n      policyId = this.element.getAttribute('data-block-on-consent') || 'default';\n    }\n\n    return policyId;\n  }\n  /**\n   * Intended to be implemented by subclasses. Tests whether the element\n   * supports the specified layout. By default only Layout.NODISPLAY is\n   * supported.\n   * @param {!Layout} layout\n   * @return {boolean}\n   * @public\n   */\n  ;\n\n  _proto.isLayoutSupported = function isLayoutSupported(layout) {\n    return layout == _layout.Layout.NODISPLAY;\n  }\n  /**\n   * Intended to be implemented by subclasses. Tests whether the element\n   * requires fixed positioning.\n   * @return {boolean}\n   * @public\n   */\n  ;\n\n  _proto.isAlwaysFixed = function isAlwaysFixed() {\n    return false;\n  }\n  /**\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isInViewport = function isInViewport() {\n    return this.inViewport_;\n  }\n  /**\n   * This method is called when the element is added to DOM for the first time\n   * and before `buildCallback` to give the element a chance to redirect its\n   * implementation to another `BaseElement` implementation. The returned\n   * value can be either `null` or `undefined` to indicate that no redirection\n   * will take place; `BaseElement` instance to upgrade immediately; or a\n   * promise to upgrade with the resolved `BaseElement` instance.\n   *\n   * Notice that calls to `upgradeCallback` are not recursive. I.e. this\n   * callback will not be called on the returned instance again.\n   *\n   * @return {!BaseElement|!Promise<!BaseElement>|null}\n   */\n  ;\n\n  _proto.upgradeCallback = function upgradeCallback() {\n    // Subclasses may override.\n    return null;\n  }\n  /**\n   * Called when the element is first created. Note that for element created\n   * using createElement this may be before any children are added.\n   */\n  ;\n\n  _proto.createdCallback = function createdCallback() {} // Subclasses may override.\n\n  /**\n   * Override in subclass to adjust the element when it is being added to the\n   * DOM. Could e.g. be used to insert a fallback. Should not typically start\n   * loading a resource.\n   */\n  ;\n\n  _proto.firstAttachedCallback = function firstAttachedCallback() {} // Subclasses may override.\n\n  /**\n   * Override in subclass if the element needs to rebuilt its DOM content.\n   * Until the element has been rebuilt its content are not shown with an only\n   * exception of [placeholder] elements. From the moment the element is created\n   * and until the building phase is complete it will have \"amp-notbuilt\" CSS\n   * class set on it.\n   *\n   * This callback is executed early after the element has been attached to DOM.\n   *\n   * This callback can either immediately return or return a promise if the\n   * build steps are asynchronous.\n   *\n   * @return {!Promise|undefined}\n   */\n  ;\n\n  _proto.buildCallback = function buildCallback() {} // Subclasses may override.\n\n  /**\n   * Called by the framework to give the element a chance to preconnect to\n   * hosts and prefetch resources it is likely to need. May be called\n   * multiple times because connections can time out.\n   * @param {boolean=} opt_onLayout\n   */\n  ;\n\n  _proto.preconnectCallback = function preconnectCallback(opt_onLayout) {} // Subclasses may override.\n\n  /**\n   * Override in subclass to adjust the element when it is being removed from\n   * the DOM. Could e.g. be used to remove a listener.\n   */\n  ;\n\n  _proto.detachedCallback = function detachedCallback() {} // Subclasses may override.\n\n  /**\n   * Subclasses can override this method to opt-in into being called to\n   * prerender when document itself is not yet visible (pre-render mode).\n   *\n   * The return value of this function is used to determine whether or not the\n   * element will be built _and_ laid out during prerender mode. Therefore, any\n   * changes to the return value _after_ buildCallback() will have no affect.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.prerenderAllowed = function prerenderAllowed() {\n    return false;\n  }\n  /**\n   * Subclasses can override this method to indicate that it is has\n   * render-blocking service.\n   *\n   * The return value of this function is used to determine if the element\n   * built _and_ laid out will be prioritized.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isBuildRenderBlocking = function isBuildRenderBlocking() {\n    return false;\n  }\n  /**\n   * Subclasses can override this method to create a dynamic placeholder\n   * element and return it to be appended to the element. This will only\n   * be called if the element doesn't already have a placeholder.\n   * @return {?Element}\n   */\n  ;\n\n  _proto.createPlaceholderCallback = function createPlaceholderCallback() {\n    return null;\n  }\n  /**\n   * Subclasses can override this method to provide a svg logo that will be\n   * displayed as the loader.\n   * @return {{\n   *  content: (!Element|undefined),\n   *  color: (string|undefined),\n   * }}\n   */\n  ;\n\n  _proto.createLoaderLogoCallback = function createLoaderLogoCallback() {\n    return {};\n  }\n  /**\n   * Subclasses can override this method to opt-out of rendering the element\n   * when it is not currently visible.\n   * Returning a boolean allows or prevents rendering outside the viewport at\n   * any distance, while returning a positive number allows rendering only when\n   * the element is within X viewports of the current viewport. Returning a\n   * zero causes the element to only render inside the viewport.\n   * @return {boolean|number}\n   */\n  ;\n\n  _proto.renderOutsideViewport = function renderOutsideViewport() {\n    // Inabox allow layout independent of viewport location.\n    return (0, _mode.getMode)(this.win).runtime == 'inabox' || 3;\n  }\n  /**\n   * Allows for rendering outside of the constraint set by renderOutsideViewport\n   * so long task scheduler is idle.  Integer values less than those returned\n   * by renderOutsideViewport have no effect.  Subclasses can override (default\n   * is disabled).\n   * @return {boolean|number}\n   */\n  ;\n\n  _proto.idleRenderOutsideViewport = function idleRenderOutsideViewport() {\n    return false;\n  }\n  /**\n   * Subclasses can override this method to opt-in into receiving additional\n   * {@link layoutCallback} calls. Note that this method is not consulted for\n   * the first layout given that each element must be laid out at least once.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isRelayoutNeeded = function isRelayoutNeeded() {\n    return false;\n  }\n  /**\n   * Called when the element should perform layout. At this point the element\n   * should load/reload resources associated with it. This method is called\n   * by the runtime and cannot be called manually. Returns promise that will\n   * complete when loading is considered to be complete.\n   *\n   * The first layout call is always called. If the subclass is interested in\n   * receiving additional callbacks, it has to opt in to do so using\n   * {@link isRelayoutNeeded} method.\n   *\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.layoutCallback = function layoutCallback() {\n    return Promise.resolve();\n  }\n  /**\n   * Called to notify the element that the first layout has been successfully\n   * completed.\n   *\n   * The default behavior of this method is to hide the placeholder. However,\n   * a subclass may choose to hide placeholder earlier or not hide it at all.\n   *\n   * @public\n   */\n  ;\n\n  _proto.firstLayoutCompleted = function firstLayoutCompleted() {\n    this.togglePlaceholder(false);\n  }\n  /**\n   * Instructs the resource that it has either entered or exited the visible\n   * viewport. Intended to be implemented by actual components.\n   * @param {boolean} unusedInViewport\n   */\n  ;\n\n  _proto.viewportCallback = function viewportCallback(unusedInViewport) {}\n  /**\n   * Requests the element to stop its activity when the document goes into\n   * inactive state. The scope is up to the actual component. Among other\n   * things the active playback of video or audio content must be stopped.\n   */\n  ;\n\n  _proto.pauseCallback = function pauseCallback() {}\n  /**\n   * Requests the element to resume its activity when the document returns from\n   * an inactive state. The scope is up to the actual component. Among other\n   * things the active playback of video or audio content may be resumed.\n   */\n  ;\n\n  _proto.resumeCallback = function resumeCallback() {}\n  /**\n   * Requests the element to unload any expensive resources when the element\n   * goes into non-visible state. The scope is up to the actual component.\n   * The component must return `true` if it'd like to later receive\n   * {@link layoutCallback} in case document becomes active again.\n   *\n   * @return {boolean}\n   */\n  ;\n\n  _proto.unlayoutCallback = function unlayoutCallback() {\n    return false;\n  }\n  /**\n   * Subclasses can override this method to opt-in into calling\n   * {@link unlayoutCallback} when paused.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.unlayoutOnPause = function unlayoutOnPause() {\n    return false;\n  }\n  /**\n   * Whether the element needs to be reconstructed after it has been\n   * re-parented. Many elements cannot survive fully the reparenting and\n   * are better to be reconstructed from scratch.\n   *\n   * An example of an element that should be reconstructed in a iframe-based\n   * element. Reparenting such an element will cause the iframe to reload and\n   * will lost the previously established connection. It's safer to reconstruct\n   * such an element. An image or the other hand does not need to be\n   * reconstructed since image itself is not reloaded by the browser and thus\n   * there's no need to use additional resources for reconstruction.\n   *\n   * @return {boolean}\n   */\n  ;\n\n  _proto.reconstructWhenReparented = function reconstructWhenReparented() {\n    return true;\n  }\n  /**\n   * Returns a promise that will resolve or fail based on the element's 'load'\n   * and 'error' events.\n   * @param {T} element\n   * @return {!Promise<T>}\n   * @template T\n   * @final\n   */\n  ;\n\n  _proto.loadPromise = function loadPromise(element) {\n    return (0, _eventHelper.loadPromise)(element);\n  }\n  /** @private */\n  ;\n\n  _proto.initActionMap_ = function initActionMap_() {\n    if (!this.actionMap_) {\n      this.actionMap_ = this.win.Object.create(null);\n    }\n  }\n  /**\n   * Registers the action handler for the method with the specified name.\n   *\n   * The handler is only invoked by events with trust equal to or greater than\n   * `minTrust`. Otherwise, a user error is logged.\n   *\n   * @param {string} alias\n   * @param {function(!./service/action-impl.ActionInvocation)} handler\n   * @param {ActionTrust} minTrust\n   * @public\n   */\n  ;\n\n  _proto.registerAction = function registerAction(alias, handler, minTrust) {\n    if (minTrust === void 0) {\n      minTrust = _actionConstants.ActionTrust.HIGH;\n    }\n\n    this.initActionMap_();\n    this.actionMap_[alias] = {\n      handler: handler,\n      minTrust: minTrust\n    };\n  }\n  /**\n   * Registers the default action for this component.\n   * @param {function(!./service/action-impl.ActionInvocation)} handler\n   * @param {string=} alias\n   * @param {ActionTrust=} minTrust\n   * @public\n   */\n  ;\n\n  _proto.registerDefaultAction = function registerDefaultAction(handler, alias, minTrust) {\n    if (alias === void 0) {\n      alias = _actionConstants.DEFAULT_ACTION;\n    }\n\n    if (minTrust === void 0) {\n      minTrust = _actionConstants.ActionTrust.HIGH;\n    }\n\n    (0, _log.devAssert)(!this.defaultActionAlias_, 'Default action \"%s\" already registered.', this.defaultActionAlias_);\n    this.registerAction(alias, handler, minTrust);\n    this.defaultActionAlias_ = alias;\n  }\n  /**\n   * Requests the element to execute the specified method. If method must have\n   * been previously registered using {@link registerAction}, otherwise an\n   * error is thrown.\n   * @param {!./service/action-impl.ActionInvocation} invocation The invocation data.\n   * @param {boolean=} unusedDeferred Whether the invocation has had to wait any time\n   *   for the element to be resolved, upgraded and built.\n   * @final\n   * @package\n   * @return {*} TODO(#23582): Specify return type\n   */\n  ;\n\n  _proto.executeAction = function executeAction(invocation, unusedDeferred) {\n    var method = invocation.method; // If the default action has an alias, the handler will be stored under it.\n\n    if (method === _actionConstants.DEFAULT_ACTION) {\n      method = this.defaultActionAlias_ || method;\n    }\n\n    this.initActionMap_();\n    var holder = this.actionMap_[method];\n    var tagName = this.element.tagName;\n    (0, _log.userAssert)(holder, \"Method not found: \" + method + \" in \" + tagName);\n    var handler = holder.handler,\n        minTrust = holder.minTrust;\n\n    if (invocation.satisfiesTrust(minTrust)) {\n      return handler(invocation);\n    }\n  }\n  /**\n   * Utility method that propagates attributes from this element\n   * to the given element.\n   * If `opt_removeMissingAttrs` is true, then also removes any specified\n   * attributes that are missing on this element from the target element.\n   * @param {string|!Array<string>} attributes\n   * @param {!Element} element\n   * @param {boolean=} opt_removeMissingAttrs\n   * @public @final\n   */\n  ;\n\n  _proto.propagateAttributes = function propagateAttributes(attributes, element, opt_removeMissingAttrs) {\n    attributes = (0, _types.isArray)(attributes) ? attributes : [attributes];\n\n    for (var i = 0; i < attributes.length; i++) {\n      var attr = attributes[i];\n      var val = this.element.getAttribute(attr);\n\n      if (null !== val) {\n        element.setAttribute(attr, val);\n      } else if (opt_removeMissingAttrs) {\n        element.removeAttribute(attr);\n      }\n    }\n  }\n  /**\n   * Utility method that forwards the given list of non-bubbling events\n   * from the given element to this element as custom events with the same name.\n   * @param  {string|!Array<string>} events\n   * @param  {!Element} element\n   * @public @final\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.forwardEvents = function forwardEvents(events, element) {\n    var _this = this;\n\n    var unlisteners = ((0, _types.isArray)(events) ? events : [events]).map(function (eventType) {\n      return (0, _eventHelper.listen)(element, eventType, function (event) {\n        _this.element.dispatchCustomEvent(eventType, (0, _eventHelper.getData)(event) || {});\n      });\n    });\n    return function () {\n      return unlisteners.forEach(function (unlisten) {\n        return unlisten();\n      });\n    };\n  }\n  /**\n   * Returns an optional placeholder element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  ;\n\n  _proto.getPlaceholder = function getPlaceholder() {\n    return this.element.getPlaceholder();\n  }\n  /**\n   * Hides or shows the placeholder, if available.\n   * @param {boolean} state\n   * @public @final\n   */\n  ;\n\n  _proto.togglePlaceholder = function togglePlaceholder(state) {\n    this.element.togglePlaceholder(state);\n  }\n  /**\n   * Returns an optional fallback element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  ;\n\n  _proto.getFallback = function getFallback() {\n    return this.element.getFallback();\n  }\n  /**\n   * Hides or shows the fallback, if available. This function must only\n   * be called inside a mutate context.\n   * @param {boolean} state\n   * @public @final\n   */\n  ;\n\n  _proto.toggleFallback = function toggleFallback(state) {\n    this.element.toggleFallback(state);\n  }\n  /**\n   * Hides or shows the loading indicator. This function must only\n   * be called inside a mutate context.\n   * @param {boolean} state\n   * @param {boolean=} opt_force\n   * @public @final\n   */\n  ;\n\n  _proto.toggleLoading = function toggleLoading(state, opt_force) {\n    this.element.toggleLoading(state, {\n      force: !!opt_force\n    });\n  }\n  /**\n   * Returns whether the loading indicator is reused again after the first\n   * render.\n   * @return {boolean}\n   * @public\n   */\n  ;\n\n  _proto.isLoadingReused = function isLoadingReused() {\n    return false;\n  }\n  /**\n   * Returns an optional overflow element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  ;\n\n  _proto.getOverflowElement = function getOverflowElement() {\n    return this.element.getOverflowElement();\n  }\n  /**\n   * An implementation can call this method to signal to the element that\n   * it has started rendering.\n   */\n  ;\n\n  _proto.renderStarted = function renderStarted() {\n    this.element.renderStarted();\n  }\n  /**\n   * Returns the original nodes of the custom element without any service nodes\n   * that could have been added for markup. These nodes can include Text,\n   * Comment and other child nodes.\n   * @return {!Array<!Node>}\n   * @public @final\n   */\n  ;\n\n  _proto.getRealChildNodes = function getRealChildNodes() {\n    return this.element.getRealChildNodes();\n  }\n  /**\n   * Returns the original children of the custom element without any service\n   * nodes that could have been added for markup.\n   * @return {!Array<!Element>}\n   * @public @final\n   */\n  ;\n\n  _proto.getRealChildren = function getRealChildren() {\n    return this.element.getRealChildren();\n  }\n  /**\n   * Configures the supplied element to have a \"fill content\" layout. The\n   * exact interpretation of \"fill content\" depends on the element's layout.\n   *\n   * If `opt_replacedContent` is specified, it indicates whether the \"replaced\n   * content\" styling should be applied. Replaced content is not allowed to\n   * have its own paddings or border.\n   *\n   * @param {!Element} element\n   * @param {boolean=} opt_replacedContent\n   * @public @final\n   */\n  ;\n\n  _proto.applyFillContent = function applyFillContent(element, opt_replacedContent) {\n    element.classList.add('i-amphtml-fill-content');\n\n    if (opt_replacedContent) {\n      element.classList.add('i-amphtml-replaced-content');\n    }\n  }\n  /**\n   * Returns the viewport within which the element operates.\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  ;\n\n  _proto.getViewport = function getViewport() {\n    return _services.Services.viewportForDoc(this.getAmpDoc());\n  }\n  /**\n   * Returns the layout rectangle used for when calculating this element's\n   * intersection with the viewport.\n   * @return {!./layout-rect.LayoutRectDef}\n   */\n  ;\n\n  _proto.getIntersectionElementLayoutBox = function getIntersectionElementLayoutBox() {\n    return this.getLayoutBox();\n  }\n  /**\n   * Requests the runtime to update the height of this element to the specified\n   * value. The runtime will schedule this request and attempt to process it\n   * as soon as possible.\n   * @param {number} newHeight\n   * @public\n   */\n  ;\n\n  _proto.changeHeight = function changeHeight(newHeight) {\n    this.element.getResources().\n    /*OK*/\n    changeSize(this.element, newHeight,\n    /* newWidth */\n    undefined);\n  }\n  /**\n   * Collapses the element, setting it to `display: none`, and notifies its\n   * owner (if there is one) through {@link collapsedCallback} that the element\n   * is no longer visible.\n   */\n  ;\n\n  _proto.collapse = function collapse() {\n    this.element.getResources().collapseElement(this.element);\n  }\n  /**\n   * Return a promise that request the runtime to collapse one element\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.attemptCollapse = function attemptCollapse() {\n    return this.element.getResources().attemptCollapse(this.element);\n  }\n  /**\n   * Return a promise that requests the runtime to update\n   * the height of this element to the specified value.\n   * The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeHeight}, the runtime\n   * may refuse to make a change in which case it will show the element's\n   * overflow element if provided, which is supposed to provide the reader with\n   * the necessary user action. (The overflow element is shown only if the\n   * requested height is greater than 0.)\n   * The promise is resolved if the height is successfully updated.\n   * @param {number} newHeight\n   * @return {!Promise}\n   * @public\n   */\n  ;\n\n  _proto.attemptChangeHeight = function attemptChangeHeight(newHeight) {\n    return this.element.getResources().attemptChangeSize(this.element, newHeight,\n    /* newWidth */\n    undefined);\n  }\n  /**\n   * Return a promise that requests the runtime to update\n   * the size of this element to the specified value.\n   * The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeSize}, the runtime\n   * may refuse to make a change in which case it will show the element's\n   * overflow element if provided, which is supposed to provide the reader with\n   * the necessary user action. (The overflow element is shown only if the\n   * requested height is greater than 0.)\n   * The promise is resolved if the height is successfully updated.\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {?Event=} opt_event\n   * @return {!Promise}\n   * @public\n   */\n  ;\n\n  _proto.attemptChangeSize = function attemptChangeSize(newHeight, newWidth, opt_event) {\n    return this.element.getResources().attemptChangeSize(this.element, newHeight, newWidth,\n    /* newMargin */\n    undefined, opt_event);\n  }\n  /**\n   * Runs the specified measure, which is called in the \"measure\" vsync phase.\n   * This is simply a proxy to the privileged vsync service.\n   *\n   * @param {function()} measurer\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.measureElement = function measureElement(measurer) {\n    return this.element.getResources().measureElement(measurer);\n  }\n  /**\n   * Runs the specified mutation on the element and ensures that remeasures and\n   * layouts are performed for the affected elements.\n   *\n   * This method should be called whenever a significant mutations are done\n   * on the DOM that could affect layout of elements inside this subtree or\n   * its siblings. The top-most affected element should be specified as the\n   * first argument to this method and all the mutation work should be done\n   * in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {function()} mutator\n   * @param {Element=} opt_element\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.mutateElement = function mutateElement(mutator, opt_element) {\n    return this.measureMutateElement(null, mutator, opt_element);\n  }\n  /**\n   * Runs the specified measure, then runs the mutation on the element and\n   * ensures that remeasures and layouts are performed for the affected\n   * elements.\n   *\n   * This method should be called whenever a measure and significant mutations\n   * are done on the DOM that could affect layout of elements inside this\n   * subtree or its siblings. The top-most affected element should be specified\n   * as the first argument to this method and all the mutation work should be\n   * done in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {?function()} measurer\n   * @param {function()} mutator\n   * @param {Element=} opt_element\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.measureMutateElement = function measureMutateElement(measurer, mutator, opt_element) {\n    return this.element.getResources().measureMutateElement(opt_element || this.element, measurer, mutator);\n  }\n  /**\n   * Called every time an owned AmpElement collapses itself.\n   * See {@link collapse}.\n   * @param {!AmpElement} unusedElement Child element that was collapsed.\n   */\n  ;\n\n  _proto.collapsedCallback = function collapsedCallback(unusedElement) {} // Subclasses may override.\n\n  /**\n   * Expands the element, resetting its default display value, and notifies its\n   * owner (if there is one) through {@link expandedCallback} that the element\n   * is no longer visible.\n   */\n  ;\n\n  _proto.expand = function expand() {\n    this.element.getResources().expandElement(this.element);\n  }\n  /**\n   * Called every time an owned AmpElement expands itself.\n   * See {@link expand}.\n   * @param {!AmpElement} unusedElement Child element that was expanded.\n   */\n  ;\n\n  _proto.expandedCallback = function expandedCallback(unusedElement) {} // Subclasses may override.\n\n  /**\n   * Called when one or more attributes are mutated.\n   * Note:\n   * - Must be called inside a mutate context.\n   * - Boolean attributes have a value of `true` and `false` when\n   *       present and missing, respectively.\n   * @param {\n   *   !JsonObject<string, (null|boolean|string|number|Array|Object)>\n   * } unusedMutations\n   */\n  ;\n\n  _proto.mutatedAttributesCallback = function mutatedAttributesCallback(unusedMutations) {} // Subclasses may override.\n\n  /**\n   * Called when we just measured the layout rect of this element. Doing\n   * more expensive style reads should now be cheap.\n   * This may currently not work with extended elements. Please file\n   * an issue if that is required.\n   * @public\n   */\n  ;\n\n  _proto.onLayoutMeasure = function onLayoutMeasure() {}\n  /**\n   * Called only when the measurements of an amp-element changes. This\n   * would not trigger for every measurement invalidation caused by a mutation.\n   * @public\n   */\n  ;\n\n  _proto.onMeasureChanged = function onMeasureChanged() {}\n  /**\n   * @return {./log.Log}\n   */\n  ;\n\n  _proto.user = function user() {\n    return (0, _log.user)(this.element);\n  };\n\n  return BaseElement;\n}();\n\nexports.BaseElement = BaseElement;\n\n},{\"./action-constants\":23,\"./event-helper\":46,\"./layout\":66,\"./log\":68,\"./mode\":70,\"./preconnect\":77,\"./services\":123,\"./types\":131}],30:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.startupChunk = startupChunk;\nexports.chunk = chunk;\nexports.chunkInstanceForTesting = chunkInstanceForTesting;\nexports.deactivateChunking = deactivateChunking;\nexports.activateChunkingForTesting = activateChunkingForTesting;\nexports.runChunksForTesting = runChunksForTesting;\nexports.onIdle = onIdle;\nexports.ChunkPriority = void 0;\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _eventHelper = require(\"./event-helper\");\n\nvar _service = require(\"./service\");\n\nvar _experiments = require(\"./experiments\");\n\nvar _styleInstaller = require(\"./style-installer\");\n\nvar _priorityQueue = _interopRequireDefault(require(\"./utils/priority-queue\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/**\n * @const {string}\n */\nvar TAG = 'CHUNK';\n/**\n * @type {boolean}\n */\n\nvar deactivated = /nochunking=1/.test(self.location.hash);\n/**\n * @const {!Promise}\n */\n\nvar resolved = Promise.resolve();\n/**\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @return {!Chunks}\n * @private\n */\n\nfunction chunkServiceForDoc(elementOrAmpDoc) {\n  (0, _service.registerServiceBuilderForDoc)(elementOrAmpDoc, 'chunk', Chunks);\n  return (0, _service.getServiceForDoc)(elementOrAmpDoc, 'chunk');\n}\n/**\n * Run the given function. For visible documents the function will be\n * called in a micro task (Essentially ASAP). If the document is\n * not visible, tasks will yield to the event loop (to give the browser\n * time to do other things) and may even be further delayed until\n * there is time.\n *\n * @param {!Document|!./service/ampdoc-impl.AmpDoc} doc\n * @param {function(?IdleDeadline)} fn\n * @param {boolean=} opt_makesBodyVisible Pass true if this service makes\n *     the body visible. This is relevant because it may influence the\n *     task scheduling strategy.\n */\n\n\nfunction startupChunk(doc, fn, opt_makesBodyVisible) {\n  if (deactivated) {\n    resolved.then(fn);\n    return;\n  }\n\n  var service = chunkServiceForDoc(doc.documentElement || doc);\n  service.runForStartup(fn);\n\n  if (opt_makesBodyVisible) {\n    service.runForStartup(function () {\n      service.bodyIsVisible_ = true;\n    });\n  }\n}\n/**\n * Run the given function sometime in the future without blocking UI.\n *\n * Higher priority tasks are executed before lower priority tasks.\n * Tasks with the same priority are executed in FIFO order.\n *\n * Uses `requestIdleCallback` if available and passes the `IdleDeadline`\n * object to the function, which can be used to perform a variable amount\n * of work depending on the remaining amount of idle time.\n *\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {function(?IdleDeadline)} fn\n * @param {ChunkPriority} priority\n */\n\n\nfunction chunk(elementOrAmpDoc, fn, priority) {\n  if (deactivated) {\n    resolved.then(fn);\n    return;\n  }\n\n  var service = chunkServiceForDoc(elementOrAmpDoc);\n  service.run(fn, priority);\n}\n/**\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @return {!Chunks}\n */\n\n\nfunction chunkInstanceForTesting(elementOrAmpDoc) {\n  return chunkServiceForDoc(elementOrAmpDoc);\n}\n/**\n * Use a standard micro task for every invocation. This should only\n * be called from the AMP bootstrap script if it is known that\n * chunking makes no sense. In particular this is the case when\n * AMP runs in the `amp-shadow` multi document mode.\n */\n\n\nfunction deactivateChunking() {\n  deactivated = true;\n}\n/**\n * @visibleForTesting\n */\n\n\nfunction activateChunkingForTesting() {\n  deactivated = false;\n}\n/**\n * Runs all currently scheduled chunks.\n * Independent of errors it will unwind the queue. Will afterwards\n * throw the first encountered error.\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n */\n\n\nfunction runChunksForTesting(elementOrAmpDoc) {\n  var service = chunkInstanceForTesting(elementOrAmpDoc);\n  var errors = [];\n\n  while (true) {\n    try {\n      if (!service.execute_(\n      /* idleDeadline */\n      null)) {\n        break;\n      }\n    } catch (e) {\n      errors.push(e);\n    }\n  }\n\n  if (errors.length) {\n    throw errors[0];\n  }\n}\n/**\n * The priority of a chunk task. Higher priority tasks have higher values.\n * @enum {number}\n */\n\n\nvar ChunkPriority = {\n  HIGH: 20,\n  LOW: 10,\n  BACKGROUND: 0\n};\n/** @enum {string} */\n\nexports.ChunkPriority = ChunkPriority;\nvar TaskState = {\n  NOT_RUN: 'not_run',\n  RUN: 'run'\n};\n/**\n * A default chunkable task.\n * @private\n */\n\nvar Task =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {function(?IdleDeadline)} fn\n   */\n  function Task(fn) {\n    /** @public {TaskState} */\n    this.state = TaskState.NOT_RUN;\n    /** @private @const {!function(?IdleDeadline)} */\n\n    this.fn_ = fn;\n  }\n  /**\n   * Executes the wrapped function.\n   * @param {?IdleDeadline} idleDeadline\n   * @throws {Error}\n   * @protected\n   */\n\n\n  var _proto = Task.prototype;\n\n  _proto.runTask_ = function runTask_(idleDeadline) {\n    if (this.state == TaskState.RUN) {\n      return;\n    }\n\n    this.state = TaskState.RUN;\n\n    try {\n      this.fn_(idleDeadline);\n    } catch (e) {\n      this.onTaskError_(e);\n      throw e;\n    }\n  }\n  /**\n   * @return {string}\n   * @protected\n   */\n  ;\n\n  _proto.getName_ = function getName_() {\n    return this.fn_.displayName || this.fn_.name;\n  }\n  /**\n   * Optional handling when a task run throws an error.\n   * @param {Error} unusedError\n   * @private\n   */\n  ;\n\n  _proto.onTaskError_ = function onTaskError_(unusedError) {} // By default, no-op.\n\n  /**\n   * Returns true if this task should be run without delay.\n   * @return {boolean}\n   * @protected\n   */\n  ;\n\n  _proto.immediateTriggerCondition_ = function immediateTriggerCondition_() {\n    // By default, there are no immediate trigger conditions.\n    return false;\n  }\n  /**\n   * Returns true if this task should be scheduled using `requestIdleCallback`.\n   * Otherwise, task is scheduled as macro-task on next event loop.\n   * @return {boolean}\n   * @protected\n   */\n  ;\n\n  _proto.useRequestIdleCallback_ = function useRequestIdleCallback_() {\n    // By default, never use requestIdleCallback.\n    return false;\n  };\n\n  return Task;\n}();\n/**\n * A task that's run as part of AMP's startup sequence.\n * @private\n */\n\n\nvar StartupTask =\n/*#__PURE__*/\nfunction (_Task) {\n  _inheritsLoose(StartupTask, _Task);\n\n  /**\n   * @param {function(?IdleDeadline)} fn\n   * @param {!Window} win\n   * @param {!Chunks} chunks\n   */\n  function StartupTask(fn, win, chunks) {\n    var _this;\n\n    _this = _Task.call(this, fn) || this;\n    /** @private @const */\n\n    _this.chunks_ = chunks;\n    return _this;\n  }\n  /** @override */\n\n\n  var _proto2 = StartupTask.prototype;\n\n  _proto2.onTaskError_ = function onTaskError_(unusedError) {\n    // Startup tasks run early in init. All errors should show the doc.\n    (0, _styleInstaller.makeBodyVisibleRecovery)(self.document);\n  }\n  /** @override */\n  ;\n\n  _proto2.immediateTriggerCondition_ = function immediateTriggerCondition_() {\n    // Run in a micro task when the doc is visible. Otherwise, run after\n    // having yielded to the event queue once.\n    return this.isVisible_();\n  }\n  /** @override */\n  ;\n\n  _proto2.useRequestIdleCallback_ = function useRequestIdleCallback_() {\n    // We only start using requestIdleCallback when the core runtime has\n    // been initialized. Otherwise we risk starving ourselves\n    // before the render-critical work is done.\n    return this.chunks_.coreReady_;\n  }\n  /**\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto2.isVisible_ = function isVisible_() {\n    return this.chunks_.ampdoc.isVisible();\n  };\n\n  return StartupTask;\n}(Task);\n/**\n * Handles queueing, scheduling and executing tasks.\n */\n\n\nvar Chunks =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n   */\n  function Chunks(ampDoc) {\n    var _this2 = this;\n\n    /** @protected @const {!./service/ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampDoc;\n    /** @private @const {!Window} */\n\n    this.win_ = ampDoc.win;\n    /** @private @const {!PriorityQueue<Task>} */\n\n    this.tasks_ = new _priorityQueue.default();\n    /** @private @const {function(?IdleDeadline)} */\n\n    this.boundExecute_ = this.execute_.bind(this);\n    /** @private {number} */\n\n    this.durationOfLastExecution_ = 0;\n    /** @private {boolean} */\n\n    this.macroAfterLongTask_ = (0, _experiments.isExperimentOn)(this.win_, 'macro-after-long-task');\n    /**\n     * Set to true if we scheduled a macro or micro task to execute the next\n     * task. If true, we don't schedule another one.\n     * Not set to true if we use rIC, because we always want to transition\n     * to immeditate invocation from that state.\n     * @private {boolean}\n     */\n\n    this.scheduledImmediateInvocation_ = false;\n    /** @private {boolean} Whether the document can actually be painted. */\n\n    this.bodyIsVisible_ = this.win_.document.documentElement.hasAttribute('i-amphtml-no-boilerplate');\n    this.win_.addEventListener('message', function (e) {\n      if ((0, _eventHelper.getData)(e) == 'amp-macro-task') {\n        _this2.execute_(\n        /* idleDeadline */\n        null);\n      }\n    });\n    /** @protected {boolean} */\n\n    this.coreReady_ = false;\n\n    _services.Services.viewerPromiseForDoc(ampDoc).then(function () {\n      // Once the viewer has been resolved, most of core runtime has been\n      // initialized as well.\n      _this2.coreReady_ = true;\n    });\n\n    ampDoc.onVisibilityChanged(function () {\n      if (ampDoc.isVisible()) {\n        _this2.schedule_();\n      }\n    });\n  }\n  /**\n   * Run fn as a \"chunk\".\n   * @param {function(?IdleDeadline)} fn\n   * @param {number} priority\n   */\n\n\n  var _proto3 = Chunks.prototype;\n\n  _proto3.run = function run(fn, priority) {\n    var t = new Task(fn);\n    this.enqueueTask_(t, priority);\n  }\n  /**\n   * Run a fn that's part of AMP's startup sequence as a \"chunk\".\n   * @param {function(?IdleDeadline)} fn\n   */\n  ;\n\n  _proto3.runForStartup = function runForStartup(fn) {\n    var t = new StartupTask(fn, this.win_, this);\n    this.enqueueTask_(t, Number.POSITIVE_INFINITY);\n  }\n  /**\n   * Queues a task to be executed later with given priority.\n   * @param {!Task} task\n   * @param {number} priority\n   * @private\n   */\n  ;\n\n  _proto3.enqueueTask_ = function enqueueTask_(task, priority) {\n    this.tasks_.enqueue(task, priority);\n    this.schedule_();\n  }\n  /**\n   * Returns the next task that hasn't been run yet.\n   * If `opt_dequeue` is true, remove the returned task from the queue.\n   * @param {boolean=} opt_dequeue\n   * @return {?Task}\n   * @private\n   */\n  ;\n\n  _proto3.nextTask_ = function nextTask_(opt_dequeue) {\n    var t = this.tasks_.peek(); // Dequeue tasks until we find one that hasn't been run yet.\n\n    while (t && t.state !== TaskState.NOT_RUN) {\n      this.tasks_.dequeue();\n      t = this.tasks_.peek();\n    } // If `opt_dequeue` is true, remove this task from the queue.\n\n\n    if (t && opt_dequeue) {\n      this.tasks_.dequeue();\n    }\n\n    return t;\n  }\n  /**\n   * Run a task.\n   * Schedule the next round if there are more tasks.\n   * @param {?IdleDeadline} idleDeadline\n   * @return {boolean} Whether anything was executed.\n   * @private\n   */\n  ;\n\n  _proto3.execute_ = function execute_(idleDeadline) {\n    var _this3 = this;\n\n    var t = this.nextTask_(\n    /* opt_dequeue */\n    true);\n\n    if (!t) {\n      this.scheduledImmediateInvocation_ = false;\n      this.durationOfLastExecution_ = 0;\n      return false;\n    }\n\n    var before;\n\n    try {\n      before = Date.now();\n      t.runTask_(idleDeadline);\n    } finally {\n      // We want to capture the time of the entire task duration including\n      // scheduled immediate (from resolved promises) micro tasks.\n      // Lacking a better way to do this we just scheduled 10 nested\n      // micro tasks.\n      resolved.then().then().then().then().then().then().then().then().then(function () {\n        _this3.scheduledImmediateInvocation_ = false;\n        _this3.durationOfLastExecution_ += Date.now() - before;\n        (0, _log.dev)().fine(TAG, t.getName_(), 'Chunk duration', Date.now() - before, _this3.durationOfLastExecution_);\n\n        _this3.schedule_();\n      });\n    }\n\n    return true;\n  }\n  /**\n   * Calls `execute_()` asynchronously.\n   * @param {?IdleDeadline} idleDeadline\n   * @private\n   */\n  ;\n\n  _proto3.executeAsap_ = function executeAsap_(idleDeadline) {\n    var _this4 = this;\n\n    // If we've spent over 5 millseconds executing the\n    // last instruction yeild back to the main thread.\n    // 5 milliseconds is a magic number.\n    if (this.macroAfterLongTask_ && this.bodyIsVisible_ && this.durationOfLastExecution_ > 5) {\n      this.durationOfLastExecution_ = 0;\n      this.requestMacroTask_();\n      return;\n    }\n\n    resolved.then(function () {\n      _this4.boundExecute_(idleDeadline);\n    });\n  }\n  /**\n   * Schedule running the next queued task.\n   * @private\n   */\n  ;\n\n  _proto3.schedule_ = function schedule_() {\n    if (this.scheduledImmediateInvocation_) {\n      return;\n    }\n\n    var nextTask = this.nextTask_();\n\n    if (!nextTask) {\n      return;\n    }\n\n    if (nextTask.immediateTriggerCondition_()) {\n      this.scheduledImmediateInvocation_ = true;\n      this.executeAsap_(\n      /* idleDeadline */\n      null);\n      return;\n    } // If requestIdleCallback exists, schedule a task with it, but\n    // do not wait longer than two seconds.\n\n\n    if (nextTask.useRequestIdleCallback_() && this.win_.requestIdleCallback) {\n      onIdle(this.win_, // Wait until we have a budget of at least 15ms.\n      // 15ms is a magic number. Budgets are higher when the user\n      // is completely idle (around 40), but that occurs too\n      // rarely to be usable. 15ms budgets can happen during scrolling\n      // but only if the device is doing super, super well, and no\n      // real processing is done between frames.\n      15\n      /* minimumTimeRemaining */\n      , 2000\n      /* timeout */\n      , this.boundExecute_);\n      return;\n    }\n\n    this.requestMacroTask_();\n  }\n  /**\n   * Requests executing of a macro task. Yields to the event queue\n   * before executing the task.\n   * Places task on browser message queue which then respectively\n   * triggers dequeuing and execution of a chunk.\n   */\n  ;\n\n  _proto3.requestMacroTask_ = function requestMacroTask_() {\n    // The message doesn't actually matter.\n    this.win_.\n    /*OK*/\n    postMessage('amp-macro-task', '*');\n  };\n\n  return Chunks;\n}();\n/**\n * Delays calling the given function until the browser is notifying us\n * about a certain minimum budget or the timeout is reached.\n * @param {!Window} win\n * @param {number} minimumTimeRemaining Minimum number of millis idle\n *     budget for callback to fire.\n * @param {number} timeout in millis for callback to fire.\n * @param {function(?IdleDeadline)} fn Callback.\n * @visibleForTesting\n */\n\n\nfunction onIdle(win, minimumTimeRemaining, timeout, fn) {\n  var startTime = Date.now();\n  /**\n   * @param {!IdleDeadline} info\n   */\n\n  function rIC(info) {\n    if (info.timeRemaining() < minimumTimeRemaining) {\n      var remainingTimeout = timeout - (Date.now() - startTime);\n\n      if (remainingTimeout <= 0 || info.didTimeout) {\n        (0, _log.dev)().fine(TAG, 'Timed out', timeout, info.didTimeout);\n        fn(info);\n      } else {\n        (0, _log.dev)().fine(TAG, 'Rescheduling with', remainingTimeout, info.timeRemaining());\n        win.requestIdleCallback(rIC, {\n          timeout: remainingTimeout\n        });\n      }\n    } else {\n      (0, _log.dev)().fine(TAG, 'Running idle callback with ', minimumTimeRemaining);\n      fn(info);\n    }\n  }\n\n  win.requestIdleCallback(rIC, {\n    timeout: timeout\n  });\n}\n\n},{\"./event-helper\":46,\"./experiments\":47,\"./log\":68,\"./service\":79,\"./services\":123,\"./style-installer\":127,\"./utils/priority-queue\":146}],31:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.CommonSignals = void 0;\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Commonly used signals across different elements and documents.\n * @enum {string}\n */\nvar CommonSignals = {\n  /**\n   * The element has been upgraded from ElementStub to its real implementation.\n   */\n  UPGRADED: 'upgraded',\n\n  /**\n   * The element has been built.\n   */\n  BUILT: 'built',\n\n  /**\n   * The element has started loading.\n   * LOAD_START triggers at the start of the layoutCallback.\n   */\n  LOAD_START: 'load-start',\n\n  /**\n   * Rendering has been confirmed to have been started.\n   * It is a signal to indicate meaningful display (e.g. text could be displayed\n   * CSS is correctly installed/applied).\n   *\n   * Elements can optionally implement RENDER_START signal. (e.g. ad, shadowdoc)\n   * if it want to define its own meaningful display time and toggle visibility.\n   *\n   * Simpler elements's RENDER_START can be equal to the start of the\n   * buildCallback\n   */\n  RENDER_START: 'render-start',\n\n  /**\n   * The element has been loaded.\n   * LOAD_END triggers at the end of the layoutCallback.\n   *\n   */\n  LOAD_END: 'load-end',\n\n  /**\n   * The initial contents of an element/document/embed have been loaded.\n   * INI_LOAD is an optional signal, implemented by ads, story, and elements\n   * that consist of other resources.\n   * It instructs that all critical resources has been loaded, and can be used\n   * for more accurate visibility measurement.\n   * When an element doesn't consist multiple child resources, LOAD_END signal\n   * can be used to indicate resource load completion.\n   * Note: Based on the implementation, INI_LOAD can trigger before or after\n   * LOAD_END.\n   */\n  INI_LOAD: 'ini-load',\n\n  /**\n   * The element has been unlaid out.\n   */\n  UNLOAD: 'unload'\n};\nexports.CommonSignals = CommonSignals;\n\n},{}],32:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.config = exports.urls = void 0;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nvar env = self.AMP_CONFIG || {};\nvar thirdPartyFrameRegex = typeof env['thirdPartyFrameRegex'] == 'string' ? new RegExp(env['thirdPartyFrameRegex']) : env['thirdPartyFrameRegex'];\nvar cdnProxyRegex = typeof env['cdnProxyRegex'] == 'string' ? new RegExp(env['cdnProxyRegex']) : env['cdnProxyRegex'];\n/** @type {!Object<string, string|boolean|RegExp|Array<RegExp>>} */\n\nvar urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex: thirdPartyFrameRegex || /^d-\\d+\\.ampproject\\.net$/,\n  cdn: env['cdnUrl'] || 'https://cdn.ampproject.org',\n\n  /* Note that cdnProxyRegex is only ever checked against origins\n   * (proto://host[:port]) so does not need to consider path\n   */\n  cdnProxyRegex: cdnProxyRegex || /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org$/,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting: env['errorReportingUrl'] || 'https://amp-error-reporting.appspot.com/r',\n  localDev: env['localDev'] || false,\n\n  /**\n   * These domains are trusted with more sensitive viewer operations such as\n   * propagating the referrer. If you believe your domain should be here,\n   * file the issue on GitHub to discuss. The process will be similar\n   * (but somewhat more stringent) to the one described in the [3p/README.md](\n   * https://github.com/ampproject/amphtml/blob/master/3p/README.md)\n   *\n   * {!Array<!RegExp>}\n   */\n  trustedViewerHosts: [/(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/, /(^|\\.)gmail\\.(com|dev)$/]\n};\nexports.urls = urls;\nvar config = {\n  urls: urls\n};\nexports.config = config;\n\n},{}],33:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.CONSENT_POLICY_STATE = void 0;\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n// This file will be imported by 3P scripts.\n\n/**\n * Possible consent policy state to proceed with.\n * @enum {number}\n */\nvar CONSENT_POLICY_STATE = {\n  // Enum value has external dependency. Please do not change existing value.\n  // If new values are added, please notify the AMP for Ads team to assure\n  // correct Real Time Config behavior is maintained for Fast Fetch.\n  SUFFICIENT: 1,\n  INSUFFICIENT: 2,\n  UNKNOWN_NOT_REQUIRED: 3,\n  UNKNOWN: 4\n};\nexports.CONSENT_POLICY_STATE = CONSENT_POLICY_STATE;\n\n},{}],34:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getConsentPolicyState = getConsentPolicyState;\nexports.getConsentPolicySharedData = getConsentPolicySharedData;\nexports.getConsentPolicyInfo = getConsentPolicyInfo;\nexports.shouldBlockOnConsentByMeta = shouldBlockOnConsentByMeta;\n\nvar _consentState = require(\"./consent-state\");\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns a promise that resolve when all consent state the policy wait\n * for resolve. Or if consent service is not available.\n * @param {!Element|!ShadowRoot} element\n * @param {string=} policyId\n * @return {!Promise<?CONSENT_POLICY_STATE>}\n */\nfunction getConsentPolicyState(element, policyId) {\n  if (policyId === void 0) {\n    policyId = 'default';\n  }\n\n  return _services.Services.consentPolicyServiceForDocOrNull(element).then(function (consentPolicy) {\n    if (!consentPolicy) {\n      return null;\n    }\n\n    return consentPolicy.whenPolicyResolved(\n    /** @type {string} */\n    policyId);\n  });\n}\n/**\n * Returns a promise that resolves to a sharedData retrieved from consent\n * remote endpoint.\n * @param {!Element|!ShadowRoot} element\n * @param {string} policyId\n * @return {!Promise<?Object>}\n */\n\n\nfunction getConsentPolicySharedData(element, policyId) {\n  return _services.Services.consentPolicyServiceForDocOrNull(element).then(function (consentPolicy) {\n    if (!consentPolicy) {\n      return null;\n    }\n\n    return consentPolicy.getMergedSharedData(\n    /** @type {string} */\n    policyId);\n  });\n}\n/**\n * TODO(zhouyx): Combine with getConsentPolicyState and return a consentInfo\n * object.\n * @param {!Element|!ShadowRoot} element\n * @param {string} policyId\n * @return {!Promise<string>}\n */\n\n\nfunction getConsentPolicyInfo(element, policyId) {\n  // Return the stored consent string.\n  return _services.Services.consentPolicyServiceForDocOrNull(element).then(function (consentPolicy) {\n    if (!consentPolicy) {\n      return null;\n    }\n\n    return consentPolicy.getConsentStringInfo(\n    /** @type {string} */\n    policyId);\n  });\n}\n/**\n * Determine if an element needs to be blocked by consent based on metaTags.\n * @param {*} element\n * @return {boolean}\n */\n\n\nfunction shouldBlockOnConsentByMeta(element) {\n  var ampdoc = element.getAmpDoc();\n\n  var content = _services.Services.documentInfoForDoc(ampdoc).metaTags['amp-consent-blocking'];\n\n  if (!content) {\n    return false;\n  } // validator enforce uniqueness of <meta name='amp-consent-blocking'>\n  // content will not be an array.\n\n\n  if (typeof content !== 'string') {\n    (0, _log.user)().error('CONSENT', 'Invalid amp-consent-blocking value, ignore meta tag');\n    return false;\n  } // Handles whitespace\n\n\n  content = content.toUpperCase().replace(/\\s/g, '').split(',');\n\n  if (content.includes(element.tagName)) {\n    return true;\n  }\n\n  return false;\n}\n\n},{\"./consent-state\":33,\"./log\":68,\"./services\":123}],35:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getCookie = getCookie;\nexports.setCookie = setCookie;\nexports.getHighestAvailableDomain = getHighestAvailableDomain;\nexports.SameSite = void 0;\n\nvar _string = require(\"./string\");\n\nvar _url = require(\"./url\");\n\nvar _config = require(\"./config\");\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TEST_COOKIE_NAME = '-test-amp-cookie-tmp';\n/** @enum {string} */\n\nvar SameSite = {\n  LAX: 'Lax',\n  STRICT: 'Strict',\n  NONE: 'None'\n};\n/**\n * Returns the value of the cookie. The cookie access is restricted and must\n * go through the privacy review. Before using this method please file a\n * GitHub issue with \"Privacy Review\" label.\n *\n * Returns the cookie's value or `null`.\n *\n * @param {!Window} win\n * @param {string} name\n * @return {?string}\n */\n\nexports.SameSite = SameSite;\n\nfunction getCookie(win, name) {\n  var cookieString = tryGetDocumentCookie_(win);\n\n  if (!cookieString) {\n    return null;\n  }\n\n  var cookies = cookieString.split(';');\n\n  for (var i = 0; i < cookies.length; i++) {\n    var cookie = cookies[i].trim();\n    var eq = cookie.indexOf('=');\n\n    if (eq == -1) {\n      continue;\n    }\n\n    if ((0, _url.tryDecodeUriComponent)(cookie.substring(0, eq).trim()) == name) {\n      var value = cookie.substring(eq + 1).trim();\n      return (0, _url.tryDecodeUriComponent)(value, value);\n    }\n  }\n\n  return null;\n}\n/**\n * This method should not be inlined to prevent TryCatch deoptimization.\n * @param {!Window} win\n * @return {string}\n * @noinline\n */\n\n\nfunction tryGetDocumentCookie_(win) {\n  try {\n    return win.document.cookie;\n  } catch (e) {\n    // Act as if no cookie is available. Exceptions can be thrown when\n    // AMP docs are opened on origins that do not allow setting\n    // cookies such as null origins.\n    return '';\n  }\n}\n/**\n * Sets the value of the cookie. The cookie access is restricted and must\n * go through the privacy review. Before using this method please file a\n * GitHub issue with \"Privacy Review\" label.\n *\n * @param {!Window} win\n * @param {string} name\n * @param {string} value\n * @param {time} expirationTime\n * @param {{\n *   highestAvailableDomain:(boolean|undefined),\n *   domain:(string|undefined),\n *   sameSite: (!SameSite|undefined),\n * }=} options\n *     - highestAvailableDomain: If true, set the cookie at the widest domain\n *       scope allowed by the browser. E.g. on example.com if we are currently\n *       on www.example.com.\n *     - domain: Explicit domain to set. domain overrides HigestAvailableDomain\n *     - allowOnProxyOrigin: Allow setting a cookie on the AMP Cache.\n *     - sameSite: The SameSite value to use when setting the cookie.\n */\n\n\nfunction setCookie(win, name, value, expirationTime, options) {\n  if (options === void 0) {\n    options = {};\n  }\n\n  checkOriginForSettingCookie(win, options, name);\n  var domain = undefined; // Respect explicitly set domain over higestAvailabeDomain\n\n  if (options.domain) {\n    domain = options.domain;\n  } else if (options.highestAvailableDomain) {\n    domain =\n    /** @type {string} */\n    getHighestAvailableDomain(win);\n  }\n\n  trySetCookie(win, name, value, expirationTime, domain, options.sameSite);\n}\n/**\n * Attemp to find the HighestAvailableDomain on\n * @param {!Window} win\n * @return {?string}\n */\n\n\nfunction getHighestAvailableDomain(win) {\n  // <meta name='amp-cookie-scope'>. Need to respect the meta first.\n  // Note: The same logic applies to shadow docs. Where all shadow docs are\n  // considered to be in the same origin. And only the <meta> from\n  // shell will be respected. (Header from shadow doc will be removed)\n  var metaTag = win.document.head && win.document.head.querySelector(\"meta[name='amp-cookie-scope']\");\n\n  if (metaTag) {\n    // The content value could be an empty string. Return null instead\n    var cookieScope = metaTag.getAttribute('content') || ''; // Verify the validness of the amp-cookie-scope meta value\n\n    var sourceOrigin = (0, _url.getSourceOrigin)(win.location.href); // Verify the meta tag content value is valid\n\n    if ((0, _string.endsWith)(sourceOrigin, '.' + cookieScope)) {\n      return cookieScope;\n    } else {\n      // When the amp-cookie-scope value is invalid, fallback to the exact origin\n      // the document is contained in.\n      // sourceOrigin in the format of 'https://xxx or http://xxx'\n      return sourceOrigin.split('://')[1];\n    }\n  }\n\n  if (!(0, _url.isProxyOrigin)(win.location.href)) {\n    var parts = win.location.hostname.split('.');\n    var domain = parts[parts.length - 1];\n    var testCookieName = getTempCookieName(win);\n\n    for (var i = parts.length - 2; i >= 0; i--) {\n      domain = parts[i] + '.' + domain; // Try set a cookie for testing only, expire after 1 sec\n\n      trySetCookie(win, testCookieName, 'delete', Date.now() + 1000, domain);\n\n      if (getCookie(win, testCookieName) == 'delete') {\n        // Remove the cookie for testing\n        trySetCookie(win, testCookieName, 'delete', Date.now() - 1000, domain);\n        return domain;\n      }\n    }\n  } // Proxy origin w/o <meta name='amp-cookie-scope>\n  // We cannot calculate the etld+1 without the public suffix list.\n  // Return null instead.\n  // Note: This should not affect cookie writing because we don't allow writing\n  // cookie to highestAvailableDomain on proxy origin\n  // In the case of link decoration on proxy origin,\n  // we expect the correct meta tag to be\n  // set by publisher or cache order for AMP runtime to find all subdomains.\n\n\n  return null;\n}\n/**\n * Attempt to set a cookie with the given params.\n *\n * @param {!Window} win\n * @param {string} name\n * @param {string} value\n * @param {time} expirationTime\n * @param {string|undefined} domain\n * @param {!SameSite=} sameSite\n */\n\n\nfunction trySetCookie(win, name, value, expirationTime, domain, sameSite) {\n  // We do not allow setting cookies on the domain that contains both\n  // the cdn. and www. hosts.\n  // Note: we need to allow cdn.ampproject.org in order to optin to experiments\n  if (domain == 'ampproject.org') {\n    // Actively delete them.\n    value = 'delete';\n    expirationTime = 0;\n  }\n\n  var cookie = encodeURIComponent(name) + '=' + encodeURIComponent(value) + '; path=/' + (domain ? '; domain=' + domain : '') + '; expires=' + new Date(expirationTime).toUTCString() + getSameSiteString(win, sameSite);\n\n  try {\n    win.document.cookie = cookie;\n  } catch (ignore) {// Do not throw if setting the cookie failed Exceptions can be thrown\n    // when AMP docs are opened on origins that do not allow setting\n    // cookies such as null origins.\n  }\n}\n/**\n * Gets the cookie string to use for SameSite. This only sets the SameSite\n * value if specified, falling back to the browser default. The default value\n * is equivalent to SameSite.NONE, but is planned to be set to SameSite.LAX in\n * Chrome 80.\n *\n * Note: In Safari 12, if the value is set to SameSite.NONE, it is treated by\n * the browser as SameSite.STRICT.\n * @param {Window} win\n * @param {!SameSite|undefined} sameSite\n * @return {string} The string to use when setting the cookie.\n */\n\n\nfunction getSameSiteString(win, sameSite) {\n  if (!sameSite) {\n    return '';\n  }\n\n  return \"; SameSite=\" + sameSite;\n}\n/**\n * Throws if a given cookie should not be set on the given origin.\n * This is a defense-in-depth. Callers should never run into this.\n *\n * @param {!Window} win\n * @param {!Object} options\n * @param {string} name For the error message.\n */\n\n\nfunction checkOriginForSettingCookie(win, options, name) {\n  if (options.allowOnProxyOrigin) {\n    (0, _log.userAssert)(!options.highestAvailableDomain, 'Could not support higestAvailable Domain on proxy origin, ' + 'specify domain explicitly');\n    return;\n  }\n\n  (0, _log.userAssert)(!(0, _url.isProxyOrigin)(win.location.href), \"Should never attempt to set cookie on proxy origin: \" + name);\n  var current = (0, _url.parseUrlDeprecated)(win.location.href).hostname.toLowerCase();\n  var proxy = (0, _url.parseUrlDeprecated)(_config.urls.cdn).hostname.toLowerCase();\n  (0, _log.userAssert)(!(current == proxy || (0, _string.endsWith)(current, '.' + proxy)), 'Should never attempt to set cookie on proxy origin. (in depth check): ' + name);\n}\n/**\n * Return a temporary cookie name for testing only\n * @param {!Window} win\n * @return {string}\n */\n\n\nfunction getTempCookieName(win) {\n  var testCookieName = TEST_COOKIE_NAME;\n  var counter = 0;\n\n  while (getCookie(win, testCookieName)) {\n    // test cookie name conflict, append counter to test cookie name\n    testCookieName = TEST_COOKIE_NAME + counter;\n  }\n\n  return testCookieName;\n}\n\n},{\"./config\":32,\"./log\":68,\"./string\":126,\"./url\":134}],36:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.assertIsName = assertIsName;\nexports.setScopeSelectorSupportedForTesting = setScopeSelectorSupportedForTesting;\nexports.isScopeSelectorSupported = isScopeSelectorSupported;\nexports.prependSelectorsWith = prependSelectorsWith;\nexports.escapeCssSelectorIdent = escapeCssSelectorIdent;\nexports.escapeCssSelectorNth = escapeCssSelectorNth;\n\nvar _cssEscape = require(\"../third_party/css-escape/css-escape\");\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Asserts that name is just an alphanumeric word, and does not contain\n * advanced CSS selector features like attributes, psuedo-classes, class names,\n * nor ids.\n * @param {string} name\n */\nfunction assertIsName(name) {\n  (0, _log.devAssert)(/^[\\w-]+$/.test(name));\n}\n/**\n * @type {boolean|undefined}\n */\n\n\nvar scopeSelectorSupported;\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\n\nfunction setScopeSelectorSupportedForTesting(val) {\n  scopeSelectorSupported = val;\n}\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element} el\n * @return {boolean}\n */\n\n\nfunction isScopeSelectorSupported(el) {\n  if (scopeSelectorSupported !== undefined) {\n    return scopeSelectorSupported;\n  }\n\n  return scopeSelectorSupported = testScopeSelector(el);\n}\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element} el\n * @return {boolean}\n */\n\n\nfunction testScopeSelector(el) {\n  try {\n    var doc = el.ownerDocument;\n    var testElement = doc.createElement('div');\n    var testChild = doc.createElement('div');\n    testElement.appendChild(testChild); // NOTE(cvializ, #12383): Firefox's implementation is incomplete,\n    // therefore we test actual functionality of`:scope` as well.\n\n    return testElement.\n    /*OK*/\n    querySelector(':scope div') === testChild;\n  } catch (e) {\n    return false;\n  }\n}\n/**\n * Prefixes a selector for ancestor selection. Splits in subselectors and\n * applies prefix to each.\n *\n * e.g.\n * ```\n *   prependSelectorsWith('div', '.i-amphtml-scoped');\n *   // => '.i-amphtml-scoped div'\n *   prependSelectorsWith('div, ul', ':scope');\n *   // => ':scope div, :scope ul'\n *   prependSelectorsWith('div, ul', 'article >');\n *   // => 'article > div, article > ul'\n * ```\n *\n * @param {string} selector\n * @param {string} distribute\n * @return {string}\n */\n\n\nfunction prependSelectorsWith(selector, distribute) {\n  return selector.replace(/^|,/g, \"$&\" + distribute + \" \");\n}\n/**\n * Escapes an ident (ID or a class name) to be used as a CSS selector.\n *\n * See https://drafts.csswg.org/cssom/#serialize-an-identifier.\n *\n * @param {string} ident\n * @return {string}\n */\n\n\nfunction escapeCssSelectorIdent(ident) {\n  return (0, _cssEscape.cssEscape)(ident);\n}\n/**\n * Escapes an ident in a way that can be used by :nth-child() psuedo-class.\n *\n * See https://github.com/w3c/csswg-drafts/issues/2306.\n *\n * @param {string|number} ident\n * @return {string}\n */\n\n\nfunction escapeCssSelectorNth(ident) {\n  var escaped = String(ident); // Ensure it doesn't close the nth-child psuedo class.\n\n  (0, _log.devAssert)(escaped.indexOf(')') === -1);\n  return escaped;\n}\n\n},{\"../third_party/css-escape/css-escape\":153,\"./log\":68}],37:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.bezierCurve = bezierCurve;\nexports.getCurve = getCurve;\nexports.Curves = exports.CurveDef = void 0;\n\nrequire(\"./time\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n// Imported just for the side effect of getting the `types` it exports into\n// the type system during compile time.\n\n/**\n * A CurveDef is a function that returns a normtime value (0 to 1) for another\n * normtime value.\n * @typedef {function(./time.normtimeDef): ./time.normtimeDef}\n */\nvar CurveDef;\n/**\n * Returns a cubic bezier curve.\n * @param {number} x1 X coordinate of the first control point.\n * @param {number} y1 Y coordinate of the first control point.\n * @param {number} x2 X coordinate of the second control point.\n * @param {number} y2 Y coordinate of the second control point.\n * @return {!CurveDef}\n */\n\nexports.CurveDef = CurveDef;\n\nfunction bezierCurve(x1, y1, x2, y2) {\n  var bezier = new Bezier(0, 0, x1, y1, x2, y2, 1, 1);\n  return bezier.solveYValueFromXValue.bind(bezier);\n}\n/**\n * Thanks to\n * https://closure-library.googlecode.com/git-history/docs/local_closure_goog_math_bezier.js.source.html\n */\n\n\nvar Bezier =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {number} x0 X coordinate of the start point.\n   * @param {number} y0 Y coordinate of the start point.\n   * @param {number} x1 X coordinate of the first control point.\n   * @param {number} y1 Y coordinate of the first control point.\n   * @param {number} x2 X coordinate of the second control point.\n   * @param {number} y2 Y coordinate of the second control point.\n   * @param {number} x3 X coordinate of the end point.\n   * @param {number} y3 Y coordinate of the end point.\n   */\n  function Bezier(x0, y0, x1, y1, x2, y2, x3, y3) {\n    /**\n     * X coordinate of the first point.\n     * @type {number}\n     */\n    this.x0 = x0;\n    /**\n     * Y coordinate of the first point.\n     * @type {number}\n     */\n\n    this.y0 = y0;\n    /**\n     * X coordinate of the first control point.\n     * @type {number}\n     */\n\n    this.x1 = x1;\n    /**\n     * Y coordinate of the first control point.\n     * @type {number}\n     */\n\n    this.y1 = y1;\n    /**\n     * X coordinate of the second control point.\n     * @type {number}\n     */\n\n    this.x2 = x2;\n    /**\n     * Y coordinate of the second control point.\n     * @type {number}\n     */\n\n    this.y2 = y2;\n    /**\n     * X coordinate of the end point.\n     * @type {number}\n     */\n\n    this.x3 = x3;\n    /**\n     * Y coordinate of the end point.\n     * @type {number}\n     */\n\n    this.y3 = y3;\n  }\n  /**\n   * Computes the y coordinate of a point on the curve given its x coordinate.\n   * @param {number} xVal The x coordinate of the point on the curve.\n   * @return {number} The y coordinate of the point on the curve.\n   */\n\n\n  var _proto = Bezier.prototype;\n\n  _proto.solveYValueFromXValue = function solveYValueFromXValue(xVal) {\n    return this.getPointY(this.solvePositionFromXValue(xVal));\n  }\n  /**\n   * Computes the position t of a point on the curve given its x coordinate.\n   * That is, for an input xVal, finds t s.t. getPointX(t) = xVal.\n   * As such, the following should always be true up to some small epsilon:\n   * t ~ solvePositionFromXValue(getPointX(t)) for t in [0, 1].\n   * @param {number} xVal The x coordinate of the point to find on the curve.\n   * @return {number} The position t.\n   */\n  ;\n\n  _proto.solvePositionFromXValue = function solvePositionFromXValue(xVal) {\n    // Desired precision on the computation.\n    var epsilon = 1e-6; // Initial estimate of t using linear interpolation.\n\n    var t = (xVal - this.x0) / (this.x3 - this.x0);\n\n    if (t <= 0) {\n      return 0;\n    } else if (t >= 1) {\n      return 1;\n    } // Try gradient descent to solve for t. If it works, it is very fast.\n\n\n    var tMin = 0;\n    var tMax = 1;\n    var value = 0;\n\n    for (var i = 0; i < 8; i++) {\n      value = this.getPointX(t);\n      var derivative = (this.getPointX(t + epsilon) - value) / epsilon;\n\n      if (Math.abs(value - xVal) < epsilon) {\n        return t;\n      } else if (Math.abs(derivative) < epsilon) {\n        break;\n      } else {\n        if (value < xVal) {\n          tMin = t;\n        } else {\n          tMax = t;\n        }\n\n        t -= (value - xVal) / derivative;\n      }\n    } // If the gradient descent got stuck in a local minimum, e.g. because\n    // the derivative was close to 0, use a Dichotomy refinement instead.\n    // We limit the number of iterations to 8.\n\n\n    for (var _i = 0; Math.abs(value - xVal) > epsilon && _i < 8; _i++) {\n      if (value < xVal) {\n        tMin = t;\n        t = (t + tMax) / 2;\n      } else {\n        tMax = t;\n        t = (t + tMin) / 2;\n      }\n\n      value = this.getPointX(t);\n    }\n\n    return t;\n  }\n  /**\n   * Computes the curve's X coordinate at a point between 0 and 1.\n   * @param {number} t The point on the curve to find.\n   * @return {number} The computed coordinate.\n   */\n  ;\n\n  _proto.getPointX = function getPointX(t) {\n    // Special case start and end.\n    if (t == 0) {\n      return this.x0;\n    } else if (t == 1) {\n      return this.x3;\n    } // Step one - from 4 points to 3\n\n\n    var ix0 = this.lerp(this.x0, this.x1, t);\n    var ix1 = this.lerp(this.x1, this.x2, t);\n    var ix2 = this.lerp(this.x2, this.x3, t); // Step two - from 3 points to 2\n\n    ix0 = this.lerp(ix0, ix1, t);\n    ix1 = this.lerp(ix1, ix2, t); // Final step - last point\n\n    return this.lerp(ix0, ix1, t);\n  }\n  /**\n   * Computes the curve's Y coordinate at a point between 0 and 1.\n   * @param {number} t The point on the curve to find.\n   * @return {number} The computed coordinate.\n   */\n  ;\n\n  _proto.getPointY = function getPointY(t) {\n    // Special case start and end.\n    if (t == 0) {\n      return this.y0;\n    } else if (t == 1) {\n      return this.y3;\n    } // Step one - from 4 points to 3\n\n\n    var iy0 = this.lerp(this.y0, this.y1, t);\n    var iy1 = this.lerp(this.y1, this.y2, t);\n    var iy2 = this.lerp(this.y2, this.y3, t); // Step two - from 3 points to 2\n\n    iy0 = this.lerp(iy0, iy1, t);\n    iy1 = this.lerp(iy1, iy2, t); // Final step - last point\n\n    return this.lerp(iy0, iy1, t);\n  }\n  /**\n   * Performs linear interpolation between values a and b. Returns the value\n   * between a and b proportional to x (when x is between 0 and 1. When x is\n   * outside this range, the return value is a linear extrapolation).\n   * @param {number} a A number.\n   * @param {number} b A number.\n   * @param {number} x The proportion between a and b.\n   * @return {number} The interpolated value between a and b.\n   */\n  ;\n\n  _proto.lerp = function lerp(a, b, x) {\n    return a + x * (b - a);\n  };\n\n  return Bezier;\n}();\n/**\n * A collection of common curves.\n * See https://developer.mozilla.org/en-US/docs/Web/CSS/timing-function\n * @enum {!CurveDef}\n */\n\n\nvar Curves = {\n  /**\n   * linear\n   * @param {number} n\n   * @return {number}\n   */\n  LINEAR: function LINEAR(n) {\n    return n;\n  },\n\n  /**\n   * ease\n   */\n  EASE: bezierCurve(0.25, 0.1, 0.25, 1.0),\n\n  /**\n   * ease-in: slow out, fast in\n   */\n  EASE_IN: bezierCurve(0.42, 0.0, 1.0, 1.0),\n\n  /**\n   * ease-out: fast out, slow in\n   */\n  EASE_OUT: bezierCurve(0.0, 0.0, 0.58, 1.0),\n\n  /**\n   * ease-in-out\n   */\n  EASE_IN_OUT: bezierCurve(0.42, 0.0, 0.58, 1.0)\n};\n/**\n * @const {!Object<string, !CurveDef>}\n */\n\nexports.Curves = Curves;\nvar NAME_MAP = {\n  'linear': Curves.LINEAR,\n  'ease': Curves.EASE,\n  'ease-in': Curves.EASE_IN,\n  'ease-out': Curves.EASE_OUT,\n  'ease-in-out': Curves.EASE_IN_OUT\n};\n/**\n * If the argument is a string, this methods matches an existing curve by name.\n * @param {?CurveDef|string|undefined} curve\n * @return {?CurveDef}\n */\n\nfunction getCurve(curve) {\n  if (!curve) {\n    return null;\n  }\n\n  if (typeof curve == 'string') {\n    // If the curve is a custom cubic-bezier curve\n    if (curve.indexOf('cubic-bezier') != -1) {\n      var match = curve.match(/cubic-bezier\\((.+)\\)/);\n\n      if (match) {\n        var values = match[1].split(',').map(parseFloat);\n\n        if (values.length == 4) {\n          for (var i = 0; i < 4; i++) {\n            if (isNaN(values[i])) {\n              return null;\n            }\n          }\n\n          return bezierCurve(values[0], values[1], values[2], values[3]);\n        }\n      }\n\n      return null;\n    }\n\n    return NAME_MAP[curve];\n  }\n\n  return curve;\n}\n\n},{\"./time\":129}],38:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.createCustomElementClass = createCustomElementClass;\nexports.createAmpElementForTesting = createAmpElementForTesting;\n\nvar dom = _interopRequireWildcard(require(\"./dom\"));\n\nvar _ampEvents = require(\"./amp-events\");\n\nvar _commonSignals = require(\"./common-signals\");\n\nvar _elementStub = require(\"./element-stub\");\n\nvar _layout = require(\"./layout\");\n\nvar _layoutDelayMeter = require(\"./layout-delay-meter\");\n\nvar _resource = require(\"./service/resource\");\n\nvar _services = require(\"./services\");\n\nvar _signals = require(\"./utils/signals\");\n\nvar _error = require(\"./error\");\n\nvar _loader = require(\"../src/loader.js\");\n\nvar _log = require(\"./log\");\n\nvar _intersectionObserverPolyfill = require(\"../src/intersection-observer-polyfill\");\n\nvar _mode = require(\"./mode\");\n\nvar _staticTemplate = require(\"./static-template\");\n\nvar _sizeList = require(\"./size-list\");\n\nvar _style = require(\"./style\");\n\nvar _consent = require(\"../src/consent\");\n\nvar _chunk = require(\"./chunk\");\n\nvar _types = require(\"./types\");\n\nvar _promise = require(\"../src/utils/promise\");\n\nfunction _getRequireWildcardCache() { if (typeof WeakMap !== \"function\") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteralLoose([\"\\n            <div class=\\\"i-amphtml-loading-container i-amphtml-fill-content\\n              amp-hidden\\\"></div>\"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _taggedTemplateLiteralLoose(strings, raw) { if (!raw) { raw = strings.slice(0); } strings.raw = raw; return strings; }\n\nfunction _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return self; }\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\nvar TAG = 'CustomElement';\n/**\n * The elements positioned ahead of this threshold may have their loading\n * indicator initialized faster. This is benefitial to avoid relayout during\n * render phase or scrolling.\n * @private @const {number}\n */\n\nvar PREPARE_LOADING_THRESHOLD = 1000;\n/**\n * @enum {number}\n */\n\nvar UpgradeState = {\n  NOT_UPGRADED: 1,\n  UPGRADED: 2,\n  UPGRADE_FAILED: 3,\n  UPGRADE_IN_PROGRESS: 4\n};\n/**\n * Caches whether the template tag is supported to avoid memory allocations.\n * @type {boolean|undefined}\n */\n\nvar templateTagSupported;\n/**\n * Whether this platform supports template tags.\n * @return {boolean}\n */\n\nfunction isTemplateTagSupported() {\n  if (templateTagSupported === undefined) {\n    var template = self.document.createElement('template');\n    templateTagSupported = 'content' in template;\n  }\n\n  return templateTagSupported;\n}\n/**\n * Creates a named custom element class.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @param {string} name The name of the custom element.\n * @return {function(new:AmpElement)} The custom element class.\n */\n\n\nfunction createCustomElementClass(win, name) {\n  var baseCustomElement =\n  /** @type {function(new:HTMLElement)} */\n  createBaseCustomElementClass(win);\n\n  var CustomAmpElement =\n  /*#__PURE__*/\n  function (_baseCustomElement) {\n    _inheritsLoose(CustomAmpElement, _baseCustomElement);\n\n    /**\n     * @see https://github.com/WebReflection/document-register-element#v1-caveat\n     * @suppress {checkTypes}\n     * @param {HTMLElement} self\n     */\n    function CustomAmpElement(self) {\n      var _this;\n\n      return (_this = _baseCustomElement.call(this, self) || this) || _assertThisInitialized(_this);\n    }\n    /**\n     * The name of the custom element.\n     * @return {string}\n     */\n\n\n    var _proto = CustomAmpElement.prototype;\n\n    _proto.elementName = function elementName() {\n      return name;\n    };\n\n    return CustomAmpElement;\n  }(baseCustomElement);\n\n  return (\n    /** @type {function(new:AmpElement)} */\n    CustomAmpElement\n  );\n}\n/**\n * Creates a base custom element class.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @return {function(new:HTMLElement)}\n */\n\n\nfunction createBaseCustomElementClass(win) {\n  if (win.__AMP_BASE_CE_CLASS) {\n    return win.__AMP_BASE_CE_CLASS;\n  }\n\n  var htmlElement =\n  /** @type {function(new:HTMLElement)} */\n  win.HTMLElement;\n  /**\n   * @abstract @extends {HTMLElement}\n   */\n\n  var BaseCustomElement =\n  /*#__PURE__*/\n  function (_htmlElement) {\n    _inheritsLoose(BaseCustomElement, _htmlElement);\n\n    /**\n     * @see https://github.com/WebReflection/document-register-element#v1-caveat\n     * @suppress {checkTypes}\n     * @param {HTMLElement} self\n     */\n    function BaseCustomElement(self) {\n      var _this2;\n\n      self = _this2 = _htmlElement.call(this, self) || this;\n      self.createdCallback();\n      return self || _assertThisInitialized(_this2);\n    }\n    /**\n     * Called when elements is created. Sets instance vars since there is no\n     * constructor.\n     * @final\n     */\n\n\n    var _proto2 = BaseCustomElement.prototype;\n\n    _proto2.createdCallback = function createdCallback() {\n      // Flag \"notbuilt\" is removed by Resource manager when the resource is\n      // considered to be built. See \"setBuilt\" method.\n\n      /** @private {boolean} */\n      this.built_ = false;\n      /**\n       * Several APIs require the element to be connected to the DOM tree, but\n       * the CustomElement lifecycle APIs are async. This lead to subtle bugs\n       * that require state tracking. See #12849, https://crbug.com/821195, and\n       * https://bugs.webkit.org/show_bug.cgi?id=180940.\n       * @private {boolean}\n       */\n\n      this.isConnected_ = false;\n      /** @private {?Promise} */\n\n      this.buildingPromise_ = null;\n      /** @type {string} */\n\n      this.readyState = 'loading';\n      /** @type {boolean} */\n\n      this.everAttached = false;\n      /**\n       * Ampdoc can only be looked up when an element is attached.\n       * @private {?./service/ampdoc-impl.AmpDoc}\n       */\n\n      this.ampdoc_ = null;\n      /**\n       * Resources can only be looked up when an element is attached.\n       * @private {?./service/resources-interface.ResourcesInterface}\n       */\n\n      this.resources_ = null;\n      /** @private {!Layout} */\n\n      this.layout_ = _layout.Layout.NODISPLAY;\n      /** @private {number} */\n\n      this.layoutWidth_ = -1;\n      /** @private {number} */\n\n      this.layoutHeight_ = -1;\n      /** @private {number} */\n\n      this.layoutCount_ = 0;\n      /** @private {boolean} */\n\n      this.isFirstLayoutCompleted_ = false;\n      /** @private {boolean} */\n\n      this.isInViewport_ = false;\n      /** @private {boolean} */\n\n      this.paused_ = false;\n      /** @private {string|null|undefined} */\n\n      this.mediaQuery_ = undefined;\n      /** @private {!./size-list.SizeList|null|undefined} */\n\n      this.sizeList_ = undefined;\n      /** @private {!./size-list.SizeList|null|undefined} */\n\n      this.heightsList_ = undefined;\n      /** @public {boolean} */\n\n      this.warnOnMissingOverflow = true;\n      /**\n       * This element can be assigned by the {@link applyStaticLayout} to a\n       * child element that will be used to size this element.\n       * @package {?Element|undefined}\n       */\n\n      this.sizerElement = undefined;\n      /** @private {boolean|undefined} */\n\n      this.loadingDisabled_ = undefined;\n      /** @private {boolean|undefined} */\n\n      this.loadingState_ = undefined;\n      /** @private {?Element} */\n\n      this.loadingContainer_ = null;\n      /** @private {?Element} */\n\n      this.loadingElement_ = null;\n      /** @private {?Element|undefined} */\n\n      this.overflowElement_ = undefined;\n      /**\n       * The time at which this element was scheduled for layout relative to\n       * the epoch. This value will be set to 0 until the this element has been\n       * scheduled.\n       * Note that this value may change over time if the element is enqueued,\n       * then dequeued and re-enqueued by the scheduler.\n       * @type {number|undefined}\n       */\n\n      this.layoutScheduleTime = undefined; // Closure compiler appears to mark HTMLElement as @struct which\n      // disables bracket access. Force this with a type coercion.\n\n      var nonStructThis =\n      /** @type {!Object} */\n      this; // `opt_implementationClass` is only used for tests.\n\n      var Ctor = win.__AMP_EXTENDED_ELEMENTS && win.__AMP_EXTENDED_ELEMENTS[this.elementName()];\n\n      if ((0, _mode.getMode)().test && nonStructThis['implementationClassForTesting']) {\n        Ctor = nonStructThis['implementationClassForTesting'];\n      }\n\n      (0, _log.devAssert)(Ctor);\n      /** @private {!./base-element.BaseElement} */\n\n      this.implementation_ = new Ctor(this);\n      /**\n       * An element always starts in a unupgraded state until it's added to DOM\n       * for the first time in which case it can be upgraded immediately or wait\n       * for script download or `upgradeCallback`.\n       * @private {!UpgradeState}\n       */\n\n      this.upgradeState_ = UpgradeState.NOT_UPGRADED;\n      /**\n       * Time delay imposed by baseElement upgradeCallback.  If no\n       * upgradeCallback specified or not yet executed, delay is 0.\n       * @private {number}\n       */\n\n      this.upgradeDelayMs_ = 0;\n      /**\n       * Action queue is initially created and kept around until the element\n       * is ready to send actions directly to the implementation.\n       * - undefined initially\n       * - array if used\n       * - null after unspun\n       * @private {?Array<!./service/action-impl.ActionInvocation>|undefined}\n       */\n\n      this.actionQueue_ = undefined;\n      /**\n       * Whether the element is in the template.\n       * @private {boolean|undefined}\n       */\n\n      this.isInTemplate_ = undefined;\n      /** @private @const */\n\n      this.signals_ = new _signals.Signals();\n\n      var perf = _services.Services.performanceForOrNull(win);\n      /** @private {boolean} */\n\n\n      this.perfOn_ = perf && perf.isPerformanceTrackingOn();\n      /** @private {?./layout-delay-meter.LayoutDelayMeter} */\n\n      this.layoutDelayMeter_ = null;\n\n      if (nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER]) {\n        nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER](nonStructThis);\n        delete nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER];\n        delete nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n      }\n    }\n    /**\n     * The name of the custom element.\n     * @abstract\n     * @return {string}\n     */\n    ;\n\n    _proto2.elementName = function elementName() {}\n    /** @return {!Signals} */\n    ;\n\n    _proto2.signals = function signals() {\n      return this.signals_;\n    }\n    /**\n     * Returns the associated ampdoc. Only available after attachment. It throws\n     * exception before the element is attached.\n     * @return {!./service/ampdoc-impl.AmpDoc}\n     * @final\n     * @package\n     */\n    ;\n\n    _proto2.getAmpDoc = function getAmpDoc() {\n      (0, _log.devAssert)(this.ampdoc_, 'no ampdoc yet, since element is not attached');\n      return (\n        /** @typedef {!./service/ampdoc-impl.AmpDoc} */\n        this.ampdoc_\n      );\n    }\n    /**\n     * Returns Resources manager. Only available after attachment. It throws\n     * exception before the element is attached.\n     * @return {!./service/resources-interface.ResourcesInterface}\n     * @final\n     * @package\n     */\n    ;\n\n    _proto2.getResources = function getResources() {\n      (0, _log.devAssert)(this.resources_, 'no resources yet, since element is not attached');\n      return (\n        /** @typedef {!./service/resources-interface.ResourcesInterface} */\n        this.resources_\n      );\n    }\n    /**\n     * Whether the element has been upgraded yet. Always returns false when\n     * the element has not yet been added to DOM. After the element has been\n     * added to DOM, the value depends on the `BaseElement` implementation and\n     * its `upgradeElement` callback.\n     * @return {boolean}\n     * @final\n     */\n    ;\n\n    _proto2.isUpgraded = function isUpgraded() {\n      return this.upgradeState_ == UpgradeState.UPGRADED;\n    }\n    /** @return {!Promise} */\n    ;\n\n    _proto2.whenUpgraded = function whenUpgraded() {\n      return this.signals_.whenSignal(_commonSignals.CommonSignals.UPGRADED);\n    }\n    /**\n     * Upgrades the element to the provided new implementation. If element\n     * has already been attached, it's layout validation and attachment flows\n     * are repeated for the new implementation.\n     * @param {function(new:./base-element.BaseElement, !Element)} newImplClass\n     * @final @package\n     */\n    ;\n\n    _proto2.upgrade = function upgrade(newImplClass) {\n      if (this.isInTemplate_) {\n        return;\n      }\n\n      if (this.upgradeState_ != UpgradeState.NOT_UPGRADED) {\n        // Already upgraded or in progress or failed.\n        return;\n      }\n\n      this.implementation_ = new newImplClass(this);\n\n      if (this.everAttached) {\n        // Usually, we do an implementation upgrade when the element is\n        // attached to the DOM. But, if it hadn't yet upgraded from\n        // ElementStub, we couldn't. Now that it's upgraded from a stub, go\n        // ahead and do the full upgrade.\n        this.tryUpgrade_();\n      }\n    }\n    /**\n     * Time delay imposed by baseElement upgradeCallback.  If no\n     * upgradeCallback specified or not yet executed, delay is 0.\n     * @return {number}\n     */\n    ;\n\n    _proto2.getUpgradeDelayMs = function getUpgradeDelayMs() {\n      return this.upgradeDelayMs_;\n    }\n    /**\n     * Completes the upgrade of the element with the provided implementation.\n     * @param {!./base-element.BaseElement} newImpl\n     * @param {number} upgradeStartTime\n     * @final @private\n     */\n    ;\n\n    _proto2.completeUpgrade_ = function completeUpgrade_(newImpl, upgradeStartTime) {\n      this.upgradeDelayMs_ = win.Date.now() - upgradeStartTime;\n      this.upgradeState_ = UpgradeState.UPGRADED;\n      this.implementation_ = newImpl;\n      this.classList.remove('amp-unresolved');\n      this.classList.remove('i-amphtml-unresolved');\n      this.implementation_.createdCallback();\n      this.assertLayout_();\n      this.implementation_.layout_ = this.layout_;\n      this.implementation_.layoutWidth_ = this.layoutWidth_;\n      this.implementation_.firstAttachedCallback();\n      this.dispatchCustomEventForTesting(_ampEvents.AmpEvents.ATTACHED);\n      this.getResources().upgraded(this);\n      this.signals_.signal(_commonSignals.CommonSignals.UPGRADED);\n    }\n    /** @private */\n    ;\n\n    _proto2.assertLayout_ = function assertLayout_() {\n      if (this.layout_ != _layout.Layout.NODISPLAY && !this.implementation_.isLayoutSupported(this.layout_)) {\n        (0, _log.userAssert)(this.getAttribute('layout'), 'The element did not specify a layout attribute. ' + 'Check https://amp.dev/documentation/guides-and-tutorials/' + 'develop/style_and_layout/control_layout and the respective ' + 'element documentation for details.');\n        (0, _log.userAssert)(false, \"Layout not supported: \" + this.layout_);\n      }\n    }\n    /**\n     * Whether the element has been built. A built element had its\n     * {@link buildCallback} method successfully invoked.\n     * @return {boolean}\n     * @final\n     */\n    ;\n\n    _proto2.isBuilt = function isBuilt() {\n      return this.built_;\n    }\n    /**\n     * Returns the promise that's resolved when the element has been built. If\n     * the build fails, the resulting promise is rejected.\n     * @return {!Promise}\n     */\n    ;\n\n    _proto2.whenBuilt = function whenBuilt() {\n      return this.signals_.whenSignal(_commonSignals.CommonSignals.BUILT);\n    }\n    /**\n     * Get the priority to load the element.\n     * @return {number}\n     */\n    ;\n\n    _proto2.getLayoutPriority = function getLayoutPriority() {\n      (0, _log.devAssert)(this.isUpgraded(), 'Cannot get priority of unupgraded element');\n      return this.implementation_.getLayoutPriority();\n    }\n    /**\n     * Get the default action alias.\n     * @return {?string}\n     */\n    ;\n\n    _proto2.getDefaultActionAlias = function getDefaultActionAlias() {\n      (0, _log.devAssert)(this.isUpgraded(), 'Cannot get default action alias of unupgraded element');\n      return this.implementation_.getDefaultActionAlias();\n    }\n    /**\n     * Requests or requires the element to be built. The build is done by\n     * invoking {@link BaseElement.buildCallback} method.\n     *\n     * Can only be called on a upgraded element. May only be called from\n     * resource.js to ensure an element and its resource are in sync.\n     *\n     * @return {?Promise}\n     * @final\n     */\n    ;\n\n    _proto2.build = function build() {\n      var _this3 = this;\n\n      assertNotTemplate(this);\n      (0, _log.devAssert)(this.isUpgraded(), 'Cannot build unupgraded element');\n\n      if (this.buildingPromise_) {\n        return this.buildingPromise_;\n      }\n\n      return this.buildingPromise_ = new Promise(function (resolve, reject) {\n        var policyId = _this3.getConsentPolicy_();\n\n        if (!policyId) {\n          resolve(_this3.implementation_.buildCallback());\n        } else {\n          _services.Services.consentPolicyServiceForDocOrNull(_this3).then(function (policy) {\n            if (!policy) {\n              return true;\n            }\n\n            return policy.whenPolicyUnblock(\n            /** @type {string} */\n            policyId);\n          }).then(function (shouldUnblock) {\n            if (shouldUnblock) {\n              resolve(_this3.implementation_.buildCallback());\n            } else {\n              reject((0, _error.blockedByConsentError)());\n            }\n          });\n        }\n      }).then(function () {\n        _this3.preconnect(\n        /* onLayout */\n        false);\n\n        _this3.built_ = true;\n\n        _this3.classList.remove('i-amphtml-notbuilt');\n\n        _this3.classList.remove('amp-notbuilt');\n\n        _this3.signals_.signal(_commonSignals.CommonSignals.BUILT);\n\n        if (_this3.isInViewport_) {\n          _this3.updateInViewport_(true);\n        }\n\n        if (_this3.actionQueue_) {\n          // Only schedule when the queue is not empty, which should be\n          // the case 99% of the time.\n          _services.Services.timerFor((0, _types.toWin)(_this3.ownerDocument.defaultView)).delay(_this3.dequeueActions_.bind(_this3), 1);\n        }\n\n        if (!_this3.getPlaceholder()) {\n          var placeholder = _this3.createPlaceholder();\n\n          if (placeholder) {\n            _this3.appendChild(placeholder);\n          }\n        }\n      }, function (reason) {\n        _this3.signals_.rejectSignal(_commonSignals.CommonSignals.BUILT,\n        /** @type {!Error} */\n        reason);\n\n        if (!(0, _error.isBlockedByConsent)(reason)) {\n          (0, _error.reportError)(reason, _this3);\n        }\n\n        throw reason;\n      });\n    }\n    /**\n     * Called to instruct the element to preconnect to hosts it uses during\n     * layout.\n     * @param {boolean} onLayout Whether this was called after a layout.\n     */\n    ;\n\n    _proto2.preconnect = function preconnect(onLayout) {\n      var _this4 = this;\n\n      if (onLayout) {\n        this.implementation_.preconnectCallback(onLayout);\n      } else {\n        // If we do early preconnects we delay them a bit. This is kind of\n        // an unfortunate trade off, but it seems faster, because the DOM\n        // operations themselves are not free and might delay\n        (0, _chunk.startupChunk)(self.document, function () {\n          var TAG = _this4.tagName;\n\n          if (!_this4.ownerDocument) {\n            (0, _log.dev)().error(TAG, 'preconnect without ownerDocument');\n            return;\n          } else if (!_this4.ownerDocument.defaultView) {\n            (0, _log.dev)().error(TAG, 'preconnect without defaultView');\n            return;\n          }\n\n          _this4.implementation_.preconnectCallback(onLayout);\n        });\n      }\n    }\n    /**\n     * Whether the custom element declares that it has to be fixed.\n     * @return {boolean}\n     */\n    ;\n\n    _proto2.isAlwaysFixed = function isAlwaysFixed() {\n      return this.implementation_.isAlwaysFixed();\n    }\n    /**\n     * Updates the layout box of the element.\n     * See {@link BaseElement.getLayoutWidth} for details.\n     * @param {!./layout-rect.LayoutRectDef} layoutBox\n     * @param {boolean=} opt_measurementsChanged\n     */\n    ;\n\n    _proto2.updateLayoutBox = function updateLayoutBox(layoutBox, opt_measurementsChanged) {\n      var _this5 = this;\n\n      this.layoutWidth_ = layoutBox.width;\n      this.layoutHeight_ = layoutBox.height;\n\n      if (this.isUpgraded()) {\n        this.implementation_.layoutWidth_ = this.layoutWidth_;\n      }\n\n      if (this.isBuilt()) {\n        try {\n          this.implementation_.onLayoutMeasure();\n\n          if (opt_measurementsChanged) {\n            this.implementation_.onMeasureChanged();\n          }\n        } catch (e) {\n          (0, _error.reportError)(e, this);\n        }\n      }\n\n      if (this.isLoadingEnabled_()) {\n        if (this.isInViewport_) {\n          // Already in viewport - start showing loading.\n          this.toggleLoading(true);\n        } else if (layoutBox.top < PREPARE_LOADING_THRESHOLD && layoutBox.top >= 0) {\n          // Few top elements will also be pre-initialized with a loading\n          // element.\n          this.mutateOrInvoke_(function () {\n            return _this5.prepareLoading_();\n          });\n        }\n      }\n    }\n    /**\n     * @return {?Element}\n     * @private\n     */\n    ;\n\n    _proto2.getSizer_ = function getSizer_() {\n      if (this.sizerElement === undefined && (this.layout_ === _layout.Layout.RESPONSIVE || this.layout_ === _layout.Layout.INTRINSIC)) {\n        // Expect sizer to exist, just not yet discovered.\n        this.sizerElement = this.querySelector('i-amphtml-sizer');\n      }\n\n      return this.sizerElement || null;\n    }\n    /**\n     * @param {Element} sizer\n     * @private\n     */\n    ;\n\n    _proto2.resetSizer_ = function resetSizer_(sizer) {\n      if (this.layout_ === _layout.Layout.RESPONSIVE) {\n        (0, _style.setStyle)(sizer, 'paddingTop', '0');\n        return;\n      }\n\n      if (this.layout_ === _layout.Layout.INTRINSIC) {\n        var intrinsicSizerImg = sizer.querySelector('.i-amphtml-intrinsic-sizer');\n\n        if (!intrinsicSizerImg) {\n          return;\n        }\n\n        intrinsicSizerImg.setAttribute('src', '');\n        return;\n      }\n    }\n    /**\n     * If the element has a media attribute, evaluates the value as a media\n     * query and based on the result adds or removes the class\n     * `i-amphtml-hidden-by-media-query`. The class adds display:none to the\n     * element which in turn prevents any of the resource loading to happen for\n     * the element.\n     *\n     * This method is called by Resources and shouldn't be called by anyone\n     * else.\n     *\n     * @final\n     * @package\n     */\n    ;\n\n    _proto2.applySizesAndMediaQuery = function applySizesAndMediaQuery() {\n      assertNotTemplate(this); // Media query.\n\n      if (this.mediaQuery_ === undefined) {\n        this.mediaQuery_ = this.getAttribute('media') || null;\n      }\n\n      if (this.mediaQuery_) {\n        var defaultView = this.ownerDocument.defaultView;\n        this.classList.toggle('i-amphtml-hidden-by-media-query', !defaultView.matchMedia(this.mediaQuery_).matches);\n      } // Sizes.\n\n\n      if (this.sizeList_ === undefined) {\n        var sizesAttr = this.getAttribute('sizes');\n        this.sizeList_ = sizesAttr ? (0, _sizeList.parseSizeList)(sizesAttr) : null;\n      }\n\n      if (this.sizeList_) {\n        (0, _style.setStyle)(this, 'width', this.sizeList_.select((0, _types.toWin)(this.ownerDocument.defaultView)));\n      } // Heights.\n\n\n      if (this.heightsList_ === undefined && this.layout_ === _layout.Layout.RESPONSIVE) {\n        var heightsAttr = this.getAttribute('heights');\n        this.heightsList_ = heightsAttr ? (0, _sizeList.parseSizeList)(heightsAttr,\n        /* allowPercent */\n        true) : null;\n      }\n\n      if (this.heightsList_) {\n        var sizer = this.getSizer_();\n\n        if (sizer) {\n          (0, _style.setStyle)(sizer, 'paddingTop', this.heightsList_.select((0, _types.toWin)(this.ownerDocument.defaultView)));\n        }\n      }\n    }\n    /**\n     * Changes the size of the element.\n     *\n     * This method is called by Resources and shouldn't be called by anyone\n     * else. This method must always be called in the mutation context.\n     *\n     * @param {number|undefined} newHeight\n     * @param {number|undefined} newWidth\n     * @param {!./layout-rect.LayoutMarginsDef=} opt_newMargins\n     * @final\n     * @package\n     */\n    ;\n\n    _proto2.changeSize = function changeSize(newHeight, newWidth, opt_newMargins) {\n      var sizer = this.getSizer_();\n\n      if (sizer) {\n        // From the moment height is changed the element becomes fully\n        // responsible for managing its height. Aspect ratio is no longer\n        // preserved.\n        this.sizerElement = null;\n        this.resetSizer_(sizer);\n        this.mutateOrInvoke_(function () {\n          if (sizer) {\n            dom.removeElement(sizer);\n          }\n        });\n      }\n\n      if (newHeight !== undefined) {\n        (0, _style.setStyle)(this, 'height', newHeight, 'px');\n      }\n\n      if (newWidth !== undefined) {\n        (0, _style.setStyle)(this, 'width', newWidth, 'px');\n      }\n\n      if (opt_newMargins) {\n        if (opt_newMargins.top != null) {\n          (0, _style.setStyle)(this, 'marginTop', opt_newMargins.top, 'px');\n        }\n\n        if (opt_newMargins.right != null) {\n          (0, _style.setStyle)(this, 'marginRight', opt_newMargins.right, 'px');\n        }\n\n        if (opt_newMargins.bottom != null) {\n          (0, _style.setStyle)(this, 'marginBottom', opt_newMargins.bottom, 'px');\n        }\n\n        if (opt_newMargins.left != null) {\n          (0, _style.setStyle)(this, 'marginLeft', opt_newMargins.left, 'px');\n        }\n      }\n\n      if (this.isAwaitingSize_()) {\n        this.sizeProvided_();\n      }\n\n      this.dispatchCustomEvent(_ampEvents.AmpEvents.SIZE_CHANGED);\n    }\n    /**\n     * Called when the element is first connected to the DOM. Calls\n     * {@link firstAttachedCallback} if this is the first attachment.\n     *\n     * This callback is guarded by checks to see if the element is still\n     * connected.  Chrome and Safari can trigger connectedCallback even when\n     * the node is disconnected. See #12849, https://crbug.com/821195, and\n     * https://bugs.webkit.org/show_bug.cgi?id=180940. Thankfully,\n     * connectedCallback will later be called when the disconnected root is\n     * connected to the document tree.\n     *\n     * @final\n     */\n    ;\n\n    _proto2.connectedCallback = function connectedCallback() {\n      if (!isTemplateTagSupported() && this.isInTemplate_ === undefined) {\n        this.isInTemplate_ = !!dom.closestAncestorElementBySelector(this, 'template');\n      }\n\n      if (this.isInTemplate_) {\n        return;\n      }\n\n      if (this.isConnected_ || !dom.isConnectedNode(this)) {\n        return;\n      }\n\n      this.isConnected_ = true;\n\n      if (!this.everAttached) {\n        this.classList.add('i-amphtml-element');\n        this.classList.add('i-amphtml-notbuilt');\n        this.classList.add('amp-notbuilt');\n      }\n\n      if (!this.ampdoc_) {\n        // Ampdoc can now be initialized.\n        var _win = (0, _types.toWin)(this.ownerDocument.defaultView);\n\n        var ampdocService = _services.Services.ampdocServiceFor(_win);\n\n        var ampdoc = ampdocService.getAmpDoc(this);\n        this.ampdoc_ = ampdoc; // Load the pre-stubbed extension if needed.\n\n        var extensionId = this.tagName.toLowerCase();\n\n        if (isStub(this.implementation_) && !ampdoc.declaresExtension(extensionId)) {\n          _services.Services.extensionsFor(_win).installExtensionForDoc(ampdoc, extensionId);\n        }\n      }\n\n      if (!this.resources_) {\n        // Resources can now be initialized since the ampdoc is now available.\n        this.resources_ = _services.Services.resourcesForDoc(this.ampdoc_);\n      }\n\n      this.getResources().add(this);\n\n      if (this.everAttached) {\n        var reconstruct = this.reconstructWhenReparented();\n\n        if (reconstruct) {\n          this.reset_();\n        }\n\n        if (this.isUpgraded()) {\n          if (reconstruct) {\n            this.getResources().upgraded(this);\n          }\n\n          this.dispatchCustomEventForTesting(_ampEvents.AmpEvents.ATTACHED);\n        }\n      } else {\n        this.everAttached = true;\n\n        try {\n          this.layout_ = (0, _layout.applyStaticLayout)(this);\n        } catch (e) {\n          (0, _error.reportError)(e, this);\n        }\n\n        if (!isStub(this.implementation_)) {\n          this.tryUpgrade_();\n        }\n\n        if (!this.isUpgraded()) {\n          this.classList.add('amp-unresolved');\n          this.classList.add('i-amphtml-unresolved'); // amp:attached is dispatched from the ElementStub class when it\n          // replayed the firstAttachedCallback call.\n\n          this.dispatchCustomEventForTesting(_ampEvents.AmpEvents.STUBBED);\n        }\n      }\n    }\n    /**\n     * @return {boolean}\n     * @private\n     */\n    ;\n\n    _proto2.isAwaitingSize_ = function isAwaitingSize_() {\n      return this.classList.contains('i-amphtml-layout-awaiting-size');\n    }\n    /**\n     * @private\n     */\n    ;\n\n    _proto2.sizeProvided_ = function sizeProvided_() {\n      this.classList.remove('i-amphtml-layout-awaiting-size');\n    }\n    /** The Custom Elements V0 sibling to `connectedCallback`. */\n    ;\n\n    _proto2.attachedCallback = function attachedCallback() {\n      this.connectedCallback();\n    }\n    /**\n     * Try to upgrade the element with the provided implementation.\n     * @private @final\n     */\n    ;\n\n    _proto2.tryUpgrade_ = function tryUpgrade_() {\n      var _this6 = this;\n\n      var impl = this.implementation_;\n      (0, _log.devAssert)(!isStub(impl), 'Implementation must not be a stub');\n\n      if (this.upgradeState_ != UpgradeState.NOT_UPGRADED) {\n        // Already upgraded or in progress or failed.\n        return;\n      } // The `upgradeCallback` only allows redirect once for the top-level\n      // non-stub class. We may allow nested upgrades later, but they will\n      // certainly be bad for performance.\n\n\n      this.upgradeState_ = UpgradeState.UPGRADE_IN_PROGRESS;\n      var startTime = win.Date.now();\n      var res = impl.upgradeCallback();\n\n      if (!res) {\n        // Nothing returned: the current object is the upgraded version.\n        this.completeUpgrade_(impl, startTime);\n      } else if (typeof res.then == 'function') {\n        // It's a promise: wait until it's done.\n        res.then(function (upgrade) {\n          _this6.completeUpgrade_(upgrade || impl, startTime);\n        }).catch(function (reason) {\n          _this6.upgradeState_ = UpgradeState.UPGRADE_FAILED;\n          (0, _log.rethrowAsync)(reason);\n        });\n      } else {\n        // It's an actual instance: upgrade immediately.\n        this.completeUpgrade_(\n        /** @type {!./base-element.BaseElement} */\n        res, startTime);\n      }\n    }\n    /**\n     * Called when the element is disconnected from the DOM.\n     *\n     * @final\n     */\n    ;\n\n    _proto2.disconnectedCallback = function disconnectedCallback() {\n      this.disconnect(\n      /* pretendDisconnected */\n      false);\n    }\n    /** The Custom Elements V0 sibling to `disconnectedCallback`. */\n    ;\n\n    _proto2.detachedCallback = function detachedCallback() {\n      this.disconnectedCallback();\n    }\n    /**\n     * Called when an element is disconnected from DOM, or when an ampDoc is\n     * being disconnected (the element itself may still be connected to ampDoc).\n     *\n     * This callback is guarded by checks to see if the element is still\n     * connected. See #12849, https://crbug.com/821195, and\n     * https://bugs.webkit.org/show_bug.cgi?id=180940.\n     * If the element is still connected to the document, you'll need to pass\n     * opt_pretendDisconnected.\n     *\n     * @param {boolean} pretendDisconnected Forces disconnection regardless\n     *     of DOM isConnected.\n     */\n    ;\n\n    _proto2.disconnect = function disconnect(pretendDisconnected) {\n      if (this.isInTemplate_ || !this.isConnected_) {\n        return;\n      }\n\n      if (!pretendDisconnected && dom.isConnectedNode(this)) {\n        return;\n      } // This path only comes from Resource#disconnect, which deletes the\n      // Resource instance tied to this element. Therefore, it is no longer\n      // an AMP Element. But, DOM queries for i-amphtml-element assume that\n      // the element is tied to a Resource.\n\n\n      if (pretendDisconnected) {\n        this.classList.remove('i-amphtml-element');\n      }\n\n      this.isConnected_ = false;\n      this.getResources().remove(this);\n      this.implementation_.detachedCallback();\n    }\n    /**\n     * Dispatches a custom event.\n     *\n     * @param {string} name\n     * @param {!Object=} opt_data Event data.\n     * @final\n     */\n    ;\n\n    _proto2.dispatchCustomEvent = function dispatchCustomEvent(name, opt_data) {\n      var data = opt_data || {}; // Constructors of events need to come from the correct window. Sigh.\n\n      var event = this.ownerDocument.createEvent('Event');\n      event.data = data;\n      event.initEvent(name,\n      /* bubbles */\n      true,\n      /* cancelable */\n      true);\n      this.dispatchEvent(event);\n    }\n    /**\n     * Dispatches a custom event only in testing environment.\n     *\n     * @param {string} name\n     * @param {!Object=} opt_data Event data.\n     * @final\n     */\n    ;\n\n    _proto2.dispatchCustomEventForTesting = function dispatchCustomEventForTesting(name, opt_data) {\n      if (!(0, _mode.getMode)().test) {\n        return;\n      }\n\n      this.dispatchCustomEvent(name, opt_data);\n    }\n    /**\n     * Whether the element can pre-render.\n     * @return {boolean}\n     * @final\n     */\n    ;\n\n    _proto2.prerenderAllowed = function prerenderAllowed() {\n      return this.implementation_.prerenderAllowed();\n    }\n    /**\n     * Whether the element has render-blocking service.\n     * @return {boolean}\n     * @final\n     */\n    ;\n\n    _proto2.isBuildRenderBlocking = function isBuildRenderBlocking() {\n      return this.implementation_.isBuildRenderBlocking();\n    }\n    /**\n     * Creates a placeholder for the element.\n     * @return {?Element}\n     * @final\n     */\n    ;\n\n    _proto2.createPlaceholder = function createPlaceholder() {\n      return this.implementation_.createPlaceholderCallback();\n    }\n    /**\n     * Creates a loader logo.\n     * @return {{\n     *  content: (!Element|undefined),\n     *  color: (string|undefined),\n     * }}\n     * @final\n     */\n    ;\n\n    _proto2.createLoaderLogo = function createLoaderLogo() {\n      return this.implementation_.createLoaderLogoCallback();\n    }\n    /**\n     * Whether the element should ever render when it is not in viewport.\n     * @return {boolean|number}\n     * @final\n     */\n    ;\n\n    _proto2.renderOutsideViewport = function renderOutsideViewport() {\n      return this.implementation_.renderOutsideViewport();\n    }\n    /**\n     * Whether the element should render outside of renderOutsideViewport when\n     * the scheduler is idle.\n     * @return {boolean|number}\n     * @final\n     */\n    ;\n\n    _proto2.idleRenderOutsideViewport = function idleRenderOutsideViewport() {\n      return this.implementation_.idleRenderOutsideViewport();\n    }\n    /**\n     * Returns a previously measured layout box adjusted to the viewport. This\n     * mainly affects fixed-position elements that are adjusted to be always\n     * relative to the document position in the viewport.\n     * @return {!./layout-rect.LayoutRectDef}\n     * @final\n     */\n    ;\n\n    _proto2.getLayoutBox = function getLayoutBox() {\n      return this.getResource_().getLayoutBox();\n    }\n    /**\n     * Returns a previously measured layout box relative to the page. The\n     * fixed-position elements are relative to the top of the document.\n     * @return {!./layout-rect.LayoutRectDef}\n     * @final\n     */\n    ;\n\n    _proto2.getPageLayoutBox = function getPageLayoutBox() {\n      return this.getResource_().getPageLayoutBox();\n    }\n    /**\n     * @return {?Element}\n     * @final\n     */\n    ;\n\n    _proto2.getOwner = function getOwner() {\n      return this.getResource_().getOwner();\n    }\n    /**\n     * Returns a change entry for that should be compatible with\n     * IntersectionObserverEntry.\n     * @return {!IntersectionObserverEntry} A change entry.\n     * @final\n     */\n    ;\n\n    _proto2.getIntersectionChangeEntry = function getIntersectionChangeEntry() {\n      var box = this.implementation_.getIntersectionElementLayoutBox();\n      var owner = this.getOwner();\n      var viewportBox = this.implementation_.getViewport().getRect(); // TODO(jridgewell, #4826): We may need to make this recursive.\n\n      var ownerBox = owner && owner.getLayoutBox();\n      return (0, _intersectionObserverPolyfill.getIntersectionChangeEntry)(box, ownerBox, viewportBox);\n    }\n    /**\n     * Returns the resource of the element.\n     * @return {!./service/resource.Resource}\n     * @private\n     */\n    ;\n\n    _proto2.getResource_ = function getResource_() {\n      return this.getResources().getResourceForElement(this);\n    }\n    /**\n     * Returns the resource ID of the element.\n     * @return {number}\n     */\n    ;\n\n    _proto2.getResourceId = function getResourceId() {\n      return this.getResource_().getId();\n    }\n    /**\n     * The runtime calls this method to determine if {@link layoutCallback}\n     * should be called again when layout changes.\n     * @return {boolean}\n     * @package @final\n     */\n    ;\n\n    _proto2.isRelayoutNeeded = function isRelayoutNeeded() {\n      return this.implementation_.isRelayoutNeeded();\n    }\n    /**\n     * Returns reference to upgraded implementation.\n     * @param {boolean} waitForBuild If true, waits for element to be built before\n     *   resolving the returned Promise. Default is true.\n     * @return {!Promise<!./base-element.BaseElement>}\n     */\n    ;\n\n    _proto2.getImpl = function getImpl(waitForBuild) {\n      var _this7 = this;\n\n      if (waitForBuild === void 0) {\n        waitForBuild = true;\n      }\n\n      var waitFor = waitForBuild ? this.whenBuilt() : this.whenUpgraded();\n      return waitFor.then(function () {\n        return _this7.implementation_;\n      });\n    }\n    /**\n     * Returns the layout of the element.\n     * @return {!Layout}\n     */\n    ;\n\n    _proto2.getLayout = function getLayout() {\n      return this.layout_;\n    }\n    /**\n     * Instructs the element to layout its content and load its resources if\n     * necessary by calling the {@link BaseElement.layoutCallback} method that\n     * should be implemented by BaseElement subclasses. Must return a promise\n     * that will yield when the layout and associated loadings are complete.\n     *\n     * This method is always called for the first layout, but for subsequent\n     * layouts the runtime consults {@link isRelayoutNeeded} method.\n     *\n     * Can only be called on a upgraded and built element.\n     *\n     * @return {!Promise}\n     * @package @final\n     */\n    ;\n\n    _proto2.layoutCallback = function layoutCallback() {\n      var _this8 = this;\n\n      assertNotTemplate(this);\n      (0, _log.devAssert)(this.isBuilt(), 'Must be built to receive viewport events');\n      this.dispatchCustomEventForTesting(_ampEvents.AmpEvents.LOAD_START);\n      var isLoadEvent = this.layoutCount_ == 0; // First layout is \"load\".\n\n      this.signals_.reset(_commonSignals.CommonSignals.UNLOAD);\n\n      if (isLoadEvent) {\n        this.signals_.signal(_commonSignals.CommonSignals.LOAD_START);\n      }\n\n      if (this.perfOn_) {\n        this.getLayoutDelayMeter_().startLayout();\n      }\n\n      var promise = (0, _promise.tryResolve)(function () {\n        return _this8.implementation_.layoutCallback();\n      });\n      this.preconnect(\n      /* onLayout */\n      true);\n      this.classList.add('i-amphtml-layout');\n      return promise.then(function () {\n        if (isLoadEvent) {\n          _this8.signals_.signal(_commonSignals.CommonSignals.LOAD_END);\n        }\n\n        _this8.readyState = 'complete';\n        _this8.layoutCount_++;\n\n        _this8.toggleLoading(false, {\n          cleanup: true\n        }); // Check if this is the first success layout that needs\n        // to call firstLayoutCompleted.\n\n\n        if (!_this8.isFirstLayoutCompleted_) {\n          _this8.implementation_.firstLayoutCompleted();\n\n          _this8.isFirstLayoutCompleted_ = true;\n\n          _this8.dispatchCustomEventForTesting(_ampEvents.AmpEvents.LOAD_END);\n        }\n      }, function (reason) {\n        // add layoutCount_ by 1 despite load fails or not\n        if (isLoadEvent) {\n          _this8.signals_.rejectSignal(_commonSignals.CommonSignals.LOAD_END,\n          /** @type {!Error} */\n          reason);\n        }\n\n        _this8.layoutCount_++;\n\n        _this8.toggleLoading(false, {\n          cleanup: true\n        });\n\n        throw reason;\n      });\n    }\n    /**\n     * Whether the resource is currently visible in the viewport.\n     * @return {boolean}\n     * @final @package\n     */\n    ;\n\n    _proto2.isInViewport = function isInViewport() {\n      return this.isInViewport_;\n    }\n    /**\n     * Instructs the resource that it entered or exited the visible viewport.\n     *\n     * Can only be called on a upgraded and built element.\n     *\n     * @param {boolean} inViewport Whether the element has entered or exited\n     *   the visible viewport.\n     * @final @package\n     */\n    ;\n\n    _proto2.viewportCallback = function viewportCallback(inViewport) {\n      var _this9 = this;\n\n      assertNotTemplate(this);\n\n      if (inViewport == this.isInViewport_) {\n        return;\n      } // TODO(dvoytenko, #9177): investigate/cleanup viewport signals for\n      // elements in dead iframes.\n\n\n      if (!this.ownerDocument || !this.ownerDocument.defaultView) {\n        return;\n      }\n\n      this.isInViewport_ = inViewport;\n\n      if (this.layoutCount_ == 0) {\n        if (!inViewport) {\n          this.toggleLoading(false);\n        } else {\n          // Set a minimum delay in case the element loads very fast or if it\n          // leaves the viewport.\n          _services.Services.timerFor((0, _types.toWin)(this.ownerDocument.defaultView)).delay(function () {\n            // TODO(dvoytenko, #9177): cleanup `this.ownerDocument.defaultView`\n            // once investigation is complete. It appears that we get a lot of\n            // errors here once the iframe is destroyed due to timer.\n            if (_this9.isInViewport_ && _this9.ownerDocument && _this9.ownerDocument.defaultView) {\n              _this9.toggleLoading(true);\n            }\n          }, 100);\n        }\n      }\n\n      if (this.isBuilt()) {\n        this.updateInViewport_(inViewport);\n      }\n    }\n    /**\n     * @param {boolean} inViewport\n     * @private\n     */\n    ;\n\n    _proto2.updateInViewport_ = function updateInViewport_(inViewport) {\n      this.implementation_.inViewport_ = inViewport;\n      this.implementation_.viewportCallback(inViewport);\n\n      if (inViewport && this.perfOn_) {\n        this.getLayoutDelayMeter_().enterViewport();\n      }\n    }\n    /**\n     * Whether the resource is currently paused.\n     * @return {boolean}\n     * @final @package\n     */\n    ;\n\n    _proto2.isPaused = function isPaused() {\n      return this.paused_;\n    }\n    /**\n     * Requests the resource to stop its activity when the document goes into\n     * inactive state. The scope is up to the actual component. Among other\n     * things the active playback of video or audio content must be stopped.\n     *\n     * @package @final\n     */\n    ;\n\n    _proto2.pauseCallback = function pauseCallback() {\n      assertNotTemplate(this);\n\n      if (this.paused_) {\n        return;\n      }\n\n      this.paused_ = true;\n      this.viewportCallback(false);\n\n      if (this.isBuilt()) {\n        this.implementation_.pauseCallback();\n      }\n    }\n    /**\n     * Requests the resource to resume its activity when the document returns\n     * from an inactive state. The scope is up to the actual component. Among\n     * other things the active playback of video or audio content may be\n     * resumed.\n     *\n     * @package @final\n     */\n    ;\n\n    _proto2.resumeCallback = function resumeCallback() {\n      assertNotTemplate(this);\n\n      if (!this.paused_) {\n        return;\n      }\n\n      this.paused_ = false;\n\n      if (this.isBuilt()) {\n        this.implementation_.resumeCallback();\n      }\n    }\n    /**\n     * Requests the element to unload any expensive resources when the element\n     * goes into non-visible state. The scope is up to the actual component.\n     *\n     * Calling this method on unbuilt or unupgraded element has no effect.\n     *\n     * @return {boolean}\n     * @package @final\n     */\n    ;\n\n    _proto2.unlayoutCallback = function unlayoutCallback() {\n      assertNotTemplate(this);\n\n      if (!this.isBuilt()) {\n        return false;\n      }\n\n      this.signals_.signal(_commonSignals.CommonSignals.UNLOAD);\n      var isReLayoutNeeded = this.implementation_.unlayoutCallback();\n\n      if (isReLayoutNeeded) {\n        this.reset_();\n      }\n\n      return isReLayoutNeeded;\n    }\n    /** @private */\n    ;\n\n    _proto2.reset_ = function reset_() {\n      this.layoutCount_ = 0;\n      this.isFirstLayoutCompleted_ = false;\n      this.signals_.reset(_commonSignals.CommonSignals.RENDER_START);\n      this.signals_.reset(_commonSignals.CommonSignals.LOAD_START);\n      this.signals_.reset(_commonSignals.CommonSignals.LOAD_END);\n      this.signals_.reset(_commonSignals.CommonSignals.INI_LOAD);\n    }\n    /**\n     * Whether to call {@link unlayoutCallback} when pausing the element.\n     * Certain elements cannot properly pause (like amp-iframes with unknown\n     * video content), and so we must unlayout to stop playback.\n     *\n     * @return {boolean}\n     * @package @final\n     */\n    ;\n\n    _proto2.unlayoutOnPause = function unlayoutOnPause() {\n      return this.implementation_.unlayoutOnPause();\n    }\n    /**\n     * Whether the element needs to be reconstructed after it has been\n     * re-parented. Many elements cannot survive fully the reparenting and\n     * are better to be reconstructed from scratch.\n     *\n     * @return {boolean}\n     * @package @final\n     */\n    ;\n\n    _proto2.reconstructWhenReparented = function reconstructWhenReparented() {\n      return this.implementation_.reconstructWhenReparented();\n    }\n    /**\n     * Collapses the element, and notifies its owner (if there is one) that the\n     * element is no longer present.\n     */\n    ;\n\n    _proto2.collapse = function collapse() {\n      this.implementation_.\n      /*OK*/\n      collapse();\n    }\n    /**\n     * Called every time an owned AmpElement collapses itself.\n     * @param {!AmpElement} element\n     */\n    ;\n\n    _proto2.collapsedCallback = function collapsedCallback(element) {\n      this.implementation_.collapsedCallback(element);\n    }\n    /**\n     * Expands the element, and notifies its owner (if there is one) that the\n     * element is now present.\n     */\n    ;\n\n    _proto2.expand = function expand() {\n      this.implementation_.\n      /*OK*/\n      expand();\n    }\n    /**\n     * Called every time an owned AmpElement expands itself.\n     * @param {!AmpElement} element\n     */\n    ;\n\n    _proto2.expandedCallback = function expandedCallback(element) {\n      this.implementation_.expandedCallback(element);\n    }\n    /**\n     * Called when one or more attributes are mutated.\n     * Note: Must be called inside a mutate context.\n     * Note: Boolean attributes have a value of `true` and `false` when\n     *     present and missing, respectively.\n     * @param {!JsonObject<string, (null|boolean|string|number|Array|Object)>} mutations\n     */\n    ;\n\n    _proto2.mutatedAttributesCallback = function mutatedAttributesCallback(mutations) {\n      this.implementation_.mutatedAttributesCallback(mutations);\n    }\n    /**\n     * Enqueues the action with the element. If element has been upgraded and\n     * built, the action is dispatched to the implementation right away.\n     * Otherwise the invocation is enqueued until the implementation is ready\n     * to receive actions.\n     * @param {!./service/action-impl.ActionInvocation} invocation\n     * @final\n     */\n    ;\n\n    _proto2.enqueAction = function enqueAction(invocation) {\n      assertNotTemplate(this);\n\n      if (!this.isBuilt()) {\n        if (this.actionQueue_ === undefined) {\n          this.actionQueue_ = [];\n        }\n\n        (0, _log.devAssert)(this.actionQueue_).push(invocation);\n      } else {\n        this.executionAction_(invocation, false);\n      }\n    }\n    /**\n     * Dequeues events from the queue and dispatches them to the implementation\n     * with \"deferred\" flag.\n     * @private\n     */\n    ;\n\n    _proto2.dequeueActions_ = function dequeueActions_() {\n      var _this10 = this;\n\n      if (!this.actionQueue_) {\n        return;\n      }\n\n      var actionQueue = (0, _log.devAssert)(this.actionQueue_);\n      this.actionQueue_ = null; // Notice, the actions are currently not de-duped.\n\n      actionQueue.forEach(function (invocation) {\n        _this10.executionAction_(invocation, true);\n      });\n    }\n    /**\n     * Executes the action immediately. All errors are consumed and reported.\n     * @param {!./service/action-impl.ActionInvocation} invocation\n     * @param {boolean} deferred\n     * @final\n     * @private\n     */\n    ;\n\n    _proto2.executionAction_ = function executionAction_(invocation, deferred) {\n      try {\n        this.implementation_.executeAction(invocation, deferred);\n      } catch (e) {\n        (0, _log.rethrowAsync)('Action execution failed:', e, invocation.node.tagName, invocation.method);\n      }\n    }\n    /**\n     * Get the consent policy to follow.\n     * @return {?string}\n     */\n    ;\n\n    _proto2.getConsentPolicy_ = function getConsentPolicy_() {\n      var policyId = this.getAttribute('data-block-on-consent');\n\n      if (policyId === null) {\n        if ((0, _consent.shouldBlockOnConsentByMeta)(this)) {\n          policyId = 'default';\n          this.setAttribute('data-block-on-consent', policyId);\n        } else {\n          // data-block-on-consent attribute not set\n          return null;\n        }\n      }\n\n      if (policyId == '' || policyId == 'default') {\n        // data-block-on-consent value not set, up to individual element\n        // Note: data-block-on-consent and data-block-on-consent='default' is\n        // treated exactly the same\n        return this.implementation_.getConsentPolicy();\n      }\n\n      return policyId;\n    }\n    /**\n     * Returns the original nodes of the custom element without any service\n     * nodes that could have been added for markup. These nodes can include\n     * Text, Comment and other child nodes.\n     * @return {!Array<!Node>}\n     * @package @final\n     */\n    ;\n\n    _proto2.getRealChildNodes = function getRealChildNodes() {\n      return dom.childNodes(this, function (node) {\n        return !isInternalOrServiceNode(node);\n      });\n    }\n    /**\n     * Returns the original children of the custom element without any service\n     * nodes that could have been added for markup.\n     * @return {!Array<!Element>}\n     * @package @final\n     */\n    ;\n\n    _proto2.getRealChildren = function getRealChildren() {\n      return dom.childElements(this, function (element) {\n        return !isInternalOrServiceNode(element);\n      });\n    }\n    /**\n     * Returns an optional placeholder element for this custom element.\n     * @return {?Element}\n     * @package @final\n     */\n    ;\n\n    _proto2.getPlaceholder = function getPlaceholder() {\n      return dom.lastChildElement(this, function (el) {\n        return el.hasAttribute('placeholder') && // Blacklist elements that has a native placeholder property\n        // like input and textarea. These are not allowed to be AMP\n        // placeholders.\n        !isInputPlaceholder(el);\n      });\n    }\n    /**\n     * Hides or shows the placeholder, if available.\n     * @param {boolean} show\n     * @package @final\n     */\n    ;\n\n    _proto2.togglePlaceholder = function togglePlaceholder(show) {\n      assertNotTemplate(this);\n\n      if (show) {\n        var placeholder = this.getPlaceholder();\n\n        if (placeholder) {\n          (0, _log.dev)().assertElement(placeholder).classList.remove('amp-hidden');\n        }\n      } else {\n        var placeholders = dom.childElementsByAttr(this, 'placeholder');\n\n        for (var i = 0; i < placeholders.length; i++) {\n          // Don't toggle elements with a native placeholder property\n          // e.g. input, textarea\n          if (isInputPlaceholder(placeholders[i])) {\n            continue;\n          }\n\n          placeholders[i].classList.add('amp-hidden');\n        }\n      }\n    }\n    /**\n     * Returns an optional fallback element for this custom element.\n     * @return {?Element}\n     * @package @final\n     */\n    ;\n\n    _proto2.getFallback = function getFallback() {\n      return dom.childElementByAttr(this, 'fallback');\n    }\n    /**\n     * Hides or shows the fallback, if available. This function must only\n     * be called inside a mutate context.\n     * @param {boolean} show\n     * @package @final\n     */\n    ;\n\n    _proto2.toggleFallback = function toggleFallback(show) {\n      assertNotTemplate(this);\n      var resourceState = this.getResource_().getState(); // Do not show fallback before layout\n\n      if (show && (resourceState == _resource.ResourceState.NOT_BUILT || resourceState == _resource.ResourceState.NOT_LAID_OUT || resourceState == _resource.ResourceState.READY_FOR_LAYOUT)) {\n        return;\n      } // This implementation is notably less efficient then placeholder\n      // toggling. The reasons for this are: (a) \"not supported\" is the state of\n      // the whole element, (b) some relayout is expected and (c) fallback\n      // condition would be rare.\n\n\n      this.classList.toggle('amp-notsupported', show);\n\n      if (show == true) {\n        var fallbackElement = this.getFallback();\n\n        if (fallbackElement) {\n          _services.Services.ownersForDoc(this.getAmpDoc()).scheduleLayout(this, fallbackElement);\n        }\n      }\n    }\n    /**\n     * An implementation can call this method to signal to the element that\n     * it has started rendering.\n     * @package @final\n     */\n    ;\n\n    _proto2.renderStarted = function renderStarted() {\n      this.signals_.signal(_commonSignals.CommonSignals.RENDER_START);\n      this.togglePlaceholder(false);\n      this.toggleLoading(false);\n    }\n    /**\n     * Whether the loading can be shown for this element.\n     * @return {boolean}\n     * @private\n     */\n    ;\n\n    _proto2.isLoadingEnabled_ = function isLoadingEnabled_() {\n      // No loading indicator will be shown if either one of these conditions\n      // true:\n      // 1. `noloading` attribute is specified;\n      // 2. The element has not been whitelisted;\n      // 3. The element is too small or has not yet been measured;\n      // 4. The element has already been laid out (include having loading\n      //    error);\n      // 5. The element is a `placeholder` or a `fallback`;\n      // 6. The element's layout is not a size-defining layout.\n      // 7. The document is A4A.\n      if (this.isInA4A()) {\n        return false;\n      }\n\n      if (this.loadingDisabled_ === undefined) {\n        this.loadingDisabled_ = this.hasAttribute('noloading');\n      }\n\n      if (this.layoutCount_ > 0 || this.layoutWidth_ <= 0 || // Layout is not ready or invisible\n      this.loadingDisabled_ || !(0, _layout.isLoadingAllowed)(this) || isInternalOrServiceNode(this) || !(0, _layout.isLayoutSizeDefined)(this.layout_)) {\n        return false;\n      }\n\n      return true;\n    }\n    /**\n     * @return {boolean}\n     */\n    ;\n\n    _proto2.isInA4A = function isInA4A() {\n      return (// in FIE\n        this.ampdoc_ && this.ampdoc_.win != this.ownerDocument.defaultView || // in inabox\n        (0, _mode.getMode)().runtime == 'inabox'\n      );\n    }\n    /**\n     * Creates a loading object. The caller must ensure that loading can\n     * actually be shown. This method must also be called in the mutate\n     * context.\n     * @private\n     */\n    ;\n\n    _proto2.prepareLoading_ = function prepareLoading_() {\n      if (!this.isLoadingEnabled_()) {\n        return;\n      }\n\n      if (!this.loadingContainer_) {\n        var doc = this.ownerDocument;\n        (0, _log.devAssert)(doc);\n        var container = (0, _staticTemplate.htmlFor)(\n        /** @type {!Document} */\n        doc)(_templateObject());\n        var loadingElement = (0, _loader.createLoaderElement)(this.getAmpDoc(), this, this.layoutWidth_, this.layoutHeight_);\n        container.appendChild(loadingElement);\n        this.appendChild(container);\n        this.loadingContainer_ = container;\n        this.loadingElement_ = loadingElement;\n      }\n    }\n    /**\n     * Turns the loading indicator on or off.\n     * @param {boolean} state\n     * @param {{cleanup:(boolean|undefined), force:(boolean|undefined)}=} opt_options\n     * @public @final\n     */\n    ;\n\n    _proto2.toggleLoading = function toggleLoading(state, opt_options) {\n      var _this11 = this;\n\n      var cleanup = opt_options && opt_options.cleanup;\n      var force = opt_options && opt_options.force;\n      assertNotTemplate(this);\n\n      if (state && !this.implementation_.isLoadingReused() && (this.layoutCount_ > 0 || this.signals_.get(_commonSignals.CommonSignals.RENDER_START))) {\n        // Loading has already been canceled. Ignore.\n        return;\n      }\n\n      if (state === this.loadingState_ && !opt_options) {\n        // Loading state is the same.\n        return;\n      }\n\n      this.loadingState_ = state;\n\n      if (!state && !this.loadingContainer_) {\n        return;\n      } // Check if loading should be shown.\n\n\n      if (state && !force && !this.isLoadingEnabled_()) {\n        this.loadingState_ = false;\n        return;\n      }\n\n      this.mutateOrInvoke_(function () {\n        var state = _this11.loadingState_; // Repeat \"loading enabled\" check because it could have changed while\n        // waiting for vsync.\n\n        if (state && !force && !_this11.isLoadingEnabled_()) {\n          state = false;\n        }\n\n        if (state) {\n          _this11.prepareLoading_();\n        }\n\n        if (!_this11.loadingContainer_) {\n          return;\n        }\n\n        _this11.loadingContainer_.classList.toggle('amp-hidden', !state);\n\n        _this11.loadingElement_.classList.toggle('amp-active', state);\n\n        if (!state && cleanup && !_this11.implementation_.isLoadingReused()) {\n          var loadingContainer = _this11.loadingContainer_;\n          _this11.loadingContainer_ = null;\n          _this11.loadingElement_ = null;\n\n          _this11.mutateOrInvoke_(function () {\n            dom.removeElement(loadingContainer);\n          });\n        }\n      });\n    }\n    /**\n     * Returns an optional overflow element for this custom element.\n     * @return {!./layout-delay-meter.LayoutDelayMeter}\n     */\n    ;\n\n    _proto2.getLayoutDelayMeter_ = function getLayoutDelayMeter_() {\n      if (!this.layoutDelayMeter_) {\n        this.layoutDelayMeter_ = new _layoutDelayMeter.LayoutDelayMeter((0, _types.toWin)(this.ownerDocument.defaultView), this.getLayoutPriority());\n      }\n\n      return this.layoutDelayMeter_;\n    }\n    /**\n     * Returns an optional overflow element for this custom element.\n     * @return {?Element}\n     */\n    ;\n\n    _proto2.getOverflowElement = function getOverflowElement() {\n      if (this.overflowElement_ === undefined) {\n        this.overflowElement_ = dom.childElementByAttr(this, 'overflow');\n\n        if (this.overflowElement_) {\n          if (!this.overflowElement_.hasAttribute('tabindex')) {\n            this.overflowElement_.setAttribute('tabindex', '0');\n          }\n\n          if (!this.overflowElement_.hasAttribute('role')) {\n            this.overflowElement_.setAttribute('role', 'button');\n          }\n        }\n      }\n\n      return this.overflowElement_;\n    }\n    /**\n     * Hides or shows the overflow, if available. This function must only\n     * be called inside a mutate context.\n     * @param {boolean} overflown\n     * @param {number|undefined} requestedHeight\n     * @param {number|undefined} requestedWidth\n     * @package @final\n     */\n    ;\n\n    _proto2.overflowCallback = function overflowCallback(overflown, requestedHeight, requestedWidth) {\n      var _this12 = this;\n\n      this.getOverflowElement();\n\n      if (!this.overflowElement_) {\n        if (overflown && this.warnOnMissingOverflow) {\n          (0, _log.user)().warn(TAG, 'Cannot resize element and overflow is not available', this);\n        }\n      } else {\n        this.overflowElement_.classList.toggle('amp-visible', overflown);\n\n        if (overflown) {\n          this.overflowElement_.onclick = function () {\n            var resources = _this12.getResources();\n\n            resources.\n            /*OK*/\n            changeSize(_this12, requestedHeight, requestedWidth);\n            resources.mutateElement(_this12, function () {\n              _this12.overflowCallback(\n              /* overflown */\n              false, requestedHeight, requestedWidth);\n            });\n          };\n        } else {\n          this.overflowElement_.onclick = null;\n        }\n      }\n    }\n    /**\n     * Mutates the element using resources if available.\n     *\n     * @param {function()} mutator\n     * @param {?Element=} opt_element\n     */\n    ;\n\n    _proto2.mutateOrInvoke_ = function mutateOrInvoke_(mutator, opt_element) {\n      if (this.resources_) {\n        this.getResources().mutateElement(opt_element || this, mutator);\n      } else {\n        mutator();\n      }\n    };\n\n    return BaseCustomElement;\n  }(htmlElement);\n\n  win.__AMP_BASE_CE_CLASS = BaseCustomElement;\n  return (\n    /** @type {function(new:HTMLElement)} */\n    win.__AMP_BASE_CE_CLASS\n  );\n}\n/**\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isInputPlaceholder(element) {\n  return 'placeholder' in element;\n}\n/** @param {!Element} element */\n\n\nfunction assertNotTemplate(element) {\n  (0, _log.devAssert)(!element.isInTemplate_, 'Must never be called in template');\n}\n/**\n * Whether the implementation is a stub.\n * @param {?./base-element.BaseElement} impl\n * @return {boolean}\n */\n\n\nfunction isStub(impl) {\n  return impl instanceof _elementStub.ElementStub;\n}\n/**\n * Returns \"true\" for internal AMP nodes or for placeholder elements.\n * @param {!Node} node\n * @return {boolean}\n */\n\n\nfunction isInternalOrServiceNode(node) {\n  if ((0, _layout.isInternalElement)(node)) {\n    return true;\n  }\n\n  if (node.tagName && (node.hasAttribute('placeholder') || node.hasAttribute('fallback') || node.hasAttribute('overflow'))) {\n    return true;\n  }\n\n  return false;\n}\n/**\n * Creates a new custom element class prototype.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @param {string} name The name of the custom element.\n * @param {function(new:./base-element.BaseElement, !Element)=} opt_implementationClass For testing only.\n * @return {!Object} Prototype of element.\n */\n\n\nfunction createAmpElementForTesting(win, name, opt_implementationClass) {\n  var Element = createCustomElementClass(win, name);\n\n  if ((0, _mode.getMode)().test && opt_implementationClass) {\n    Element.prototype.implementationClassForTesting = opt_implementationClass;\n  }\n\n  return Element;\n}\n\n},{\"../src/consent\":34,\"../src/intersection-observer-polyfill\":62,\"../src/loader.js\":67,\"../src/utils/promise\":147,\"./amp-events\":26,\"./chunk\":30,\"./common-signals\":31,\"./dom\":41,\"./element-stub\":43,\"./error\":44,\"./layout\":66,\"./layout-delay-meter\":64,\"./log\":68,\"./mode\":70,\"./service/resource\":101,\"./services\":123,\"./size-list\":124,\"./static-template\":125,\"./style\":128,\"./types\":131,\"./utils/signals\":149}],39:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.isDocumentReady = isDocumentReady;\nexports.onDocumentReady = onDocumentReady;\nexports.whenDocumentReady = whenDocumentReady;\nexports.whenDocumentComplete = whenDocumentComplete;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nfunction isDocumentReady(doc) {\n  return doc.readyState != 'loading' && doc.readyState != 'uninitialized';\n}\n/**\n * Whether the document has loaded all the css and sub-resources.\n * @param {!Document} doc\n * @return {boolean}\n */\n\n\nfunction isDocumentComplete(doc) {\n  return doc.readyState == 'complete';\n}\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {function(!Document)} callback\n */\n\n\nfunction onDocumentReady(doc, callback) {\n  onDocumentState(doc, isDocumentReady, callback);\n}\n/**\n * Calls the callback when document's state satisfies the stateFn.\n * @param {!Document} doc\n * @param {function(!Document):boolean} stateFn\n * @param {function(!Document)} callback\n */\n\n\nfunction onDocumentState(doc, stateFn, callback) {\n  var ready = stateFn(doc);\n\n  if (ready) {\n    callback(doc);\n  } else {\n    var readyListener = function readyListener() {\n      if (stateFn(doc)) {\n        if (!ready) {\n          ready = true;\n          callback(doc);\n        }\n\n        doc.removeEventListener('readystatechange', readyListener);\n      }\n    };\n\n    doc.addEventListener('readystatechange', readyListener);\n  }\n}\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\n\n\nfunction whenDocumentReady(doc) {\n  return new Promise(function (resolve) {\n    onDocumentReady(doc, resolve);\n  });\n}\n/**\n * Returns a promise that is resolved when document is complete.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\n\n\nfunction whenDocumentComplete(doc) {\n  return new Promise(function (resolve) {\n    onDocumentState(doc, isDocumentComplete, resolve);\n  });\n}\n\n},{}],40:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installGlobalSubmitListenerForDoc = installGlobalSubmitListenerForDoc;\nexports.onDocumentFormSubmit_ = onDocumentFormSubmit_;\n\nvar _actionConstants = require(\"./action-constants\");\n\nvar _url = require(\"./url\");\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _elementService = require(\"./element-service\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise}\n */\nfunction installGlobalSubmitListenerForDoc(ampdoc) {\n  // Register global submit event listener only if the amp-form\n  // extension is used. Allowing the usage of native forms, otherwise.\n  return (0, _elementService.isExtensionScriptInNode)(ampdoc, 'amp-form').then(function (ampFormInstalled) {\n    if (ampFormInstalled) {\n      ampdoc.getRootNode().addEventListener('submit', onDocumentFormSubmit_, true);\n    }\n  });\n}\n/**\n * Intercept any submit on the current document and prevent invalid submits from\n * going through.\n *\n * @param {!Event} e\n */\n\n\nfunction onDocumentFormSubmit_(e) {\n  if (e.defaultPrevented) {\n    return;\n  }\n\n  var form = (0, _log.dev)().assertElement(e.target);\n\n  if (!form || form.tagName != 'FORM') {\n    return;\n  } // amp-form extension will add novalidate to all forms to manually trigger\n  // validation. In that case `novalidate` doesn't have the same meaning.\n\n\n  var isAmpFormMarked = form.classList.contains('i-amphtml-form');\n  var shouldValidate;\n\n  if (isAmpFormMarked) {\n    shouldValidate = !form.hasAttribute('amp-novalidate');\n  } else {\n    shouldValidate = !form.hasAttribute('novalidate');\n  } // Safari does not trigger validation check on submission, hence we\n  // trigger it manually. In other browsers this would never execute since\n  // the submit event wouldn't be fired if the form is invalid.\n\n\n  if (shouldValidate && form.checkValidity && !form.checkValidity()) {\n    e.preventDefault();\n  }\n\n  var inputs = form.elements;\n\n  for (var i = 0; i < inputs.length; i++) {\n    (0, _log.userAssert)(!inputs[i].name || inputs[i].name != _url.SOURCE_ORIGIN_PARAM, 'Illegal input name, %s found: %s', _url.SOURCE_ORIGIN_PARAM, inputs[i]);\n  }\n\n  var action = form.getAttribute('action');\n  var actionXhr = form.getAttribute('action-xhr');\n  var method = (form.getAttribute('method') || 'GET').toUpperCase();\n\n  if (actionXhr) {\n    (0, _url.assertHttpsUrl)(actionXhr, form, 'action-xhr');\n    (0, _log.userAssert)(!(0, _url.isProxyOrigin)(actionXhr), 'form action-xhr should not be on AMP CDN: %s', form);\n    (0, _url.checkCorsUrl)(actionXhr);\n  }\n\n  if (action) {\n    (0, _url.assertHttpsUrl)(action, form, 'action');\n    (0, _log.userAssert)(!(0, _url.isProxyOrigin)(action), 'form action should not be on AMP CDN: %s', form);\n    (0, _url.checkCorsUrl)(action);\n  }\n\n  if (method == 'GET') {\n    (0, _log.userAssert)(actionXhr || action, 'form action-xhr or action attribute is required for method=GET: %s', form);\n  } else if (method == 'POST') {\n    if (action) {\n      var TAG = 'form';\n      (0, _log.user)().error(TAG, 'action attribute is invalid for method=POST: %s', form);\n    }\n\n    if (!actionXhr) {\n      e.preventDefault();\n      (0, _log.userAssert)(false, 'Only XHR based (via action-xhr attribute) submissions are support ' + 'for POST requests. %s', form);\n    }\n  }\n\n  var target = form.getAttribute('target');\n\n  if (target) {\n    (0, _log.userAssert)(target == '_blank' || target == '_top', 'form target=%s is invalid can only be _blank or _top: %s', target, form);\n  } else {\n    form.setAttribute('target', '_top');\n  } // For xhr submissions relay the submission event through action service to\n  // allow us to wait for amp-form (and possibly its dependencies) to execute\n  // the actual submission. For non-XHR GET we let the submission go through\n  // to allow _blank target to work.\n\n\n  if (actionXhr) {\n    e.preventDefault(); // It's important to stop propagation of the submission to avoid double\n    // handling of the event in cases were we are delegating to action service\n    // to deliver the submission event.\n\n    e.stopImmediatePropagation();\n\n    var actions = _services.Services.actionServiceForDoc(form);\n\n    actions.execute(form, 'submit',\n    /*args*/\n    null,\n    /*source*/\n    form,\n    /*caller*/\n    form, e, _actionConstants.ActionTrust.HIGH);\n  }\n}\n\n},{\"./action-constants\":23,\"./element-service\":42,\"./log\":68,\"./services\":123,\"./url\":134}],41:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.waitForChild = waitForChild;\nexports.waitForChildPromise = waitForChildPromise;\nexports.waitForBodyOpen = waitForBodyOpen;\nexports.waitForBodyOpenPromise = waitForBodyOpenPromise;\nexports.removeElement = removeElement;\nexports.removeChildren = removeChildren;\nexports.copyChildren = copyChildren;\nexports.insertAfterOrAtStart = insertAfterOrAtStart;\nexports.addAttributesToElement = addAttributesToElement;\nexports.createElementWithAttributes = createElementWithAttributes;\nexports.isConnectedNode = isConnectedNode;\nexports.rootNodeFor = rootNodeFor;\nexports.isShadowRoot = isShadowRoot;\nexports.closest = closest;\nexports.closestNode = closestNode;\nexports.closestAncestorElementBySelector = closestAncestorElementBySelector;\nexports.ancestorElements = ancestorElements;\nexports.ancestorElementsByTag = ancestorElementsByTag;\nexports.childElement = childElement;\nexports.childElements = childElements;\nexports.lastChildElement = lastChildElement;\nexports.childNodes = childNodes;\nexports.childElementByAttr = childElementByAttr;\nexports.lastChildElementByAttr = lastChildElementByAttr;\nexports.childElementsByAttr = childElementsByAttr;\nexports.childElementByTag = childElementByTag;\nexports.childElementsByTag = childElementsByTag;\nexports.matches = matches;\nexports.elementByTag = elementByTag;\nexports.scopedQuerySelector = scopedQuerySelector;\nexports.scopedQuerySelectorAll = scopedQuerySelectorAll;\nexports.getDataParamsFromAttributes = getDataParamsFromAttributes;\nexports.hasNextNodeInDocumentOrder = hasNextNodeInDocumentOrder;\nexports.templateContentClone = templateContentClone;\nexports.iterateCursor = iterateCursor;\nexports.openWindowDialog = openWindowDialog;\nexports.isJsonScriptTag = isJsonScriptTag;\nexports.isJsonLdScriptTag = isJsonLdScriptTag;\nexports.isRTL = isRTL;\nexports.escapeHtml = escapeHtml;\nexports.tryFocus = tryFocus;\nexports.isIframed = isIframed;\nexports.isAmpElement = isAmpElement;\nexports.whenUpgradedToCustomElement = whenUpgradedToCustomElement;\nexports.fullscreenEnter = fullscreenEnter;\nexports.fullscreenExit = fullscreenExit;\nexports.isFullscreenElement = isFullscreenElement;\nexports.isEnabled = isEnabled;\nexports.domOrderComparator = domOrderComparator;\nexports.toggleAttribute = toggleAttribute;\nexports.getVerticalScrollbarWidth = getVerticalScrollbarWidth;\nexports.UPGRADE_TO_CUSTOMELEMENT_RESOLVER = exports.UPGRADE_TO_CUSTOMELEMENT_PROMISE = void 0;\n\nvar _promise = require(\"./utils/promise\");\n\nvar _css = require(\"./css\");\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object\");\n\nvar _string = require(\"./string\");\n\nvar _types = require(\"./types\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar HTML_ESCAPE_CHARS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  \"'\": '&#x27;',\n  '`': '&#x60;'\n};\nvar HTML_ESCAPE_REGEX = /(&|<|>|\"|'|`)/g;\n/** @const {string} */\n\nvar UPGRADE_TO_CUSTOMELEMENT_PROMISE = '__AMP_UPG_PRM';\n/** @const {string} */\n\nexports.UPGRADE_TO_CUSTOMELEMENT_PROMISE = UPGRADE_TO_CUSTOMELEMENT_PROMISE;\nvar UPGRADE_TO_CUSTOMELEMENT_RESOLVER = '__AMP_UPG_RES';\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * callback is executed.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @param {function()} callback\n */\n\nexports.UPGRADE_TO_CUSTOMELEMENT_RESOLVER = UPGRADE_TO_CUSTOMELEMENT_RESOLVER;\n\nfunction waitForChild(parent, checkFunc, callback) {\n  if (checkFunc(parent)) {\n    callback();\n    return;\n  }\n  /** @const {!Window} */\n\n\n  var win = (0, _types.toWin)(parent.ownerDocument.defaultView);\n\n  if (win.MutationObserver) {\n    /** @const {MutationObserver} */\n    var observer = new win.MutationObserver(function () {\n      if (checkFunc(parent)) {\n        observer.disconnect();\n        callback();\n      }\n    });\n    observer.observe(parent, {\n      childList: true\n    });\n  } else {\n    /** @const {number} */\n    var interval = win.setInterval(function () {\n      if (checkFunc(parent)) {\n        win.clearInterval(interval);\n        callback();\n      }\n    },\n    /* milliseconds */\n    5);\n  }\n}\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * promise is resolved.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @return {!Promise}\n */\n\n\nfunction waitForChildPromise(parent, checkFunc) {\n  return new Promise(function (resolve) {\n    waitForChild(parent, checkFunc, resolve);\n  });\n}\n/**\n * Waits for document's body to be available and ready.\n * @param {!Document} doc\n * @param {function()} callback\n */\n\n\nfunction waitForBodyOpen(doc, callback) {\n  waitForChild(doc.documentElement, function () {\n    return !!doc.body;\n  }, callback);\n}\n/**\n * Waits for document's body to be available.\n * @param {!Document} doc\n * @return {!Promise}\n */\n\n\nfunction waitForBodyOpenPromise(doc) {\n  return new Promise(function (resolve) {\n    return waitForBodyOpen(doc, resolve);\n  });\n}\n/**\n * Removes the element.\n * @param {!Element} element\n */\n\n\nfunction removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element} parent\n */\n\n\nfunction removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element|!DocumentFragment} to\n */\n\n\nfunction copyChildren(from, to) {\n  var frag = to.ownerDocument.createDocumentFragment();\n\n  for (var n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n\n  to.appendChild(frag);\n}\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n * @param {?Node} after\n */\n\n\nfunction insertAfterOrAtStart(root, element, after) {\n  var before = after ? after.nextSibling : root.firstChild;\n  root.insertBefore(element, before);\n}\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\n\n\nfunction addAttributesToElement(element, attributes) {\n  for (var attr in attributes) {\n    element.setAttribute(attr, attributes[attr]);\n  }\n\n  return element;\n}\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\n\n\nfunction createElementWithAttributes(doc, tagName, attributes) {\n  var element = doc.createElement(tagName);\n  return addAttributesToElement(element, attributes);\n}\n/**\n * Returns true if node is connected (attached).\n * @param {!Node} node\n * @return {boolean}\n * @see https://dom.spec.whatwg.org/#connected\n */\n\n\nfunction isConnectedNode(node) {\n  var connected = node.isConnected;\n\n  if (connected !== undefined) {\n    return connected;\n  } // \"An element is connected if its shadow-including root is a document.\"\n\n\n  var n = node;\n\n  do {\n    n = rootNodeFor(n);\n\n    if (n.host) {\n      n = n.host;\n    } else {\n      break;\n    }\n  } while (true);\n\n  return n.nodeType === Node.DOCUMENT_NODE;\n}\n/**\n * Returns the root for a given node. Does not cross shadow DOM boundary.\n * @param {!Node} node\n * @return {!Node}\n */\n\n\nfunction rootNodeFor(node) {\n  if (Node.prototype.getRootNode) {\n    // Type checker says `getRootNode` may return null.\n    return node.getRootNode() || node;\n  }\n\n  var n; // Check isShadowRoot() is only needed for the polyfill case.\n\n  for (n = node; !!n.parentNode && !isShadowRoot(n); n = n.parentNode) {}\n\n  return n;\n}\n/**\n * Determines if value is actually a `ShadowRoot` node.\n * @param {*} value\n * @return {boolean}\n */\n\n\nfunction isShadowRoot(value) {\n  // TODO(#22733): remove in preference to dom's `rootNodeFor`.\n  if (!value) {\n    return false;\n  } // Node.nodeType == DOCUMENT_FRAGMENT to speed up the tests. Unfortunately,\n  // nodeType of DOCUMENT_FRAGMENT is used currently for ShadowRoot nodes.\n\n\n  if (value.tagName == 'I-AMPHTML-SHADOW-ROOT') {\n    return true;\n  }\n\n  return value.nodeType ==\n  /* DOCUMENT_FRAGMENT */\n  11 && Object.prototype.toString.call(value) === '[object ShadowRoot]';\n}\n/**\n * Finds the closest element that satisfies the callback from this element\n * up the DOM subtree.\n * @param {!Element} element\n * @param {function(!Element):boolean} callback\n * @param {Element=} opt_stopAt optional elemnt to stop the search at.\n * @return {?Element}\n */\n\n\nfunction closest(element, callback, opt_stopAt) {\n  for (var el = element; el && el !== opt_stopAt; el = el.parentElement) {\n    if (callback(el)) {\n      return el;\n    }\n  }\n\n  return null;\n}\n/**\n * Finds the closest node that satisfies the callback from this node\n * up the DOM subtree.\n * @param {!Node} node\n * @param {function(!Node):boolean} callback\n * @return {?Node}\n */\n\n\nfunction closestNode(node, callback) {\n  for (var n = node; n; n = n.parentNode) {\n    if (callback(n)) {\n      return n;\n    }\n  }\n\n  return null;\n}\n/**\n * Finds the closest ancestor element with the specified selector from this\n * element.\n * @param {!Element} element\n * @param {string} selector\n * @return {?Element} closest ancestor if found.\n */\n\n\nfunction closestAncestorElementBySelector(element, selector) {\n  if (element.closest) {\n    return element.closest(selector);\n  }\n\n  return closest(element, function (el) {\n    return matches(el, selector);\n  });\n}\n/**\n * Finds all ancestor elements that satisfy predicate.\n * @param {!Element} child\n * @param {function(!Element):boolean} predicate\n * @return {!Array<!Element>}\n */\n\n\nfunction ancestorElements(child, predicate) {\n  var ancestors = [];\n\n  for (var ancestor = child.parentElement; ancestor; ancestor = ancestor.parentElement) {\n    if (predicate(ancestor)) {\n      ancestors.push(ancestor);\n    }\n  }\n\n  return ancestors;\n}\n/**\n * Finds all ancestor elements that has the specified tag name.\n * @param {!Element} child\n * @param {string} tagName\n * @return {!Array<!Element>}\n */\n\n\nfunction ancestorElementsByTag(child, tagName) {\n  (0, _css.assertIsName)(tagName);\n  tagName = tagName.toUpperCase();\n  return ancestorElements(child, function (el) {\n    return el.tagName == tagName;\n  });\n}\n/**\n * Finds the first child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\n\n\nfunction childElement(parent, callback) {\n  for (var child = parent.firstElementChild; child; child = child.nextElementSibling) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n\n  return null;\n}\n/**\n * Finds all child elements that satisfy the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {!Array<!Element>}\n */\n\n\nfunction childElements(parent, callback) {\n  var children = [];\n\n  for (var child = parent.firstElementChild; child; child = child.nextElementSibling) {\n    if (callback(child)) {\n      children.push(child);\n    }\n  }\n\n  return children;\n}\n/**\n * Finds the last child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\n\n\nfunction lastChildElement(parent, callback) {\n  for (var child = parent.lastElementChild; child; child = child.previousElementSibling) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n\n  return null;\n}\n/**\n * Finds all child nodes that satisfy the callback.\n * These nodes can include Text, Comment and other child nodes.\n * @param {!Node} parent\n * @param {function(!Node):boolean} callback\n * @return {!Array<!Node>}\n */\n\n\nfunction childNodes(parent, callback) {\n  var nodes = [];\n\n  for (var child = parent.firstChild; child; child = child.nextSibling) {\n    if (callback(child)) {\n      nodes.push(child);\n    }\n  }\n\n  return nodes;\n}\n/**\n * Finds the first child element that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {?Element}\n */\n\n\nfunction childElementByAttr(parent, attr) {\n  (0, _css.assertIsName)(attr);\n  return (\n    /*OK*/\n    scopedQuerySelector(parent, \"> [\" + attr + \"]\")\n  );\n}\n/**\n * Finds the last child element that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {?Element}\n */\n\n\nfunction lastChildElementByAttr(parent, attr) {\n  (0, _css.assertIsName)(attr);\n  return lastChildElement(parent, function (el) {\n    return el.hasAttribute(attr);\n  });\n}\n/**\n * Finds all child elements that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {!NodeList<!Element>}\n */\n\n\nfunction childElementsByAttr(parent, attr) {\n  (0, _css.assertIsName)(attr);\n  return (\n    /*OK*/\n    scopedQuerySelectorAll(parent, \"> [\" + attr + \"]\")\n  );\n}\n/**\n * Finds the first child element that has the specified tag name.\n * @param {!Element} parent\n * @param {string} tagName\n * @return {?Element}\n */\n\n\nfunction childElementByTag(parent, tagName) {\n  (0, _css.assertIsName)(tagName);\n  return (\n    /*OK*/\n    scopedQuerySelector(parent, \"> \" + tagName)\n  );\n}\n/**\n * Finds all child elements with the specified tag name.\n * @param {!Element} parent\n * @param {string} tagName\n * @return {!NodeList<!Element>}\n */\n\n\nfunction childElementsByTag(parent, tagName) {\n  (0, _css.assertIsName)(tagName);\n  return (\n    /*OK*/\n    scopedQuerySelectorAll(parent, \"> \" + tagName)\n  );\n}\n/**\n * Checks if the given element matches the selector\n * @param  {!Element} el The element to verify\n * @param  {string} selector The selector to check against\n * @return {boolean} True if the element matched the selector. False otherwise.\n */\n\n\nfunction matches(el, selector) {\n  var matcher = el.matches || el.webkitMatchesSelector || el.mozMatchesSelector || el.msMatchesSelector || el.oMatchesSelector;\n\n  if (matcher) {\n    return matcher.call(el, selector);\n  }\n\n  return false; // IE8 always returns false.\n}\n/**\n * Finds the first descendant element with the specified name.\n * @param {!Element|!Document|!ShadowRoot} element\n * @param {string} tagName\n * @return {?Element}\n */\n\n\nfunction elementByTag(element, tagName) {\n  (0, _css.assertIsName)(tagName);\n  return element.\n  /*OK*/\n  querySelector(tagName);\n}\n/**\n * Finds all elements that matche `selector`, scoped inside `root`\n * for user-agents that do not support native scoping.\n *\n * This method isn't required for modern builds, can be removed.\n *\n * @param {!Element} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n */\n\n\nfunction scopedQuerySelectionFallback(root, selector) {\n  var unique = 'i-amphtml-scoped';\n  root.classList.add(unique);\n  var scopedSelector = (0, _css.prependSelectorsWith)(selector, \".\" + unique);\n  var elements = root.\n  /*OK*/\n  querySelectorAll(scopedSelector);\n  root.classList.remove(unique);\n  return elements;\n}\n/**\n * Finds the first element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element} root\n * @param {string} selector\n * @return {?Element}\n */\n\n\nfunction scopedQuerySelector(root, selector) {\n  if ((0, _css.isScopeSelectorSupported)(root)) {\n    return root.\n    /*OK*/\n    querySelector((0, _css.prependSelectorsWith)(selector, ':scope'));\n  } // Only IE.\n\n\n  var fallbackResult = scopedQuerySelectionFallback(root, selector);\n  return fallbackResult[0] === undefined ? null : fallbackResult[0];\n}\n/**\n * Finds every element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n */\n\n\nfunction scopedQuerySelectorAll(root, selector) {\n  if ((0, _css.isScopeSelectorSupported)(root)) {\n    return root.\n    /*OK*/\n    querySelectorAll((0, _css.prependSelectorsWith)(selector, ':scope'));\n  } // Only IE.\n\n\n  return scopedQuerySelectionFallback(root, selector);\n}\n/**\n * Returns element data-param- attributes as url parameters key-value pairs.\n * e.g. data-param-some-attr=value -> {someAttr: value}.\n * @param {!Element} element\n * @param {function(string):string=} opt_computeParamNameFunc to compute the\n *    parameter name, get passed the camel-case parameter name.\n * @param {!RegExp=} opt_paramPattern Regex pattern to match data attributes.\n * @return {!JsonObject}\n */\n\n\nfunction getDataParamsFromAttributes(element, opt_computeParamNameFunc, opt_paramPattern) {\n  var computeParamNameFunc = opt_computeParamNameFunc || function (key) {\n    return key;\n  };\n\n  var dataset = element.dataset;\n  var params = (0, _object.dict)();\n  var paramPattern = opt_paramPattern ? opt_paramPattern : /^param(.+)/;\n\n  for (var key in dataset) {\n    var _matches = key.match(paramPattern);\n\n    if (_matches) {\n      var param = _matches[1][0].toLowerCase() + _matches[1].substr(1);\n\n      params[computeParamNameFunc(param)] = dataset[key];\n    }\n  }\n\n  return params;\n}\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node} opt_stopNode\n * @return {boolean}\n */\n\n\nfunction hasNextNodeInDocumentOrder(element, opt_stopNode) {\n  var currentElement = element;\n\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while ((currentElement = currentElement.parentNode) && currentElement != opt_stopNode);\n\n  return false;\n}\n/**\n * Returns a clone of the content of a template element.\n *\n * Polyfill to replace .content access for browsers that do not support\n * HTMLTemplateElements natively.\n *\n * @param {!HTMLTemplateElement|!Element} template\n * @return {!DocumentFragment}\n */\n\n\nfunction templateContentClone(template) {\n  if ('content' in template) {\n    return template.content.cloneNode(true);\n  } else {\n    var content = template.ownerDocument.createDocumentFragment();\n    copyChildren(template, content);\n    return content;\n  }\n}\n/**\n * Iterate over an array-like.\n * Test cases: https://jsbench.github.io/#f638cacc866a1b2d6e517e6cfa900d6b\n * @param {!IArrayLike<T>} iterable\n * @param {function(T, number)} cb\n * @template T\n */\n\n\nfunction iterateCursor(iterable, cb) {\n  var length = iterable.length;\n\n  for (var i = 0; i < length; i++) {\n    cb(iterable[i], i);\n  }\n}\n/**\n * This method wraps around window's open method. It first tries to execute\n * `open` call with the provided target and if it fails, it retries the call\n * with the `_top` target. This is necessary given that in some embedding\n * scenarios, such as iOS' WKWebView, navigation to `_blank` and other targets\n * is blocked by default.\n *\n * @param {!Window} win\n * @param {string} url\n * @param {string} target\n * @param {string=} opt_features\n * @return {?Window}\n */\n\n\nfunction openWindowDialog(win, url, target, opt_features) {\n  // Try first with the specified target. If we're inside the WKWebView or\n  // a similar environments, this method is expected to fail by default for\n  // all targets except `_top`.\n  var res;\n\n  try {\n    res = win.open(url, target, opt_features);\n  } catch (e) {\n    (0, _log.dev)().error('DOM', 'Failed to open url on target: ', target, e);\n  } // Then try with `_top` target.\n\n\n  if (!res && target != '_top' && !(0, _string.includes)(opt_features || '', 'noopener')) {\n    res = win.open(url, '_top');\n  }\n\n  return res;\n}\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isJsonScriptTag(element) {\n  return element.tagName == 'SCRIPT' && element.hasAttribute('type') && element.getAttribute('type').toUpperCase() == 'APPLICATION/JSON';\n}\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isJsonLdScriptTag(element) {\n  return element.tagName == 'SCRIPT' && element.getAttribute('type').toUpperCase() == 'APPLICATION/LD+JSON';\n}\n/**\n * Whether the page's direction is right to left or not.\n * @param {!Document} doc\n * @return {boolean}\n */\n\n\nfunction isRTL(doc) {\n  var dir = doc.body.getAttribute('dir') || doc.documentElement.getAttribute('dir') || 'ltr';\n  return dir == 'rtl';\n}\n/**\n * Escapes `<`, `>` and other HTML charcaters with their escaped forms.\n * @param {string} text\n * @return {string}\n */\n\n\nfunction escapeHtml(text) {\n  if (!text) {\n    return text;\n  }\n\n  return text.replace(HTML_ESCAPE_REGEX, escapeHtmlChar);\n}\n/**\n * @param {string} c\n * @return {string}\n */\n\n\nfunction escapeHtmlChar(c) {\n  return HTML_ESCAPE_CHARS[c];\n}\n/**\n * Tries to focus on the given element; fails silently if browser throws an\n * exception.\n * @param {!Element} element\n */\n\n\nfunction tryFocus(element) {\n  try {\n    element.\n    /*OK*/\n    focus();\n  } catch (e) {// IE <= 7 may throw exceptions when focusing on hidden items.\n  }\n}\n/**\n * Whether the given window is in an iframe or not.\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nfunction isIframed(win) {\n  return win.parent && win.parent != win;\n}\n/**\n * Determines if this element is an AMP element\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isAmpElement(element) {\n  var tag = element.tagName; // Use prefix to recognize AMP element. This is necessary because stub\n  // may not be attached yet.\n\n  return (0, _string.startsWith)(tag, 'AMP-') && // Some \"amp-*\" elements are not really AMP elements. :smh:\n  !(tag == 'AMP-STICKY-AD-TOP-PADDING' || tag == 'AMP-BODY');\n}\n/**\n * Return a promise that resolve when an AMP element upgrade from HTMLElement\n * to CustomElement\n * @param {!Element} element\n * @return {!Promise<!Element>}\n */\n\n\nfunction whenUpgradedToCustomElement(element) {\n  (0, _log.devAssert)(isAmpElement(element), 'element is not AmpElement');\n\n  if (element.createdCallback) {\n    // Element already is CustomElement;\n    return Promise.resolve(element);\n  } // If Element is still HTMLElement, wait for it to upgrade to customElement\n  // Note: use pure string to avoid obfuscation between versions.\n\n\n  if (!element[UPGRADE_TO_CUSTOMELEMENT_PROMISE]) {\n    var deferred = new _promise.Deferred();\n    element[UPGRADE_TO_CUSTOMELEMENT_PROMISE] = deferred.promise;\n    element[UPGRADE_TO_CUSTOMELEMENT_RESOLVER] = deferred.resolve;\n  }\n\n  return element[UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n}\n/**\n * Replacement for `Element.requestFullscreen()` method.\n * https://developer.mozilla.org/en-US/docs/Web/API/Element/requestFullscreen\n * @param {!Element} element\n */\n\n\nfunction fullscreenEnter(element) {\n  var requestFs = element.requestFullscreen || element.requestFullScreen || element.webkitRequestFullscreen || element.webkitEnterFullscreen || element.msRequestFullscreen || element.mozRequestFullScreen;\n\n  if (requestFs) {\n    requestFs.call(element);\n  }\n}\n/**\n * Replacement for `Document.exitFullscreen()` method.\n * https://developer.mozilla.org/en-US/docs/Web/API/Document/exitFullscreen\n * @param {!Element} element\n */\n\n\nfunction fullscreenExit(element) {\n  var elementBoundExit = element.cancelFullScreen || element.exitFullscreen || element.webkitExitFullscreen || element.webkitCancelFullScreen || element.mozCancelFullScreen || element.msExitFullscreen;\n\n  if (elementBoundExit) {\n    elementBoundExit.call(element);\n    return;\n  }\n\n  var ownerDocument = element.ownerDocument;\n\n  if (!ownerDocument) {\n    return;\n  }\n\n  var docBoundExit = ownerDocument.cancelFullScreen || ownerDocument.exitFullscreencancelFullScreen || ownerDocument.webkitExitFullscreencancelFullScreen || ownerDocument.webkitCancelFullScreencancelFullScreen || ownerDocument.mozCancelFullScreencancelFullScreen || ownerDocument.msExitFullscreen;\n\n  if (docBoundExit) {\n    docBoundExit.call(ownerDocument);\n  }\n}\n/**\n * Replacement for `Document.fullscreenElement`.\n * https://developer.mozilla.org/en-US/docs/Web/API/Document/fullscreenElement\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isFullscreenElement(element) {\n  var webkitDisplayingFullscreen = element.webkitDisplayingFullscreen;\n\n  if (webkitDisplayingFullscreen !== undefined) {\n    return webkitDisplayingFullscreen;\n  }\n\n  var ownerDocument = element.ownerDocument;\n\n  if (!ownerDocument) {\n    return false;\n  }\n\n  var fullscreenElement = ownerDocument.fullscreenElement || ownerDocument.webkitFullscreenElement || ownerDocument.mozFullScreenElement || ownerDocument.webkitCurrentFullScreenElement;\n  return fullscreenElement == element;\n}\n/**\n * Returns true if node is not disabled.\n *\n * IE8 can return false positives, see {@link matches}.\n * @param {!Element} element\n * @return {boolean}\n * @see https://www.w3.org/TR/html5/forms.html#concept-fe-disabled\n */\n\n\nfunction isEnabled(element) {\n  return !(element.disabled || matches(element, ':disabled'));\n}\n/**\n * A sorting comparator that sorts elements in DOM tree order.\n * A first sibling is sorted to be before its nextSibling.\n * A parent node is sorted to be before a child.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/compareDocumentPosition\n *\n * @param {!Element} element1\n * @param {!Element} element2\n * @return {number}\n */\n\n\nfunction domOrderComparator(element1, element2) {\n  if (element1 === element2) {\n    return 0;\n  }\n\n  var pos = element1.compareDocumentPosition(element2);\n  var precedingOrContains = Node.DOCUMENT_POSITION_PRECEDING | Node.DOCUMENT_POSITION_CONTAINS; // if fe2 is preceding or contains fe1 then, fe1 is after fe2\n\n  if (pos & precedingOrContains) {\n    return 1;\n  } // if fe2 is following or contained by fe1, then fe1 is before fe2\n\n\n  return -1;\n}\n/**\n * Like `Element.prototype.toggleAttribute`. This either toggles an attribute\n * on by adding an attribute with an empty value, or toggles it off by removing\n * the attribute. This does not mutate the element if the new state matches\n * the existing state.\n * @param {!Element} element An element to toggle the attribute for.\n * @param {string} name The name of the attribute.\n * @param {boolean=} forced Whether the attribute should be forced on/off. If\n *    not specified, it will be toggled from the current state.\n * @return {boolean} Whether or not the element now has the attribute.\n */\n\n\nfunction toggleAttribute(element, name, forced) {\n  var hasAttribute = element.hasAttribute(name);\n  var enabled = forced !== undefined ? forced : !hasAttribute;\n\n  if (enabled !== hasAttribute) {\n    if (enabled) {\n      element.setAttribute(name, '');\n    } else {\n      element.removeAttribute(name);\n    }\n  }\n\n  return enabled;\n}\n/**\n * @param {!Window} win\n * @return {number} The width of the vertical scrollbar, in pixels.\n */\n\n\nfunction getVerticalScrollbarWidth(win) {\n  var documentElement = win.document.documentElement;\n  var windowWidth = win.\n  /*OK*/\n  innerWidth;\n  var documentWidth = documentElement.\n  /*OK*/\n  clientWidth;\n  return windowWidth - documentWidth;\n}\n\n},{\"./css\":36,\"./log\":68,\"./string\":126,\"./types\":131,\"./utils/object\":145,\"./utils/promise\":147}],42:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getElementService = getElementService;\nexports.getElementServiceIfAvailable = getElementServiceIfAvailable;\nexports.getElementServiceForDoc = getElementServiceForDoc;\nexports.getElementServiceIfAvailableForDoc = getElementServiceIfAvailableForDoc;\nexports.getElementServiceIfAvailableForDocInEmbedScope = getElementServiceIfAvailableForDocInEmbedScope;\nexports.extensionScriptsInNode = extensionScriptsInNode;\nexports.isExtensionScriptInNode = isExtensionScriptInNode;\n\nvar dom = _interopRequireWildcard(require(\"./dom\"));\n\nvar _service = require(\"./service\");\n\nvar _types = require(\"./types\");\n\nvar _log = require(\"./log\");\n\nfunction _getRequireWildcardCache() { if (typeof WeakMap !== \"function\") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\nfunction getElementService(win, id, extension, opt_element) {\n  return getElementServiceIfAvailable(win, id, extension, opt_element).then(function (service) {\n    return assertService(service, id, extension);\n  });\n}\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\n\n\nfunction getElementServiceIfAvailable(win, id, extension, opt_element) {\n  var s = (0, _service.getServicePromiseOrNull)(win, id);\n\n  if (s) {\n    return (\n      /** @type {!Promise<?Object>} */\n      s\n    );\n  }\n\n  return getElementServicePromiseOrNull(win, id, extension, opt_element);\n}\n/**\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @return {boolean} Whether this element is scheduled to be loaded.\n */\n\n\nfunction isElementScheduled(win, elementName) {\n  // Set in custom-element.js\n  if (!win.__AMP_EXTENDED_ELEMENTS) {\n    return false;\n  }\n\n  return !!win.__AMP_EXTENDED_ELEMENTS[elementName];\n}\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\n\n\nfunction getElementServiceForDoc(element, id, extension, opt_element) {\n  return getElementServiceIfAvailableForDoc(element, id, extension, opt_element).then(function (service) {\n    return assertService(service, id, extension);\n  });\n}\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\n\n\nfunction getElementServiceIfAvailableForDoc(element, id, extension, opt_element) {\n  var s = (0, _service.getServicePromiseOrNullForDoc)(element, id);\n\n  if (s) {\n    return (\n      /** @type {!Promise<?Object>} */\n      s\n    );\n  }\n\n  var ampdoc = (0, _service.getAmpdoc)(element);\n  return ampdoc.waitForBodyOpen().then(function () {\n    return waitForExtensionIfPresent(ampdoc.win, extension, ampdoc.win.document.head);\n  }).then(function () {\n    // If this service is provided by an element, then we can't depend on\n    // the service (they may not use the element).\n    if (opt_element) {\n      return (0, _service.getServicePromiseOrNullForDoc)(element, id);\n    } else if (isElementScheduled(ampdoc.win, extension)) {\n      return (0, _service.getServicePromiseForDoc)(element, id);\n    }\n\n    return null;\n  });\n}\n/**\n * Returns a promise for service for the given id in the embed scope of\n * a given element, if it exists. Falls back to ampdoc scope if the element\n * is not embedded.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<?Object>}\n */\n\n\nfunction getElementServiceIfAvailableForDocInEmbedScope(element, id, extension) {\n  var s = (0, _service.getExistingServiceForDocInEmbedScope)(element, id);\n\n  if (s) {\n    return (\n      /** @type {!Promise<?Object>} */\n      Promise.resolve(s)\n    );\n  }\n\n  var win = (0, _types.toWin)(element.ownerDocument.defaultView);\n  var topWin = (0, _service.getTopWindow)(win); // In embeds, doc services are stored on the embed window.\n\n  if (win !== topWin) {\n    return getElementServicePromiseOrNull(win, id, extension);\n  } else {\n    // Only fallback to element's ampdoc (top-level) if not embedded.\n    return getElementServiceIfAvailableForDoc(element, id, extension);\n  }\n}\n/**\n * Throws user error if `service` is null.\n * @param {Object} service\n * @param {string} id\n * @param {string} extension\n * @return {!Object}\n * @private\n * @closurePrimitive {asserts.matchesReturn}\n */\n\n\nfunction assertService(service, id, extension) {\n  return (\n    /** @type {!Object} */\n    (0, _log.userAssert)(service, 'Service %s was requested to be provided through %s, ' + 'but %s is not loaded in the current page. To fix this ' + 'problem load the JavaScript file for %s in this page.', id, extension, extension, extension)\n  );\n}\n/**\n * Get list of all the extension JS files.\n * @param {HTMLHeadElement|Element|ShadowRoot} head\n * @return {!Array<string>}\n */\n\n\nfunction extensionScriptsInNode(head) {\n  // ampdoc.getHeadNode() can return null.\n  if (!head) {\n    return [];\n  }\n\n  var scripts = {}; // Note: Some extensions don't have [custom-element] or [custom-template]\n  // e.g. amp-viewer-integration.\n\n  var list = head.querySelectorAll('script[custom-element],script[custom-template]');\n\n  for (var i = 0; i < list.length; i++) {\n    var script = list[i];\n    var name = script.getAttribute('custom-element') || script.getAttribute('custom-template');\n    scripts[name] = true;\n  }\n\n  return Object.keys(scripts);\n}\n/**\n * Waits for body to be present then verifies that an extension script is\n * present in head for installation.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} extensionId\n * @return {!Promise<boolean>}\n */\n\n\nfunction isExtensionScriptInNode(ampdoc, extensionId) {\n  return ampdoc.waitForBodyOpen().then(function () {\n    return extensionScriptInNode(ampdoc.getHeadNode(), extensionId);\n  });\n}\n/**\n * Verifies that an extension script is present in head for\n * installation.\n * @param {HTMLHeadElement|Element|ShadowRoot} head\n * @param {string} extensionId\n * @return {boolean}\n * @private\n */\n\n\nfunction extensionScriptInNode(head, extensionId) {\n  return extensionScriptsInNode(head).includes(extensionId);\n}\n/**\n * Waits for an extension if its script is present\n * @param {!Window} win\n * @param {string} extension\n * @param {HTMLHeadElement|Element|ShadowRoot} head\n * @return {!Promise}\n * @private\n */\n\n\nfunction waitForExtensionIfPresent(win, extension, head) {\n  /**\n   * If there is an extension script wait for it to load before trying\n   * to get the service. Prevents a race condition when everything but\n   * the extensions is in cache. If there is no script then it's either\n   * not present, or the service was defined by a test. In those cases\n   * we don't wait around for an extension that does not exist.\n   */\n  // TODO(jpettitt) investigate registerExtension to short circuit\n  // the dom call in extensionScriptsInNode()\n  if (!extensionScriptInNode(head, extension)) {\n    return Promise.resolve();\n  }\n\n  var extensions = (0, _service.getService)(win, 'extensions');\n  return (\n    /** @type {!Promise<?Object>} */\n    extensions.waitForExtension(win, extension)\n  );\n}\n/**\n * Returns the promise for service with `id` on the given window if available.\n * Otherwise, resolves with null (service was not registered).\n * @param {!Window} win\n * @param {string} id\n * @param {string} extension\n * @param {boolean=} opt_element\n * @return {!Promise<Object>}\n * @private\n */\n\n\nfunction getElementServicePromiseOrNull(win, id, extension, opt_element) {\n  return dom.waitForBodyOpenPromise(win.document).then(function () {\n    return waitForExtensionIfPresent(win, extension, win.document.head);\n  }).then(function () {\n    // If this service is provided by an element, then we can't depend on\n    // the service (they may not use the element).\n    if (opt_element) {\n      return (0, _service.getServicePromiseOrNull)(win, id);\n    } else if (isElementScheduled(win, extension)) {\n      return (0, _service.getServicePromise)(win, id);\n    }\n\n    return null;\n  });\n}\n\n},{\"./dom\":41,\"./log\":68,\"./service\":79,\"./types\":131}],43:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ElementStub = exports.stubbedElements = void 0;\n\nvar _baseElement = require(\"./base-element\");\n\nvar _log = require(\"./log\");\n\nfunction _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return self; }\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/** @type {!Array} */\nvar stubbedElements = [];\nexports.stubbedElements = stubbedElements;\n\nvar ElementStub =\n/*#__PURE__*/\nfunction (_BaseElement) {\n  _inheritsLoose(ElementStub, _BaseElement);\n\n  /** @param {!AmpElement} element */\n  function ElementStub(element) {\n    var _this;\n\n    _this = _BaseElement.call(this, element) || this;\n    stubbedElements.push(_assertThisInitialized(_this));\n    return _this;\n  }\n  /** @override */\n\n\n  var _proto = ElementStub.prototype;\n\n  _proto.getLayoutPriority = function getLayoutPriority() {\n    return (0, _log.devAssert)(0, 'Cannot get priority of stubbed element');\n  }\n  /** @override */\n  ;\n\n  _proto.isLayoutSupported = function isLayoutSupported(unusedLayout) {\n    // Always returns true and will eventually call this method on the actual\n    // element.\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.reconstructWhenReparented = function reconstructWhenReparented() {\n    // No real state so no reason to reconstruct.\n    return false;\n  };\n\n  return ElementStub;\n}(_baseElement.BaseElement);\n\nexports.ElementStub = ElementStub;\n\n},{\"./base-element\":29,\"./log\":68}],44:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.reportErrorForWin = reportErrorForWin;\nexports.reportError = reportError;\nexports.cancellation = cancellation;\nexports.isCancellation = isCancellation;\nexports.blockedByConsentError = blockedByConsentError;\nexports.isBlockedByConsent = isBlockedByConsent;\nexports.installErrorReporting = installErrorReporting;\nexports.reportErrorToServerOrViewer = reportErrorToServerOrViewer;\nexports.maybeReportErrorToViewer = maybeReportErrorToViewer;\nexports.errorReportingDataForViewer = errorReportingDataForViewer;\nexports.getErrorReportData = getErrorReportData;\nexports.detectNonAmpJs = detectNonAmpJs;\nexports.resetAccumulatedErrorMessagesForTesting = resetAccumulatedErrorMessagesForTesting;\nexports.detectJsEngineFromStack = detectJsEngineFromStack;\nexports.reportErrorToAnalytics = reportErrorToAnalytics;\n\nvar _ampEvents = require(\"./amp-events\");\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object\");\n\nvar _experiments = require(\"./experiments\");\n\nvar _exponentialBackoff = require(\"./exponential-backoff\");\n\nvar _mode = require(\"./mode\");\n\nvar _eventHelper = require(\"./event-helper\");\n\nvar _url = require(\"./url\");\n\nvar _styleInstaller = require(\"./style-installer\");\n\nvar _string = require(\"./string\");\n\nvar _analytics = require(\"./analytics\");\n\nvar _config = require(\"./config\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @const {string}\n */\nvar CANCELLED = 'CANCELLED';\n/**\n * @const {string}\n */\n\nvar BLOCK_BY_CONSENT = 'BLOCK_BY_CONSENT';\n/**\n * @const {string}\n */\n\nvar ABORTED = 'AbortError';\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\n\nvar NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD = 0.001;\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\n\nvar USER_ERROR_THROTTLE_THRESHOLD = 0.1;\n/**\n * Collects error messages, so they can be included in subsequent reports.\n * That allows identifying errors that might be caused by previous errors.\n */\n\nvar accumulatedErrorMessages = self.__AMP_ERRORS || []; // Use a true global, to avoid multi-module inclusion issues.\n\nself.__AMP_ERRORS = accumulatedErrorMessages;\n/**\n * Pushes element into array, keeping at most the most recent limit elements\n *\n * @param {!Array<T>} array\n * @param {T} element\n * @param {number} limit\n * @template T\n */\n\nfunction pushLimit(array, element, limit) {\n  if (array.length >= limit) {\n    array.splice(0, array.length - limit + 1);\n  }\n\n  array.push(element);\n}\n/**\n * A wrapper around our exponentialBackoff, to lazy initialize it to avoid an\n * un-DCE'able side-effect.\n * @param {function()} work the function to execute after backoff\n * @return {number} the setTimeout id\n */\n\n\nvar _reportingBackoff = function reportingBackoff(work) {\n  // Set reportingBackoff as the lazy-created function. JS Vooodoooo.\n  _reportingBackoff = (0, _exponentialBackoff.exponentialBackoff)(1.5);\n  return _reportingBackoff(work);\n};\n/**\n * Attempts to stringify a value, falling back to String.\n * @param {*} value\n * @return {string}\n */\n\n\nfunction tryJsonStringify(value) {\n  try {\n    // Cast is fine, because we really don't care here. Just trying.\n    return JSON.stringify(\n    /** @type {!JsonObject} */\n    value);\n  } catch (e) {\n    return String(value);\n  }\n}\n/**\n * The true JS engine, as detected by inspecting an Error stack. This should be\n * used with the userAgent to tell definitely. I.e., Chrome on iOS is really a\n * Safari JS engine.\n */\n\n\nvar detectedJsEngine;\n/**\n * @param {!Window} win\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n */\n\nfunction reportErrorForWin(win, error, opt_associatedElement) {\n  reportError(error, opt_associatedElement);\n\n  if (error && !!win && (0, _log.isUserErrorMessage)(error.message) && !(0, _log.isUserErrorEmbed)(error.message)) {\n    reportErrorToAnalytics(\n    /** @type {!Error} */\n    error, win);\n  }\n}\n/**\n * Reports an error. If the error has an \"associatedElement\" property\n * the element is marked with the `i-amphtml-element-error` and displays\n * the message itself. The message is always send to the console.\n * If the error has a \"messageArray\" property, that array is logged.\n * This way one gets the native fidelity of the console for things like\n * elements instead of stringification.\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n * @return {!Error}\n */\n\n\nfunction reportError(error, opt_associatedElement) {\n  try {\n    // Convert error to the expected type.\n    var isValidError;\n\n    if (error) {\n      if (error.message !== undefined) {\n        error = (0, _log.duplicateErrorIfNecessary)(\n        /** @type {!Error} */\n        error);\n        isValidError = true;\n      } else {\n        var origError = error;\n        error = new Error(tryJsonStringify(origError));\n        error.origError = origError;\n      }\n    } else {\n      error = new Error('Unknown error');\n    } // Report if error is not an expected type.\n\n\n    if (!isValidError && (0, _mode.getMode)().localDev && !(0, _mode.getMode)().test) {\n      setTimeout(function () {\n        var rethrow = new Error('_reported_ Error reported incorrectly: ' + error);\n        throw rethrow;\n      });\n    }\n\n    if (error.reported) {\n      return (\n        /** @type {!Error} */\n        error\n      );\n    }\n\n    error.reported = true; // Update element.\n\n    var element = opt_associatedElement || error.associatedElement;\n\n    if (element && element.classList) {\n      element.classList.add('i-amphtml-error');\n\n      if ((0, _mode.getMode)().development) {\n        element.classList.add('i-amphtml-element-error');\n        element.setAttribute('error-message', error.message);\n      }\n    } // Report to console.\n\n\n    if (self.console) {\n      var output = console.error || console.log;\n\n      if (error.messageArray) {\n        output.apply(console, error.messageArray);\n      } else {\n        if (element) {\n          output.call(console, error.message, element);\n        } else if (!(0, _mode.getMode)().minified) {\n          output.call(console, error.stack);\n        } else {\n          output.call(console, error.message);\n        }\n      }\n    }\n\n    if (element && element.dispatchCustomEventForTesting) {\n      element.dispatchCustomEventForTesting(_ampEvents.AmpEvents.ERROR, error.message);\n    } // 'call' to make linter happy. And .call to make compiler happy\n    // that expects some @this.\n\n\n    onError['call'](undefined, undefined, undefined, undefined, undefined, error);\n  } catch (errorReportingError) {\n    setTimeout(function () {\n      throw errorReportingError;\n    });\n  }\n\n  return (\n    /** @type {!Error} */\n    error\n  );\n}\n/**\n * Returns an error for a cancellation of a promise.\n * @return {!Error}\n */\n\n\nfunction cancellation() {\n  return new Error(CANCELLED);\n}\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\n\n\nfunction isCancellation(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n\n  if (typeof errorOrMessage == 'string') {\n    return (0, _string.startsWith)(errorOrMessage, CANCELLED);\n  }\n\n  if (typeof errorOrMessage.message == 'string') {\n    return (0, _string.startsWith)(errorOrMessage.message, CANCELLED);\n  }\n\n  return false;\n}\n/**\n * Returns an error for component blocked by consent\n * @return {!Error}\n */\n\n\nfunction blockedByConsentError() {\n  return new Error(BLOCK_BY_CONSENT);\n}\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\n\n\nfunction isBlockedByConsent(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n\n  if (typeof errorOrMessage == 'string') {\n    return (0, _string.startsWith)(errorOrMessage, BLOCK_BY_CONSENT);\n  }\n\n  if (typeof errorOrMessage.message == 'string') {\n    return (0, _string.startsWith)(errorOrMessage.message, BLOCK_BY_CONSENT);\n  }\n\n  return false;\n}\n/**\n * Install handling of global unhandled exceptions.\n * @param {!Window} win\n */\n\n\nfunction installErrorReporting(win) {\n  win.onerror =\n  /** @type {!Function} */\n  onError;\n  win.addEventListener('unhandledrejection', function (event) {\n    if (event.reason && (event.reason.message === CANCELLED || event.reason.message === BLOCK_BY_CONSENT || event.reason.message === ABORTED)) {\n      event.preventDefault();\n      return;\n    }\n\n    reportError(event.reason || new Error('rejected promise ' + event));\n  });\n}\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @this {!Window|undefined}\n */\n\n\nfunction onError(message, filename, line, col, error) {\n  var _this = this;\n\n  // Make an attempt to unhide the body.\n  if (this && this.document) {\n    (0, _styleInstaller.makeBodyVisibleRecovery)(this.document);\n  }\n\n  if ((0, _mode.getMode)().localDev || (0, _mode.getMode)().development || (0, _mode.getMode)().test) {\n    return;\n  }\n\n  var hasNonAmpJs = false;\n\n  try {\n    hasNonAmpJs = detectNonAmpJs(self);\n  } catch (ignore) {// Ignore errors during error report generation.\n  }\n\n  if (hasNonAmpJs && Math.random() > 0.01) {\n    // Only report 1% of errors on pages with non-AMP JS.\n    // These errors can almost never be acted upon, but spikes such as\n    // due to buggy browser extensions may be helpful to notify authors.\n    return;\n  }\n\n  var data = getErrorReportData(message, filename, line, col, error, hasNonAmpJs);\n\n  if (data) {\n    _reportingBackoff(function () {\n      try {\n        return reportErrorToServerOrViewer(_this,\n        /** @type {!JsonObject} */\n        data).catch(function () {// catch async errors to avoid recursive errors.\n        });\n      } catch (e) {// catch async errors to avoid recursive errors.\n      }\n    });\n  }\n}\n/**\n * Passes the given error data to either server or viewer.\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {Promise<undefined>}\n */\n\n\nfunction reportErrorToServerOrViewer(win, data) {\n  // Report the error to viewer if it has the capability. The data passed\n  // to the viewer is exactly the same as the data passed to the server\n  // below.\n  return maybeReportErrorToViewer(win, data).then(function (reportedErrorToViewer) {\n    if (!reportedErrorToViewer) {\n      var xhr = new XMLHttpRequest();\n      xhr.open('POST', _config.urls.errorReporting, true);\n      xhr.send(JSON.stringify(data));\n    }\n  });\n}\n/**\n * Passes the given error data to the viewer if the following criteria is met:\n * - The viewer is a trusted viewer\n * - The viewer has the `errorReporter` capability\n * - The AMP doc is in single doc mode\n * - The AMP doc is opted-in for error interception (`<html>` tag has the\n *   `report-errors-to-viewer` attribute)\n *\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {!Promise<boolean>} `Promise<True>` if the error was sent to the\n *     viewer, `Promise<False>` otherwise.\n * @visibleForTesting\n */\n\n\nfunction maybeReportErrorToViewer(win, data) {\n  var ampdocService = _services.Services.ampdocServiceFor(win);\n\n  if (!ampdocService.isSingleDoc()) {\n    return Promise.resolve(false);\n  }\n\n  var ampdocSingle = ampdocService.getSingleDoc();\n  var htmlElement = ampdocSingle.getRootNode().documentElement;\n  var docOptedIn = htmlElement.hasAttribute('report-errors-to-viewer');\n\n  if (!docOptedIn) {\n    return Promise.resolve(false);\n  }\n\n  var viewer = _services.Services.viewerForDoc(ampdocSingle);\n\n  if (!viewer.hasCapability('errorReporter')) {\n    return Promise.resolve(false);\n  }\n\n  return viewer.isTrustedViewer().then(function (viewerTrusted) {\n    if (!viewerTrusted) {\n      return false;\n    }\n\n    viewer.sendMessage('error', errorReportingDataForViewer(data));\n    return true;\n  });\n}\n/**\n * Strips down the error reporting data to a minimal set\n * to be sent to the viewer.\n * @param {!JsonObject} errorReportData\n * @return {!JsonObject}\n * @visibleForTesting\n */\n\n\nfunction errorReportingDataForViewer(errorReportData) {\n  return (0, _object.dict)({\n    'm': errorReportData['m'],\n    // message\n    'a': errorReportData['a'],\n    // isUserError\n    's': errorReportData['s'],\n    // error stack\n    'el': errorReportData['el'],\n    // tagName\n    'ex': errorReportData['ex'],\n    // expected error?\n    'v': errorReportData['v'],\n    // runtime\n    'jse': errorReportData['jse'] // detectedJsEngine\n\n  });\n}\n/**\n * @param {string|undefined}  message\n * @param {*|undefined} error\n * @return {string}\n */\n\n\nfunction buildErrorMessage_(message, error) {\n  if (error) {\n    if (error.message) {\n      message = error.message;\n    } else {\n      // This should never be a string, but sometimes it is.\n      message = String(error);\n    }\n  }\n\n  if (!message) {\n    message = 'Unknown error';\n  }\n\n  return message;\n}\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @param {boolean} hasNonAmpJs\n * @return {!JsonObject|undefined} The data to post\n * visibleForTesting\n */\n\n\nfunction getErrorReportData(message, filename, line, col, error, hasNonAmpJs) {\n  message = buildErrorMessage_(message, error); // An \"expected\" error is still an error, i.e. some features are disabled\n  // or not functioning fully because of it. However, it's an expected\n  // error. E.g. as is the case with some browser API missing (storage).\n  // Thus, the error can be classified differently by log aggregators.\n  // The main goal is to monitor that an \"expected\" error doesn't deteriorate\n  // over time. It's impossible to completely eliminate it.\n\n  var expected = !!(error && error.expected);\n\n  if (/_reported_/.test(message)) {\n    return;\n  }\n\n  if (message == CANCELLED) {\n    return;\n  }\n\n  var detachedWindow = !(self && self.window);\n  var throttleBase = Math.random(); // We throttle load errors and generic \"Script error.\" errors\n  // that have no information and thus cannot be acted upon.\n\n  if ((0, _eventHelper.isLoadErrorMessage)(message) || // See https://github.com/ampproject/amphtml/issues/7353\n  // for context.\n  message == 'Script error.' || // Window has become detached, really anything can happen\n  // at this point.\n  detachedWindow) {\n    expected = true;\n\n    if (throttleBase > NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD) {\n      return;\n    }\n  }\n\n  var isUserError = (0, _log.isUserErrorMessage)(message); // Only report a subset of user errors.\n\n  if (isUserError && throttleBase > USER_ERROR_THROTTLE_THRESHOLD) {\n    return;\n  } // This is the App Engine app in\n  // https://github.com/ampproject/error-tracker\n  // It stores error reports via https://cloud.google.com/error-reporting/\n  // for analyzing production issues.\n\n\n  var data =\n  /** @type {!JsonObject} */\n  Object.create(null);\n  data['v'] = (0, _mode.getMode)().rtvVersion;\n  data['noAmp'] = hasNonAmpJs ? '1' : '0';\n  data['m'] = message.replace(_log.USER_ERROR_SENTINEL, '');\n  data['a'] = isUserError ? '1' : '0'; // Errors are tagged with \"ex\" (\"expected\") label to allow loggers to\n  // classify these errors as benchmarks and not exceptions.\n\n  data['ex'] = expected ? '1' : '0';\n  data['dw'] = detachedWindow ? '1' : '0';\n  var runtime = '1p';\n\n  if (self.context && self.context.location) {\n    data['3p'] = '1';\n    runtime = '3p';\n  } else if ((0, _mode.getMode)().runtime) {\n    runtime = (0, _mode.getMode)().runtime;\n  }\n\n  if ((0, _mode.getMode)().singlePassType) {\n    data['spt'] = (0, _mode.getMode)().singlePassType;\n  }\n\n  data['rt'] = runtime; // Add our a4a id if we are inabox\n\n  if (runtime === 'inabox') {\n    data['adid'] = (0, _mode.getMode)().a4aId;\n  } // TODO(erwinm): Remove ca when all systems read `bt` instead of `ca` to\n  // identify js binary type.\n\n\n  data['ca'] = (0, _experiments.isCanary)(self) ? '1' : '0'; // Pass binary type.\n\n  data['bt'] = (0, _experiments.getBinaryType)(self);\n\n  if (self.location.ancestorOrigins && self.location.ancestorOrigins[0]) {\n    data['or'] = self.location.ancestorOrigins[0];\n  }\n\n  if (self.viewerState) {\n    data['vs'] = self.viewerState;\n  } // Is embedded?\n\n\n  if (self.parent && self.parent != self) {\n    data['iem'] = '1';\n  }\n\n  if (self.AMP && self.AMP.viewer) {\n    var resolvedViewerUrl = self.AMP.viewer.getResolvedViewerUrl();\n    var messagingOrigin = self.AMP.viewer.maybeGetMessagingOrigin();\n\n    if (resolvedViewerUrl) {\n      data['rvu'] = resolvedViewerUrl;\n    }\n\n    if (messagingOrigin) {\n      data['mso'] = messagingOrigin;\n    }\n  }\n\n  if (!detectedJsEngine) {\n    detectedJsEngine = detectJsEngineFromStack();\n  }\n\n  data['jse'] = detectedJsEngine;\n  var exps = [];\n  var experiments = (0, _experiments.experimentTogglesOrNull)(self);\n\n  for (var exp in experiments) {\n    var on = experiments[exp];\n    exps.push(exp + \"=\" + (on ? '1' : '0'));\n  }\n\n  data['exps'] = exps.join(',');\n\n  if (error) {\n    var tagName = error.associatedElement ? error.associatedElement.tagName : 'u'; // Unknown\n\n    data['el'] = tagName;\n\n    if (error.args) {\n      data['args'] = JSON.stringify(error.args);\n    }\n\n    if (!isUserError && !error.ignoreStack && error.stack) {\n      data['s'] = error.stack;\n    } // TODO(jridgewell, #18574); Make sure error is always an object.\n\n\n    if (error.message) {\n      error.message += ' _reported_';\n    }\n  } else {\n    data['f'] = filename || '';\n    data['l'] = line || '';\n    data['c'] = col || '';\n  }\n\n  data['r'] = self.document ? self.document.referrer : '';\n  data['ae'] = accumulatedErrorMessages.join(',');\n  data['fr'] = self.location.originalHash || self.location.hash;\n  pushLimit(accumulatedErrorMessages, message, 25);\n  return data;\n}\n/**\n * Returns true if it appears like there is non-AMP JS on the\n * current page.\n * @param {!Window} win\n * @return {boolean}\n * @visibleForTesting\n */\n\n\nfunction detectNonAmpJs(win) {\n  if (!win.document) {\n    return false;\n  }\n\n  var scripts = win.document.querySelectorAll('script[src]');\n\n  for (var i = 0; i < scripts.length; i++) {\n    if (!(0, _url.isProxyOrigin)(scripts[i].src.toLowerCase())) {\n      return true;\n    }\n  }\n\n  return false;\n}\n/**\n * Resets accumulated error messages for testing\n */\n\n\nfunction resetAccumulatedErrorMessagesForTesting() {\n  accumulatedErrorMessages = [];\n}\n/**\n * Does a series of checks on the stack of an thrown error to determine the\n * JS engine that is currently running. This gives a bit more information than\n * just the UserAgent, since browsers often allow overriding it to \"emulate\"\n * mobile.\n * @return {string}\n * @visibleForTesting\n */\n\n\nfunction detectJsEngineFromStack() {\n  /** @constructor */\n  function Fn() {}\n\n  Fn.prototype.t = function () {\n    throw new Error('message');\n  };\n\n  var object = new Fn();\n\n  try {\n    object.t();\n  } catch (e) {\n    var stack = e.stack; // Safari only mentions the method name.\n\n    if ((0, _string.startsWith)(stack, 't@')) {\n      return 'Safari';\n    } // Firefox mentions \"prototype\".\n\n\n    if (stack.indexOf('.prototype.t@') > -1) {\n      return 'Firefox';\n    } // IE looks like Chrome, but includes a context for the base stack line.\n    // Explicitly, we're looking for something like:\n    // \"    at Global code (https://example.com/app.js:1:200)\" or\n    // \"    at Anonymous function (https://example.com/app.js:1:200)\"\n    // vs Chrome which has:\n    // \"    at https://example.com/app.js:1:200\"\n\n\n    var last = stack.split('\\n').pop();\n\n    if (/\\bat .* \\(/i.test(last)) {\n      return 'IE';\n    } // Finally, chrome includes the error message in the stack.\n\n\n    if ((0, _string.startsWith)(stack, 'Error: message')) {\n      return 'Chrome';\n    }\n  }\n\n  return 'unknown';\n}\n/**\n * @param {!Error} error\n * @param {!Window} win\n */\n\n\nfunction reportErrorToAnalytics(error, win) {\n  // Currently this can only be executed in a single-doc mode. Otherwise,\n  // it's not clear which ampdoc the event would belong too.\n  if (_services.Services.ampdocServiceFor(win).isSingleDoc()) {\n    var vars = (0, _object.dict)({\n      'errorName': error.name,\n      'errorMessage': error.message\n    });\n    (0, _analytics.triggerAnalyticsEvent)(getRootElement_(win), 'user-error', vars);\n  }\n}\n/**\n * @param {!Window} win\n * @return {!Element}\n * @private\n */\n\n\nfunction getRootElement_(win) {\n  var root = _services.Services.ampdocServiceFor(win).getSingleDoc().getRootNode();\n\n  return (0, _log.dev)().assertElement(root.documentElement || root.body || root);\n}\n\n},{\"./amp-events\":26,\"./analytics\":27,\"./config\":32,\"./event-helper\":46,\"./experiments\":47,\"./exponential-backoff\":48,\"./log\":68,\"./mode\":70,\"./services\":123,\"./string\":126,\"./style-installer\":127,\"./url\":134,\"./utils/object\":145}],45:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.internalListenImplementation = internalListenImplementation;\nexports.detectEvtListenerOptsSupport = detectEvtListenerOptsSupport;\nexports.resetEvtListenerOptsSupportForTesting = resetEvtListenerOptsSupportForTesting;\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether addEventListener supports options or only takes capture as a boolean\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nvar optsSupported;\n/**\n * Listens for the specified event on the element.\n *\n * Do not use this directly. This method is implemented as a shared\n * dependency. Use `listen()` in either `event-helper` or `3p-frame-messaging`,\n * depending on your use case.\n *\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\n\nfunction internalListenImplementation(element, eventType, listener, opt_evtListenerOpts) {\n  var localElement = element;\n  var localListener = listener;\n  /**\n   * @type {?Function}\n   */\n\n  var wrapped;\n\n  wrapped = function wrapped(event) {\n    try {\n      return localListener(event);\n    } catch (e) {\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(e);\n\n      throw e;\n    }\n  };\n\n  var optsSupported = detectEvtListenerOptsSupport();\n  var capture = false;\n\n  if (opt_evtListenerOpts) {\n    capture = opt_evtListenerOpts.capture;\n  }\n\n  localElement.addEventListener(eventType, wrapped, optsSupported ? opt_evtListenerOpts : capture);\n  return function () {\n    if (localElement) {\n      localElement.removeEventListener(eventType, wrapped, optsSupported ? opt_evtListenerOpts : capture);\n    } // Ensure these are GC'd\n\n\n    localListener = null;\n    localElement = null;\n    wrapped = null;\n  };\n}\n/**\n * Tests whether the browser supports options as an argument of addEventListener\n * or not.\n *\n * @return {boolean}\n */\n\n\nfunction detectEvtListenerOptsSupport() {\n  // Only run the test once\n  if (optsSupported !== undefined) {\n    return optsSupported;\n  }\n\n  optsSupported = false;\n\n  try {\n    // Test whether browser supports EventListenerOptions or not\n    var options = {\n      get capture() {\n        optsSupported = true;\n      }\n\n    };\n    self.addEventListener('test-options', null, options);\n    self.removeEventListener('test-options', null, options);\n  } catch (err) {// EventListenerOptions are not supported\n  }\n\n  return optsSupported;\n}\n/**\n * Resets the test for whether addEventListener supports options or not.\n */\n\n\nfunction resetEvtListenerOptsSupportForTesting() {\n  optsSupported = undefined;\n}\n\n},{}],46:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.createCustomEvent = createCustomEvent;\nexports.listen = listen;\nexports.getData = getData;\nexports.getDetail = getDetail;\nexports.listenOnce = listenOnce;\nexports.listenOncePromise = listenOncePromise;\nexports.isLoaded = isLoaded;\nexports.loadPromise = loadPromise;\nexports.isLoadErrorMessage = isLoadErrorMessage;\nexports.MEDIA_LOAD_FAILURE_SRC_PROPERTY = void 0;\n\nvar _eventHelperListen = require(\"./event-helper-listen\");\n\nvar _dom = require(\"./dom\");\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {string}  */\nvar LOAD_FAILURE_PREFIX = 'Failed to load:';\n/** @const {string} */\n\nvar MEDIA_LOAD_FAILURE_SRC_PROPERTY = '__AMP_MEDIA_LOAD_FAILURE_SRC';\n/**\n * Returns a CustomEvent with a given type and detail; supports fallback for IE.\n * @param {!Window} win\n * @param {string} type\n * @param {!JsonObject|string|undefined|null} detail\n * @param {EventInit=} opt_eventInit\n * @return {!Event}\n */\n\nexports.MEDIA_LOAD_FAILURE_SRC_PROPERTY = MEDIA_LOAD_FAILURE_SRC_PROPERTY;\n\nfunction createCustomEvent(win, type, detail, opt_eventInit) {\n  var eventInit =\n  /** @type {!CustomEventInit} */\n  {\n    detail: detail\n  };\n  Object.assign(eventInit, opt_eventInit); // win.CustomEvent is a function on Edge, Chrome, FF, Safari but\n  // is an object on IE 11.\n\n  if (typeof win.CustomEvent == 'function') {\n    return new win.CustomEvent(type, eventInit);\n  } else {\n    // Deprecated fallback for IE.\n    var e = win.document.createEvent('CustomEvent');\n    e.initCustomEvent(type, !!eventInit.bubbles, !!eventInit.cancelable, detail);\n    return e;\n  }\n}\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\n\n\nfunction listen(element, eventType, listener, opt_evtListenerOpts) {\n  return (0, _eventHelperListen.internalListenImplementation)(element, eventType, listener, opt_evtListenerOpts);\n}\n/**\n * Returns the data property of an event with the correct type.\n * @param {!Event|{data: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\n\n\nfunction getData(event) {\n  return (\n    /** @type {?JsonObject|string|undefined} */\n    event.data\n  );\n}\n/**\n * Returns the detail property of an event with the correct type.\n * @param {!Event|{detail: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\n\n\nfunction getDetail(event) {\n  return (\n    /** @type {?JsonObject|string|undefined} */\n    event.detail\n  );\n}\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\n\n\nfunction listenOnce(element, eventType, listener, opt_evtListenerOpts) {\n  var localListener = listener;\n  var unlisten = (0, _eventHelperListen.internalListenImplementation)(element, eventType, function (event) {\n    try {\n      localListener(event);\n    } finally {\n      // Ensure listener is GC'd\n      localListener = null;\n      unlisten();\n    }\n  }, opt_evtListenerOpts);\n  return unlisten;\n}\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {Object=} opt_evtListenerOpts\n * @param {function(!UnlistenDef)=} opt_cancel An optional function that, when\n *     provided, will be called with the unlistener. This gives the caller\n *     access to the unlistener, so it may be called manually when necessary.\n * @return {!Promise<!Event>}\n */\n\n\nfunction listenOncePromise(element, eventType, opt_evtListenerOpts, opt_cancel) {\n  var unlisten;\n  var eventPromise = new Promise(function (resolve) {\n    unlisten = listenOnce(element, eventType, resolve, opt_evtListenerOpts);\n  });\n  eventPromise.then(unlisten, unlisten);\n\n  if (opt_cancel) {\n    opt_cancel(unlisten);\n  }\n\n  return eventPromise;\n}\n/**\n * Whether the specified element/window has been loaded already.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\n\n\nfunction isLoaded(eleOrWindow) {\n  return !!(eleOrWindow.complete || eleOrWindow.readyState == 'complete' || isHTMLMediaElement(eleOrWindow) && eleOrWindow.readyState > 0 || // If the passed in thing is a Window, infer loaded state from\n  //\n  eleOrWindow.document && eleOrWindow.document.readyState == 'complete');\n}\n/**\n * Returns a promise that will resolve or fail based on the eleOrWindow's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {T} eleOrWindow Supports both Elements and as a special case Windows.\n * @return {!Promise<T>}\n * @template T\n */\n\n\nfunction loadPromise(eleOrWindow) {\n  var unlistenLoad;\n  var unlistenError;\n\n  if (isLoaded(eleOrWindow)) {\n    return Promise.resolve(eleOrWindow);\n  }\n\n  var isMediaElement = isHTMLMediaElement(eleOrWindow);\n\n  if (isMediaElement && eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === eleOrWindow.currentSrc) {\n    return Promise.reject(eleOrWindow);\n  }\n\n  var loadingPromise = new Promise(function (resolve, reject) {\n    // Listen once since IE 5/6/7 fire the onload event continuously for\n    // animated GIFs.\n    if (isMediaElement) {\n      // The following event can be triggered by the media or one of its\n      // sources. Using capture is required as the media events do not bubble.\n      unlistenLoad = listenOnce(eleOrWindow, 'loadedmetadata', resolve, {\n        capture: true\n      });\n    } else {\n      unlistenLoad = listenOnce(eleOrWindow, 'load', resolve);\n    } // Don't unlisten on error for Windows.\n\n\n    if (!eleOrWindow.tagName) {\n      return;\n    }\n\n    var errorTarget = eleOrWindow; // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n\n    if (isMediaElement && !eleOrWindow.hasAttribute('src')) {\n      errorTarget = (0, _dom.lastChildElement)(eleOrWindow, function (child) {\n        return child.tagName === 'SOURCE';\n      });\n\n      if (!errorTarget) {\n        return reject(new Error('Media has no source.'));\n      }\n    }\n\n    unlistenError = listenOnce(errorTarget, 'error', reject);\n  });\n  return loadingPromise.then(function () {\n    if (unlistenError) {\n      unlistenError();\n    }\n\n    return eleOrWindow;\n  }, function () {\n    if (unlistenLoad) {\n      unlistenLoad();\n    }\n\n    failedToLoad(eleOrWindow);\n  });\n}\n/**\n * Emit error on load failure.\n * @param {!Element|!Window} eleOrWindow Supports both Elements and as a special\n *     case Windows.\n */\n\n\nfunction failedToLoad(eleOrWindow) {\n  // Mark the element as errored since some elements - like HTMLMediaElement\n  // using HTMLSourceElement - do not provide any synchronous way to verify if\n  // they already errored, even though the error event was already dispatched.\n  if (isHTMLMediaElement(eleOrWindow)) {\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] = eleOrWindow.currentSrc || true;\n  } // Report failed loads as user errors so that they automatically go\n  // into the \"document error\" bucket.\n\n\n  var target = eleOrWindow;\n\n  if (target && target.src) {\n    target = target.src;\n  }\n\n  throw (0, _log.user)().createError(LOAD_FAILURE_PREFIX, target);\n}\n/**\n * Returns true if the parameter is a HTMLMediaElement.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\n\n\nfunction isHTMLMediaElement(eleOrWindow) {\n  return eleOrWindow.tagName === 'AUDIO' || eleOrWindow.tagName === 'VIDEO';\n}\n/**\n * Returns true if this error message is was created for a load error.\n * @param {string} message An error message\n * @return {boolean}\n */\n\n\nfunction isLoadErrorMessage(message) {\n  return message.indexOf(LOAD_FAILURE_PREFIX) != -1;\n}\n\n},{\"./dom\":41,\"./event-helper-listen\":45,\"./log\":68}],47:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.isCanary = isCanary;\nexports.getBinaryType = getBinaryType;\nexports.isExperimentOn = isExperimentOn;\nexports.toggleExperiment = toggleExperiment;\nexports.experimentToggles = experimentToggles;\nexports.experimentTogglesOrNull = experimentTogglesOrNull;\nexports.getExperimentTogglesForTesting = getExperimentTogglesForTesting;\nexports.resetExperimentTogglesForTesting = resetExperimentTogglesForTesting;\nexports.randomlySelectUnsetExperiments = randomlySelectUnsetExperiments;\nexports.getExperimentBranch = getExperimentBranch;\nexports.forceExperimentBranch = forceExperimentBranch;\nexports.RANDOM_NUMBER_GENERATORS = exports.ExperimentInfo = void 0;\n\nvar _log = require(\"./log\");\n\nvar _mode = require(\"./mode\");\n\nvar _object = require(\"./utils/object\");\n\nvar _url = require(\"./url\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Experiments system allows a developer to opt-in to test\n * features that are not yet fully tested.\n *\n * Experiments page: https://cdn.ampproject.org/experiments.html *\n */\n\n/** @const {string} */\nvar TAG = 'EXPERIMENTS';\n/** @const {string} */\n\nvar LOCAL_STORAGE_KEY = 'amp-experiment-toggles';\n/** @const {string} */\n\nvar TOGGLES_WINDOW_PROPERTY = '__AMP__EXPERIMENT_TOGGLES';\n/**\n * @typedef {{\n *   isTrafficEligible: function(!Window):boolean,\n *   branches: !Array<string>\n * }}\n */\n\nvar ExperimentInfo;\n/**\n * Whether we are in canary.\n * @param {!Window} win\n * @return {boolean}\n */\n\nexports.ExperimentInfo = ExperimentInfo;\n\nfunction isCanary(win) {\n  return !!(win.AMP_CONFIG && win.AMP_CONFIG.canary);\n}\n/**\n * Returns binary type, e.g., canary, production, control, or rc.\n * @param {!Window} win\n * @return {string}\n */\n\n\nfunction getBinaryType(win) {\n  return win.AMP_CONFIG && win.AMP_CONFIG.type ? win.AMP_CONFIG.type : 'unknown';\n}\n/**\n * Whether the specified experiment is on or off.\n * @param {!Window} win\n * @param {string} experimentId\n * @return {boolean}\n */\n\n\nfunction isExperimentOn(win, experimentId) {\n  var toggles = experimentToggles(win);\n  return !!toggles[experimentId];\n}\n/**\n * Toggles the experiment on or off. Returns the actual value of the experiment\n * after toggling is done.\n * @param {!Window} win\n * @param {string} experimentId\n * @param {boolean=} opt_on\n * @param {boolean=} opt_transientExperiment  Whether to toggle the\n *     experiment state \"transiently\" (i.e., for this page load only) or\n *     durably (by saving the experiment IDs after toggling).\n *     Default: false (save durably).\n * @return {boolean} New state for experimentId.\n */\n\n\nfunction toggleExperiment(win, experimentId, opt_on, opt_transientExperiment) {\n  var currentlyOn = isExperimentOn(win,\n  /*OK*/\n  experimentId);\n  var on = !!(opt_on !== undefined ? opt_on : !currentlyOn);\n\n  if (on != currentlyOn) {\n    var toggles = experimentToggles(win);\n    toggles[experimentId] = on;\n\n    if (!opt_transientExperiment) {\n      var storedToggles = getExperimentToggles(win);\n      storedToggles[experimentId] = on;\n      saveExperimentToggles(win, storedToggles); // Avoid affecting tests that spy/stub warn().\n\n      if (!(0, _mode.getMode)().test) {\n        (0, _log.user)().warn(TAG, '\"%s\" experiment %s for the domain \"%s\". See: https://amp.dev/documentation/guides-and-tutorials/learn/experimental', experimentId, on ? 'enabled' : 'disabled', win.location.hostname);\n      }\n    }\n  }\n\n  return on;\n}\n/**\n * Calculate whether the experiment is on or off based off of its default value,\n * stored overriden value, or the global config frequency given.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\n\n\nfunction experimentToggles(win) {\n  if (win[TOGGLES_WINDOW_PROPERTY]) {\n    return win[TOGGLES_WINDOW_PROPERTY];\n  }\n\n  win[TOGGLES_WINDOW_PROPERTY] = Object.create(null);\n  var toggles = win[TOGGLES_WINDOW_PROPERTY]; // Read the default config of this build.\n\n  if (win.AMP_CONFIG) {\n    for (var experimentId in win.AMP_CONFIG) {\n      var frequency = win.AMP_CONFIG[experimentId];\n\n      if (typeof frequency === 'number' && frequency >= 0 && frequency <= 1) {\n        toggles[experimentId] = Math.random() < frequency;\n      }\n    }\n  } // Read document level override from meta tag.\n\n\n  if (win.AMP_CONFIG && Array.isArray(win.AMP_CONFIG['allow-doc-opt-in']) && win.AMP_CONFIG['allow-doc-opt-in'].length > 0) {\n    var allowed = win.AMP_CONFIG['allow-doc-opt-in'];\n    var meta = win.document.head.querySelector('meta[name=\"amp-experiments-opt-in\"]');\n\n    if (meta) {\n      var optedInExperiments = meta.getAttribute('content').split(',');\n\n      for (var i = 0; i < optedInExperiments.length; i++) {\n        if (allowed.indexOf(optedInExperiments[i]) != -1) {\n          toggles[optedInExperiments[i]] = true;\n        }\n      }\n    }\n  }\n\n  Object.assign(toggles, getExperimentToggles(win));\n\n  if (win.AMP_CONFIG && Array.isArray(win.AMP_CONFIG['allow-url-opt-in']) && win.AMP_CONFIG['allow-url-opt-in'].length > 0) {\n    var _allowed = win.AMP_CONFIG['allow-url-opt-in'];\n    var hash = win.location.originalHash || win.location.hash;\n    var params = (0, _url.parseQueryString)(hash);\n\n    for (var _i = 0; _i < _allowed.length; _i++) {\n      var param = params[\"e-\" + _allowed[_i]];\n\n      if (param == '1') {\n        toggles[_allowed[_i]] = true;\n      }\n\n      if (param == '0') {\n        toggles[_allowed[_i]] = false;\n      }\n    }\n  }\n\n  return toggles;\n}\n/**\n * Returns the cached experiments toggles, or null if they have not been\n * computed yet.\n * @param {!Window} win\n * @return {Object<string, boolean>}\n */\n\n\nfunction experimentTogglesOrNull(win) {\n  return win[TOGGLES_WINDOW_PROPERTY] || null;\n}\n/**\n * Returns a set of experiment IDs currently on.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\n\n\nfunction getExperimentToggles(win) {\n  var experimentsString = '';\n\n  try {\n    if ('localStorage' in win) {\n      experimentsString = win.localStorage.getItem(LOCAL_STORAGE_KEY);\n    }\n  } catch (e) {\n    (0, _log.dev)().warn(TAG, 'Failed to retrieve experiments from localStorage.');\n  }\n\n  var tokens = experimentsString ? experimentsString.split(/\\s*,\\s*/g) : [];\n  var toggles = Object.create(null);\n\n  for (var i = 0; i < tokens.length; i++) {\n    if (tokens[i].length == 0) {\n      continue;\n    }\n\n    if (tokens[i][0] == '-') {\n      toggles[tokens[i].substr(1)] = false;\n    } else {\n      toggles[tokens[i]] = true;\n    }\n  }\n\n  return toggles;\n}\n/**\n * Saves a set of experiment IDs currently on.\n * @param {!Window} win\n * @param {!Object<string, boolean>} toggles\n */\n\n\nfunction saveExperimentToggles(win, toggles) {\n  var experimentIds = [];\n\n  for (var experiment in toggles) {\n    experimentIds.push((toggles[experiment] === false ? '-' : '') + experiment);\n  }\n\n  try {\n    if ('localStorage' in win) {\n      win.localStorage.setItem(LOCAL_STORAGE_KEY, experimentIds.join(','));\n    }\n  } catch (e) {\n    (0, _log.user)().error(TAG, 'Failed to save experiments to localStorage.');\n  }\n}\n/**\n * See getExperimentToggles().\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n * @visibleForTesting\n */\n\n\nfunction getExperimentTogglesForTesting(win) {\n  return getExperimentToggles(win);\n}\n/**\n * Resets the experimentsToggle cache for testing purposes.\n * @param {!Window} win\n * @visibleForTesting\n */\n\n\nfunction resetExperimentTogglesForTesting(win) {\n  saveExperimentToggles(win, {});\n  win[TOGGLES_WINDOW_PROPERTY] = null;\n}\n/**\n * In some browser implementations of Math.random(), sequential calls of\n * Math.random() are correlated and can cause a bias.  In particular,\n * if the previous random() call was < 0.001 (as it will be if we select\n * into an experiment), the next value could be less than 0.5 more than\n * 50.7% of the time.  This provides an implementation that roots down into\n * the crypto API, when available, to produce less biased samples.\n *\n * @return {number} Pseudo-random floating-point value on the range [0, 1).\n */\n\n\nfunction slowButAccuratePrng() {\n  // TODO(tdrl): Implement.\n  return Math.random();\n}\n/**\n * Container for alternate random number generator implementations.  This\n * allows us to set an \"accurate\" PRNG for branch selection, but to mock it\n * out easily in tests.\n *\n * @visibleForTesting\n * @const {!{accuratePrng: function():number}}\n */\n\n\nvar RANDOM_NUMBER_GENERATORS = {\n  accuratePrng: slowButAccuratePrng\n};\n/**\n * Selects, uniformly at random, a single item from the array.\n * @param {!Array<string>} arr Object to select from.\n * @return {?string} Single item from arr or null if arr was empty.\n */\n\nexports.RANDOM_NUMBER_GENERATORS = RANDOM_NUMBER_GENERATORS;\n\nfunction selectRandomItem(arr) {\n  var rn = RANDOM_NUMBER_GENERATORS.accuratePrng();\n  return arr[Math.floor(rn * arr.length)] || null;\n}\n/**\n * Selects which page-level experiment branches are enabled. If a given\n * experiment name is already set (including to the null / no branches selected\n * state), this won't alter its state.\n *\n * Check whether a given experiment is set using isExperimentOn(win,\n * experimentName) and, if it is on, look for which branch is selected in\n * win.__AMP_EXPERIMENT_BRANCHES[experimentName].\n *\n * @param {!Window} win Window context on which to save experiment\n *     selection state.\n * @param {!Object<string, !ExperimentInfo>} experiments  Set of experiments to\n *     configure for this page load.\n * @return {!Object<string, string>} Map of experiment names to selected\n *     branches.\n */\n\n\nfunction randomlySelectUnsetExperiments(win, experiments) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  var selectedExperiments = {};\n\n  for (var experimentName in experiments) {\n    // Skip experimentName if it is not a key of experiments object or if it\n    // has already been populated by some other property.\n    if (!(0, _object.hasOwn)(experiments, experimentName)) {\n      continue;\n    }\n\n    if ((0, _object.hasOwn)(win.__AMP_EXPERIMENT_BRANCHES, experimentName)) {\n      selectedExperiments[experimentName] = win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n      continue;\n    }\n\n    if (!experiments[experimentName].isTrafficEligible || !experiments[experimentName].isTrafficEligible(win)) {\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = null;\n      continue;\n    } // If we're in the experiment, but we haven't already forced a specific\n    // experiment branch (e.g., via a test setup), then randomize the branch\n    // choice.\n\n\n    if (!win.__AMP_EXPERIMENT_BRANCHES[experimentName] && isExperimentOn(win,\n    /*OK*/\n    experimentName)) {\n      var branches = experiments[experimentName].branches;\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = selectRandomItem(branches);\n      selectedExperiments[experimentName] = win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n    }\n  }\n\n  return selectedExperiments;\n}\n/**\n * Returns the experiment branch enabled for the given experiment ID.\n * For example, 'control' or 'experiment'.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @return {?string} Active experiment branch ID for experimentName (possibly\n *     null if experimentName has been tested but no branch was enabled).\n */\n\n\nfunction getExperimentBranch(win, experimentName) {\n  return win.__AMP_EXPERIMENT_BRANCHES ? win.__AMP_EXPERIMENT_BRANCHES[experimentName] : null;\n}\n/**\n * Force enable (or disable) a specific branch of a given experiment name.\n * Disables the experiment name altogether if branchId is falseish.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @param {?string} branchId ID of branch to force or null to disable\n *     altogether.\n * @visibleForTesting\n */\n\n\nfunction forceExperimentBranch(win, experimentName, branchId) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  toggleExperiment(win, experimentName, !!branchId, true);\n  win.__AMP_EXPERIMENT_BRANCHES[experimentName] = branchId;\n}\n\n},{\"./log\":68,\"./mode\":70,\"./url\":134,\"./utils/object\":145}],48:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.exponentialBackoff = exponentialBackoff;\nexports.exponentialBackoffClock = exponentialBackoffClock;\nexports.getJitter = getJitter;\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {number=} opt_base Exponential base. Defaults to 2.\n * @return {function(function()): number} Function that when invoked will\n *     call the passed in function. On every invocation the next\n *     invocation of the passed in function will be exponentially\n *     later. Returned function returns timeout id.\n */\nfunction exponentialBackoff(opt_base) {\n  var getTimeout = exponentialBackoffClock(opt_base);\n  return function (work) {\n    return setTimeout(work, getTimeout());\n  };\n}\n/**\n * @param {number=} opt_base Exponential base. Defaults to 2.\n * @return {function(): number} Function that when invoked will return\n *    a number that exponentially grows per invocation.\n */\n\n\nfunction exponentialBackoffClock(opt_base) {\n  var base = opt_base || 2;\n  var count = 0;\n  return function () {\n    var wait = Math.pow(base, count++);\n    wait += getJitter(wait);\n    return wait * 1000;\n  };\n}\n/**\n * Add jitter to avoid the thundering herd. This can e.g. happen when\n * we poll a backend and it fails for everyone at the same time.\n * We add up to 30% (default) longer or shorter than the given time.\n *\n * @param {number} wait the amount if base milliseconds\n * @param {number=} opt_perc the min/max percentage to add or sutract\n * @return {number}\n */\n\n\nfunction getJitter(wait, opt_perc) {\n  opt_perc = opt_perc || 0.3;\n  var jitter = wait * opt_perc * Math.random();\n\n  if (Math.random() > 0.5) {\n    jitter *= -1;\n  }\n\n  return jitter;\n}\n\n},{}],49:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.insertAnalyticsElement = insertAnalyticsElement;\nexports.useAnalyticsInSandbox = useAnalyticsInSandbox;\nexports.CustomEventReporterBuilder = void 0;\n\nvar _commonSignals = require(\"./common-signals\");\n\nvar _services = require(\"./services\");\n\nvar _dom = require(\"./dom\");\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object\");\n\nvar _types = require(\"./types\");\n\nvar _analytics = require(\"./analytics\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Method to create scoped analytics element for any element.\n * TODO: Make this function private\n * @param {!Element} parentElement\n * @param {!JsonObject} config\n * @param {boolean=} loadAnalytics\n * @param {boolean=} disableImmediate\n * @return {!Element} created analytics element\n */\nfunction insertAnalyticsElement(parentElement, config, loadAnalytics, disableImmediate) {\n  if (loadAnalytics === void 0) {\n    loadAnalytics = false;\n  }\n\n  if (disableImmediate === void 0) {\n    disableImmediate = false;\n  }\n\n  var doc =\n  /** @type {!Document} */\n  parentElement.ownerDocument;\n  var analyticsElem = (0, _dom.createElementWithAttributes)(doc, 'amp-analytics', (0, _object.dict)({\n    'sandbox': 'true',\n    'trigger': disableImmediate ? '' : 'immediate'\n  }));\n  var scriptElem = (0, _dom.createElementWithAttributes)(doc, 'script', (0, _object.dict)({\n    'type': 'application/json'\n  }));\n  scriptElem.textContent = JSON.stringify(config);\n  analyticsElem.appendChild(scriptElem);\n  analyticsElem.CONFIG = config; // Force load analytics extension if script not included in page.\n\n  if (loadAnalytics) {\n    // Get Extensions service and force load analytics extension.\n    var extensions = _services.Services.extensionsFor((0, _types.toWin)(parentElement.ownerDocument.defaultView));\n\n    var ampdoc = _services.Services.ampdoc(parentElement);\n\n    extensions.\n    /*OK*/\n    installExtensionForDoc(ampdoc, 'amp-analytics');\n  } else {\n    _services.Services.analyticsForDocOrNull(parentElement).then(function (analytics) {\n      (0, _log.devAssert)(analytics);\n    });\n  }\n\n  parentElement.appendChild(analyticsElem);\n  return analyticsElem;\n}\n/**\n * A class that handles customEvent reporting of extension element through\n * amp-analytics. This class is not exposed to extension element directly to\n * restrict the genration of the config Please use CustomEventReporterBuilder to\n * build a CustomEventReporter instance.\n */\n\n\nvar CustomEventReporter =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Element} parent\n   * @param {!JsonObject} config\n   */\n  function CustomEventReporter(parent, config) {\n    var _this = this;\n\n    (0, _log.devAssert)(config['triggers'], 'Config must have triggers defined');\n    /** @private {string} */\n\n    this.id_ = parent.getResourceId();\n    /** @private {!AmpElement} */\n\n    this.parent_ = parent;\n    /** @private {JsonObject} */\n\n    this.config_ = config;\n\n    for (var event in config['triggers']) {\n      var eventType = config['triggers'][event]['on'];\n      (0, _log.devAssert)(eventType, 'CustomEventReporter config must specify trigger eventType');\n      var newEventType = this.getEventTypeInSandbox_(eventType);\n      config['triggers'][event]['on'] = newEventType;\n    }\n\n    this.parent_.signals().whenSignal(_commonSignals.CommonSignals.LOAD_START).then(function () {\n      insertAnalyticsElement(_this.parent_, config, true);\n    });\n  }\n  /**\n   * @param {string} eventType\n   * @param {!JsonObject=} opt_vars A map of vars and their values.\n   */\n\n\n  var _proto = CustomEventReporter.prototype;\n\n  _proto.trigger = function trigger(eventType, opt_vars) {\n    (0, _log.devAssert)(this.config_['triggers'][eventType], 'Cannot trigger non initiated eventType');\n    (0, _analytics.triggerAnalyticsEvent)(this.parent_, this.getEventTypeInSandbox_(eventType), opt_vars);\n  }\n  /**\n   * @param {string} eventType\n   * @return {string}\n   */\n  ;\n\n  _proto.getEventTypeInSandbox_ = function getEventTypeInSandbox_(eventType) {\n    return \"sandbox-\" + this.id_ + \"-\" + eventType;\n  };\n\n  return CustomEventReporter;\n}();\n/**\n * A builder class that enable extension elements to easily build and get a\n * CustomEventReporter instance. Its constructor requires the parent AMP\n * element. It provides two methods #track() and #build() to build the\n * CustomEventReporter instance.\n */\n\n\nvar CustomEventReporterBuilder =\n/*#__PURE__*/\nfunction () {\n  /** @param {!AmpElement} parent */\n  function CustomEventReporterBuilder(parent) {\n    /** @private {!AmpElement} */\n    this.parent_ = parent;\n    /** @private {?JsonObject} */\n\n    this.config_ =\n    /** @type {JsonObject} */\n    {\n      'requests': {},\n      'triggers': {}\n    };\n  }\n  /**\n   * @param {!JsonObject} transportConfig\n   */\n\n\n  var _proto2 = CustomEventReporterBuilder.prototype;\n\n  _proto2.setTransportConfig = function setTransportConfig(transportConfig) {\n    this.config_['transport'] = transportConfig;\n  }\n  /**\n   * @param {!JsonObject} extraUrlParamsConfig\n   */\n  ;\n\n  _proto2.setExtraUrlParams = function setExtraUrlParams(extraUrlParamsConfig) {\n    this.config_['extraUrlParams'] = extraUrlParamsConfig;\n  }\n  /**\n   * The #track() method takes in a unique custom-event name, and the\n   * corresponding request url (or an array of request urls). One can call\n   * #track() multiple times with different eventType name (order doesn't\n   * matter) before #build() is called.\n   * @param {string} eventType\n   * @param {string|!Array<string>} request\n   * @return {!CustomEventReporterBuilder}\n   */\n  ;\n\n  _proto2.track = function track(eventType, request) {\n    request = (0, _types.isArray)(request) ? request : [request];\n    (0, _log.devAssert)(!this.config_['triggers'][eventType], 'customEventReporterBuilder should not track same eventType twice');\n    var requestList = [];\n\n    for (var i = 0; i < request.length; i++) {\n      var requestName = eventType + \"-request-\" + i;\n      this.config_['requests'][requestName] = request[i];\n      requestList.push(requestName);\n    }\n\n    this.config_['triggers'][eventType] = {\n      'on': eventType,\n      'request': requestList\n    };\n    return this;\n  }\n  /**\n   * Call the #build() method to build and get the CustomEventReporter instance.\n   * One CustomEventReporterBuilder instance can only build one reporter, which\n   * means #build() should only be called once after all eventType are added.\n   * @return {!CustomEventReporter}\n   */\n  ;\n\n  _proto2.build = function build() {\n    (0, _log.devAssert)(this.config_, 'CustomEventReporter already built');\n    var report = new CustomEventReporter(this.parent_,\n    /** @type {!JsonObject} */\n    this.config_);\n    this.config_ = null;\n    return report;\n  };\n\n  return CustomEventReporterBuilder;\n}();\n/**\n * A helper method that should be used by all extension elements to add their\n * sandbox analytics tracking. This method takes care of insert and remove the\n * analytics tracker at the right time of the element lifecycle.\n * @param {!AmpElement} element\n * @param {!Promise<!JsonObject>} promise\n */\n\n\nexports.CustomEventReporterBuilder = CustomEventReporterBuilder;\n\nfunction useAnalyticsInSandbox(element, promise) {\n  var analyticsElement = null;\n  var configPromise = promise; // Listener to LOAD_START signal. Insert analytics element on LOAD_START\n\n  element.signals().whenSignal(_commonSignals.CommonSignals.LOAD_START).then(function () {\n    if (analyticsElement || !configPromise) {\n      return;\n    }\n\n    configPromise.then(function (config) {\n      if (!configPromise) {\n        // If config promise resolve after unload, do nothing.\n        return;\n      }\n\n      configPromise = null;\n      analyticsElement = insertAnalyticsElement(element, config, false);\n    });\n  }); // Listener to UNLOAD signal. Destroy remove element on UNLOAD\n\n  element.signals().whenSignal(_commonSignals.CommonSignals.UNLOAD).then(function () {\n    configPromise = null;\n\n    if (analyticsElement) {\n      (0, _dom.removeElement)(analyticsElement);\n      analyticsElement = null;\n    }\n  });\n}\n\n},{\"./analytics\":27,\"./common-signals\":31,\"./dom\":41,\"./log\":68,\"./services\":123,\"./types\":131,\"./utils/object\":145}],50:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.FiniteStateMachine = void 0;\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @template STATE\n */\nvar FiniteStateMachine =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Constructs a FSM using the bits defined in initialState as changeable\n   * states.\n   * @param {STATE} initialState\n   */\n  function FiniteStateMachine(initialState) {\n    /**\n     * The current state of the FSM\n     * @private {STATE}\n     */\n    this.state_ = initialState;\n    /**\n     * Callbacks that are invoked when transitioning from an old state\n     * to the new.\n     * @private {Object<string, function()>}\n     */\n\n    this.transitions_ = Object.create(null);\n  }\n  /**\n   * Adds a transition callback that will be called when the oldState\n   * transitions to the newState.\n   * @param {STATE} oldState\n   * @param {STATE} newState\n   * @param {function()} callback\n   */\n\n\n  var _proto = FiniteStateMachine.prototype;\n\n  _proto.addTransition = function addTransition(oldState, newState, callback) {\n    var transition = this.statesToTransition_(oldState, newState);\n    (0, _log.devAssert)(!this.transitions_[transition], 'cannot define a duplicate transition callback');\n    this.transitions_[transition] = callback;\n  }\n  /**\n   * Transitions to the newState and invokes the registered transition\n   * callback, if one is defined.\n   * @param {STATE} newState\n   */\n  ;\n\n  _proto.setState = function setState(newState) {\n    var oldState = this.state_;\n    this.state_ = newState;\n    var transition = this.statesToTransition_(oldState, newState);\n    var callback = this.transitions_[transition];\n\n    if (callback) {\n      callback();\n    }\n  }\n  /**\n   * Transforms the state transition into a key which identifies a callback.\n   * @private\n   * @param {STATE} oldState\n   * @param {STATE} newState\n   * @return {string}\n   */\n  ;\n\n  _proto.statesToTransition_ = function statesToTransition_(oldState, newState) {\n    return oldState + \"|\" + newState;\n  };\n\n  return FiniteStateMachine;\n}();\n\nexports.FiniteStateMachine = FiniteStateMachine;\n\n},{\"./log\":68}],51:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.FocusHistory = void 0;\n\nvar _observable = require(\"./observable\");\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * FocusHistory keeps track of recent focused elements. This history can be\n * purged using `purgeBefore` method.\n */\nvar FocusHistory =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   * @param {number} purgeTimeout\n   */\n  function FocusHistory(win, purgeTimeout) {\n    var _this = this;\n\n    /** @const {!Window} */\n    this.win = win;\n    /** @private @const {number} */\n\n    this.purgeTimeout_ = purgeTimeout;\n    /** @private @const {!Array<!{el: !Element, time: time}>} */\n\n    this.history_ = [];\n    /** @private @const {!Observable<!Element>} */\n\n    this.observeFocus_ = new _observable.Observable();\n    /**\n     * @private\n     * @param {!Event} e\n     */\n\n    this.captureFocus_ = function (e) {\n      // Hack (#15079) due to Firefox firing focus events on the entire page\n      if (e.target && e.target.nodeType == 1) {\n        _this.pushFocus_((0, _log.dev)().assertElement(e.target));\n      }\n    };\n    /**\n     * @private\n     * @param {*} unusedE\n     */\n\n\n    this.captureBlur_ = function (unusedE) {\n      // IFrame elements do not receive `focus` event. An alternative way is\n      // implemented here. We wait for a blur to arrive on the main window\n      // and after a short time check which element is active.\n      _services.Services.timerFor(win).delay(function () {\n        _this.pushFocus_((0, _log.dev)().assertElement(_this.win.document.activeElement));\n      }, 500);\n    };\n\n    this.win.document.addEventListener('focus', this.captureFocus_, true);\n    this.win.addEventListener('blur', this.captureBlur_);\n  }\n  /** @visibleForTesting */\n\n\n  var _proto = FocusHistory.prototype;\n\n  _proto.cleanup_ = function cleanup_() {\n    this.win.document.removeEventListener('focus', this.captureFocus_, true);\n    this.win.removeEventListener('blur', this.captureBlur_);\n  }\n  /**\n   * Add a listener for focus events.\n   * @param {function(!Element)} handler\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onFocus = function onFocus(handler) {\n    return this.observeFocus_.add(handler);\n  }\n  /**\n   * @param {!Element} element\n   * @private\n   */\n  ;\n\n  _proto.pushFocus_ = function pushFocus_(element) {\n    var now = Date.now();\n\n    if (this.history_.length == 0 || this.history_[this.history_.length - 1].el != element) {\n      this.history_.push({\n        el: element,\n        time: now\n      });\n    } else {\n      this.history_[this.history_.length - 1].time = now;\n    }\n\n    this.purgeBefore(now - this.purgeTimeout_);\n    this.observeFocus_.fire(element);\n  }\n  /**\n   * Returns the element that was focused last.\n   * @return {?Element}\n   */\n  ;\n\n  _proto.getLast = function getLast() {\n    if (this.history_.length == 0) {\n      return null;\n    }\n\n    return this.history_[this.history_.length - 1].el;\n  }\n  /**\n   * Removes elements from the history older than the specified time.\n   * @param {time} time\n   */\n  ;\n\n  _proto.purgeBefore = function purgeBefore(time) {\n    var index = this.history_.length - 1;\n\n    for (var i = 0; i < this.history_.length; i++) {\n      if (this.history_[i].time >= time) {\n        index = i - 1;\n        break;\n      }\n    }\n\n    if (index != -1) {\n      this.history_.splice(0, index + 1);\n    }\n  }\n  /**\n   * Returns `true` if the specified element contains any of the elements in\n   * the history.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  ;\n\n  _proto.hasDescendantsOf = function hasDescendantsOf(element) {\n    if (this.win.document.activeElement) {\n      this.pushFocus_(this.win.document.activeElement);\n    }\n\n    for (var i = 0; i < this.history_.length; i++) {\n      if (element.contains(this.history_[i].el)) {\n        return true;\n      }\n    }\n\n    return false;\n  };\n\n  return FocusHistory;\n}();\n\nexports.FocusHistory = FocusHistory;\n\n},{\"./log\":68,\"./observable\":71,\"./services\":123}],52:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.createFormDataWrapper = createFormDataWrapper;\nexports.isFormDataWrapper = isFormDataWrapper;\nexports.PolyfillFormDataWrapper = void 0;\n\nvar _services = require(\"./services\");\n\nvar _form = require(\"./form\");\n\nvar _dom = require(\"./dom\");\n\nvar _object = require(\"./utils/object\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/**\n * Create a form data wrapper. The wrapper is necessary to provide a common\n * API for FormData objects on all browsers. For example, not all browsers\n * support the FormData#entries or FormData#delete functions.\n *\n * @param {!Window} win\n * @param {!HTMLFormElement=} opt_form\n * @return {!FormDataWrapperInterface}\n */\nfunction createFormDataWrapper(win, opt_form) {\n  var platform = _services.Services.platformFor(win);\n\n  if (platform.isIos() && platform.getMajorVersion() == 11) {\n    return new Ios11NativeFormDataWrapper(opt_form);\n  } else if (FormData.prototype.entries && FormData.prototype.delete) {\n    return new NativeFormDataWrapper(opt_form);\n  } else {\n    return new PolyfillFormDataWrapper(opt_form);\n  }\n}\n/**\n * Check if the given object is a FormDataWrapper instance\n * @param {*} o\n * @return {boolean} True if the object is a FormDataWrapper instance.\n */\n\n\nfunction isFormDataWrapper(o) {\n  // instanceof doesn't work as expected, so we detect with duck-typing.\n  return !!o && typeof o.getFormData == 'function';\n}\n/**\n * A polyfill wrapper for a `FormData` object.\n *\n * If there's no native `FormData#entries`, chances are there are no native\n * methods to read the content of the `FormData` after construction, so the\n * only way to implement `entries` in this class is to capture the fields in\n * the form passed to the constructor (and the arguments passed to the\n * `append` method).\n *\n * For more details on this, see http://mdn.io/FormData.\n *\n * @implements {FormDataWrapperInterface}\n * @visibleForTesting\n */\n\n\nvar PolyfillFormDataWrapper =\n/*#__PURE__*/\nfunction () {\n  /** @override */\n  function PolyfillFormDataWrapper(opt_form) {\n    if (opt_form === void 0) {\n      opt_form = undefined;\n    }\n\n    /** @private @const {!Object<string, !Array<string>>} */\n    this.fieldValues_ = opt_form ? (0, _form.getFormAsObject)(opt_form) : (0, _object.map)();\n  }\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n\n\n  var _proto = PolyfillFormDataWrapper.prototype;\n\n  _proto.append = function append(name, value, opt_filename) {\n    // Coercion to string is required to match\n    // the native FormData.append behavior\n    var nameString = String(name);\n    this.fieldValues_[nameString] = this.fieldValues_[nameString] || [];\n    this.fieldValues_[nameString].push(String(value));\n  }\n  /** @override */\n  ;\n\n  _proto.delete = function _delete(name) {\n    delete this.fieldValues_[name];\n  }\n  /** @override */\n  ;\n\n  _proto.entries = function entries() {\n    var _this = this;\n\n    var fieldEntries = [];\n    Object.keys(this.fieldValues_).forEach(function (name) {\n      var values = _this.fieldValues_[name];\n      values.forEach(function (value) {\n        return fieldEntries.push([name, value]);\n      });\n    }); // Generator functions are not supported by the current Babel configuration,\n    // so we must manually implement the iterator interface.\n\n    var nextIndex = 0;\n    return (\n      /** @type {!Iterator<!Array<string>>} */\n      {\n        next: function next() {\n          return nextIndex < fieldEntries.length ? {\n            value: fieldEntries[nextIndex++],\n            done: false\n          } : {\n            value: undefined,\n            done: true\n          };\n        }\n      }\n    );\n  }\n  /** @override */\n  ;\n\n  _proto.getFormData = function getFormData() {\n    var _this2 = this;\n\n    var formData = new FormData();\n    Object.keys(this.fieldValues_).forEach(function (name) {\n      var values = _this2.fieldValues_[name];\n      values.forEach(function (value) {\n        return formData.append(name, value);\n      });\n    });\n    return formData;\n  };\n\n  return PolyfillFormDataWrapper;\n}();\n/**\n * Wrap the native `FormData` implementation.\n *\n * NOTE: This differs from the standard `FormData` constructor. This constructor\n * includes a submit button if it was used to submit the `opt_form`, where\n * the native `FormData` constructor does not include the submit button used to\n * submit the form.\n * {@link https://xhr.spec.whatwg.org/#dom-formdata}\n * @implements {FormDataWrapperInterface}\n */\n\n\nexports.PolyfillFormDataWrapper = PolyfillFormDataWrapper;\n\nvar NativeFormDataWrapper =\n/*#__PURE__*/\nfunction () {\n  /** @override */\n  function NativeFormDataWrapper(opt_form) {\n    /** @private @const {!FormData} */\n    this.formData_ = new FormData(opt_form);\n    this.maybeIncludeSubmitButton_(opt_form);\n  }\n  /**\n   * If a submit button is focused (because it was used to submit the form),\n   * or was the first submit button present, add its name and value to the\n   * `FormData`, since publishers expect the submit button to be present.\n   * @param {!HTMLFormElement=} opt_form\n   * @private\n   */\n\n\n  var _proto2 = NativeFormDataWrapper.prototype;\n\n  _proto2.maybeIncludeSubmitButton_ = function maybeIncludeSubmitButton_(opt_form) {\n    // If a form is not passed to the constructor,\n    // we are not in a submitting code path.\n    if (!opt_form) {\n      return;\n    }\n\n    var button = (0, _form.getSubmitButtonUsed)(opt_form);\n\n    if (button && button.name) {\n      this.append(button.name, button.value);\n    }\n  }\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n  ;\n\n  _proto2.append = function append(name, value, opt_filename) {\n    this.formData_.append(name, value);\n  }\n  /** @override */\n  ;\n\n  _proto2.delete = function _delete(name) {\n    this.formData_.delete(name);\n  }\n  /** @override */\n  ;\n\n  _proto2.entries = function entries() {\n    return this.formData_.entries();\n  }\n  /** @override */\n  ;\n\n  _proto2.getFormData = function getFormData() {\n    return this.formData_;\n  };\n\n  return NativeFormDataWrapper;\n}();\n/**\n * iOS 11 has a bug when submitting empty file inputs.\n * This works around the bug by replacing the empty files with Blob objects.\n */\n\n\nvar Ios11NativeFormDataWrapper =\n/*#__PURE__*/\nfunction (_NativeFormDataWrappe) {\n  _inheritsLoose(Ios11NativeFormDataWrapper, _NativeFormDataWrappe);\n\n  /** @override */\n  function Ios11NativeFormDataWrapper(opt_form) {\n    var _this3;\n\n    _this3 = _NativeFormDataWrappe.call(this, opt_form) || this;\n\n    if (opt_form) {\n      (0, _dom.iterateCursor)(opt_form.elements, function (input) {\n        if (input.type == 'file' && input.files.length == 0) {\n          _this3.formData_.delete(input.name);\n\n          _this3.formData_.append(input.name, new Blob([]), '');\n        }\n      });\n    }\n\n    return _this3;\n  }\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n\n\n  var _proto3 = Ios11NativeFormDataWrapper.prototype;\n\n  _proto3.append = function append(name, value, opt_filename) {\n    // Safari 11 breaks on submitting empty File values.\n    if (value && typeof value == 'object' && isEmptyFile(value)) {\n      this.formData_.append(name, new Blob([]), opt_filename || '');\n    } else {\n      this.formData_.append(name, value);\n    }\n  };\n\n  return Ios11NativeFormDataWrapper;\n}(NativeFormDataWrapper);\n/**\n * A wrapper for a native `FormData` object that allows the retrieval of entries\n * in the form data after construction even on browsers that don't natively\n * support `FormData.prototype.entries`.\n *\n * @interface\n * Subclassing `FormData` doesn't work in this case as the transpiler\n *     generates code that calls the super constructor directly using\n *     `Function.prototype.call`. WebKit (Safari) doesn't allow this and\n *     enforces that constructors be called with the `new` operator.\n */\n\n\nvar FormDataWrapperInterface =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates a new wrapper for a `FormData` object.\n   *\n   * If there's no native `FormData#entries`, chances are there are no native\n   * methods to read the content of the `FormData` after construction, so the\n   * only way to implement `entries` in this class is to capture the fields in\n   * the form passed to the constructor (and the arguments passed to the\n   * `append` method).\n   *\n   * This constructor should also add the submitter element as defined in the\n   * HTML spec for Form Submission Algorithm, but is not defined by the standard\n   * when using the `FormData` constructor directly.\n   *\n   * For more details on this, see http://mdn.io/FormData.\n   *\n   * @param {!HTMLFormElement=} opt_form An HTML `<form>` element  when\n   *     specified, the `FormData` object will be populated with the form's\n   *     current keys/values using the name property of each element for the\n   *     keys and their submitted value for the values. It will also encode file\n   *     input content.\n   */\n  function FormDataWrapperInterface(opt_form) {}\n  /**\n   * Appends a new value onto an existing key inside a `FormData` object, or\n   * adds the key if it does not already exist.\n   *\n   * Appending a `File` object is not yet supported and the `filename`\n   * parameter is ignored for this wrapper.\n   *\n   * For more details on this, see http://mdn.io/FormData/append.\n   *\n   * TODO(cvializ): Update file support\n   *\n   * @param {string} unusedName The name of the field whose data is contained in\n   *     `value`.\n   * @param {string|!File} unusedValue The field's value.\n   * @param {string=} opt_filename The filename to use if the value is a file.\n   */\n\n\n  var _proto4 = FormDataWrapperInterface.prototype;\n\n  _proto4.append = function append(unusedName, unusedValue, opt_filename) {}\n  /**\n   * Remove the given value from the FormData.\n   *\n   * For more details on this, see http://mdn.io/FormData/delete.\n   *\n   * @param {string} unusedName The name of the field to remove from the FormData.\n   */\n  ;\n\n  _proto4.delete = function _delete(unusedName) {}\n  /**\n   * Returns an iterator of all key/value pairs contained in this object.\n   *\n   * For more details on this, see http://mdn.io/FormData/entries.\n   *\n   * @return {!Iterator<!Array<string|!File>>}\n   */\n  ;\n\n  _proto4.entries = function entries() {}\n  /**\n   * Returns the wrapped native `FormData` object.\n   *\n   * @return {!FormData}\n   */\n  ;\n\n  _proto4.getFormData = function getFormData() {};\n\n  return FormDataWrapperInterface;\n}();\n/**\n * Check if the given file is an empty file, which is the result of submitting\n * an empty `<input type=\"file\">`. These cause errors when submitting forms\n * in Safari 11.\n *\n * @param {!File} file\n * @return {boolean}\n */\n\n\nfunction isEmptyFile(file) {\n  return file.name == '' && file.size == 0;\n}\n\n},{\"./dom\":41,\"./form\":53,\"./services\":123,\"./utils/object\":145}],53:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.formOrNullForElement = formOrNullForElement;\nexports.setFormForElement = setFormForElement;\nexports.getFormAsObject = getFormAsObject;\nexports.getSubmitButtonUsed = getSubmitButtonUsed;\nexports.isDisabled = isDisabled;\nexports.isFieldDefault = isFieldDefault;\nexports.isFieldEmpty = isFieldEmpty;\n\nvar _dom = require(\"./dom\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {string} */\nvar FORM_PROP_ = '__AMP_FORM';\n/**\n * @param {!Element} element\n * @return {../extensions/amp-form/0.1/amp-form.AmpForm}\n */\n\nfunction formOrNullForElement(element) {\n  return element[FORM_PROP_] || null;\n}\n/**\n * @param {!Element} element\n * @param {!../extensions/amp-form/0.1/amp-form.AmpForm} form\n */\n\n\nfunction setFormForElement(element, form) {\n  element[FORM_PROP_] = form;\n}\n/**\n * Returns form data in the passed-in form as an object.\n * Includes focused submit buttons.\n * @param {!HTMLFormElement} form\n * @return {!JsonObject}\n */\n\n\nfunction getFormAsObject(form) {\n  var elements = form.elements;\n  var data =\n  /** @type {!JsonObject} */\n  {}; // <button> is handled separately\n\n  var submittableTagsRegex = /^(?:input|select|textarea)$/i; // type=submit is handled separately\n\n  var unsubmittableTypesRegex = /^(?:submit|button|image|file|reset)$/i;\n  var checkableType = /^(?:checkbox|radio)$/i;\n\n  var _loop = function _loop(i) {\n    var input = elements[i];\n    var checked = input.checked,\n        name = input.name,\n        multiple = input.multiple,\n        options = input.options,\n        tagName = input.tagName,\n        type = input.type,\n        value = input.value;\n\n    if (!name || isDisabled(input) || !submittableTagsRegex.test(tagName) || unsubmittableTypesRegex.test(type) || checkableType.test(type) && !checked) {\n      return \"continue\";\n    }\n\n    if (data[name] === undefined) {\n      data[name] = [];\n    }\n\n    if (multiple) {\n      (0, _dom.iterateCursor)(options, function (option) {\n        if (option.selected) {\n          data[name].push(option.value);\n        }\n      });\n      return \"continue\";\n    }\n\n    data[name].push(value);\n  };\n\n  for (var i = 0; i < elements.length; i++) {\n    var _ret = _loop(i);\n\n    if (_ret === \"continue\") continue;\n  }\n\n  var submitButton = getSubmitButtonUsed(form);\n\n  if (submitButton && submitButton.name) {\n    var name = submitButton.name;\n\n    if (data[name] === undefined) {\n      data[name] = [];\n    }\n\n    data[submitButton.name].push(submitButton.value);\n  } // Wait until the end to remove the empty values, since\n  // we don't know when evaluating any one input whether\n  // there will be or have already been inputs with the same names.\n  // e.g. We want to remove empty <select multiple name=x> but\n  // there could also be an <input name=x>. At the end we know if an empty name\n  // can be deleted.\n\n\n  Object.keys(data).forEach(function (key) {\n    if (data[key].length == 0) {\n      delete data[key];\n    }\n  });\n  return data;\n}\n/**\n * Gets the submit button used to submit the form.\n * This searches through the form elements to find:\n * 1. The first submit button element OR\n * 2. a focused submit button, indicating it was specifically used to submit.\n * 3. null, if neither of the above is found.\n * @param {!HTMLFormElement} form\n * @return {?Element}\n */\n\n\nfunction getSubmitButtonUsed(form) {\n  var elements = form.elements;\n  var length = elements.length;\n  var activeElement = form.ownerDocument.activeElement;\n  var firstSubmitButton = null;\n\n  for (var i = 0; i < length; i++) {\n    var element = elements[i];\n\n    if (!isSubmitButton(element)) {\n      continue;\n    }\n\n    if (!firstSubmitButton) {\n      firstSubmitButton = element;\n    }\n\n    if (activeElement == element) {\n      return activeElement;\n    }\n  }\n\n  return firstSubmitButton;\n}\n/**\n * True if the given button can submit a form.\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isSubmitButton(element) {\n  var tagName = element.tagName,\n      type = element.type;\n  return tagName == 'BUTTON' || type == 'submit';\n}\n/**\n * Checks if a field is disabled.\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isDisabled(element) {\n  if (element.disabled) {\n    return true;\n  }\n\n  var ancestors = (0, _dom.ancestorElementsByTag)(element, 'fieldset');\n\n  for (var i = 0; i < ancestors.length; i++) {\n    if (ancestors[i].disabled) {\n      return true;\n    }\n  }\n\n  return false;\n}\n/**\n * Checks if a form field is in its default state.\n * @param {!Element} field\n * @return {boolean}\n */\n\n\nfunction isFieldDefault(field) {\n  switch (field.type) {\n    case 'select-multiple':\n    case 'select-one':\n      var options = field.options;\n\n      for (var j = 0; j < options.length; j++) {\n        if (options[j].selected !== options[j].defaultSelected) {\n          return false;\n        }\n      }\n\n      break;\n\n    case 'checkbox':\n    case 'radio':\n      return field.checked === field.defaultChecked;\n\n    default:\n      return field.value === field.defaultValue;\n  }\n\n  return true;\n}\n/**\n * Checks if a form field is empty. It expects a form field element,\n * i.e. `<input>`, `<textarea>`, or `<select>`.\n * @param {!Element} field\n * @throws {Error}\n * @return {boolean}\n */\n\n\nfunction isFieldEmpty(field) {\n  switch (field.tagName) {\n    case 'INPUT':\n      if (field.type == 'checkbox' || field.type == 'radio') {\n        return !field.checked;\n      } else {\n        return !field.value;\n      }\n\n    case 'TEXTAREA':\n      return !field.value;\n\n    case 'SELECT':\n      // dropdown menu has at least one option always selected\n      return false;\n\n    default:\n      throw new Error(\"isFieldEmpty: \" + field.tagName + \" is not a supported field element.\");\n  }\n}\n\n},{\"./dom\":41}],54:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.setSrcdocSupportedForTesting = setSrcdocSupportedForTesting;\nexports.setFriendlyIframeEmbedVisible = setFriendlyIframeEmbedVisible;\nexports.installFriendlyIframeEmbed = installFriendlyIframeEmbed;\nexports.mergeHtmlForTesting = mergeHtmlForTesting;\nexports.installStandardServicesInEmbed = installStandardServicesInEmbed;\nexports.FriendlyIframeEmbed = exports.FriendlyIframeSpec = exports.FIE_CSS_CLEANUP_EXP = void 0;\n\nvar _commonSignals = require(\"./common-signals\");\n\nvar _iframeHelper = require(\"./iframe-helper\");\n\nvar _extensionsImpl = require(\"./service/extensions-impl\");\n\nvar _observable = require(\"./observable\");\n\nvar _services = require(\"./services\");\n\nvar _signals = require(\"./utils/signals\");\n\nvar _ampdoc = require(\"../build/ampdoc.css\");\n\nvar _ampshared = require(\"../build/ampshared.css\");\n\nvar _customElementRegistry = require(\"./service/custom-element-registry\");\n\nvar _log = require(\"./log\");\n\nvar _service = require(\"./service\");\n\nvar _dom = require(\"./dom\");\n\nvar _experiments = require(\"./experiments\");\n\nvar _coreServices = require(\"./service/core-services\");\n\nvar _customElements = require(\"./polyfills/custom-elements\");\n\nvar _domtokenlist = require(\"./polyfills/domtokenlist\");\n\nvar _documentContains = require(\"./polyfills/document-contains\");\n\nvar _styleInstaller = require(\"./style-installer\");\n\nvar _timerImpl = require(\"./service/timer-impl\");\n\nvar _documentReady = require(\"./document-ready\");\n\nvar _layoutRect = require(\"./layout-rect\");\n\nvar _eventHelper = require(\"./event-helper\");\n\nvar _style = require(\"./style\");\n\nvar _types = require(\"./types\");\n\nvar _iniLoad = require(\"./ini-load\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @const {{experiment: string, control: string, branch: string}}\n */\nvar FIE_CSS_CLEANUP_EXP = {\n  branch: 'fie-css-cleanup',\n  control: '21064213',\n  experiment: '21064214'\n};\n/**\n * Parameters used to create the new \"friendly iframe\" embed.\n * - html: The complete content of an AMP embed, which is itself an AMP\n *   document. Can include whatever is normally allowed in an AMP document,\n *   except for AMP `<script>` declarations. Those should be passed as an\n *   array of `extensionIds`.\n * - extensionsIds: An optional array of AMP extension IDs used in this embed.\n * - fonts: An optional array of fonts used in this embed.\n *\n * @typedef {{\n *   host: (?AmpElement|undefined),\n *   url: string,\n *   html: string,\n *   extensionIds: (?Array<string>|undefined),\n *   fonts: (?Array<string>|undefined),\n * }}\n */\n\nexports.FIE_CSS_CLEANUP_EXP = FIE_CSS_CLEANUP_EXP;\nvar FriendlyIframeSpec;\n/**\n * @type {boolean|undefined}\n * @visibleForTesting\n */\n\nexports.FriendlyIframeSpec = FriendlyIframeSpec;\nvar srcdocSupported;\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\n\nfunction setSrcdocSupportedForTesting(val) {\n  srcdocSupported = val;\n}\n/**\n * Returns `true` if the Friendly Iframes are supported.\n * @return {boolean}\n */\n\n\nfunction isSrcdocSupported() {\n  if (srcdocSupported === undefined) {\n    srcdocSupported = 'srcdoc' in HTMLIFrameElement.prototype;\n  }\n\n  return srcdocSupported;\n}\n/**\n * Sets whether the embed is currently visible. The interpretation of visibility\n * is up to the embed parent. However, most of typical cases would rely on\n * whether the embed is currently in the viewport.\n * @param {!FriendlyIframeEmbed} embed\n * @param {boolean} visible\n * TODO(dvoytenko): Re-evaluate and probably drop once layers are ready.\n */\n\n\nfunction setFriendlyIframeEmbedVisible(embed, visible) {\n  embed.setVisible_(visible);\n}\n/**\n * Creates the requested \"friendly iframe\" embed. Returns the promise that\n * will be resolved as soon as the embed is available. The actual\n * initialization of the embed will start as soon as the `iframe` is added\n * to the DOM.\n * @param {!HTMLIFrameElement} iframe\n * @param {!Element} container\n * @param {!FriendlyIframeSpec} spec\n * @param {function(!Window, ?./service/ampdoc-impl.AmpDoc=)=} opt_preinstallCallback\n * @return {!Promise<!FriendlyIframeEmbed>}\n */\n\n\nfunction installFriendlyIframeEmbed(iframe, container, spec, opt_preinstallCallback // TODO(#22733): remove \"window\" argument.\n) {\n  /** @const {!Window} */\n  var win = (0, _service.getTopWindow)((0, _types.toWin)(iframe.ownerDocument.defaultView));\n  /** @const {!./service/extensions-impl.Extensions} */\n\n  var extensions = _services.Services.extensionsFor(win);\n\n  var ampdocFieExperimentOn = (0, _experiments.isExperimentOn)(win, 'ampdoc-fie');\n  /** @const {?./service/ampdoc-impl.AmpDocService} */\n\n  var ampdocService = ampdocFieExperimentOn ? _services.Services.ampdocServiceFor(win) : null;\n  (0, _style.setStyle)(iframe, 'visibility', 'hidden');\n  iframe.setAttribute('referrerpolicy', 'unsafe-url');\n  iframe.setAttribute('marginheight', '0');\n  iframe.setAttribute('marginwidth', '0'); // Pre-load extensions.\n\n  if (spec.extensionIds) {\n    spec.extensionIds.forEach(function (extensionId) {\n      return extensions.preloadExtension(extensionId);\n    });\n  }\n\n  var html = mergeHtml(spec); // Receive the signal when iframe is ready: it's document is formed.\n\n  iframe.onload = function () {\n    // Chrome does not reflect the iframe readystate.\n    iframe.readyState = 'complete';\n  };\n\n  var registerViolationListener = function registerViolationListener() {\n    iframe.contentWindow.addEventListener('securitypolicyviolation', function (violationEvent) {\n      (0, _log.dev)().warn('FIE', 'security policy violation', violationEvent);\n    });\n  };\n\n  var loadedPromise;\n\n  if (isSrcdocSupported()) {\n    iframe.srcdoc = html;\n    loadedPromise = (0, _eventHelper.loadPromise)(iframe);\n    container.appendChild(iframe);\n    registerViolationListener();\n  } else {\n    iframe.src = 'about:blank';\n    container.appendChild(iframe);\n    var childDoc = iframe.contentWindow.document;\n    childDoc.open();\n    registerViolationListener();\n    childDoc.write(html); // With document.write, `iframe.onload` arrives almost immediately, thus\n    // we need to wait for child's `window.onload`.\n\n    loadedPromise = (0, _eventHelper.loadPromise)(iframe.contentWindow);\n    childDoc.close();\n  } // Wait for document ready signal.\n  // This is complicated due to crbug.com/649201 on Chrome and a similar issue\n  // on Safari where newly created document's `readyState` immediately equals\n  // `complete`, even though the document itself is not yet available. There's\n  // no other reliable signal for `readyState` in a child window and thus\n  // we have to fallback to polling.\n\n\n  var readyPromise;\n\n  if (isIframeReady(iframe)) {\n    readyPromise = Promise.resolve();\n  } else {\n    readyPromise = new Promise(function (resolve) {\n      /** @const {number} */\n      var interval = win.setInterval(function () {\n        if (isIframeReady(iframe)) {\n          resolve();\n          win.clearInterval(interval);\n        }\n      },\n      /* milliseconds */\n      5); // For safety, make sure we definitely stop polling when child doc is\n      // loaded.\n\n      loadedPromise.catch(function (error) {\n        (0, _log.rethrowAsync)(error);\n      }).then(function () {\n        resolve();\n        win.clearInterval(interval);\n      });\n    });\n  }\n\n  return readyPromise.then(function () {\n    var childWin =\n    /** @type {!Window} */\n    iframe.contentWindow;\n    var signals = spec.host && spec.host.signals();\n    var ampdoc = ampdocFieExperimentOn && ampdocService ? ampdocService.installFieDoc(spec.url, childWin, {\n      signals: signals\n    }) : null;\n    var embed = new FriendlyIframeEmbed(iframe, spec, loadedPromise, ampdoc);\n    iframe[_iframeHelper.FIE_EMBED_PROP] = embed; // Add extensions.\n\n    if (ampdoc && ampdocFieExperimentOn) {\n      embed.installExtensionsInFie(extensions, ampdoc, spec.extensionIds || [], opt_preinstallCallback);\n    } else {\n      embed.installExtensionsInChildWindow(extensions, childWin, spec.extensionIds || [], opt_preinstallCallback);\n    } // Ready to be shown.\n\n\n    embed.startRender_();\n    return embed;\n  });\n}\n/**\n * Returns `true` when iframe is ready.\n * @param {!HTMLIFrameElement} iframe\n * @return {boolean}\n */\n\n\nfunction isIframeReady(iframe) {\n  // This is complicated due to crbug.com/649201 on Chrome and a similar issue\n  // on Safari where newly created document's `readyState` immediately equals\n  // `complete`, even though the document itself is not yet available. There's\n  // no other reliable signal for `readyState` in a child window and thus\n  // the best way to check is to see the contents of the body.\n  var childDoc = iframe.contentWindow && iframe.contentWindow.document;\n  return !!(childDoc && (0, _documentReady.isDocumentReady)(childDoc) && childDoc.body && childDoc.body.firstChild);\n}\n/**\n * Merges base and fonts into html document.\n * @param {!FriendlyIframeSpec} spec\n * @return {string}\n */\n\n\nfunction mergeHtml(spec) {\n  var originalHtml = spec.html;\n  var originalHtmlUp = originalHtml.toUpperCase(); // Find the insertion point.\n\n  var ip = originalHtmlUp.indexOf('<HEAD');\n\n  if (ip != -1) {\n    ip = originalHtmlUp.indexOf('>', ip + 1) + 1;\n  }\n\n  if (ip == -1) {\n    ip = originalHtmlUp.indexOf('<BODY');\n  }\n\n  if (ip == -1) {\n    ip = originalHtmlUp.indexOf('<HTML');\n\n    if (ip != -1) {\n      ip = originalHtmlUp.indexOf('>', ip + 1) + 1;\n    }\n  }\n\n  var result = []; // Preambule.\n\n  if (ip > 0) {\n    result.push(originalHtml.substring(0, ip));\n  } // Add <BASE> tag.\n\n\n  result.push(\"<base href=\\\"\" + (0, _dom.escapeHtml)(spec.url) + \"\\\">\"); // Load fonts.\n\n  if (spec.fonts) {\n    spec.fonts.forEach(function (font) {\n      result.push(\"<link href=\\\"\" + (0, _dom.escapeHtml)(font) + \"\\\" rel=\\\"stylesheet\\\" type=\\\"text/css\\\">\");\n    });\n  } // Load CSP\n\n\n  result.push('<meta http-equiv=Content-Security-Policy ' + \"content=\\\"script-src 'none';object-src 'none';child-src 'none'\\\">\"); // Postambule.\n\n  if (ip > 0) {\n    result.push(originalHtml.substring(ip));\n  } else {\n    result.push(originalHtml);\n  }\n\n  return result.join('');\n}\n/**\n * Exposes `mergeHtml` for testing purposes.\n * @param {!FriendlyIframeSpec} spec\n * @return {string}\n * @visibleForTesting\n */\n\n\nfunction mergeHtmlForTesting(spec) {\n  return mergeHtml(spec);\n}\n/**\n * A \"friendly iframe\" embed. This is the iframe that's fully accessible to\n * the AMP runtime. It's similar to Shadow DOM in many respects, but it also\n * provides iframe/viewport measurements and enables the use of `vh`, `vw` and\n * `@media` CSS.\n *\n * The friendly iframe is managed by the top-level AMP Runtime. When it's\n * destroyed, the `destroy` method must be called to free up the shared\n * resources.\n *\n * @visibleForTesting\n */\n\n\nvar FriendlyIframeEmbed =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!HTMLIFrameElement} iframe\n   * @param {!FriendlyIframeSpec} spec\n   * @param {!Promise} loadedPromise\n   * @param {?./service/ampdoc-impl.AmpDocFie} ampdoc\n   */\n  function FriendlyIframeEmbed(iframe, spec, loadedPromise, ampdoc) {\n    var _this = this;\n\n    /** @const {!HTMLIFrameElement} */\n    this.iframe = iframe;\n    /** @const {!Window} */\n\n    this.win =\n    /** @type {!Window} */\n    iframe.contentWindow;\n    /** @const {?./service/ampdoc-impl.AmpDocFie} */\n\n    this.ampdoc = ampdoc;\n    /** @const {!FriendlyIframeSpec} */\n\n    this.spec = spec;\n    /** @const {?AmpElement} */\n\n    this.host = spec.host || null;\n    /** @const @private {time} */\n\n    this.startTime_ = Date.now();\n    /**\n     * Starts out as invisible. The interpretation of this flag is up to\n     * the emded parent.\n     * @private {boolean}\n     */\n\n    this.visible_ = false;\n    /** @private {!Observable<boolean>} */\n\n    this.visibilityObservable_ = new _observable.Observable();\n    /** @private @const */\n\n    this.signals_ = this.ampdoc ? this.ampdoc.signals() : this.host ? this.host.signals() : new _signals.Signals();\n    /** @private @const {!Promise} */\n\n    this.winLoadedPromise_ = Promise.all([loadedPromise, this.whenReady()]);\n\n    if (this.ampdoc) {\n      this.whenReady().then(function () {\n        return _this.ampdoc.setReady();\n      });\n    }\n  }\n  /**\n   * Ensures that all resources from this iframe have been released.\n   */\n\n\n  var _proto = FriendlyIframeEmbed.prototype;\n\n  _proto.destroy = function destroy() {\n    this.removeResources_();\n    (0, _service.disposeServicesForEmbed)(this.win);\n\n    if (this.ampdoc) {\n      this.ampdoc.dispose();\n    }\n  }\n  /**\n   * @return {time}\n   */\n  ;\n\n  _proto.getStartTime = function getStartTime() {\n    return this.startTime_;\n  }\n  /**\n   * Returns the base URL for the embedded document.\n   * @return {string}\n   */\n  ;\n\n  _proto.getUrl = function getUrl() {\n    return this.spec.url;\n  }\n  /** @return {!Signals} */\n  ;\n\n  _proto.signals = function signals() {\n    return this.signals_;\n  }\n  /**\n   * Returns a promise that will resolve when the embed document is ready.\n   * Notice that this signal coincides with the embed's `render-start`.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.whenReady = function whenReady() {\n    return this.signals_.whenSignal(_commonSignals.CommonSignals.RENDER_START);\n  }\n  /**\n   * Returns a promise that will resolve when the child window's `onload` event\n   * has been emitted. In friendly iframes this typically only includes font\n   * loading.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.whenWindowLoaded = function whenWindowLoaded() {\n    return this.winLoadedPromise_;\n  }\n  /**\n   * Returns a promise that will resolve when the initial load  of the embed's\n   * content has been completed.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.whenIniLoaded = function whenIniLoaded() {\n    return this.signals_.whenSignal(_commonSignals.CommonSignals.INI_LOAD);\n  }\n  /**\n   * @private\n   * @restricted\n   */\n  ;\n\n  _proto.startRender_ = function startRender_() {\n    var _this2 = this;\n\n    if (this.host) {\n      this.host.renderStarted();\n    } else {\n      this.signals_.signal(_commonSignals.CommonSignals.RENDER_START);\n    } // Common signal RENDER_START indicates time to toggle visibility\n\n\n    (0, _style.setStyle)(this.iframe, 'visibility', '');\n\n    if (this.win.document && this.win.document.body) {\n      this.win.document.documentElement.classList.add('i-amphtml-fie');\n      (0, _style.setStyles)((0, _log.dev)().assertElement(this.win.document.body), {\n        opacity: 1,\n        visibility: 'visible',\n        animation: 'none'\n      });\n    } // Initial load signal signal.\n\n\n    var rect;\n\n    if (this.host) {\n      rect = this.host.getLayoutBox();\n    } else {\n      rect = (0, _layoutRect.layoutRectLtwh)(0, 0, this.win.\n      /*OK*/\n      innerWidth, this.win.\n      /*OK*/\n      innerHeight);\n    }\n\n    Promise.all([this.whenReady(), (0, _iniLoad.whenContentIniLoad)(this.iframe, this.win, rect)]).then(function () {\n      _this2.signals_.signal(_commonSignals.CommonSignals.INI_LOAD);\n    });\n  }\n  /**\n   * Whether the embed is currently visible. The interpretation of visibility\n   * is up to the embed parent. However, most of typical cases would rely on\n   * whether the embed is currently in the viewport.\n   * @return {boolean}\n   * TODO(dvoytenko): Re-evaluate and probably drop once layers are ready.\n   */\n  ;\n\n  _proto.isVisible = function isVisible() {\n    return this.visible_;\n  }\n  /**\n   * See `isVisible` for more info.\n   * @param {function(boolean)} handler\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onVisibilityChanged = function onVisibilityChanged(handler) {\n    return this.visibilityObservable_.add(handler);\n  }\n  /**\n   * @param {boolean} visible\n   * @private\n   * @restricted\n   */\n  ;\n\n  _proto.setVisible_ = function setVisible_(visible) {\n    if (this.visible_ != visible) {\n      this.visible_ = visible;\n      this.visibilityObservable_.fire(this.visible_);\n    }\n  }\n  /**\n   * @return {!HTMLBodyElement}\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.getBodyElement = function getBodyElement() {\n    return (\n      /** @type {!HTMLBodyElement} */\n      (this.iframe.contentDocument || this.iframe.contentWindow.document).body\n    );\n  }\n  /**\n   * @return {!./service/resources-interface.ResourcesInterface}\n   * @private\n   */\n  ;\n\n  _proto.getResources_ = function getResources_() {\n    return _services.Services.resourcesForDoc(this.iframe);\n  }\n  /**\n   * Runs a measure/mutate cycle ensuring that the iframe change is propagated\n   * to the resource manager.\n   * @param {{measure: (function()|undefined), mutate: function()}} task\n   * @return {!Promise}\n   * @private\n   */\n  ;\n\n  _proto.measureMutate_ = function measureMutate_(task) {\n    return this.getResources_().measureMutateElement(this.iframe, task.measure || null, task.mutate);\n  }\n  /**\n   * Removes all resources belonging to the FIE window.\n   * @private\n   */\n  ;\n\n  _proto.removeResources_ = function removeResources_() {\n    var _this3 = this;\n\n    var resources = this.getResources_();\n    var toRemove = resources.get().filter(function (resource) {\n      return resource.hostWin == _this3.win;\n    });\n    toRemove.forEach(function (resource) {\n      resources.remove(resource.element);\n      resource.disconnect();\n    });\n  }\n  /**\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.enterFullOverlayMode = function enterFullOverlayMode() {\n    var _this4 = this;\n\n    var ampAdParent = (0, _log.dev)().assertElement(this.iframe.parentNode); // Security assertion. Otherwise any 3p frame could request lighbox mode.\n\n    (0, _log.userAssert)(ampAdParent.tagName.toLowerCase() == 'amp-ad', 'Only <amp-ad> is allowed to enter lightbox mode.');\n    var bodyStyle;\n    return this.measureMutate_({\n      measure: function measure() {\n        var rect = _this4.host ? _this4.host.getLayoutBox() : _this4.iframe.\n        /*OK*/\n        getBoundingClientRect(); // Offset by scroll top as iframe will be position: fixed.\n\n        var dy = -_services.Services.viewportForDoc(_this4.iframe).getScrollTop();\n\n        var _moveLayoutRect = (0, _layoutRect.moveLayoutRect)(rect,\n        /* dx */\n        0, dy),\n            top = _moveLayoutRect.top,\n            left = _moveLayoutRect.left,\n            width = _moveLayoutRect.width,\n            height = _moveLayoutRect.height; // Offset body by header height to prevent visual jump.\n\n\n        bodyStyle = {\n          top: (0, _style.px)(top),\n          left: (0, _style.px)(left),\n          width: (0, _style.px)(width),\n          height: (0, _style.px)(height)\n        };\n      },\n      mutate: function mutate() {\n        // !important to prevent abuse e.g. box @ ltwh = 0, 0, 0, 0\n        (0, _style.setImportantStyles)(_this4.iframe, {\n          'position': 'fixed',\n          'left': 0,\n          'right': 0,\n          'bottom': 0,\n          'width': '100vw',\n          'top': 0,\n          'height': '100vh'\n        }); // We need to override runtime-level !important rules\n\n        (0, _style.setImportantStyles)(_this4.getBodyElement(), {\n          'background': 'transparent',\n          'position': 'absolute',\n          'bottom': 'auto',\n          'right': 'auto',\n          // Read during vsync measure phase.\n          'top': bodyStyle.top,\n          'left': bodyStyle.left,\n          'width': bodyStyle.width,\n          'height': bodyStyle.height\n        });\n      }\n    });\n  }\n  /**\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.leaveFullOverlayMode = function leaveFullOverlayMode() {\n    var _this5 = this;\n\n    return this.measureMutate_({\n      mutate: function mutate() {\n        (0, _style.resetStyles)(_this5.iframe, ['position', 'left', 'right', 'top', 'bottom', 'width', 'height']); // we're not resetting background here as we need to set it to\n        // transparent permanently.\n\n        (0, _style.resetStyles)(_this5.getBodyElement(), ['position', 'top', 'left', 'width', 'height', 'bottom', 'right']);\n      }\n    });\n  }\n  /**\n   * Install extensions in the child window (friendly iframe). The pre-install\n   * callback, if specified, is executed after polyfills have been configured\n   * but before the first extension is installed.\n   * @param {!./service/extensions-impl.Extensions} extensions\n   * @param {!./service/ampdoc-impl.AmpDocFie} ampdoc\n   * @param {!Array<string>} extensionIds\n   * @param {function(!Window, ?./service/ampdoc-impl.AmpDoc=)=} opt_preinstallCallback\n   * @return {!Promise}\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.installExtensionsInFie = function installExtensionsInFie(extensions, ampdoc, extensionIds, opt_preinstallCallback) {\n    var topWin = extensions.win;\n    var childWin = ampdoc.win;\n    var parentWin = (0, _types.toWin)(childWin.frameElement.ownerDocument.defaultView);\n    (0, _service.setParentWindow)(childWin, parentWin); // Install necessary polyfills.\n\n    installPolyfillsInChildWindow(parentWin, childWin); // Install runtime styles.\n\n    (0, _styleInstaller.installStylesForDoc)(ampdoc, (0, _experiments.getExperimentBranch)(this.win, FIE_CSS_CLEANUP_EXP.branch) === FIE_CSS_CLEANUP_EXP.experiment ? _ampshared.cssText : _ampdoc.cssText + _ampshared.cssText,\n    /* callback */\n    null,\n    /* opt_isRuntimeCss */\n    true,\n    /* opt_ext */\n    'amp-runtime'); // Run pre-install callback.\n\n    if (opt_preinstallCallback) {\n      opt_preinstallCallback(ampdoc.win, ampdoc);\n    } // Install embeddable standard services.\n\n\n    installStandardServicesInEmbeddedDoc(ampdoc); // Install built-ins and legacy elements.\n\n    copyBuiltinElementsToChildWindow(topWin, childWin);\n    (0, _extensionsImpl.stubLegacyElements)(childWin);\n    return Promise.all(extensionIds.map(function (extensionId) {\n      // This will extend automatic upgrade of custom elements from top\n      // window to the child window.\n      if (!_extensionsImpl.LEGACY_ELEMENTS.includes(extensionId)) {\n        (0, _customElementRegistry.stubElementIfNotKnown)(childWin, extensionId);\n      }\n\n      return extensions.installExtensionInDoc(ampdoc, extensionId);\n    }));\n  }\n  /**\n   * Install extensions in the child window (friendly iframe). The pre-install\n   * callback, if specified, is executed after polyfills have been configured\n   * but before the first extension is installed.\n   * @param {!./service/extensions-impl.Extensions} extensions\n   * @param {!Window} childWin\n   * @param {!Array<string>} extensionIds\n   * @param {function(!Window, ?./service/ampdoc-impl.AmpDoc=)=} opt_preinstallCallback\n   * @return {!Promise}\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.installExtensionsInChildWindow = function installExtensionsInChildWindow(extensions, childWin, extensionIds, opt_preinstallCallback) {\n    var topWin = extensions.win;\n    var parentWin = (0, _types.toWin)(childWin.frameElement.ownerDocument.defaultView);\n    (0, _service.setParentWindow)(childWin, parentWin); // Install necessary polyfills.\n\n    installPolyfillsInChildWindow(parentWin, childWin); // Install runtime styles.\n\n    (0, _styleInstaller.installStylesLegacy)(childWin.document, (0, _experiments.getExperimentBranch)(this.win, FIE_CSS_CLEANUP_EXP.branch) === FIE_CSS_CLEANUP_EXP.experiment ? _ampshared.cssText : _ampdoc.cssText + _ampshared.cssText,\n    /* callback */\n    null,\n    /* opt_isRuntimeCss */\n    true,\n    /* opt_ext */\n    'amp-runtime'); // Run pre-install callback.\n\n    if (opt_preinstallCallback) {\n      opt_preinstallCallback(childWin);\n    } // Install embeddable standard services.\n\n\n    installStandardServicesInEmbed(childWin); // Install built-ins and legacy elements.\n\n    copyBuiltinElementsToChildWindow(topWin, childWin);\n    (0, _extensionsImpl.stubLegacyElements)(childWin);\n    var promises = [];\n    extensionIds.forEach(function (extensionId) {\n      // This will extend automatic upgrade of custom elements from top\n      // window to the child window.\n      if (!_extensionsImpl.LEGACY_ELEMENTS.includes(extensionId)) {\n        (0, _customElementRegistry.stubElementIfNotKnown)(childWin, extensionId);\n      } // Install CSS.\n\n\n      var promise = extensions.preloadExtension(extensionId).then(function (extension) {\n        // Adopt embeddable extension services.\n        extension.services.forEach(function (service) {\n          (0, _service.installServiceInEmbedIfEmbeddable)(childWin, service.serviceClass);\n        }); // Adopt the custom elements.\n\n        var elementPromises = null;\n\n        var _loop = function _loop(elementName) {\n          var elementDef = extension.elements[elementName];\n          var elementPromise = new Promise(function (resolve) {\n            if (elementDef.css) {\n              (0, _styleInstaller.installStylesLegacy)(childWin.document, elementDef.css,\n              /* completeCallback */\n              resolve,\n              /* isRuntime */\n              false, extensionId);\n            } else {\n              resolve();\n            }\n          }).then(function () {\n            (0, _customElementRegistry.upgradeOrRegisterElement)(childWin, elementName, elementDef.implementationClass);\n          });\n\n          if (elementPromises) {\n            elementPromises.push(elementPromise);\n          } else {\n            elementPromises = [elementPromise];\n          }\n        };\n\n        for (var elementName in extension.elements) {\n          _loop(elementName);\n        }\n\n        if (elementPromises) {\n          return Promise.all(elementPromises).then(function () {\n            return extension;\n          });\n        }\n\n        return extension;\n      });\n      promises.push(promise);\n    });\n    return Promise.all(promises);\n  };\n\n  return FriendlyIframeEmbed;\n}();\n/**\n * Install polyfills in the child window (friendly iframe).\n * @param {!Window} parentWin\n * @param {!Window} childWin\n */\n\n\nexports.FriendlyIframeEmbed = FriendlyIframeEmbed;\n\nfunction installPolyfillsInChildWindow(parentWin, childWin) {\n  (0, _documentContains.install)(childWin);\n  (0, _domtokenlist.install)(childWin);\n  (0, _customElements.install)(childWin);\n}\n/**\n * Copy builtins to a child window.\n * @param {!Window} parentWin\n * @param {!Window} childWin\n */\n\n\nfunction copyBuiltinElementsToChildWindow(parentWin, childWin) {\n  (0, _customElementRegistry.copyElementToChildWindow)(parentWin, childWin, 'amp-img');\n  (0, _customElementRegistry.copyElementToChildWindow)(parentWin, childWin, 'amp-pixel');\n}\n/**\n * Adopt predefined core services for the embedded ampdoc (friendly iframe).\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nfunction installStandardServicesInEmbeddedDoc(ampdoc) {\n  (0, _coreServices.installAmpdocServices)(ampdoc);\n  (0, _timerImpl.installTimerInEmbedWindow)(ampdoc.win);\n}\n/**\n * Adopt predefined core services for the child window (friendly iframe).\n * @param {!Window} childWin\n * @visibleForTesting\n */\n\n\nfunction installStandardServicesInEmbed(childWin) {\n  // TODO(#22733): remove when ampdoc-fie is launched.\n  var frameElement = (0, _log.dev)().assertElement(childWin.frameElement, 'frameElement not found for embed');\n  var standardServices = [// The order of service adoptations is important.\n  _services.Services.urlForDoc(frameElement), _services.Services.actionServiceForDoc(frameElement), _services.Services.standardActionsForDoc(frameElement), _services.Services.navigationForDoc(frameElement)];\n  var ampdoc = (0, _service.getAmpdoc)(frameElement);\n  standardServices.forEach(function (service) {\n    // Static functions must be invoked on the class, not the instance.\n    service.constructor.installInEmbedWindow(childWin, ampdoc);\n  });\n  (0, _timerImpl.installTimerInEmbedWindow)(childWin);\n}\n\n},{\"../build/ampdoc.css\":6,\"../build/ampshared.css\":7,\"./common-signals\":31,\"./document-ready\":39,\"./dom\":41,\"./event-helper\":46,\"./experiments\":47,\"./iframe-helper\":57,\"./ini-load\":59,\"./layout-rect\":65,\"./log\":68,\"./observable\":71,\"./polyfills/custom-elements\":74,\"./polyfills/document-contains\":75,\"./polyfills/domtokenlist\":76,\"./service\":79,\"./service/core-services\":85,\"./service/custom-element-registry\":87,\"./service/extensions-impl\":90,\"./service/timer-impl\":108,\"./services\":123,\"./style\":128,\"./style-installer\":127,\"./types\":131,\"./utils/signals\":149}],55:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getState = getState;\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Gets state from History.\n * But IE11 throws if there is no state.\n *\n * @param {!History} history\n * @return {*}\n */\nfunction getState(history) {\n  try {\n    return history.state;\n  } catch (e) {\n    return null;\n  }\n}\n\n},{}],56:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getContextMetadata = getContextMetadata;\n\nvar _domFingerprint = require(\"./utils/dom-fingerprint\");\n\nvar _services = require(\"./services\");\n\nvar _object = require(\"./utils/object.js\");\n\nvar _experiments = require(\"./experiments\");\n\nvar _layout = require(\"./layout\");\n\nvar _modeObject = require(\"./mode-object\");\n\nvar _internalVersion = require(\"./internal-version\");\n\nvar _config = require(\"./config\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Produces the attributes for the ad template.\n * @param {!Window} parentWindow\n * @param {!AmpElement} element\n * @param {string} sentinel\n * @param {!JsonObject=} attributes\n * @return {!JsonObject}\n */\nfunction getContextMetadata(parentWindow, element, sentinel, attributes) {\n  var startTime = Date.now();\n  var width = element.getAttribute('width');\n  var height = element.getAttribute('height');\n  attributes = attributes ? attributes : (0, _object.dict)();\n  attributes['width'] = (0, _layout.getLengthNumeral)(width);\n  attributes['height'] = (0, _layout.getLengthNumeral)(height);\n\n  if (element.getAttribute('title')) {\n    attributes['title'] = element.getAttribute('title');\n  }\n\n  var locationHref = parentWindow.location.href; // This is really only needed for tests, but whatever. Children\n  // see us as the logical origin, so telling them we are about:srcdoc\n  // will fail ancestor checks.\n\n  if (locationHref == 'about:srcdoc') {\n    locationHref = parentWindow.parent.location.href;\n  }\n\n  var ampdoc = _services.Services.ampdoc(element);\n\n  var docInfo = _services.Services.documentInfoForDoc(element);\n\n  var viewer = _services.Services.viewerForDoc(element);\n\n  var referrer = viewer.getUnconfirmedReferrerUrl(); // TODO(alanorozco): Redesign data structure so that fields not exposed by\n  // AmpContext are not part of this object.\n\n  var layoutRect = element.getPageLayoutBox(); // Use JsonObject to preserve field names so that ampContext can access\n  // values with name\n  // ampcontext.js and this file are compiled in different compilation unit\n  // Note: Field names can by perserved by using JsonObject, or by adding\n  // perserved name to extern. We are doing both right now.\n  // Please also add new introduced variable\n  // name to the extern list.\n\n  attributes['_context'] = (0, _object.dict)({\n    'ampcontextVersion': (0, _internalVersion.internalRuntimeVersion)(),\n    'ampcontextFilepath': _config.urls.thirdParty + \"/\" + (0, _internalVersion.internalRuntimeVersion)() + \"/ampcontext-v0.js\",\n    'sourceUrl': docInfo.sourceUrl,\n    'referrer': referrer,\n    'canonicalUrl': docInfo.canonicalUrl,\n    'pageViewId': docInfo.pageViewId,\n    'location': {\n      'href': locationHref\n    },\n    'startTime': startTime,\n    'tagName': element.tagName,\n    'mode': (0, _modeObject.getModeObject)(),\n    'canary': (0, _experiments.isCanary)(parentWindow),\n    'hidden': !ampdoc.isVisible(),\n    'initialLayoutRect': layoutRect ? {\n      'left': layoutRect.left,\n      'top': layoutRect.top,\n      'width': layoutRect.width,\n      'height': layoutRect.height\n    } : null,\n    'initialIntersection': element.getIntersectionChangeEntry(),\n    'domFingerprint': _domFingerprint.DomFingerprint.generate(element),\n    'experimentToggles': (0, _experiments.experimentToggles)(parentWindow),\n    'sentinel': sentinel\n  });\n  var adSrc = element.getAttribute('src');\n\n  if (adSrc) {\n    attributes['src'] = adSrc;\n  }\n\n  return attributes;\n}\n\n},{\"./config\":32,\"./experiments\":47,\"./internal-version\":61,\"./layout\":66,\"./mode-object\":69,\"./services\":123,\"./utils/dom-fingerprint\":139,\"./utils/object.js\":145}],57:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.listenFor = listenFor;\nexports.listenForOncePromise = listenForOncePromise;\nexports.postMessage = postMessage;\nexports.postMessageToWindows = postMessageToWindows;\nexports.parseIfNeeded = parseIfNeeded;\nexports.looksLikeTrackingIframe = looksLikeTrackingIframe;\nexports.isAdLike = isAdLike;\nexports.disableScrollingOnIframe = disableScrollingOnIframe;\nexports.canInspectWindow = canInspectWindow;\nexports.getFriendlyIframeEmbedOptional = getFriendlyIframeEmbedOptional;\nexports.isInFie = isInFie;\nexports.makePausable = makePausable;\nexports.isPausable = isPausable;\nexports.setPaused = setPaused;\nexports.FIE_EMBED_PROP = exports.SubscriptionApi = void 0;\n\nvar _dom = require(\"./dom\");\n\nvar _pFrameMessaging = require(\"./3p-frame-messaging\");\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object\");\n\nvar _eventHelper = require(\"./event-helper\");\n\nvar _url = require(\"./url\");\n\nvar _array = require(\"./utils/array\");\n\nvar _style = require(\"./style\");\n\nvar _json = require(\"./json\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Sentinel used to force unlistening after a iframe is detached.\n * @type {string}\n */\nvar UNLISTEN_SENTINEL = 'unlisten';\n/**\n * The iframe feature policy that forces the iframe to pause when it's not\n * display.\n * See https://github.com/dtapuska/iframe-freeze.\n */\n\nvar EXECUTION_WHILE_NOT_RENDERED = 'execution-while-not-rendered';\n/**\n * @typedef {{\n *   frame: !Element,\n *   events: !Object<string, !Array<function(!JsonObject)>>\n * }}\n */\n\nvar WindowEventsDef;\n/**\n * Returns a mapping from a URL's origin to an array of windows and their\n * listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {boolean=} opt_create create the mapping if it does not exist\n * @return {?Object<string, !Array<!WindowEventsDef>>}\n */\n\nfunction getListenFors(parentWin, opt_create) {\n  var listeningFors = parentWin.listeningFors;\n\n  if (!listeningFors && opt_create) {\n    listeningFors = parentWin.listeningFors = Object.create(null);\n  }\n\n  return listeningFors || null;\n}\n/**\n * Returns an array of WindowEventsDef that have had any listenFor listeners\n * registered for this sentinel.\n * @param {?Window} parentWin the window that created the iframe\n * @param {string} sentinel the sentinel of the message\n * @param {boolean=} opt_create create the array if it does not exist\n * @return {?Array<!WindowEventsDef>}\n */\n\n\nfunction getListenForSentinel(parentWin, sentinel, opt_create) {\n  var listeningFors = getListenFors(parentWin, opt_create);\n\n  if (!listeningFors) {\n    return listeningFors;\n  }\n\n  var listenSentinel = listeningFors[sentinel];\n\n  if (!listenSentinel && opt_create) {\n    listenSentinel = listeningFors[sentinel] = [];\n  }\n\n  return listenSentinel || null;\n}\n/**\n * Returns an mapping of event names to listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {!Element} iframe the iframe element who's context will trigger the\n *     event\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @return {?Object<string, !Array<function(!JsonObject, !Window, string, !MessageEvent)>>}\n */\n\n\nfunction getOrCreateListenForEvents(parentWin, iframe, opt_is3P) {\n  var sentinel = getSentinel_(iframe, opt_is3P);\n  var listenSentinel = getListenForSentinel(parentWin, sentinel, true);\n  var windowEvents;\n\n  for (var i = 0; i < listenSentinel.length; i++) {\n    var we = listenSentinel[i];\n\n    if (we.frame === iframe) {\n      windowEvents = we;\n      break;\n    }\n  }\n\n  if (!windowEvents) {\n    windowEvents = {\n      frame: iframe,\n      events: Object.create(null)\n    };\n    listenSentinel.push(windowEvents);\n  }\n\n  return windowEvents.events;\n}\n/**\n * Returns an mapping of event names to listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {string} sentinel the sentinel of the message\n * @param {string} origin the source window's origin\n * @param {?Window} triggerWin the window that triggered the event\n * @return {?Object<string, !Array<function(!JsonObject, !Window, string, !MessageEvent)>>}\n */\n\n\nfunction getListenForEvents(parentWin, sentinel, origin, triggerWin) {\n  var listenSentinel = getListenForSentinel(parentWin, sentinel);\n\n  if (!listenSentinel) {\n    return listenSentinel;\n  } // Find the entry for the frame.\n  // TODO(@nekodo): Add a WeakMap<Window, WindowEventsDef> cache to\n  //     speed up this process.\n\n\n  var windowEvents;\n\n  for (var i = 0; i < listenSentinel.length; i++) {\n    var we = listenSentinel[i];\n    var contentWindow = we.frame.contentWindow;\n\n    if (!contentWindow) {\n      setTimeout(dropListenSentinel, 0, listenSentinel);\n    } else if (triggerWin == contentWindow || isDescendantWindow(contentWindow, triggerWin)) {\n      // 3p code path, we may accept messages from nested frames.\n      windowEvents = we;\n      break;\n    }\n  }\n\n  return windowEvents ? windowEvents.events : null;\n}\n/**\n * Checks whether one window is a descendant of another by climbing\n * the parent chain.\n * @param {?Window} ancestor potential ancestor window\n * @param {?Window} descendant potential descendant window\n * @return {boolean}\n */\n\n\nfunction isDescendantWindow(ancestor, descendant) {\n  for (var win = descendant; win && win != win.parent; win = win.parent) {\n    if (win == ancestor) {\n      return true;\n    }\n  }\n\n  return false;\n}\n/**\n * Removes any listenFors registed on listenSentinel that do not have\n * a contentWindow (the frame was removed from the DOM tree).\n * @param {!Array<!WindowEventsDef>} listenSentinel\n */\n\n\nfunction dropListenSentinel(listenSentinel) {\n  var noopData = (0, _object.dict)({\n    'sentinel': UNLISTEN_SENTINEL\n  });\n\n  for (var i = listenSentinel.length - 1; i >= 0; i--) {\n    var windowEvents = listenSentinel[i];\n\n    if (!windowEvents.frame.contentWindow) {\n      listenSentinel.splice(i, 1);\n      var events = windowEvents.events;\n\n      for (var name in events) {\n        // Splice here, so that each unlisten does not shift the array\n        events[name].splice(0, Infinity).forEach(function (event) {\n          event(noopData);\n        });\n      }\n    }\n  }\n}\n/**\n * Registers the global listenFor event listener if it has yet to be.\n * @param {?Window} parentWin\n */\n\n\nfunction registerGlobalListenerIfNeeded(parentWin) {\n  if (parentWin.listeningFors) {\n    return;\n  }\n\n  var listenForListener = function listenForListener(event) {\n    if (!(0, _eventHelper.getData)(event)) {\n      return;\n    }\n\n    var data = parseIfNeeded((0, _eventHelper.getData)(event));\n\n    if (!data || !data['sentinel']) {\n      return;\n    }\n\n    var listenForEvents = getListenForEvents(parentWin, data['sentinel'], event.origin, event.source);\n\n    if (!listenForEvents) {\n      return;\n    }\n\n    var listeners = listenForEvents[data['type']];\n\n    if (!listeners) {\n      return;\n    } // We slice to avoid issues with adding another listener or unlistening\n    // during iteration. We could move to a Doubly Linked List with\n    // backtracking, but that's overly complicated.\n\n\n    listeners = listeners.slice();\n\n    for (var i = 0; i < listeners.length; i++) {\n      var listener = listeners[i];\n      listener(data, event.source, event.origin, event);\n    }\n  };\n\n  parentWin.addEventListener('message', listenForListener);\n}\n/**\n * Allows listening for message from the iframe. Returns an unlisten\n * function to remove the listener.\n *\n * @param {?Element} iframe\n * @param {string} typeOfMessage\n * @param {?function(!JsonObject, !Window, string, !MessageEvent)} callback Called when a\n *     message of this type arrives for this iframe.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @param {boolean=} opt_includingNestedWindows set to true if messages from\n *     nested frames should also be accepted.\n * @param {boolean=} opt_allowOpaqueOrigin set to true if messages from\n       opaque origins (origin == null) are allowed.\n * @return {!UnlistenDef}\n */\n\n\nfunction listenFor(iframe, typeOfMessage, callback, opt_is3P, opt_includingNestedWindows, opt_allowOpaqueOrigin) {\n  (0, _log.devAssert)(iframe.src, 'only iframes with src supported');\n  (0, _log.devAssert)(!iframe.parentNode, 'cannot register events on an attached ' + 'iframe. It will cause hair-pulling bugs like #2942');\n  (0, _log.devAssert)(callback);\n  var parentWin = iframe.ownerDocument.defaultView;\n  registerGlobalListenerIfNeeded(parentWin);\n  var listenForEvents = getOrCreateListenForEvents(parentWin, iframe, opt_is3P);\n  var iframeOrigin = (0, _url.parseUrlDeprecated)(iframe.src).origin;\n  var events = listenForEvents[typeOfMessage] || (listenForEvents[typeOfMessage] = []);\n  var unlisten;\n\n  var listener = function listener(data, source, origin, event) {\n    var sentinel = data['sentinel']; // Exclude messages that don't satisfy amp sentinel rules.\n\n    if (sentinel == 'amp') {\n      // For `amp` sentinel, nested windows are not allowed\n      if (source != iframe.contentWindow) {\n        return;\n      } // For `amp` sentinel origin must match unless opaque origin is allowed\n\n\n      var isOpaqueAndAllowed = origin == 'null' && opt_allowOpaqueOrigin;\n\n      if (iframeOrigin != origin && !isOpaqueAndAllowed) {\n        return;\n      }\n    } // Exclude nested frames if necessary.\n    // Note that the source was already verified to be either the contentWindow\n    // of the iframe itself or a descendant window within it.\n\n\n    if (!opt_includingNestedWindows && source != iframe.contentWindow) {\n      return;\n    }\n\n    if (data.sentinel == UNLISTEN_SENTINEL) {\n      unlisten();\n      return;\n    }\n\n    callback(data, source, origin, event);\n  };\n\n  events.push(listener);\n  return unlisten = function unlisten() {\n    if (listener) {\n      var index = events.indexOf(listener);\n\n      if (index > -1) {\n        events.splice(index, 1);\n      } // Make sure references to the unlisten function do not keep\n      // alive too much.\n\n\n      listener = null;\n      events = null;\n      callback = null;\n    }\n  };\n}\n/**\n * Returns a promise that resolves when one of given messages has been observed\n * for the first time. And remove listener for all other messages.\n * @param {!Element} iframe\n * @param {string|!Array<string>} typeOfMessages\n * @param {boolean=} opt_is3P\n * @return {!Promise<!{data: !JsonObject, source: !Window, origin: string, event: !MessageEvent}>}\n */\n\n\nfunction listenForOncePromise(iframe, typeOfMessages, opt_is3P) {\n  var unlistenList = [];\n\n  if (typeof typeOfMessages == 'string') {\n    typeOfMessages = [typeOfMessages];\n  }\n\n  return new Promise(function (resolve) {\n    for (var i = 0; i < typeOfMessages.length; i++) {\n      var message = typeOfMessages[i];\n      var unlisten = listenFor(iframe, message, function (data, source, origin, event) {\n        for (var _i = 0; _i < unlistenList.length; _i++) {\n          unlistenList[_i]();\n        }\n\n        resolve({\n          data: data,\n          source: source,\n          origin: origin,\n          event: event\n        });\n      }, opt_is3P);\n      unlistenList.push(unlisten);\n    }\n  });\n}\n/**\n * Posts a message to the iframe.\n * @param {!Element} iframe The iframe.\n * @param {string} type Type of the message.\n * @param {!JsonObject} object Message payload.\n * @param {string} targetOrigin origin of the target.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n */\n\n\nfunction postMessage(iframe, type, object, targetOrigin, opt_is3P) {\n  postMessageToWindows(iframe, [{\n    win: iframe.contentWindow,\n    origin: targetOrigin\n  }], type, object, opt_is3P);\n}\n/**\n * Posts an identical message to multiple target windows with the same\n * sentinel.\n * The message is serialized only once.\n * @param {!Element} iframe The iframe.\n * @param {!Array<{win: !Window, origin: string}>} targets to send the message\n *     to, pairs of window and its origin.\n * @param {string} type Type of the message.\n * @param {!JsonObject} object Message payload.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n */\n\n\nfunction postMessageToWindows(iframe, targets, type, object, opt_is3P) {\n  if (!iframe.contentWindow) {\n    return;\n  }\n\n  object['type'] = type;\n  object['sentinel'] = getSentinel_(iframe, opt_is3P);\n  var payload = object;\n\n  if (opt_is3P) {\n    // Serialize ourselves because that is much faster in Chrome.\n    payload = 'amp-' + JSON.stringify(object);\n  }\n\n  for (var i = 0; i < targets.length; i++) {\n    var target = targets[i];\n    target.win.\n    /*OK*/\n    postMessage(payload, target.origin);\n  }\n}\n/**\n * Gets the sentinel string.\n * @param {!Element} iframe The iframe.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @return {string} Sentinel string.\n * @private\n */\n\n\nfunction getSentinel_(iframe, opt_is3P) {\n  return opt_is3P ? iframe.getAttribute('data-amp-3p-sentinel') : 'amp';\n}\n/**\n * JSON parses event.data if it needs to be\n * @param {*} data\n * @return {?JsonObject} object message\n * @private\n * @visibleForTesting\n */\n\n\nfunction parseIfNeeded(data) {\n  if (typeof data == 'string') {\n    if (data.charAt(0) == '{') {\n      data = (0, _json.tryParseJson)(data, function (e) {\n        (0, _log.dev)().warn('IFRAME-HELPER', 'Postmessage could not be parsed. ' + 'Is it in a valid JSON format?', e);\n      }) || null;\n    } else if ((0, _pFrameMessaging.isAmpMessage)(data)) {\n      data = (0, _pFrameMessaging.deserializeMessage)(data);\n    } else {\n      data = null;\n    }\n  }\n\n  return (\n    /** @type {?JsonObject} */\n    data\n  );\n}\n/**\n * Manages a postMessage API for an iframe with a subscription message and\n * a way to broadcast messages to all subscribed windows, which\n * in turn must all be descendants of the contentWindow of the iframe.\n */\n\n\nvar SubscriptionApi =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Element} iframe The iframe.\n   * @param {string} type Type of the subscription message.\n   * @param {boolean} is3p set to true if the iframe is 3p.\n   * @param {function(!JsonObject, !Window, string)} requestCallback Callback\n   *     invoked whenever a new window subscribes.\n   */\n  function SubscriptionApi(iframe, type, is3p, requestCallback) {\n    var _this = this;\n\n    /** @private @const {!Element} */\n    this.iframe_ = iframe;\n    /** @private @const {boolean} */\n\n    this.is3p_ = is3p;\n    /** @private @const {!Array<{win: !Window, origin: string}>} */\n\n    this.clientWindows_ = [];\n    /** @private @const {!UnlistenDef} */\n\n    this.unlisten_ = listenFor(this.iframe_, type, function (data, source, origin) {\n      // This message might be from any window within the iframe, we need\n      // to keep track of which windows want to be sent updates.\n      if (!_this.clientWindows_.some(function (entry) {\n        return entry.win == source;\n      })) {\n        _this.clientWindows_.push({\n          win: source,\n          origin: origin\n        });\n      }\n\n      requestCallback(data, source, origin);\n    }, this.is3p_, // For 3P frames we also allow nested frames within them to subscribe..\n    this.is3p_\n    /* opt_includingNestedWindows */\n    );\n  }\n  /**\n   * Sends a message to all subscribed windows.\n   * @param {string} type Type of the message.\n   * @param {!JsonObject} data Message payload.\n   */\n\n\n  var _proto = SubscriptionApi.prototype;\n\n  _proto.send = function send(type, data) {\n    // Remove clients that have been removed from the DOM.\n    (0, _array.remove)(this.clientWindows_, function (client) {\n      return !client.win.parent;\n    });\n    postMessageToWindows(this.iframe_, this.clientWindows_, type, data, this.is3p_);\n  }\n  /**\n   * Destroys iframe.\n   */\n  ;\n\n  _proto.destroy = function destroy() {\n    this.unlisten_();\n    this.clientWindows_.length = 0;\n  };\n\n  return SubscriptionApi;\n}();\n/**\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nexports.SubscriptionApi = SubscriptionApi;\n\nfunction looksLikeTrackingIframe(element) {\n  var box = element.getLayoutBox(); // This heuristic is subject to change.\n\n  if (box.width > 10 || box.height > 10) {\n    return false;\n  } // Iframe is not tracking iframe if open with user interaction\n\n\n  return !(0, _dom.closestAncestorElementBySelector)(element, '.i-amphtml-overlay');\n} // Most common ad sizes\n// Array of [width, height] pairs.\n\n\nvar adSizes = [[300, 250], [320, 50], [300, 50], [320, 100]];\n/**\n * Guess whether this element might be an ad.\n * @param {!Element} element An amp-iframe element.\n * @return {boolean}\n * @visibleForTesting\n */\n\nfunction isAdLike(element) {\n  var box = element.getLayoutBox();\n  var height = box.height,\n      width = box.width;\n\n  for (var i = 0; i < adSizes.length; i++) {\n    var refWidth = adSizes[i][0];\n    var refHeight = adSizes[i][1];\n\n    if (refHeight > height) {\n      continue;\n    }\n\n    if (refWidth > width) {\n      continue;\n    } // Fuzzy matching to account for padding.\n\n\n    if (height - refHeight <= 20 && width - refWidth <= 20) {\n      return true;\n    }\n  }\n\n  return false;\n}\n/**\n * @param {!Element} iframe\n * @return {!Element}\n * @private\n */\n\n\nfunction disableScrollingOnIframe(iframe) {\n  (0, _dom.addAttributesToElement)(iframe, (0, _object.dict)({\n    'scrolling': 'no'\n  })); // This shouldn't work, but it does on Firefox.\n  // https://stackoverflow.com/a/15494969\n\n  (0, _style.setStyle)(iframe, 'overflow', 'hidden');\n  return iframe;\n}\n/**\n * Returns true if win's properties can be accessed and win is defined.\n * This functioned is used to determine if a window is cross-domained\n * from the perspective of the current window.\n * @param {!Window} win\n * @return {boolean}\n * @private\n */\n\n\nfunction canInspectWindow(win) {\n  // TODO: this is not reliable.  The compiler assumes that property reads are\n  // side-effect free.  The recommended fix is to use goog.reflect.sinkValue\n  // but since we're not using the closure library I'm not sure how to do this.\n  // See https://github.com/google/closure-compiler/issues/3156\n  try {\n    // win['test'] could be truthy but not true the compiler shouldn't be able\n    // to optimize this check away.\n    return !!win.location.href && (win['test'] || true);\n  } catch (unusedErr) {\n    // eslint-disable-line no-unused-vars\n    return false;\n  }\n}\n/** @const {string} */\n\n\nvar FIE_EMBED_PROP = '__AMP_EMBED__';\n/**\n * Returns the embed created using `installFriendlyIframeEmbed` or `null`.\n * Caution: This will only return the FIE after the iframe has 'loaded'. If you\n * are checking before this signal you may be in a race condition that returns\n * null.\n * @param {!HTMLIFrameElement} iframe\n * @return {?./friendly-iframe-embed.FriendlyIframeEmbed}\n */\n\nexports.FIE_EMBED_PROP = FIE_EMBED_PROP;\n\nfunction getFriendlyIframeEmbedOptional(iframe) {\n  return (\n    /** @type {?./friendly-iframe-embed.FriendlyIframeEmbed} */\n    iframe[FIE_EMBED_PROP]\n  );\n}\n/**\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isInFie(element) {\n  return element.classList.contains('i-amphtml-fie') || !!(0, _dom.closestAncestorElementBySelector)(element, '.i-amphtml-fie');\n}\n/**\n * @param {!HTMLIFrameElement} iframe\n */\n\n\nfunction makePausable(iframe) {\n  var oldAllow = (iframe.getAttribute('allow') || '').trim();\n  iframe.setAttribute('allow', EXECUTION_WHILE_NOT_RENDERED + \" 'none';\" + oldAllow);\n}\n/**\n * @param {!HTMLIFrameElement} iframe\n * @return {boolean}\n */\n\n\nfunction isPausable(iframe) {\n  return !!iframe.featurePolicy && iframe.featurePolicy.features().indexOf(EXECUTION_WHILE_NOT_RENDERED) != -1 && !iframe.featurePolicy.allowsFeature(EXECUTION_WHILE_NOT_RENDERED);\n}\n/**\n * @param {!HTMLIFrameElement} iframe\n * @param {boolean} paused\n */\n\n\nfunction setPaused(iframe, paused) {\n  (0, _style.toggle)(iframe, !paused);\n}\n\n},{\"./3p-frame-messaging\":21,\"./dom\":41,\"./event-helper\":46,\"./json\":63,\"./log\":68,\"./style\":128,\"./url\":134,\"./utils/array\":135,\"./utils/object\":145}],58:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getTrackImpressionPromise = getTrackImpressionPromise;\nexports.resetTrackImpressionPromiseForTesting = resetTrackImpressionPromiseForTesting;\nexports.maybeTrackImpression = maybeTrackImpression;\nexports.doNotTrackImpression = doNotTrackImpression;\nexports.isTrustedReferrer = isTrustedReferrer;\nexports.shouldAppendExtraParams = shouldAppendExtraParams;\nexports.getExtraParamsUrl = getExtraParamsUrl;\n\nvar _promise = require(\"./utils/promise\");\n\nvar _services = require(\"./services\");\n\nvar _url = require(\"./url\");\n\nvar _log = require(\"./log\");\n\nvar _mode = require(\"./mode\");\n\nvar _experiments = require(\"./experiments\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TIMEOUT_VALUE = 8000;\nvar trackImpressionPromise = null;\nvar DEFAULT_APPEND_URL_PARAM = ['gclid', 'gclsrc'];\n/**\n * These domains are trusted with more sensitive viewer operations such as\n * sending impression requests. If you believe your domain should be here,\n * file the issue on GitHub to discuss. The process will be similar\n * (but somewhat more stringent) to the one described in the [3p/README.md](\n * https://github.com/ampproject/amphtml/blob/master/3p/README.md)\n *\n * @export {!Array<!RegExp>}\n */\n\nvar TRUSTED_REFERRER_HOSTS = [\n/**\n * Twitter's link wrapper domains:\n * - t.co\n */\n/^t.co$/];\n/**\n * A function to get the trackImpressionPromise;\n * @return {!Promise}\n */\n\nfunction getTrackImpressionPromise() {\n  return (0, _log.userAssert)(trackImpressionPromise, 'E#19457 trackImpressionPromise');\n}\n/**\n * Function that reset the trackImpressionPromise only for testing\n * @visibleForTesting\n */\n\n\nfunction resetTrackImpressionPromiseForTesting() {\n  trackImpressionPromise = null;\n}\n/**\n * Emit a HTTP request to a destination defined on the incoming URL.\n * Launched for trusted viewer. Otherwise guarded by experiment.\n * @param {!Window} win\n */\n\n\nfunction maybeTrackImpression(win) {\n  var deferred = new _promise.Deferred();\n  var promise = deferred.promise,\n      resolveImpression = deferred.resolve;\n  trackImpressionPromise = _services.Services.timerFor(win).timeoutPromise(TIMEOUT_VALUE, promise, 'TrackImpressionPromise timeout').catch(function (error) {\n    (0, _log.dev)().warn('IMPRESSION', error);\n  });\n\n  var viewer = _services.Services.viewerForDoc(win.document.documentElement);\n\n  var isTrustedViewerPromise = viewer.isTrustedViewer();\n  var isTrustedReferrerPromise = viewer.getReferrerUrl().then(function (referrer) {\n    return isTrustedReferrer(referrer);\n  });\n  Promise.all([isTrustedViewerPromise, isTrustedReferrerPromise]).then(function (results) {\n    var isTrustedViewer = results[0];\n    var isTrustedReferrer = results[1]; // Enable the feature in the case of trusted viewer,\n    // or trusted referrer\n    // or with experiment turned on\n\n    if (!isTrustedViewer && !isTrustedReferrer && !(0, _experiments.isExperimentOn)(win, 'alp')) {\n      resolveImpression();\n      return;\n    }\n\n    var replaceUrlPromise = handleReplaceUrl(win);\n    var clickUrlPromise = handleClickUrl(win);\n    Promise.all([replaceUrlPromise, clickUrlPromise]).then(function () {\n      resolveImpression();\n    }, function () {});\n  });\n}\n/**\n * Signal that impression tracking is not relevant in this environment.\n */\n\n\nfunction doNotTrackImpression() {\n  trackImpressionPromise = Promise.resolve();\n}\n/**\n * Handle the getReplaceUrl and return a promise when url is replaced Only\n * handles replaceUrl when viewer indicates AMP to do so. Viewer should indicate\n * by setting the legacy replaceUrl init param and add `replaceUrl` to its\n * capability param. Future plan is to change the type of legacy init replaceUrl\n * param from url string to boolean value. Please NOTE replaceUrl and adLocation\n * will never arrive at same time, so there is no race condition on the order of\n * handling url replacement.\n * @param {!Window} win\n * @return {!Promise}\n */\n\n\nfunction handleReplaceUrl(win) {\n  var viewer = _services.Services.viewerForDoc(win.document.documentElement); // ReplaceUrl substitution doesn't have to wait until the document is visible\n\n\n  if (!viewer.getParam('replaceUrl')) {\n    // The init replaceUrl param serve as a signal on whether replaceUrl is\n    // required for this doc.\n    return Promise.resolve();\n  }\n\n  if (!viewer.hasCapability('replaceUrl')) {\n    // If Viewer is not capability of providing async replaceUrl, use the legacy\n    // init replaceUrl param.\n    viewer.replaceUrl(viewer.getParam('replaceUrl') || null);\n    return Promise.resolve();\n  } // request async replaceUrl is viewer support getReplaceUrl.\n\n\n  return viewer.sendMessageAwaitResponse('getReplaceUrl',\n  /* data */\n  undefined).then(function (response) {\n    if (!response || typeof response != 'object') {\n      (0, _log.dev)().warn('IMPRESSION', 'get invalid replaceUrl response');\n      return;\n    }\n\n    viewer.replaceUrl(response['replaceUrl'] || null);\n  }, function (err) {\n    (0, _log.dev)().warn('IMPRESSION', 'Error request replaceUrl from viewer', err);\n  });\n}\n/**\n * @param {string} referrer\n * @return {boolean}\n * @visibleForTesting\n */\n\n\nfunction isTrustedReferrer(referrer) {\n  var url = (0, _url.parseUrlDeprecated)(referrer);\n\n  if (url.protocol != 'https:') {\n    return false;\n  }\n\n  return TRUSTED_REFERRER_HOSTS.some(function (th) {\n    return th.test(url.hostname);\n  });\n}\n/**\n * Perform the impression request if it has been provided via\n * the click param in the viewer arguments. Returns a promise.\n * @param {!Window} win\n * @return {!Promise}\n */\n\n\nfunction handleClickUrl(win) {\n  var ampdoc = _services.Services.ampdoc(win.document.documentElement);\n\n  var viewer = _services.Services.viewerForDoc(ampdoc);\n  /** @const {?string} */\n\n\n  var clickUrl = viewer.getParam('click');\n\n  if (!clickUrl) {\n    return Promise.resolve();\n  }\n\n  if (clickUrl.indexOf('https://') != 0) {\n    (0, _log.user)().warn('IMPRESSION', 'click fragment param should start with https://. Found ', clickUrl);\n    return Promise.resolve();\n  }\n\n  if (win.location.hash) {\n    // This is typically done using replaceState inside the viewer.\n    // If for some reason it failed, get rid of the fragment here to\n    // avoid duplicate tracking.\n    win.location.hash = '';\n  } // TODO(@zhouyx) need test with a real response.\n\n\n  return ampdoc.whenFirstVisible().then(function () {\n    return invoke(win, (0, _log.dev)().assertString(clickUrl));\n  }).then(function (response) {\n    applyResponse(win, response);\n  }).catch(function (err) {\n    (0, _log.user)().warn('IMPRESSION', 'Error on request clickUrl: ', err);\n  });\n}\n/**\n * Send the url to ad server and wait for its response\n * @param {!Window} win\n * @param {string} clickUrl\n * @return {!Promise<?JsonObject>}\n */\n\n\nfunction invoke(win, clickUrl) {\n  if ((0, _mode.getMode)().localDev && !(0, _mode.getMode)().test) {\n    clickUrl = 'http://localhost:8000/impression-proxy?url=' + clickUrl;\n  }\n\n  return _services.Services.xhrFor(win).fetchJson(clickUrl, {\n    credentials: 'include'\n  }).then(function (res) {\n    // Treat 204 no content response specially\n    if (res.status == 204) {\n      return null;\n    }\n\n    return res.json();\n  });\n}\n/**\n * parse the response back from ad server\n * Set for analytics purposes\n * @param {!Window} win\n * @param {?JsonObject} response\n */\n\n\nfunction applyResponse(win, response) {\n  if (!response) {\n    return;\n  }\n\n  var adLocation = response['location'];\n  var adTracking = response['tracking_url']; // If there is a tracking_url, need to track it\n  // Otherwise track the location\n\n  var trackUrl = adTracking || adLocation;\n\n  if (trackUrl && !(0, _url.isProxyOrigin)(trackUrl)) {\n    // To request the provided trackUrl for tracking purposes.\n    new Image().src = trackUrl;\n  } // Replace the location href params with new location params we get (if any).\n\n\n  if (adLocation) {\n    if (!win.history.replaceState) {\n      return;\n    }\n\n    var viewer = _services.Services.viewerForDoc(win.document.documentElement);\n\n    var currentHref = win.location.href;\n    var url = (0, _url.parseUrlDeprecated)(adLocation);\n    var params = (0, _url.parseQueryString)(url.search);\n    var newHref = (0, _url.addParamsToUrl)(currentHref, params); // TODO: Avoid overwriting the fragment parameter.\n\n    win.history.replaceState(null, '', newHref);\n    viewer.maybeUpdateFragmentForCct();\n  }\n}\n/**\n * Return a promise that whether appending extra url params to outgoing link is\n * required.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<boolean>}\n */\n\n\nfunction shouldAppendExtraParams(ampdoc) {\n  return ampdoc.whenReady().then(function () {\n    return !!ampdoc.getBody().querySelector('amp-analytics[type=googleanalytics]');\n  });\n}\n/**\n * Return the extra url params string that should be appended to outgoing link\n * @param {!Window} win\n * @param {!Element} target\n * @return {string}\n */\n\n\nfunction getExtraParamsUrl(win, target) {\n  // Get an array with extra params that needs to append.\n  var url = (0, _url.parseUrlDeprecated)(win.location.href);\n  var params = (0, _url.parseQueryString)(url.search);\n  var appendParams = [];\n\n  for (var i = 0; i < DEFAULT_APPEND_URL_PARAM.length; i++) {\n    var param = DEFAULT_APPEND_URL_PARAM[i];\n\n    if (typeof params[param] !== 'undefined') {\n      appendParams.push(param);\n    }\n  } // Check if the param already exists\n\n\n  var additionalUrlParams = target.getAttribute('data-amp-addparams');\n  var href = target.href;\n\n  if (additionalUrlParams) {\n    href = (0, _url.addParamsToUrl)(href, (0, _url.parseQueryString)(additionalUrlParams));\n  }\n\n  var loc = (0, _url.parseUrlDeprecated)(href);\n  var existParams = (0, _url.parseQueryString)(loc.search);\n\n  for (var _i = appendParams.length - 1; _i >= 0; _i--) {\n    var _param = appendParams[_i];\n\n    if (typeof existParams[_param] !== 'undefined') {\n      appendParams.splice(_i, 1);\n    }\n  }\n\n  return getQueryParamUrl(appendParams);\n}\n/**\n * Helper method to convert an query param array to string\n * @param {!Array<string>} params\n * @return {string}\n */\n\n\nfunction getQueryParamUrl(params) {\n  var url = '';\n\n  for (var i = 0; i < params.length; i++) {\n    var param = params[i];\n    url += i == 0 ? param + \"=QUERY_PARAM(\" + param + \")\" : \"&\" + param + \"=QUERY_PARAM(\" + param + \")\";\n  }\n\n  return url;\n}\n\n},{\"./experiments\":47,\"./log\":68,\"./mode\":70,\"./services\":123,\"./url\":134,\"./utils/promise\":147}],59:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.whenContentIniLoad = whenContentIniLoad;\nexports.getMeasuredResources = getMeasuredResources;\n\nvar _resourcesInterface = require(\"./service/resources-interface\");\n\nvar _services = require(\"./services\");\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {!Array<string>} */\nvar EXCLUDE_INI_LOAD = ['AMP-AD', 'AMP-ANALYTICS', 'AMP-PIXEL', 'AMP-AD-EXIT'];\n/**\n * Returns the promise that will be resolved when all content elements\n * have been loaded in the initially visible set.\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {!Window} hostWin\n * @param {!./layout-rect.LayoutRectDef} rect\n * @param {boolean=} opt_isInPrerender signifies if we are in prerender mode.\n * @return {!Promise}\n */\n\nfunction whenContentIniLoad(elementOrAmpDoc, hostWin, rect, opt_isInPrerender) {\n  var ampdoc = _services.Services.ampdoc(elementOrAmpDoc);\n\n  return getMeasuredResources(ampdoc, hostWin, function (r) {\n    // TODO(jridgewell): Remove isFixed check here once the position\n    // is calculted correctly in a separate layer for embeds.\n    if (!r.isDisplayed() || !r.overlaps(rect) && !r.isFixed() || opt_isInPrerender && !r.prerenderAllowed()) {\n      return false;\n    }\n\n    return true;\n  }).then(function (resources) {\n    var promises = [];\n    resources.forEach(function (r) {\n      if (!EXCLUDE_INI_LOAD.includes(r.element.tagName)) {\n        promises.push(r.loadedOnce());\n      }\n    });\n    return Promise.all(promises);\n  });\n}\n/**\n * Returns a subset of resources which are (1) belong to the specified host\n * window, and (2) meet the filterFn given.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {!Window} hostWin\n * @param {function(!./service/resource.Resource):boolean} filterFn\n * @return {!Promise<!Array<!./service/resource.Resource>>}\n */\n\n\nfunction getMeasuredResources(ampdoc, hostWin, filterFn) {\n  // First, wait for the `ready-scan` signal. Waiting for each element\n  // individually is too expensive and `ready-scan` will cover most of\n  // the initially parsed elements.\n  // TODO(jridgewell): this path should be switched to use a future\n  // \"layer has been measured\" signal.\n  return ampdoc.signals().whenSignal(_resourcesInterface.READY_SCAN_SIGNAL).then(function () {\n    // Second, wait for any left-over elements to complete measuring.\n    var measurePromiseArray = [];\n\n    var resources = _services.Services.resourcesForDoc(ampdoc);\n\n    resources.get().forEach(function (r) {\n      if (!r.hasBeenMeasured() && r.hostWin == hostWin && !r.hasOwner()) {\n        measurePromiseArray.push(r.getPageLayoutBoxAsync());\n      }\n    });\n    return Promise.all(measurePromiseArray);\n  }).then(function () {\n    var resources = _services.Services.resourcesForDoc(ampdoc);\n\n    return resources.get().filter(function (r) {\n      return r.hostWin == hostWin && !r.hasOwner() && r.hasBeenMeasured() && filterFn(r);\n    });\n  });\n}\n\n},{\"./service/resources-interface\":103,\"./services\":123}],60:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installInputService = installInputService;\nexports.Input = void 0;\n\nvar _observable = require(\"./observable\");\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _eventHelper = require(\"./event-helper\");\n\nvar _service = require(\"./service\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG_ = 'Input';\nvar MAX_MOUSE_CONFIRM_ATTEMPS_ = 3;\nvar CLICK_TIMEOUT_ = 300;\n/**\n * Detects and maintains different types of input such as touch, mouse or\n * keyboard.\n */\n\nvar Input =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function Input(win) {\n    /** @const {!Window} */\n    this.win = win;\n    /** @private {!Function} */\n\n    this.boundOnKeyDown_ = this.onKeyDown_.bind(this);\n    /** @private {!Function} */\n\n    this.boundOnMouseDown_ = this.onMouseDown_.bind(this);\n    /** @private {?function(!Event)} */\n\n    this.boundOnMouseMove_ = null;\n    /** @private {?Function} */\n\n    this.boundMouseCanceled_ = null;\n    /** @private {?Function} */\n\n    this.boundMouseConfirmed_ = null;\n    /** @private {boolean} */\n\n    this.hasTouch_ = 'ontouchstart' in win || win.navigator['maxTouchPoints'] !== undefined && win.navigator['maxTouchPoints'] > 0 || win['DocumentTouch'] !== undefined;\n    (0, _log.dev)().fine(TAG_, 'touch detected:', this.hasTouch_);\n    /** @private {boolean} */\n\n    this.keyboardActive_ = false;\n    this.win.document.addEventListener('keydown', this.boundOnKeyDown_);\n    this.win.document.addEventListener('mousedown', this.boundOnMouseDown_);\n    /** @private {boolean} */\n\n    this.hasMouse_ = true;\n    /** @private {number} */\n\n    this.mouseConfirmAttemptCount_ = 0;\n    /** @private {!Observable<boolean>} */\n\n    this.touchDetectedObservable_ = new _observable.Observable();\n    /** @private {!Observable<boolean>} */\n\n    this.mouseDetectedObservable_ = new _observable.Observable();\n    /** @private {!Observable<boolean>} */\n\n    this.keyboardStateObservable_ = new _observable.Observable(); // If touch available, temporarily set hasMouse to false and wait for\n    // mouse events.\n\n    if (this.hasTouch_) {\n      this.hasMouse_ = !this.hasTouch_;\n      this.boundOnMouseMove_ =\n      /** @type {function(!Event)} */\n      this.onMouseMove_.bind(this);\n      (0, _eventHelper.listenOnce)(win.document, 'mousemove', this.boundOnMouseMove_);\n    }\n  }\n  /**\n   * Whether the touch input has been detected.\n   * @return {boolean}\n   */\n\n\n  var _proto = Input.prototype;\n\n  _proto.isTouchDetected = function isTouchDetected() {\n    return this.hasTouch_;\n  }\n  /**\n   * Registers an event handle in case if the touch is detected.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onTouchDetected = function onTouchDetected(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isTouchDetected());\n    }\n\n    return this.touchDetectedObservable_.add(handler);\n  }\n  /**\n   * Whether the mouse input has been detected.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isMouseDetected = function isMouseDetected() {\n    return this.hasMouse_;\n  }\n  /**\n   * Registers an event handle in case if the mouse is detected.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onMouseDetected = function onMouseDetected(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isMouseDetected());\n    }\n\n    return this.mouseDetectedObservable_.add(handler);\n  }\n  /**\n   * Whether the keyboard input is currently active.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isKeyboardActive = function isKeyboardActive() {\n    return this.keyboardActive_;\n  }\n  /**\n   * Registers an event handle for changes in the keyboard input.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onKeyboardStateChanged = function onKeyboardStateChanged(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isKeyboardActive());\n    }\n\n    return this.keyboardStateObservable_.add(handler);\n  }\n  /**\n   * @param {!Event} e\n   * @private\n   */\n  ;\n\n  _proto.onKeyDown_ = function onKeyDown_(e) {\n    if (this.keyboardActive_) {\n      return;\n    }\n\n    if (e.defaultPrevented) {\n      return;\n    } // Ignore inputs.\n\n\n    var target = e.target;\n\n    if (target && (target.tagName == 'INPUT' || target.tagName == 'TEXTAREA' || target.tagName == 'SELECT' || target.tagName == 'OPTION' || target.hasAttribute('contenteditable'))) {\n      return;\n    }\n\n    this.keyboardActive_ = true;\n    this.keyboardStateObservable_.fire(true);\n    (0, _log.dev)().fine(TAG_, 'keyboard activated');\n  }\n  /** @private */\n  ;\n\n  _proto.onMouseDown_ = function onMouseDown_() {\n    if (!this.keyboardActive_) {\n      return;\n    }\n\n    this.keyboardActive_ = false;\n    this.keyboardStateObservable_.fire(false);\n    (0, _log.dev)().fine(TAG_, 'keyboard deactivated');\n  }\n  /**\n   * @param {!Event} e\n   * @return {!Promise|undefined}\n   * @private\n   */\n  ;\n\n  _proto.onMouseMove_ = function onMouseMove_(e) {\n    var _this = this;\n\n    // The event explicitly states that it's a result of a touch event.\n    if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) {\n      this.mouseCanceled_();\n      return undefined;\n    }\n\n    if (!this.boundMouseConfirmed_) {\n      this.boundMouseConfirmed_ = this.mouseConfirmed_.bind(this);\n      this.boundMouseCanceled_ = this.mouseCanceled_.bind(this);\n    } // If \"click\" arrives within a timeout time, this is most likely a\n    // touch/mouse emulation. Otherwise, if timeout exceeded, this looks\n    // like a legitimate mouse event.\n\n\n    var unlisten;\n    var listenPromise = (0, _eventHelper.listenOncePromise)(this.win.document, 'click',\n    /* capture */\n    undefined, function (unlistener) {\n      unlisten = unlistener;\n    });\n    return _services.Services.timerFor(this.win).timeoutPromise(CLICK_TIMEOUT_, listenPromise).then(this.boundMouseCanceled_, function () {\n      if (unlisten) {\n        unlisten();\n      }\n\n      _this.boundMouseConfirmed_();\n    });\n  }\n  /** @private */\n  ;\n\n  _proto.mouseConfirmed_ = function mouseConfirmed_() {\n    this.hasMouse_ = true;\n    this.mouseDetectedObservable_.fire(true);\n    (0, _log.dev)().fine(TAG_, 'mouse detected');\n  }\n  /** @private */\n  ;\n\n  _proto.mouseCanceled_ = function mouseCanceled_() {\n    // Repeat, if attempts allow.\n    this.mouseConfirmAttemptCount_++;\n\n    if (this.mouseConfirmAttemptCount_ <= MAX_MOUSE_CONFIRM_ATTEMPS_) {\n      (0, _eventHelper.listenOnce)(this.win.document, 'mousemove',\n      /** @type {function(!Event)} */\n      this.boundOnMouseMove_);\n    } else {\n      (0, _log.dev)().fine(TAG_, 'mouse detection failed');\n    }\n  };\n\n  return Input;\n}();\n/**\n * @param {!Window} win\n */\n\n\nexports.Input = Input;\n\nfunction installInputService(win) {\n  (0, _service.registerServiceBuilder)(win, 'input', Input);\n}\n\n},{\"./event-helper\":46,\"./log\":68,\"./observable\":71,\"./service\":79,\"./services\":123}],61:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.internalRuntimeVersion = internalRuntimeVersion;\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns the internal AMP runtime version. Note that this is not the RTV,\n * which is a prefix and the runtime version.\n *\n * The call sites for this function are replaced with a compile time constant\n * string.\n *\n * @return {string}\n */\nfunction internalRuntimeVersion() {\n  return '$internalRuntimeVersion$';\n}\n\n},{}],62:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getIntersectionChangeEntry = getIntersectionChangeEntry;\nexports.nativeIntersectionObserverSupported = nativeIntersectionObserverSupported;\nexports.intersectionRatio = intersectionRatio;\nexports.getThresholdSlot = getThresholdSlot;\nexports.IntersectionObserverPolyfill = exports.IntersectionObserverApi = exports.DEFAULT_THRESHOLD = exports.DOMRect = void 0;\n\nvar _pass = require(\"./pass\");\n\nvar _services = require(\"./services\");\n\nvar _iframeHelper = require(\"./iframe-helper\");\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object\");\n\nvar _types = require(\"./types\");\n\nvar _layoutRect = require(\"./layout-rect\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The structure that defines the rectangle used in intersection observers.\n *\n * @typedef {{\n *   top: number,\n *   bottom: number,\n *   left: number,\n *   right: number,\n *   width: number,\n *   height: number,\n *   x: number,\n *   y: number,\n * }}\n */\nvar DOMRect;\nexports.DOMRect = DOMRect;\nvar DEFAULT_THRESHOLD = [0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1];\n/** @typedef {{\n *    element: !Element,\n *    currentThresholdSlot: number,\n *  }}\n */\n\nexports.DEFAULT_THRESHOLD = DEFAULT_THRESHOLD;\nvar ElementIntersectionStateDef;\n/** @const @private */\n\nvar TAG = 'INTERSECTION-OBSERVER';\n/** @const @private */\n\nvar INIT_TIME = Date.now();\n/**\n * A function to get the element's current IntersectionObserverEntry\n * regardless of the intersetion ratio. Only available when element is not\n * nested in a container iframe.\n * TODO: support opt_iframe if there's valid use cases.\n * @param {!./layout-rect.LayoutRectDef} element element's rect\n * @param {?./layout-rect.LayoutRectDef} owner element's owner rect\n * @param {!./layout-rect.LayoutRectDef} hostViewport hostViewport's rect\n * @return {!IntersectionObserverEntry} A change entry.\n */\n\nfunction getIntersectionChangeEntry(element, owner, hostViewport) {\n  var intersection = (0, _layoutRect.rectIntersection)(element, owner, hostViewport) || (0, _layoutRect.layoutRectLtwh)(0, 0, 0, 0);\n  var ratio = intersectionRatio(intersection, element);\n  return calculateChangeEntry(element, hostViewport, intersection, ratio);\n}\n/**\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nfunction nativeIntersectionObserverSupported(win) {\n  return 'IntersectionObserver' in win && 'IntersectionObserverEntry' in win && 'intersectionRatio' in win.IntersectionObserverEntry.prototype;\n}\n/**\n * A class to help amp-iframe and amp-ad nested iframe listen to intersection\n * change.\n */\n\n\nvar IntersectionObserverApi =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!AMP.BaseElement} baseElement\n   * @param {!Element} iframe\n   * @param {boolean=} opt_is3p\n   */\n  function IntersectionObserverApi(baseElement, iframe, opt_is3p) {\n    var _this = this;\n\n    /** @private @const {!AMP.BaseElement} */\n    this.baseElement_ = baseElement;\n    /** @private {?IntersectionObserverPolyfill} */\n\n    this.intersectionObserver_ = null;\n    /** @private {boolean} */\n\n    this.shouldObserve_ = false;\n    /** @private {boolean} */\n\n    this.isInViewport_ = false;\n    /** @private {?function()} */\n\n    this.unlistenOnDestroy_ = null;\n    /** @private {!./service/viewport/viewport-interface.ViewportInterface} */\n\n    this.viewport_ = baseElement.getViewport();\n    /** @private {?SubscriptionApi} */\n\n    this.subscriptionApi_ = new _iframeHelper.SubscriptionApi(iframe, 'send-intersections', opt_is3p || false, function () {\n      _this.startSendingIntersection_();\n    });\n    this.intersectionObserver_ = new IntersectionObserverPolyfill(function (entries) {\n      // Remove target info from cross origin iframe.\n      for (var i = 0; i < entries.length; i++) {\n        delete entries[i]['target'];\n      }\n\n      _this.subscriptionApi_.send('intersection', (0, _object.dict)({\n        'changes': entries\n      }));\n    }, {\n      threshold: DEFAULT_THRESHOLD\n    });\n    this.intersectionObserver_.tick(this.viewport_.getRect());\n    /** @const {function()} */\n\n    this.fire = function () {\n      if (!_this.shouldObserve_ || !_this.isInViewport_) {\n        return;\n      }\n\n      _this.intersectionObserver_.tick(_this.viewport_.getRect());\n    };\n  }\n  /**\n   * Function to start listening to viewport event. and observer intersection\n   * change on the element.\n   */\n\n\n  var _proto = IntersectionObserverApi.prototype;\n\n  _proto.startSendingIntersection_ = function startSendingIntersection_() {\n    var _this2 = this;\n\n    this.shouldObserve_ = true;\n    this.intersectionObserver_.observe(this.baseElement_.element);\n    this.baseElement_.getVsync().measure(function () {\n      _this2.isInViewport_ = _this2.baseElement_.isInViewport();\n\n      _this2.fire();\n    });\n    var unlistenViewportScroll = this.viewport_.onScroll(this.fire);\n    var unlistenViewportChange = this.viewport_.onChanged(this.fire);\n\n    this.unlistenOnDestroy_ = function () {\n      unlistenViewportScroll();\n      unlistenViewportChange();\n    };\n  }\n  /**\n   * Enable to the PositionObserver to listen to viewport events\n   * @param {boolean} inViewport\n   */\n  ;\n\n  _proto.onViewportCallback = function onViewportCallback(inViewport) {\n    this.isInViewport_ = inViewport;\n  }\n  /**\n   * Clean all listenrs\n   */\n  ;\n\n  _proto.destroy = function destroy() {\n    this.shouldObserve_ = false;\n    this.intersectionObserver_.disconnect();\n    this.intersectionObserver_ = null;\n\n    if (this.unlistenOnDestroy_) {\n      this.unlistenOnDestroy_();\n      this.unlistenOnDestroy_ = null;\n    }\n\n    this.subscriptionApi_.destroy();\n    this.subscriptionApi_ = null;\n  };\n\n  return IntersectionObserverApi;\n}();\n/**\n * The IntersectionObserverPolyfill class lets any element receive its\n * intersection data with the viewport. It acts like native browser supported\n * IntersectionObserver.\n * The IntersectionObserver receives a callback function and an optional option\n * as params. Whenever the element intersection ratio cross a threshold value,\n * IntersectionObserverPolyfill will call the provided callback function with\n * the change entry. Only Works with one document for now.\n * @visibleForTesting\n */\n\n\nexports.IntersectionObserverApi = IntersectionObserverApi;\n\nvar IntersectionObserverPolyfill =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {function(!Array<!IntersectionObserverEntry>)} callback\n   * @param {Object=} opt_option\n   */\n  function IntersectionObserverPolyfill(callback, opt_option) {\n    /** @private @const {function(!Array<!IntersectionObserverEntry>)} */\n    this.callback_ = callback; // The input threshold can be a number or an array of numbers.\n\n    var threshold = opt_option && opt_option.threshold;\n\n    if (threshold) {\n      threshold = (0, _types.isArray)(threshold) ? threshold : [threshold];\n    } else {\n      threshold = [0];\n    }\n\n    for (var i = 0; i < threshold.length; i++) {\n      (0, _log.devAssert)((0, _types.isFiniteNumber)(threshold[i]), 'Threshold should be a finite number or an array of finite numbers');\n    }\n    /**\n     * A list of threshold, sorted in increasing numeric order\n     * @private @const {!Array}\n     */\n\n\n    this.threshold_ = threshold.sort();\n    (0, _log.devAssert)(this.threshold_[0] >= 0 && this.threshold_[this.threshold_.length - 1] <= 1, 'Threshold should be in the range from \"[0, 1]\"');\n    /** @private {?./layout-rect.LayoutRectDef} */\n\n    this.lastViewportRect_ = null;\n    /** @private {./layout-rect.LayoutRectDef|undefined} */\n\n    this.lastIframeRect_ = undefined;\n    /**\n     * Store a list of observed elements and their current threshold slot which\n     * their intersection ratio fills, range from [0, this.threshold_.length]\n     * @private {Array<!ElementIntersectionStateDef>}\n     */\n\n    this.observeEntries_ = [];\n    /**\n     * Mutation observer to fire off on visibility changes\n     * @private {?function()}\n     */\n\n    this.hiddenObserverUnlistener_ = null;\n    /** @private {Pass} */\n\n    this.mutationPass_ = null;\n  }\n  /**\n   * Function to unobserve all elements.\n   * and clean up the polyfill.\n   */\n\n\n  var _proto2 = IntersectionObserverPolyfill.prototype;\n\n  _proto2.disconnect = function disconnect() {\n    this.observeEntries_.length = 0;\n    this.disconnectMutationObserver_();\n  }\n  /**\n   * Provide a way to observe the intersection change for a specific element\n   * Please note IntersectionObserverPolyfill only support AMP element now\n   * TODO: Support non AMP element\n   * @param {!Element} element\n   */\n  ;\n\n  _proto2.observe = function observe(element) {\n    // Check the element is an AMP element.\n    (0, _log.devAssert)(element.getLayoutBox); // If the element already exists in current observeEntries, do nothing\n\n    for (var i = 0; i < this.observeEntries_.length; i++) {\n      if (this.observeEntries_[i].element === element) {\n        (0, _log.dev)().warn(TAG, 'should observe same element once');\n        return;\n      }\n    }\n\n    var newState = {\n      element: element,\n      currentThresholdSlot: 0\n    }; // Get the new observed element's first changeEntry based on last viewport\n\n    if (this.lastViewportRect_) {\n      var change = this.getValidIntersectionChangeEntry_(newState, this.lastViewportRect_, this.lastIframeRect_);\n\n      if (change) {\n        this.callback_([change]);\n      }\n    } // Add a mutation observer to tick ourself\n    // TODO (@torch2424): Allow this to observe elements,\n    // from multiple documents.\n\n\n    var ampdoc = _services.Services.ampdoc(element);\n\n    if (ampdoc.win.MutationObserver && !this.hiddenObserverUnlistener_) {\n      this.mutationPass_ = new _pass.Pass(ampdoc.win, this.handleMutationObserverPass_.bind(this, element));\n\n      var hiddenObserver = _services.Services.hiddenObserverForDoc(element);\n\n      this.hiddenObserverUnlistener_ = hiddenObserver.add(this.handleMutationObserverNotification_.bind(this));\n    } // push new observed element\n\n\n    this.observeEntries_.push(newState);\n  }\n  /**\n   * Provide a way to unobserve intersection change for a specified element\n   * @param {!Element} element\n   */\n  ;\n\n  _proto2.unobserve = function unobserve(element) {\n    // find the unobserved element in observeEntries\n    for (var i = 0; i < this.observeEntries_.length; i++) {\n      if (this.observeEntries_[i].element === element) {\n        this.observeEntries_.splice(i, 1);\n\n        if (this.observeEntries_.length <= 0) {\n          this.disconnectMutationObserver_();\n        }\n\n        return;\n      }\n    }\n\n    (0, _log.dev)().warn(TAG, 'unobserve non-observed element');\n  }\n  /**\n   * Tick function that update the DOMRect of the root of observed elements.\n   * Caller needs to make sure to pass in the correct container.\n   * Note: the opt_iframe param is the iframe position relative to the host doc,\n   * The iframe must be a non-scrollable iframe.\n   * @param {!./layout-rect.LayoutRectDef} hostViewport\n   * @param {./layout-rect.LayoutRectDef=} opt_iframe\n   */\n  ;\n\n  _proto2.tick = function tick(hostViewport, opt_iframe) {\n    if (opt_iframe) {\n      // If element inside an iframe. Adjust origin to the iframe.left/top.\n      hostViewport = (0, _layoutRect.moveLayoutRect)(hostViewport, -opt_iframe.left, -opt_iframe.top);\n      opt_iframe = (0, _layoutRect.moveLayoutRect)(opt_iframe, -opt_iframe.left, -opt_iframe.top);\n    }\n\n    this.lastViewportRect_ = hostViewport;\n    this.lastIframeRect_ = opt_iframe;\n    var changes = [];\n\n    for (var i = 0; i < this.observeEntries_.length; i++) {\n      var change = this.getValidIntersectionChangeEntry_(this.observeEntries_[i], hostViewport, opt_iframe);\n\n      if (change) {\n        changes.push(change);\n      }\n    }\n\n    if (changes.length) {\n      this.callback_(changes);\n    }\n  }\n  /**\n   * Return a change entry for one element that should be compatible with\n   * IntersectionObserverEntry if it's valid with current config.\n   * When the new intersection ratio doesn't cross one of a threshold value,\n   * the function will return null.\n   *\n   * @param {!ElementIntersectionStateDef} state\n   * @param {!./layout-rect.LayoutRectDef} hostViewport hostViewport's rect\n   * @param {./layout-rect.LayoutRectDef=} opt_iframe iframe container rect\n   *    If opt_iframe is provided, all LayoutRect has position relative to\n   *    the iframe. If opt_iframe is not provided,\n   *    all LayoutRect has position relative to the host document.\n   * @return {?IntersectionObserverEntry} A valid change entry or null if ratio\n   * @private\n   */\n  ;\n\n  _proto2.getValidIntersectionChangeEntry_ = function getValidIntersectionChangeEntry_(state, hostViewport, opt_iframe) {\n    var element = state.element;\n    var elementRect = element.getLayoutBox();\n    var owner = element.getOwner();\n    var ownerRect = owner && owner.getLayoutBox(); // calculate intersectionRect. that the element intersects with hostViewport\n    // and intersects with owner element and container iframe if exists.\n\n    var intersectionRect = (0, _layoutRect.rectIntersection)(elementRect, ownerRect, hostViewport, opt_iframe) || (0, _layoutRect.layoutRectLtwh)(0, 0, 0, 0); // calculate ratio, call callback based on new ratio value.\n\n    var ratio = intersectionRatio(intersectionRect, elementRect);\n    var newThresholdSlot = getThresholdSlot(this.threshold_, ratio);\n\n    if (newThresholdSlot == state.currentThresholdSlot) {\n      return null;\n    }\n\n    state.currentThresholdSlot = newThresholdSlot; // To get same behavior as native IntersectionObserver set hostViewport null\n    // if inside an iframe\n\n    var changeEntry = calculateChangeEntry(elementRect, opt_iframe ? null : hostViewport, intersectionRect, ratio);\n    changeEntry.target = element;\n    return changeEntry;\n  }\n  /**\n   * Handle Mutation Oberserver events\n   * @private\n   */\n  ;\n\n  _proto2.handleMutationObserverNotification_ = function handleMutationObserverNotification_() {\n    if (this.mutationPass_.isPending()) {\n      return;\n    } // Wait one animation frame so that other mutations may arrive.\n\n\n    this.mutationPass_.schedule(16);\n  }\n  /**\n   * Handle Mutation Observer Pass\n   * This performas the tick, and is wrapped in a paas\n   * To handle throttling of the observer\n   * @param {!Element} element\n   * @private\n   */\n  ;\n\n  _proto2.handleMutationObserverPass_ = function handleMutationObserverPass_(element) {\n    var _this3 = this;\n\n    var viewport = _services.Services.viewportForDoc(element);\n\n    var resources = _services.Services.resourcesForDoc(element);\n\n    resources.onNextPass(function () {\n      _this3.tick(viewport.getRect());\n    });\n  }\n  /**\n   * Clean up the mutation observer\n   * @private\n   */\n  ;\n\n  _proto2.disconnectMutationObserver_ = function disconnectMutationObserver_() {\n    if (this.hiddenObserverUnlistener_) {\n      this.hiddenObserverUnlistener_();\n    }\n\n    this.hiddenObserverUnlistener_ = null;\n\n    if (this.mutationPass_) {\n      this.mutationPass_.cancel();\n    }\n\n    this.mutationPass_ = null;\n  };\n\n  return IntersectionObserverPolyfill;\n}();\n/**\n * Returns the ratio of the smaller box's area to the larger box's area.\n * @param {!./layout-rect.LayoutRectDef} smaller\n * @param {!./layout-rect.LayoutRectDef} larger\n * @return {number}\n * @visibleForTesting\n */\n\n\nexports.IntersectionObserverPolyfill = IntersectionObserverPolyfill;\n\nfunction intersectionRatio(smaller, larger) {\n  var smallerBoxArea = smaller.width * smaller.height;\n  var largerBoxArea = larger.width * larger.height; // Check for a divide by zero\n\n  return largerBoxArea === 0 ? 0 : smallerBoxArea / largerBoxArea;\n}\n/**\n * Returns the slot number that the current ratio fills in.\n * @param {!Array} sortedThreshold valid sorted IoB threshold\n * @param {number} ratio Range from [0, 1]\n * @return {number} Range from [0, threshold.length]\n * @visibleForTesting\n */\n\n\nfunction getThresholdSlot(sortedThreshold, ratio) {\n  var startIdx = 0;\n  var endIdx = sortedThreshold.length; // 0 is a special case that does not fit into [small, large) range\n\n  if (ratio == 0) {\n    return 0;\n  }\n\n  var mid = (startIdx + endIdx) / 2 | 0;\n\n  while (startIdx < mid) {\n    var midValue = sortedThreshold[mid]; // In the range of [small, large)\n\n    if (ratio < midValue) {\n      endIdx = mid;\n    } else {\n      startIdx = mid;\n    }\n\n    mid = (startIdx + endIdx) / 2 | 0;\n  }\n\n  return endIdx;\n}\n/**\n * Helper function to calculate the IntersectionObserver change entry.\n * @param {!./layout-rect.LayoutRectDef} element element's rect\n * @param {?./layout-rect.LayoutRectDef} hostViewport hostViewport's rect\n * @param {!./layout-rect.LayoutRectDef} intersection\n * @param {number} ratio\n * @return {!IntersectionObserverEntry}}\n */\n\n\nfunction calculateChangeEntry(element, hostViewport, intersection, ratio) {\n  // If element not in an iframe.\n  // adjust all LayoutRect to hostViewport Origin.\n  var boundingClientRect = element;\n  var rootBounds = hostViewport; // If no hostViewport is provided, element is inside an non-scrollable iframe.\n  // Every Layoutrect has already adjust their origin according to iframe\n  // rect origin. LayoutRect position is relative to iframe origin,\n  // thus relative to iframe's viewport origin because the viewport is at the\n  // iframe origin. No need to adjust position here.\n\n  if (hostViewport) {\n    // If element not in an iframe.\n    // adjust all LayoutRect to hostViewport Origin.\n    rootBounds =\n    /** @type {!./layout-rect.LayoutRectDef} */\n    rootBounds;\n    intersection = (0, _layoutRect.moveLayoutRect)(intersection, -hostViewport.left, -hostViewport.top); // The element is relative to (0, 0), while the viewport moves. So, we must\n    // adjust.\n\n    boundingClientRect = (0, _layoutRect.moveLayoutRect)(boundingClientRect, -hostViewport.left, -hostViewport.top); // Now, move the viewport to (0, 0)\n\n    rootBounds = (0, _layoutRect.moveLayoutRect)(rootBounds, -hostViewport.left, -hostViewport.top);\n  }\n\n  return (\n    /** @type {!IntersectionObserverEntry} */\n    {\n      time: typeof performance !== 'undefined' && performance.now ? performance.now() : Date.now() - INIT_TIME,\n      rootBounds: rootBounds,\n      boundingClientRect: boundingClientRect,\n      intersectionRect: intersection,\n      intersectionRatio: ratio\n    }\n  );\n}\n\n},{\"./iframe-helper\":57,\"./layout-rect\":65,\"./log\":68,\"./pass\":72,\"./services\":123,\"./types\":131,\"./utils/object\":145}],63:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.recreateNonProtoObject = recreateNonProtoObject;\nexports.getValueForExpr = getValueForExpr;\nexports.parseJson = parseJson;\nexports.tryParseJson = tryParseJson;\nexports.getChildJsonConfig = getChildJsonConfig;\nexports.deepEquals = deepEquals;\nexports.jsonConfiguration = jsonConfiguration;\nexports.jsonLiteral = jsonLiteral;\nexports.includeJsonLiteral = includeJsonLiteral;\n\nvar _dom = require(\"./dom\");\n\nvar _types = require(\"./types\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n// NOTE Type are changed to {*} because of\n// https://github.com/google/closure-compiler/issues/1999\n\n/**\n * JSON scalar. It's either string, number or boolean.\n * @typedef {*} should be string|number|boolean|null\n */\nvar JSONScalarDef;\n/**\n * JSON object. It's a map with string keys and JSON values.\n * @typedef {*} should be !Object<string, ?JSONValueDef>\n */\n\nvar JSONObjectDef;\n/**\n * JSON array. It's an array with JSON values.\n * @typedef {*} should be !Array<?JSONValueDef>\n */\n\nvar JSONArrayDef;\n/**\n * JSON value. It's either a scalar, an object or an array.\n * @typedef {*} should be !JSONScalarDef|!JSONObjectDef|!JSONArrayDef\n */\n\nvar JSONValueDef;\n/**\n * Recreates objects with prototype-less copies.\n * @param {!JsonObject} obj\n * @return {!JsonObject}\n */\n\nfunction recreateNonProtoObject(obj) {\n  var copy = Object.create(null);\n\n  for (var k in obj) {\n    if (!hasOwnProperty(obj, k)) {\n      continue;\n    }\n\n    var v = obj[k];\n    copy[k] = (0, _types.isObject)(v) ? recreateNonProtoObject(v) : v;\n  }\n\n  return (\n    /** @type {!JsonObject} */\n    copy\n  );\n}\n/**\n * Returns a value from an object for a field-based expression. The expression\n * is a simple nested dot-notation of fields, such as `field1.field2`. If any\n * field in a chain does not exist or is not an object or array, the returned\n * value will be `undefined`.\n *\n * @param {!JsonObject} obj\n * @param {string} expr\n * @return {*}\n */\n\n\nfunction getValueForExpr(obj, expr) {\n  // The `.` indicates \"the object itself\".\n  if (expr == '.') {\n    return obj;\n  } // Otherwise, navigate via properties.\n\n\n  var parts = expr.split('.');\n  var value = obj;\n\n  for (var i = 0; i < parts.length; i++) {\n    var part = parts[i];\n\n    if (part && value && value[part] !== undefined && hasOwnProperty(value, part)) {\n      value = value[part];\n      continue;\n    }\n\n    value = undefined;\n    break;\n  }\n\n  return value;\n}\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {*} json JSON string to parse\n * @return {?JsonObject} May be extend to parse arrays.\n */\n\n\nfunction parseJson(json) {\n  return (\n    /** @type {?JsonObject} */\n    JSON.parse(\n    /** @type {string} */\n    json)\n  );\n}\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {*} json JSON string to parse\n * @param {function(!Error)=} opt_onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject} May be extend to parse arrays.\n */\n\n\nfunction tryParseJson(json, opt_onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    if (opt_onFailed) {\n      opt_onFailed(e);\n    }\n\n    return null;\n  }\n}\n/**\n * Helper method to get the json config from an element <script> tag\n * @param {!Element} element\n * @return {?JsonObject}\n * @throws {!Error} If element does not have exactly one <script> child\n * with type=\"application/json\", or if the <script> contents are not valid JSON.\n */\n\n\nfunction getChildJsonConfig(element) {\n  var scripts = (0, _dom.childElementsByTag)(element, 'script');\n  var n = scripts.length;\n\n  if (n !== 1) {\n    throw new Error(\"Found \" + scripts.length + \" <script> children. Expected 1.\");\n  }\n\n  var script = scripts[0];\n\n  if (!(0, _dom.isJsonScriptTag)(script)) {\n    throw new Error('<script> child must have type=\"application/json\"');\n  }\n\n  try {\n    return parseJson(script.textContent);\n  } catch (unusedError) {\n    throw new Error('Failed to parse <script> contents. Is it valid JSON?');\n  }\n}\n/**\n * Deeply checks strict equality of items in nested arrays and objects.\n *\n * @param {JSONValueDef} a\n * @param {JSONValueDef} b\n * @param {number} depth The maximum depth. Must be finite.\n * @return {boolean}\n * @throws {Error} If depth argument is not finite.\n */\n\n\nfunction deepEquals(a, b, depth) {\n  if (depth === void 0) {\n    depth = 5;\n  }\n\n  if (!isFinite(depth) || depth < 0) {\n    throw new Error('Invalid depth: ' + depth);\n  }\n\n  if (a === b) {\n    return true;\n  }\n  /** @type {!Array<{a: JSONValueDef, b: JSONValueDef, depth: number}>} */\n\n\n  var queue = [{\n    a: a,\n    b: b,\n    depth: depth\n  }];\n\n  while (queue.length > 0) {\n    var _queue$shift = queue.shift(),\n        _a = _queue$shift.a,\n        _b = _queue$shift.b,\n        _depth = _queue$shift.depth; // Only check deep equality if depth > 0.\n\n\n    if (_depth > 0) {\n      if (typeof _a !== typeof _b) {\n        return false;\n      } else if (Array.isArray(_a) && Array.isArray(_b)) {\n        if (_a.length !== _b.length) {\n          return false;\n        }\n\n        for (var i = 0; i < _a.length; i++) {\n          queue.push({\n            a: _a[i],\n            b: _b[i],\n            depth: _depth - 1\n          });\n        }\n\n        continue;\n      } else if (_a && _b && typeof _a === 'object' && typeof _b === 'object') {\n        var keysA = Object.keys(\n        /** @type {!Object} */\n        _a);\n        var keysB = Object.keys(\n        /** @type {!Object} */\n        _b);\n\n        if (keysA.length !== keysB.length) {\n          return false;\n        }\n\n        for (var _i = 0; _i < keysA.length; _i++) {\n          var k = keysA[_i];\n          queue.push({\n            a: _a[k],\n            b: _b[k],\n            depth: _depth - 1\n          });\n        }\n\n        continue;\n      }\n    } // If we get here, then depth == 0 or (a, b) are primitives.\n\n\n    if (_a !== _b) {\n      return false;\n    }\n  }\n\n  return true;\n}\n/**\n * @param {*} obj\n * @param {string} key\n * @return {boolean}\n */\n\n\nfunction hasOwnProperty(obj, key) {\n  if (obj == null || typeof obj != 'object') {\n    return false;\n  }\n\n  return Object.prototype.hasOwnProperty.call(\n  /** @type {!Object} */\n  obj, key);\n}\n/**\n * This helper function handles configurations specified in a JSON format.\n *\n * It allows the configuration is to be written in plain JS (which has better\n * dev ergonomics like comments and trailing commas), and allows the\n * configuration to be transformed into an efficient JSON-parsed representation\n * in the dist build. See https://v8.dev/blog/cost-of-javascript-2019#json\n *\n * @param {!Object} obj\n * @return {!JsonObject}\n */\n\n\nfunction jsonConfiguration(obj) {\n  return (\n    /** @type {!JsonObject} */\n    obj\n  );\n}\n/**\n * This converts an Object into a suitable type to be used in `includeJsonLiteral`.\n * This doesn't actually do any conversion, it only changes the closure type.\n *\n * @param {!Object|!Array|string|number|boolean|null} value\n * @return {!InternalJsonLiteralTypeDef}\n */\n\n\nfunction jsonLiteral(value) {\n  return (\n    /** @type {!InternalJsonLiteralTypeDef} */\n    value\n  );\n}\n/**\n * Allows inclusion of a variable (that's wrapped in a jsonLiteral\n * call) to be included inside a jsonConfiguration.\n *\n * @param {!InternalJsonLiteralTypeDef} value\n * @return {*}\n */\n\n\nfunction includeJsonLiteral(value) {\n  return value;\n}\n\n},{\"./dom\":41,\"./types\":131}],64:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.LayoutDelayMeter = void 0;\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar LABEL_MAP = {\n  0: 'cld',\n  2: 'adld'\n};\n/**\n * Measures the time latency between \"first time in viewport\" and\n * \"start to layout\" of an element.\n */\n\nvar LayoutDelayMeter =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   * @param {number} priority\n   */\n  function LayoutDelayMeter(win, priority) {\n    /** @private {!Window} */\n    this.win_ = win;\n    /** @private {?./service/performance-impl.Performance} */\n\n    this.performance_ = _services.Services.performanceForOrNull(win);\n    /** @private {?number} */\n\n    this.firstInViewportTime_ = null;\n    /** @private {?number} */\n\n    this.firstLayoutTime_ = null;\n    /** @private {boolean} */\n\n    this.done_ = false;\n    /** @private {?string} */\n\n    this.label_ = LABEL_MAP[priority];\n  }\n  /**\n   *\n   */\n\n\n  var _proto = LayoutDelayMeter.prototype;\n\n  _proto.enterViewport = function enterViewport() {\n    if (!this.label_ || this.firstInViewportTime_) {\n      return;\n    }\n\n    this.firstInViewportTime_ = this.win_.Date.now();\n    this.tryMeasureDelay_();\n  }\n  /**\n   * starts layout\n   */\n  ;\n\n  _proto.startLayout = function startLayout() {\n    if (!this.label_ || this.firstLayoutTime_) {\n      return;\n    }\n\n    this.firstLayoutTime_ = this.win_.Date.now();\n    this.tryMeasureDelay_();\n  }\n  /**\n   * Tries to measure delay\n   */\n  ;\n\n  _proto.tryMeasureDelay_ = function tryMeasureDelay_() {\n    if (!this.performance_ || !this.performance_.isPerformanceTrackingOn()) {\n      return;\n    }\n\n    if (this.done_) {\n      // Already measured.\n      return;\n    }\n\n    if (!this.firstInViewportTime_ || !this.firstLayoutTime_) {\n      // Not ready yet.\n      return;\n    }\n\n    var delay = this.win_.Math.max(this.firstLayoutTime_ - this.firstInViewportTime_, 0);\n    this.performance_.tickDelta((0, _log.dev)().assertString(this.label_), delay);\n    this.performance_.throttledFlush();\n    this.done_ = true;\n  };\n\n  return LayoutDelayMeter;\n}();\n\nexports.LayoutDelayMeter = LayoutDelayMeter;\n\n},{\"./log\":68,\"./services\":123}],65:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.layoutRectLtwh = layoutRectLtwh;\nexports.layoutRectFromDomRect = layoutRectFromDomRect;\nexports.layoutRectsOverlap = layoutRectsOverlap;\nexports.rectIntersection = rectIntersection;\nexports.layoutRectsRelativePos = layoutRectsRelativePos;\nexports.layoutPositionRelativeToScrolledViewport = layoutPositionRelativeToScrolledViewport;\nexports.expandLayoutRect = expandLayoutRect;\nexports.moveLayoutRect = moveLayoutRect;\nexports.areMarginsChanged = areMarginsChanged;\nexports.layoutRectSizeEquals = layoutRectSizeEquals;\nexports.layoutRectEquals = layoutRectEquals;\nexports.cloneLayoutMarginsChangeDef = cloneLayoutMarginsChangeDef;\nexports.RelativePositions = exports.LayoutMarginsChangeDef = exports.LayoutMarginsDef = exports.LayoutRectDef = void 0;\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The structure that combines position and size for an element. The exact\n * interpretation of position and size depends on the use case.\n *\n * @typedef {{\n *   top: number,\n *   bottom: number,\n *   left: number,\n *   right: number,\n *   width: number,\n *   height: number,\n *   x: number,\n *   y: number\n * }}\n */\nvar LayoutRectDef;\n/**\n * The structure that represents the margins of an Element.\n *\n * @typedef {{\n *   top: number,\n *   right: number,\n *   bottom: number,\n *   left: number\n * }}\n */\n\nexports.LayoutRectDef = LayoutRectDef;\nvar LayoutMarginsDef;\n/**\n * The structure that represents a requested change to the margins of an\n * Element. Any new values specified will replace existing ones (rather than\n * being additive).\n *\n * @typedef {{\n *   top: (number|undefined),\n *   right: (number|undefined),\n *   bottom: (number|undefined),\n *   left: (number|undefined)\n * }}\n */\n\nexports.LayoutMarginsDef = LayoutMarginsDef;\nvar LayoutMarginsChangeDef;\n/**\n * RelativePositions\n *\n * Describes the relative position of an element to another (whether the\n * first is inside the second, on top of the second or on the bottom\n * @enum {string}\n */\n\nexports.LayoutMarginsChangeDef = LayoutMarginsChangeDef;\nvar RelativePositions = {\n  INSIDE: 'inside',\n  TOP: 'top',\n  BOTTOM: 'bottom'\n};\n/**\n * Creates a layout rect based on the left, top, width and height parameters\n * in that order.\n * @param {number} left\n * @param {number} top\n * @param {number} width\n * @param {number} height\n * @return {!LayoutRectDef}\n */\n\nexports.RelativePositions = RelativePositions;\n\nfunction layoutRectLtwh(left, top, width, height) {\n  return {\n    left: left,\n    top: top,\n    width: width,\n    height: height,\n    bottom: top + height,\n    right: left + width,\n    x: left,\n    y: top\n  };\n}\n/**\n * Creates a layout rect based on the DOMRect, e.g. obtained from calling\n * getBoundingClientRect.\n * @param {!ClientRect} rect\n * @return {!LayoutRectDef}\n */\n\n\nfunction layoutRectFromDomRect(rect) {\n  return layoutRectLtwh(Number(rect.left), Number(rect.top), Number(rect.width), Number(rect.height));\n}\n/**\n * Returns true if the specified two rects overlap by a single pixel.\n * @param {!LayoutRectDef} r1\n * @param {!LayoutRectDef} r2\n * @return {boolean}\n */\n\n\nfunction layoutRectsOverlap(r1, r2) {\n  return r1.top <= r2.bottom && r2.top <= r1.bottom && r1.left <= r2.right && r2.left <= r1.right;\n}\n/**\n * Returns the intersection between a, b or null if there is none.\n * @param {...?LayoutRectDef|undefined} var_args\n * @return {?LayoutRectDef}\n */\n\n\nfunction rectIntersection(var_args) {\n  var x0 = -Infinity;\n  var x1 = Infinity;\n  var y0 = -Infinity;\n  var y1 = Infinity;\n\n  for (var i = 0; i < arguments.length; i++) {\n    var current = arguments[i];\n\n    if (!current) {\n      continue;\n    }\n\n    x0 = Math.max(x0, current.left);\n    x1 = Math.min(x1, current.left + current.width);\n    y0 = Math.max(y0, current.top);\n    y1 = Math.min(y1, current.top + current.height);\n\n    if (x1 < x0 || y1 < y0) {\n      return null;\n    }\n  }\n\n  if (x1 == Infinity) {\n    return null;\n  }\n\n  return layoutRectLtwh(x0, y0, x1 - x0, y1 - y0);\n}\n/**\n * Returns the position of r2 relative to r1\n * @param {!LayoutRectDef} r1\n * @param {!LayoutRectDef} r2\n * @return {RelativePositions}\n */\n\n\nfunction layoutRectsRelativePos(r1, r2) {\n  if (r1.top < r2.top) {\n    return RelativePositions.TOP;\n  } else if (r1.bottom > r2.bottom) {\n    return RelativePositions.BOTTOM;\n  } else {\n    return RelativePositions.INSIDE;\n  }\n}\n/**\n * Determines if any portion of a layoutBox would be onscreen in the given\n * viewport, when scrolled to the specified position.\n * @param {!LayoutRectDef} layoutBox\n * @param {!./service/viewport/viewport-interface.ViewportInterface} viewport\n * @param {number} scrollPos\n * @return {RelativePositions}\n */\n\n\nfunction layoutPositionRelativeToScrolledViewport(layoutBox, viewport, scrollPos) {\n  var scrollLayoutBox = layoutRectFromDomRect(\n  /** @type {!ClientRect} */\n  {\n    top: scrollPos,\n    bottom: scrollPos + viewport.getHeight(),\n    left: 0,\n    right: viewport.getWidth()\n  });\n\n  if (layoutRectsOverlap(layoutBox, scrollLayoutBox)) {\n    return RelativePositions.INSIDE;\n  } else {\n    return layoutRectsRelativePos(layoutBox, scrollLayoutBox);\n  }\n}\n/**\n * Expand the layout rect using multiples of width and height.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dw Expansion in width, specified as a multiple of width.\n * @param {number} dh Expansion in height, specified as a multiple of height.\n * @return {!LayoutRectDef}\n */\n\n\nfunction expandLayoutRect(rect, dw, dh) {\n  return layoutRectLtwh(rect.left - rect.width * dw, rect.top - rect.height * dh, rect.width * (1 + dw * 2), rect.height * (1 + dh * 2));\n}\n/**\n * Moves the layout rect using dx and dy.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dx Move horizontally with this value.\n * @param {number} dy Move vertically with this value.\n * @return {!LayoutRectDef}\n */\n\n\nfunction moveLayoutRect(rect, dx, dy) {\n  if (dx == 0 && dy == 0 || rect.width == 0 && rect.height == 0) {\n    return rect;\n  }\n\n  return layoutRectLtwh(rect.left + dx, rect.top + dy, rect.width, rect.height);\n}\n/**\n * @param {!LayoutMarginsDef} margins\n * @param {!LayoutMarginsChangeDef} change\n * @return {boolean}\n */\n\n\nfunction areMarginsChanged(margins, change) {\n  return change.top !== undefined && change.top != margins.top || change.right !== undefined && change.right != margins.right || change.bottom !== undefined && change.bottom != margins.bottom || change.left !== undefined && change.left != margins.left;\n}\n/**\n * @param {!LayoutRectDef} from\n * @param {!LayoutRectDef} to\n * @return {boolean}\n */\n\n\nfunction layoutRectSizeEquals(from, to) {\n  return from.width == to.width && from.height === to.height;\n}\n/**\n * @param {?LayoutRectDef} r1\n * @param {?LayoutRectDef} r2\n * @return {boolean}\n */\n\n\nfunction layoutRectEquals(r1, r2) {\n  if (!r1 || !r2) {\n    return false;\n  }\n\n  return r1.left == r2.left && r1.top == r2.top && r1.width == r2.width && r1.height == r2.height;\n}\n/**\n * @param {LayoutMarginsChangeDef|undefined} marginsChange\n * @return {LayoutMarginsChangeDef|undefined}\n */\n\n\nfunction cloneLayoutMarginsChangeDef(marginsChange) {\n  if (!marginsChange) {\n    return marginsChange;\n  }\n\n  return {\n    top: marginsChange.top,\n    bottom: marginsChange.bottom,\n    left: marginsChange.left,\n    right: marginsChange.right\n  };\n}\n\n},{}],66:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.parseLayout = parseLayout;\nexports.getLayoutClass = getLayoutClass;\nexports.isLayoutSizeDefined = isLayoutSizeDefined;\nexports.isLayoutSizeFixed = isLayoutSizeFixed;\nexports.isInternalElement = isInternalElement;\nexports.parseLength = parseLength;\nexports.assertLength = assertLength;\nexports.assertLengthOrPercent = assertLengthOrPercent;\nexports.getLengthUnits = getLengthUnits;\nexports.getLengthNumeral = getLengthNumeral;\nexports.hasNaturalDimensions = hasNaturalDimensions;\nexports.getNaturalDimensions = getNaturalDimensions;\nexports.isLoadingAllowed = isLoadingAllowed;\nexports.isIframeVideoPlayerComponent = isIframeVideoPlayerComponent;\nexports.applyStaticLayout = applyStaticLayout;\nexports.LOADING_ELEMENTS_ = exports.naturalDimensions_ = exports.LengthDef = exports.LayoutPriority = exports.Layout = void 0;\n\nvar _log = require(\"./log\");\n\nvar _staticTemplate = require(\"./static-template\");\n\nvar _types = require(\"./types\");\n\nvar _style = require(\"./style\");\n\nvar _string = require(\"./string\");\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteralLoose([\"\\n      <i-amphtml-sizer class=\\\"i-amphtml-sizer\\\">\\n        <img alt=\\\"\\\" role=\\\"presentation\\\" aria-hidden=\\\"true\\\"\\n             class=\\\"i-amphtml-intrinsic-sizer\\\" />\\n      </i-amphtml-sizer>\"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _taggedTemplateLiteralLoose(strings, raw) { if (!raw) { raw = strings.slice(0); } strings.raw = raw; return strings; }\n\n/**\n * @enum {string}\n */\nvar Layout = {\n  NODISPLAY: 'nodisplay',\n  FIXED: 'fixed',\n  FIXED_HEIGHT: 'fixed-height',\n  RESPONSIVE: 'responsive',\n  CONTAINER: 'container',\n  FILL: 'fill',\n  FLEX_ITEM: 'flex-item',\n  FLUID: 'fluid',\n  INTRINSIC: 'intrinsic'\n};\n/**\n * Layout priorities to use with BaseElement#getLayoutPriority() and\n * BaseElement#updateLayoutPriority().\n * @enum {number}\n */\n\nexports.Layout = Layout;\nvar LayoutPriority = {\n  CONTENT: 0,\n  METADATA: 1,\n  ADS: 2,\n  BACKGROUND: 3\n};\n/**\n * CSS Length type. E.g. \"1px\" or \"20vh\".\n * @typedef {string}\n */\n\nexports.LayoutPriority = LayoutPriority;\nvar LengthDef;\n/**\n * @typedef {{\n *   width: string,\n *   height: string\n * }}\n */\n\nexports.LengthDef = LengthDef;\nvar DimensionsDef;\n/**\n * The set of elements with natural dimensions, that is, elements\n * which have a known dimension either based on their value specified here,\n * or, if the value is null, a dimension specific to the browser.\n * `hasNaturalDimensions` checks for membership in this set.\n * `getNaturalDimensions` determines the dimensions for an element in the\n *    set and caches it.\n * @type {!Object<string, ?DimensionsDef>}\n * @private  Visible for testing only!\n */\n\nvar naturalDimensions_ = {\n  'AMP-PIXEL': {\n    width: '0px',\n    height: '0px'\n  },\n  'AMP-ANALYTICS': {\n    width: '1px',\n    height: '1px'\n  },\n  // TODO(dvoytenko): audio should have width:auto.\n  'AMP-AUDIO': null,\n  'AMP-SOCIAL-SHARE': {\n    width: '60px',\n    height: '44px'\n  }\n};\n/**\n * Elements that the progress can be shown for. This set has to be externalized\n * since the element's implementation may not be downloaded yet.\n * This list does not include video players which are found via regex later.\n * @enum {boolean}\n * @private  Visible for testing only!\n */\n\nexports.naturalDimensions_ = naturalDimensions_;\nvar LOADING_ELEMENTS_ = {\n  'AMP-AD': true,\n  'AMP-ANIM': true,\n  'AMP-EMBED': true,\n  'AMP-FACEBOOK': true,\n  'AMP-FACEBOOK-COMMENTS': true,\n  'AMP-FACEBOOK-PAGE': true,\n  'AMP-GOOGLE-DOCUMENT-EMBED': true,\n  'AMP-IFRAME': true,\n  'AMP-IMG': true,\n  'AMP-INSTAGRAM': true,\n  'AMP-LIST': true,\n  'AMP-PINTEREST': true,\n  'AMP-PLAYBUZZ': true,\n  'AMP-TWITTER': true\n};\n/**\n * All video player components must either have a) \"video\" or b) \"player\" in\n * their name. A few components don't follow this convention for historical\n * reasons, so they are listed individually.\n * @private @const {!RegExp}\n */\n\nexports.LOADING_ELEMENTS_ = LOADING_ELEMENTS_;\nvar videoPlayerTagNameRe = /^amp\\-(video|.+player)|AMP-BRIGHTCOVE|AMP-DAILYMOTION|AMP-YOUTUBE|AMP-VIMEO|AMP-IMA-VIDEO/i;\n/**\n * @param {string} s\n * @return {Layout|undefined} Returns undefined in case of failure to parse\n *   the layout string.\n */\n\nfunction parseLayout(s) {\n  for (var k in Layout) {\n    if (Layout[k] == s) {\n      return Layout[k];\n    }\n  }\n\n  return undefined;\n}\n/**\n * @param {!Layout} layout\n * @return {string}\n */\n\n\nfunction getLayoutClass(layout) {\n  return 'i-amphtml-layout-' + layout;\n}\n/**\n * Whether an element with this layout inherently defines the size.\n * @param {!Layout} layout\n * @return {boolean}\n */\n\n\nfunction isLayoutSizeDefined(layout) {\n  return layout == Layout.FIXED || layout == Layout.FIXED_HEIGHT || layout == Layout.RESPONSIVE || layout == Layout.FILL || layout == Layout.FLEX_ITEM || layout == Layout.FLUID || layout == Layout.INTRINSIC;\n}\n/**\n * Whether an element with this layout has a fixed dimension.\n * @param {!Layout} layout\n * @return {boolean}\n */\n\n\nfunction isLayoutSizeFixed(layout) {\n  return layout == Layout.FIXED || layout == Layout.FIXED_HEIGHT;\n}\n/**\n * Whether the tag is an internal (service) AMP tag.\n * @param {!Node|string} tag\n * @return {boolean}\n */\n\n\nfunction isInternalElement(tag) {\n  var tagName = typeof tag == 'string' ? tag : tag.tagName;\n  return tagName && (0, _string.startsWith)(tagName.toLowerCase(), 'i-');\n}\n/**\n * Parses the CSS length value. If no units specified, the assumed value is\n * \"px\". Returns undefined in case of parsing error.\n * @param {string|undefined|null} s\n * @return {!LengthDef|undefined}\n */\n\n\nfunction parseLength(s) {\n  if (typeof s == 'number') {\n    return s + 'px';\n  }\n\n  if (!s) {\n    return undefined;\n  }\n\n  if (!/^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|cm|mm|q|in|pc|pt)?$/.test(s)) {\n    return undefined;\n  }\n\n  if (/^\\d+(\\.\\d+)?$/.test(s)) {\n    return s + 'px';\n  }\n\n  return s;\n}\n/**\n * Asserts that the supplied value is a non-percent CSS Length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {!LengthDef}\n * @closurePrimitive {asserts.matchesReturn}\n */\n\n\nfunction assertLength(length) {\n  (0, _log.userAssert)(/^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|cm|mm|q|in|pc|pt)$/.test(length), 'Invalid length value: %s', length);\n  return (\n    /** @type {!LengthDef} */\n    length\n  );\n}\n/**\n * Asserts that the supplied value is a CSS Length value\n * (including percent unit).\n * @param {!LengthDef|string} length\n * @return {!LengthDef}\n * @closurePrimitive {asserts.matchesReturn}\n */\n\n\nfunction assertLengthOrPercent(length) {\n  (0, _log.userAssert)(/^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|%)$/.test(length), 'Invalid length or percent value: %s', length);\n  return length;\n}\n/**\n * Returns units from the CSS length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {string}\n */\n\n\nfunction getLengthUnits(length) {\n  assertLength(length);\n  (0, _log.dev)().assertString(length);\n  var m = (0, _log.userAssert)(length.match(/[a-z]+/i), 'Failed to read units from %s', length);\n  return m[0];\n}\n/**\n * Returns the numeric value of a CSS length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {number|undefined}\n */\n\n\nfunction getLengthNumeral(length) {\n  var res = parseFloat(length);\n  return (0, _types.isFiniteNumber)(res) ? res : undefined;\n}\n/**\n * Determines whether the tagName is a known element that has natural dimensions\n * in our runtime or the browser.\n * @param {string} tagName The element tag name.\n * @return {boolean}\n */\n\n\nfunction hasNaturalDimensions(tagName) {\n  tagName = tagName.toUpperCase();\n  return naturalDimensions_[tagName] !== undefined;\n}\n/**\n * Determines the default dimensions for an element which could vary across\n * different browser implementations, like <audio> for instance.\n * This operation can only be completed for an element whitelisted by\n * `hasNaturalDimensions`.\n * @param {!Element} element\n * @return {DimensionsDef}\n */\n\n\nfunction getNaturalDimensions(element) {\n  var tagName = element.tagName.toUpperCase();\n  (0, _log.devAssert)(naturalDimensions_[tagName] !== undefined);\n\n  if (!naturalDimensions_[tagName]) {\n    var doc = element.ownerDocument;\n    var naturalTagName = tagName.replace(/^AMP\\-/, '');\n    var temp = doc.createElement(naturalTagName); // For audio, should no-op elsewhere.\n\n    temp.controls = true;\n    (0, _style.setStyles)(temp, {\n      position: 'absolute',\n      visibility: 'hidden'\n    });\n    doc.body.appendChild(temp);\n    naturalDimensions_[tagName] = {\n      width: (temp.\n      /*OK*/\n      offsetWidth || 1) + 'px',\n      height: (temp.\n      /*OK*/\n      offsetHeight || 1) + 'px'\n    };\n    doc.body.removeChild(temp);\n  }\n\n  return (\n    /** @type {DimensionsDef} */\n    naturalDimensions_[tagName]\n  );\n}\n/**\n * Whether the loading can be shown for the specified elemeent. This set has\n * to be externalized since the element's implementation may not be\n * downloaded yet.\n * @param {!Element} element\n * @return {boolean}\n */\n\n\nfunction isLoadingAllowed(element) {\n  var tagName = element.tagName.toUpperCase();\n  return LOADING_ELEMENTS_[tagName] || isIframeVideoPlayerComponent(tagName);\n}\n/**\n * All video player components must either have a) \"video\" or b) \"player\" in\n * their name. A few components don't follow this convention for historical\n * reasons, so they're present in the LOADING_ELEMENTS_ whitelist.\n * @param {string} tagName\n * @return {boolean}\n */\n\n\nfunction isIframeVideoPlayerComponent(tagName) {\n  if (tagName == 'AMP-VIDEO') {\n    return false;\n  }\n\n  return videoPlayerTagNameRe.test(tagName);\n}\n/**\n * Applies layout to the element. Visible for testing only.\n *\n * \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  / _____|\n *  \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n *   \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n *    \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n *     \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n *\n * The equivalent of this method is used for server-side rendering (SSR) and\n * any changes made to it must be made in coordination with caches that\n * implement SSR. For more information on SSR see bit.ly/amp-ssr.\n *\n * @param {!Element} element\n * @return {!Layout}\n */\n\n\nfunction applyStaticLayout(element) {\n  // Check if the layout has already been done by server-side rendering or\n  // client-side rendering and the element was cloned. The document may be\n  // visible to the user if the boilerplate was removed so please take care in\n  // making changes here.\n  var completedLayoutAttr = element.getAttribute('i-amphtml-layout');\n\n  if (completedLayoutAttr) {\n    var _layout =\n    /** @type {!Layout} */\n    (0, _log.devAssert)(parseLayout(completedLayoutAttr));\n\n    if ((_layout == Layout.RESPONSIVE || _layout == Layout.INTRINSIC) && element.firstElementChild) {\n      // Find sizer, but assume that it might not have been parsed yet.\n      element.sizerElement = element.querySelector('i-amphtml-sizer') || undefined;\n    } else if (_layout == Layout.NODISPLAY) {\n      (0, _style.toggle)(element, false); // TODO(jridgewell): Temporary hack while SSR still adds an inline\n      // `display: none`\n\n      element['style']['display'] = '';\n    }\n\n    return _layout;\n  } // If the layout was already done by server-side rendering (SSR), then the\n  // code below will not run. Any changes below will necessitate a change to SSR\n  // and must be coordinated with caches that implement SSR. See bit.ly/amp-ssr.\n  // Parse layout from the element.\n\n\n  var layoutAttr = element.getAttribute('layout');\n  var widthAttr = element.getAttribute('width');\n  var heightAttr = element.getAttribute('height');\n  var sizesAttr = element.getAttribute('sizes');\n  var heightsAttr = element.getAttribute('heights'); // Input layout attributes.\n\n  var inputLayout = layoutAttr ? parseLayout(layoutAttr) : null;\n  (0, _log.userAssert)(inputLayout !== undefined, 'Unknown layout: %s', layoutAttr);\n  /** @const {string|null|undefined} */\n\n  var inputWidth = widthAttr && widthAttr != 'auto' ? parseLength(widthAttr) : widthAttr;\n  (0, _log.userAssert)(inputWidth !== undefined, 'Invalid width value: %s', widthAttr);\n  /** @const {string|null|undefined} */\n\n  var inputHeight = heightAttr && heightAttr != 'fluid' ? parseLength(heightAttr) : heightAttr;\n  (0, _log.userAssert)(inputHeight !== undefined, 'Invalid height value: %s', heightAttr); // Effective layout attributes. These are effectively constants.\n\n  var width;\n  var height;\n  var layout; // Calculate effective width and height.\n\n  if ((!inputLayout || inputLayout == Layout.FIXED || inputLayout == Layout.FIXED_HEIGHT) && (!inputWidth || !inputHeight) && hasNaturalDimensions(element.tagName)) {\n    // Default width and height: handle elements that do not specify a\n    // width/height and are defined to have natural browser dimensions.\n    var dimensions = getNaturalDimensions(element);\n    width = inputWidth || inputLayout == Layout.FIXED_HEIGHT ? inputWidth : dimensions.width;\n    height = inputHeight || dimensions.height;\n  } else {\n    width = inputWidth;\n    height = inputHeight;\n  } // Calculate effective layout.\n\n\n  if (inputLayout) {\n    layout = inputLayout;\n  } else if (!width && !height) {\n    layout = Layout.CONTAINER;\n  } else if (height == 'fluid') {\n    layout = Layout.FLUID;\n  } else if (height && (!width || width == 'auto')) {\n    layout = Layout.FIXED_HEIGHT;\n  } else if (height && width && (sizesAttr || heightsAttr)) {\n    layout = Layout.RESPONSIVE;\n  } else {\n    layout = Layout.FIXED;\n  } // Verify layout attributes.\n\n\n  if (layout == Layout.FIXED || layout == Layout.FIXED_HEIGHT || layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) {\n    (0, _log.userAssert)(height, 'Expected height to be available: %s', heightAttr);\n  }\n\n  if (layout == Layout.FIXED_HEIGHT) {\n    (0, _log.userAssert)(!width || width == 'auto', 'Expected width to be either absent or equal \"auto\" ' + 'for fixed-height layout: %s', widthAttr);\n  }\n\n  if (layout == Layout.FIXED || layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) {\n    (0, _log.userAssert)(width && width != 'auto', 'Expected width to be available and not equal to \"auto\": %s', widthAttr);\n  }\n\n  if (layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) {\n    (0, _log.userAssert)(getLengthUnits(width) == getLengthUnits(height), 'Length units should be the same for width and height: %s, %s', widthAttr, heightAttr);\n  } else {\n    (0, _log.userAssert)(heightsAttr === null, 'Unexpected \"heights\" attribute for none-responsive layout');\n  } // Apply UI.\n\n\n  element.classList.add(getLayoutClass(layout));\n\n  if (isLayoutSizeDefined(layout)) {\n    element.classList.add('i-amphtml-layout-size-defined');\n  }\n\n  if (layout == Layout.NODISPLAY) {\n    // CSS defines layout=nodisplay automatically with `display:none`. Thus\n    // no additional styling is needed.\n    (0, _style.toggle)(element, false); // TODO(jridgewell): Temporary hack while SSR still adds an inline\n    // `display: none`\n\n    element['style']['display'] = '';\n  } else if (layout == Layout.FIXED) {\n    (0, _style.setStyles)(element, {\n      width: (0, _log.dev)().assertString(width),\n      height: (0, _log.dev)().assertString(height)\n    });\n  } else if (layout == Layout.FIXED_HEIGHT) {\n    (0, _style.setStyle)(element, 'height', (0, _log.dev)().assertString(height));\n  } else if (layout == Layout.RESPONSIVE) {\n    var sizer = element.ownerDocument.createElement('i-amphtml-sizer');\n    (0, _style.setStyles)(sizer, {\n      paddingTop: getLengthNumeral(height) / getLengthNumeral(width) * 100 + '%'\n    });\n    element.insertBefore(sizer, element.firstChild);\n    element.sizerElement = sizer;\n  } else if (layout == Layout.INTRINSIC) {\n    // Intrinsic uses an svg inside the sizer element rather than the padding\n    // trick Note a naked svg won't work becasue other thing expect the\n    // i-amphtml-sizer element\n    var _sizer = (0, _staticTemplate.htmlFor)(element)(_templateObject());\n\n    var intrinsicSizer = _sizer.firstElementChild;\n    intrinsicSizer.setAttribute('src', \"data:image/svg+xml;charset=utf-8,<svg height=\\\"\" + height + \"\\\" width=\\\"\" + width + \"\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" version=\\\"1.1\\\"/>\");\n    element.insertBefore(_sizer, element.firstChild);\n    element.sizerElement = _sizer;\n  } else if (layout == Layout.FILL) {// Do nothing.\n  } else if (layout == Layout.CONTAINER) {// Do nothing. Elements themselves will check whether the supplied\n    // layout value is acceptable. In particular container is only OK\n    // sometimes.\n  } else if (layout == Layout.FLEX_ITEM) {\n    // Set height and width to a flex item if they exist.\n    // The size set to a flex item could be overridden by `display: flex` later.\n    if (width) {\n      (0, _style.setStyle)(element, 'width', width);\n    }\n\n    if (height) {\n      (0, _style.setStyle)(element, 'height', height);\n    }\n  } else if (layout == Layout.FLUID) {\n    element.classList.add('i-amphtml-layout-awaiting-size');\n\n    if (width) {\n      (0, _style.setStyle)(element, 'width', width);\n    }\n\n    (0, _style.setStyle)(element, 'height', 0);\n  } // Mark the element as having completed static layout, in case it is cloned\n  // in the future.\n\n\n  element.setAttribute('i-amphtml-layout', layout);\n  return layout;\n}\n\n},{\"./log\":68,\"./static-template\":125,\"./string\":126,\"./style\":128,\"./types\":131}],67:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.createLoaderElement = createLoaderElement;\n\nvar _services = require(\"./services\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Gets a Promise for the LoaderService, initiating a request to download the\n * code.\n * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n * @param {!Element} element\n * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n */\nfunction getLoaderServicePromise(ampDoc, element) {\n  return _services.Services.extensionsFor(ampDoc.win).installExtensionForDoc(ampDoc, 'amp-loader').then(function () {\n    return _services.Services.loaderServiceForDoc(element);\n  });\n}\n/**\n * Creates a default \"loading indicator\" element based on the new design.\n *\n * Please see https://github.com/ampproject/amphtml/issues/20237 for details,\n * screenshots and various states of the new loader design.\n * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n * @param {!AmpElement} element\n * @param {number} elementWidth\n * @param {number} elementHeight\n * @return {!Element} The loader root element.\n */\n\n\nfunction createLoaderElement(ampDoc, element, elementWidth, elementHeight) {\n  var startTime = Date.now(); // We create the loader root element up front, since it is needed\n  // synchronously. We create the actual element with animations when the\n  // service is ready.\n\n  var loaderRoot = element.ownerDocument.createElement('div');\n  getLoaderServicePromise(ampDoc, element).then(function (loaderService) {\n    var endTime = Date.now();\n    var initDelay = endTime - startTime;\n    loaderService.initializeLoader(element, loaderRoot, initDelay, elementWidth, elementHeight);\n  });\n  return loaderRoot;\n}\n\n},{\"./services\":123}],68:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.isUserErrorMessage = isUserErrorMessage;\nexports.isUserErrorEmbed = isUserErrorEmbed;\nexports.setReportError = setReportError;\nexports.overrideLogLevel = overrideLogLevel;\nexports.duplicateErrorIfNecessary = duplicateErrorIfNecessary;\nexports.createErrorVargs = createErrorVargs;\nexports.rethrowAsync = rethrowAsync;\nexports.initLogConstructor = initLogConstructor;\nexports.resetLogConstructorForTesting = resetLogConstructorForTesting;\nexports.user = user;\nexports.dev = dev;\nexports.isFromEmbed = isFromEmbed;\nexports.devAssert = devAssert;\nexports.userAssert = userAssert;\nexports.Log = exports.LogLevel = exports.USER_ERROR_EMBED_SENTINEL = exports.USER_ERROR_SENTINEL = void 0;\n\nvar _mode = require(\"./mode\");\n\nvar _modeObject = require(\"./mode-object\");\n\nvar _internalVersion = require(\"./internal-version\");\n\nvar _types = require(\"./types\");\n\nvar _function = require(\"./utils/function\");\n\nvar _config = require(\"./config\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar noop = function noop() {};\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\n\n\nvar USER_ERROR_SENTINEL = \"\\u200B\\u200B\\u200B\";\n/**\n * Four zero width space.\n *\n * @const {string}\n */\n\nexports.USER_ERROR_SENTINEL = USER_ERROR_SENTINEL;\nvar USER_ERROR_EMBED_SENTINEL = \"\\u200B\\u200B\\u200B\\u200B\";\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a user error.\n */\n\nexports.USER_ERROR_EMBED_SENTINEL = USER_ERROR_EMBED_SENTINEL;\n\nfunction isUserErrorMessage(message) {\n  return message.indexOf(USER_ERROR_SENTINEL) >= 0;\n}\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a a user error from an iframe embed.\n */\n\n\nfunction isUserErrorEmbed(message) {\n  return message.indexOf(USER_ERROR_EMBED_SENTINEL) >= 0;\n}\n/**\n * @enum {number}\n * @private Visible for testing only.\n */\n\n\nvar LogLevel = {\n  OFF: 0,\n  ERROR: 1,\n  WARN: 2,\n  INFO: 3,\n  FINE: 4\n};\n/**\n * Sets reportError function. Called from error.js to break cyclic\n * dependency.\n * @param {function(*, !Element=)|undefined} fn\n */\n\nexports.LogLevel = LogLevel;\n\nfunction setReportError(fn) {\n  self.__AMP_REPORT_ERROR = fn;\n}\n/**\n * @type {!LogLevel|undefined}\n * @private\n */\n\n\nvar levelOverride_ = undefined;\n/**\n * @param {!LogLevel} level\n */\n\nfunction overrideLogLevel(level) {\n  levelOverride_ = level;\n}\n/**\n * Prefixes `internalRuntimeVersion` with the `01` channel signifier (for prod.) for\n * extracted message URLs.\n * (Specific channel is irrelevant: message tables are invariant on internal version.)\n * @return {string}\n */\n\n\nvar messageUrlRtv = function messageUrlRtv() {\n  return \"01\" + (0, _internalVersion.internalRuntimeVersion)();\n};\n/**\n * Gets a URL to display a message on amp.dev.\n * @param {string} id\n * @param {!Array} interpolatedParts\n * @return {string}\n */\n\n\nvar externalMessageUrl = function externalMessageUrl(id, interpolatedParts) {\n  return interpolatedParts.reduce(function (prefix, arg) {\n    return prefix + \"&s[]=\" + messageArgToEncodedComponent(arg);\n  }, \"https://log.amp.dev/?v=\" + messageUrlRtv() + \"&id=\" + encodeURIComponent(id));\n};\n/**\n * URL to simple log messages table JSON file, which contains an Object<string, string>\n * which maps message id to full message template.\n * @return {string}\n */\n\n\nvar externalMessagesSimpleTableUrl = function externalMessagesSimpleTableUrl() {\n  return _config.urls.cdn + \"/rtv/\" + messageUrlRtv() + \"/log-messages.simple.json\";\n};\n/**\n * @param {*} arg\n * @return {string}\n */\n\n\nvar messageArgToEncodedComponent = function messageArgToEncodedComponent(arg) {\n  return encodeURIComponent(String(elementStringOrPassthru(arg)));\n};\n/**\n * Logging class. Use of sentinel string instead of a boolean to check user/dev\n * errors because errors could be rethrown by some native code as a new error,\n * and only a message would survive. Also, some browser dont support a 5th\n * error object argument in window.onerror. List of supporting browser can be\n * found here:\n * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n * @final\n * @private Visible for testing only.\n */\n\n\nvar Log =\n/*#__PURE__*/\nfunction () {\n  /**\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {!Window} win\n   * @param {function(!./mode.ModeDef):!LogLevel} levelFunc\n   * @param {string=} opt_suffix\n   */\n  function Log(win, levelFunc, opt_suffix) {\n    var _this = this;\n\n    if (opt_suffix === void 0) {\n      opt_suffix = '';\n    }\n\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = (0, _mode.getMode)().test && win.__AMP_TEST_IFRAME ? win.parent : win;\n    /** @private @const {function(!./mode.ModeDef):!LogLevel} */\n\n    this.levelFunc_ = levelFunc;\n    /** @private @const {!LogLevel} */\n\n    this.level_ = this.defaultLevel_();\n    /** @private @const {string} */\n\n    this.suffix_ = opt_suffix;\n    /** @private {?JsonObject} */\n\n    this.messages_ = null;\n    this.fetchExternalMessagesOnce_ = (0, _function.once)(function () {\n      win.fetch(externalMessagesSimpleTableUrl()).then(function (response) {\n        return response.json();\n      }, noop).then(function (opt_messages) {\n        if (opt_messages) {\n          _this.messages_ =\n          /** @type {!JsonObject} */\n          opt_messages;\n        }\n      });\n    });\n  }\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n\n\n  var _proto = Log.prototype;\n\n  _proto.getLevel_ = function getLevel_() {\n    return levelOverride_ !== undefined ? levelOverride_ : this.level_;\n  }\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  ;\n\n  _proto.defaultLevel_ = function defaultLevel_() {\n    // No console - can't enable logging.\n    if (!this.win.console || !this.win.console.log) {\n      return LogLevel.OFF;\n    } // Logging has been explicitly disabled.\n\n\n    if ((0, _mode.getMode)().log == '0') {\n      return LogLevel.OFF;\n    } // Logging is enabled for tests directly.\n\n\n    if ((0, _mode.getMode)().test && this.win.ENABLE_LOG) {\n      return LogLevel.FINE;\n    } // LocalDev by default allows INFO level, unless overriden by `#log`.\n\n\n    if ((0, _mode.getMode)().localDev && !(0, _mode.getMode)().log) {\n      return LogLevel.INFO;\n    } // Delegate to the specific resolver.\n\n\n    return this.levelFunc_((0, _modeObject.getModeObject)());\n  }\n  /**\n   * @param {string} tag\n   * @param {string} level\n   * @param {!Array} messages\n   */\n  ;\n\n  _proto.msg_ = function msg_(tag, level, messages) {\n    if (this.getLevel_() != LogLevel.OFF) {\n      var fn = this.win.console.log;\n\n      if (level == 'ERROR') {\n        fn = this.win.console.error || fn;\n      } else if (level == 'INFO') {\n        fn = this.win.console.info || fn;\n      } else if (level == 'WARN') {\n        fn = this.win.console.warn || fn;\n      }\n\n      var args = this.maybeExpandMessageArgs_(messages); // Prefix console message with \"[tag]\".\n\n      var prefix = \"[\" + tag + \"]\";\n\n      if (typeof args[0] === 'string') {\n        // Prepend string to avoid breaking string substitutions e.g. %s.\n        args[0] = prefix + ' ' + args[0];\n      } else {\n        args.unshift(prefix);\n      }\n\n      fn.apply(this.win.console, args);\n    }\n  }\n  /**\n   * Whether the logging is enabled.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isEnabled = function isEnabled() {\n    return this.getLevel_() != LogLevel.OFF;\n  }\n  /**\n   * Reports a fine-grained message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  ;\n\n  _proto.fine = function fine(tag, var_args) {\n    if (this.getLevel_() >= LogLevel.FINE) {\n      this.msg_(tag, 'FINE', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n  /**\n   * Reports a informational message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  ;\n\n  _proto.info = function info(tag, var_args) {\n    if (this.getLevel_() >= LogLevel.INFO) {\n      this.msg_(tag, 'INFO', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n  /**\n   * Reports a warning message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  ;\n\n  _proto.warn = function warn(tag, var_args) {\n    if (this.getLevel_() >= LogLevel.WARN) {\n      this.msg_(tag, 'WARN', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n  /**\n   * Reports an error message. If the logging is disabled, the error is rethrown\n   * asynchronously.\n   * @param {string} tag\n   * @param {...*} var_args\n   * @return {!Error|undefined}\n   * @private\n   */\n  ;\n\n  _proto.error_ = function error_(tag, var_args) {\n    if (this.getLevel_() >= LogLevel.ERROR) {\n      this.msg_(tag, 'ERROR', Array.prototype.slice.call(arguments, 1));\n    } else {\n      var error = createErrorVargs.apply(null, Array.prototype.slice.call(arguments, 1));\n      this.prepareError_(error);\n      return error;\n    }\n  }\n  /**\n   * Reports an error message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  ;\n\n  _proto.error = function error(tag, var_args) {\n    var error = this.error_.apply(this, arguments);\n\n    if (error) {\n      error.name = tag || error.name; // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n  /**\n   * Reports an error message and marks with an expected property. If the\n   * logging is disabled, the error is rethrown asynchronously.\n   * @param {string} unusedTag\n   * @param {...*} var_args\n   */\n  ;\n\n  _proto.expectedError = function expectedError(unusedTag, var_args) {\n    var error = this.error_.apply(this, arguments);\n\n    if (error) {\n      error.expected = true; // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n  /**\n   * Creates an error object.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  ;\n\n  _proto.createError = function createError(var_args) {\n    var error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    return error;\n  }\n  /**\n   * Creates an error object with its expected property set to true.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  ;\n\n  _proto.createExpectedError = function createExpectedError(var_args) {\n    var error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n  /**\n   * Throws an error if the first argument isn't trueish.\n   *\n   * Supports argument substitution into the message via %s placeholders.\n   *\n   * Throws an error object that has two extra properties:\n   * - associatedElement: This is the first element provided in the var args.\n   *   It can be used for improved display of error messages.\n   * - messageArray: The elements of the substituted message as non-stringified\n   *   elements in an array. When e.g. passed to console.error this yields\n   *   native displays of things like HTML elements.\n   *\n   * NOTE: for an explanation of the tempate R implementation see\n   * https://github.com/google/closure-library/blob/08858804/closure/goog/asserts/asserts.js#L192-L213\n   *\n   * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n   *     not evaluate to true.\n   * @param {!Array|string=} opt_message The assertion message\n   * @param {...*} var_args Arguments substituted into %s in the message.\n   * @return {R} The value of shouldBeTrueish.\n   * @throws {!Error} When `value` is `null` or `undefined`.\n   * @template T\n   * @template R :=\n   *     mapunion(T, (V) =>\n   *         cond(eq(V, 'null'),\n   *             none(),\n   *             cond(eq(V, 'undefined'),\n   *                 none(),\n   *                 V)))\n   *  =:\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  ;\n\n  _proto.assert = function assert(shouldBeTrueish, opt_message, var_args) {\n    var firstElement;\n\n    if ((0, _types.isArray)(opt_message)) {\n      return this.assert.apply(this, [shouldBeTrueish].concat(this.expandMessageArgs_(\n      /** @type {!Array} */\n      opt_message)));\n    }\n\n    if (!shouldBeTrueish) {\n      var message = opt_message || 'Assertion failed';\n      var splitMessage = message.split('%s');\n      var first = splitMessage.shift();\n      var formatted = first;\n      var messageArray = [];\n      var i = 2;\n      pushIfNonEmpty(messageArray, first);\n\n      while (splitMessage.length > 0) {\n        var nextConstant = splitMessage.shift();\n        var val = arguments[i++];\n\n        if (val && val.tagName) {\n          firstElement = val;\n        }\n\n        messageArray.push(val);\n        pushIfNonEmpty(messageArray, nextConstant.trim());\n        formatted += stringOrElementString(val) + nextConstant;\n      }\n\n      var e = new Error(formatted);\n      e.fromAssert = true;\n      e.associatedElement = firstElement;\n      e.messageArray = messageArray;\n      this.prepareError_(e); // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n\n      self.__AMP_REPORT_ERROR(e);\n\n      throw e;\n    }\n\n    return shouldBeTrueish;\n  }\n  /**\n   * Throws an error if the first argument isn't an Element\n   *\n   * Otherwise see `assert` for usage\n   *\n   * @param {*} shouldBeElement\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Element} The value of shouldBeTrueish.\n   * @template T\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  ;\n\n  _proto.assertElement = function assertElement(shouldBeElement, opt_message) {\n    var shouldBeTrueish = shouldBeElement && shouldBeElement.nodeType == 1;\n    this.assertType_(shouldBeElement, shouldBeTrueish, 'Element expected', opt_message);\n    return (\n      /** @type {!Element} */\n      shouldBeElement\n    );\n  }\n  /**\n   * Throws an error if the first argument isn't a string. The string can\n   * be empty.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeString\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {string} The string value. Can be an empty string.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  ;\n\n  _proto.assertString = function assertString(shouldBeString, opt_message) {\n    this.assertType_(shouldBeString, typeof shouldBeString == 'string', 'String expected', opt_message);\n    return (\n      /** @type {string} */\n      shouldBeString\n    );\n  }\n  /**\n   * Throws an error if the first argument isn't a number. The allowed values\n   * include `0` and `NaN`.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeNumber\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {number} The number value. The allowed values include `0`\n   *   and `NaN`.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  ;\n\n  _proto.assertNumber = function assertNumber(shouldBeNumber, opt_message) {\n    this.assertType_(shouldBeNumber, typeof shouldBeNumber == 'number', 'Number expected', opt_message);\n    return (\n      /** @type {number} */\n      shouldBeNumber\n    );\n  }\n  /**\n   * Throws an error if the first argument is not an array.\n   * The array can be empty.\n   *\n   * @param {*} shouldBeArray\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Array} The array value\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  ;\n\n  _proto.assertArray = function assertArray(shouldBeArray, opt_message) {\n    this.assertType_(shouldBeArray, (0, _types.isArray)(shouldBeArray), 'Array expected', opt_message);\n    return (\n      /** @type {!Array} */\n      shouldBeArray\n    );\n  }\n  /**\n   * Throws an error if the first argument isn't a boolean.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeBoolean\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {boolean} The boolean value.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  ;\n\n  _proto.assertBoolean = function assertBoolean(shouldBeBoolean, opt_message) {\n    this.assertType_(shouldBeBoolean, !!shouldBeBoolean === shouldBeBoolean, 'Boolean expected', opt_message);\n    return (\n      /** @type {boolean} */\n      shouldBeBoolean\n    );\n  }\n  /**\n   * Asserts and returns the enum value. If the enum doesn't contain such a\n   * value, the error is thrown.\n   *\n   * @param {!Object<T>} enumObj\n   * @param {string} s\n   * @param {string=} opt_enumName\n   * @return {T}\n   * @template T\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  ;\n\n  _proto.assertEnumValue = function assertEnumValue(enumObj, s, opt_enumName) {\n    if ((0, _types.isEnumValue)(enumObj, s)) {\n      return s;\n    }\n\n    this.assert(false, 'Unknown %s value: \"%s\"', opt_enumName || 'enum', s);\n  }\n  /**\n   * @param {!Error} error\n   * @private\n   */\n  ;\n\n  _proto.prepareError_ = function prepareError_(error) {\n    error = duplicateErrorIfNecessary(error);\n\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) == -1) {\n        error.message += this.suffix_;\n      }\n    } else if (isUserErrorMessage(error.message)) {\n      error.message = error.message.replace(USER_ERROR_SENTINEL, '');\n    }\n  }\n  /**\n   * @param {!Array} args\n   * @return {!Array}\n   * @private\n   */\n  ;\n\n  _proto.maybeExpandMessageArgs_ = function maybeExpandMessageArgs_(args) {\n    if ((0, _types.isArray)(args[0])) {\n      return this.expandMessageArgs_(\n      /** @type {!Array} */\n      args[0]);\n    }\n\n    return args;\n  }\n  /**\n   * Either redirects a pair of (errorId, ...args) to a URL where the full\n   * message is displayed, or displays it from a fetched table.\n   *\n   * This method is used by the output of the `transform-log-methods` babel\n   * plugin. It should not be used directly. Use the (*error|assert*|info|warn)\n   * methods instead.\n   *\n   * @param {!Array} parts\n   * @return {!Array}\n   * @private\n   */\n  ;\n\n  _proto.expandMessageArgs_ = function expandMessageArgs_(parts) {\n    // First value should exist.\n    var id = parts.shift(); // Best effort fetch of message template table.\n    // Since this is async, the first few logs might be indirected to a URL even\n    // if in development mode. Message table is ~small so this should be a short\n    // gap.\n\n    if ((0, _mode.getMode)(this.win).development) {\n      this.fetchExternalMessagesOnce_();\n    }\n\n    if (this.messages_ && id in this.messages_) {\n      return [this.messages_[id]].concat(parts);\n    }\n\n    return [\"More info at \" + externalMessageUrl(id, parts)];\n  }\n  /**\n   * Asserts types, backbone of `assertNumber`, `assertString`, etc.\n   *\n   * It understands array-based \"id\"-contracted messages.\n   *\n   * Otherwise creates a sprintf syntax string containing the optional message or the\n   * default. An interpolation token is added at the end to include the `subject`.\n   * @param {*} subject\n   * @param {*} assertion\n   * @param {string} defaultMessage\n   * @param {!Array|string=} opt_message\n   * @private\n   */\n  ;\n\n  _proto.assertType_ = function assertType_(subject, assertion, defaultMessage, opt_message) {\n    if ((0, _types.isArray)(opt_message)) {\n      this.assert(assertion, opt_message.concat(subject));\n    } else {\n      this.assert(assertion, (opt_message || defaultMessage) + \": %s\", subject);\n    }\n  };\n\n  return Log;\n}();\n/**\n * @param {string|!Element} val\n * @return {string}\n */\n\n\nexports.Log = Log;\n\nvar stringOrElementString = function stringOrElementString(val) {\n  return (\n    /** @type {string} */\n    elementStringOrPassthru(val)\n  );\n};\n/**\n * @param {*} val\n * @return {*}\n */\n\n\nfunction elementStringOrPassthru(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (val && val.nodeType == 1) {\n    return val.tagName.toLowerCase() + (val.id ? '#' + val.id : '');\n  }\n\n  return val;\n}\n/**\n * @param {!Array} array\n * @param {*} val\n */\n\n\nfunction pushIfNonEmpty(array, val) {\n  if (val != '') {\n    array.push(val);\n  }\n}\n/**\n * Some exceptions (DOMException, namely) have read-only message.\n * @param {!Error} error\n * @return {!Error};\n */\n\n\nfunction duplicateErrorIfNecessary(error) {\n  var messageProperty = Object.getOwnPropertyDescriptor(error, 'message');\n\n  if (messageProperty && messageProperty.writable) {\n    return error;\n  }\n\n  var message = error.message,\n      stack = error.stack;\n  var e = new Error(message); // Copy all the extraneous things we attach.\n\n  for (var prop in error) {\n    e[prop] = error[prop];\n  } // Ensure these are copied.\n\n\n  e.stack = stack;\n  return e;\n}\n/**\n * @param {...*} var_args\n * @return {!Error}\n * @visibleForTesting\n */\n\n\nfunction createErrorVargs(var_args) {\n  var error = null;\n  var message = '';\n\n  for (var i = 0; i < arguments.length; i++) {\n    var arg = arguments[i];\n\n    if (arg instanceof Error && !error) {\n      error = duplicateErrorIfNecessary(arg);\n    } else {\n      if (message) {\n        message += ' ';\n      }\n\n      message += arg;\n    }\n  }\n\n  if (!error) {\n    error = new Error(message);\n  } else if (message) {\n    error.message = message + ': ' + error.message;\n  }\n\n  return error;\n}\n/**\n * Rethrows the error without terminating the current context. This preserves\n * whether the original error designation is a user error or a dev error.\n * @param {...*} var_args\n */\n\n\nfunction rethrowAsync(var_args) {\n  var error = createErrorVargs.apply(null, arguments);\n  setTimeout(function () {\n    // reportError is installed globally per window in the entry point.\n    self.__AMP_REPORT_ERROR(error);\n\n    throw error;\n  });\n}\n/**\n * Cache for logs. We do not use a Service since the service module depends\n * on Log and closure literally can't even.\n * @type {{user: ?Log, dev: ?Log, userForEmbed: ?Log}}\n */\n\n\nself.__AMP_LOG = self.__AMP_LOG || {\n  user: null,\n  dev: null,\n  userForEmbed: null\n};\nvar logs = self.__AMP_LOG;\n/**\n * Eventually holds a constructor for Log objects. Lazily initialized, so we\n * can avoid ever referencing the real constructor except in JS binaries\n * that actually want to include the implementation.\n * @type {?Function}\n */\n\nvar logConstructor = null;\n/**\n * Initializes log contructor.\n */\n\nfunction initLogConstructor() {\n  logConstructor = Log; // Initialize instances for use. If a binary (an extension for example) that\n  // does not call `initLogConstructor` invokes `dev()` or `user()` earlier than\n  // the binary that does call `initLogConstructor` (amp.js), the extension will\n  // throw an error as that extension will never be able to initialize the log\n  // instances and we also don't want it to call `initLogConstructor` either\n  // (since that will cause the Log implementation to be bundled into that\n  // binary). So we must initialize the instances eagerly so that they are ready\n  // for use (stored globally) after the main binary calls `initLogConstructor`.\n\n  dev();\n  user();\n}\n/**\n * Resets log contructor for testing.\n */\n\n\nfunction resetLogConstructorForTesting() {\n  logConstructor = null;\n}\n/**\n * Publisher level log.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Development mode is enabled via `#development=1` or logging is explicitly\n *     enabled via `#log=D` where D >= 1.\n *  3. AMP.setLogLevel(D) is called, where D >= 1.\n *\n * @param {!Element=} opt_element\n * @return {!Log}\n */\n\n\nfunction user(opt_element) {\n  if (!logs.user) {\n    logs.user = getUserLogger(USER_ERROR_SENTINEL);\n  }\n\n  if (!isFromEmbed(logs.user.win, opt_element)) {\n    return logs.user;\n  } else {\n    if (logs.userForEmbed) {\n      return logs.userForEmbed;\n    }\n\n    return logs.userForEmbed = getUserLogger(USER_ERROR_EMBED_SENTINEL);\n  }\n}\n/**\n * Getter for user logger\n * @param {string=} suffix\n * @return {!Log}\n */\n\n\nfunction getUserLogger(suffix) {\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n\n  return new logConstructor(self, function (mode) {\n    var logNum = parseInt(mode.log, 10);\n\n    if (mode.development || logNum >= 1) {\n      return LogLevel.FINE;\n    }\n\n    return LogLevel.WARN;\n  }, suffix);\n}\n/**\n * AMP development log. Calls to `devLog().assert` and `dev.fine` are stripped\n * in the PROD binary. However, `devLog().assert` result is preserved in either\n * case.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Logging is explicitly enabled via `#log=D`, where D >= 2.\n *  3. AMP.setLogLevel(D) is called, where D >= 2.\n *\n * @return {!Log}\n */\n\n\nfunction dev() {\n  if (logs.dev) {\n    return logs.dev;\n  }\n\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n\n  return logs.dev = new logConstructor(self, function (mode) {\n    var logNum = parseInt(mode.log, 10);\n\n    if (logNum >= 3) {\n      return LogLevel.FINE;\n    }\n\n    if (logNum >= 2) {\n      return LogLevel.INFO;\n    }\n\n    return LogLevel.OFF;\n  });\n}\n/**\n * @param {!Window} win\n * @param {!Element=} opt_element\n * @return {boolean} isEmbed\n */\n\n\nfunction isFromEmbed(win, opt_element) {\n  if (!opt_element) {\n    return false;\n  }\n\n  return opt_element.ownerDocument.defaultView != win;\n}\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * NOTE: for an explanation of the tempate R implementation see\n * https://github.com/google/closure-library/blob/08858804/closure/goog/asserts/asserts.js#L192-L213\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {R} The value of shouldBeTrueish.\n * @template T\n * @template R :=\n *     mapunion(T, (V) =>\n *         cond(eq(V, 'null'),\n *             none(),\n *             cond(eq(V, 'undefined'),\n *                 none(),\n *                 V)))\n *  =:\n * @throws {!Error} When `value` is `null` or `undefined`.\n * @closurePrimitive {asserts.matchesReturn}\n */\n\n\nfunction devAssert(shouldBeTrueish, opt_message, opt_1, opt_2, opt_3, opt_4, opt_5, opt_6, opt_7, opt_8, opt_9) {\n  if ((0, _mode.getMode)().minified) {\n    return shouldBeTrueish;\n  }\n\n  return dev().\n  /*Orig call*/\n  assert(shouldBeTrueish, opt_message, opt_1, opt_2, opt_3, opt_4, opt_5, opt_6, opt_7, opt_8, opt_9);\n}\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * NOTE: for an explanation of the tempate R implementation see\n * https://github.com/google/closure-library/blob/08858804/closure/goog/asserts/asserts.js#L192-L213\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {R} The value of shouldBeTrueish.\n * @template T\n * @template R :=\n *     mapunion(T, (V) =>\n *         cond(eq(V, 'null'),\n *             none(),\n *             cond(eq(V, 'undefined'),\n *                 none(),\n *                 V)))\n *  =:\n * @throws {!Error} When `value` is `null` or `undefined`.\n * @closurePrimitive {asserts.matchesReturn}\n */\n\n\nfunction userAssert(shouldBeTrueish, opt_message, opt_1, opt_2, opt_3, opt_4, opt_5, opt_6, opt_7, opt_8, opt_9) {\n  return user().\n  /*Orig call*/\n  assert(shouldBeTrueish, opt_message, opt_1, opt_2, opt_3, opt_4, opt_5, opt_6, opt_7, opt_8, opt_9);\n}\n\n},{\"./config\":32,\"./internal-version\":61,\"./mode\":70,\"./mode-object\":69,\"./types\":131,\"./utils/function\":140}],69:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getModeObject = getModeObject;\n\nvar _mode = require(\"./mode\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Provides info about the current app. This return value may be cached and\n * passed around as it will always be DCE'd.\n * @param {?Window=} opt_win\n * @return {!./mode.ModeDef}\n */\nfunction getModeObject(opt_win) {\n  return {\n    localDev: (0, _mode.getMode)(opt_win).localDev,\n    development: (0, _mode.getMode)(opt_win).development,\n    filter: (0, _mode.getMode)(opt_win).filter,\n    minified: (0, _mode.getMode)(opt_win).minified,\n    lite: (0, _mode.getMode)(opt_win).lite,\n    test: (0, _mode.getMode)(opt_win).test,\n    log: (0, _mode.getMode)(opt_win).log,\n    version: (0, _mode.getMode)(opt_win).version,\n    rtvVersion: (0, _mode.getMode)(opt_win).rtvVersion,\n    singlePassType: (0, _mode.getMode)(opt_win).singlePassType\n  };\n}\n\n},{\"./mode\":70}],70:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getMode = getMode;\nexports.getRtvVersionForTesting = getRtvVersionForTesting;\nexports.resetRtvVersionForTesting = resetRtvVersionForTesting;\nexports.ModeDef = void 0;\n\nvar _internalVersion = require(\"./internal-version\");\n\nvar _urlParseQueryString = require(\"./url-parse-query-string\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   minified: boolean,\n *   lite: boolean,\n *   test: boolean,\n *   log: (string|undefined),\n *   version: string,\n *   rtvVersion: string,\n *   runtime: (null|string|undefined),\n *   a4aId: (null|string|undefined),\n *   singlePassType: (string|undefined)\n * }}\n */\nvar ModeDef;\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\n\nexports.ModeDef = ModeDef;\nvar rtvVersion = '';\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\n\nfunction getMode(opt_win) {\n  var win = opt_win || self;\n\n  if (win.__AMP_MODE) {\n    return win.__AMP_MODE;\n  }\n\n  return win.__AMP_MODE = getMode_(win);\n}\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\n\n\nfunction getMode_(win) {\n  // TODO(erwinmombay): simplify the logic here\n  var AMP_CONFIG = self.AMP_CONFIG || {}; // Magic constants that are replaced by closure compiler.\n  // IS_MINIFIED is always replaced with true when closure compiler is used\n  // while IS_DEV is only replaced when `gulp dist` is called without the\n  // --fortesting flag.\n\n  var IS_DEV = true;\n  var IS_MINIFIED = false;\n  var localDevEnabled = !!AMP_CONFIG.localDev;\n  var runningTests = !!AMP_CONFIG.test || IS_DEV && !!(win.__AMP_TEST || win.__karma__);\n  var runningTestsOnIe = win.__karma__ && win.__karma__.config.amp.testOnIe;\n  var isLocalDev = IS_DEV && (localDevEnabled || runningTests);\n  var hashQuery = (0, _urlParseQueryString.parseQueryString_)( // location.originalHash is set by the viewer when it removes the fragment\n  // from the URL.\n  win.location.originalHash || win.location.hash);\n  var singlePassType = AMP_CONFIG.spt;\n  var searchQuery = (0, _urlParseQueryString.parseQueryString_)(win.location.search);\n\n  if (!rtvVersion) {\n    rtvVersion = getRtvVersion(win, isLocalDev);\n  } // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `gulp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n\n\n  return {\n    localDev: isLocalDev,\n    // Triggers validation or enable pub level logging. Validation can be\n    // bypassed via #validate=0.\n    // Note that AMP_DEV_MODE flag is used for testing purposes.\n    // Use Array.indexOf instead of Array.includes because of #24219\n    development: !!(['1', 'actions', 'amp', 'amp4ads', 'amp4email'].indexOf(hashQuery['development']) >= 0 || win.AMP_DEV_MODE),\n    examiner: hashQuery['development'] == '2',\n    // amp-geo override\n    geoOverride: hashQuery['amp-geo'],\n    // amp-user-location override\n    userLocationOverride: hashQuery['amp-user-location'],\n    minified: IS_MINIFIED,\n    // Whether document is in an amp-lite viewer. It signal that the user\n    // would prefer to use less bandwidth.\n    lite: searchQuery['amp_lite'] != undefined,\n    test: runningTests,\n    testIe: runningTestsOnIe,\n    log: hashQuery['log'],\n    version: (0, _internalVersion.internalRuntimeVersion)(),\n    rtvVersion: rtvVersion,\n    singlePassType: singlePassType\n  };\n}\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @param {boolean} isLocalDev\n * @return {string}\n */\n\n\nfunction getRtvVersion(win, isLocalDev) {\n  // If it's local dev then we won't actually have a full version so\n  // just use the version.\n  if (isLocalDev) {\n    return (0, _internalVersion.internalRuntimeVersion)();\n  }\n\n  if (win.AMP_CONFIG && win.AMP_CONFIG.v) {\n    return win.AMP_CONFIG.v;\n  } // Currently `internalRuntimeVersion` and thus `mode.version` contain only\n  // major version. The full version however must also carry the minor version.\n  // We will default to production default `01` minor version for now.\n  // TODO(erwinmombay): decide whether internalRuntimeVersion should contain\n  // minor version.\n\n\n  return \"01\" + (0, _internalVersion.internalRuntimeVersion)();\n}\n/**\n * @param {!Window} win\n * @param {boolean} isLocalDev\n * @return {string}\n * @visibleForTesting\n */\n\n\nfunction getRtvVersionForTesting(win, isLocalDev) {\n  return getRtvVersion(win, isLocalDev);\n}\n/** @visibleForTesting */\n\n\nfunction resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n\n},{\"./internal-version\":61,\"./url-parse-query-string\":132}],71:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.Observable = void 0;\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * This class helps to manage observers. Observers can be added, removed or\n * fired through and instance of this class.\n * @template TYPE\n */\nvar Observable =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates an instance of Observable.\n   */\n  function Observable() {\n    /** @type {?Array<function(TYPE)>} */\n    this.handlers_ = null;\n  }\n  /**\n   * Adds the observer to this instance.\n   * @param {function(TYPE)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n\n\n  var _proto = Observable.prototype;\n\n  _proto.add = function add(handler) {\n    var _this = this;\n\n    if (!this.handlers_) {\n      this.handlers_ = [];\n    }\n\n    this.handlers_.push(handler);\n    return function () {\n      _this.remove(handler);\n    };\n  }\n  /**\n   * Removes the observer from this instance.\n   * @param {function(TYPE)} handler Observer's instance.\n   */\n  ;\n\n  _proto.remove = function remove(handler) {\n    if (!this.handlers_) {\n      return;\n    }\n\n    var index = this.handlers_.indexOf(handler);\n\n    if (index > -1) {\n      this.handlers_.splice(index, 1);\n    }\n  }\n  /**\n   * Removes all observers.\n   */\n  ;\n\n  _proto.removeAll = function removeAll() {\n    if (!this.handlers_) {\n      return;\n    }\n\n    this.handlers_.length = 0;\n  }\n  /**\n   * Fires an event. All observers are called.\n   * @param {TYPE=} opt_event\n   */\n  ;\n\n  _proto.fire = function fire(opt_event) {\n    if (!this.handlers_) {\n      return;\n    }\n\n    var handlers = this.handlers_;\n\n    for (var i = 0; i < handlers.length; i++) {\n      var handler = handlers[i];\n      handler(opt_event);\n    }\n  }\n  /**\n   * Returns number of handlers. Mostly needed for tests.\n   * @return {number}\n   */\n  ;\n\n  _proto.getHandlerCount = function getHandlerCount() {\n    if (!this.handlers_) {\n      return 0;\n    }\n\n    return this.handlers_.length;\n  };\n\n  return Observable;\n}();\n\nexports.Observable = Observable;\n\n},{}],72:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.Pass = void 0;\n\nvar _services = require(\"./services\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Pass class helps to manage single-pass process. A pass is scheduled using\n * delay method. Only one pass can be pending at a time. If no pass is pending\n * the process is considered to be \"idle\".\n */\nvar Pass =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates a new Pass instance.\n   * @param {!Window} win\n   * @param {function()} handler Handler to be executed when pass is triggered.\n   * @param {number=} opt_defaultDelay Default delay to be used when schedule\n   *   is called without one.\n   */\n  function Pass(win, handler, opt_defaultDelay) {\n    var _this = this;\n\n    this.timer_ = _services.Services.timerFor(win);\n    /** @private @const {function()} */\n\n    this.handler_ = handler;\n    /** @private @const {number} */\n\n    this.defaultDelay_ = opt_defaultDelay || 0;\n    /** @private {number|string} */\n\n    this.scheduled_ = -1;\n    /** @private {number} */\n\n    this.nextTime_ = 0;\n    /** @private {boolean} */\n\n    this.running_ = false;\n    /**\n     * @private\n     * @const {function()}\n     */\n\n    this.boundPass_ = function () {\n      _this.pass_();\n    };\n  }\n  /**\n   * Whether or not a pass is currently pending.\n   * @return {boolean}\n   */\n\n\n  var _proto = Pass.prototype;\n\n  _proto.isPending = function isPending() {\n    return this.scheduled_ != -1;\n  }\n  /**\n   * Tries to schedule a new pass optionally with specified delay. If the new\n   * requested pass is requested before the pending pass, the pending pass is\n   * canceled. If the new pass is requested after the pending pass, the newly\n   * requested pass is ignored.\n   *\n   * Returns {@code true} if the pass has been scheduled and {@code false} if\n   * ignored.\n   *\n   * @param {number=} opt_delay Delay to schedule the pass. If not specified\n   *   the default delay is used, falling back to 0.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.schedule = function schedule(opt_delay) {\n    var delay = opt_delay || this.defaultDelay_;\n\n    if (this.running_ && delay < 10) {\n      // If we get called recursively, wait at least 10ms for the next\n      // execution.\n      delay = 10;\n    }\n\n    var nextTime = Date.now() + delay; // Schedule anew if nothing is scheduled currently or if the new time is\n    // sooner then previously requested.\n\n    if (!this.isPending() || nextTime - this.nextTime_ < -10) {\n      this.cancel();\n      this.nextTime_ = nextTime;\n      this.scheduled_ = this.timer_.delay(this.boundPass_, delay);\n      return true;\n    }\n\n    return false;\n  }\n  /**\n   *\n   */\n  ;\n\n  _proto.pass_ = function pass_() {\n    this.scheduled_ = -1;\n    this.nextTime_ = 0;\n    this.running_ = true;\n    this.handler_();\n    this.running_ = false;\n  }\n  /**\n   * Cancels the pending pass if any.\n   */\n  ;\n\n  _proto.cancel = function cancel() {\n    if (this.isPending()) {\n      this.timer_.cancel(this.scheduled_);\n      this.scheduled_ = -1;\n    }\n  };\n\n  return Pass;\n}();\n\nexports.Pass = Pass;\n\n},{\"./services\":123}],73:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.createPixel = createPixel;\n\nvar _windowInterface = require(\"../src/window-interface\");\n\nvar _dom = require(\"../src/dom\");\n\nvar _object = require(\"../src/utils/object\");\n\nvar _log = require(\"../src/log\");\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {string} */\nvar TAG = 'pixel';\n/**\n * @param {!Window} win\n * @param {string} src\n * @param {?string=} referrerPolicy\n * @return {!Element}\n */\n\nfunction createPixel(win, src, referrerPolicy) {\n  if (referrerPolicy && referrerPolicy !== 'no-referrer') {\n    (0, _log.user)().error(TAG, 'Unsupported referrerPolicy: %s', referrerPolicy);\n  }\n\n  return referrerPolicy === 'no-referrer' ? createNoReferrerPixel(win, src) : createImagePixel(win, src);\n}\n/**\n * @param {!Window} win\n * @param {string} src\n * @return {!Element}\n */\n\n\nfunction createNoReferrerPixel(win, src) {\n  if (isReferrerPolicySupported()) {\n    return createImagePixel(win, src, true);\n  } else {\n    // if \"referrerPolicy\" is not supported, use iframe wrapper\n    // to scrub the referrer.\n    var iframe = (0, _dom.createElementWithAttributes)(\n    /** @type {!Document} */\n    win.document, 'iframe', (0, _object.dict)({\n      'src': 'about:blank',\n      'style': 'display:none'\n    }));\n    win.document.body.appendChild(iframe);\n    createImagePixel(iframe.contentWindow, src);\n    return iframe;\n  }\n}\n/**\n * @param {!Window} win\n * @param {string} src\n * @param {boolean=} noReferrer\n * @return {!Image}\n */\n\n\nfunction createImagePixel(win, src, noReferrer) {\n  if (noReferrer === void 0) {\n    noReferrer = false;\n  }\n\n  var Image = _windowInterface.WindowInterface.getImage(win);\n\n  var image = new Image();\n\n  if (noReferrer) {\n    image.referrerPolicy = 'no-referrer';\n  }\n\n  image.src = src;\n  return image;\n}\n/**\n * Check if element attribute \"referrerPolicy\" is supported by the browser.\n * Safari 11.1 does not support it yet.\n *\n * @return {boolean}\n */\n\n\nfunction isReferrerPolicySupported() {\n  return 'referrerPolicy' in Image.prototype;\n}\n\n},{\"../src/dom\":41,\"../src/log\":68,\"../src/utils/object\":145,\"../src/window-interface\":152}],74:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.install = install;\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @typedef {{\n *   promise: !Promise<undefined>,\n *   resolve: function(),\n * }}\n */\nvar DeferredDef;\n/**\n * @typedef {!Function}\n */\n\nvar CustomElementConstructorDef;\n/**\n * @typedef {{\n *  name: string,\n *  ctor: !CustomElementConstructorDef,\n * }}\n */\n\nvar CustomElementDef;\n/**\n * Validates the custom element's name.\n * This intentionally ignores \"valid\" higher Unicode Code Points.\n * https://html.spec.whatwg.org/multipage/custom-elements.html#valid-custom-element-name\n */\n\nvar VALID_NAME = /^[a-z][a-z0-9._]*-[a-z0-9._-]*$/;\nvar INVALID_NAMES = ['annotation-xml', 'color-profile', 'font-face', 'font-face-src', 'font-face-uri', 'font-face-format', 'font-face-name', 'missing-glyph'];\n/**\n * A MutationObserverInit dictionary to track subtree modifications.\n */\n\nvar TRACK_SUBTREE = {\n  'childList': true,\n  'subtree': true\n};\n/**\n * Asserts that the custom element name conforms to the spec.\n *\n * @param {!Function} SyntaxError\n * @param {string} name\n */\n\nfunction assertValidName(SyntaxError, name) {\n  if (!VALID_NAME.test(name) || INVALID_NAMES.includes(name)) {\n    throw new SyntaxError(\"invalid custom element name \\\"\" + name + \"\\\"\");\n  }\n}\n/**\n * Does win have a full Custom Elements registry?\n *\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nfunction hasCustomElements(win) {\n  var customElements = win.customElements;\n  return !!(customElements && customElements.define && customElements.get && customElements.whenDefined);\n}\n/**\n * Was HTMLElement already patched for this window?\n *\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nfunction isPatched(win) {\n  var tag = win.HTMLElement.toString();\n  return tag.indexOf('[native code]') === -1;\n}\n/**\n * Throws the error outside the current event loop.\n *\n * @param {!Error} error\n */\n\n\nfunction rethrowAsync(error) {\n  new\n  /*OK*/\n  Promise(function () {\n    throw error;\n  });\n}\n/**\n * The public Custom Elements API.\n */\n\n\nvar CustomElementRegistry =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   * @param {!Registry} registry\n   */\n  function CustomElementRegistry(win, registry) {\n    /**\n     * @const @private\n     */\n    this.win_ = win;\n    /**\n     * @const @private\n     */\n\n    this.registry_ = registry;\n    /**\n     * @type {!Object<string, DeferredDef>}\n     * @private\n     * @const\n     */\n\n    this.pendingDefines_ = win.Object.create(null);\n  }\n  /**\n   * Register the custom element.\n   *\n   * @param {string} name\n   * @param {!CustomElementConstructorDef} ctor\n   * @param {!Object=} options\n   */\n\n\n  var _proto = CustomElementRegistry.prototype;\n\n  _proto.define = function define(name, ctor, options) {\n    this.registry_.define(name, ctor, options); // If anyone is waiting for this custom element to be defined, resolve\n    // their promise.\n\n    var pending = this.pendingDefines_;\n    var deferred = pending[name];\n\n    if (deferred) {\n      deferred.resolve();\n      delete pending[name];\n    }\n  }\n  /**\n   * Get the constructor of the (already defined) custom element.\n   *\n   * @param {string} name\n   * @return {!CustomElementConstructorDef|undefined}\n   */\n  ;\n\n  _proto.get = function get(name) {\n    var def = this.registry_.getByName(name);\n\n    if (def) {\n      return def.ctor;\n    }\n  }\n  /**\n   * Returns a promise that waits until the custom element is defined.\n   * If the custom element is already defined, returns a resolved promise.\n   *\n   * @param {string} name\n   * @return {!Promise<undefined>}\n   */\n  ;\n\n  _proto.whenDefined = function whenDefined(name) {\n    var _this$win_ = this.win_,\n        Promise = _this$win_.Promise,\n        SyntaxError = _this$win_.SyntaxError;\n    assertValidName(SyntaxError, name);\n\n    if (this.registry_.getByName(name)) {\n      return Promise.resolve();\n    }\n\n    var pending = this.pendingDefines_;\n    var deferred = pending[name];\n\n    if (deferred) {\n      return deferred.promise;\n    }\n\n    var resolve;\n    var promise = new\n    /*OK*/\n    Promise(function (res) {\n      return resolve = res;\n    });\n    pending[name] = {\n      promise: promise,\n      resolve: resolve\n    };\n    return promise;\n  }\n  /**\n   * Upgrade all custom elements inside root.\n   *\n   * @param {!Node} root\n   */\n  ;\n\n  _proto.upgrade = function upgrade(root) {\n    this.registry_.upgrade(root);\n  };\n\n  return CustomElementRegistry;\n}();\n/**\n * This internal APIs necessary to run the CustomElementRegistry.\n * Since Registry is never exposed externally, all methods are actually\n * available on the instance.\n */\n\n\nvar Registry =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function Registry(win) {\n    /**\n     * @private @const\n     */\n    this.win_ = win;\n    /**\n     * @private @const\n     */\n\n    this.doc_ = win.document;\n    /**\n     * @type {!Object<string, !CustomElementDef>}\n     * @private\n     * @const\n     */\n\n    this.definitions_ = win.Object.create(null);\n    /**\n     * A up-to-date DOM selector for all custom elements.\n     * @type {string}\n     */\n\n    this.query_ = '';\n    /**\n     * The currently upgrading element.\n     * @private {Element}\n     */\n\n    this.current_ = null;\n    /**\n     * Once started (after the first Custom Element definition), this tracks\n     * DOM append and removals.\n     *\n     * @private {MutationObserver}\n     */\n\n    this.mutationObserver_ = null;\n    /**\n     * All the observed DOM trees, including shadow trees. This is cleared out\n     * when the mutation observer is created.\n     *\n     * @private @const {!Array<!Node>}\n     */\n\n    this.observed_ = [win.document];\n  }\n  /**\n   * The currently-being-upgraded custom element.\n   *\n   * When an already created (through the DOM parsing APIs, or innerHTML)\n   * custom element node is being upgraded, we can't just create a new node\n   * (it's illegal in the spec). But we still need to run the custom element's\n   * constructor code on the node. We avoid this conundrum by running the\n   * constructor while returning this current node in the HTMLElement\n   * class constructor (the base class of all custom elements).\n   *\n   * @return {Element}\n   */\n\n\n  var _proto2 = Registry.prototype;\n\n  _proto2.current = function current() {\n    var current = this.current_;\n    this.current_ = null;\n    return current;\n  }\n  /**\n   * Finds the custom element definition by name.\n   *\n   * @param {string} name\n   * @return {CustomElementDef|undefined}\n   */\n  ;\n\n  _proto2.getByName = function getByName(name) {\n    var definition = this.definitions_[name];\n\n    if (definition) {\n      return definition;\n    }\n  }\n  /**\n   * Finds the custom element definition by constructor instance.\n   *\n   * @param {CustomElementConstructorDef} ctor\n   * @return {CustomElementDef|undefined}\n   */\n  ;\n\n  _proto2.getByConstructor = function getByConstructor(ctor) {\n    var definitions = this.definitions_;\n\n    for (var name in definitions) {\n      var def = definitions[name];\n\n      if (def.ctor === ctor) {\n        return def;\n      }\n    }\n  }\n  /**\n   * Registers the custom element definition, and upgrades all elements by that\n   * name in the root document.\n   *\n   * @param {string} name\n   * @param {!CustomElementConstructorDef} ctor\n   * @param {!Object|undefined} options\n   */\n  ;\n\n  _proto2.define = function define(name, ctor, options) {\n    var _this$win_2 = this.win_,\n        Error = _this$win_2.Error,\n        SyntaxError = _this$win_2.SyntaxError;\n\n    if (options) {\n      throw new Error('Extending native custom elements is not supported');\n    }\n\n    assertValidName(SyntaxError, name);\n\n    if (this.getByName(name) || this.getByConstructor(ctor)) {\n      throw new Error(\"duplicate definition \\\"\" + name + \"\\\"\");\n    } // TODO(jridgewell): Record connectedCallback, disconnectedCallback,\n    // adoptedCallback, attributeChangedCallback, and observedAttributes.\n    // TODO(jridgewell): If attributeChangedCallback, gather observedAttributes\n\n\n    this.definitions_[name] = {\n      name: name,\n      ctor: ctor\n    };\n    this.observe_(name);\n    this.upgrade(this.doc_, name);\n  }\n  /**\n   * Upgrades custom elements descendants of root (but not including root).\n   *\n   * When called with an opt_query, it both upgrades and connects the custom\n   * elements (this is used during the custom element define algorithm).\n   *\n   * @param {!Node} root\n   * @param {string=} opt_query\n   */\n  ;\n\n  _proto2.upgrade = function upgrade(root, opt_query) {\n    // Only CustomElementRegistry.p.define provides a query (the newly defined\n    // custom element). In this case, we are both upgrading _and_ connecting\n    // the custom elements.\n    var newlyDefined = !!opt_query;\n    var query = opt_query || this.query_;\n    var upgradeCandidates = this.queryAll_(root, query);\n\n    for (var i = 0; i < upgradeCandidates.length; i++) {\n      var candidate = upgradeCandidates[i];\n\n      if (newlyDefined) {\n        this.connectedCallback_(candidate);\n      } else {\n        this.upgradeSelf(candidate);\n      }\n    }\n  }\n  /**\n   * Upgrades the custom element node, if a custom element has been registered\n   * by this name.\n   *\n   * @param {!Node} node\n   */\n  ;\n\n  _proto2.upgradeSelf = function upgradeSelf(node) {\n    var def = this.getByName(node.localName);\n\n    if (!def) {\n      return;\n    }\n\n    this.upgradeSelf_(\n    /** @type {!Element} */\n    node, def);\n  }\n  /**\n   * @param {!Node} root\n   * @param {string} query\n   * @return {!Array|!NodeList}\n   */\n  ;\n\n  _proto2.queryAll_ = function queryAll_(root, query) {\n    if (!query || !root.querySelectorAll) {\n      // Nothing to do...\n      return [];\n    }\n\n    return root.querySelectorAll(query);\n  }\n  /**\n   * Upgrades the (already created via DOM parsing) custom element.\n   *\n   * @param {!Element} node\n   * @param {!CustomElementDef} def\n   */\n  ;\n\n  _proto2.upgradeSelf_ = function upgradeSelf_(node, def) {\n    var ctor = def.ctor;\n\n    if (node instanceof ctor) {\n      return;\n    } // Despite how it looks, this is not a useless construction.\n    // HTMLElementPolyfill (the base class of all custom elements) will return\n    // the current node, allowing the custom element's subclass constructor to\n    // run on the node. The node itself is already constructed, so the return\n    // value is just the node.\n\n\n    this.current_ = node;\n\n    try {\n      var el = new ctor();\n\n      if (el !== node) {\n        throw new this.win_.Error('Constructor illegally returned a different instance.');\n      }\n    } catch (e) {\n      rethrowAsync(e);\n    }\n  }\n  /**\n   * Fires connectedCallback on the custom element, if it has one.\n   * This also upgrades the custom element, since it may not have been\n   * accessible via the root document before (a detached DOM tree).\n   *\n   * @param {!Node} node\n   */\n  ;\n\n  _proto2.connectedCallback_ = function connectedCallback_(node) {\n    var def = this.getByName(node.localName);\n\n    if (!def) {\n      return;\n    }\n\n    this.upgradeSelf_(\n    /** @type {!Element} */\n    node, def); // TODO(jridgewell): It may be appropriate to adoptCallback, if the node\n    // used to be in another doc.\n    // TODO(jridgewell): I should be calling the definitions connectedCallback\n    // with node as the context.\n\n    if (node.connectedCallback) {\n      try {\n        node.connectedCallback();\n      } catch (e) {\n        rethrowAsync(e);\n      }\n    }\n  }\n  /**\n   * Fires disconnectedCallback on the custom element, if it has one.\n   *\n   * @param {!Node} node\n   */\n  ;\n\n  _proto2.disconnectedCallback_ = function disconnectedCallback_(node) {\n    // TODO(jridgewell): I should be calling the definitions connectedCallback\n    // with node as the context.\n    if (node.disconnectedCallback) {\n      try {\n        node.disconnectedCallback();\n      } catch (e) {\n        rethrowAsync(e);\n      }\n    }\n  }\n  /**\n   * Records name as a registered custom element to observe.\n   *\n   * Starts the Mutation Observer if this is the first registered custom\n   * element. This is deferred until the first custom element is defined to\n   * speed up initial rendering of the page.\n   *\n   * Mutation Observers are conveniently available in every browser we care\n   * about. When a node is connected to the root document, all custom\n   * elements (including that node iteself) will be upgraded and call\n   * connectedCallback. When a node is disconnectedCallback from the root\n   * document, all custom elements will call disconnectedCallback.\n   *\n   * @param {string} name\n   */\n  ;\n\n  _proto2.observe_ = function observe_(name) {\n    var _this = this;\n\n    if (this.query_) {\n      this.query_ += \",\" + name;\n      return;\n    }\n\n    this.query_ = name; // The first registered name starts the mutation observer.\n\n    var mo = new this.win_.MutationObserver(function (records) {\n      if (records) {\n        _this.handleRecords_(records);\n      }\n    });\n    this.mutationObserver_ = mo;\n    this.observed_.forEach(function (tree) {\n      mo.observe(tree, TRACK_SUBTREE);\n    });\n    this.observed_.length = 0;\n    installPatches(this.win_, this);\n  }\n  /**\n   * Adds the shadow tree to be observed by the polyfill.\n   *\n   * @param {!Node} tree\n   */\n  ;\n\n  _proto2.observe = function observe(tree) {\n    if (this.mutationObserver_) {\n      this.mutationObserver_.observe(tree, TRACK_SUBTREE);\n    } else {\n      this.observed_.push(tree);\n    }\n  }\n  /**\n   * This causes a synchronous handling of all the Mutation Observer's tracked\n   * mutations. This does nothing until the mutation observer is actually\n   * registered on the first Custom Element definition.\n   */\n  ;\n\n  _proto2.sync = function sync() {\n    if (this.mutationObserver_) {\n      this.handleRecords_(this.mutationObserver_.takeRecords());\n    }\n  }\n  /**\n   * Handle all the Mutation Observer's Mutation Records.\n   * All added custom elements will be upgraded (if not already) and call\n   * connectedCallback. All removed custom elements will call\n   * disconnectedCallback.\n   *\n   * @param {!Array<!MutationRecord>} records\n   */\n  ;\n\n  _proto2.handleRecords_ = function handleRecords_(records) {\n    for (var i = 0; i < records.length; i++) {\n      var record = records[i];\n\n      if (!record) {\n        continue;\n      }\n\n      var addedNodes = record.addedNodes,\n          removedNodes = record.removedNodes;\n\n      for (var _i = 0; _i < addedNodes.length; _i++) {\n        var node = addedNodes[_i];\n        var connectedCandidates = this.queryAll_(node, this.query_);\n        this.connectedCallback_(node);\n\n        for (var _i2 = 0; _i2 < connectedCandidates.length; _i2++) {\n          this.connectedCallback_(connectedCandidates[_i2]);\n        }\n      }\n\n      for (var _i3 = 0; _i3 < removedNodes.length; _i3++) {\n        var _node = removedNodes[_i3];\n        var disconnectedCandidates = this.queryAll_(_node, this.query_);\n        this.disconnectedCallback_(_node);\n\n        for (var _i4 = 0; _i4 < disconnectedCandidates.length; _i4++) {\n          this.disconnectedCallback_(disconnectedCandidates[_i4]);\n        }\n      }\n    }\n  };\n\n  return Registry;\n}();\n/**\n * Patches the DOM APIs to support synchronous Custom Elements.\n * @param {!Window} win\n * @param {!Registry} registry\n */\n\n\nfunction installPatches(win, registry) {\n  var Document = win.Document,\n      Element = win.Element,\n      Node = win.Node,\n      Object = win.Object,\n      document = win.document;\n  var docProto = Document.prototype;\n  var elProto = Element.prototype;\n  var nodeProto = Node.prototype;\n  var createElement = docProto.createElement,\n      importNode = docProto.importNode;\n  var appendChild = nodeProto.appendChild,\n      cloneNode = nodeProto.cloneNode,\n      insertBefore = nodeProto.insertBefore,\n      removeChild = nodeProto.removeChild,\n      replaceChild = nodeProto.replaceChild; // Patch createElement to immediately upgrade the custom element.\n  // This has the added benefit that it avoids the \"already created but needs\n  // constructor code run\" chicken-and-egg problem.\n\n  docProto.createElement = function (name) {\n    var def = registry.getByName(name);\n\n    if (def) {\n      return new def.ctor();\n    }\n\n    return createElement.apply(this, arguments);\n  }; // Patch importNode to immediately upgrade custom elements.\n  // TODO(jridgewell): Can fire adoptedCallback for cross doc imports.\n\n\n  docProto.importNode = function () {\n    var imported = importNode.apply(this, arguments); // Only upgrade elements if the document that the nodes were imported into\n    // is _this_ document. If it's another document, then that document's\n    // element registry must do the upgrade.\n    // Eg, when importing from a <template>, the cloned document fragment\n    // should be upgraded. But importing from document into the <template>\n    // should not.\n\n    if (imported && this === document) {\n      registry.upgradeSelf(imported);\n      registry.upgrade(imported);\n    }\n\n    return imported;\n  }; // Patch appendChild to upgrade custom elements before returning.\n\n\n  nodeProto.appendChild = function () {\n    var appended = appendChild.apply(this, arguments);\n    registry.sync();\n    return appended;\n  }; // Patch insertBefore to upgrade custom elements before returning.\n\n\n  nodeProto.insertBefore = function () {\n    var inserted = insertBefore.apply(this, arguments);\n    registry.sync();\n    return inserted;\n  }; // Patch removeChild to upgrade custom elements before returning.\n\n\n  nodeProto.removeChild = function () {\n    var removed = removeChild.apply(this, arguments);\n    registry.sync();\n    return removed;\n  }; // Patch replaceChild to upgrade and detach custom elements before returning.\n\n\n  nodeProto.replaceChild = function () {\n    var replaced = replaceChild.apply(this, arguments);\n    registry.sync();\n    return replaced;\n  }; // Patch cloneNode to immediately upgrade custom elements.\n\n\n  nodeProto.cloneNode = function () {\n    var cloned = cloneNode.apply(this, arguments); // Only upgrade elements if the cloned node belonged to _this_ document.\n    // Eg, when cloning a <template>'s content, the cloned document fragment\n    // does not belong to this document.\n\n    if (cloned.ownerDocument === document) {\n      registry.upgradeSelf(cloned);\n      registry.upgrade(cloned);\n    }\n\n    return cloned;\n  }; // Patch the innerHTML setter to immediately upgrade custom elements.\n  // Note, this could technically fire connectedCallbacks if this node was\n  // connected, but we leave that to the Mutation Observer.\n\n\n  var innerHTMLProto = elProto;\n  var innerHTMLDesc = Object.getOwnPropertyDescriptor(innerHTMLProto, 'innerHTML');\n\n  if (!innerHTMLDesc) {\n    // Sigh... IE11 puts innerHTML desciptor on HTMLElement. But, we've\n    // replaced HTMLElement with a polyfill wrapper, so have to get its proto.\n    innerHTMLProto =\n    /** @type {!Object} */\n    win.HTMLElement.prototype.__proto__;\n    innerHTMLDesc = Object.getOwnPropertyDescriptor(innerHTMLProto, 'innerHTML');\n  }\n\n  var innerHTMLSetter = innerHTMLDesc.set;\n\n  innerHTMLDesc.set = function (html) {\n    innerHTMLSetter.call(this, html);\n    registry.upgrade(this);\n  };\n\n  Object.defineProperty(innerHTMLProto, 'innerHTML', innerHTMLDesc);\n}\n/**\n * Does the polyfilling.\n * @param {!Window} win\n */\n\n\nfunction polyfill(win) {\n  var Element = win.Element,\n      HTMLElement = win.HTMLElement,\n      Object = win.Object,\n      document = win.document;\n  var createElement = document.createElement;\n  var registry = new Registry(win);\n  var customElements = new CustomElementRegistry(win, registry); // Expose the custom element registry.\n  // Object.getOwnPropertyDescriptor(window, 'customElements')\n  // {get: , set: undefined, enumerable: true, configurable: true}\n\n  Object.defineProperty(win, 'customElements', {\n    enumerable: true,\n    configurable: true,\n    // writable: false,\n    value: customElements\n  }); // Have to patch shadow methods now, since there's no way to find shadow trees\n  // later.\n\n  var elProto = Element.prototype;\n  var attachShadow = elProto.attachShadow,\n      createShadowRoot = elProto.createShadowRoot;\n\n  if (attachShadow) {\n    /**\n     * @param {!{mode: string}} unused\n     * @return {!ShadowRoot}\n     */\n    elProto.attachShadow = function (unused) {\n      var shadow = attachShadow.apply(this, arguments);\n      registry.observe(shadow);\n      return shadow;\n    }; // Necessary for Shadow AMP\n\n\n    elProto.attachShadow.toString = function () {\n      return attachShadow.toString();\n    };\n  }\n\n  if (createShadowRoot) {\n    /**\n     * @return {!ShadowRoot}\n     */\n    elProto.createShadowRoot = function () {\n      var shadow = createShadowRoot.apply(this, arguments);\n      registry.observe(shadow);\n      return shadow;\n    }; // Necessary for Shadow AMP\n\n\n    elProto.createShadowRoot.toString = function () {\n      return createShadowRoot.toString();\n    };\n  }\n  /**\n   * You can't use the real HTMLElement constructor, because you can't subclass\n   * it without using native classes. So, mock its approximation using\n   * createElement.\n   * @return {*} TODO(#23582): Specify return type\n   */\n\n\n  function HTMLElementPolyfill() {\n    var constructor = this.constructor; // If we're upgrading an already created custom element, we can't create\n    // another new node (by the spec, it must be the same node).\n\n    var el = registry.current(); // If there's not a already created custom element, we're being invoked via\n    // `new`ing the constructor.\n    //\n    // Technically, we could get here via createElement, but we patched that.\n    // If it the custom element was registered, the patch turned it into a\n    // `new` call.\n    // If it was not registered, the native createElement is used. And if\n    // native createElement is being used and we got to this code, we're really\n    // in an infinite loop (a native createElement call just below) so we've\n    // got bigger problems.\n    //\n    // So just take my word we got here via `new`.\n\n    if (!el) {\n      // The custom element definition is an invariant. If the custom element\n      // is registered, everything works. If it's not, it throws in the member\n      // property access (only defined custom elements can be directly\n      // constructed via `new`).\n      var def = registry.getByConstructor(constructor);\n      el = createElement.call(document, def.name);\n    } // Finally, if the node was already constructed, we need to reset its\n    // prototype to the custom element prototype. And if it wasn't already\n    // constructed, we created a new node via native createElement, and we need\n    // to reset its prototype. Basically always reset the prototype.\n\n\n    el.__proto__ = constructor.prototype;\n    return el;\n  }\n\n  subClass(Object, HTMLElement, HTMLElementPolyfill); // Expose the polyfilled HTMLElement constructor for everyone to extend from.\n\n  win.HTMLElement = HTMLElementPolyfill;\n}\n/**\n * Wraps HTMLElement in a Reflect.construct constructor, so that transpiled\n * classes can `_this = superClass.call(this)` during their construction.\n *\n * This is only used when Custom Elements v1 is already available _and_ we're\n * using transpiled classes (which use ES5 construction idioms).\n *\n * @param {!Window} win\n * @suppress {globalThis}\n */\n\n\nfunction wrapHTMLElement(win) {\n  var HTMLElement = win.HTMLElement,\n      Reflect = win.Reflect,\n      Object = win.Object;\n  /**\n   * @return {!Element}\n   */\n\n  function HTMLElementWrapper() {\n    var ctor =\n    /** @type {function(...?):?|undefined} */\n    this.constructor; // Reflect.construct allows us to construct a new HTMLElement without using\n    // `new` (which will always fail because native HTMLElement is a restricted\n    // constructor).\n\n    return Reflect.construct(HTMLElement, [], ctor);\n  }\n\n  subClass(Object, HTMLElement, HTMLElementWrapper); // Expose the wrapped HTMLElement constructor for everyone to extend from.\n\n  win.HTMLElement = HTMLElementWrapper;\n}\n/**\n * Setups up prototype inheritance\n *\n * @param {!Object} Object\n * @param {!Function} superClass\n * @param {!Function} subClass\n */\n\n\nfunction subClass(Object, superClass, subClass) {\n  // Object.getOwnPropertyDescriptor(superClass.prototype, 'constructor')\n  // {value: , writable: true, enumerable: false, configurable: true}\n  subClass.prototype = Object.create(superClass.prototype, {\n    constructor: {\n      // enumerable: false,\n      configurable: true,\n      writable: true,\n      value: subClass\n    }\n  });\n  subClass.__proto__ = superClass;\n}\n/**\n * Polyfills Custom Elements v1 API. This has 5 modes:\n *\n * 1. Custom elements v1 already supported, using native classes\n * 2. Custom elements v1 already supported, using transpiled classes\n * 3. Custom elements v1 not supported, using native classes\n * 4. Custom elements v1 not supported, using transpiled classes\n * 5. No sample class constructor provided\n *\n * In mode 1, nothing is done. In mode 2, a minimal polyfill is used to support\n * extending the HTMLElement base class. In mode 3, 4, and 5 a full polyfill is\n * done.\n *\n * @param {!Window} win\n * @param {!Function=} opt_ctor\n */\n\n\nfunction install(win, opt_ctor) {\n  // Don't install in no-DOM environments e.g. worker.\n  var shouldInstall = win.document;\n  var hasCE = hasCustomElements(win);\n\n  if (!shouldInstall || hasCE && isPatched(win)) {\n    return;\n  }\n\n  var install = true;\n  var installWrapper = false;\n\n  if (opt_ctor && hasCE) {\n    // If ctor is constructable without new, it's a function. That means it was\n    // compiled down, and we need to do the minimal polyfill because all you\n    // cannot extend HTMLElement without native classes.\n    try {\n      var _Object = win.Object,\n          _Reflect = win.Reflect; // \"Construct\" ctor using ES5 idioms\n\n      var instance = _Object.create(opt_ctor.prototype);\n\n      opt_ctor.call(instance); // If that succeeded, we're in a transpiled environment\n      // Let's find out if we can wrap HTMLElement and avoid a full patch.\n\n      installWrapper = !!(_Reflect && _Reflect.construct);\n    } catch (e) {\n      // The ctor threw when we constructed is via ES5, so it's a real class.\n      // We're ok to not install the polyfill.\n      install = false;\n    }\n  }\n\n  if (installWrapper) {\n    wrapHTMLElement(win);\n  } else if (install) {\n    polyfill(win);\n  }\n}\n\n},{}],75:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.install = install;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Polyfill for `document.contains()` method. Notice that according to spec\n * `document.contains` is inclusionary.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/contains\n * @param {?Node} node\n * @return {boolean}\n * @this {Node}\n */\nfunction documentContainsPolyfill(node) {\n  // Per spec, \"contains\" method is inclusionary\n  // i.e. `node.contains(node) == true`. However, we still need to test\n  // equality to the document itself.\n  return node == this || this.documentElement.contains(node);\n}\n/**\n * Polyfills `HTMLDocument.contains` API.\n * @param {!Window} win\n */\n\n\nfunction install(win) {\n  // HTMLDocument is undefined in Internet Explorer 10, but it has Document,\n  // so we use that as a fallback.\n  var documentClass = win.HTMLDocument || win.Document;\n\n  if (documentClass && !documentClass.prototype.contains) {\n    win.Object.defineProperty(documentClass.prototype, 'contains', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: documentContainsPolyfill\n    });\n  }\n}\n\n},{}],76:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.install = install;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Polyfill for `DOMTokenList.prototype.toggle(token, opt_force)` method. This\n * is specially important because IE does not support `opt_force` attribute. See\n * https://goo.gl/hgKNYY for details.\n * @param {string} token\n * @param {boolean=} opt_force\n * @this {DOMTokenList}\n * @return {boolean}\n */\nfunction domTokenListTogglePolyfill(token, opt_force) {\n  var remove = opt_force === undefined ? this.contains(token) : !opt_force;\n\n  if (remove) {\n    this.remove(token);\n    return false;\n  } else {\n    this.add(token);\n    return true;\n  }\n}\n/**\n * Polyfills `DOMTokenList.prototype.toggle` API and makes `.add` accepts N\n * classes in IE.\n * @param {!Window} win\n */\n\n\nfunction install(win) {\n  if (isIe(win) && win.DOMTokenList) {\n    win.Object.defineProperty(win.DOMTokenList.prototype, 'toggle', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: domTokenListTogglePolyfill\n    });\n    var add = win.DOMTokenList.prototype.add;\n\n    win.DOMTokenList.prototype.add = function () {\n      for (var i = 0; i < arguments.length; i++) {\n        add.call(this, arguments[i]);\n      }\n    };\n  }\n}\n/**\n * Whether the current browser is a IE browser.\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nfunction isIe(win) {\n  return /Trident|MSIE|IEMobile/i.test(win.navigator.userAgent);\n}\n\n},{}],77:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.setPreconnectFeaturesForTesting = setPreconnectFeaturesForTesting;\nexports.preconnectForElement = preconnectForElement;\nexports.preconnectToOrigin = preconnectToOrigin;\nexports.Preconnect = void 0;\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _service = require(\"./service\");\n\nvar _staticTemplate = require(\"./static-template\");\n\nvar _url3 = require(\"./url\");\n\nvar _string = require(\"./string\");\n\nvar _types = require(\"./types\");\n\nvar _documentReady = require(\"./document-ready\");\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteralLoose([\"\\n        <link rel=\\\"preload\\\" referrerpolicy=\\\"origin\\\" />\"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _taggedTemplateLiteralLoose(strings, raw) { if (!raw) { raw = strings.slice(0); } strings.raw = raw; return strings; }\n\nvar ACTIVE_CONNECTION_TIMEOUT_MS = 180 * 1000;\nvar PRECONNECT_TIMEOUT_MS = 10 * 1000;\n/**\n * @typedef {{\n *   preload: (boolean|undefined),\n *   preconnect: (boolean|undefined)\n * }}\n */\n\nvar PreconnectFeaturesDef;\n/** @private {?PreconnectFeaturesDef} */\n\nvar preconnectFeatures = null;\n/**\n * Detect related features if feature detection is supported by the\n * browser. Even if this fails, the browser may support the feature.\n * @param {!Window} win\n * @return {!PreconnectFeaturesDef}\n */\n\nfunction getPreconnectFeatures(win) {\n  if (!preconnectFeatures) {\n    var linkTag = win.document.createElement('link');\n    var tokenList = linkTag['relList'];\n    linkTag.as = 'invalid-value';\n\n    if (!tokenList || !tokenList.supports) {\n      return {};\n    }\n\n    preconnectFeatures = {\n      preconnect: tokenList.supports('preconnect'),\n      preload: tokenList.supports('preload'),\n      onlyValidAs: linkTag.as != 'invalid-value'\n    };\n  }\n\n  return preconnectFeatures;\n}\n/**\n * @param {?PreconnectFeaturesDef} features\n */\n\n\nfunction setPreconnectFeaturesForTesting(features) {\n  preconnectFeatures = features;\n}\n\nvar PreconnectService =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function PreconnectService(win) {\n    /** @private @const {!Document} */\n    this.document_ = win.document;\n    /** @private @const {!Element} */\n\n    this.head_ = (0, _log.dev)().assertElement(win.document.head);\n    /**\n     * Origin we've preconnected to and when that connection\n     * expires as a timestamp in MS.\n     * @private @const {!Object<string, number>}\n     */\n\n    this.origins_ = {};\n    /**\n     * Urls we've prefetched.\n     * @private @const {!Object<string, boolean>}\n     */\n\n    this.urls_ = {};\n    /** @private @const {!./service/platform-impl.Platform}  */\n\n    this.platform_ = _services.Services.platformFor(win); // Mark current origin as preconnected.\n\n    this.origins_[(0, _url3.parseUrlDeprecated)(win.location.href).origin] = true;\n    /**\n     * Detect support for the given resource hints.\n     * Unfortunately not all browsers support this, so this can only\n     * be used as an affirmative signal.\n     * @private @const {!PreconnectFeaturesDef}\n     */\n\n    this.features_ = getPreconnectFeatures(win);\n    /** @private @const {!./service/timer-impl.Timer} */\n\n    this.timer_ = _services.Services.timerFor(win);\n  }\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   */\n\n\n  var _proto = PreconnectService.prototype;\n\n  _proto.url = function url(ampdoc, _url, opt_alsoConnecting) {\n    var _this = this;\n\n    ampdoc.whenFirstVisible().then(function () {\n      _this.url_(ampdoc, _url, opt_alsoConnecting);\n    });\n  }\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   * @private\n   */\n  ;\n\n  _proto.url_ = function url_(ampdoc, url, opt_alsoConnecting) {\n    if (!this.isInterestingUrl_(url)) {\n      return;\n    }\n\n    var _parseUrlDeprecated = (0, _url3.parseUrlDeprecated)(url),\n        origin = _parseUrlDeprecated.origin;\n\n    var now = Date.now();\n    var lastPreconnectTimeout = this.origins_[origin];\n\n    if (lastPreconnectTimeout && now < lastPreconnectTimeout) {\n      if (opt_alsoConnecting) {\n        this.origins_[origin] = now + ACTIVE_CONNECTION_TIMEOUT_MS;\n      }\n\n      return;\n    } // If we are about to use the connection, don't re-preconnect for\n    // 180 seconds.\n\n\n    var timeout = opt_alsoConnecting ? ACTIVE_CONNECTION_TIMEOUT_MS : PRECONNECT_TIMEOUT_MS;\n    this.origins_[origin] = now + timeout; // If we know that preconnect is supported, there is no need to do\n    // dedicated dns-prefetch.\n\n    var dns;\n\n    if (!this.features_.preconnect) {\n      dns = this.document_.createElement('link');\n      dns.setAttribute('rel', 'dns-prefetch');\n      dns.setAttribute('href', origin);\n      this.head_.appendChild(dns);\n    }\n\n    var preconnect = this.document_.createElement('link');\n    preconnect.setAttribute('rel', 'preconnect');\n    preconnect.setAttribute('href', origin);\n    preconnect.setAttribute('referrerpolicy', 'origin');\n    this.head_.appendChild(preconnect); // Remove the tags eventually to free up memory.\n\n    this.timer_.delay(function () {\n      if (dns && dns.parentNode) {\n        dns.parentNode.removeChild(dns);\n      }\n\n      if (preconnect.parentNode) {\n        preconnect.parentNode.removeChild(preconnect);\n      }\n    }, 10000);\n    this.preconnectPolyfill_(ampdoc, origin);\n  }\n  /**\n   * Asks the browser to preload a URL. Always also does a preconnect\n   * because browser support for that is better.\n   *\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {string=} opt_preloadAs\n   */\n  ;\n\n  _proto.preload = function preload(ampdoc, url, opt_preloadAs) {\n    var _this2 = this;\n\n    if (!this.isInterestingUrl_(url)) {\n      return;\n    }\n\n    if (this.urls_[url]) {\n      return;\n    }\n\n    this.urls_[url] = true;\n    this.url(ampdoc, url,\n    /* opt_alsoConnecting */\n    true);\n\n    if (!this.features_.preload) {\n      return;\n    }\n\n    if (opt_preloadAs == 'document' && this.platform_.isSafari()) {\n      // Preloading documents currently does not work in Safari,\n      // because it\n      // - does not support preloading iframes\n      // - and uses a different cache for iframes (when loaded without\n      //   as attribute).\n      return;\n    }\n\n    ampdoc.whenFirstVisible().then(function () {\n      _this2.performPreload_(url);\n    });\n  }\n  /**\n   * Performs a preload using `<link rel=\"preload\">`.\n   * @param {string} url\n   * @private\n   */\n  ;\n\n  _proto.performPreload_ = function performPreload_(url) {\n    var preload = (0, _staticTemplate.htmlFor)(this.document_)(_templateObject());\n    preload.setAttribute('href', url); // Do not set 'as' attribute to correct value for now, for 2 reasons\n    // - document value is not yet supported and dropped\n    // - script is blocked due to CSP.\n    // Due to spec change we now have to also preload with the \"as\"\n    // being set to `fetch` when it would previously would be empty.\n    // See https://github.com/w3c/preload/issues/80\n    // for details.\n\n    if (this.features_.onlyValidAs) {\n      preload.as = 'fetch';\n    } else {\n      preload.as = '';\n    }\n\n    this.head_.appendChild(preload); // As opposed to preconnect we do not clean this tag up, because there is\n    // no expectation as to it having an immediate effect.\n  }\n  /**\n   * Skips over non HTTP/HTTPS URL.\n   * @param {string} url\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isInterestingUrl_ = function isInterestingUrl_(url) {\n    if ((0, _string.startsWith)(url, 'https:') || (0, _string.startsWith)(url, 'http:')) {\n      return true;\n    }\n\n    return false;\n  }\n  /**\n   * Safari does not support preconnecting, but due to its significant\n   * performance benefits we implement this crude polyfill.\n   *\n   * We make an image connection to a \"well-known\" file on the origin adding\n   * a random query string to bust the cache (no caching because we do want to\n   * actually open the connection).\n   *\n   * This should get us an open SSL connection to these hosts and significantly\n   * speed up the next connections.\n   *\n   * The actual URL is expected to 404. If you see errors for\n   * amp_preconnect_polyfill in your DevTools console or server log:\n   * This is expected and fine to leave as is. Its fine to send a non 404\n   * response, but please make it small :)\n   *\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} origin\n   * @private\n   */\n  ;\n\n  _proto.preconnectPolyfill_ = function preconnectPolyfill_(ampdoc, origin) {\n    // Unfortunately there is no reliable way to feature detect whether\n    // preconnect is supported, so we do this only in Safari, which is\n    // the most important browser without support for it.\n    if (this.features_.preconnect || !(this.platform_.isSafari() || this.platform_.isIos())) {\n      return;\n    } // Don't attempt to preconnect for ACTIVE_CONNECTION_TIMEOUT_MS since\n    // we effectively create an active connection.\n    // TODO(@cramforce): Confirm actual http2 timeout in Safari.\n\n\n    var now = Date.now();\n    this.origins_[origin] = now + ACTIVE_CONNECTION_TIMEOUT_MS; // Make the URL change whenever we want to make a new request,\n    // but make it stay stable in between. While a given page\n    // would not actually make a new request, another page might\n    // and with this it has the same URL. If (and that is a big if)\n    // the server responds with a cacheable response, this reduces\n    // requests we make. More importantly, though, it reduces URL\n    // entropy as seen by servers and thus allows reverse proxies\n    // (read CDNs) to respond more efficiently.\n\n    var cacheBust = now - now % ACTIVE_CONNECTION_TIMEOUT_MS;\n    var url = origin + '/robots.txt?_AMP_safari_preconnect_polyfill_cachebust=' + cacheBust;\n    var xhr = new XMLHttpRequest();\n    xhr.open('HEAD', url, true); // We only support credentialed preconnect for now.\n\n    xhr.withCredentials = true;\n    xhr.send();\n  };\n\n  return PreconnectService;\n}();\n\nvar Preconnect =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!PreconnectService} preconnectService\n   * @param {!Element} element\n   */\n  function Preconnect(preconnectService, element) {\n    /** @const @private {!PreconnectService} */\n    this.preconnectService_ = preconnectService;\n    /** @const @private {!Element} */\n\n    this.element_ = element;\n    /** @private {?./service/ampdoc-impl.AmpDoc} */\n\n    this.ampdoc_ = null;\n  }\n  /**\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   * @private\n   */\n\n\n  var _proto2 = Preconnect.prototype;\n\n  _proto2.getAmpdoc_ = function getAmpdoc_() {\n    if (!this.ampdoc_) {\n      this.ampdoc_ = _services.Services.ampdoc(this.element_);\n    }\n\n    return this.ampdoc_;\n  }\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   */\n  ;\n\n  _proto2.url = function url(_url2, opt_alsoConnecting) {\n    this.preconnectService_.url(this.getAmpdoc_(), _url2, opt_alsoConnecting);\n  }\n  /**\n   * Asks the browser to preload a URL. Always also does a preconnect\n   * because browser support for that is better.\n   *\n   * @param {string} url\n   * @param {string=} opt_preloadAs\n   */\n  ;\n\n  _proto2.preload = function preload(url, opt_preloadAs) {\n    this.preconnectService_.preload(this.getAmpdoc_(), url, opt_preloadAs);\n  };\n\n  return Preconnect;\n}();\n/**\n * @param {!Element} element\n * @return {!Preconnect}\n */\n\n\nexports.Preconnect = Preconnect;\n\nfunction preconnectForElement(element) {\n  var serviceHolder = (0, _types.toWin)(element.ownerDocument.defaultView);\n  (0, _service.registerServiceBuilder)(serviceHolder, 'preconnect', PreconnectService);\n  var preconnectService = (0, _service.getService)(serviceHolder, 'preconnect');\n  return new Preconnect(preconnectService, element);\n}\n/**\n * Preconnects to the source URL and canonical domains to make sure\n * outbound navigations are quick. Waits for onload to avoid blocking\n * more high priority loads.\n * @param {!Document} document\n * @return {Promise} When work is done.\n */\n\n\nfunction preconnectToOrigin(document) {\n  return (0, _documentReady.whenDocumentComplete)(document).then(function () {\n    var element = document.documentElement;\n    var preconnect = preconnectForElement(element);\n\n    var info = _services.Services.documentInfoForDoc(element);\n\n    preconnect.url(info.sourceUrl);\n    preconnect.url(info.canonicalUrl);\n  });\n}\n\n},{\"./document-ready\":39,\"./log\":68,\"./service\":79,\"./services\":123,\"./static-template\":125,\"./string\":126,\"./types\":131,\"./url\":134}],78:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.waitForServices = waitForServices;\nexports.hasRenderDelayingServices = hasRenderDelayingServices;\nexports.isRenderDelayingService = isRenderDelayingService;\nexports.includedServices = includedServices;\nexports.RenderDelayingService = void 0;\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _service = require(\"./service\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A map of services that delay rendering. The key is the name of the service\n * and the value is a DOM query which is used to check if the service is needed\n * in the current document.\n * Do not add a service unless absolutely necessary.\n *\n * \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  / _____|\n *  \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n *   \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n *    \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n *     \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n *\n * The equivalent of this list is used for server-side rendering (SSR) and any\n * changes made to it must be made in coordination with caches that implement\n * SSR. For more information on SSR see bit.ly/amp-ssr.\n *\n * @const {!Object<string, string>}\n */\nvar SERVICES = {\n  'amp-dynamic-css-classes': '[custom-element=amp-dynamic-css-classes]',\n  'variant': 'amp-experiment',\n  'amp-story-render': 'amp-story[standalone]'\n};\n/**\n * Base class for render delaying services.\n * This should be extended to ensure the service\n * is properly handled\n *\n * @interface\n */\n\nvar RenderDelayingService =\n/*#__PURE__*/\nfunction () {\n  function RenderDelayingService() {}\n\n  var _proto = RenderDelayingService.prototype;\n\n  /**\n   * Function to return a promise for when\n   * it is finished delaying render, and is ready.\n   * NOTE: This should simply return Promise.resolve,\n   * if your service does not need to perform any logic\n   * after being registered.\n   * @return {!Promise}\n   */\n  _proto.whenReady = function whenReady() {};\n\n  return RenderDelayingService;\n}();\n/**\n * Maximum milliseconds to wait for all extensions to load before erroring.\n * @const\n */\n\n\nexports.RenderDelayingService = RenderDelayingService;\nvar LOAD_TIMEOUT = 3000;\n/**\n * Detects any render delaying services that are required on the page, and\n * returns a promise with a timeout.\n * @param {!Window} win\n * @return {!Promise<!Array<*>>} resolves to an Array that has the same length\n *     as the detected render delaying services\n */\n\nfunction waitForServices(win) {\n  var promises = includedServices(win).map(function (serviceId) {\n    var serviceReadyPromise = (0, _service.getServicePromise)(win, serviceId).then(function (service) {\n      if (service && isRenderDelayingService(service)) {\n        return service.whenReady().then(function () {\n          return service;\n        });\n      }\n\n      return service;\n    });\n    return _services.Services.timerFor(win).timeoutPromise(LOAD_TIMEOUT, serviceReadyPromise, \"Render timeout waiting for service \" + serviceId + \" to be ready.\");\n  });\n  return Promise.all(promises);\n}\n/**\n * Returns true if the page has a render delaying service.\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nfunction hasRenderDelayingServices(win) {\n  return includedServices(win).length > 0;\n}\n/**\n * Function to determine if the passed\n * Object is a Render Delaying Service\n * @param {!Object} service\n * @return {boolean}\n */\n\n\nfunction isRenderDelayingService(service) {\n  var maybeRenderDelayingService =\n  /** @type {!RenderDelayingService}*/\n  service;\n  return typeof maybeRenderDelayingService.whenReady == 'function';\n}\n/**\n * Detects which, if any, render-delaying extensions are included on the page.\n * @param {!Window} win\n * @return {!Array<string>}\n */\n\n\nfunction includedServices(win) {\n  /** @const {!Document} */\n  var doc = win.document;\n  (0, _log.devAssert)(doc.body);\n  return Object.keys(SERVICES).filter(function (service) {\n    return doc.querySelector(SERVICES[service]);\n  });\n}\n\n},{\"./log\":68,\"./service\":79,\"./services\":123}],79:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getExistingServiceForDocInEmbedScope = getExistingServiceForDocInEmbedScope;\nexports.installServiceInEmbedScope = installServiceInEmbedScope;\nexports.registerServiceBuilder = registerServiceBuilder;\nexports.registerServiceBuilderForDoc = registerServiceBuilderForDoc;\nexports.rejectServicePromiseForDoc = rejectServicePromiseForDoc;\nexports.getService = getService;\nexports.getServicePromise = getServicePromise;\nexports.getExistingServiceOrNull = getExistingServiceOrNull;\nexports.getServicePromiseOrNull = getServicePromiseOrNull;\nexports.getServiceForDoc = getServiceForDoc;\nexports.getServicePromiseForDoc = getServicePromiseForDoc;\nexports.getServicePromiseOrNullForDoc = getServicePromiseOrNullForDoc;\nexports.setParentWindow = setParentWindow;\nexports.getParentWindow = getParentWindow;\nexports.getTopWindow = getTopWindow;\nexports.getParentWindowFrameElement = getParentWindowFrameElement;\nexports.getAmpdoc = getAmpdoc;\nexports.isDisposable = isDisposable;\nexports.assertDisposable = assertDisposable;\nexports.disposeServicesForDoc = disposeServicesForDoc;\nexports.disposeServicesForEmbed = disposeServicesForEmbed;\nexports.installServiceInEmbedIfEmbeddable = installServiceInEmbedIfEmbeddable;\nexports.adoptServiceForEmbedDoc = adoptServiceForEmbedDoc;\nexports.resetServiceForTesting = resetServiceForTesting;\nexports.EmbeddableService = exports.Disposable = void 0;\n\nvar _promise = require(\"./utils/promise\");\n\nvar _log = require(\"./log\");\n\nvar _experiments = require(\"./experiments\");\n\nvar _types = require(\"./types\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Registration and getter functions for AMP services.\n *\n * Invariant: Service getters never return null for registered services.\n */\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * - context: Argument for ctor, either a window or an ampdoc.\n * - ctor: Function that constructs and returns the service.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise),\n *   resolve: (?function(!Object)),\n *   reject: (?function((*))),\n *   context: (?Window|?./service/ampdoc-impl.AmpDoc),\n *   ctor: (?function(new:Object, !Window)|\n *          ?function(new:Object, !./service/ampdoc-impl.AmpDoc)),\n * }}\n */\nvar ServiceHolderDef;\n/**\n * This interface provides a `dispose` method that will be called by\n * runtime when a service needs to be disposed of.\n * @interface\n */\n\nvar Disposable =\n/*#__PURE__*/\nfunction () {\n  function Disposable() {}\n\n  var _proto = Disposable.prototype;\n\n  /**\n   * Instructs the service to release any resources it might be holding. Can\n   * be called only once in the lifecycle of a service.\n   */\n  _proto.dispose = function dispose() {};\n\n  return Disposable;\n}();\n/**\n * Services must implement this interface to be embeddable in FIEs.\n * @interface\n */\n\n\nexports.Disposable = Disposable;\n\nvar EmbeddableService =\n/*#__PURE__*/\nfunction () {\n  function EmbeddableService() {}\n\n  /**\n   * Installs a new instance of the service in the given FIE window.\n   * @param {!Window} unusedEmbedWin\n   * @param {!./service/ampdoc-impl.AmpDoc} unusedAmpDoc\n   */\n  EmbeddableService.installInEmbedWindow = function installInEmbedWindow(unusedEmbedWin, unusedAmpDoc) {};\n\n  return EmbeddableService;\n}();\n/**\n * Returns a service with the given id. Assumes that it has been constructed\n * already.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id\n * @return {?Object}\n */\n\n\nexports.EmbeddableService = EmbeddableService;\n\nfunction getExistingServiceForDocInEmbedScope(element, id) {\n  // TODO(#22733): completely remove this method once ampdoc-fie launches.\n  var document = element.ownerDocument;\n  var win = (0, _types.toWin)(document.defaultView);\n  var topWin = getTopWindow(win); // First, try to resolve via local embed window (if applicable).\n\n  var isEmbed = win != topWin;\n  var ampdocFieExperimentOn = (0, _experiments.isExperimentOn)(topWin, 'ampdoc-fie');\n\n  if (isEmbed && !ampdocFieExperimentOn) {\n    if (isServiceRegistered(win, id)) {\n      return getServiceInternal(win, id);\n    } // Fallback from FIE to parent is intentionally unsupported for safety.\n\n\n    return null;\n  } else {\n    // Resolve via the element's ampdoc.\n    return getServiceForDocOrNullInternal(element, id);\n  }\n}\n/**\n * Installs a service override on amp-doc level.\n * @param {!Window} embedWin\n * @param {string} id\n * @param {!Object} service The service.\n */\n\n\nfunction installServiceInEmbedScope(embedWin, id, service) {\n  var topWin = getTopWindow(embedWin);\n  (0, _log.devAssert)(embedWin != topWin, 'Service override can only be installed in embed window: %s', id);\n  (0, _log.devAssert)(!isServiceRegistered(embedWin, id), 'Service override has already been installed: %s', id);\n  var ampdocFieExperimentOn = (0, _experiments.isExperimentOn)(topWin, 'ampdoc-fie');\n\n  if (ampdocFieExperimentOn) {\n    var ampdoc = getAmpdoc(embedWin.document);\n    registerServiceInternal(getAmpdocServiceHolder(ampdoc), ampdoc, id, function () {\n      return service;\n    },\n    /* override */\n    true);\n  } else {\n    registerServiceInternal(embedWin, embedWin, id, function () {\n      return service;\n    });\n    getServiceInternal(embedWin, id); // Force service to build.\n  }\n}\n/**\n * Registers a service given a class to be used as implementation.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(new:Object, !Window)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\n\n\nfunction registerServiceBuilder(win, id, constructor, opt_instantiate) {\n  win = getTopWindow(win);\n  registerServiceInternal(win, win, id, constructor);\n\n  if (opt_instantiate) {\n    getServiceInternal(win, id);\n  }\n}\n/**\n * Returns a service and registers it given a class to be used as\n * implementation.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id of the service.\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\n\n\nfunction registerServiceBuilderForDoc(nodeOrDoc, id, constructor, opt_instantiate) {\n  var ampdoc = getAmpdoc(nodeOrDoc);\n  var holder = getAmpdocServiceHolder(ampdoc);\n  registerServiceInternal(holder, ampdoc, id, constructor);\n\n  if (opt_instantiate) {\n    getServiceInternal(holder, id);\n  }\n}\n/**\n * Reject a service promise.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id\n * @param {*} error\n */\n\n\nfunction rejectServicePromiseForDoc(nodeOrDoc, id, error) {\n  var ampdoc = getAmpdoc(nodeOrDoc);\n  var holder = getAmpdocServiceHolder(ampdoc);\n  rejectServicePromiseInternal(holder, id, error);\n}\n/**\n * Returns a service for the given id and window (a per-window singleton). Users\n * should typically wrap this as a special purpose function (e.g.\n * `Services.vsyncFor(win)`) for type safety and because the factory should not\n * be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\n\n\nfunction getService(win, id) {\n  win = getTopWindow(win);\n  return getServiceInternal(win, id);\n}\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. `Services.vsyncFor(win)`) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\n\n\nfunction getServicePromise(win, id) {\n  return getServicePromiseInternal(win, id);\n}\n/**\n * Returns a service or null with the given id.\n * @param {!Window} win\n * @param {string} id\n * @return {?Object} The service.\n */\n\n\nfunction getExistingServiceOrNull(win, id) {\n  win = getTopWindow(win);\n\n  if (isServiceRegistered(win, id)) {\n    return getServiceInternal(win, id);\n  } else {\n    return null;\n  }\n}\n/**\n * Like getServicePromise but returns null if the service was never registered.\n * @param {!Window} win\n * @param {string} id\n * @return {?Promise<!Object>}\n */\n\n\nfunction getServicePromiseOrNull(win, id) {\n  return getServicePromiseOrNullInternal(win, id);\n}\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * Expects service `id` to be registered.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {T}\n * @template T\n */\n\n\nfunction getServiceForDoc(elementOrAmpDoc, id) {\n  var ampdoc = getAmpdoc(elementOrAmpDoc);\n  var holder = getAmpdocServiceHolder(ampdoc);\n  return getServiceInternal(holder, id);\n}\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * If service `id` is not registered, returns null.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id\n * @return {?Object}\n */\n\n\nfunction getServiceForDocOrNullInternal(element, id) {\n  var ampdoc = getAmpdoc(element);\n  var holder = getAmpdocServiceHolder(ampdoc);\n\n  if (isServiceRegistered(holder, id)) {\n    return getServiceInternal(holder, id);\n  } else {\n    return null;\n  }\n}\n/**\n * Returns a promise for a service for the given id and ampdoc. Also expects\n * a service that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {!Promise<!Object>}\n */\n\n\nfunction getServicePromiseForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseInternal(getAmpdocServiceHolder(elementOrAmpDoc), id);\n}\n/**\n * Like getServicePromiseForDoc but returns null if the service was never\n * registered for this ampdoc.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Promise<!Object>}\n */\n\n\nfunction getServicePromiseOrNullForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseOrNullInternal(getAmpdocServiceHolder(elementOrAmpDoc), id);\n}\n/**\n * Set the parent and top windows on a child window (friendly iframe).\n * @param {!Window} win\n * @param {!Window} parentWin\n */\n\n\nfunction setParentWindow(win, parentWin) {\n  win.__AMP_PARENT = parentWin;\n  win.__AMP_TOP = getTopWindow(parentWin);\n}\n/**\n * Returns the parent window for a child window (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\n\n\nfunction getParentWindow(win) {\n  return win.__AMP_PARENT || win;\n}\n/**\n * Returns the top window where AMP Runtime is installed for a child window\n * (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\n\n\nfunction getTopWindow(win) {\n  return win.__AMP_TOP || (win.__AMP_TOP = win);\n}\n/**\n * Returns the parent \"friendly\" iframe if the node belongs to a child window.\n * @param {!Node} node\n * @param {!Window=} opt_topWin\n * @return {?HTMLIFrameElement}\n */\n\n\nfunction getParentWindowFrameElement(node, opt_topWin) {\n  var childWin = (node.ownerDocument || node).defaultView;\n  var topWin = opt_topWin || getTopWindow(childWin);\n\n  if (childWin && childWin != topWin && getTopWindow(childWin) == topWin) {\n    try {\n      return (\n        /** @type {?HTMLIFrameElement} */\n        childWin.frameElement\n      );\n    } catch (e) {// Ignore the error.\n    }\n  }\n\n  return null;\n}\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc}\n */\n\n\nfunction getAmpdoc(nodeOrDoc) {\n  if (nodeOrDoc.nodeType) {\n    var win = (0, _types.toWin)(\n    /** @type {!Document} */\n    (nodeOrDoc.ownerDocument || nodeOrDoc).defaultView);\n    return getAmpdocService(win).getAmpDoc(\n    /** @type {!Node} */\n    nodeOrDoc);\n  }\n\n  return (\n    /** @type {!./service/ampdoc-impl.AmpDoc} */\n    nodeOrDoc\n  );\n}\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc|!Window}\n */\n\n\nfunction getAmpdocServiceHolder(nodeOrDoc) {\n  var ampdoc = getAmpdoc(nodeOrDoc);\n  return ampdoc.isSingleDoc() ? ampdoc.win : ampdoc;\n}\n/**\n * This is essentially a duplicate of `ampdoc.js`, but necessary to avoid\n * circular dependencies.\n * @param {!Window} win\n * @return {!./service/ampdoc-impl.AmpDocService}\n */\n\n\nfunction getAmpdocService(win) {\n  return (\n    /** @type {!./service/ampdoc-impl.AmpDocService} */\n    getService(win, 'ampdoc')\n  );\n}\n/**\n * Get service `id` from `holder`. Assumes the service\n * has already been registered.\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {Object}\n * @template T\n */\n\n\nfunction getServiceInternal(holder, id) {\n  (0, _log.devAssert)(isServiceRegistered(holder, id), \"Expected service \" + id + \" to be registered\");\n  var services = getServices(holder);\n  var s = services[id];\n\n  if (!s.obj) {\n    (0, _log.devAssert)(s.ctor, \"Service \" + id + \" registered without ctor nor impl.\");\n    (0, _log.devAssert)(s.context, \"Service \" + id + \" registered without context.\");\n    s.obj = new s.ctor(s.context);\n    (0, _log.devAssert)(s.obj, \"Service \" + id + \" constructed to null.\");\n    s.ctor = null;\n    s.context = null; // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n\n  return s.obj;\n}\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {!Window|!./service/ampdoc-impl.AmpDoc} context Win or AmpDoc.\n * @param {string} id of the service.\n * @param {?function(new:Object, !Window)|?function(new:Object, !./service/ampdoc-impl.AmpDoc)} ctor Constructor function to new the service. Called with context.\n * @param {boolean=} opt_override\n */\n\n\nfunction registerServiceInternal(holder, context, id, ctor, opt_override) {\n  var services = getServices(holder);\n  var s = services[id];\n\n  if (!s) {\n    s = services[id] = {\n      obj: null,\n      promise: null,\n      resolve: null,\n      reject: null,\n      context: null,\n      ctor: null\n    };\n  }\n\n  if (!opt_override && (s.ctor || s.obj)) {\n    // Service already registered.\n    return;\n  }\n\n  s.ctor = ctor;\n  s.context = context; // The service may have been requested already, in which case there is a\n  // pending promise that needs to fulfilled.\n\n  if (s.resolve) {\n    // getServiceInternal will resolve the promise.\n    getServiceInternal(holder, id);\n  }\n}\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\n\n\nfunction getServicePromiseInternal(holder, id) {\n  var cached = getServicePromiseOrNullInternal(holder, id);\n\n  if (cached) {\n    return cached;\n  } // Service is not registered.\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n\n\n  var services = getServices(holder);\n  services[id] = emptyServiceHolderWithPromise();\n  return (\n    /** @type {!Promise<!Object>} */\n    services[id].promise\n  );\n}\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @param {*} error\n */\n\n\nfunction rejectServicePromiseInternal(holder, id, error) {\n  var services = getServices(holder);\n  var s = services[id];\n\n  if (s) {\n    if (s.reject) {\n      s.reject(error);\n    }\n\n    return;\n  }\n\n  services[id] = emptyServiceHolderWithPromise();\n  services[id].reject(error);\n}\n/**\n * Returns a promise for service `id` if the service has been registered\n * on `holder`.\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {?Promise<!Object>}\n */\n\n\nfunction getServicePromiseOrNullInternal(holder, id) {\n  var services = getServices(holder);\n  var s = services[id];\n\n  if (s) {\n    if (s.promise) {\n      return s.promise;\n    } else {\n      // Instantiate service if not already instantiated.\n      getServiceInternal(holder, id);\n      return s.promise = Promise.resolve(\n      /** @type {!Object} */\n      s.obj);\n    }\n  }\n\n  return null;\n}\n/**\n * Returns the object that holds the services registered in a holder.\n * @param {!Object} holder\n * @return {!Object<string,!ServiceHolderDef>}\n */\n\n\nfunction getServices(holder) {\n  var services = holder.__AMP_SERVICES;\n\n  if (!services) {\n    services = holder.__AMP_SERVICES = {};\n  }\n\n  return services;\n}\n/**\n * Whether the specified service implements `Disposable` interface.\n * @param {!Object} service\n * @return {boolean}\n */\n\n\nfunction isDisposable(service) {\n  return typeof service.dispose == 'function';\n}\n/**\n * Asserts that the specified service implements `Disposable` interface and\n * typecasts the instance to `Disposable`.\n * @param {!Object} service\n * @return {!Disposable}\n */\n\n\nfunction assertDisposable(service) {\n  (0, _log.devAssert)(isDisposable(service), 'required to implement Disposable');\n  return (\n    /** @type {!Disposable} */\n    service\n  );\n}\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * ampdoc scope.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nfunction disposeServicesForDoc(ampdoc) {\n  disposeServicesInternal(ampdoc);\n}\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * embed scope.\n * @param {!Window} embedWin\n */\n\n\nfunction disposeServicesForEmbed(embedWin) {\n  disposeServicesInternal(embedWin);\n}\n/**\n * @param {!Object} holder Object holding the service instances.\n */\n\n\nfunction disposeServicesInternal(holder) {\n  // TODO(dvoytenko): Consider marking holder as destroyed for later-arriving\n  // service to be canceled automatically.\n  var services = getServices(holder);\n\n  var _loop = function _loop(id) {\n    if (!Object.prototype.hasOwnProperty.call(services, id)) {\n      return \"continue\";\n    }\n\n    var serviceHolder = services[id];\n\n    if (serviceHolder.obj) {\n      disposeServiceInternal(id, serviceHolder.obj);\n    } else if (serviceHolder.promise) {\n      serviceHolder.promise.then(function (instance) {\n        return disposeServiceInternal(id, instance);\n      });\n    }\n  };\n\n  for (var id in services) {\n    var _ret = _loop(id);\n\n    if (_ret === \"continue\") continue;\n  }\n}\n/**\n * @param {string} id\n * @param {!Object} service\n */\n\n\nfunction disposeServiceInternal(id, service) {\n  if (!isDisposable(service)) {\n    return;\n  }\n\n  try {\n    assertDisposable(service).dispose();\n  } catch (e) {\n    // Ensure that a failure to dispose a service does not disrupt other\n    // services.\n    (0, _log.dev)().error('SERVICE', 'failed to dispose service', id, e);\n  }\n}\n/**\n * Adopts an embeddable (implements `EmbeddableService` interface) service\n * in embed scope.\n * @param {!Window} embedWin\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} serviceClass\n * @suppress {missingProperties}\n * @return {boolean}\n */\n\n\nfunction installServiceInEmbedIfEmbeddable(embedWin, serviceClass) {\n  var isEmbeddableService = typeof serviceClass.installInEmbedWindow === 'function';\n\n  if (!isEmbeddableService) {\n    return false;\n  }\n\n  var frameElement = (0, _log.dev)().assertElement(embedWin.frameElement, 'frameElement not found for embed');\n  var ampdoc = getAmpdoc(frameElement);\n  serviceClass.installInEmbedWindow(embedWin, ampdoc);\n  return true;\n}\n/**\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\n\n\nfunction adoptServiceForEmbedDoc(ampdoc, id) {\n  var service = getServiceInternal(getAmpdocServiceHolder((0, _log.devAssert)(ampdoc.getParent())), id);\n  registerServiceInternal(getAmpdocServiceHolder(ampdoc), ampdoc, id, function () {\n    return service;\n  });\n}\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Object} holder\n * @param {string} id of the service.\n */\n\n\nfunction resetServiceForTesting(holder, id) {\n  if (holder.__AMP_SERVICES) {\n    holder.__AMP_SERVICES[id] = null;\n  }\n}\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {boolean}\n */\n\n\nfunction isServiceRegistered(holder, id) {\n  var service = holder.__AMP_SERVICES && holder.__AMP_SERVICES[id]; // All registered services must have an implementation or a constructor.\n\n  return !!(service && (service.ctor || service.obj));\n}\n/** @return {!ServiceHolderDef} */\n\n\nfunction emptyServiceHolderWithPromise() {\n  var deferred = new _promise.Deferred();\n  var promise = deferred.promise,\n      resolve = deferred.resolve,\n      reject = deferred.reject;\n  promise.catch(function () {}); // avoid uncaught exception when service gets rejected\n\n  return {\n    obj: null,\n    promise: promise,\n    resolve: resolve,\n    reject: reject,\n    context: null,\n    ctor: null\n  };\n}\n\n},{\"./experiments\":47,\"./log\":68,\"./types\":131,\"./utils/promise\":147}],80:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.parseActionMap = parseActionMap;\nexports.dereferenceArgsVariables = dereferenceArgsVariables;\nexports.installActionServiceForDoc = installActionServiceForDoc;\nexports.DeferredEvent = exports.ActionService = exports.ActionInvocation = exports.ActionEventDef = exports.ActionInfoDef = exports.TAPPABLE_ARIA_ROLES = void 0;\n\nvar _actionConstants = require(\"../action-constants\");\n\nvar _keyCodes = require(\"../utils/key-codes\");\n\nvar _services = require(\"../services\");\n\nvar _rateLimit = require(\"../utils/rate-limit\");\n\nvar _log = require(\"../log\");\n\nvar _object = require(\"../utils/object\");\n\nvar _eventHelper = require(\"../event-helper\");\n\nvar _mode = require(\"../mode\");\n\nvar _json = require(\"../json\");\n\nvar _service = require(\"../service\");\n\nvar _types = require(\"../types\");\n\nvar _dom = require(\"../dom\");\n\nvar _error = require(\"../error\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {string} */\nvar TAG_ = 'Action';\n/** @const {string} */\n\nvar ACTION_MAP_ = '__AMP_ACTION_MAP__' + Math.random();\n/** @const {string} */\n\nvar ACTION_QUEUE_ = '__AMP_ACTION_QUEUE__';\n/** @const {string} */\n\nvar ACTION_HANDLER_ = '__AMP_ACTION_HANDLER__';\n/** @const {number} */\n\nvar DEFAULT_DEBOUNCE_WAIT = 300; // ms\n\n/** @const {number} */\n\nvar DEFAULT_THROTTLE_INTERVAL = 100; // ms\n\n/** @const {!Object<string,!Array<string>>} */\n\nvar NON_AMP_ELEMENTS_ACTIONS_ = {\n  'form': ['submit', 'clear']\n};\n/**\n * Interactable widgets which should trigger tap events when the user clicks\n * or activates via the keyboard. Not all are here, e.g. progressbar, tabpanel,\n * since they are text inputs, readonly, or composite widgets that shouldn't\n * need to trigger tap events from spacebar or enter on their own.\n * See https://www.w3.org/TR/wai-aria-1.1/#widget_roles\n * @const {!Object<boolean>}\n */\n\nvar TAPPABLE_ARIA_ROLES = {\n  'button': true,\n  'checkbox': true,\n  'link': true,\n  'listbox': true,\n  'menuitem': true,\n  'menuitemcheckbox': true,\n  'menuitemradio': true,\n  'option': true,\n  'radio': true,\n  'scrollbar': true,\n  'slider': true,\n  'spinbutton': true,\n  'switch': true,\n  'tab': true,\n  'treeitem': true\n};\n/**\n * An expression arg value, e.g. `foo.bar` in `e:t.m(arg=foo.bar)`.\n * @typedef {{expression: string}}\n */\n\nexports.TAPPABLE_ARIA_ROLES = TAPPABLE_ARIA_ROLES;\nvar ActionInfoArgExpressionDef;\n/**\n * An arg value.\n * @typedef {(boolean|number|string|ActionInfoArgExpressionDef)}\n */\n\nvar ActionInfoArgValueDef;\n/**\n * Map of arg names to their values, e.g. {arg: 123} in `e:t.m(arg=123)`.\n * @typedef {Object<string, ActionInfoArgValueDef>}\n */\n\nvar ActionInfoArgsDef;\n/**\n * @typedef {{\n *   event: string,\n *   target: string,\n *   method: string,\n *   args: ?ActionInfoArgsDef,\n *   str: string\n * }}\n */\n\nvar ActionInfoDef;\n/**\n * Function called when an action is invoked.\n *\n * Optionally, takes this action's position within all actions triggered by\n * the same event, as well as said action array, as params.\n *\n * If the action is chainable, returns a Promise which resolves when the\n * action is complete. Otherwise, returns null.\n *\n * @typedef {function(!ActionInvocation, number=, !Array<!ActionInfoDef>=):?Promise}\n */\n\nexports.ActionInfoDef = ActionInfoDef;\nvar ActionHandlerDef;\n/**\n * @typedef {Event|DeferredEvent}\n */\n\nvar ActionEventDef;\n/**\n * The structure that contains all details of the action method invocation.\n * @struct @const @package For type.\n */\n\nexports.ActionEventDef = ActionEventDef;\n\nvar ActionInvocation =\n/*#__PURE__*/\nfunction () {\n  /**\n   * For example:\n   *\n   *   <div id=\"div\" on=\"tap:myForm.submit(foo=bar)\">\n   *     <button id=\"btn\">Submit</button>\n   *   </div>\n   *\n   * `node` is #myForm.\n   * `method` is \"submit\".\n   * `args` is {'foo': 'bar'}.\n   * `source` is #btn.\n   * `caller` is #div.\n   * `event` is a \"click\" Event object.\n   * `actionEventType` is \"tap\".\n   * `trust` depends on whether this action was a result of a user gesture.\n   * `tagOrTarget` is \"amp-form\".\n   * `sequenceId` is a pseudo-UUID.\n   *\n   * @param {!Node} node Element whose action is being invoked.\n   * @param {string} method Name of the action being invoked.\n   * @param {?JsonObject} args Named action arguments.\n   * @param {?Element} source Element that generated the `event`.\n   * @param {?Element} caller Element containing the on=\"...\" action handler.\n   * @param {?ActionEventDef} event The event object that triggered this action.\n   * @param {!ActionTrust} trust The trust level of this invocation's trigger.\n   * @param {?string} actionEventType The AMP event name that triggered this.\n   * @param {?string} tagOrTarget The global target name or the element tagName.\n   * @param {number} sequenceId An identifier for this action's sequence (all\n   *   actions triggered by one event e.g. \"tap:form1.submit, form2.submit\").\n   */\n  function ActionInvocation(node, method, args, source, caller, event, trust, actionEventType, tagOrTarget, sequenceId) {\n    if (actionEventType === void 0) {\n      actionEventType = '?';\n    }\n\n    if (tagOrTarget === void 0) {\n      tagOrTarget = null;\n    }\n\n    if (sequenceId === void 0) {\n      sequenceId = Math.random();\n    }\n\n    /** @type {!Node} */\n    this.node = node;\n    /** @const {string} */\n\n    this.method = method;\n    /** @const {?JsonObject} */\n\n    this.args = args;\n    /** @const {?Element} */\n\n    this.source = source;\n    /** @const {?Element} */\n\n    this.caller = caller;\n    /** @const {?ActionEventDef} */\n\n    this.event = event;\n    /** @const {!ActionTrust} */\n\n    this.trust = trust;\n    /** @const {?string} */\n\n    this.actionEventType = actionEventType;\n    /** @const {string} */\n\n    this.tagOrTarget = tagOrTarget || node.tagName;\n    /** @const {number} */\n\n    this.sequenceId = sequenceId;\n  }\n  /**\n   * Returns true if the trigger event has a trust equal to or greater than\n   * `minimumTrust`. Otherwise, logs a user error and returns false.\n   * @param {ActionTrust} minimumTrust\n   * @return {boolean}\n   */\n\n\n  var _proto = ActionInvocation.prototype;\n\n  _proto.satisfiesTrust = function satisfiesTrust(minimumTrust) {\n    // Sanity check.\n    if (!(0, _types.isFiniteNumber)(this.trust)) {\n      (0, _log.dev)().error(TAG_, \"Invalid trust for '\" + this.method + \"': \" + this.trust);\n      return false;\n    }\n\n    if (this.trust < minimumTrust) {\n      (0, _log.user)().error(TAG_, \"\\\"\" + this.actionEventType + \"\\\" is not allowed to invoke \" + (\"\\\"\" + this.tagOrTarget + \".\" + this.method + \"\\\".\"));\n      return false;\n    }\n\n    return true;\n  };\n\n  return ActionInvocation;\n}();\n/**\n * TODO(dvoytenko): consider splitting this class into two:\n * 1. A class that has a method \"trigger(element, eventType, data)\" and\n *    simply can search target in DOM and trigger methods on it.\n * 2. A class that configures event recognizers and rules and then\n *    simply calls action.trigger.\n * @implements {../service.EmbeddableService}\n */\n\n\nexports.ActionInvocation = ActionInvocation;\n\nvar ActionService =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_root\n   */\n  function ActionService(ampdoc, opt_root) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @const {!Document|!ShadowRoot} */\n\n    this.root_ = opt_root || ampdoc.getRootNode();\n    /**\n     * Optional whitelist of actions, e.g.:\n     *\n     *     [{tagOrTarget: 'AMP', method: 'navigateTo'},\n     *      {tagOrTarget: 'AMP-FORM', method: 'submit'},\n     *      {tagOrTarget: '*', method: 'show'}]\n     *\n     * If not null, any actions that are not in the whitelist will be ignored\n     * and throw a user error at invocation time. Note that `tagOrTarget` is\n     * always the canonical uppercased form (same as\n     * `Element.prototype.tagName`). If `tagOrTarget` is the wildcard '*', then\n     * the whitelisted method is allowed on any tag or target.\n     * @private {?Array<{tagOrTarget: string, method: string}>}\n     */\n\n    this.whitelist_ = this.queryWhitelist_();\n    /** @const @private {!Object<string, ActionHandlerDef>} */\n\n    this.globalTargets_ = (0, _object.map)();\n    /**\n     * @const @private {!Object<string, {handler: ActionHandlerDef, minTrust: ActionTrust}>}\n     */\n\n    this.globalMethodHandlers_ = (0, _object.map)(); // Add core events.\n\n    this.addEvent('tap');\n    this.addEvent('submit');\n    this.addEvent('change');\n    this.addEvent('input-debounced');\n    this.addEvent('input-throttled');\n    this.addEvent('valid');\n    this.addEvent('invalid');\n  }\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n\n\n  ActionService.installInEmbedWindow = function installInEmbedWindow(embedWin, ampdoc) {\n    (0, _service.installServiceInEmbedScope)(embedWin, 'action', new ActionService(ampdoc, embedWin.document));\n  }\n  /**\n   * @param {string} name\n   * TODO(dvoytenko): switch to a system where the event recognizers are\n   * registered with Action instead, e.g. \"doubletap\", \"tap to zoom\".\n   */\n  ;\n\n  var _proto2 = ActionService.prototype;\n\n  _proto2.addEvent = function addEvent(name) {\n    var _this = this;\n\n    if (name == 'tap') {\n      // TODO(dvoytenko): if needed, also configure touch-based tap, e.g. for\n      // fast-click.\n      this.root_.addEventListener('click', function (event) {\n        if (!event.defaultPrevented) {\n          var element = (0, _log.dev)().assertElement(event.target);\n\n          _this.trigger(element, name, event, _actionConstants.ActionTrust.HIGH);\n        }\n      });\n      this.root_.addEventListener('keydown', function (event) {\n        var key = event.key,\n            target = event.target;\n        var element = (0, _log.dev)().assertElement(target);\n\n        if (key == _keyCodes.Keys.ENTER || key == _keyCodes.Keys.SPACE) {\n          var role = element.getAttribute('role');\n          var isTapEventRole = role && (0, _object.hasOwn)(TAPPABLE_ARIA_ROLES, role.toLowerCase());\n\n          if (!event.defaultPrevented && isTapEventRole) {\n            var hasAction = _this.trigger(element, name, event, _actionConstants.ActionTrust.HIGH); // Only if the element has an action do we prevent the default.\n            // In the absence of an action, e.g. on=\"[event].method\", we do not\n            // want to stop default behavior.\n\n\n            if (hasAction) {\n              event.preventDefault();\n            }\n          }\n        }\n      });\n    } else if (name == 'submit') {\n      this.root_.addEventListener(name, function (event) {\n        var element = (0, _log.dev)().assertElement(event.target); // For get requests, the delegating to the viewer needs to happen\n        // before this.\n\n        _this.trigger(element, name, event, _actionConstants.ActionTrust.HIGH);\n      });\n    } else if (name == 'change') {\n      this.root_.addEventListener(name, function (event) {\n        var element = (0, _log.dev)().assertElement(event.target);\n\n        _this.addTargetPropertiesAsDetail_(event);\n\n        _this.trigger(element, name, event, _actionConstants.ActionTrust.HIGH);\n      });\n    } else if (name == 'input-debounced') {\n      var debouncedInput = (0, _rateLimit.debounce)(this.ampdoc.win, function (event) {\n        var target = (0, _log.dev)().assertElement(event.target);\n\n        _this.trigger(target, name,\n        /** @type {!ActionEventDef} */\n        event, _actionConstants.ActionTrust.HIGH);\n      }, DEFAULT_DEBOUNCE_WAIT);\n      this.root_.addEventListener('input', function (event) {\n        // Create a DeferredEvent to avoid races where the browser cleans up\n        // the event object before the async debounced function is called.\n        var deferredEvent = new DeferredEvent(event);\n\n        _this.addTargetPropertiesAsDetail_(deferredEvent);\n\n        debouncedInput(deferredEvent);\n      });\n    } else if (name == 'input-throttled') {\n      var throttledInput = (0, _rateLimit.throttle)(this.ampdoc.win, function (event) {\n        var target = (0, _log.dev)().assertElement(event.target);\n\n        _this.trigger(target, name,\n        /** @type {!ActionEventDef} */\n        event, _actionConstants.ActionTrust.HIGH);\n      }, DEFAULT_THROTTLE_INTERVAL);\n      this.root_.addEventListener('input', function (event) {\n        var deferredEvent = new DeferredEvent(event);\n\n        _this.addTargetPropertiesAsDetail_(deferredEvent);\n\n        throttledInput(deferredEvent);\n      });\n    } else if (name == 'valid' || name == 'invalid') {\n      this.root_.addEventListener(name, function (event) {\n        var element = (0, _log.dev)().assertElement(event.target);\n\n        _this.trigger(element, name, event, _actionConstants.ActionTrust.HIGH);\n      });\n    }\n  }\n  /**\n   * Registers the action target that will receive all designated actions.\n   * @param {string} name\n   * @param {ActionHandlerDef} handler\n   */\n  ;\n\n  _proto2.addGlobalTarget = function addGlobalTarget(name, handler) {\n    this.globalTargets_[name] = handler;\n  }\n  /**\n   * Registers the action handler for a common method.\n   * @param {string} name\n   * @param {ActionHandlerDef} handler\n   * @param {ActionTrust} minTrust\n   */\n  ;\n\n  _proto2.addGlobalMethodHandler = function addGlobalMethodHandler(name, handler, minTrust) {\n    if (minTrust === void 0) {\n      minTrust = _actionConstants.ActionTrust.HIGH;\n    }\n\n    this.globalMethodHandlers_[name] = {\n      handler: handler,\n      minTrust: minTrust\n    };\n  }\n  /**\n   * Triggers the specified event on the target element.\n   * @param {!Element} target\n   * @param {string} eventType\n   * @param {?ActionEventDef} event\n   * @param {!ActionTrust} trust\n   * @param {?JsonObject=} opt_args\n   * @return {boolean} true if the target has an action.\n   */\n  ;\n\n  _proto2.trigger = function trigger(target, eventType, event, trust, opt_args) {\n    return this.action_(target, eventType, event, trust, opt_args);\n  }\n  /**\n   * Triggers execution of the method on a target/method.\n   * @param {!Element} target\n   * @param {string} method\n   * @param {?JsonObject} args\n   * @param {?Element} source\n   * @param {?Element} caller\n   * @param {?ActionEventDef} event\n   * @param {ActionTrust} trust\n   */\n  ;\n\n  _proto2.execute = function execute(target, method, args, source, caller, event, trust) {\n    var invocation = new ActionInvocation(target, method, args, source, caller, event, trust);\n    this.invoke_(invocation);\n  }\n  /**\n   * Installs action handler for the specified element. The action handler is\n   * responsible for checking invocation trust.\n   *\n   * For AMP elements, use base-element.registerAction() instead.\n   *\n   * @param {!Element} target\n   * @param {ActionHandlerDef} handler\n   */\n  ;\n\n  _proto2.installActionHandler = function installActionHandler(target, handler) {\n    // TODO(dvoytenko, #7063): switch back to `target.id` with form proxy.\n    var targetId = target.getAttribute('id') || '';\n    (0, _log.devAssert)(isAmpTagName(targetId) || target.tagName.toLowerCase() in NON_AMP_ELEMENTS_ACTIONS_, 'AMP or special element expected: %s', target.tagName + '#' + targetId);\n\n    if (target[ACTION_HANDLER_]) {\n      (0, _log.dev)().error(TAG_, \"Action handler already installed for \" + target);\n      return;\n    }\n\n    target[ACTION_HANDLER_] = handler;\n    /** @const {Array<!ActionInvocation>} */\n\n    var queuedInvocations = target[ACTION_QUEUE_];\n\n    if ((0, _types.isArray)(queuedInvocations)) {\n      // Invoke and clear all queued invocations now handler is installed.\n      _services.Services.timerFor((0, _types.toWin)(target.ownerDocument.defaultView)).delay(function () {\n        // TODO(dvoytenko, #1260): dedupe actions.\n        queuedInvocations.forEach(function (invocation) {\n          try {\n            handler(invocation);\n          } catch (e) {\n            (0, _log.dev)().error(TAG_, 'Action execution failed:', invocation, e);\n          }\n        });\n        target[ACTION_QUEUE_].length = 0;\n      }, 1);\n    }\n  }\n  /**\n   * Checks if the given element has registered a particular action type.\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  ;\n\n  _proto2.hasAction = function hasAction(element, actionEventType, opt_stopAt) {\n    return !!this.findAction_(element, actionEventType, opt_stopAt);\n  }\n  /**\n   * Checks if the given element's registered action resolves to at least one\n   * existing element by id or a global target (e.g. \"AMP\").\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  ;\n\n  _proto2.hasResolvableAction = function hasResolvableAction(element, actionEventType, opt_stopAt) {\n    var _this2 = this;\n\n    var action = this.findAction_(element, actionEventType, opt_stopAt);\n\n    if (!action) {\n      return false;\n    }\n\n    return action.actionInfos.some(function (_ref) {\n      var target = _ref.target;\n      return !!_this2.getActionNode_(target);\n    });\n  }\n  /**\n   * Checks if the given element's registered action resolves to at least one\n   * existing element by id or a global target (e.g. \"AMP\").\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element} targetElement\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  ;\n\n  _proto2.hasResolvableActionForTarget = function hasResolvableActionForTarget(element, actionEventType, targetElement, opt_stopAt) {\n    var _this3 = this;\n\n    var action = this.findAction_(element, actionEventType, opt_stopAt);\n\n    if (!action) {\n      return false;\n    }\n\n    return action.actionInfos.some(function (_ref2) {\n      var target = _ref2.target;\n      return _this3.getActionNode_(target) == targetElement;\n    });\n  }\n  /**\n   * For global targets e.g. \"AMP\", returns the document root. Otherwise,\n   * `target` is an element id and the corresponding element is returned.\n   * @param {string} target\n   * @return {?Document|?Element|?ShadowRoot}\n   * @private\n   */\n  ;\n\n  _proto2.getActionNode_ = function getActionNode_(target) {\n    return this.globalTargets_[target] ? this.root_ : this.root_.getElementById(target);\n  }\n  /**\n   * Sets the action whitelist. Can be used to clear it.\n   * @param {!Array<{tagOrTarget: string, method: string}>} whitelist\n   */\n  ;\n\n  _proto2.setWhitelist = function setWhitelist(whitelist) {\n    this.whitelist_ = whitelist;\n  }\n  /**\n   * Adds an action to the whitelist.\n   * @param {string} tagOrTarget The tag or target to whitelist, e.g.\n   *     'AMP-LIST', '*'.\n   * @param {string} method The method to whitelist, e.g. 'show', 'hide'.\n   */\n  ;\n\n  _proto2.addToWhitelist = function addToWhitelist(tagOrTarget, method) {\n    if (!this.whitelist_) {\n      this.whitelist_ = [];\n    }\n\n    this.whitelist_.push({\n      tagOrTarget: tagOrTarget,\n      method: method\n    });\n  }\n  /**\n   * @param {!Element} source\n   * @param {string} actionEventType\n   * @param {?ActionEventDef} event\n   * @param {!ActionTrust} trust\n   * @param {?JsonObject=} opt_args\n   * @return {boolean} True if the element has an action.\n   * @private\n   */\n  ;\n\n  _proto2.action_ = function action_(source, actionEventType, event, trust, opt_args) {\n    var _this4 = this;\n\n    var action = this.findAction_(source, actionEventType);\n\n    if (!action) {\n      return false;\n    } // Use a pseudo-UUID to uniquely identify this sequence of actions.\n    // A sequence is all actions triggered by a single event.\n\n\n    var sequenceId = Math.random(); // Invoke actions serially, where each action waits for its predecessor\n    // to complete. `currentPromise` is the i'th promise in the chain.\n\n    /** @type {?Promise} */\n\n    var currentPromise = null;\n    action.actionInfos.forEach(function (_ref3) {\n      var target = _ref3.target,\n          args = _ref3.args,\n          method = _ref3.method,\n          str = _ref3.str;\n      var dereferencedArgs = dereferenceArgsVariables(args, event, opt_args);\n\n      var invokeAction = function invokeAction() {\n        var node = _this4.getActionNode_(target);\n\n        if (!node) {\n          _this4.error_(\"Target \\\"\" + target + \"\\\" not found for action [\" + str + \"].\");\n\n          return;\n        }\n\n        var invocation = new ActionInvocation(node, method, dereferencedArgs, source, action.node, event, trust, actionEventType, node.tagName || target, sequenceId);\n        return _this4.invoke_(invocation);\n      }; // Wait for the previous action, if any.\n\n\n      currentPromise = currentPromise ? currentPromise.then(invokeAction) : invokeAction();\n    });\n    return action.actionInfos.length >= 1;\n  }\n  /**\n   * @param {string} message\n   * @param {?Element=} opt_element\n   * @private\n   */\n  ;\n\n  _proto2.error_ = function error_(message, opt_element) {\n    if (opt_element) {\n      // reportError() supports displaying the element in dev console.\n      var e = (0, _log.user)().createError(\"[\" + TAG_ + \"] \" + message);\n      (0, _error.reportError)(e, opt_element);\n      throw e;\n    } else {\n      (0, _log.user)().error(TAG_, message);\n    }\n  }\n  /**\n   * @param {!ActionInvocation} invocation\n   * @return {?Promise}\n   * @private\n   */\n  ;\n\n  _proto2.invoke_ = function invoke_(invocation) {\n    var method = invocation.method,\n        tagOrTarget = invocation.tagOrTarget; // Check that this action is whitelisted (if a whitelist is set).\n\n    if (this.whitelist_) {\n      if (!isActionWhitelisted(invocation, this.whitelist_)) {\n        this.error_(\"\\\"\" + tagOrTarget + \".\" + method + \"\\\" is not whitelisted \" + JSON.stringify(this.whitelist_) + \".\");\n        return null;\n      }\n    } // Handle global targets e.g. \"AMP\".\n\n\n    var globalTarget = this.globalTargets_[tagOrTarget];\n\n    if (globalTarget) {\n      return globalTarget(invocation);\n    } // Subsequent handlers assume that invocation target is an Element.\n\n\n    var node = (0, _log.dev)().assertElement(invocation.node); // Handle global actions e.g. \"<any-element-id>.toggle\".\n\n    var globalMethod = this.globalMethodHandlers_[method];\n\n    if (globalMethod && invocation.satisfiesTrust(globalMethod.minTrust)) {\n      return globalMethod.handler(invocation);\n    } // Handle element-specific actions.\n\n\n    var lowerTagName = node.tagName.toLowerCase();\n\n    if (isAmpTagName(lowerTagName)) {\n      if (node.enqueAction) {\n        node.enqueAction(invocation);\n      } else {\n        this.error_(\"Unrecognized AMP element \\\"\" + lowerTagName + \"\\\".\", node);\n      }\n\n      return null;\n    } // Special non-AMP elements with AMP ID or known supported actions.\n\n\n    var nonAmpActions = NON_AMP_ELEMENTS_ACTIONS_[lowerTagName]; // TODO(dvoytenko, #7063): switch back to `target.id` with form proxy.\n\n    var targetId = node.getAttribute('id') || '';\n\n    if (isAmpTagName(targetId) || nonAmpActions && nonAmpActions.indexOf(method) > -1) {\n      var handler = node[ACTION_HANDLER_];\n\n      if (handler) {\n        handler(invocation);\n      } else {\n        node[ACTION_QUEUE_] = node[ACTION_QUEUE_] || [];\n        node[ACTION_QUEUE_].push(invocation);\n      }\n\n      return null;\n    } // Unsupported method.\n\n\n    this.error_(\"Target (\" + tagOrTarget + \") doesn't support \\\"\" + method + \"\\\" action.\", invocation.caller);\n    return null;\n  }\n  /**\n   * @param {!Element} target\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {?{node: !Element, actionInfos: !Array<!ActionInfoDef>}}\n   */\n  ;\n\n  _proto2.findAction_ = function findAction_(target, actionEventType, opt_stopAt) {\n    // Go from target up the DOM tree and find the applicable action.\n    var n = target;\n\n    while (n) {\n      if (opt_stopAt && n == opt_stopAt) {\n        return null;\n      }\n\n      var actionInfos = this.matchActionInfos_(n, actionEventType);\n\n      if (actionInfos && (0, _dom.isEnabled)(n)) {\n        return {\n          node: n,\n          actionInfos: (0, _log.devAssert)(actionInfos)\n        };\n      }\n\n      n = n.parentElement;\n    }\n\n    return null;\n  }\n  /**\n   * @param {!Element} node\n   * @param {string} actionEventType\n   * @return {?Array<!ActionInfoDef>}\n   */\n  ;\n\n  _proto2.matchActionInfos_ = function matchActionInfos_(node, actionEventType) {\n    var actionMap = this.getActionMap_(node, actionEventType);\n\n    if (!actionMap) {\n      return null;\n    }\n\n    return actionMap[actionEventType] || null;\n  }\n  /**\n   * @param {!Element} node\n   * @param {string} actionEventType\n   * @return {?Object<string, !Array<!ActionInfoDef>>}\n   */\n  ;\n\n  _proto2.getActionMap_ = function getActionMap_(node, actionEventType) {\n    var actionMap = node[ACTION_MAP_];\n\n    if (actionMap === undefined) {\n      actionMap = null;\n\n      if (node.hasAttribute('on')) {\n        var action = node.getAttribute('on');\n        actionMap = parseActionMap(action, node);\n        node[ACTION_MAP_] = actionMap;\n      } else if (node.hasAttribute('execute')) {\n        var _action = node.getAttribute('execute');\n\n        actionMap = parseActionMap(actionEventType + \":\" + _action, node);\n        node[ACTION_MAP_] = actionMap;\n      }\n    }\n\n    return actionMap;\n  }\n  /**\n   * Resets a node's actions with those defined in the given actions string.\n   * @param {!Element} node\n   * @param {string} actionsStr\n   */\n  ;\n\n  _proto2.setActions = function setActions(node, actionsStr) {\n    node.setAttribute('on', actionsStr); // Clear cache.\n\n    delete node[ACTION_MAP_];\n  }\n  /**\n   * Searches for a whitelist meta tag, parses and returns its contents.\n   *\n   * For example:\n   * <meta name=\"amp-action-whitelist\" content=\"AMP.setState, amp-form.submit\">\n   *\n   * Returns:\n   * [{tagOrTarget: 'AMP', method: 'setState'},\n   *  {tagOrTarget: 'AMP-FORM', method: 'submit'}]\n   *\n   * @return {?Array<{tagOrTarget: string, method: string}>}\n   * @private\n   */\n  ;\n\n  _proto2.queryWhitelist_ = function queryWhitelist_() {\n    var _this5 = this;\n\n    var _this$ampdoc$getRootN = this.ampdoc.getRootNode(),\n        head = _this$ampdoc$getRootN.head;\n\n    if (!head) {\n      return null;\n    }\n\n    var meta = head.querySelector('meta[name=\"amp-action-whitelist\"]');\n\n    if (!meta) {\n      return null;\n    }\n\n    return meta.getAttribute('content').split(',') // Turn an empty string whitelist into an empty array, otherwise the\n    // parse error in the mapper below would trigger.\n    .filter(function (action) {\n      return action;\n    }).map(function (action) {\n      var parts = action.split('.');\n\n      if (parts.length < 2) {\n        _this5.error_(\"Invalid action whitelist entry: \" + action + \".\");\n\n        return;\n      }\n\n      var tagOrTarget = parts[0].trim();\n      var method = parts[1].trim();\n      return {\n        tagOrTarget: tagOrTarget,\n        method: method\n      };\n    }) // Filter out undefined elements because of the parse error above.\n    .filter(function (action) {\n      return action;\n    });\n  }\n  /**\n   * Given a browser 'change' or 'input' event, add `details` property to it\n   * containing whitelisted properties of the target element.\n   * @param {!ActionEventDef} event\n   * @private\n   */\n  ;\n\n  _proto2.addTargetPropertiesAsDetail_ = function addTargetPropertiesAsDetail_(event) {\n    var detail =\n    /** @type {!JsonObject} */\n    (0, _object.map)();\n    var target = event.target;\n\n    if (target.value !== undefined) {\n      detail['value'] = target.value;\n    } // Check tagName instead since `valueAsNumber` isn't supported on IE.\n\n\n    if (target.tagName == 'INPUT') {\n      // Probably supported natively but convert anyways for consistency.\n      detail['valueAsNumber'] = Number(target.value);\n    }\n\n    if (target.checked !== undefined) {\n      detail['checked'] = target.checked;\n    }\n\n    if (target.min !== undefined || target.max !== undefined) {\n      detail['min'] = target.min;\n      detail['max'] = target.max;\n    }\n\n    if (Object.keys(detail).length > 0) {\n      event.detail = detail;\n    }\n  };\n\n  return ActionService;\n}();\n/**\n * @param {string} lowercaseTagName\n * @return {boolean}\n * @private\n */\n\n\nexports.ActionService = ActionService;\n\nfunction isAmpTagName(lowercaseTagName) {\n  return lowercaseTagName.substring(0, 4) === 'amp-';\n}\n/**\n * Returns `true` if the given action invocation is whitelisted in the given\n * whitelist. Default actions' alias, 'activate', are automatically\n * whitelisted if their corresponding registered alias is whitelisted.\n * @param {!ActionInvocation} invocation\n * @param {!Array<{tagOrTarget: string, method: string}>} whitelist\n * @return {boolean}\n * @private\n */\n\n\nfunction isActionWhitelisted(invocation, whitelist) {\n  var method = invocation.method;\n  var node = invocation.node,\n      tagOrTarget = invocation.tagOrTarget; // Use alias if default action is invoked.\n\n  if (method === _actionConstants.DEFAULT_ACTION && typeof node.getDefaultActionAlias == 'function') {\n    method = node.getDefaultActionAlias();\n  }\n\n  var lcMethod = method.toLowerCase();\n  var lcTagOrTarget = tagOrTarget.toLowerCase();\n  return whitelist.some(function (w) {\n    if (w.tagOrTarget.toLowerCase() === lcTagOrTarget || w.tagOrTarget === '*') {\n      if (w.method.toLowerCase() === lcMethod) {\n        return true;\n      }\n    }\n\n    return false;\n  });\n}\n/**\n * A clone of an event object with its function properties replaced.\n * This is useful e.g. for event objects that need to be passed to an async\n * context, but the browser might have cleaned up the original event object.\n * This clone replaces functions with error throws since they won't behave\n * normally after the original object has been destroyed.\n * @private visible for testing\n */\n\n\nvar DeferredEvent =\n/**\n * @param {!Event} event\n */\nfunction DeferredEvent(event) {\n  /** @type {?Object} */\n  this.detail = null;\n  cloneWithoutFunctions(event, this);\n};\n/**\n * Clones an object and replaces its function properties with throws.\n * @param {!T} original\n * @param {!T=} opt_dest\n * @return {!T}\n * @template T\n * @private\n */\n\n\nexports.DeferredEvent = DeferredEvent;\n\nfunction cloneWithoutFunctions(original, opt_dest) {\n  var clone = opt_dest || (0, _object.map)();\n\n  for (var prop in original) {\n    var value = original[prop];\n\n    if (typeof value === 'function') {\n      clone[prop] = notImplemented;\n    } else {\n      clone[prop] = original[prop];\n    }\n  }\n\n  return clone;\n}\n/** @private */\n\n\nfunction notImplemented() {\n  (0, _log.devAssert)(null, 'Deferred events cannot access native event functions.');\n}\n/**\n * @param {string} action\n * @param {!Element} context\n * @return {?Object<string, !Array<!ActionInfoDef>>}\n * @private Visible for testing only.\n */\n\n\nfunction parseActionMap(action, context) {\n  var assertAction = assertActionForParser.bind(null, action, context);\n  var assertToken = assertTokenForParser.bind(null, action, context);\n  var actionMap = null;\n  var toks = new ParserTokenizer(action);\n  var tok;\n  var peek;\n\n  do {\n    tok = toks.next();\n\n    if (tok.type == TokenType.EOF || tok.type == TokenType.SEPARATOR && tok.value == ';') {// Expected, ignore.\n    } else if (tok.type == TokenType.LITERAL || tok.type == TokenType.ID) {\n      // Format: event:target.method\n      // Event: \"event:\"\n      var event = tok.value; // Target: \":target.\" separator\n\n      assertToken(toks.next(), [TokenType.SEPARATOR], ':');\n      var actions = []; // Handlers for event.\n\n      do {\n        var target = assertToken(toks.next(), [TokenType.LITERAL, TokenType.ID]).value; // Method: \".method\". Method is optional.\n\n        var method = _actionConstants.DEFAULT_ACTION;\n        var args = null;\n        peek = toks.peek();\n\n        if (peek.type == TokenType.SEPARATOR && peek.value == '.') {\n          toks.next(); // Skip '.'\n\n          method = assertToken(toks.next(), [TokenType.LITERAL, TokenType.ID]).value || method; // Optionally, there may be arguments: \"(key = value, key = value)\".\n\n          peek = toks.peek();\n\n          if (peek.type == TokenType.SEPARATOR && peek.value == '(') {\n            toks.next(); // Skip '('\n\n            args = tokenizeMethodArguments(toks, assertToken, assertAction);\n          }\n        }\n\n        actions.push({\n          event: event,\n          target: target,\n          method: method,\n          args: args && (0, _mode.getMode)().test && Object.freeze ? Object.freeze(args) : args,\n          str: action\n        });\n        peek = toks.peek();\n      } while (peek.type == TokenType.SEPARATOR && peek.value == ',' && toks.next()); // skip \",\" when found\n\n\n      if (!actionMap) {\n        actionMap = (0, _object.map)();\n      }\n\n      actionMap[event] = actions;\n    } else {\n      // Unexpected token.\n      assertAction(false, \"; unexpected token [\" + (tok.value || '') + \"]\");\n    }\n  } while (tok.type != TokenType.EOF);\n\n  return actionMap;\n}\n/**\n * Tokenizes and returns method arguments, e.g. target.method(arguments).\n * @param {!ParserTokenizer} toks\n * @param {!Function} assertToken\n * @param {!Function} assertAction\n * @return {?ActionInfoArgsDef}\n * @private\n */\n\n\nfunction tokenizeMethodArguments(toks, assertToken, assertAction) {\n  var peek = toks.peek();\n  var tok;\n  var args = null; // Object literal. Format: {...}\n\n  if (peek.type == TokenType.OBJECT) {\n    // Don't parse object literals. Tokenize as a single expression\n    // fragment and delegate to specific action handler.\n    args = (0, _object.map)();\n\n    var _toks$next = toks.next(),\n        value = _toks$next.value;\n\n    args[_actionConstants.RAW_OBJECT_ARGS_KEY] = value;\n    assertToken(toks.next(), [TokenType.SEPARATOR], ')');\n  } else {\n    // Key-value pairs. Format: key = value, ....\n    do {\n      tok = toks.next();\n      var _tok = tok,\n          type = _tok.type,\n          _value = _tok.value;\n\n      if (type == TokenType.SEPARATOR && (_value == ',' || _value == ')')) {// Expected: ignore.\n      } else if (type == TokenType.LITERAL || type == TokenType.ID) {\n        // Key: \"key = \"\n        assertToken(toks.next(), [TokenType.SEPARATOR], '='); // Value is either a literal or an expression: \"foo.bar.baz\"\n\n        tok = assertToken(toks.next(\n        /* convertValue */\n        true), [TokenType.LITERAL, TokenType.ID]);\n        var argValueTokens = [tok]; // Expressions have one or more dereferences: \".identifier\"\n\n        if (tok.type == TokenType.ID) {\n          for (peek = toks.peek(); peek.type == TokenType.SEPARATOR && peek.value == '.'; peek = toks.peek()) {\n            toks.next(); // Skip '.'.\n\n            tok = assertToken(toks.next(false), [TokenType.ID]);\n            argValueTokens.push(tok);\n          }\n        }\n\n        var argValue = argValueForTokens(argValueTokens);\n\n        if (!args) {\n          args = (0, _object.map)();\n        }\n\n        args[_value] = argValue;\n        peek = toks.peek();\n        assertAction(peek.type == TokenType.SEPARATOR && (peek.value == ',' || peek.value == ')'), 'Expected either [,] or [)]');\n      } else {\n        // Unexpected token.\n        assertAction(false, \"; unexpected token [\" + (tok.value || '') + \"]\");\n      }\n    } while (!(tok.type == TokenType.SEPARATOR && tok.value == ')'));\n  }\n\n  return args;\n}\n/**\n * @param {Array<!TokenDef>} tokens\n * @return {?ActionInfoArgValueDef}\n * @private\n */\n\n\nfunction argValueForTokens(tokens) {\n  if (tokens.length == 0) {\n    return null;\n  } else if (tokens.length == 1) {\n    return (\n      /** @type {(boolean|number|string)} */\n      tokens[0].value\n    );\n  } else {\n    var values = tokens.map(function (token) {\n      return token.value;\n    });\n    var expression = values.join('.');\n    return (\n      /** @type {ActionInfoArgExpressionDef} */\n      {\n        expression: expression\n      }\n    );\n  }\n}\n/**\n * Dereferences expression args in `args` using values in data.\n * @param {?ActionInfoArgsDef} args\n * @param {?ActionEventDef} event\n * @param {?JsonObject=} opt_args\n * @return {?JsonObject}\n * @private\n */\n\n\nfunction dereferenceArgsVariables(args, event, opt_args) {\n  if (!args) {\n    return args;\n  }\n\n  var data = opt_args || (0, _object.dict)({});\n\n  if (event) {\n    var detail = (0, _eventHelper.getDetail)(\n    /** @type {!Event} */\n    event);\n\n    if (detail) {\n      data['event'] = detail;\n    }\n  }\n\n  var applied = (0, _object.map)();\n  Object.keys(args).forEach(function (key) {\n    var value = args[key]; // Only JSON expression strings that contain dereferences (e.g. `foo.bar`)\n    // are processed as ActionInfoArgExpressionDef. We also support\n    // dereferencing strings like `foo` iff there is a corresponding key in\n    // `data`. Otherwise, `foo` is treated as a string \"foo\".\n\n    if (typeof value == 'object' && value.expression) {\n      var expr =\n      /** @type {ActionInfoArgExpressionDef} */\n      value.expression;\n      var exprValue = (0, _json.getValueForExpr)(data, expr); // If expr can't be found in data, use null instead of undefined.\n\n      value = exprValue === undefined ? null : exprValue;\n    }\n\n    if (data[value]) {\n      applied[key] = data[value];\n    } else {\n      applied[key] = value;\n    }\n  });\n  return applied;\n}\n/**\n * @param {string} s\n * @param {!Element} context\n * @param {?T} condition\n * @param {string=} opt_message\n * @return {T}\n * @template T\n * @private\n */\n\n\nfunction assertActionForParser(s, context, condition, opt_message) {\n  return (0, _log.userAssert)(condition, 'Invalid action definition in %s: [%s] %s', context, s, opt_message || '');\n}\n/**\n * @param {string} s\n * @param {!Element} context\n * @param {!TokenDef} tok\n * @param {Array<TokenType>} types\n * @param {*=} opt_value\n * @return {!TokenDef}\n * @private\n */\n\n\nfunction assertTokenForParser(s, context, tok, types, opt_value) {\n  if (opt_value !== undefined) {\n    assertActionForParser(s, context, types.includes(tok.type) && tok.value == opt_value, \"; expected [\" + opt_value + \"]\");\n  } else {\n    assertActionForParser(s, context, types.includes(tok.type));\n  }\n\n  return tok;\n}\n/**\n * @enum {number}\n */\n\n\nvar TokenType = {\n  INVALID: 0,\n  EOF: 1,\n  SEPARATOR: 2,\n  LITERAL: 3,\n  ID: 4,\n  OBJECT: 5\n};\n/**\n * @typedef {{type: TokenType, value: *}}\n */\n\nvar TokenDef;\n/** @private @const {string} */\n\nvar WHITESPACE_SET = \" \\t\\n\\r\\f\\x0B\\xA0\\u2028\\u2029\";\n/** @private @const {string} */\n\nvar SEPARATOR_SET = ';:.()=,|!';\n/** @private @const {string} */\n\nvar STRING_SET = '\"\\'';\n/** @private @const {string} */\n\nvar OBJECT_SET = '{}';\n/** @private @const {string} */\n\nvar SPECIAL_SET = WHITESPACE_SET + SEPARATOR_SET + STRING_SET + OBJECT_SET;\n/** @private */\n\nvar ParserTokenizer =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {string} str\n   */\n  function ParserTokenizer(str) {\n    /** @private @const {string} */\n    this.str_ = str;\n    /** @private {number} */\n\n    this.index_ = -1;\n  }\n  /**\n   * Returns the next token and advances the position.\n   * @param {boolean=} opt_convertValues\n   * @return {!TokenDef}\n   */\n\n\n  var _proto3 = ParserTokenizer.prototype;\n\n  _proto3.next = function next(opt_convertValues) {\n    var tok = this.next_(opt_convertValues || false);\n    this.index_ = tok.index;\n    return tok;\n  }\n  /**\n   * Returns the next token but keeps the current position.\n   * @param {boolean=} opt_convertValues\n   * @return {!TokenDef}\n   */\n  ;\n\n  _proto3.peek = function peek(opt_convertValues) {\n    return this.next_(opt_convertValues || false);\n  }\n  /**\n   * @param {boolean} convertValues\n   * @return {!{type: TokenType, value: *, index: number}}\n   */\n  ;\n\n  _proto3.next_ = function next_(convertValues) {\n    var newIndex = this.index_ + 1;\n\n    if (newIndex >= this.str_.length) {\n      return {\n        type: TokenType.EOF,\n        index: this.index_\n      };\n    }\n\n    var c = this.str_.charAt(newIndex); // Whitespace: standard set.\n\n    if (WHITESPACE_SET.indexOf(c) != -1) {\n      newIndex++;\n\n      for (; newIndex < this.str_.length; newIndex++) {\n        if (WHITESPACE_SET.indexOf(this.str_.charAt(newIndex)) == -1) {\n          break;\n        }\n      }\n\n      if (newIndex >= this.str_.length) {\n        return {\n          type: TokenType.EOF,\n          index: newIndex\n        };\n      }\n\n      c = this.str_.charAt(newIndex);\n    } // A numeric. Notice that it steals the `.` from separators.\n\n\n    if (convertValues && (isNum(c) || c == '.' && newIndex + 1 < this.str_.length && isNum(this.str_[newIndex + 1]))) {\n      var hasFraction = c == '.';\n\n      var _end = newIndex + 1;\n\n      for (; _end < this.str_.length; _end++) {\n        var c2 = this.str_.charAt(_end);\n\n        if (c2 == '.') {\n          hasFraction = true;\n          continue;\n        }\n\n        if (!isNum(c2)) {\n          break;\n        }\n      }\n\n      var _s = this.str_.substring(newIndex, _end);\n\n      var value = hasFraction ? parseFloat(_s) : parseInt(_s, 10);\n      newIndex = _end - 1;\n      return {\n        type: TokenType.LITERAL,\n        value: value,\n        index: newIndex\n      };\n    } // Different separators.\n\n\n    if (SEPARATOR_SET.indexOf(c) != -1) {\n      return {\n        type: TokenType.SEPARATOR,\n        value: c,\n        index: newIndex\n      };\n    } // String literal.\n\n\n    if (STRING_SET.indexOf(c) != -1) {\n      var _end2 = -1;\n\n      for (var i = newIndex + 1; i < this.str_.length; i++) {\n        if (this.str_.charAt(i) == c) {\n          _end2 = i;\n          break;\n        }\n      }\n\n      if (_end2 == -1) {\n        return {\n          type: TokenType.INVALID,\n          index: newIndex\n        };\n      }\n\n      var _value2 = this.str_.substring(newIndex + 1, _end2);\n\n      newIndex = _end2;\n      return {\n        type: TokenType.LITERAL,\n        value: _value2,\n        index: newIndex\n      };\n    } // Object literal.\n\n\n    if (c == '{') {\n      var numberOfBraces = 1;\n\n      var _end3 = -1;\n\n      for (var _i = newIndex + 1; _i < this.str_.length; _i++) {\n        var char = this.str_[_i];\n\n        if (char == '{') {\n          numberOfBraces++;\n        } else if (char == '}') {\n          numberOfBraces--;\n        }\n\n        if (numberOfBraces <= 0) {\n          _end3 = _i;\n          break;\n        }\n      }\n\n      if (_end3 == -1) {\n        return {\n          type: TokenType.INVALID,\n          index: newIndex\n        };\n      }\n\n      var _value3 = this.str_.substring(newIndex, _end3 + 1);\n\n      newIndex = _end3;\n      return {\n        type: TokenType.OBJECT,\n        value: _value3,\n        index: newIndex\n      };\n    } // Advance until next special character.\n\n\n    var end = newIndex + 1;\n\n    for (; end < this.str_.length; end++) {\n      if (SPECIAL_SET.indexOf(this.str_.charAt(end)) != -1) {\n        break;\n      }\n    }\n\n    var s = this.str_.substring(newIndex, end);\n    newIndex = end - 1; // Boolean literal.\n\n    if (convertValues && (s == 'true' || s == 'false')) {\n      var _value4 = s == 'true';\n\n      return {\n        type: TokenType.LITERAL,\n        value: _value4,\n        index: newIndex\n      };\n    } // Identifier.\n\n\n    if (!isNum(s.charAt(0))) {\n      return {\n        type: TokenType.ID,\n        value: s,\n        index: newIndex\n      };\n    } // Key.\n\n\n    return {\n      type: TokenType.LITERAL,\n      value: s,\n      index: newIndex\n    };\n  };\n\n  return ParserTokenizer;\n}();\n/**\n * Tests whether a chacter is a number.\n * @param {string} c\n * @return {boolean}\n */\n\n\nfunction isNum(c) {\n  return c >= '0' && c <= '9';\n}\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nfunction installActionServiceForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'action', ActionService,\n  /* opt_instantiate */\n  true);\n}\n\n},{\"../action-constants\":23,\"../dom\":41,\"../error\":44,\"../event-helper\":46,\"../json\":63,\"../log\":68,\"../mode\":70,\"../service\":79,\"../services\":123,\"../types\":131,\"../utils/key-codes\":142,\"../utils/object\":145,\"../utils/rate-limit\":148}],81:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.batchedXhrServiceForTesting = batchedXhrServiceForTesting;\nexports.installBatchedXhrService = installBatchedXhrService;\nexports.BatchedXhr = void 0;\n\nvar _xhrImpl = require(\"./xhr-impl\");\n\nvar _service = require(\"../service\");\n\nvar _object = require(\"../utils/object\");\n\nvar _url = require(\"../url\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/**\n * A wrapper around the Xhr service which batches the result of GET requests\n *\n * @package Visible for type.\n * @visibleForTesting\n */\nvar BatchedXhr =\n/*#__PURE__*/\nfunction (_Xhr) {\n  _inheritsLoose(BatchedXhr, _Xhr);\n\n  /**\n   * @param {!Window} win\n   */\n  function BatchedXhr(win) {\n    var _this;\n\n    _this = _Xhr.call(this, win) || this;\n    /** @const {!Object<!Promise<!Response>>} */\n\n    _this.fetchPromises_ = (0, _object.map)();\n    return _this;\n  }\n  /**\n   * Fetch and batch the requests if possible.\n   *\n   * @param {string} input URL\n   * @param {?FetchInitDef=} opt_init Fetch options object.\n   * @return {!Promise<!Response>}\n   * @override\n   */\n\n\n  var _proto = BatchedXhr.prototype;\n\n  _proto.fetch = function fetch(input, opt_init) {\n    var _this2 = this;\n\n    var accept = opt_init && opt_init.headers && opt_init.headers['Accept'] || '';\n    var isBatchable = !opt_init || !opt_init.method || opt_init.method === 'GET';\n    var key = this.getMapKey_(input, accept);\n    var isBatched = !!this.fetchPromises_[key];\n\n    if (isBatchable && isBatched) {\n      return this.fetchPromises_[key].then(function (response) {\n        return response.clone();\n      });\n    }\n\n    var fetchPromise = _Xhr.prototype.fetch.call(this, input, opt_init);\n\n    if (isBatchable) {\n      this.fetchPromises_[key] = fetchPromise.then(function (response) {\n        delete _this2.fetchPromises_[key];\n        return response.clone();\n      }, function (err) {\n        delete _this2.fetchPromises_[key];\n        throw err;\n      });\n    }\n\n    return fetchPromise;\n  }\n  /**\n   * Creates a map key for a fetch.\n   *\n   * @param {string} input URL\n   * @param {string} responseType\n   * @return {string}\n   * @private\n   */\n  ;\n\n  _proto.getMapKey_ = function getMapKey_(input, responseType) {\n    return (0, _url.removeFragment)(input) + responseType;\n  };\n\n  return BatchedXhr;\n}(_xhrImpl.Xhr);\n/**\n * @param {!Window} window\n * @return {!BatchedXhr}\n */\n\n\nexports.BatchedXhr = BatchedXhr;\n\nfunction batchedXhrServiceForTesting(window) {\n  installBatchedXhrService(window);\n  return (0, _service.getService)(window, 'batched-xhr');\n}\n/**\n * @param {!Window} window\n */\n\n\nfunction installBatchedXhrService(window) {\n  (0, _service.registerServiceBuilder)(window, 'batched-xhr', BatchedXhr);\n}\n\n},{\"../service\":79,\"../url\":134,\"../utils/object\":145,\"./xhr-impl\":122}],82:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.CacheCidApi = void 0;\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\nvar _object = require(\"../utils/object\");\n\nvar _url = require(\"../url\");\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The Client ID service key.\n * @const @private {string}\n */\nvar SERVICE_KEY_ = 'AIzaSyDKtqGxnoeIqVM33Uf7hRSa3GJxuzR7mLc';\n/**\n * Tag for debug logging.\n * @const @private {string}\n */\n\nvar TAG_ = 'CacheCidApi';\n/**\n * The URL for the cache-served CID API.\n * @const @private {string}\n */\n\nvar CACHE_API_URL = 'https://ampcid.google.com/v1/cache:getClientId?key=';\n/**\n * The XHR timeout in milliseconds for requests to the CID API.\n * @const @private {number}\n */\n\nvar TIMEOUT_ = 30000;\n/**\n * Exposes CID API for cache-served pages without a viewer.\n */\n\nvar CacheCidApi =\n/*#__PURE__*/\nfunction () {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  function CacheCidApi(ampdoc) {\n    /** @private {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n    /** @private {!./viewer-interface.ViewerInterface} */\n\n    this.viewer_ = _services.Services.viewerForDoc(this.ampdoc_);\n    /** @private {?Promise<?string>} */\n\n    this.publisherCidPromise_ = null;\n    /** @private {!./timer-impl.Timer} */\n\n    this.timer_ = _services.Services.timerFor(this.ampdoc_.win);\n  }\n  /**\n   * Returns true if the page is embedded in CCT and is served by a proxy.\n   * @return {boolean}\n   */\n\n\n  var _proto = CacheCidApi.prototype;\n\n  _proto.isSupported = function isSupported() {\n    return this.viewer_.isCctEmbedded() && this.viewer_.isProxyOrigin();\n  }\n  /**\n   * Returns scoped CID retrieved from the Viewer.\n   * @param {string} scope\n   * @return {!Promise<?string>}\n   */\n  ;\n\n  _proto.getScopedCid = function getScopedCid(scope) {\n    var _this = this;\n\n    if (!this.viewer_.isCctEmbedded()) {\n      return (\n        /** @type {!Promise<?string>} */\n        Promise.resolve(null)\n      );\n    }\n\n    if (!this.publisherCidPromise_) {\n      var url = CACHE_API_URL + SERVICE_KEY_;\n      this.publisherCidPromise_ = this.fetchCid_(url);\n    }\n\n    return this.publisherCidPromise_.then(function (publisherCid) {\n      return publisherCid ? _this.scopeCid_(publisherCid, scope) : null;\n    });\n  }\n  /**\n   * Returns scoped CID retrieved from the Viewer.\n   * @param {string} url\n   * @param {boolean=} useAlternate\n   * @return {!Promise<?string>}\n   */\n  ;\n\n  _proto.fetchCid_ = function fetchCid_(url, useAlternate) {\n    var _this2 = this;\n\n    if (useAlternate === void 0) {\n      useAlternate = true;\n    }\n\n    var payload = (0, _object.dict)({\n      'publisherOrigin': (0, _url.getSourceOrigin)(this.ampdoc_.win.location)\n    }); // Make the XHR request to the cache endpoint.\n\n    var timeoutMessage = 'fetchCidTimeout';\n    return this.timer_.timeoutPromise(TIMEOUT_, _services.Services.xhrFor(this.ampdoc_.win).fetchJson(url, {\n      method: 'POST',\n      ampCors: false,\n      credentials: 'include',\n      mode: 'cors',\n      body: payload\n    }), timeoutMessage).then(function (res) {\n      return res.json().then(function (response) {\n        if (response['optOut']) {\n          return null;\n        }\n\n        var cid = response['publisherClientId'];\n\n        if (!cid && useAlternate && response['alternateUrl']) {\n          // If an alternate url is provided, try again with the alternate url\n          // The client is still responsible for appending API keys to the URL.\n          var alt = response['alternateUrl'] + \"?key=\" + SERVICE_KEY_;\n          return _this2.fetchCid_((0, _log.dev)().assertString(alt), false);\n        }\n\n        return cid;\n      });\n    }).catch(function (e) {\n      if (e && e.response) {\n        e.response.json().then(function (res) {\n          (0, _log.dev)().error(TAG_, JSON.stringify(res));\n        });\n      } else {\n        var isTimeout = e && e.message == timeoutMessage;\n\n        if (isTimeout) {\n          (0, _log.dev)().expectedError(TAG_, e);\n        } else {\n          (0, _log.dev)().error(TAG_, e);\n        }\n      }\n\n      return null;\n    });\n  }\n  /**\n   * Returns scoped CID extracted from the fetched publisherCid.\n   * @param {string} publisherCid\n   * @param {string} scope\n   * @return {!Promise<string>}\n   */\n  ;\n\n  _proto.scopeCid_ = function scopeCid_(publisherCid, scope) {\n    var text = publisherCid + ';' + scope;\n    return _services.Services.cryptoFor(this.ampdoc_.win).sha384Base64(text).then(function (enc) {\n      return 'amp-' + enc;\n    });\n  };\n\n  return CacheCidApi;\n}();\n\nexports.CacheCidApi = CacheCidApi;\n\n},{\"../log\":68,\"../services\":123,\"../url\":134,\"../utils/object\":145}],83:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.GoogleCidApi = exports.TokenStatus = void 0;\n\nvar _services = require(\"../services\");\n\nvar _windowInterface = require(\"../window-interface\");\n\nvar _log = require(\"../log\");\n\nvar _object = require(\"../utils/object\");\n\nvar _cookies = require(\"../cookies\");\n\nvar _url = require(\"../url\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar GOOGLE_API_URL = 'https://ampcid.google.com/v1/publisher:getClientId?key=';\nvar TAG = 'GoogleCidApi';\nvar AMP_TOKEN = 'AMP_TOKEN';\n/** @enum {string} */\n\nvar TokenStatus = {\n  RETRIEVING: '$RETRIEVING',\n  OPT_OUT: '$OPT_OUT',\n  NOT_FOUND: '$NOT_FOUND',\n  ERROR: '$ERROR'\n};\nexports.TokenStatus = TokenStatus;\nvar TIMEOUT = 30000;\nvar HOUR = 60 * 60 * 1000;\nvar DAY = 24 * HOUR;\nvar YEAR = 365 * DAY;\n/**\n * Client impl for Google CID API\n */\n\nvar GoogleCidApi =\n/*#__PURE__*/\nfunction () {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  function GoogleCidApi(ampdoc) {\n    /**\n     * @private {!Window}\n     */\n    this.win_ = ampdoc.win;\n    /**\n     * @private {!./timer-impl.Timer}\n     */\n\n    this.timer_ = _services.Services.timerFor(this.win_);\n    /**\n     * @private {!Object<string, !Promise<?string>>}\n     */\n\n    this.cidPromise_ = {};\n\n    var _Services$documentInf = _services.Services.documentInfoForDoc(ampdoc),\n        canonicalUrl = _Services$documentInf.canonicalUrl;\n    /** @private {?string} */\n\n\n    this.canonicalOrigin_ = canonicalUrl ? (0, _url.parseUrlDeprecated)(canonicalUrl).origin : null;\n  }\n  /**\n   * @param {string} apiKey\n   * @param {string} scope\n   * @return {!Promise<?string>}\n   */\n\n\n  var _proto = GoogleCidApi.prototype;\n\n  _proto.getScopedCid = function getScopedCid(apiKey, scope) {\n    var _this = this;\n\n    if (this.cidPromise_[scope]) {\n      return this.cidPromise_[scope];\n    }\n\n    var token; // Block the request if a previous request is on flight\n    // Poll every 200ms. Longer interval means longer latency for the 2nd CID.\n\n    return this.cidPromise_[scope] = this.timer_.poll(200, function () {\n      token = (0, _cookies.getCookie)(_this.win_, AMP_TOKEN);\n      return token !== TokenStatus.RETRIEVING;\n    }).then(function () {\n      if (token === TokenStatus.OPT_OUT) {\n        return TokenStatus.OPT_OUT;\n      } // If the page referrer is proxy origin, we force to use API even the\n      // token indicates a previous fetch returned nothing\n\n\n      var forceFetch = token === TokenStatus.NOT_FOUND && _this.isReferrerProxyOrigin_(); // Token is in a special state, fallback to existing cookie\n\n\n      if (!forceFetch && _this.isStatusToken_(token)) {\n        return null;\n      }\n\n      if (!token || _this.isStatusToken_(token)) {\n        _this.persistToken_(TokenStatus.RETRIEVING, TIMEOUT);\n      }\n\n      var url = GOOGLE_API_URL + apiKey;\n      return _this.fetchCid_((0, _log.dev)().assertString(url), scope, token).then(function (response) {\n        var cid = _this.handleResponse_(response);\n\n        if (!cid && response['alternateUrl']) {\n          // If an alternate url is provided, try again with the alternate\n          // url The client is still responsible for appending API keys to\n          // the URL.\n          var altUrl = response['alternateUrl'] + \"?key=\" + apiKey;\n          return _this.fetchCid_((0, _log.dev)().assertString(altUrl), scope, token).then(_this.handleResponse_.bind(_this));\n        }\n\n        return cid;\n      }).catch(function (e) {\n        _this.persistToken_(TokenStatus.ERROR, TIMEOUT);\n\n        if (e && e.response) {\n          e.response.json().then(function (res) {\n            (0, _log.dev)().error(TAG, JSON.stringify(res));\n          });\n        } else {\n          (0, _log.dev)().error(TAG, e);\n        }\n\n        return null;\n      });\n    });\n  }\n  /**\n   * @param {string} url\n   * @param {string} scope\n   * @param {?string} token\n   * @return {!Promise<!JsonObject>}\n   */\n  ;\n\n  _proto.fetchCid_ = function fetchCid_(url, scope, token) {\n    var payload = (0, _object.dict)({\n      'originScope': scope,\n      'canonicalOrigin': this.canonicalOrigin_\n    });\n\n    if (token) {\n      payload['securityToken'] = token;\n    }\n\n    return this.timer_.timeoutPromise(TIMEOUT, _services.Services.xhrFor(this.win_).fetchJson(url, {\n      method: 'POST',\n      ampCors: false,\n      credentials: 'include',\n      mode: 'cors',\n      body: payload\n    }).then(function (res) {\n      return res.json();\n    }));\n  }\n  /**\n   * @param {!JsonObject} res\n   * @return {?string}\n   */\n  ;\n\n  _proto.handleResponse_ = function handleResponse_(res) {\n    if (res['optOut']) {\n      this.persistToken_(TokenStatus.OPT_OUT, YEAR);\n      return TokenStatus.OPT_OUT;\n    }\n\n    if (res['clientId']) {\n      this.persistToken_(res['securityToken'], YEAR);\n      return res['clientId'];\n    }\n\n    if (res['alternateUrl']) {\n      return null;\n    }\n\n    this.persistToken_(TokenStatus.NOT_FOUND, HOUR);\n    return null;\n  }\n  /**\n   * @param {string|undefined} tokenValue\n   * @param {number} expires\n   */\n  ;\n\n  _proto.persistToken_ = function persistToken_(tokenValue, expires) {\n    if (tokenValue) {\n      (0, _cookies.setCookie)(this.win_, AMP_TOKEN, tokenValue, this.expiresIn_(expires), {\n        highestAvailableDomain: true\n      });\n    }\n  }\n  /**\n   * @param {number} time\n   * @return {number}\n   */\n  ;\n\n  _proto.expiresIn_ = function expiresIn_(time) {\n    return this.win_.Date.now() + time;\n  }\n  /**\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isReferrerProxyOrigin_ = function isReferrerProxyOrigin_() {\n    return (0, _url.isProxyOrigin)(_windowInterface.WindowInterface.getDocumentReferrer(this.win_));\n  }\n  /**\n   * @param {?string} token\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isStatusToken_ = function isStatusToken_(token) {\n    return (\n      /** @type {boolean} */\n      token && token[0] === '$'\n    );\n  };\n\n  return GoogleCidApi;\n}();\n\nexports.GoogleCidApi = GoogleCidApi;\n\n},{\"../cookies\":35,\"../log\":68,\"../services\":123,\"../url\":134,\"../utils/object\":145,\"../window-interface\":152}],84:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.optOutOfCid = optOutOfCid;\nexports.isOptedOutOfCid = isOptedOutOfCid;\nexports.getProxySourceOrigin = getProxySourceOrigin;\nexports.viewerBaseCid = viewerBaseCid;\nexports.getRandomString64 = getRandomString64;\nexports.installCidService = installCidService;\nexports.cidServiceForDocForTesting = cidServiceForDocForTesting;\nexports.CidDef = exports.BASE_CID_MAX_AGE_MILLIS = void 0;\n\nvar _cidApi = require(\"./cid-api\");\n\nvar _log = require(\"../log\");\n\nvar _cookies = require(\"../cookies\");\n\nvar _service = require(\"../service\");\n\nvar _url = require(\"../url\");\n\nvar _json = require(\"../json\");\n\nvar _cacheCidApi = require(\"./cache-cid-api\");\n\nvar _services = require(\"../services\");\n\nvar _viewerCidApi = require(\"./viewer-cid-api\");\n\nvar _base = require(\"../utils/base64\");\n\nvar _object = require(\"../utils/object\");\n\nvar _bytes = require(\"../utils/bytes\");\n\nvar _dom = require(\"../dom\");\n\nvar _promise = require(\"../utils/promise\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Provides per AMP document source origin and use case\n * persistent client identifiers for use in analytics and similar use\n * cases.\n *\n * For details, see https://goo.gl/Mwaacs\n */\nvar ONE_DAY_MILLIS = 24 * 3600 * 1000;\n/**\n * We ignore base cids that are older than (roughly) one year.\n */\n\nvar BASE_CID_MAX_AGE_MILLIS = 365 * ONE_DAY_MILLIS;\nexports.BASE_CID_MAX_AGE_MILLIS = BASE_CID_MAX_AGE_MILLIS;\nvar SCOPE_NAME_VALIDATOR = /^[a-zA-Z0-9-_.]+$/;\nvar CID_OPTOUT_STORAGE_KEY = 'amp-cid-optout';\nvar CID_OPTOUT_VIEWER_MESSAGE = 'cidOptOut';\n/**\n * Tag for debug logging.\n * @const @private {string}\n */\n\nvar TAG_ = 'CID';\n/**\n * The name of the Google CID API as it appears in the meta tag to opt-in.\n * @const @private {string}\n */\n\nvar GOOGLE_CID_API_META_NAME = 'amp-google-client-id-api';\n/**\n * The mapping from analytics providers to CID scopes.\n * @const @private {Object<string, string>}\n */\n\nvar CID_API_SCOPE_WHITELIST = {\n  'googleanalytics': 'AMP_ECID_GOOGLE'\n};\n/**\n * The mapping from analytics providers to their CID API service keys.\n * @const @private {Object<string, string>}\n */\n\nvar API_KEYS = {\n  'googleanalytics': 'AIzaSyA65lEHUEizIsNtlbNo-l2K18dT680nsaM'\n};\n/**\n * A base cid string value and the time it was last read / stored.\n * @typedef {{time: time, cid: string}}\n */\n\nvar BaseCidInfoDef;\n/**\n * The \"get CID\" parameters.\n * - createCookieIfNotPresent: Whether CID is allowed to create a cookie when.\n *   Default value is `false`.\n * @typedef {{\n *   scope: string,\n *   createCookieIfNotPresent: (boolean|undefined),\n *   cookieName: (string|undefined),\n * }}\n */\n\nvar GetCidDef;\n/**\n * @interface\n */\n\nvar CidDef =\n/*#__PURE__*/\nfunction () {\n  function CidDef() {}\n\n  var _proto = CidDef.prototype;\n\n  /**\n   * @param {!GetCidDef} unusedGetCidStruct an object provides CID scope name for\n   *     proxy case and cookie name for non-proxy case.\n   * @param {!Promise} unusedConsent Promise for when the user has given consent\n   *     (if deemed necessary by the publisher) for use of the client\n   *     identifier.\n   * @param {!Promise=} opt_persistenceConsent Dedicated promise for when\n   *     it is OK to persist a new tracking identifier. This could be\n   *     supplied ONLY by the code that supplies the actual consent\n   *     cookie.\n   *     If this is given, the consent param should be a resolved promise\n   *     because this call should be only made in order to get consent.\n   *     The consent promise passed to other calls should then itself\n   *     depend on the opt_persistenceConsent promise (and the actual\n   *     consent, of course).\n   * @return {!Promise<?string>} A client identifier that should be used\n   *      within the current source origin and externalCidScope. Might be\n   *      null if user has opted out of cid or no identifier was found\n   *      or it could be made.\n   *      This promise may take a long time to resolve if consent isn't\n   *      given.\n   */\n  _proto.get = function get(unusedGetCidStruct, unusedConsent, opt_persistenceConsent) {}\n  /**\n   * User will be opted out of Cid issuance for all scopes.\n   * When opted-out Cid service will reject all `get` requests.\n   *\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.optOut = function optOut() {};\n\n  return CidDef;\n}();\n/**\n * @implements {CidDef}\n */\n\n\nexports.CidDef = CidDef;\n\nvar Cid =\n/*#__PURE__*/\nfunction () {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  function Cid(ampdoc) {\n    /** @const */\n    this.ampdoc = ampdoc;\n    /**\n     * Cached base cid once read from storage to avoid repeated\n     * reads.\n     * @private {?Promise<string>}\n     * @restricted\n     */\n\n    this.baseCid_ = null;\n    /**\n     * Cache to store external cids. Scope is used as the key and cookie value\n     * is the value.\n     * @private {!Object<string, !Promise<string>>}\n     * @restricted\n     */\n\n    this.externalCidCache_ = Object.create(null);\n    /**\n     * @private @const {!CacheCidApi}\n     */\n\n    this.cacheCidApi_ = new _cacheCidApi.CacheCidApi(ampdoc);\n    /**\n     * @private {!ViewerCidApi}\n     */\n\n    this.viewerCidApi_ = new _viewerCidApi.ViewerCidApi(ampdoc);\n    this.cidApi_ = new _cidApi.GoogleCidApi(ampdoc);\n    /** @private {?Object<string, string>} */\n\n    this.apiKeyMap_ = null;\n  }\n  /** @override */\n\n\n  var _proto2 = Cid.prototype;\n\n  _proto2.get = function get(getCidStruct, consent, opt_persistenceConsent) {\n    var _this = this;\n\n    (0, _log.userAssert)(SCOPE_NAME_VALIDATOR.test(getCidStruct.scope) && SCOPE_NAME_VALIDATOR.test(getCidStruct.cookieName), 'The CID scope and cookie name must only use the characters ' + '[a-zA-Z0-9-_.]+\\nInstead found: %s', getCidStruct.scope);\n    return consent.then(function () {\n      return _this.ampdoc.whenFirstVisible();\n    }).then(function () {\n      // Check if user has globally opted out of CID, we do this after\n      // consent check since user can optout during consent process.\n      return isOptedOutOfCid(_this.ampdoc);\n    }).then(function (optedOut) {\n      if (optedOut) {\n        return '';\n      }\n\n      var cidPromise = _this.getExternalCid_(getCidStruct, opt_persistenceConsent || consent); // Getting the CID might involve an HTTP request. We timeout after 10s.\n\n\n      return _services.Services.timerFor(_this.ampdoc.win).timeoutPromise(10000, cidPromise, \"Getting cid for \\\"\" + getCidStruct.scope + \"\\\" timed out\").catch(function (error) {\n        (0, _log.rethrowAsync)(error);\n      });\n    });\n  }\n  /** @override */\n  ;\n\n  _proto2.optOut = function optOut() {\n    return optOutOfCid(this.ampdoc);\n  }\n  /**\n   * Returns the \"external cid\". This is a cid for a specific purpose\n   * (Say Analytics provider X). It is unique per user, userAssert, that purpose\n   * and the AMP origin site.\n   * @param {!GetCidDef} getCidStruct\n   * @param {!Promise} persistenceConsent\n   * @return {!Promise<?string>}\n   */\n  ;\n\n  _proto2.getExternalCid_ = function getExternalCid_(getCidStruct, persistenceConsent) {\n    var _this2 = this;\n\n    var scope = getCidStruct.scope;\n    /** @const {!Location} */\n\n    var url = (0, _url.parseUrlDeprecated)(this.ampdoc.win.location.href);\n\n    if (!(0, _url.isProxyOrigin)(url)) {\n      var apiKey = this.isScopeOptedIn_(scope);\n\n      if (apiKey) {\n        return this.cidApi_.getScopedCid(apiKey, scope).then(function (scopedCid) {\n          if (scopedCid == _cidApi.TokenStatus.OPT_OUT) {\n            return null;\n          }\n\n          if (scopedCid) {\n            var cookieName = getCidStruct.cookieName || scope;\n            setCidCookie(_this2.ampdoc.win, cookieName, scopedCid);\n            return scopedCid;\n          }\n\n          return getOrCreateCookie(_this2, getCidStruct, persistenceConsent);\n        });\n      }\n\n      return getOrCreateCookie(this, getCidStruct, persistenceConsent);\n    }\n\n    return this.viewerCidApi_.isSupported().then(function (supported) {\n      if (supported) {\n        var _apiKey = _this2.isScopeOptedIn_(scope);\n\n        return _this2.viewerCidApi_.getScopedCid(_apiKey, scope);\n      }\n\n      if (_this2.cacheCidApi_.isSupported() && _this2.isScopeOptedIn_(scope)) {\n        return _this2.cacheCidApi_.getScopedCid(scope).then(function (scopedCid) {\n          if (scopedCid) {\n            return scopedCid;\n          }\n\n          return _this2.scopeBaseCid_(persistenceConsent, scope, url);\n        });\n      }\n\n      return _this2.scopeBaseCid_(persistenceConsent, scope, url);\n    });\n  }\n  /**\n   *\n   * @param {!Promise} persistenceConsent\n   * @param {*} scope\n   * @param {!Location} url\n   * @return {*}\n   */\n  ;\n\n  _proto2.scopeBaseCid_ = function scopeBaseCid_(persistenceConsent, scope, url) {\n    var _this3 = this;\n\n    return getBaseCid(this, persistenceConsent).then(function (baseCid) {\n      return _services.Services.cryptoFor(_this3.ampdoc.win).sha384Base64(baseCid + getProxySourceOrigin(url) + scope);\n    });\n  }\n  /**\n   * Checks if the page has opted in CID API for the given scope.\n   * Returns the API key that should be used, or null if page hasn't opted in.\n   *\n   * @param {string} scope\n   * @return {string|undefined}\n   */\n  ;\n\n  _proto2.isScopeOptedIn_ = function isScopeOptedIn_(scope) {\n    if (!this.apiKeyMap_) {\n      this.apiKeyMap_ = this.getOptedInScopes_();\n    }\n\n    return this.apiKeyMap_[scope];\n  }\n  /**\n   * Reads meta tags for opted in scopes.  Meta tags will have the form\n   * <meta name=\"provider-api-name\" content=\"provider-name\">\n   * @return {!Object<string, string>}\n   */\n  ;\n\n  _proto2.getOptedInScopes_ = function getOptedInScopes_() {\n    var apiKeyMap = {};\n    var optInMeta = this.ampdoc.win.document.head.\n    /*OK*/\n    querySelector(\"meta[name=\" + GOOGLE_CID_API_META_NAME + \"]\");\n\n    if (optInMeta && optInMeta.hasAttribute('content')) {\n      var list = optInMeta.getAttribute('content').split(',');\n      list.forEach(function (item) {\n        item = item.trim();\n\n        if (item.indexOf('=') > 0) {\n          var pair = item.split('=');\n          var scope = pair[0].trim();\n          apiKeyMap[scope] = pair[1].trim();\n        } else {\n          var clientName = item;\n          var _scope = CID_API_SCOPE_WHITELIST[clientName];\n\n          if (_scope) {\n            apiKeyMap[_scope] = API_KEYS[clientName];\n          } else {\n            (0, _log.user)().warn(TAG_, \"Unsupported client for Google CID API: \" + clientName + \".\" + (\"Please remove or correct \" + optInMeta.\n            /*OK*/\n            outerHTML));\n          }\n        }\n      });\n    }\n\n    return apiKeyMap;\n  };\n\n  return Cid;\n}();\n/**\n * User will be opted out of Cid issuance for all scopes.\n * When opted-out Cid service will reject all `get` requests.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise}\n * @visibleForTesting\n */\n\n\nfunction optOutOfCid(ampdoc) {\n  // Tell the viewer that user has opted out.\n  _services.Services.viewerForDoc(ampdoc).\n  /*OK*/\n  sendMessage(CID_OPTOUT_VIEWER_MESSAGE, (0, _object.dict)()); // Store the optout bit in storage\n\n\n  return _services.Services.storageForDoc(ampdoc).then(function (storage) {\n    return storage.set(CID_OPTOUT_STORAGE_KEY, true);\n  });\n}\n/**\n * Whether user has opted out of Cid issuance for all scopes.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<boolean>}\n * @visibleForTesting\n */\n\n\nfunction isOptedOutOfCid(ampdoc) {\n  return _services.Services.storageForDoc(ampdoc).then(function (storage) {\n    return storage.get(CID_OPTOUT_STORAGE_KEY).then(function (val) {\n      return !!val;\n    });\n  }).catch(function () {\n    // If we fail to read the flag, assume not opted out.\n    return false;\n  });\n}\n/**\n * Sets a new CID cookie for expire 1 year from now.\n * @param {!Window} win\n * @param {string} scope\n * @param {string} cookie\n */\n\n\nfunction setCidCookie(win, scope, cookie) {\n  var expiration = Date.now() + BASE_CID_MAX_AGE_MILLIS;\n  (0, _cookies.setCookie)(win, scope, cookie, expiration, {\n    highestAvailableDomain: true\n  });\n}\n/**\n * If cookie exists it's returned immediately. Otherwise, if instructed, the\n * new cookie is created.\n *\n * @param {!Cid} cid\n * @param {!GetCidDef} getCidStruct\n * @param {!Promise} persistenceConsent\n * @return {!Promise<?string>}\n */\n\n\nfunction getOrCreateCookie(cid, getCidStruct, persistenceConsent) {\n  var win = cid.ampdoc.win;\n  var scope = getCidStruct.scope;\n  var cookieName = getCidStruct.cookieName || scope;\n  var existingCookie = (0, _cookies.getCookie)(win, cookieName);\n\n  if (!existingCookie && !getCidStruct.createCookieIfNotPresent) {\n    return (\n      /** @type {!Promise<?string>} */\n      Promise.resolve(null)\n    );\n  }\n\n  if (cid.externalCidCache_[scope]) {\n    return (\n      /** @type {!Promise<?string>} */\n      cid.externalCidCache_[scope]\n    );\n  }\n\n  if (existingCookie) {\n    // If we created the cookie, update it's expiration time.\n    if (/^amp-/.test(existingCookie)) {\n      setCidCookie(win, cookieName, existingCookie);\n    }\n\n    return (\n      /** @type {!Promise<?string>} */\n      Promise.resolve(existingCookie)\n    );\n  }\n\n  var newCookiePromise = getRandomString64(win) // Create new cookie, always prefixed with \"amp-\", so that we can see from\n  // the value whether we created it.\n  .then(function (randomStr) {\n    return 'amp-' + randomStr;\n  }); // Store it as a cookie based on the persistence consent.\n\n  Promise.all([newCookiePromise, persistenceConsent]).then(function (results) {\n    // The initial CID generation is inherently racy. First one that gets\n    // consent wins.\n    var newCookie = results[0];\n    var relookup = (0, _cookies.getCookie)(win, cookieName);\n\n    if (!relookup) {\n      setCidCookie(win, cookieName, newCookie);\n    }\n  });\n  return cid.externalCidCache_[scope] = newCookiePromise;\n}\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin. Throws an error if the doc is not on a proxy origin.\n * @param {!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n * @visibleForTesting BUT if this is needed elsewhere it could be\n *     factored into its own package.\n */\n\n\nfunction getProxySourceOrigin(url) {\n  (0, _log.userAssert)((0, _url.isProxyOrigin)(url), 'Expected proxy origin %s', url.origin);\n  return (0, _url.getSourceOrigin)(url);\n}\n/**\n * Returns the base cid for the current user(). This string must not\n * be exposed to users without hashing with the current source origin\n * and the externalCidScope.\n * On a proxy this value is the same for a user across all source\n * origins.\n * @param {!Cid} cid\n * @param {!Promise} persistenceConsent\n * @return {!Promise<string>}\n */\n\n\nfunction getBaseCid(cid, persistenceConsent) {\n  if (cid.baseCid_) {\n    return cid.baseCid_;\n  }\n\n  var win = cid.ampdoc.win;\n  return cid.baseCid_ = read(cid.ampdoc).then(function (stored) {\n    var needsToStore = false;\n    var baseCid; // See if we have a stored base cid and whether it is still valid\n    // in terms of expiration.\n\n    if (stored && !isExpired(stored)) {\n      baseCid = Promise.resolve(stored.cid);\n\n      if (shouldUpdateStoredTime(stored)) {\n        needsToStore = true;\n      }\n    } else {\n      // We need to make a new one.\n      baseCid = _services.Services.cryptoFor(win).sha384Base64(getEntropy(win));\n      needsToStore = true;\n    }\n\n    if (needsToStore) {\n      baseCid.then(function (baseCid) {\n        store(cid.ampdoc, persistenceConsent, baseCid);\n      });\n    }\n\n    return baseCid;\n  });\n}\n/**\n * Stores a new cidString in localStorage. Adds the current time to the\n * stored value.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Promise} persistenceConsent\n * @param {string} cidString Actual cid string to store.\n */\n\n\nfunction store(ampdoc, persistenceConsent, cidString) {\n  var win = ampdoc.win;\n\n  if ((0, _dom.isIframed)(win)) {\n    // If we are being embedded, try to save the base cid to the viewer.\n    viewerBaseCid(ampdoc, createCidData(cidString));\n  } else {\n    // To use local storage, we need user's consent.\n    persistenceConsent.then(function () {\n      try {\n        win.localStorage.setItem('amp-cid', createCidData(cidString));\n      } catch (ignore) {// Setting localStorage may fail. In practice we don't expect that to\n        // happen a lot (since we don't go anywhere near the quota, but\n        // in particular in Safari private browsing mode it always fails.\n        // In that case we just don't store anything, which is just fine.\n      }\n    });\n  }\n}\n/**\n * Get/set the Base CID from/to the viewer.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {string=} opt_data Stringified JSON object {cid, time}.\n * @return {!Promise<string|undefined>}\n */\n\n\nfunction viewerBaseCid(ampdoc, opt_data) {\n  var viewer = _services.Services.viewerForDoc(ampdoc);\n\n  return viewer.isTrustedViewer().then(function (trusted) {\n    if (!trusted) {\n      return undefined;\n    } // TODO(lannka, #11060): clean up when all Viewers get migrated\n\n\n    (0, _log.dev)().expectedError('CID', 'Viewer does not provide cap=cid');\n    return viewer.sendMessageAwaitResponse('cid', opt_data).then(function (data) {\n      // For backward compatibility: #4029\n      if (data && !(0, _json.tryParseJson)(data)) {\n        // TODO(lannka, #11060): clean up when all Viewers get migrated\n        (0, _log.dev)().expectedError('CID', 'invalid cid format');\n        return JSON.stringify((0, _object.dict)({\n          'time': Date.now(),\n          // CID returned from old API is always fresh\n          'cid': data\n        }));\n      }\n\n      return data;\n    });\n  });\n}\n/**\n * Creates a JSON object that contains the given CID and the current time as\n * a timestamp.\n * @param {string} cidString\n * @return {string}\n */\n\n\nfunction createCidData(cidString) {\n  return JSON.stringify((0, _object.dict)({\n    'time': Date.now(),\n    'cid': cidString\n  }));\n}\n/**\n * Gets the persisted CID data as a promise. It tries to read from\n * localStorage first then from viewer if it is in embedded mode.\n * Returns null if none was found.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<?BaseCidInfoDef>}\n */\n\n\nfunction read(ampdoc) {\n  var win = ampdoc.win;\n  var data;\n\n  try {\n    data = win.localStorage.getItem('amp-cid');\n  } catch (ignore) {// If reading from localStorage fails, we assume it is empty.\n  }\n\n  var dataPromise = Promise.resolve(data);\n\n  if (!data && (0, _dom.isIframed)(win)) {\n    // If we are being embedded, try to get the base cid from the viewer.\n    dataPromise = viewerBaseCid(ampdoc);\n  }\n\n  return dataPromise.then(function (data) {\n    if (!data) {\n      return null;\n    }\n\n    var item = (0, _json.parseJson)(data);\n    return {\n      time: item['time'],\n      cid: item['cid']\n    };\n  });\n}\n/**\n * Whether the retrieved cid object is expired and should be ignored.\n * @param {!BaseCidInfoDef} storedCidInfo\n * @return {boolean}\n */\n\n\nfunction isExpired(storedCidInfo) {\n  var createdTime = storedCidInfo.time;\n  var now = Date.now();\n  return createdTime + BASE_CID_MAX_AGE_MILLIS < now;\n}\n/**\n * Whether we should write a new timestamp to the stored cid value.\n * We say yes if it is older than 1 day, so we only do this max once\n * per day to avoid writing to localStorage all the time.\n * @param {!BaseCidInfoDef} storedCidInfo\n * @return {boolean}\n */\n\n\nfunction shouldUpdateStoredTime(storedCidInfo) {\n  var createdTime = storedCidInfo.time;\n  var now = Date.now();\n  return createdTime + ONE_DAY_MILLIS < now;\n}\n/**\n * Returns an array with a total of 128 of random values based on the\n * `win.crypto.getRandomValues` API. If that is not available concatenates\n * a string of other values that might be hard to guess including\n * `Math.random` and the current time.\n * @param {!Window} win\n * @return {!Uint8Array|string} Entropy.\n */\n\n\nfunction getEntropy(win) {\n  // Use win.crypto.getRandomValues to get 128 bits of random value\n  var uint8array = (0, _bytes.getCryptoRandomBytesArray)(win, 16); // 128 bit\n\n  if (uint8array) {\n    return uint8array;\n  } // Support for legacy browsers.\n\n\n  return String(win.location.href + Date.now() + win.Math.random() + win.screen.width + win.screen.height);\n}\n/**\n * Produces an external CID for use in a cookie.\n * @param {!Window} win\n * @return {!Promise<string>} The cid\n */\n\n\nfunction getRandomString64(win) {\n  var entropy = getEntropy(win);\n\n  if (typeof entropy == 'string') {\n    return _services.Services.cryptoFor(win).sha384Base64(entropy);\n  } else {\n    // If our entropy is a pure random number, we can just directly turn it\n    // into base 64\n    var cast =\n    /** @type {!Uint8Array} */\n    entropy;\n    return (0, _promise.tryResolve)(function () {\n      return (0, _base.base64UrlEncodeFromBytes)(cast) // Remove trailing padding\n      .replace(/\\.+$/, '');\n    });\n  }\n}\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {*} TODO(#23582): Specify return type\n */\n\n\nfunction installCidService(ampdoc) {\n  return (0, _service.registerServiceBuilderForDoc)(ampdoc, 'cid', Cid);\n}\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Cid}\n * @private visible for testing\n */\n\n\nfunction cidServiceForDocForTesting(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'cid', Cid);\n  return (0, _service.getServiceForDoc)(ampdoc, 'cid');\n}\n\n},{\"../cookies\":35,\"../dom\":41,\"../json\":63,\"../log\":68,\"../service\":79,\"../services\":123,\"../url\":134,\"../utils/base64\":136,\"../utils/bytes\":137,\"../utils/object\":145,\"../utils/promise\":147,\"./cache-cid-api\":82,\"./cid-api\":83,\"./viewer-cid-api\":113}],85:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installBuiltinElements = installBuiltinElements;\nexports.installRuntimeServices = installRuntimeServices;\nexports.installAmpdocServices = installAmpdocServices;\n\nvar _service = require(\"../service\");\n\nvar _actionImpl = require(\"./action-impl\");\n\nvar _batchedXhrImpl = require(\"./batched-xhr-impl\");\n\nvar _cidImpl = require(\"./cid-impl\");\n\nvar _cryptoImpl = require(\"./crypto-impl\");\n\nvar _documentInfoImpl = require(\"./document-info-impl\");\n\nvar _navigation = require(\"./navigation\");\n\nvar _documentSubmit = require(\"../document-submit\");\n\nvar _hiddenObserverImpl = require(\"./hidden-observer-impl\");\n\nvar _historyImpl = require(\"./history-impl\");\n\nvar _ampImg = require(\"../../builtins/amp-img\");\n\nvar _input = require(\"../input\");\n\nvar _ampLayout = require(\"../../builtins/amp-layout\");\n\nvar _ownersImpl = require(\"./owners-impl\");\n\nvar _ampPixel = require(\"../../builtins/amp-pixel\");\n\nvar _platformImpl = require(\"./platform-impl\");\n\nvar _resourcesImpl = require(\"./resources-impl\");\n\nvar _standardActionsImpl = require(\"./standard-actions-impl\");\n\nvar _storageImpl = require(\"./storage-impl\");\n\nvar _templateImpl = require(\"./template-impl\");\n\nvar _timerImpl = require(\"./timer-impl\");\n\nvar _urlImpl = require(\"./url-impl\");\n\nvar _urlReplacementsImpl = require(\"./url-replacements-impl\");\n\nvar _viewerImpl = require(\"./viewer-impl\");\n\nvar _viewportImpl = require(\"./viewport/viewport-impl\");\n\nvar _vsyncImpl = require(\"./vsync-impl\");\n\nvar _xhrImpl = require(\"./xhr-impl\");\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Install builtins.\n * @param {!Window} win\n * @restricted\n */\nfunction installBuiltinElements(win) {\n  (0, _ampImg.installImg)(win);\n  (0, _ampPixel.installPixel)(win);\n  (0, _ampLayout.installLayout)(win);\n}\n/**\n * Install runtime-level services.\n * @param {!Window} global Global scope to adopt.\n * @restricted\n */\n\n\nfunction installRuntimeServices(global) {\n  (0, _cryptoImpl.installCryptoService)(global);\n  (0, _batchedXhrImpl.installBatchedXhrService)(global);\n  (0, _platformImpl.installPlatformService)(global);\n  (0, _templateImpl.installTemplatesService)(global);\n  (0, _timerImpl.installTimerService)(global);\n  (0, _vsyncImpl.installVsyncService)(global);\n  (0, _xhrImpl.installXhrService)(global);\n  (0, _input.installInputService)(global);\n}\n/**\n * Install ampdoc-level services.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @restricted\n */\n\n\nfunction installAmpdocServices(ampdoc) {\n  var isEmbedded = !!ampdoc.getParent(); // When making changes to this method:\n  // 1. Order is important!\n  // 2. Consider to install same services to amp-inabox.js\n\n  (0, _urlImpl.installUrlForDoc)(ampdoc);\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'documentInfo') : (0, _documentInfoImpl.installDocumentInfoServiceForDoc)(ampdoc); // those services are installed in amp-inabox.js\n\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'cid') : (0, _cidImpl.installCidService)(ampdoc);\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'viewer') : (0, _viewerImpl.installViewerServiceForDoc)(ampdoc);\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'viewport') : (0, _viewportImpl.installViewportServiceForDoc)(ampdoc);\n  (0, _hiddenObserverImpl.installHiddenObserverForDoc)(ampdoc);\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'history') : (0, _historyImpl.installHistoryServiceForDoc)(ampdoc);\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'resources') : (0, _resourcesImpl.installResourcesServiceForDoc)(ampdoc);\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'owners') : (0, _ownersImpl.installOwnersServiceForDoc)(ampdoc);\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'url-replace') : (0, _urlReplacementsImpl.installUrlReplacementsServiceForDoc)(ampdoc);\n  (0, _actionImpl.installActionServiceForDoc)(ampdoc);\n  (0, _standardActionsImpl.installStandardActionsForDoc)(ampdoc);\n  isEmbedded ? (0, _service.adoptServiceForEmbedDoc)(ampdoc, 'storage') : (0, _storageImpl.installStorageServiceForDoc)(ampdoc);\n  (0, _navigation.installGlobalNavigationHandlerForDoc)(ampdoc);\n  (0, _documentSubmit.installGlobalSubmitListenerForDoc)(ampdoc);\n}\n\n},{\"../../builtins/amp-img\":8,\"../../builtins/amp-layout\":9,\"../../builtins/amp-pixel\":10,\"../document-submit\":40,\"../input\":60,\"../service\":79,\"./action-impl\":80,\"./batched-xhr-impl\":81,\"./cid-impl\":84,\"./crypto-impl\":86,\"./document-info-impl\":88,\"./hidden-observer-impl\":92,\"./history-impl\":93,\"./navigation\":97,\"./owners-impl\":98,\"./platform-impl\":100,\"./resources-impl\":102,\"./standard-actions-impl\":104,\"./storage-impl\":105,\"./template-impl\":107,\"./timer-impl\":108,\"./url-impl\":110,\"./url-replacements-impl\":111,\"./viewer-impl\":114,\"./viewport/viewport-impl\":119,\"./vsync-impl\":121,\"./xhr-impl\":122}],86:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installCryptoService = installCryptoService;\nexports.Crypto = void 0;\n\nvar _services = require(\"../services\");\n\nvar _base = require(\"../utils/base64\");\n\nvar _log = require(\"../log\");\n\nvar _service = require(\"../service\");\n\nvar _bytes = require(\"../utils/bytes\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {string} */\nvar TAG = 'Crypto';\n/**\n * @typedef {function((string|Uint8Array))}\n */\n\nvar CryptoPolyfillDef;\n\nvar Crypto =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates an instance of Crypto.\n   * @param {!Window} win\n   */\n  function Crypto(win) {\n    /** @private {!Window} */\n    this.win_ = win;\n    var subtle = null;\n    var isLegacyWebkit = false;\n\n    if (win.crypto) {\n      if (win.crypto.subtle) {\n        subtle = win.crypto.subtle;\n      } else if (win.crypto.webkitSubtle) {\n        subtle = win.crypto.webkitSubtle;\n        isLegacyWebkit = true;\n      }\n    }\n    /** @const {{name: string}} */\n\n\n    this.pkcsAlgo = {\n      name: 'RSASSA-PKCS1-v1_5',\n      hash: {\n        name: 'SHA-256'\n      }\n    };\n    /** @const {?webCrypto.SubtleCrypto} */\n\n    this.subtle = subtle;\n    /** @private @const {boolean} */\n\n    this.isLegacyWebkit_ = isLegacyWebkit;\n    /** @private {?Promise<!CryptoPolyfillDef>} */\n\n    this.polyfillPromise_ = null;\n  }\n  /**\n   * Returns the SHA-384 hash of the input string in a number array.\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<!Uint8Array>}\n   * @throws {!Error} when input string contains chars out of range [0,255]\n   */\n\n\n  var _proto = Crypto.prototype;\n\n  _proto.sha384 = function sha384(input) {\n    var _this = this;\n\n    if (typeof input === 'string') {\n      input = (0, _bytes.stringToBytes)(input);\n    }\n\n    if (!this.subtle || this.polyfillPromise_) {\n      // means native Crypto API is not available or failed before.\n      return (this.polyfillPromise_ || this.loadPolyfill_()).then(function (polyfillSha384) {\n        return polyfillSha384(input);\n      });\n    }\n\n    try {\n      return this.subtle.digest({\n        name: 'SHA-384'\n      }, input)\n      /** @param {?} buffer */\n      .then(function (buffer) {\n        return new Uint8Array(buffer);\n      }, function (e) {\n        // Chrome doesn't allow the usage of Crypto API under\n        // non-secure origin: https://www.chromium.org/Home/chromium-security/prefer-secure-origins-for-powerful-new-features\n        if (e.message && e.message.indexOf('secure origin') < 0) {\n          // Log unexpected fallback.\n          (0, _log.user)().error(TAG, 'SubtleCrypto failed, fallback to closure lib.', e);\n        }\n\n        return _this.loadPolyfill_().then(function () {\n          return _this.sha384(input);\n        });\n      });\n    } catch (e) {\n      (0, _log.dev)().error(TAG, 'SubtleCrypto failed, fallback to closure lib.', e);\n      return this.loadPolyfill_().then(function () {\n        return _this.sha384(input);\n      });\n    }\n  }\n  /**\n   * Returns the SHA-384 hash of the input string in the format of web safe\n   * base64 (using -_. instead of +/=).\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<string>}\n   * @throws {!Error} when input string contains chars out of range [0,255]\n   */\n  ;\n\n  _proto.sha384Base64 = function sha384Base64(input) {\n    return this.sha384(input).then(function (buffer) {\n      return (0, _base.base64UrlEncodeFromBytes)(buffer);\n    });\n  }\n  /**\n   * Returns a uniform hash of the input string as a float number in the range\n   * of [0, 1).\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<number>}\n   */\n  ;\n\n  _proto.uniform = function uniform(input) {\n    return this.sha384(input).then(function (buffer) {\n      // Consider the Uint8 array as a base256 fraction number,\n      // then convert it to the decimal form.\n      var result = 0;\n\n      for (var i = 2; i >= 0; i--) {\n        // 3 base256 digits give enough precision\n        result = (result + buffer[i]) / 256;\n      }\n\n      return result;\n    });\n  }\n  /**\n   * Loads Crypto polyfill library.\n   * @return {!Promise<!CryptoPolyfillDef>}\n   * @private\n   */\n  ;\n\n  _proto.loadPolyfill_ = function loadPolyfill_() {\n    var _this2 = this;\n\n    if (this.polyfillPromise_) {\n      return this.polyfillPromise_;\n    }\n\n    return this.polyfillPromise_ = _services.Services.extensionsFor(this.win_).preloadExtension('amp-crypto-polyfill').then(function () {\n      return (0, _service.getService)(_this2.win_, 'crypto-polyfill');\n    });\n  }\n  /**\n   * Checks whether Web Cryptography is available, which is required for PKCS 1\n   * operations. SHA-384 operations do not need this because there's a polyfill.\n   * This could be false if the browser does not support Web Cryptography, or if\n   * the current browsing context is not secure (e.g., it's on an insecure HTTP\n   * page, or an HTTPS iframe embedded in an insecure HTTP page).\n   *\n   * @return {boolean} whether Web Cryptography is available\n   */\n  ;\n\n  _proto.isPkcsAvailable = function isPkcsAvailable() {\n    return Boolean(this.subtle) && this.win_['isSecureContext'] !== false;\n  }\n  /**\n   * Converts an RSA JSON Web Key object to a browser-native cryptographic key.\n   * As a precondition, `isPkcsAvailable()` must be `true`.\n   *\n   * @param {!Object} jwk a deserialized RSA JSON Web Key, as specified in\n   *     Section 6.3 of RFC 7518\n   * @return {!Promise<!webCrypto.CryptoKey>}\n   * @throws {TypeError} if `jwk` is not an RSA JSON Web Key\n   */\n  ;\n\n  _proto.importPkcsKey = function importPkcsKey(jwk) {\n    (0, _log.devAssert)(this.isPkcsAvailable()); // Safari 10 and earlier want this as an ArrayBufferView.\n\n    var keyData = this.isLegacyWebkit_ ? (0, _bytes.utf8Encode)(JSON.stringify(\n    /** @type {!JsonObject} */\n    jwk)) :\n    /** @type {!webCrypto.JsonWebKey} */\n    jwk;\n    return (\n      /** @type {!Promise<!webCrypto.CryptoKey>} */\n      this.subtle.importKey('jwk', keyData, this.pkcsAlgo, true, ['verify'])\n    );\n  }\n  /**\n   * Verifies an RSASSA-PKCS1-v1_5 signature with a SHA-256 hash. As a\n   * precondition, `isPkcsAvailable()` must be `true`.\n   *\n   * @param {!webCrypto.CryptoKey} key an RSA public key\n   * @param {!Uint8Array} signature an RSASSA-PKCS1-v1_5 signature\n   * @param {!BufferSource} data the data that was signed\n   * @return {!Promise<boolean>} whether the signature is correct for the given\n   *     data and public key\n   */\n  ;\n\n  _proto.verifyPkcs = function verifyPkcs(key, signature, data) {\n    (0, _log.devAssert)(this.isPkcsAvailable());\n    return (\n      /** @type {!Promise<boolean>} */\n      this.subtle.verify(this.pkcsAlgo, key, signature, data)\n    );\n  };\n\n  return Crypto;\n}();\n/**\n * @param {!Window} win\n * @return {*} TODO(#23582): Specify return type\n */\n\n\nexports.Crypto = Crypto;\n\nfunction installCryptoService(win) {\n  return (0, _service.registerServiceBuilder)(win, 'crypto', Crypto);\n}\n\n},{\"../log\":68,\"../service\":79,\"../services\":123,\"../utils/base64\":136,\"../utils/bytes\":137}],87:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.upgradeOrRegisterElement = upgradeOrRegisterElement;\nexports.stubElementsForDoc = stubElementsForDoc;\nexports.stubElementIfNotKnown = stubElementIfNotKnown;\nexports.copyElementToChildWindow = copyElementToChildWindow;\nexports.registerElement = registerElement;\nexports.markElementScheduledForTesting = markElementScheduledForTesting;\nexports.resetScheduledElementForTesting = resetScheduledElementForTesting;\nexports.getElementClassForTesting = getElementClassForTesting;\n\nvar _elementStub = require(\"../element-stub\");\n\nvar _customElement = require(\"../custom-element\");\n\nvar _elementService = require(\"../element-service\");\n\nvar _error = require(\"../error\");\n\nvar _log = require(\"../log\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!Window} win\n * @return {!Object<string, function(new:../base-element.BaseElement, !Element)>}\n */\nfunction getExtendedElements(win) {\n  if (!win.__AMP_EXTENDED_ELEMENTS) {\n    win.__AMP_EXTENDED_ELEMENTS = {};\n  }\n\n  return win.__AMP_EXTENDED_ELEMENTS;\n}\n/**\n * Registers an element. Upgrades it if has previously been stubbed.\n * @param {!Window} win\n * @param {string} name\n * @param {function(new:../base-element.BaseElement, !Element)} toClass\n */\n\n\nfunction upgradeOrRegisterElement(win, name, toClass) {\n  var knownElements = getExtendedElements(win);\n\n  if (!knownElements[name]) {\n    registerElement(win, name,\n    /** @type {!Function} */\n    toClass);\n    return;\n  }\n\n  if (knownElements[name] == toClass) {\n    // Already registered this instance.\n    return;\n  }\n\n  (0, _log.userAssert)(knownElements[name] == _elementStub.ElementStub, '%s is already registered. The script tag for ' + '%s is likely included twice in the page.', name, name);\n  knownElements[name] = toClass;\n\n  for (var i = 0; i < _elementStub.stubbedElements.length; i++) {\n    var stub = _elementStub.stubbedElements[i]; // There are 3 possible states here:\n    // 1. We never made the stub because the extended impl. loaded first.\n    //    In that case the element won't be in the array.\n    // 2. We made a stub but the browser didn't attach it yet. In\n    //    that case we don't need to upgrade but simply switch to the new\n    //    implementation.\n    // 3. A stub was attached. We upgrade which means we replay the\n    //    implementation.\n\n    var element = stub.element;\n\n    if (element.tagName.toLowerCase() == name && element.ownerDocument.defaultView == win) {\n      tryUpgradeElement_(element, toClass); // Remove element from array.\n\n      _elementStub.stubbedElements.splice(i--, 1);\n    }\n  }\n}\n/**\n * This method should not be inlined to prevent TryCatch deoptimization.\n * @param {Element} element\n * @param {function(new:../base-element.BaseElement, !Element)} toClass\n * @private\n * @noinline\n */\n\n\nfunction tryUpgradeElement_(element, toClass) {\n  try {\n    element.upgrade(toClass);\n  } catch (e) {\n    (0, _error.reportError)(e, element);\n  }\n}\n/**\n * Stub extended elements missing an implementation. It can be called multiple\n * times and on partial document in order to start stubbing as early as\n * possible.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nfunction stubElementsForDoc(ampdoc) {\n  var extensions = (0, _elementService.extensionScriptsInNode)(ampdoc.getHeadNode());\n  extensions.forEach(function (name) {\n    ampdoc.declareExtension(name);\n    stubElementIfNotKnown(ampdoc.win, name);\n  });\n}\n/**\n * Stub element if not yet known.\n * @param {!Window} win\n * @param {string} name\n */\n\n\nfunction stubElementIfNotKnown(win, name) {\n  var knownElements = getExtendedElements(win);\n\n  if (!knownElements[name]) {\n    registerElement(win, name, _elementStub.ElementStub);\n  }\n}\n/**\n * Copies the specified element to child window (friendly iframe). This way\n * all implementations of the AMP elements are shared between all friendly\n * frames.\n * @param {!Window} parentWin\n * @param {!Window} childWin\n * @param {string} name\n */\n\n\nfunction copyElementToChildWindow(parentWin, childWin, name) {\n  var toClass = getExtendedElements(parentWin)[name];\n  registerElement(childWin, name, toClass || _elementStub.ElementStub);\n}\n/**\n * Registers a new custom element with its implementation class.\n * @param {!Window} win The window in which to register the elements.\n * @param {string} name Name of the custom element\n * @param {function(new:../base-element.BaseElement, !Element)} implementationClass\n */\n\n\nfunction registerElement(win, name, implementationClass) {\n  var knownElements = getExtendedElements(win);\n  knownElements[name] = implementationClass;\n  var klass = (0, _customElement.createCustomElementClass)(win, name);\n  win['customElements'].define(name, klass);\n}\n/**\n * In order to provide better error messages we only allow to retrieve\n * services from other elements if those elements are loaded in the page.\n * This makes it possible to mark an element as loaded in a test.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @visibleForTesting\n */\n\n\nfunction markElementScheduledForTesting(win, elementName) {\n  var knownElements = getExtendedElements(win);\n\n  if (!knownElements[elementName]) {\n    knownElements[elementName] = _elementStub.ElementStub;\n  }\n}\n/**\n * Resets our scheduled elements.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @visibleForTesting\n */\n\n\nfunction resetScheduledElementForTesting(win, elementName) {\n  if (win.__AMP_EXTENDED_ELEMENTS) {\n    delete win.__AMP_EXTENDED_ELEMENTS[elementName];\n  }\n}\n/**\n * Returns a currently registered element class.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @return {?function()}\n * @visibleForTesting\n */\n\n\nfunction getElementClassForTesting(win, elementName) {\n  var knownElements = win.__AMP_EXTENDED_ELEMENTS;\n  return knownElements && knownElements[elementName] || null;\n}\n\n},{\"../custom-element\":38,\"../element-service\":42,\"../element-stub\":43,\"../error\":44,\"../log\":68}],88:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installDocumentInfoServiceForDoc = installDocumentInfoServiceForDoc;\nexports.DocInfo = exports.DocumentInfoDef = void 0;\n\nvar _url = require(\"../url\");\n\nvar _cidImpl = require(\"./cid-impl\");\n\nvar _types = require(\"../types\");\n\nvar _object = require(\"../utils/object\");\n\nvar _service = require(\"../service\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @private @const {!Array<string>} */\nvar filteredLinkRels = ['prefetch', 'preload', 'preconnect', 'dns-prefetch'];\n/**\n * Properties:\n *     - sourceUrl: the source url of an amp document.\n *     - canonicalUrl: The doc's canonical.\n *     - pageViewId: Id for this page view. Low entropy but should be unique\n *     - pageViewId64: Id for this page view. High entropy but should be unique\n *       for concurrent page views of a user().\n *     - linkRels: A map object of link tag's rel (key) and corresponding\n *       hrefs (value). rel could be 'canonical', 'icon', etc.\n *     - metaTags: A map object of meta tag's name (key) and corresponding\n *       contents (value).\n *     - replaceParams: A map object of extra query string parameter names (key)\n *       to corresponding values, used for custom analytics.\n *       Null if not applicable.\n *\n * @typedef {{\n *   sourceUrl: string,\n *   canonicalUrl: string,\n *   pageViewId: string,\n *   pageViewId64: !Promise<string>,\n *   linkRels: !Object<string, string|!Array<string>>,\n *   metaTags: !Object<string, string|!Array<string>>,\n *   replaceParams: ?Object<string, string|!Array<string>>\n * }}\n */\n\nvar DocumentInfoDef;\n/**\n * @param {!Node|!./ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {*} TODO(#23582): Specify return type\n */\n\nexports.DocumentInfoDef = DocumentInfoDef;\n\nfunction installDocumentInfoServiceForDoc(nodeOrDoc) {\n  return (0, _service.registerServiceBuilderForDoc)(nodeOrDoc, 'documentInfo', DocInfo);\n}\n\nvar DocInfo =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  function DocInfo(ampdoc) {\n    /** @private @const  */\n    this.ampdoc_ = ampdoc;\n    /** @private {?DocumentInfoDef} */\n\n    this.info_ = null;\n    /** @private {?Promise<string>} */\n\n    this.pageViewId64_ = null;\n  }\n  /** @return {!DocumentInfoDef} */\n\n\n  var _proto = DocInfo.prototype;\n\n  _proto.get = function get() {\n    if (this.info_) {\n      return this.info_;\n    }\n\n    var ampdoc = this.ampdoc_;\n    var url = ampdoc.getUrl();\n    var sourceUrl = (0, _url.getSourceUrl)(url);\n    var rootNode = ampdoc.getRootNode();\n    var canonicalUrl = rootNode && rootNode.AMP && rootNode.AMP.canonicalUrl;\n\n    if (!canonicalUrl) {\n      var canonicalTag = rootNode.querySelector('link[rel=canonical]');\n      canonicalUrl = canonicalTag ? (0, _url.parseUrlDeprecated)(canonicalTag.href).href : sourceUrl;\n    }\n\n    var pageViewId = getPageViewId(ampdoc.win);\n    var linkRels = getLinkRels(ampdoc.win.document);\n    var metaTags = getMetaTags(ampdoc.win.document);\n    var replaceParams = getReplaceParams(ampdoc);\n    return this.info_ = {\n      /** @return {string} */\n      get sourceUrl() {\n        return (0, _url.getSourceUrl)(ampdoc.getUrl());\n      },\n\n      canonicalUrl: canonicalUrl,\n      pageViewId: pageViewId,\n\n      get pageViewId64() {\n        // Must be calculated async since getRandomString64() can load the\n        // amp-crypto-polyfill on some browsers, and extensions service\n        // may not be registered yet.\n        if (!this.pageViewId64_) {\n          this.pageViewId64_ = (0, _cidImpl.getRandomString64)(ampdoc.win);\n        }\n\n        return this.pageViewId64_;\n      },\n\n      linkRels: linkRels,\n      metaTags: metaTags,\n      replaceParams: replaceParams\n    };\n  };\n\n  return DocInfo;\n}();\n/**\n * Returns a relatively low entropy random string.\n * This should be called once per window and then cached for subsequent\n * access to the same value to be persistent per page.\n * @param {!Window} win\n * @return {string}\n */\n\n\nexports.DocInfo = DocInfo;\n\nfunction getPageViewId(win) {\n  return String(Math.floor(win.Math.random() * 10000));\n}\n/**\n * Returns a map object of link tag relations in document head.\n * Key is the link rel, value is a list of corresponding hrefs.\n * @param {!Document} doc\n * @return {!JsonObject<string, string|!Array<string>>}\n */\n\n\nfunction getLinkRels(doc) {\n  var linkRels = (0, _object.map)();\n\n  if (doc.head) {\n    var links = doc.head.querySelectorAll('link[rel]');\n\n    var _loop = function _loop(i) {\n      var link = links[i];\n      var href = link.href;\n      var rels = link.getAttribute('rel');\n\n      if (!rels || !href) {\n        return \"continue\";\n      }\n\n      rels.split(/\\s+/).forEach(function (rel) {\n        if (filteredLinkRels.indexOf(rel) != -1) {\n          return;\n        }\n\n        var value = linkRels[rel];\n\n        if (value) {\n          // Change to array if more than one href for the same rel\n          if (!(0, _types.isArray)(value)) {\n            value = linkRels[rel] = [value];\n          }\n\n          value.push(href);\n        } else {\n          linkRels[rel] = href;\n        }\n      });\n    };\n\n    for (var i = 0; i < links.length; i++) {\n      var _ret = _loop(i);\n\n      if (_ret === \"continue\") continue;\n    }\n  }\n\n  return linkRels;\n}\n/**\n * Returns a map object of meta tags in document head.\n * Key is the meta name, value is a list of corresponding content values.\n * @param {!Document} doc\n * @return {!JsonObject<string, string|!Array<string>>}\n */\n\n\nfunction getMetaTags(doc) {\n  var metaTags = (0, _object.map)();\n\n  if (doc.head) {\n    var metas = doc.head.querySelectorAll('meta[name]');\n\n    for (var i = 0; i < metas.length; i++) {\n      var meta = metas[i];\n      var content = meta.getAttribute('content');\n      var name = meta.getAttribute('name');\n\n      if (!name || !content) {\n        continue;\n      }\n\n      var value = metaTags[name];\n\n      if (value) {\n        // Change to array if more than one content for the same name\n        if (!(0, _types.isArray)(value)) {\n          value = metaTags[name] = [value];\n        }\n\n        value.push(content);\n      } else {\n        metaTags[name] = content;\n      }\n    }\n  }\n\n  return metaTags;\n}\n/**\n * Attempts to retrieve extra parameters from the \"amp_r\" query param,\n * returning null if invalid.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {?JsonObject<string, string|!Array<string>>}\n */\n\n\nfunction getReplaceParams(ampdoc) {\n  // The \"amp_r\" parameter is only supported for ads.\n  if (!ampdoc.isSingleDoc() || (0, _url.getProxyServingType)(ampdoc.win.location.href) != 'a') {\n    return null;\n  }\n\n  var url = (0, _url.parseUrlDeprecated)(ampdoc.win.location.href);\n  var replaceRaw = (0, _url.parseQueryString)(url.search)['amp_r'];\n\n  if (replaceRaw === undefined) {\n    // Differentiate the case between empty replace params and invalid result\n    return null;\n  }\n\n  return (0, _url.parseQueryString)(replaceRaw);\n}\n\n},{\"../service\":79,\"../types\":131,\"../url\":134,\"../utils/object\":145,\"./cid-impl\":84}],89:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.calculateScriptBaseUrl = calculateScriptBaseUrl;\nexports.calculateExtensionScriptUrl = calculateExtensionScriptUrl;\nexports.calculateEntryPointScriptUrl = calculateEntryPointScriptUrl;\nexports.parseExtensionUrl = parseExtensionUrl;\n\nvar _mode = require(\"../mode\");\n\nvar _config = require(\"../config\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Internal structure that maintains the state of an extension through loading.\n *\n * @typedef {{\n *   extensionId: (string|undefined),\n *   extensionVersion: (string|undefined),\n * }}\n * @private\n */\nvar ExtensionInfoDef;\n/**\n * Calculate the base url for any scripts.\n * @param {!Location} location The window's location\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\n\nfunction calculateScriptBaseUrl(location, opt_isLocalDev) {\n  if (opt_isLocalDev) {\n    var prefix = location.protocol + \"//\" + location.host;\n\n    if (location.protocol == 'about:') {\n      prefix = '';\n    }\n\n    return prefix + \"/dist\";\n  }\n\n  return _config.urls.cdn;\n}\n/**\n * Calculate script url for an extension.\n * @param {!Location} location The window's location\n * @param {string} extensionId\n * @param {string=} opt_extensionVersion\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\n\n\nfunction calculateExtensionScriptUrl(location, extensionId, opt_extensionVersion, opt_isLocalDev) {\n  var base = calculateScriptBaseUrl(location, opt_isLocalDev);\n  var rtv = (0, _mode.getMode)().rtvVersion;\n\n  if (opt_extensionVersion == null) {\n    opt_extensionVersion = '0.1';\n  }\n\n  var extensionVersion = opt_extensionVersion ? '-' + opt_extensionVersion : '';\n  return base + \"/rtv/\" + rtv + \"/v0/\" + extensionId + extensionVersion + \".js\";\n}\n/**\n * Calculate script url for an entry point.\n * If `opt_rtv` is true, returns the URL matching the current RTV.\n * @param {!Location} location The window's location\n * @param {string} entryPoint\n * @param {boolean=} isLocalDev\n * @param {boolean=} opt_rtv\n * @return {string}\n */\n\n\nfunction calculateEntryPointScriptUrl(location, entryPoint, isLocalDev, opt_rtv) {\n  var base = calculateScriptBaseUrl(location, isLocalDev);\n\n  if (opt_rtv) {\n    return base + \"/rtv/\" + (0, _mode.getMode)().rtvVersion + \"/\" + entryPoint + \".js\";\n  }\n\n  return base + \"/\" + entryPoint + \".js\";\n}\n/**\n * Parse the extension version from a given script URL.\n * @param {string} scriptUrl\n * @return {!ExtensionInfoDef}\n */\n\n\nfunction parseExtensionUrl(scriptUrl) {\n  var regex = /^(.*)\\/(.*)-([0-9.]+)\\.js$/i;\n  var matches = scriptUrl.match(regex);\n  return {\n    extensionId: matches ? matches[2] : undefined,\n    extensionVersion: matches ? matches[3] : undefined\n  };\n}\n\n},{\"../config\":32,\"../mode\":70}],90:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.isTemplateExtension = isTemplateExtension;\nexports.installExtensionsService = installExtensionsService;\nexports.stubLegacyElements = stubLegacyElements;\nexports.Extensions = exports.LEGACY_ELEMENTS = void 0;\n\nvar _promise = require(\"../utils/promise\");\n\nvar _services = require(\"../services\");\n\nvar _extensionLocation = require(\"./extension-location\");\n\nvar _log = require(\"../log\");\n\nvar _mode = require(\"../mode\");\n\nvar _styleInstaller = require(\"../style-installer\");\n\nvar _object = require(\"../utils/object\");\n\nvar _service = require(\"../service\");\n\nvar _string = require(\"../string\");\n\nvar _customElementRegistry = require(\"./custom-element-registry\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar LEGACY_ELEMENTS = ['amp-ad', 'amp-embed', 'amp-video'];\nexports.LEGACY_ELEMENTS = LEGACY_ELEMENTS;\nvar TAG = 'extensions';\nvar UNKNOWN_EXTENSION = '_UNKNOWN_';\nvar CUSTOM_TEMPLATES = ['amp-mustache'];\nvar LOADER_PROP = '__AMP_EXT_LDR';\n/**\n * Default milliseconds to wait for all extensions to load before erroring.\n * (8 seconds is the same as the CSS boilerplate timoeout)\n * @const\n */\n\nvar LOAD_TIMEOUT = 8000;\n/**\n * Contains data for the declaration of a custom element.\n *\n * @typedef {{\n *   implementationClass:\n *       function(new:../base-element.BaseElement, !Element),\n *   css: (?string|undefined),\n * }}\n */\n\nvar ExtensionElementDef;\n/**\n * Contains data for the declaration of an extension service.\n *\n * @typedef {{serviceName: string, serviceClass: function(new:Object, !./ampdoc-impl.AmpDoc)}}\n */\n\nvar ExtensionServiceDef;\n/**\n * The structure that contains the resources declared by an extension.\n *\n * @typedef {{\n *   elements: !Object<string, !ExtensionElementDef>,\n *   services: !Object<string, !ExtensionServiceDef>,\n * }}\n */\n\nvar ExtensionDef;\n/**\n * Internal structure that maintains the state of an extension through loading.\n *\n * @typedef {{\n *   extension: !ExtensionDef,\n *   auto: boolean,\n *   docFactories: !Array<function(!./ampdoc-impl.AmpDoc)>,\n *   promise: (!Promise<!ExtensionDef>|undefined),\n *   resolve: (function(!ExtensionDef)|undefined),\n *   reject: (function(!Error)|undefined),\n *   loaded: (boolean|undefined),\n *   error: (!Error|undefined),\n *   scriptPresent: (boolean|undefined),\n * }}\n * @private\n */\n\nvar ExtensionHolderDef;\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\n\nfunction isTemplateExtension(extensionId) {\n  return CUSTOM_TEMPLATES.indexOf(extensionId) >= 0;\n}\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\n\n\nfunction isIntermediateExtension(extensionId) {\n  return (0, _string.startsWith)(extensionId, '_');\n}\n/**\n * Install extensions service.\n * @param {!Window} window\n * @restricted\n */\n\n\nfunction installExtensionsService(window) {\n  (0, _service.registerServiceBuilder)(window, 'extensions', Extensions);\n}\n/**\n * The services that manages extensions in the runtime.\n * @visibleForTesting\n */\n\n\nvar Extensions =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function Extensions(win) {\n    /** @const {!Window} */\n    this.win = win;\n    /** @const @private */\n\n    this.ampdocService_ = _services.Services.ampdocServiceFor(win);\n    /** @private @const {!Object<string, !ExtensionHolderDef>} */\n\n    this.extensions_ = {};\n    /** @private {?string} */\n\n    this.currentExtensionId_ = null;\n  }\n  /**\n   * Register and process the specified extension. The factory is called\n   * immediately, which in turn is expected to register elements, templates,\n   * services and document factories. This method is called by the extension's\n   * script itself when it's loaded using the regular `AMP.push()` callback.\n   * @param {string} extensionId\n   * @param {function(!Object, !Object)} factory\n   * @param {!Object} arg\n   * @restricted\n   */\n\n\n  var _proto = Extensions.prototype;\n\n  _proto.registerExtension = function registerExtension(extensionId, factory, arg) {\n    var holder = this.getExtensionHolder_(extensionId,\n    /* auto */\n    true);\n\n    try {\n      this.currentExtensionId_ = extensionId;\n      factory(arg, arg['_']);\n\n      if ((0, _mode.getMode)().localDev || (0, _mode.getMode)().test) {\n        if (Object.freeze) {\n          var m = holder.extension;\n          m.elements = Object.freeze(m.elements);\n          holder.extension = Object.freeze(m);\n        }\n      }\n\n      holder.loaded = true;\n\n      if (holder.resolve) {\n        holder.resolve(holder.extension);\n      }\n    } catch (e) {\n      holder.error = e;\n\n      if (holder.reject) {\n        holder.reject(e);\n      }\n\n      throw e;\n    } finally {\n      this.currentExtensionId_ = null;\n    }\n  }\n  /**\n   * Waits for the previously included extension to complete\n   * loading/registration.\n   * @param {!Window} win\n   * @param {string} extensionId\n   * @param {number=} opt_timeout\n   * @return {!Promise<?ExtensionDef>}\n   */\n  ;\n\n  _proto.waitForExtension = function waitForExtension(win, extensionId, opt_timeout) {\n    return (\n      /** @type {!Promise<?ExtensionDef>} */\n      _services.Services.timerFor(win).timeoutPromise(opt_timeout || LOAD_TIMEOUT, this.waitFor_(this.getExtensionHolder_(extensionId,\n      /* auto */\n      false)), \"Render timeout waiting for extension \" + extensionId + \" to be load.\")\n    );\n  }\n  /**\n   * Returns the promise that will be resolved when the extension has been\n   * loaded. If necessary, adds the extension script to the page.\n   * @param {string} extensionId\n   * @param {string=} opt_extensionVersion\n   * @return {!Promise<!ExtensionDef>}\n   */\n  ;\n\n  _proto.preloadExtension = function preloadExtension(extensionId, opt_extensionVersion) {\n    if (extensionId == 'amp-embed') {\n      extensionId = 'amp-ad';\n    }\n\n    var holder = this.getExtensionHolder_(extensionId,\n    /* auto */\n    false);\n    this.insertExtensionScriptIfNeeded_(extensionId, holder, opt_extensionVersion);\n    return this.waitFor_(holder);\n  }\n  /**\n   * Returns the promise that will be resolved when the extension has been\n   * loaded. If necessary, adds the extension script to the page.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} extensionId\n   * @param {string=} opt_extensionVersion\n   * @return {!Promise<!ExtensionDef>}\n   */\n  ;\n\n  _proto.installExtensionForDoc = function installExtensionForDoc(ampdoc, extensionId, opt_extensionVersion) {\n    var _this = this;\n\n    var rootNode = ampdoc.getRootNode();\n    var extLoaders = rootNode[LOADER_PROP];\n\n    if (!extLoaders) {\n      extLoaders = rootNode[LOADER_PROP] = (0, _object.map)();\n    }\n\n    if (extLoaders[extensionId]) {\n      return extLoaders[extensionId];\n    }\n\n    (0, _customElementRegistry.stubElementIfNotKnown)(ampdoc.win, extensionId);\n    return extLoaders[extensionId] = this.preloadExtension(extensionId, opt_extensionVersion).then(function () {\n      return _this.installExtensionInDoc(ampdoc, extensionId);\n    });\n  }\n  /**\n   * Reloads the new version of the extension.\n   * @param {string} extensionId\n   * @return {!Promise<!ExtensionDef>}\n   */\n  ;\n\n  _proto.reloadExtension = function reloadExtension(extensionId) {\n    // Ignore inserted script elements to prevent recursion.\n    var el = this.getExtensionScript_(extensionId,\n    /* includeInserted */\n    false);\n    (0, _log.devAssert)(el, 'Cannot find script for extension: %s', extensionId); // \"Disconnect\" the old script element and extension record.\n\n    var holder = this.extensions_[extensionId];\n\n    if (holder) {\n      (0, _log.devAssert)(!holder.loaded && !holder.error);\n      delete this.extensions_[extensionId];\n    }\n\n    el.setAttribute('i-amphtml-loaded-new-version', extensionId);\n    var urlParts = (0, _extensionLocation.parseExtensionUrl)(el.src);\n    return this.preloadExtension(extensionId, urlParts.extensionVersion);\n  }\n  /**\n   * Returns the extension <script> element and attribute for the given\n   * extension ID, if it exists. Otherwise, returns null.\n   * @param {string} extensionId\n   * @param {boolean=} includeInserted If true, includes script elements that\n   *   are inserted by the runtime dynamically. Default is true.\n   * @return {?Element}\n   * @private\n   */\n  ;\n\n  _proto.getExtensionScript_ = function getExtensionScript_(extensionId, includeInserted) {\n    if (includeInserted === void 0) {\n      includeInserted = true;\n    }\n\n    // Always ignore <script> elements that have a mismatched RTV.\n    var modifier = ':not([i-amphtml-loaded-new-version])' + (includeInserted ? '' : ':not([i-amphtml-inserted])');\n    return this.win.document.head.\n    /*OK*/\n    querySelector(\"script[src*=\\\"/\" + extensionId + \"-\\\"]\" + modifier);\n  }\n  /**\n   * Returns the promise that will be resolved with the extension element's\n   * class when the extension has been loaded. If necessary, adds the extension\n   * script to the page.\n   * @param {string} elementName\n   * @return {!Promise<function(new:../base-element.BaseElement, !Element)>}\n   */\n  ;\n\n  _proto.loadElementClass = function loadElementClass(elementName) {\n    return this.preloadExtension(elementName).then(function (extension) {\n      var element = (0, _log.devAssert)(extension.elements[elementName], 'Element not found: %s', elementName);\n      return element.implementationClass;\n    });\n  }\n  /**\n   * Add an element to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {string} name\n   * @param {function(new:../base-element.BaseElement, !Element)} implementationClass\n   * @param {?string|undefined} css\n   * @restricted\n   */\n  ;\n\n  _proto.addElement = function addElement(name, implementationClass, css) {\n    var _this2 = this;\n\n    var holder = this.getCurrentExtensionHolder_(name);\n    holder.extension.elements[name] = {\n      implementationClass: implementationClass,\n      css: css\n    };\n    this.addDocFactory(function (ampdoc) {\n      _this2.installElement_(ampdoc, name, implementationClass, css);\n    });\n  }\n  /**\n   * Installs the specified element implementation in the ampdoc.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} name\n   * @param {!Function} implementationClass\n   * @param {?string|undefined} css\n   * @private\n   */\n  ;\n\n  _proto.installElement_ = function installElement_(ampdoc, name, implementationClass, css) {\n    var _this3 = this;\n\n    if (css) {\n      (0, _styleInstaller.installStylesForDoc)(ampdoc, css, function () {\n        _this3.registerElementInWindow_(ampdoc.win, name, implementationClass);\n      },\n      /* isRuntimeCss */\n      false, name);\n    } else {\n      this.registerElementInWindow_(ampdoc.win, name, implementationClass);\n    }\n  }\n  /**\n   * @param {!Window} win\n   * @param {string} name\n   * @param {!Function} implementationClass\n   * @private\n   */\n  ;\n\n  _proto.registerElementInWindow_ = function registerElementInWindow_(win, name, implementationClass) {\n    // Register the element in the window.\n    (0, _customElementRegistry.upgradeOrRegisterElement)(win, name, implementationClass); // Register this extension to resolve its Service Promise.\n\n    (0, _service.registerServiceBuilder)(win, name, emptyService);\n  }\n  /**\n   * Add a service to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {string} name\n   * @param {function(new:Object, !./ampdoc-impl.AmpDoc)} implementationClass\n   */\n  ;\n\n  _proto.addService = function addService(name, implementationClass) {\n    var holder = this.getCurrentExtensionHolder_();\n    holder.extension.services.push(\n    /** @type {!ExtensionServiceDef} */\n    {\n      serviceName: name,\n      serviceClass: implementationClass\n    });\n    this.addDocFactory(function (ampdoc) {\n      (0, _service.registerServiceBuilderForDoc)(ampdoc, name, implementationClass,\n      /* instantiate */\n      true);\n    });\n  }\n  /**\n   * Add a ampdoc factory to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {function(!./ampdoc-impl.AmpDoc)} factory\n   * @param {string=} opt_forName\n   * @restricted\n   */\n  ;\n\n  _proto.addDocFactory = function addDocFactory(factory, opt_forName) {\n    var holder = this.getCurrentExtensionHolder_(opt_forName);\n    holder.docFactories.push(factory); // If a single-doc mode, run factory right away if it's included by the doc.\n\n    if (this.currentExtensionId_ && this.ampdocService_.isSingleDoc()) {\n      var ampdoc = this.ampdocService_.getAmpDoc(this.win.document);\n      var extensionId = (0, _log.dev)().assertString(this.currentExtensionId_); // Note that this won't trigger for FIE extensions that are not present\n      // in the parent doc.\n\n      if (ampdoc.declaresExtension(extensionId) || holder.auto) {\n        factory(ampdoc);\n      }\n    }\n  }\n  /**\n   * Installs all ampdoc factories previously registered with\n   * `addDocFactory`.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Array<string>} extensionIds\n   * @return {!Promise}\n   * @restricted\n   */\n  ;\n\n  _proto.installExtensionsInDoc = function installExtensionsInDoc(ampdoc, extensionIds) {\n    var _this4 = this;\n\n    var promises = [];\n    extensionIds.forEach(function (extensionId) {\n      promises.push(_this4.installExtensionInDoc(ampdoc, extensionId));\n    });\n    return Promise.all(promises);\n  }\n  /**\n   * Installs all ampdoc factories for the specified extension.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} extensionId\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.installExtensionInDoc = function installExtensionInDoc(ampdoc, extensionId) {\n    var holder = this.getExtensionHolder_(extensionId,\n    /* auto */\n    false);\n    return this.waitFor_(holder).then(function () {\n      ampdoc.declareExtension(extensionId);\n      holder.docFactories.forEach(function (factory) {\n        try {\n          factory(ampdoc);\n        } catch (e) {\n          (0, _log.rethrowAsync)('Doc factory failed: ', e, extensionId);\n        }\n      });\n    });\n  }\n  /**\n   * Creates or returns an existing extension holder.\n   * @param {string} extensionId\n   * @param {boolean} auto\n   * @return {!ExtensionHolderDef}\n   * @private\n   */\n  ;\n\n  _proto.getExtensionHolder_ = function getExtensionHolder_(extensionId, auto) {\n    var holder = this.extensions_[extensionId];\n\n    if (!holder) {\n      var extension =\n      /** @type {ExtensionDef} */\n      {\n        elements: {},\n        services: []\n      };\n      holder =\n      /** @type {ExtensionHolderDef} */\n      {\n        extension: extension,\n        auto: auto,\n        docFactories: [],\n        promise: undefined,\n        resolve: undefined,\n        reject: undefined,\n        loaded: undefined,\n        error: undefined,\n        scriptPresent: undefined\n      };\n      this.extensions_[extensionId] = holder;\n    }\n\n    return holder;\n  }\n  /**\n   * Returns the holder for the extension currently being registered.\n   * @param {string=} opt_forName Used for logging only.\n   * @return {!ExtensionHolderDef}\n   * @private\n   */\n  ;\n\n  _proto.getCurrentExtensionHolder_ = function getCurrentExtensionHolder_(opt_forName) {\n    if (!this.currentExtensionId_ && !(0, _mode.getMode)().test) {\n      (0, _log.dev)().error(TAG, 'unknown extension for ', opt_forName);\n    }\n\n    return this.getExtensionHolder_(this.currentExtensionId_ || UNKNOWN_EXTENSION,\n    /* auto */\n    true);\n  }\n  /**\n   * Creates or returns an existing promise that will yield as soon as the\n   * extension has been loaded.\n   * @param {!ExtensionHolderDef} holder\n   * @return {!Promise<!ExtensionDef>}\n   * @private\n   */\n  ;\n\n  _proto.waitFor_ = function waitFor_(holder) {\n    if (!holder.promise) {\n      if (holder.loaded) {\n        holder.promise = Promise.resolve(holder.extension);\n      } else if (holder.error) {\n        holder.promise = Promise.reject(holder.error);\n      } else {\n        var deferred = new _promise.Deferred();\n        holder.promise = deferred.promise;\n        holder.resolve = deferred.resolve;\n        holder.reject = deferred.reject;\n      }\n    }\n\n    return holder.promise;\n  }\n  /**\n   * Ensures that the script has already been injected in the page.\n   * @param {string} extensionId\n   * @param {!ExtensionHolderDef} holder\n   * @param {string=} opt_extensionVersion\n   * @private\n   */\n  ;\n\n  _proto.insertExtensionScriptIfNeeded_ = function insertExtensionScriptIfNeeded_(extensionId, holder, opt_extensionVersion) {\n    if (this.isExtensionScriptRequired_(extensionId, holder)) {\n      var scriptElement = this.createExtensionScript_(extensionId, opt_extensionVersion);\n      this.win.document.head.appendChild(scriptElement);\n      holder.scriptPresent = true;\n    }\n  }\n  /**\n   * Determine the need to add amp extension script to document.\n   * @param {string} extensionId\n   * @param {!ExtensionHolderDef} holder\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.isExtensionScriptRequired_ = function isExtensionScriptRequired_(extensionId, holder) {\n    if (holder.loaded || holder.error) {\n      return false;\n    }\n\n    if (holder.scriptPresent === undefined) {\n      var scriptInHead = this.getExtensionScript_(extensionId);\n      holder.scriptPresent = !!scriptInHead;\n    }\n\n    return !holder.scriptPresent;\n  }\n  /**\n   * Create the missing amp extension HTML script element.\n   * @param {string} extensionId\n   * @param {string=} opt_extensionVersion\n   * @return {!Element} Script object\n   * @private\n   */\n  ;\n\n  _proto.createExtensionScript_ = function createExtensionScript_(extensionId, opt_extensionVersion) {\n    var scriptElement = this.win.document.createElement('script');\n    scriptElement.async = true;\n\n    if (isIntermediateExtension(extensionId)) {\n      opt_extensionVersion = '';\n    } else {\n      scriptElement.setAttribute(this.attributeForExtension_(extensionId), extensionId);\n    }\n\n    scriptElement.setAttribute('data-script', extensionId);\n    scriptElement.setAttribute('i-amphtml-inserted', '');\n    var loc = this.win.location;\n\n    if ((0, _mode.getMode)().test && this.win.testLocation) {\n      loc = this.win.testLocation;\n    }\n\n    var scriptSrc = (0, _extensionLocation.calculateExtensionScriptUrl)(loc, extensionId, opt_extensionVersion, (0, _mode.getMode)().localDev);\n    scriptElement.src = scriptSrc;\n    return scriptElement;\n  }\n  /**\n   * @param {string} extensionId\n   * @return {string}\n   * @private\n   */\n  ;\n\n  _proto.attributeForExtension_ = function attributeForExtension_(extensionId) {\n    return isTemplateExtension(extensionId) ? 'custom-template' : 'custom-element';\n  };\n\n  return Extensions;\n}();\n/**\n * @param {!Window} win\n */\n\n\nexports.Extensions = Extensions;\n\nfunction stubLegacyElements(win) {\n  LEGACY_ELEMENTS.forEach(function (name) {\n    (0, _customElementRegistry.stubElementIfNotKnown)(win, name);\n  });\n}\n/**\n * @return {!Object}\n */\n\n\nfunction emptyService() {\n  // All services need to resolve to an object.\n  return {};\n}\n\n},{\"../log\":68,\"../mode\":70,\"../service\":79,\"../services\":123,\"../string\":126,\"../style-installer\":127,\"../utils/object\":145,\"../utils/promise\":147,\"./custom-element-registry\":87,\"./extension-location\":89}],91:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.FixedLayer = void 0;\n\nvar _pass = require(\"../pass\");\n\nvar _services = require(\"../services\");\n\nvar _style = require(\"../style\");\n\nvar _dom = require(\"../dom\");\n\nvar _log = require(\"../log\");\n\nvar _string = require(\"../string\");\n\nvar _experiments = require(\"../experiments\");\n\nvar _array = require(\"../utils/array\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG = 'FixedLayer';\nvar DECLARED_FIXED_PROP = '__AMP_DECLFIXED';\nvar DECLARED_STICKY_PROP = '__AMP_DECLSTICKY';\nvar LIGHTBOX_MODE_ATTR = 'i-amphtml-lightbox';\nvar LIGHTBOX_ELEMENT_CLASS = 'i-amphtml-lightbox-element';\n/**\n * @param {!Element} el\n * @return {boolean}\n */\n\nfunction isLightbox(el) {\n  return el.tagName.indexOf('LIGHTBOX') !== -1;\n}\n/**\n * The fixed layer is a *sibling* of the body element. I.e. it's a direct\n * child of documentElement. It's used to manage the `position:fixed` and\n * `position:sticky` elements in iOS-iframe case due to the\n * https://bugs.webkit.org/show_bug.cgi?id=154399 bug, which is itself\n * a result of workaround for the issue where scrolling is not supported\n * in iframes (https://bugs.webkit.org/show_bug.cgi?id=149264).\n * This implementation finds all elements that could be `fixed` or `sticky`\n * and checks on major relayouts if they are indeed `fixed`/`sticky`.\n * Some `fixed` elements may be moved into the \"transfer layer\".\n */\n\n\nvar FixedLayer =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!./vsync-impl.Vsync} vsync\n   * @param {number} borderTop\n   * @param {number} paddingTop\n   * @param {boolean} transfer\n   */\n  function FixedLayer(ampdoc, vsync, borderTop, paddingTop, transfer) {\n    var _this = this;\n\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @private @const */\n\n    this.vsync_ = vsync;\n    /** @const @private {number} */\n\n    this.borderTop_ = borderTop;\n    /** @private {number} */\n\n    this.paddingTop_ = paddingTop;\n    /** @private {number} */\n\n    this.committedPaddingTop_ = paddingTop;\n    /** @private @const {boolean} */\n\n    this.transfer_ = transfer && ampdoc.isSingleDoc();\n    /** @private {?TransferLayerDef} */\n\n    this.transferLayer_ = null;\n    /** @private {number} */\n\n    this.counter_ = 0;\n    /** @const @private {!Array<!ElementDef>} */\n\n    this.elements_ = [];\n    /** @const @private {!Pass} */\n\n    this.updatePass_ = new _pass.Pass(ampdoc.win, function () {\n      _this.update();\n    });\n    /** @private {?function()} */\n\n    this.hiddenObserverUnlistener_ = null;\n    /** @private {!Array<string>} */\n\n    this.fixedSelectors_ = [];\n    /** @private {!Array<string>} */\n\n    this.stickySelectors_ = [];\n  }\n  /**\n   * Informs FixedLayer that a lightbox was opened.\n   *\n   * - FixedLayer hides any transfer layer elements that may be overlayed on\n   *   top of the lightbox, which is confusing UX.\n   * - When `onComplete` resolves, FixedLayer scans and transfers any fixed\n   *   descendants of `lightbox`. This enables unjanky fixed elements in\n   *   lightboxes on iOS.\n   *\n   * @param {!Element=} opt_lightbox\n   * @param {!Promise=} opt_onComplete Promise that resolves when lightbox\n   *   UX completes e.g. open transition animation.\n   */\n\n\n  var _proto = FixedLayer.prototype;\n\n  _proto.enterLightbox = function enterLightbox(opt_lightbox, opt_onComplete) {\n    var _this2 = this;\n\n    var transferLayer = this.getTransferLayer_();\n\n    if (transferLayer) {\n      transferLayer.setLightboxMode(true);\n    }\n\n    if (opt_lightbox && opt_onComplete) {\n      opt_onComplete.then(function () {\n        _this2.scanNode_((0, _log.dev)().assertElement(opt_lightbox),\n        /* lightboxMode */\n        true);\n      });\n    }\n  }\n  /**\n   * Reverses the actions performed by `enterLightbox()`.\n   */\n  ;\n\n  _proto.leaveLightbox = function leaveLightbox() {\n    var transferLayer = this.getTransferLayer_();\n\n    if (transferLayer) {\n      transferLayer.setLightboxMode(false);\n    }\n\n    var fes = (0, _array.remove)(this.elements_, function (fe) {\n      return !!fe.lightboxed;\n    });\n    this.returnFixedElements_(fes);\n\n    if (!this.elements_.length) {\n      this.unobserveHiddenMutations_();\n    }\n  }\n  /**\n   * Must be always called after DOMReady.\n   */\n  ;\n\n  _proto.setup = function setup() {\n    var root = this.ampdoc.getRootNode();\n    var stylesheets = root.styleSheets;\n\n    if (!stylesheets) {\n      return;\n    }\n\n    this.fixedSelectors_.length = 0;\n    this.stickySelectors_.length = 0;\n\n    for (var i = 0; i < stylesheets.length; i++) {\n      var stylesheet = stylesheets[i]; // Rare but may happen if the document is being concurrently disposed.\n\n      if (!stylesheet) {\n        (0, _log.dev)().error(TAG, 'Aborting setup due to null stylesheet.');\n        return;\n      }\n\n      var disabled = stylesheet.disabled,\n          ownerNode = stylesheet.ownerNode;\n\n      if (disabled || !ownerNode || ownerNode.tagName != 'STYLE' || ownerNode.hasAttribute('amp-boilerplate') || ownerNode.hasAttribute('amp-runtime') || ownerNode.hasAttribute('amp-extension')) {\n        continue;\n      } // Don't dereference cssRules early to avoid \"Cannot access rules\"\n      // DOMException due to reading a CORS stylesheet e.g. font.\n\n\n      this.discoverSelectors_(stylesheet.cssRules);\n    }\n\n    this.scanNode_(root);\n\n    if (this.elements_.length > 0) {\n      this.observeHiddenMutations();\n    }\n\n    var platform = _services.Services.platformFor(this.ampdoc.win);\n\n    if (this.elements_.length > 0 && !this.transfer_ && platform.isIos()) {\n      (0, _log.user)().warn(TAG, 'Please test this page inside of an AMP Viewer such' + \" as Google's because the fixed or sticky positioning might have\" + ' slightly different layout.');\n    }\n  }\n  /**\n   * @param {!Node} node\n   * @param {boolean=} opt_lightboxMode\n   * @private\n   */\n  ;\n\n  _proto.scanNode_ = function scanNode_(node, opt_lightboxMode) {\n    this.trySetupSelectors_(node, opt_lightboxMode); // Sort tracked elements in document order.\n\n    this.sortInDomOrder_();\n    this.update();\n  }\n  /**\n   * Begin observing changes to the hidden attribute.\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.observeHiddenMutations = function observeHiddenMutations() {\n    if (!(0, _experiments.isExperimentOn)(this.ampdoc.win, 'hidden-mutation-observer')) {\n      return;\n    }\n\n    this.initHiddenObserver_();\n  }\n  /**\n   * Stop observing changes to the hidden attribute.\n   */\n  ;\n\n  _proto.unobserveHiddenMutations_ = function unobserveHiddenMutations_() {\n    this.updatePass_.cancel();\n    var unlisten = this.hiddenObserverUnlistener_;\n\n    if (unlisten) {\n      unlisten();\n      this.hiddenObserverUnlistener_ = null;\n    }\n  }\n  /**\n   * Start observing changes to the hidden attribute, if we haven't already\n   * started.\n   */\n  ;\n\n  _proto.initHiddenObserver_ = function initHiddenObserver_() {\n    var _this3 = this;\n\n    if (this.hiddenObserverUnlistener_) {\n      return;\n    }\n\n    var root = this.ampdoc.getRootNode();\n    var element = root.documentElement || root;\n\n    var hiddenObserver = _services.Services.hiddenObserverForDoc(element);\n\n    this.hiddenObserverUnlistener_ = hiddenObserver.add(function () {\n      if (!_this3.updatePass_.isPending()) {\n        // Wait one animation frame so that other mutations may arrive.\n        _this3.updatePass_.schedule(16);\n      }\n    });\n  }\n  /**\n   * Updates the viewer's padding-top position and recalculates offsets of\n   * all elements. The padding update can be transient, in which case the\n   * UI itself is not updated leaving the blank space up top, which is invisible\n   * due to scroll position. This mode saves significant resources. However,\n   * eventhough layout is not updated, the fixed/sticky coordinates still need\n   * to be recalculated.\n   * @param {number} paddingTop\n   * @param {boolean} opt_transient\n   */\n  ;\n\n  _proto.updatePaddingTop = function updatePaddingTop(paddingTop, opt_transient) {\n    this.paddingTop_ = paddingTop;\n\n    if (!opt_transient) {\n      this.committedPaddingTop_ = paddingTop;\n    }\n\n    this.update();\n  }\n  /**\n   * Apply or reset transform style to fixed elements. The existing transition,\n   * if any, is disabled when custom transform is supplied.\n   * @param {?string} transform\n   */\n  ;\n\n  _proto.transformMutate = function transformMutate(transform) {\n    // Unfortunately, we can't do anything with sticky elements here. Updating\n    // `top` in animation frames causes reflow on all platforms and we can't\n    // determine whether an element is currently docked to apply transform.\n    if (transform) {\n      // Apply transform style to all fixed elements\n      this.elements_.forEach(function (e) {\n        if (e.fixedNow && e.top) {\n          (0, _style.setStyle)(e.element, 'transition', 'none');\n\n          if (e.transform && e.transform != 'none') {\n            (0, _style.setStyle)(e.element, 'transform', e.transform + ' ' + transform);\n          } else {\n            (0, _style.setStyle)(e.element, 'transform', transform);\n          }\n        }\n      });\n    } else {\n      // Reset transform style to all fixed elements\n      this.elements_.forEach(function (e) {\n        if (e.fixedNow && e.top) {\n          (0, _style.setStyles)(e.element, {\n            transform: '',\n            transition: ''\n          });\n        }\n      });\n    }\n  }\n  /**\n   * Adds the element directly into the fixed/sticky layer, bypassing discovery.\n   * @param {!Element} element\n   * @param {boolean=} opt_forceTransfer If set to true, then the element needs\n   *    to be forcefully transferred to the transfer layer. If false, then it\n   *    will only receive top-padding compensation for the header and never be\n   *    transferred.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.addElement = function addElement(element, opt_forceTransfer) {\n    var added = this.setupElement_(element,\n    /* selector */\n    '*',\n    /* position */\n    'fixed', opt_forceTransfer);\n\n    if (!added) {\n      return Promise.resolve();\n    }\n\n    this.sortInDomOrder_(); // If this is the first element, we need to start the mutation observer.\n    // This'll only be created once.\n\n    this.observeHiddenMutations();\n    return this.update();\n  }\n  /**\n   * Removes the element from the fixed/sticky layer.\n   * @param {!Element} element\n   */\n  ;\n\n  _proto.removeElement = function removeElement(element) {\n    var fes = this.tearDownElement_(element);\n    this.returnFixedElements_(fes);\n  }\n  /**\n   * Returns fixed elements from the transfer layer.\n   * @param {!Array<ElementDef>} fes\n   * @private\n   */\n  ;\n\n  _proto.returnFixedElements_ = function returnFixedElements_(fes) {\n    var _this4 = this;\n\n    if (fes.length > 0 && this.transferLayer_) {\n      this.vsync_.mutate(function () {\n        for (var i = 0; i < fes.length; i++) {\n          var fe = fes[i];\n\n          if (fe.position == 'fixed') {\n            _this4.transferLayer_.returnFrom(fe);\n          }\n        }\n      });\n    }\n  }\n  /**\n   * Whether the element is declared as fixed in any of the user's stylesheets.\n   * Will include any matches, not necessarily currently fixed elements.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isDeclaredFixed = function isDeclaredFixed(element) {\n    return !!element[DECLARED_FIXED_PROP];\n  }\n  /**\n   * Whether the element is declared as sticky in any of the user's stylesheets.\n   * Will include any matches, not necessarily currently sticky elements.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isDeclaredSticky = function isDeclaredSticky(element) {\n    return !!element[DECLARED_STICKY_PROP];\n  }\n  /**\n   * Performs fixed/sticky actions.\n   * 1. Updates `top` styling if necessary.\n   * 2. On iOS/Iframe moves elements between fixed layer and BODY depending on\n   * whether they are currently visible and fixed\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.update = function update() {\n    var _this5 = this;\n\n    // Some of the elements may no longer be in DOM.\n\n    /** @type {!Array<!ElementDef>} */\n    var toRemove = this.elements_.filter(function (fe) {\n      return !_this5.ampdoc.contains(fe.element);\n    });\n    toRemove.forEach(function (fe) {\n      return _this5.tearDownElement_(fe.element);\n    });\n\n    if (this.elements_.length == 0) {\n      return Promise.resolve();\n    } // Clear out the update pass since we're doing the work now.\n\n\n    this.updatePass_.cancel(); // Next, the positioning-related properties will be measured. If a\n    // potentially fixed/sticky element turns out to be actually fixed/sticky,\n    // it will be decorated and possibly moved to a separate layer.\n\n    var hasTransferables = false;\n    return this.vsync_.runPromise({\n      measure: function measure(state) {\n        var elements = _this5.elements_;\n        var autoTops = [];\n        var win = _this5.ampdoc.win; // Notice that this code intentionally breaks vsync contract.\n        // Unfortunately, there's no way to reliably test whether or not\n        // `top` has been set to a non-auto value on all platforms. To work\n        // this around, this code compares `style.top` values with a new\n        // `style.bottom` value.\n        // 1. Unset top from previous mutates and set bottom to an extremely\n        // large value (to catch cases where sticky-tops are in a long way\n        // down inside a scroller).\n\n        for (var i = 0; i < elements.length; i++) {\n          (0, _style.setImportantStyles)(elements[i].element, {\n            top: '',\n            bottom: '-9999vh',\n            transition: 'none'\n          });\n        } // 2. Capture the `style.top` with this new `style.bottom` value. If\n        // this element has a non-auto top, this value will remain constant\n        // regardless of bottom.\n\n\n        for (var _i = 0; _i < elements.length; _i++) {\n          autoTops.push((0, _style.computedStyle)(win, elements[_i].element).top);\n        } // 3. Cleanup the `style.bottom`.\n\n\n        for (var _i2 = 0; _i2 < elements.length; _i2++) {\n          (0, _style.setStyle)(elements[_i2].element, 'bottom', '');\n        }\n\n        for (var _i3 = 0; _i3 < elements.length; _i3++) {\n          var fe = elements[_i3];\n          var element = fe.element,\n              forceTransfer = fe.forceTransfer;\n          var style = (0, _style.computedStyle)(win, element);\n          var offsetWidth = element.offsetWidth,\n              offsetHeight = element.offsetHeight,\n              offsetTop = element.offsetTop;\n          var _style$position = style.position,\n              position = _style$position === void 0 ? '' : _style$position,\n              _style$display = style.display,\n              display = _style$display === void 0 ? '' : _style$display,\n              bottom = style.bottom,\n              zIndex = style.zIndex;\n          var opacity = parseFloat(style.opacity);\n          var transform = style[(0, _style.getVendorJsPropertyName)(style, 'transform')];\n          var top = style.top;\n          var isFixed = position === 'fixed' && (forceTransfer || offsetWidth > 0 && offsetHeight > 0);\n          var isSticky = (0, _string.endsWith)(position, 'sticky');\n          var isDisplayed = display !== 'none';\n\n          if (!isDisplayed || !(isFixed || isSticky)) {\n            state[fe.id] = {\n              fixed: false,\n              sticky: false,\n              transferrable: false,\n              top: '',\n              zIndex: ''\n            };\n            continue;\n          }\n\n          if (top === 'auto' || autoTops[_i3] !== top) {\n            if (isFixed && offsetTop === _this5.committedPaddingTop_ + _this5.borderTop_) {\n              top = '0px';\n            } else {\n              top = '';\n            }\n          } // Transferability requires an element to be:\n          // 1. Greater than 0% opacity. That's a lot of work for no benefit.\n          //    Additionally, transparent elements used for \"service\" needs and\n          //    thus best kept in the original tree. The visibility, however,\n          //    is not considered because `visibility` CSS is inherited.\n          // 2. Height < 300. This avoids transferring large sections of UI,\n          //    e.g. publisher-customized amp-consent UI (#17995).\n          // 3. Has `top` or `bottom` CSS set. This ensures we only transfer\n          //    fixed elements that are _not_ auto-positioned to avoid jumping\n          //    position after transferring to the fixed layer (due to loss of\n          //    parent positioning context). We could calculate this offset, but\n          //    we don't (yet).\n\n\n          var isTransferrable = false;\n\n          if (isFixed) {\n            if (forceTransfer === true) {\n              isTransferrable = true;\n            } else if (forceTransfer === false) {\n              isTransferrable = false;\n            } else {\n              isTransferrable = opacity > 0 && offsetHeight < 300 && !!(top || bottom);\n            }\n          }\n\n          if (isTransferrable) {\n            hasTransferables = true;\n          }\n\n          state[fe.id] = {\n            fixed: isFixed,\n            sticky: isSticky,\n            transferrable: isTransferrable,\n            top: top,\n            zIndex: zIndex,\n            transform: transform\n          };\n        }\n      },\n      mutate: function mutate(state) {\n        if (hasTransferables && _this5.transfer_) {\n          _this5.getTransferLayer_().update();\n        }\n\n        var elements = _this5.elements_;\n\n        for (var i = 0; i < elements.length; i++) {\n          var fe = elements[i];\n          var feState = state[fe.id]; // Fix a bug with Safari. For some reason, you cannot unset\n          // transition when it's important. You can, however, set it to a valid\n          // non-important value, then unset it.\n\n          (0, _style.setStyle)(fe.element, 'transition', 'none'); // Note: This MUST be done after measurements are taken.\n          // Transitions will mess up everything and, depending on when paints\n          // happen, mutates of transition and bottom at the same time may be\n          // make the transition active.\n\n          (0, _style.setStyle)(fe.element, 'transition', '');\n\n          if (feState) {\n            _this5.mutateElement_(fe, i, feState);\n          }\n        }\n      }\n    }, {}).catch(function (error) {\n      // Fail silently.\n      (0, _log.dev)().error(TAG, 'Failed to mutate fixed elements:', error);\n    });\n  }\n  /**\n   * Calls `setupSelectors_` in a try-catch.\n   * Fails quietly with a dev error if call fails.\n   * This method should not be inlined to prevent TryCatch deoptimization.\n   * @param {!Node} root\n   * @param {boolean=} opt_lightboxMode\n   * @private\n   * @noinline\n   */\n  ;\n\n  _proto.trySetupSelectors_ = function trySetupSelectors_(root, opt_lightboxMode) {\n    try {\n      this.setupSelectors_(root, opt_lightboxMode);\n    } catch (e) {\n      // Fail quietly.\n      (0, _log.dev)().error(TAG, 'Failed to setup fixed elements:', e);\n    }\n  }\n  /**\n   * Calls `setupElement_` for up to 10 elements matching each selector\n   * in `fixedSelectors` and for all selectors in `stickySelectors`.\n   * @param {!Node} root\n   * @param {boolean=} opt_lightboxMode\n   * @private\n   */\n  ;\n\n  _proto.setupSelectors_ = function setupSelectors_(root, opt_lightboxMode) {\n    for (var i = 0; i < this.fixedSelectors_.length; i++) {\n      var fixedSelector = this.fixedSelectors_[i];\n      var elements = root.querySelectorAll(fixedSelector);\n\n      for (var j = 0; j < elements.length; j++) {\n        if (this.elements_.length > 10) {\n          // We shouldn't have too many of `fixed` elements.\n          break;\n        }\n\n        this.setupElement_(elements[j], fixedSelector, 'fixed',\n        /* opt_forceTransfer */\n        undefined, opt_lightboxMode);\n      }\n    }\n\n    for (var _i4 = 0; _i4 < this.stickySelectors_.length; _i4++) {\n      var stickySelector = this.stickySelectors_[_i4];\n\n      var _elements = root.querySelectorAll(stickySelector);\n\n      for (var _j = 0; _j < _elements.length; _j++) {\n        this.setupElement_(_elements[_j], stickySelector, 'sticky',\n        /* opt_forceTransfer */\n        undefined, opt_lightboxMode);\n      }\n    }\n  }\n  /**\n   * If the given element has a `style` attribute with a top/bottom CSS rule,\n   * display a user error. FixedLayer's implementation currently overrides\n   * top, bottom and a few other CSS rules.\n   * @param {!Element} element\n   * @private\n   */\n  ;\n\n  _proto.warnAboutInlineStylesIfNecessary_ = function warnAboutInlineStylesIfNecessary_(element) {\n    if (element.hasAttribute('style') && ((0, _style.getStyle)(element, 'top') || (0, _style.getStyle)(element, 'bottom'))) {\n      (0, _log.user)().error(TAG, 'Inline styles with `top`, `bottom` and other ' + 'CSS rules are not supported yet for fixed or sticky elements ' + '(#14186). Unexpected behavior may occur.', element);\n    }\n  }\n  /**\n   * This method records the potentially fixed or sticky element. One of a more\n   * critical functions - it records all selectors that may apply \"fixed\"\n   * or \"sticky\" to this element to check them later.\n   *\n   * @param {!Element} element\n   * @param {string} selector\n   * @param {string} position\n   * @param {boolean=} opt_forceTransfer If true, then the element will\n   *    be forcibly transferred to the transfer layer.\n   * @param {boolean=} opt_lightboxMode If true, then descendants of lightboxes\n   *    are allowed to be set up. Default is false.\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.setupElement_ = function setupElement_(element, selector, position, opt_forceTransfer, opt_lightboxMode) {\n    // Warn that pub-authored inline styles may be overriden by FixedLayer.\n    if (!opt_forceTransfer) {\n      this.warnAboutInlineStylesIfNecessary_(element);\n    } // Ignore lightboxes because FixedLayer can interfere with their\n    // opening/closing animations (#19149).\n\n\n    if (isLightbox(element)) {\n      return false;\n    }\n\n    var isLightboxDescendant = (0, _dom.closest)(element, isLightbox);\n\n    if (!opt_lightboxMode && isLightboxDescendant) {\n      return false;\n    }\n\n    var elements = this.elements_; // Avoid ancestor-descendant relationships in tracked elements to prevent\n    // \"double top-offset\" (#22860).\n\n    var removals = [];\n\n    for (var i = 0; i < elements.length; i++) {\n      var el = elements[i].element;\n\n      if (el === element) {\n        break;\n      } // Early exit if element is a child of an already-tracked element...\n\n\n      if (el.contains(element)) {\n        return false;\n      } // Remove the already-tracked element if it is a child of the new\n      // element...\n\n\n      if (element.contains(el)) {\n        removals.push(el);\n      }\n    }\n\n    for (var _i5 = 0; _i5 < removals.length; _i5++) {\n      this.removeElement(removals[_i5]);\n    }\n\n    var fe = null;\n\n    for (var _i6 = 0; _i6 < elements.length; _i6++) {\n      var _el = elements[_i6];\n\n      if (_el.element == element && _el.position == position) {\n        fe = _el;\n        break;\n      }\n    }\n\n    var isFixed = position == 'fixed';\n\n    if (fe) {\n      if (!fe.selectors.includes(selector)) {\n        // Already seen.\n        fe.selectors.push(selector);\n      }\n    } else {\n      // A new entry.\n      var id = 'F' + this.counter_++;\n      element.setAttribute('i-amphtml-fixedid', id);\n\n      if (isFixed) {\n        element[DECLARED_FIXED_PROP] = true;\n      } else {\n        element[DECLARED_STICKY_PROP] = true;\n      }\n\n      fe = {\n        id: id,\n        element: element,\n        position: position,\n        selectors: [selector],\n        fixedNow: false,\n        stickyNow: false,\n        lightboxed: !!isLightboxDescendant\n      };\n      elements.push(fe);\n    }\n\n    fe.forceTransfer = isFixed ? opt_forceTransfer : false;\n    return true;\n  }\n  /**\n   * Undoes set up by removing element record and and resets `top` style.\n   * Does _not_ return the element from the transfer layer.\n   *\n   * @param {!Element} element\n   * @return {!Array<!ElementDef>}\n   * @private\n   */\n  ;\n\n  _proto.tearDownElement_ = function tearDownElement_(element) {\n    var removed = [];\n\n    for (var i = 0; i < this.elements_.length; i++) {\n      var fe = this.elements_[i];\n\n      if (fe.element === element) {\n        if (!fe.lightboxed) {\n          this.vsync_.mutate(function () {\n            (0, _style.setStyle)(element, 'top', '');\n          });\n        }\n\n        this.elements_.splice(i, 1);\n        removed.push(fe);\n      }\n    }\n\n    if (!this.elements_.length) {\n      this.unobserveHiddenMutations_();\n    }\n\n    return removed;\n  }\n  /**\n   * @private\n   */\n  ;\n\n  _proto.sortInDomOrder_ = function sortInDomOrder_() {\n    this.elements_.sort(function (fe1, fe2) {\n      return (0, _dom.domOrderComparator)(fe1.element, fe2.element);\n    });\n  }\n  /**\n   * Mutates the fixed/sticky element. At this point it's determined that the\n   * element is indeed fixed/sticky. There are two main functions here:\n   *  1. `top` has to be updated to reflect viewer's paddingTop.\n   *  2. The element may need to be transfered to the separate fixed layer.\n   *\n   * @param {!ElementDef} fe\n   * @param {number} index\n   * @param {!ElementStateDef} state\n   * @private\n   */\n  ;\n\n  _proto.mutateElement_ = function mutateElement_(fe, index, state) {\n    var element = fe.element,\n        oldFixed = fe.fixedNow;\n    fe.fixedNow = state.fixed;\n    fe.stickyNow = state.sticky;\n    fe.top = state.fixed || state.sticky ? state.top : '';\n    fe.transform = state.transform; // Move back to the BODY layer and reset transfer z-index.\n\n    if (oldFixed && (!state.fixed || !state.transferrable) && this.transferLayer_) {\n      this.transferLayer_.returnFrom(fe);\n    } // Update `top` to adjust position to the viewer's paddingTop. However,\n    // ignore lightboxed elements since lightboxes ignore the viewer header.\n\n\n    if (state.top && (state.fixed || state.sticky) && !fe.lightboxed) {\n      if (state.fixed || !this.transfer_) {\n        // Fixed positions always need top offsetting, as well as stickies on\n        // non iOS Safari.\n        (0, _style.setStyle)(element, 'top', \"calc(\" + state.top + \" + \" + this.paddingTop_ + \"px)\");\n      } else {\n        // On iOS Safari (this.transfer_ = true), stickies cannot\n        // have an offset because they are already offset by the padding-top.\n        if (this.committedPaddingTop_ === this.paddingTop_) {\n          // So, when the header is shown, just use top.\n          (0, _style.setStyle)(element, 'top', state.top);\n        } else {\n          // When the header is not shown, we need to subtract the padding top.\n          (0, _style.setStyle)(element, 'top', \"calc(\" + state.top + \" - \" + this.committedPaddingTop_ + \"px)\");\n        }\n      }\n    } // Move element to the fixed layer.\n\n\n    if (this.transfer_ && state.fixed && state.transferrable) {\n      this.getTransferLayer_().transferTo(fe, index, state);\n    }\n  }\n  /**\n   * @return {?TransferLayerDef}\n   */\n  ;\n\n  _proto.getTransferLayer_ = function getTransferLayer_() {\n    // This mode is only allowed for a single-doc case.\n    if (!this.transfer_ || this.transferLayer_) {\n      return this.transferLayer_;\n    }\n\n    var doc = this.ampdoc.win.document;\n    this.transferLayer_ = doc.body.shadowRoot ? new TransferLayerShadow(doc, this.vsync_) : new TransferLayerBody(doc, this.vsync_);\n    return this.transferLayer_;\n  }\n  /**\n   * Find all `position:fixed` and `position:sticky` elements.\n   * @param {!Array<CSSRule>} rules\n   * @private\n   */\n  ;\n\n  _proto.discoverSelectors_ = function discoverSelectors_(rules) {\n    for (var i = 0; i < rules.length; i++) {\n      var rule = rules[i];\n\n      if (rule.type ==\n      /* CSSMediaRule */\n      4 || rule.type ==\n      /* CSSSupportsRule */\n      12) {\n        this.discoverSelectors_(rule.cssRules);\n        continue;\n      }\n\n      if (rule.type ==\n      /* CSSStyleRule */\n      1) {\n        var selectorText = rule.selectorText;\n        var position = rule.style.position;\n\n        if (selectorText === '*' || !position) {\n          continue;\n        }\n\n        if (position === 'fixed') {\n          this.fixedSelectors_.push(selectorText);\n        } else if ((0, _string.endsWith)(position, 'sticky')) {\n          this.stickySelectors_.push(selectorText);\n        }\n      }\n    }\n  };\n\n  return FixedLayer;\n}();\n/**\n * @typedef {{\n *   id: string,\n *   selectors: !Array,\n *   element: !Element,\n *   position: string,\n *   placeholder: (?Element|undefined),\n *   fixedNow: boolean,\n *   stickyNow: boolean,\n *   top: (string|undefined),\n *   transform: (string|undefined),\n *   forceTransfer: (boolean|undefined),\n *   lightboxed: (boolean|undefined),\n * }}\n */\n\n\nexports.FixedLayer = FixedLayer;\nvar ElementDef;\n/**\n * @typedef {{\n *   fixed: boolean,\n *   sticky: boolean,\n *   transferrable: boolean,\n *   top: string,\n *   zIndex: string,\n * }}\n */\n\nvar ElementStateDef;\n/**\n * The contract for transfer layer.\n * @interface\n */\n\nvar TransferLayerDef =\n/*#__PURE__*/\nfunction () {\n  function TransferLayerDef() {}\n\n  var _proto2 = TransferLayerDef.prototype;\n\n  /**\n   * @return {!Element}\n   */\n  _proto2.getRoot = function getRoot() {}\n  /**\n   * Update most current styles for the transfer layer.\n   */\n  ;\n\n  _proto2.update = function update() {}\n  /**\n   * Toggles internal state after entering or leaving lightbox mode.\n   * @param {boolean} unusedOn\n   */\n  ;\n\n  _proto2.setLightboxMode = function setLightboxMode(unusedOn) {}\n  /**\n   * Transfer the element from the body into the transfer layer.\n   * @param {!ElementDef} unusedFe\n   * @param {number} unusedIndex\n   * @param {!ElementStateDef} unusedState\n   */\n  ;\n\n  _proto2.transferTo = function transferTo(unusedFe, unusedIndex, unusedState) {}\n  /**\n   * Return the element from the transfer layer back to the body.\n   * @param {!ElementDef} unusedFe\n   */\n  ;\n\n  _proto2.returnFrom = function returnFrom(unusedFe) {};\n\n  return TransferLayerDef;\n}();\n/**\n * The parallel `<body>` element is created and fixed elements are moved into\n * this element.\n * @implements {TransferLayerDef}\n */\n\n\nvar TransferLayerBody =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Document} doc\n   * @param {!./vsync-impl.Vsync} vsync\n   */\n  function TransferLayerBody(doc, vsync) {\n    /** @private @const {!Document} */\n    this.doc_ = doc;\n    /** @private @const {!./vsync-impl.Vsync} */\n\n    this.vsync_ = vsync;\n    /** @private @const {!Element} */\n\n    this.layer_ = doc.body.cloneNode(\n    /* deep */\n    false);\n    this.layer_.removeAttribute('style');\n    var styles = {\n      position: 'absolute',\n      top: 0,\n      left: 0,\n      height: 0,\n      width: 0,\n      pointerEvents: 'none',\n      overflow: 'hidden',\n      // Reset possible BODY styles.\n      animation: 'none',\n      background: 'none',\n      border: 'none',\n      borderImage: 'none',\n      boxSizing: 'border-box',\n      boxShadow: 'none',\n      float: 'none',\n      margin: 0,\n      opacity: 1,\n      outline: 'none',\n      padding: 'none',\n      transform: 'none',\n      transition: 'none'\n    };\n    (0, _style.setStyles)(this.layer_, (0, _style.assertDoesNotContainDisplay)(styles));\n    (0, _style.setInitialDisplay)(this.layer_, 'block');\n    doc.documentElement.appendChild(this.layer_);\n  }\n  /** @override */\n\n\n  var _proto3 = TransferLayerBody.prototype;\n\n  _proto3.getRoot = function getRoot() {\n    return this.layer_;\n  }\n  /** @override */\n  ;\n\n  _proto3.setLightboxMode = function setLightboxMode(on) {\n    var _this6 = this;\n\n    this.vsync_.mutate(function () {\n      var root = _this6.getRoot();\n\n      if (on) {\n        root.setAttribute(LIGHTBOX_MODE_ATTR, '');\n      } else {\n        root.removeAttribute(LIGHTBOX_MODE_ATTR);\n      }\n    });\n  }\n  /**\n   * Synchronizes any attribute mutations done on the real body to the layer.\n   * This is to better simulate the body in CSS selectors.\n   * @override\n   */\n  ;\n\n  _proto3.update = function update() {\n    var body = this.doc_.body;\n    var layer = this.layer_;\n    var bodyAttrs = body.attributes;\n    var layerAttrs = layer.attributes;\n\n    for (var i = 0; i < bodyAttrs.length; i++) {\n      var attr = bodyAttrs[i]; // Style is not copied because the fixed-layer must have very precise\n      // styles to enable smooth scrolling.\n\n      if (attr.name === 'style') {\n        continue;\n      } // Use cloneNode to get around invalid attribute names. Ahem, amp-bind.\n\n\n      layerAttrs.setNamedItem(attr.cloneNode(false));\n    }\n\n    for (var _i7 = 0; _i7 < layerAttrs.length; _i7++) {\n      var name = layerAttrs[_i7].name;\n\n      if (name === 'style' || name === LIGHTBOX_MODE_ATTR || body.hasAttribute(name)) {\n        continue;\n      }\n\n      layer.removeAttribute(name);\n      _i7--;\n    }\n  }\n  /** @override */\n  ;\n\n  _proto3.transferTo = function transferTo(fe, index, state) {\n    var _this7 = this;\n\n    var element = fe.element;\n\n    if (element.parentElement == this.layer_) {\n      return;\n    }\n\n    (0, _log.dev)().fine(TAG, 'transfer to fixed:', fe.id, fe.element);\n    (0, _log.user)().warn(TAG, 'In order to improve scrolling performance in Safari,' + ' we now move the element to a fixed positioning layer:', fe.element);\n\n    if (!fe.placeholder) {\n      // Never been transfered before: ensure that it's properly configured.\n      (0, _style.setStyle)(element, 'pointer-events', 'initial');\n      var placeholder = fe.placeholder = this.doc_.createElement('i-amphtml-fpa');\n      (0, _style.toggle)(placeholder, false);\n      placeholder.setAttribute('i-amphtml-fixedid', fe.id);\n    } // Calculate z-index based on the declared z-index and DOM position.\n\n\n    (0, _style.setStyle)(element, 'zIndex', \"calc(\" + (10000 + index) + \" + \" + (state.zIndex || 0) + \")\"); // Identify lightboxed elements so they can be visible when the transfer\n    // layer is \"hidden\", and hidden with the transfer layer is \"visible\".\n\n    if (fe.lightboxed) {\n      element.classList.add(LIGHTBOX_ELEMENT_CLASS);\n    }\n\n    element.parentElement.replaceChild(fe.placeholder, element);\n    this.layer_.appendChild(element); // Test if the element still matches one of the `fixed` selectors. If not\n    // return it back to BODY.\n\n    var matches = fe.selectors.some(function (selector) {\n      return _this7.matches_(element, selector);\n    });\n\n    if (!matches) {\n      (0, _log.user)().warn(TAG, 'Failed to move the element to the fixed position layer.' + ' This is most likely due to the compound CSS selector:', fe.element);\n      this.returnFrom(fe);\n    }\n  }\n  /** @override */\n  ;\n\n  _proto3.returnFrom = function returnFrom(fe) {\n    if (!fe.placeholder || !this.doc_.contains(fe.placeholder)) {\n      return;\n    }\n\n    var element = fe.element,\n        placeholder = fe.placeholder;\n    (0, _log.dev)().fine(TAG, 'return from fixed:', fe.id, element);\n\n    if (fe.lightboxed) {\n      element.classList.remove(LIGHTBOX_ELEMENT_CLASS);\n    }\n\n    if (this.doc_.contains(element)) {\n      (0, _style.setStyle)(fe.element, 'zIndex', '');\n      placeholder.parentElement.replaceChild(element, placeholder);\n    } else {\n      placeholder.parentElement.removeChild(placeholder);\n    }\n  }\n  /**\n   * @param {!Element} element\n   * @param {string} selector\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto3.matches_ = function matches_(element, selector) {\n    try {\n      return (0, _dom.matches)(element, selector);\n    } catch (e) {\n      // Fail silently.\n      (0, _log.dev)().error(TAG, 'Failed to test query match:', e);\n      return false;\n    }\n  };\n\n  return TransferLayerBody;\n}();\n\nvar FIXED_LAYER_SLOT = 'i-amphtml-fixed';\n/**\n * The fixed layer is created inside the shadow root of the `<body>` element\n * and fixed elements are distributed into this element via slots.\n * @implements {TransferLayerDef}\n */\n\nvar TransferLayerShadow =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Document} doc\n   * @param {!./vsync-impl.Vsync} vsync\n   */\n  function TransferLayerShadow(doc, vsync) {\n    /** @private @const {!./vsync-impl.Vsync} */\n    this.vsync_ = vsync;\n    /** @private @const {!Element} */\n\n    this.layer_ = doc.createElement('div');\n    this.layer_.id = 'i-amphtml-fixed-layer';\n    (0, _style.setImportantStyles)(this.layer_, {\n      position: 'absolute',\n      top: 0,\n      left: 0,\n      height: 0,\n      width: 0,\n      overflow: 'hidden'\n    }); // The slot where all fixed elements will be distributed.\n\n    var slot = doc.createElement('slot');\n    slot.setAttribute('name', FIXED_LAYER_SLOT);\n    this.layer_.appendChild(slot);\n    doc.body.shadowRoot.appendChild(this.layer_);\n  }\n  /** @override */\n\n\n  var _proto4 = TransferLayerShadow.prototype;\n\n  _proto4.getRoot = function getRoot() {\n    return this.layer_;\n  }\n  /** @override */\n  ;\n\n  _proto4.setLightboxMode = function setLightboxMode(on) {\n    var _this8 = this;\n\n    this.vsync_.mutate(function () {\n      (0, _style.setStyle)(_this8.getRoot(), 'visibility', on ? 'hidden' : 'visible');\n    });\n  }\n  /** @override */\n  ;\n\n  _proto4.update = function update() {} // Nothing to do.\n\n  /** @override */\n  ;\n\n  _proto4.transferTo = function transferTo(fe) {\n    var element = fe.element;\n    (0, _log.dev)().fine(TAG, 'transfer to fixed:', fe.id, fe.element);\n    (0, _log.user)().warn(TAG, 'In order to improve scrolling performance in Safari,' + ' we now move the element to a fixed positioning layer:', fe.element); // Distribute to the slot.\n\n    element.setAttribute('slot', FIXED_LAYER_SLOT);\n  }\n  /** @override */\n  ;\n\n  _proto4.returnFrom = function returnFrom(fe) {\n    (0, _log.dev)().fine(TAG, 'return from fixed:', fe.id, fe.element);\n    fe.element.removeAttribute('slot');\n  };\n\n  return TransferLayerShadow;\n}();\n\n},{\"../dom\":41,\"../experiments\":47,\"../log\":68,\"../pass\":72,\"../services\":123,\"../string\":126,\"../style\":128,\"../utils/array\":135}],92:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installHiddenObserverForDoc = installHiddenObserverForDoc;\nexports.HiddenObserver = void 0;\n\nvar _observable = require(\"../observable\");\n\nvar _log = require(\"../log\");\n\nvar _service = require(\"../service\");\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * MutationObserverInit options to listen for mutations to the `hidden`\n * attribute.\n */\nvar OBSERVER_OPTIONS = {\n  attributes: true,\n  attributeFilter: ['hidden'],\n  subtree: true\n};\n/**\n * A document level service that will listen for mutations on the `hidden`\n * attribute and notify listeners. The `hidden` attribute is used to toggle\n * `display: none` on elements.\n * @implements {../service.EmbeddableService}\n * @implements {../service.Disposable}\n */\n\nvar HiddenObserver =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_root\n   */\n  function HiddenObserver(ampdoc, opt_root) {\n    // TODO(#22733): remove subroooting once ampdoc-fie is launched.\n\n    /** @const {!Document|!ShadowRoot} */\n    this.root_ = opt_root || ampdoc.getRootNode();\n    var doc = this.root_.ownerDocument || this.root_;\n    /** @const {!Window} */\n\n    this.win_ =\n    /** @type {!Window} */\n    (0, _log.devAssert)(doc.defaultView);\n    /** @private {?MutationObserver} */\n\n    this.mutationObserver_ = null;\n    /** @private {?Observable<!Array<!MutationRecord>>} */\n\n    this.observable_ = null;\n  }\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n\n\n  HiddenObserver.installInEmbedWindow = function installInEmbedWindow(embedWin, ampdoc) {\n    (0, _service.installServiceInEmbedScope)(embedWin, 'hidden-observer', new HiddenObserver(ampdoc, embedWin.document));\n  }\n  /**\n   * Adds the observer to this instance.\n   * @param {function(!Array<!MutationRecord>)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  var _proto = HiddenObserver.prototype;\n\n  _proto.add = function add(handler) {\n    var _this = this;\n\n    this.init_();\n    var remove = this.observable_.add(handler);\n    return function () {\n      remove();\n\n      if (_this.observable_.getHandlerCount() === 0) {\n        _this.dispose();\n      }\n    };\n  }\n  /**\n   * Initializes the mutation observer and observable.\n   */\n  ;\n\n  _proto.init_ = function init_() {\n    var _this2 = this;\n\n    if (this.mutationObserver_) {\n      return;\n    }\n\n    this.observable_ = new _observable.Observable();\n    var mo = new this.win_.MutationObserver(function (mutations) {\n      if (mutations) {\n        _this2.observable_.fire(mutations);\n      }\n    });\n    this.mutationObserver_ = mo;\n    mo.observe(this.root_, OBSERVER_OPTIONS);\n  }\n  /**\n   * Cleans up the all the mutation observer once the last listener stops\n   * listening, or when the service's doc is disposing.\n   */\n  ;\n\n  _proto.dispose = function dispose() {\n    if (!this.mutationObserver_) {\n      return;\n    }\n\n    this.mutationObserver_.disconnect();\n    this.observable_.removeAll();\n    this.mutationObserver_ = null;\n    this.observable_ = null;\n  };\n\n  return HiddenObserver;\n}();\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nexports.HiddenObserver = HiddenObserver;\n\nfunction installHiddenObserverForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'hidden-observer', HiddenObserver);\n}\n\n},{\"../log\":68,\"../observable\":71,\"../service\":79}],93:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installHistoryServiceForDoc = installHistoryServiceForDoc;\nexports.HistoryBindingVirtual_ = exports.HistoryBindingNatural_ = exports.History = void 0;\n\nvar _promise = require(\"../utils/promise\");\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\nvar _object = require(\"../utils/object\");\n\nvar _mode = require(\"../mode\");\n\nvar _service = require(\"../service\");\n\nvar _history = require(\"../history\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @private @const {string} */\nvar TAG_ = 'History';\n/** @private @const {string} */\n\nvar HISTORY_PROP_ = 'AMP.History';\n/** @typedef {number} */\n\nvar HistoryIdDef;\n/**\n * @typedef {{stackIndex: HistoryIdDef, title: string, fragment: string, data: (!JsonObject|undefined)}}\n */\n\nvar HistoryStateDef;\n/**\n * @typedef {{title: (string|undefined), fragment: (string|undefined), url: (string|undefined), canonicalUrl: (string|undefined), data: (!JsonObject|undefined)}}\n */\n\nvar HistoryStateUpdateDef;\n/**\n * Wraps the browser's History API for viewer support and necessary polyfills.\n */\n\nvar History =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!HistoryBindingInterface} binding\n   */\n  function History(ampdoc, binding) {\n    /** @private @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n    /** @private @const {!../service/timer-impl.Timer} */\n\n    this.timer_ = _services.Services.timerFor(ampdoc.win);\n    /** @private @const {!HistoryBindingInterface} */\n\n    this.binding_ = binding;\n    /** @private {number} */\n\n    this.stackIndex_ = 0;\n    /** @private {!Array<!Function|undefined>} */\n\n    this.stackOnPop_ = [];\n    /**\n     * @private {!Array<!{\n     *   callback: function():!Promise,\n     *   resolve: !Function,\n     *   reject: !Function,\n     *   trace: (!Error|undefined)\n     * }>} */\n\n    this.queue_ = [];\n    this.binding_.setOnStateUpdated(this.onStateUpdated_.bind(this));\n  }\n  /** @visibleForTesting */\n\n\n  var _proto = History.prototype;\n\n  _proto.cleanup = function cleanup() {\n    this.binding_.cleanup();\n  }\n  /**\n   * Pushes new state into history stack with an optional callback to be called\n   * when this state is popped as well as an object with updates to be applied\n   * to the state.\n   * @param {!Function=} opt_onPop\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryIdDef>}\n   */\n  ;\n\n  _proto.push = function push(opt_onPop, opt_stateUpdate) {\n    var _this = this;\n\n    return this.enque_(function () {\n      return _this.binding_.push(opt_stateUpdate).then(function (historyState) {\n        _this.onStateUpdated_(historyState);\n\n        if (opt_onPop) {\n          _this.stackOnPop_[historyState.stackIndex] = opt_onPop;\n        }\n\n        return historyState.stackIndex;\n      });\n    }, 'push');\n  }\n  /**\n   * Pops a previously pushed state from the history stack. If onPop callback\n   * has been registered, it will be called with the state that was associated\n   * with the new head state within the history stack. All states coming\n   * after the supplied state will also be popped, and their\n   * callbacks executed in the same fashion.\n   * @param {!HistoryIdDef} stateId\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.pop = function pop(stateId) {\n    var _this2 = this;\n\n    return this.enque_(function () {\n      return _this2.binding_.pop(stateId).then(function (historyState) {\n        _this2.onStateUpdated_(historyState);\n      });\n    }, 'pop');\n  }\n  /**\n   * Replaces the current state, optionally specifying updates to the state\n   * object to be associated with the replacement.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.replace = function replace(opt_stateUpdate) {\n    var _this3 = this;\n\n    return this.enque_(function () {\n      return _this3.binding_.replace(opt_stateUpdate);\n    }, 'replace');\n  }\n  /**\n   * Retrieves the current state, containing the current fragment, title,\n   * and amp-bind state.\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  ;\n\n  _proto.get = function get() {\n    var _this4 = this;\n\n    return this.enque_(function () {\n      return _this4.binding_.get();\n    }, 'get');\n  }\n  /**\n   * Requests navigation one step back. This request is only satisifed\n   * when the history has at least one step to go back in the context\n   * of this document.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.goBack = function goBack() {\n    var _this5 = this;\n\n    return this.enque_(function () {\n      if (_this5.stackIndex_ <= 0) {\n        // Nothing left to pop.\n        return Promise.resolve();\n      } // Pop the current state. The binding will ignore the request if\n      // it cannot satisfy it.\n\n\n      return _this5.binding_.pop(_this5.stackIndex_).then(function (historyState) {\n        _this5.onStateUpdated_(historyState);\n      });\n    }, 'goBack');\n  }\n  /**\n   * Helper method to handle navigation to a local target, e.g. When a user\n   * clicks an anchor link to a local hash - <a href=\"#section1\">Go to section\n   * 1</a>.\n   *\n   * @param {string} target\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.replaceStateForTarget = function replaceStateForTarget(target) {\n    var _this6 = this;\n\n    (0, _log.devAssert)(target[0] == '#', 'target should start with a #');\n    var previousHash = this.ampdoc_.win.location.hash;\n    return this.push(function () {\n      _this6.ampdoc_.win.location.replace(previousHash || '#');\n    }).then(function () {\n      _this6.binding_.replaceStateForTarget(target);\n    });\n  }\n  /**\n   * Get the fragment from the url or the viewer.\n   * Strip leading '#' in the fragment\n   * @return {!Promise<string>}\n   */\n  ;\n\n  _proto.getFragment = function getFragment() {\n    return this.binding_.getFragment();\n  }\n  /**\n   * Update the page url fragment\n   * @param {string} fragment\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.updateFragment = function updateFragment(fragment) {\n    if (fragment[0] == '#') {\n      fragment = fragment.substr(1);\n    }\n\n    return this.binding_.updateFragment(fragment);\n  }\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  ;\n\n  _proto.onStateUpdated_ = function onStateUpdated_(historyState) {\n    this.stackIndex_ = historyState.stackIndex;\n    this.doPop_(historyState);\n  }\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  ;\n\n  _proto.doPop_ = function doPop_(historyState) {\n    var _this7 = this;\n\n    if (this.stackIndex_ >= this.stackOnPop_.length - 1) {\n      return;\n    }\n\n    var toPop = [];\n\n    for (var i = this.stackOnPop_.length - 1; i > this.stackIndex_; i--) {\n      if (this.stackOnPop_[i]) {\n        toPop.push(this.stackOnPop_[i]);\n        this.stackOnPop_[i] = undefined;\n      }\n    }\n\n    this.stackOnPop_.splice(this.stackIndex_ + 1);\n\n    if (toPop.length > 0) {\n      var _loop = function _loop(_i) {\n        // With the same delay timeouts must observe the order, although\n        // there's no hard requirement in this case to follow the pop order.\n        _this7.timer_.delay(function () {\n          return toPop[_i](historyState);\n        }, 1);\n      };\n\n      for (var _i = 0; _i < toPop.length; _i++) {\n        _loop(_i);\n      }\n    }\n  }\n  /**\n   * @param {function():!Promise<RESULT>} callback\n   * @param {string} name\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   * @private\n   */\n  ;\n\n  _proto.enque_ = function enque_(callback, name) {\n    var deferred = new _promise.Deferred();\n    var promise = deferred.promise,\n        resolve = deferred.resolve,\n        reject = deferred.reject; // TODO(dvoytenko, #8785): cleanup after tracing.\n\n    var trace = new Error('history trace for ' + name + ': ');\n    this.queue_.push({\n      callback: callback,\n      resolve: resolve,\n      reject: reject,\n      trace: trace\n    });\n\n    if (this.queue_.length == 1) {\n      this.deque_();\n    }\n\n    return promise;\n  }\n  /**\n   * @private\n   */\n  ;\n\n  _proto.deque_ = function deque_() {\n    var _this8 = this;\n\n    if (this.queue_.length == 0) {\n      return;\n    }\n\n    var task = this.queue_[0];\n    var promise;\n\n    try {\n      promise = task.callback();\n    } catch (e) {\n      promise = Promise.reject(e);\n    }\n\n    promise.then(function (result) {\n      task.resolve(result);\n    }, function (reason) {\n      (0, _log.dev)().error(TAG_, 'failed to execute a task:', reason); // TODO(dvoytenko, #8785): cleanup after tracing.\n\n      if (task.trace) {\n        task.trace.message += reason;\n        (0, _log.dev)().error(TAG_, task.trace);\n      }\n\n      task.reject(reason);\n    }).then(function () {\n      _this8.queue_.splice(0, 1);\n\n      _this8.deque_();\n    });\n  };\n\n  return History;\n}();\n/**\n * HistoryBindingInterface is an interface that defines an underlying technology\n * behind the {@link History}.\n * @interface\n */\n\n\nexports.History = History;\n\nvar HistoryBindingInterface =\n/*#__PURE__*/\nfunction () {\n  function HistoryBindingInterface() {}\n\n  var _proto2 = HistoryBindingInterface.prototype;\n\n  /** @protected */\n  _proto2.cleanup = function cleanup() {}\n  /**\n   * Configures a callback to be called when the state has been updated.\n   * @param {function(!HistoryStateDef)} unusedCallback\n   * @protected\n   */\n  ;\n\n  _proto2.setOnStateUpdated = function setOnStateUpdated(unusedCallback) {}\n  /**\n   * Pushes a new state onto the history stack, optionally specifying the state\n   * object associated with the current state.\n   * Returns a promise that yields the new state.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  ;\n\n  _proto2.push = function push(opt_stateUpdate) {}\n  /**\n   * Pops a previously pushed state from the history stack. All history\n   * states coming after this state will also be popped.\n   * Returns a promise that yields the new state.\n   * @param {number} unusedStackIndex\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  ;\n\n  _proto2.pop = function pop(unusedStackIndex) {}\n  /**\n   * Replaces the current state, optionally specifying updates to the state\n   * object to be associated with the replacement.\n   * Returns a promise that yields the new state.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  ;\n\n  _proto2.replace = function replace(opt_stateUpdate) {}\n  /**\n   * Retrieves the current state, containing the current fragment, title,\n   * and amp-bind state.\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  ;\n\n  _proto2.get = function get() {}\n  /**\n   * Replaces the state for local target navigation.\n   * @param {string} unusedTarget\n   */\n  ;\n\n  _proto2.replaceStateForTarget = function replaceStateForTarget(unusedTarget) {}\n  /**\n   * Get the fragment from the url or the viewer.\n   * Strip leading '#' in the fragment\n   * @return {!Promise<string>}\n   */\n  ;\n\n  _proto2.getFragment = function getFragment() {}\n  /**\n   * Update the page url fragment\n   * @param {string} unusedFragment\n   * @return {!Promise}\n   */\n  ;\n\n  _proto2.updateFragment = function updateFragment(unusedFragment) {};\n\n  return HistoryBindingInterface;\n}();\n/**\n * Implementation of HistoryBindingInterface based on the native window. It uses\n * window.history properties and events.\n *\n * Visible for testing.\n *\n * @implements {HistoryBindingInterface}\n */\n\n\nvar HistoryBindingNatural_ =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function HistoryBindingNatural_(win) {\n    var _this9 = this;\n\n    /** @const {!Window} */\n    this.win = win;\n    /** @private @const {!../service/timer-impl.Timer} */\n\n    this.timer_ = _services.Services.timerFor(win);\n    var history = this.win.history;\n    /** @private {number} */\n\n    this.startIndex_ = history.length - 1;\n    var state = (0, _history.getState)(history);\n\n    if (state && state[HISTORY_PROP_] !== undefined) {\n      this.startIndex_ = Math.min(state[HISTORY_PROP_], this.startIndex_);\n    }\n    /** @private {number} */\n\n\n    this.stackIndex_ = this.startIndex_;\n    /**\n     * @private {{promise: !Promise, resolve: !Function,\n     *   reject: !Function}|undefined}\n     */\n\n    this.waitingState_;\n    /** @private {?function(!HistoryStateDef)} */\n\n    this.onStateUpdated_ = null; // A number of browsers do not support history.state. In this cases,\n    // History will track its own version. See unsupportedState_.\n\n    /** @private {boolean} @const */\n\n    this.supportsState_ = 'state' in history;\n    /** @private {*} */\n\n    this.unsupportedState_ = this.historyState_(this.stackIndex_); // There are still browsers who do not support push/replaceState.\n\n    var pushState, replaceState;\n\n    if (history.pushState && history.replaceState) {\n      /** @private @const {function(*, string=, string=)|undefined} */\n      this.origPushState_ = history.originalPushState || history.pushState.bind(history);\n      /** @private @const {function(*, string=, string=)|undefined} */\n\n      this.origReplaceState_ = history.originalReplaceState || history.replaceState.bind(history);\n\n      pushState = function pushState(state, opt_title, opt_url) {\n        _this9.unsupportedState_ = state;\n\n        _this9.origPushState_(state, opt_title, // A bug in edge causes paths to become undefined if URL is\n        // undefined, filed here: https://goo.gl/KlImZu\n        opt_url || null);\n      };\n\n      replaceState = function replaceState(state, opt_title, opt_url) {\n        _this9.unsupportedState_ = state; // NOTE: check for `undefined` since IE11 and Edge\n        // unexpectedly coerces it into a `string`.\n\n        if (opt_url !== undefined) {\n          _this9.origReplaceState_(state, opt_title, opt_url);\n        } else {\n          _this9.origReplaceState_(state, opt_title);\n        }\n      };\n\n      if (!history.originalPushState) {\n        history.originalPushState = this.origPushState_;\n      }\n\n      if (!history.originalReplaceState) {\n        history.originalReplaceState = this.origReplaceState_;\n      }\n    } else {\n      pushState = function pushState(state, opt_title, opt_url) {\n        _this9.unsupportedState_ = state;\n      };\n\n      replaceState = function replaceState(state, opt_title, opt_url) {\n        _this9.unsupportedState_ = state;\n      };\n    }\n    /** @private @const {!Function} */\n\n\n    this.pushState_ = pushState;\n    /** @private @const {!Function} */\n\n    this.replaceState_ = replaceState;\n\n    try {\n      this.replaceState_(this.historyState_(this.stackIndex_,\n      /* replace */\n      true));\n    } catch (e) {\n      (0, _log.dev)().error(TAG_, 'Initial replaceState failed: ' + e.message);\n    }\n\n    history.pushState = this.historyPushState_.bind(this);\n    history.replaceState = this.historyReplaceState_.bind(this);\n\n    this.popstateHandler_ = function (e) {\n      var event =\n      /** @type {!PopStateEvent} */\n      e;\n      var state =\n      /** @type {!JsonObject} */\n      event.state;\n      (0, _log.dev)().fine(TAG_, 'popstate event: ' + _this9.win.history.length + ', ' + JSON.stringify(state));\n\n      _this9.onHistoryEvent_();\n    };\n\n    this.win.addEventListener('popstate', this.popstateHandler_);\n  }\n  /** @override */\n\n\n  var _proto3 = HistoryBindingNatural_.prototype;\n\n  _proto3.cleanup = function cleanup() {\n    if (this.origPushState_) {\n      this.win.history.pushState = this.origPushState_;\n    }\n\n    if (this.origReplaceState_) {\n      this.win.history.replaceState = this.origReplaceState_;\n    }\n\n    this.win.removeEventListener('popstate', this.popstateHandler_);\n  }\n  /**\n   * @param {number} stackIndex\n   * @param {boolean=} opt_replace\n   * @return {*}\n   * @private\n   */\n  ;\n\n  _proto3.historyState_ = function historyState_(stackIndex, opt_replace) {\n    var state = (0, _object.map)(opt_replace ? this.getState_() : undefined);\n    state[HISTORY_PROP_] = stackIndex;\n    return state;\n  }\n  /** @override */\n  ;\n\n  _proto3.setOnStateUpdated = function setOnStateUpdated(callback) {\n    this.onStateUpdated_ = callback;\n  }\n  /** @override */\n  ;\n\n  _proto3.push = function push(opt_stateUpdate) {\n    var _this10 = this;\n\n    return this.whenReady_(function () {\n      var newState = _this10.mergeStateUpdate_(_this10.getState_(), opt_stateUpdate || {});\n\n      _this10.historyPushState_(newState,\n      /* title */\n      undefined, newState.fragment ? '#' + newState.fragment : undefined);\n\n      return (0, _promise.tryResolve)(function () {\n        return _this10.mergeStateUpdate_(newState, {\n          stackIndex: _this10.stackIndex_\n        });\n      });\n    });\n  }\n  /** @override */\n  ;\n\n  _proto3.pop = function pop(stackIndex) {\n    var _this11 = this;\n\n    // On pop, stack is not allowed to go prior to the starting point.\n    stackIndex = Math.max(stackIndex, this.startIndex_);\n    return this.whenReady_(function () {\n      return _this11.back_(_this11.stackIndex_ - stackIndex + 1);\n    }).then(function (newStackIndex) {\n      return _this11.mergeStateUpdate_(_this11.getState_(), {\n        stackIndex: newStackIndex\n      });\n    });\n  }\n  /** @override */\n  ;\n\n  _proto3.replace = function replace(opt_stateUpdate) {\n    var _this12 = this;\n\n    if (opt_stateUpdate === void 0) {\n      opt_stateUpdate = {};\n    }\n\n    return this.whenReady_(function () {\n      var newState = _this12.mergeStateUpdate_(_this12.getState_(), opt_stateUpdate || {});\n\n      var url = (newState.url || '').replace(/#.*/, '');\n      var fragment = newState.fragment ? '#' + newState.fragment : '';\n\n      _this12.historyReplaceState_(newState, newState.title, url || fragment ? url + fragment : undefined);\n\n      return (0, _promise.tryResolve)(function () {\n        return _this12.mergeStateUpdate_(newState, {\n          stackIndex: _this12.stackIndex_\n        });\n      });\n    });\n  }\n  /** @override */\n  ;\n\n  _proto3.get = function get() {\n    var _this13 = this;\n\n    return (0, _promise.tryResolve)(function () {\n      return _this13.mergeStateUpdate_(_this13.getState_(), {\n        stackIndex: _this13.stackIndex_\n      });\n    });\n  }\n  /**\n   * @param {number} stackIndex\n   * @return {!Promise}\n   */\n  ;\n\n  _proto3.backTo = function backTo(stackIndex) {\n    var _this14 = this;\n\n    // On pop, stack is not allowed to go prior to the starting point.\n    stackIndex = Math.max(stackIndex, this.startIndex_);\n    return this.whenReady_(function () {\n      return _this14.back_(_this14.stackIndex_ - stackIndex);\n    });\n  }\n  /** @private */\n  ;\n\n  _proto3.onHistoryEvent_ = function onHistoryEvent_() {\n    var state = this.getState_();\n    (0, _log.dev)().fine(TAG_, 'history event: ' + this.win.history.length + ', ' + JSON.stringify(state));\n    var stackIndex = state ? state[HISTORY_PROP_] : undefined;\n    var newStackIndex = this.stackIndex_;\n    var waitingState = this.waitingState_;\n    this.waitingState_ = undefined;\n\n    if (newStackIndex > this.win.history.length - 2) {\n      // Make sure stack has enough space. Whether we are going forward or\n      // backward, the stack should have at least one extra cell.\n      newStackIndex = this.win.history.length - 2;\n      this.updateHistoryState_(this.mergeStateUpdate_(state, {\n        stackIndex: newStackIndex\n      }));\n    }\n\n    if (stackIndex == undefined) {\n      // A new navigation forward by the user.\n      newStackIndex = newStackIndex + 1;\n    } else if (stackIndex < this.win.history.length) {\n      // A simple trip back.\n      newStackIndex = stackIndex;\n    } else {\n      // Generally not possible, but for posterity.\n      newStackIndex = this.win.history.length - 1;\n    } // If state index has been updated as the result replace the state.\n\n\n    if (!state) {\n      state = {};\n    }\n\n    state[HISTORY_PROP_] = newStackIndex;\n    this.replaceState_(state, undefined, undefined); // Update the stack, pop squeezed states.\n\n    if (newStackIndex != this.stackIndex_) {\n      this.updateHistoryState_(this.mergeStateUpdate_(state, {\n        stackIndex: newStackIndex\n      }));\n    } // User navigation is allowed to move past the starting point of\n    // the history stack.\n\n\n    if (newStackIndex < this.startIndex_) {\n      this.startIndex_ = newStackIndex;\n    }\n\n    if (waitingState) {\n      waitingState.resolve();\n    }\n  }\n  /** @private */\n  ;\n\n  _proto3.getState_ = function getState_() {\n    if (this.supportsState_) {\n      return (0, _history.getState)(this.win.history);\n    }\n\n    return this.unsupportedState_;\n  }\n  /** @private */\n  ;\n\n  _proto3.assertReady_ = function assertReady_() {\n    (0, _log.devAssert)(!this.waitingState_, 'The history must not be in the waiting state');\n  }\n  /**\n   * @param {function():!Promise<RESULT>} callback\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   * @private\n   */\n  ;\n\n  _proto3.whenReady_ = function whenReady_(callback) {\n    if (!this.waitingState_) {\n      return callback();\n    }\n\n    return this.waitingState_.promise.then(callback, callback);\n  }\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  ;\n\n  _proto3.wait_ = function wait_() {\n    this.assertReady_();\n    var deferred = new _promise.Deferred();\n    var resolve = deferred.resolve,\n        reject = deferred.reject;\n    var promise = this.timer_.timeoutPromise(500, deferred.promise);\n    this.waitingState_ = {\n      promise: promise,\n      resolve: resolve,\n      reject: reject\n    };\n    return promise;\n  }\n  /**\n   * @param {number} steps\n   * @return {!Promise}\n   */\n  ;\n\n  _proto3.back_ = function back_(steps) {\n    var _this15 = this;\n\n    this.assertReady_();\n\n    if (steps <= 0) {\n      return Promise.resolve(this.stackIndex_);\n    }\n\n    this.unsupportedState_ = this.historyState_(this.stackIndex_ - steps);\n    var promise = this.wait_();\n    this.win.history.go(-steps);\n    return promise.then(function () {\n      return Promise.resolve(_this15.stackIndex_);\n    });\n  }\n  /**\n   * @param {*=} state\n   * @param {(string|undefined)=} title\n   * @param {(string|undefined)=} url\n   * @private\n   */\n  ;\n\n  _proto3.historyPushState_ = function historyPushState_(state, title, url) {\n    this.assertReady_();\n\n    if (!state) {\n      state = {};\n    }\n\n    var stackIndex = this.stackIndex_ + 1;\n    state[HISTORY_PROP_] = stackIndex;\n    this.pushState_(state, title, url);\n\n    if (stackIndex != this.win.history.length - 1) {\n      stackIndex = this.win.history.length - 1;\n      state[HISTORY_PROP_] = stackIndex;\n      this.replaceState_(state);\n    }\n\n    var newState = this.mergeStateUpdate_(\n    /** @type {!HistoryStateDef} */\n    state, {\n      stackIndex: stackIndex\n    });\n    this.updateHistoryState_(newState);\n  }\n  /**\n   * If this is a hash update the choice of `location.replace` vs\n   * `history.replaceState` is important. Due to bugs, not every browser\n   * triggers `:target` pseudo-class when `replaceState` is called.\n   * See http://www.zachleat.com/web/moving-target/ for more details.\n   * location.replace will trigger a `popstate` event, we temporarily\n   * disable handling it.\n   * @param {string} target\n   *\n   * @override\n   */\n  ;\n\n  _proto3.replaceStateForTarget = function replaceStateForTarget(target) {\n    var _this16 = this;\n\n    (0, _log.devAssert)(target[0] == '#', 'target should start with a #');\n    this.whenReady_(function () {\n      // location.replace will fire a popstate event which is not a history\n      // event, so temporarily remove the event listener and re-add it after.\n      // As explained above in the function comment, typically we'd just do\n      // replaceState here but in order to trigger :target re-eval we have to\n      // use location.replace.\n      _this16.win.removeEventListener('popstate', _this16.popstateHandler_);\n\n      try {\n        // TODO(mkhatib, #6095): Chrome iOS will add extra states for\n        // location.replace.\n        _this16.win.location.replace(target);\n      } finally {\n        _this16.win.addEventListener('popstate', _this16.popstateHandler_);\n      }\n\n      _this16.historyReplaceState_();\n\n      return Promise.resolve();\n    });\n  }\n  /**\n   * @param {*=} state\n   * @param {(string|undefined)=} title\n   * @param {(string|undefined)=} url\n   * @private\n   */\n  ;\n\n  _proto3.historyReplaceState_ = function historyReplaceState_(state, title, url) {\n    this.assertReady_();\n\n    if (!state) {\n      state = {};\n    }\n\n    var stackIndex = Math.min(this.stackIndex_, this.win.history.length - 1);\n    state[HISTORY_PROP_] = stackIndex;\n    this.replaceState_(state, title, url);\n    var newState = this.mergeStateUpdate_(\n    /** @type {!HistoryStateDef} */\n    state, {\n      stackIndex: stackIndex\n    });\n    this.updateHistoryState_(newState);\n  }\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  ;\n\n  _proto3.updateHistoryState_ = function updateHistoryState_(historyState) {\n    this.assertReady_();\n    historyState.stackIndex = Math.min(historyState.stackIndex, this.win.history.length - 1);\n\n    if (this.stackIndex_ != historyState.stackIndex) {\n      (0, _log.dev)().fine(TAG_, 'stack index changed: ' + this.stackIndex_ + ' -> ' + historyState.stackIndex);\n      this.stackIndex_ = historyState.stackIndex;\n\n      if (this.onStateUpdated_) {\n        this.onStateUpdated_(historyState);\n      }\n    }\n  }\n  /** @override */\n  ;\n\n  _proto3.getFragment = function getFragment() {\n    var hash = this.win.location.hash;\n    /* Strip leading '#' */\n\n    hash = hash.substr(1);\n    return Promise.resolve(hash);\n  }\n  /** @override */\n  ;\n\n  _proto3.updateFragment = function updateFragment(fragment) {\n    return this.replace({\n      fragment: fragment\n    });\n  }\n  /**\n   * @param {?HistoryStateDef} state\n   * @param {!HistoryStateUpdateDef} update\n   * @return {!HistoryStateDef}\n   */\n  ;\n\n  _proto3.mergeStateUpdate_ = function mergeStateUpdate_(state, update) {\n    var mergedData =\n    /** @type {!JsonObject} */\n    Object.assign({}, state && state.data || {}, update.data || {});\n    return (\n      /** @type {!HistoryStateDef} */\n      Object.assign({}, state || {}, update, {\n        data: mergedData\n      })\n    );\n  };\n\n  return HistoryBindingNatural_;\n}();\n/**\n * Implementation of HistoryBindingInterface that assumes a virtual history that\n * relies on viewer's \"pushHistory\", \"popHistory\" and \"historyPopped\"\n * protocol.\n *\n * Visible for testing.\n *\n * @implements {HistoryBindingInterface}\n */\n\n\nexports.HistoryBindingNatural_ = HistoryBindingNatural_;\n\nvar HistoryBindingVirtual_ =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   * @param {!./viewer-interface.ViewerInterface} viewer\n   */\n  function HistoryBindingVirtual_(win, viewer) {\n    var _this17 = this;\n\n    /** @const {!Window} */\n    this.win = win;\n    /** @private @const {!./viewer-interface.ViewerInterface} */\n\n    this.viewer_ = viewer;\n    /** @private {number} */\n\n    this.stackIndex_ = 0;\n    /** @private {?function(!HistoryStateDef)} */\n\n    this.onStateUpdated_ = null;\n    /** @private {!UnlistenDef} */\n\n    this.unlistenOnHistoryPopped_ = this.viewer_.onMessage('historyPopped', function (data) {\n      return _this17.onHistoryPopped_(data);\n    });\n  }\n  /** @override */\n\n\n  var _proto4 = HistoryBindingVirtual_.prototype;\n\n  _proto4.replaceStateForTarget = function replaceStateForTarget(target) {\n    (0, _log.devAssert)(target[0] == '#', 'target should start with a #');\n    this.win.location.replace(target);\n  }\n  /** @override */\n  ;\n\n  _proto4.cleanup = function cleanup() {\n    this.unlistenOnHistoryPopped_();\n  }\n  /** @override */\n  ;\n\n  _proto4.setOnStateUpdated = function setOnStateUpdated(callback) {\n    this.onStateUpdated_ = callback;\n  }\n  /**\n   * Gets the history state from a response. This checks if `maybeHistoryState`\n   * is a history state, and returns it if so, falling back to `fallbackState`\n   * otherwise.\n   * @param {*} maybeHistoryState\n   * @param {!HistoryStateDef} fallbackState\n   * @param {string} debugId\n   * @return {!HistoryStateDef}\n   * @private\n   */\n  ;\n\n  _proto4.toHistoryState_ = function toHistoryState_(maybeHistoryState, fallbackState, debugId) {\n    if (this.isHistoryState_(maybeHistoryState)) {\n      return (\n        /** @type {!HistoryStateDef} */\n        maybeHistoryState\n      );\n    } else {\n      (0, _log.dev)().warn(TAG_, 'Ignored unexpected \"%s\" data:', debugId, maybeHistoryState);\n    }\n\n    return fallbackState;\n  }\n  /**\n   * @param {*} maybeHistoryState\n   * @return {boolean}\n   */\n  ;\n\n  _proto4.isHistoryState_ = function isHistoryState_(maybeHistoryState) {\n    return !!maybeHistoryState && maybeHistoryState['stackIndex'] !== undefined;\n  }\n  /**\n   * `pushHistory`\n   *\n   *   Request:  {'stackIndex': string}\n   *   Response: undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  ;\n\n  _proto4.push = function push(opt_stateUpdate) {\n    var _this18 = this;\n\n    var message =\n    /** @type {!JsonObject} */\n    Object.assign({\n      'stackIndex': this.stackIndex_ + 1\n    }, opt_stateUpdate || {});\n    var push = 'pushHistory';\n    return this.viewer_.sendMessageAwaitResponse(push, message).then(function (response) {\n      var fallbackState =\n      /** @type {!HistoryStateDef} */\n      message;\n\n      var newState = _this18.toHistoryState_(response, fallbackState, push);\n\n      _this18.updateHistoryState_(newState);\n\n      return newState;\n    });\n  }\n  /**\n   * `popHistory`\n   *\n   *   Request:  {'stackIndex': string}\n   *   Response: undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  ;\n\n  _proto4.pop = function pop(stackIndex) {\n    var _this19 = this;\n\n    if (stackIndex > this.stackIndex_) {\n      return this.get();\n    }\n\n    var message = (0, _object.dict)({\n      'stackIndex': this.stackIndex_\n    });\n    var pop = 'popHistory';\n    return this.viewer_.sendMessageAwaitResponse(pop, message).then(function (response) {\n      var fallbackState =\n      /** @type {!HistoryStateDef} */\n      (0, _object.dict)({\n        'stackIndex': _this19.stackIndex_ - 1\n      });\n\n      var newState = _this19.toHistoryState_(response, fallbackState, pop);\n\n      _this19.updateHistoryState_(newState);\n\n      return newState;\n    });\n  }\n  /**\n   * `replaceHistory`\n   *\n   *   Request:   {'fragment': string}\n   *   Response:  undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  ;\n\n  _proto4.replace = function replace(opt_stateUpdate) {\n    var _this20 = this;\n\n    if (opt_stateUpdate && opt_stateUpdate.url) {\n      if (!this.viewer_.hasCapability('fullReplaceHistory')) {\n        // Full URL replacement requested, but not supported by the viewer.\n        // Don't update, and return the current state.\n        var curState =\n        /** @type {!HistoryStateDef} */\n        (0, _object.dict)({\n          'stackIndex': this.stackIndex_\n        });\n        return Promise.resolve(curState);\n      } // replace fragment, only explicit fragment param will be sent.\n\n\n      var url = opt_stateUpdate.url.replace(/#.*/, '');\n      opt_stateUpdate.url = url;\n    }\n\n    var message =\n    /** @type {!JsonObject} */\n    Object.assign({\n      'stackIndex': this.stackIndex_\n    }, opt_stateUpdate || {});\n    var replace = 'replaceHistory';\n    return this.viewer_.sendMessageAwaitResponse(replace, message,\n    /* cancelUnsent */\n    true).then(function (response) {\n      var fallbackState =\n      /** @type {!HistoryStateDef} */\n      message;\n\n      var newState = _this20.toHistoryState_(response, fallbackState, replace);\n\n      _this20.updateHistoryState_(newState);\n\n      return newState;\n    });\n  }\n  /**\n   * Note: Only returns the current `stackIndex`.\n   * @override\n   */\n  ;\n\n  _proto4.get = function get() {\n    // Not sure why this type coercion is necessary, but CC complains otherwise.\n    return Promise.resolve(\n    /** @type {!HistoryStateDef} */\n    {\n      data: undefined,\n      fragment: '',\n      stackIndex: this.stackIndex_,\n      title: ''\n    });\n  }\n  /**\n   * `historyPopped` (from viewer)\n   *\n   *   Request:  {'newStackIndex': number} | {'stackIndex': number}\n   *   Response: undefined\n   *\n   * @param {!JsonObject} data\n   * @private\n   */\n  ;\n\n  _proto4.onHistoryPopped_ = function onHistoryPopped_(data) {\n    if (data['newStackIndex'] !== undefined) {\n      data['stackIndex'] = data['newStackIndex'];\n    }\n\n    if (this.isHistoryState_(data)) {\n      this.updateHistoryState_(\n      /** @type {!HistoryStateDef} */\n      data);\n    } else {\n      (0, _log.dev)().warn(TAG_, 'Ignored unexpected \"historyPopped\" data:', data);\n    }\n  }\n  /**\n   * @param {!HistoryStateDef} state\n   * @private\n   */\n  ;\n\n  _proto4.updateHistoryState_ = function updateHistoryState_(state) {\n    var stackIndex = state.stackIndex;\n\n    if (this.stackIndex_ != stackIndex) {\n      (0, _log.dev)().fine(TAG_, \"stackIndex: \" + this.stackIndex_ + \" -> \" + stackIndex);\n      this.stackIndex_ = stackIndex;\n\n      if (this.onStateUpdated_) {\n        this.onStateUpdated_(state);\n      }\n    }\n  }\n  /**\n   * `getFragment`\n   *\n   *   Request:  undefined\n   *   Response: string\n   *\n   * @override\n   */\n  ;\n\n  _proto4.getFragment = function getFragment() {\n    if (!this.viewer_.hasCapability('fragment')) {\n      return Promise.resolve('');\n    }\n\n    return this.viewer_.sendMessageAwaitResponse('getFragment', undefined,\n    /* cancelUnsent */\n    true).then(function (data) {\n      if (!data) {\n        return '';\n      }\n\n      var hash = (0, _log.dev)().assertString(data);\n      /* Strip leading '#'*/\n\n      if (hash[0] == '#') {\n        hash = hash.substr(1);\n      }\n\n      return hash;\n    });\n  }\n  /**\n   * `replaceHistory`\n   *\n   *   Request:   {'fragment': string}\n   *   Response:  undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  ;\n\n  _proto4.updateFragment = function updateFragment(fragment) {\n    if (!this.viewer_.hasCapability('fragment')) {\n      return Promise.resolve();\n    }\n\n    return (\n      /** @type {!Promise} */\n      this.viewer_.sendMessageAwaitResponse('replaceHistory', (0, _object.dict)({\n        'fragment': fragment\n      }),\n      /* cancelUnsent */\n      true)\n    );\n  };\n\n  return HistoryBindingVirtual_;\n}();\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!History}\n * @private\n */\n\n\nexports.HistoryBindingVirtual_ = HistoryBindingVirtual_;\n\nfunction createHistory(ampdoc) {\n  var viewer = _services.Services.viewerForDoc(ampdoc);\n\n  var binding;\n\n  if (viewer.isOvertakeHistory() || (0, _mode.getMode)(ampdoc.win).test || ampdoc.win.__AMP_TEST_IFRAME) {\n    binding = new HistoryBindingVirtual_(ampdoc.win, viewer);\n  } else {\n    // Only one global \"natural\" binding is allowed since it works with the\n    // global history stack.\n    (0, _service.registerServiceBuilder)(ampdoc.win, 'global-history-binding', HistoryBindingNatural_);\n    binding = (0, _service.getService)(ampdoc.win, 'global-history-binding');\n  }\n\n  return new History(ampdoc, binding);\n}\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nfunction installHistoryServiceForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'history', createHistory);\n}\n\n},{\"../history\":55,\"../log\":68,\"../mode\":70,\"../service\":79,\"../services\":123,\"../utils/object\":145,\"../utils/promise\":147}],94:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.checkAndFix = checkAndFix;\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG = 'ie-media-bug';\n/**\n * An ugly fix for IE's problem with `matchMedia` API, where media queries\n * are evaluated incorrectly. See #2577 for more details. Returns the promise\n * that will be resolved when the bug is fixed.\n * @param {!Window} win\n * @param {!../service/platform-impl.Platform=} opt_platform\n * @return {?Promise}\n * @package\n */\n\nfunction checkAndFix(win, opt_platform) {\n  var platform = opt_platform || _services.Services.platformFor(win);\n\n  if (!platform.isIe() || matchMediaIeQuite(win)) {\n    return null;\n  } // Poll until the expression resolves correctly, but only up to a point.\n\n\n  return new Promise(function (resolve) {\n    /** @const {number} */\n    var endTime = Date.now() + 2000;\n    /** @const {number} */\n\n    var interval = win.setInterval(function () {\n      var now = Date.now();\n      var matches = matchMediaIeQuite(win);\n\n      if (matches || now > endTime) {\n        win.clearInterval(interval);\n        resolve();\n\n        if (!matches) {\n          (0, _log.dev)().error(TAG, 'IE media never resolved');\n        }\n      }\n    }, 10);\n  });\n}\n/**\n * @param {!Window} win\n * @return {boolean}\n * @private\n */\n\n\nfunction matchMediaIeQuite(win) {\n  // The expression is `min-width <= W <= max-width`.\n  // In IE `min-width: X` actually compares string `<`, thus we add -1 to\n  // `min-width` and add +1 to `max-width`. Given the expression above, it's\n  // a non-essential correction by 1px.\n  var q = \"(min-width: \" + (win.\n  /*OK*/\n  innerWidth - 1) + \"px)\" + (\" AND (max-width: \" + (win.\n  /*OK*/\n  innerWidth + 1) + \"px)\");\n\n  try {\n    return win.matchMedia(q).matches;\n  } catch (e) {\n    (0, _log.dev)().error(TAG, 'IE matchMedia failed: ', e); // Return `true` to avoid polling on a broken API.\n\n    return true;\n  }\n}\n\n},{\"../log\":68,\"../services\":123}],95:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.isLongTaskApiSupported = isLongTaskApiSupported;\nexports.JankMeter = void 0;\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\nvar _staticTemplate = require(\"../static-template\");\n\nvar _experiments = require(\"../experiments\");\n\nfunction _templateObject() {\n  var data = _taggedTemplateLiteralLoose([\"\\n      <div class=\\\"i-amphtml-jank-meter\\\"></div>\"]);\n\n  _templateObject = function _templateObject() {\n    return data;\n  };\n\n  return data;\n}\n\nfunction _taggedTemplateLiteralLoose(strings, raw) { if (!raw) { raw = strings.slice(0); } strings.raw = raw; return strings; }\n\n/** @const {number} */\nvar NTH_FRAME = 200;\n\nvar JankMeter =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function JankMeter(win) {\n    /** @private {!Window} */\n    this.win_ = win;\n    /** @private {number} */\n\n    this.badFrameCnt_ = 0;\n    /** @private {number} */\n\n    this.totalFrameCnt_ = 0;\n    /** @private {number} */\n\n    this.longTaskChild_ = 0;\n    /** @private {number} */\n\n    this.longTaskSelf_ = 0;\n    /** @private {?number} */\n\n    this.scheduledTime_ = null;\n    /** @private {?./performance-impl.Performance} */\n\n    this.perf_ = _services.Services.performanceForOrNull(win);\n    /** @private {?BatteryManager} */\n\n    this.batteryManager_ = null;\n    /** @private {?number} */\n\n    this.batteryLevelStart_ = null;\n    this.initializeBatteryManager_();\n    /** @private {?PerformanceObserver} */\n\n    this.longTaskObserver_ = null;\n    this.initializeLongTaskObserver_();\n  }\n  /**\n   * Callback for scheduled.\n   */\n\n\n  var _proto = JankMeter.prototype;\n\n  _proto.onScheduled = function onScheduled() {\n    if (!this.isEnabled_()) {\n      return;\n    } // only take the first schedule for the current frame.\n\n\n    if (this.scheduledTime_ == null) {\n      this.scheduledTime_ = this.win_.Date.now();\n    }\n  }\n  /**\n   * Callback for run.\n   */\n  ;\n\n  _proto.onRun = function onRun() {\n    if (!this.isEnabled_() || this.scheduledTime_ == null) {\n      return;\n    }\n\n    var paintLatency = this.win_.Date.now() - this.scheduledTime_;\n    this.scheduledTime_ = null;\n    this.totalFrameCnt_++;\n\n    if (paintLatency > 16) {\n      this.badFrameCnt_++;\n      (0, _log.dev)().info('JANK', 'Paint latency: ' + paintLatency + 'ms');\n    } // Report metrics on Nth frame, so we have sort of normalized numbers.\n\n\n    if (this.perf_ && this.totalFrameCnt_ == NTH_FRAME) {\n      // gfp: Good Frame Probability\n      var gfp = this.calculateGfp_();\n      this.perf_.tickDelta('gfp', gfp); // bf: Bad Frames\n\n      this.perf_.tickDelta('bf', this.badFrameCnt_);\n\n      if (this.longTaskObserver_) {\n        // lts: Long Tasks of Self frame\n        this.perf_.tickDelta('lts', this.longTaskSelf_); // ltc: Long Tasks of Child frames\n\n        this.perf_.tickDelta('ltc', this.longTaskChild_);\n        this.longTaskObserver_.disconnect();\n        this.longTaskObserver_ = null;\n      }\n\n      var batteryDrop = 0;\n\n      if (this.batteryManager_ && this.batteryLevelStart_ != null) {\n        batteryDrop = this.win_.Math.max(0, this.win_.Math.floor(this.batteryManager_.level * 100 - this.batteryLevelStart_)); // bd: Battery Drop\n\n        this.perf_.tickDelta('bd', batteryDrop);\n      }\n\n      this.perf_.flush();\n\n      if (isJankMeterEnabled(this.win_)) {\n        this.displayMeterDisplay_(batteryDrop);\n      }\n    }\n  }\n  /**\n   * Returns if is enabled\n   *\n   * @return {?boolean}\n   */\n  ;\n\n  _proto.isEnabled_ = function isEnabled_() {\n    return isJankMeterEnabled(this.win_) || this.perf_ && this.perf_.isPerformanceTrackingOn() && this.totalFrameCnt_ < NTH_FRAME;\n  }\n  /**\n   * @param {number} batteryDrop\n   * @private\n   */\n  ;\n\n  _proto.displayMeterDisplay_ = function displayMeterDisplay_(batteryDrop) {\n    var doc = this.win_.document;\n    var display = (0, _staticTemplate.htmlFor)(doc)(_templateObject());\n    display.textContent = \"bf:\" + this.badFrameCnt_ + \", lts: \" + this.longTaskSelf_ + \", \" + (\"ltc:\" + this.longTaskChild_ + \", bd:\" + batteryDrop);\n    doc.body.appendChild(display);\n  }\n  /**\n   * Calculate Good Frame Probability, which is a value range from 0 to 100.\n   * @return {number}\n   * @private\n   */\n  ;\n\n  _proto.calculateGfp_ = function calculateGfp_() {\n    return this.win_.Math.floor((this.totalFrameCnt_ - this.badFrameCnt_) / this.totalFrameCnt_ * 100);\n  }\n  /**\n   * Initializes long task observer.\n   */\n  ;\n\n  _proto.initializeLongTaskObserver_ = function initializeLongTaskObserver_() {\n    var _this = this;\n\n    if (!this.isEnabled_() || !isLongTaskApiSupported(this.win_)) {\n      return;\n    }\n\n    this.longTaskObserver_ = new this.win_.PerformanceObserver(function (entryList) {\n      var entries = entryList.getEntries();\n\n      for (var i = 0; i < entries.length; i++) {\n        if (entries[i].entryType == 'longtask') {\n          // longtask is any task with duration of bigger than 50ms\n          // we sum up the number of 50ms a task spans.\n          var span = _this.win_.Math.floor(entries[i].duration / 50);\n\n          if (entries[i].name == 'cross-origin-descendant') {\n            _this.longTaskChild_ += span;\n            (0, _log.user)().info('LONGTASK', \"from child frame \" + entries[i].duration + \"ms\");\n          } else {\n            _this.longTaskSelf_ += span;\n            (0, _log.dev)().info('LONGTASK', \"from self frame \" + entries[i].duration + \"ms\");\n          }\n        }\n      }\n    });\n    this.longTaskObserver_.observe({\n      entryTypes: ['longtask']\n    });\n  }\n  /**\n   * Initializes battery manager.\n   */\n  ;\n\n  _proto.initializeBatteryManager_ = function initializeBatteryManager_() {\n    var _this2 = this;\n\n    if (isBatteryApiSupported(this.win_)) {\n      this.win_.navigator.getBattery().then(function (battery) {\n        _this2.batteryManager_ = battery;\n        _this2.batteryLevelStart_ = battery.level * 100;\n      });\n    }\n  };\n\n  return JankMeter;\n}();\n/**\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nexports.JankMeter = JankMeter;\n\nfunction isJankMeterEnabled(win) {\n  return (0, _experiments.isExperimentOn)(win, 'jank-meter');\n}\n/**\n * @param {!Window} win\n * @return {boolean}\n */\n\n\nfunction isLongTaskApiSupported(win) {\n  return !!win.PerformanceObserver && !!win['TaskAttributionTiming'] && 'containerName' in win['TaskAttributionTiming'].prototype;\n}\n/**\n * @param {!Window} unusedWin\n * @return {boolean}\n */\n\n\nfunction isBatteryApiSupported(unusedWin) {\n  // TODO: (@lannka, #9749)\n  return false;\n}\n\n},{\"../experiments\":47,\"../log\":68,\"../services\":123,\"../static-template\":125}],96:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.MutatorInterface = void 0;\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* eslint-disable no-unused-vars */\n\n/**\n * @interface\n */\nvar MutatorInterface =\n/*#__PURE__*/\nfunction () {\n  function MutatorInterface() {}\n\n  var _proto = MutatorInterface.prototype;\n\n  /**\n   * Requests the runtime to change the element's size. When the size is\n   * successfully updated then the opt_callback is called.\n   * @param {!Element} element\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {function()=} opt_callback A callback function.\n   * @param {!../layout-rect.LayoutMarginsChangeDef=} opt_newMargins\n   */\n  _proto.changeSize = function changeSize(element, newHeight, newWidth, opt_callback, opt_newMargins) {}\n  /**\n   * Return a promise that requests the runtime to update the size of\n   * this element to the specified value.\n   * The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeSize}, the runtime\n   * may refuse to make a change in which case it will reject promise, call the\n   * `overflowCallback` method on the target resource with the height value.\n   * Overflow callback is expected to provide the reader with the user action\n   * to update the height manually.\n   * Note that the runtime does not call the `overflowCallback` method if the\n   * requested height is 0 or negative.\n   * If the height is successfully updated then the promise is resolved.\n   * @param {!Element} element\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef=} opt_newMargins\n   * @return {!Promise}\n   * @param {?Event=} opt_event\n   */\n  ;\n\n  _proto.attemptChangeSize = function attemptChangeSize(element, newHeight, newWidth, opt_newMargins, opt_event) {}\n  /**\n   * Expands the element.\n   * @param {!Element} element\n   */\n  ;\n\n  _proto.expandElement = function expandElement(element) {}\n  /**\n   * Return a promise that requests runtime to collapse this element.\n   * The runtime will schedule this request and first attempt to resize\n   * the element to height and width 0. If success runtime will set element\n   * display to none, and notify element owner of this collapse.\n   * @param {!Element} element\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.attemptCollapse = function attemptCollapse(element) {}\n  /**\n   * Collapses the element: ensures that it's `display:none`, notifies its\n   * owner and updates the layout box.\n   * @param {!Element} element\n   */\n  ;\n\n  _proto.collapseElement = function collapseElement(element) {}\n  /**\n   * Runs the specified measure, which is called in the \"measure\" vsync phase.\n   * This is simply a proxy to the privileged vsync service.\n   *\n   * @param {function()} measurer\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.measureElement = function measureElement(measurer) {}\n  /**\n   * Runs the specified mutation on the element and ensures that remeasures and\n   * layouts performed for the affected elements.\n   *\n   * This method should be called whenever a significant mutations are done\n   * on the DOM that could affect layout of elements inside this subtree or\n   * its siblings. The top-most affected element should be specified as the\n   * first argument to this method and all the mutation work should be done\n   * in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {!Element} element\n   * @param {function()} mutator\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.mutateElement = function mutateElement(element, mutator) {}\n  /**\n   * Runs the specified mutation on the element and ensures that remeasures and\n   * layouts performed for the affected elements.\n   *\n   * This method should be called whenever a significant mutations are done\n   * on the DOM that could affect layout of elements inside this subtree or\n   * its siblings. The top-most affected element should be specified as the\n   * first argument to this method and all the mutation work should be done\n   * in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {!Element} element\n   * @param {?function()} measurer\n   * @param {function()} mutator\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.measureMutateElement = function measureMutateElement(element, measurer, mutator) {};\n\n  return MutatorInterface;\n}();\n/* eslint-enable no-unused-vars */\n\n\nexports.MutatorInterface = MutatorInterface;\n\n},{}],97:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installGlobalNavigationHandlerForDoc = installGlobalNavigationHandlerForDoc;\nexports.maybeExpandUrlParamsForTesting = maybeExpandUrlParamsForTesting;\nexports.Navigation = exports.Priority = void 0;\n\nvar _services = require(\"../services\");\n\nvar _dom = require(\"../dom\");\n\nvar _log = require(\"../log\");\n\nvar _object = require(\"../utils/object\");\n\nvar _css = require(\"../css\");\n\nvar _impression = require(\"../impression\");\n\nvar _mode = require(\"../mode\");\n\nvar _service = require(\"../service\");\n\nvar _types = require(\"../types\");\n\nvar _priorityQueue = _interopRequireDefault(require(\"../utils/priority-queue\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG = 'navigation';\n/** @private @const {string} */\n\nvar EVENT_TYPE_CLICK = 'click';\n/** @private @const {string} */\n\nvar EVENT_TYPE_CONTEXT_MENU = 'contextmenu';\nvar VALID_TARGETS = ['_top', '_blank'];\n/** @private @const {string} */\n\nvar ORIG_HREF_ATTRIBUTE = 'data-a4a-orig-href';\n/**\n * Key used for retargeting event target originating from shadow DOM.\n * @const {string}\n */\n\nvar AMP_CUSTOM_LINKER_TARGET = '__AMP_CUSTOM_LINKER_TARGET__';\n/**\n * @enum {number} Priority reserved for extensions in anchor mutations.\n * The higher the priority, the sooner it's invoked.\n */\n\nvar Priority = {\n  LINK_REWRITER_MANAGER: 0,\n  ANALYTICS_LINKER: 2\n};\n/**\n * Install navigation service for ampdoc, which handles navigations from anchor\n * tag clicks and other runtime features like AMP.navigateTo().\n *\n * Immediately instantiates the service.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\nexports.Priority = Priority;\n\nfunction installGlobalNavigationHandlerForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, TAG, Navigation,\n  /* opt_instantiate */\n  true);\n}\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Event} e\n * @visibleForTesting\n */\n\n\nfunction maybeExpandUrlParamsForTesting(ampdoc, e) {\n  maybeExpandUrlParams(ampdoc, e);\n}\n/**\n * Intercept any click on the current document and prevent any\n * linking to an identifier from pushing into the history stack.\n * @implements {../service.EmbeddableService}\n * @visibleForTesting\n */\n\n\nvar Navigation =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_rootNode\n   */\n  function Navigation(ampdoc, opt_rootNode) {\n    var _this = this;\n\n    // TODO(#22733): remove subroooting once ampdoc-fie is launched.\n\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @private @const {!Document|!ShadowRoot} */\n\n    this.rootNode_ = opt_rootNode || ampdoc.getRootNode();\n    /** @private @const {!./viewport/viewport-interface.ViewportInterface} */\n\n    this.viewport_ = _services.Services.viewportForDoc(this.ampdoc);\n    /** @private @const {!./viewer-interface.ViewerInterface} */\n\n    this.viewer_ = _services.Services.viewerForDoc(this.ampdoc);\n    /** @private @const {!./history-impl.History} */\n\n    this.history_ = _services.Services.historyForDoc(this.ampdoc);\n    /** @private @const {!./platform-impl.Platform} */\n\n    this.platform_ = _services.Services.platformFor(this.ampdoc.win);\n    /** @private @const {boolean} */\n\n    this.isIosSafari_ = this.platform_.isIos() && this.platform_.isSafari();\n    /** @private @const {boolean} */\n\n    this.isIframed_ = (0, _dom.isIframed)(this.ampdoc.win) && this.viewer_.isOvertakeHistory();\n    /** @private @const {boolean} */\n\n    this.isEmbed_ = this.rootNode_ != this.ampdoc.getRootNode() || !!this.ampdoc.getParent();\n    /** @private @const {boolean} */\n\n    this.isInABox_ = (0, _mode.getMode)(this.ampdoc.win).runtime == 'inabox';\n    /**\n     * Must use URL parsing scoped to `rootNode_` for correct FIE behavior.\n     * @private @const {!Element|!ShadowRoot}\n     */\n\n    this.serviceContext_ =\n    /** @type {!Element|!ShadowRoot} */\n    this.rootNode_.nodeType == Node.DOCUMENT_NODE ? this.rootNode_.documentElement : this.rootNode_;\n    /** @private @const {!function(!Event)|undefined} */\n\n    this.boundHandle_ = this.handle_.bind(this);\n    this.rootNode_.addEventListener(EVENT_TYPE_CLICK, this.boundHandle_);\n    this.rootNode_.addEventListener(EVENT_TYPE_CONTEXT_MENU, this.boundHandle_);\n    /** @private {boolean} */\n\n    this.appendExtraParams_ = false;\n    (0, _impression.shouldAppendExtraParams)(this.ampdoc).then(function (res) {\n      _this.appendExtraParams_ = res;\n    });\n    /**\n     * Lazy-generated list of A2A-enabled navigation features.\n     * @private {?Array<string>}\n     */\n\n    this.a2aFeatures_ = null;\n    /**\n     * @type {!PriorityQueue<function(!Element, !Event)>}\n     * @private\n     * @const\n     */\n\n    this.anchorMutators_ = new _priorityQueue.default();\n    /**\n     * @type {!PriorityQueue<function(string)>}\n     * @private\n     * @const\n     */\n\n    this.navigateToMutators_ = new _priorityQueue.default();\n  }\n  /**\n   * Registers a handler that performs URL replacement on the href\n   * of an ad click.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Window} win\n   */\n\n\n  Navigation.installAnchorClickInterceptor = function installAnchorClickInterceptor(ampdoc, win) {\n    win.document.documentElement.addEventListener('click', maybeExpandUrlParams.bind(null, ampdoc),\n    /* capture */\n    true);\n  }\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n  ;\n\n  Navigation.installInEmbedWindow = function installInEmbedWindow(embedWin, ampdoc) {\n    (0, _service.installServiceInEmbedScope)(embedWin, TAG, new Navigation(ampdoc, embedWin.document));\n  }\n  /**\n   * Removes all event listeners.\n   */\n  ;\n\n  var _proto = Navigation.prototype;\n\n  _proto.cleanup = function cleanup() {\n    if (this.boundHandle_) {\n      this.rootNode_.removeEventListener(EVENT_TYPE_CLICK, this.boundHandle_);\n      this.rootNode_.removeEventListener(EVENT_TYPE_CONTEXT_MENU, this.boundHandle_);\n    }\n  }\n  /**\n   * Opens a new window with the specified target.\n   *\n   * @param {!Window} win A window to use to open a new window.\n   * @param {string} url THe URL to open.\n   * @param {string} target The target for the newly opened window.\n   * @param {boolean} opener Whether or not the new window should have acccess\n   *   to the opener (win).\n   */\n  ;\n\n  _proto.openWindow = function openWindow(win, url, target, opener) {\n    var options = ''; // We don't pass noopener for Chrome since it opens a new window without\n    // tabs. Instead, we remove the opener property from the newly opened\n    // window.\n    // Note: for Safari, we need to use noopener instead of clearing the opener\n    // property.\n\n    if ((this.platform_.isIos() || !this.platform_.isChrome()) && !opener) {\n      options += 'noopener';\n    }\n\n    var newWin = (0, _dom.openWindowDialog)(win, url, target, options); // For Chrome, since we cannot use noopener.\n\n    if (newWin && !opener) {\n      newWin.opener = null;\n    }\n  }\n  /**\n   * Navigates a window to a URL.\n   *\n   * If opt_requestedBy matches a feature name in a <meta> tag with attribute\n   * name=\"amp-to-amp-navigation\", then treats the URL as an AMP URL (A2A).\n   *\n   * @param {!Window} win\n   * @param {string} url\n   * @param {string=} opt_requestedBy\n   * @param {!{\n   *   target: (string|undefined),\n   *   opener: (boolean|undefined),\n   * }=} opt_options\n   */\n  ;\n\n  _proto.navigateTo = function navigateTo(win, url, opt_requestedBy, _temp) {\n    var _ref = _temp === void 0 ? {} : _temp,\n        _ref$target = _ref.target,\n        target = _ref$target === void 0 ? '_top' : _ref$target,\n        _ref$opener = _ref.opener,\n        opener = _ref$opener === void 0 ? false : _ref$opener;\n\n    url = this.applyNavigateToMutators_(url);\n\n    var urlService = _services.Services.urlForDoc(this.serviceContext_);\n\n    if (!urlService.isProtocolValid(url)) {\n      (0, _log.user)().error(TAG, 'Cannot navigate to invalid protocol: ' + url);\n      return;\n    }\n\n    (0, _log.userAssert)(VALID_TARGETS.includes(target), \"Target '\" + target + \"' not supported.\"); // Resolve navigateTos relative to the source URL, not the proxy URL.\n\n    url = urlService.getSourceUrl(url); // If we have a target of \"_blank\", we will want to open a new window. A\n    // target of \"_top\" should behave like it would on an anchor tag and\n    // update the URL.\n\n    if (target == '_blank') {\n      this.openWindow(win, url, target, opener);\n      return;\n    } // If this redirect was requested by a feature that opted into A2A,\n    // try to ask the viewer to navigate this AMP URL.\n\n\n    if (opt_requestedBy) {\n      if (!this.a2aFeatures_) {\n        this.a2aFeatures_ = this.queryA2AFeatures_();\n      }\n\n      if (this.a2aFeatures_.includes(opt_requestedBy)) {\n        if (this.navigateToAmpUrl(url, opt_requestedBy)) {\n          return;\n        }\n      }\n    } // Otherwise, perform normal behavior of navigating the top frame.\n\n\n    win.top.location.href = url;\n  }\n  /**\n   * Requests A2A navigation to the given destination. If the viewer does\n   * not support this operation, does nothing.\n   * The URL is assumed to be in AMP Cache format already.\n   * @param {string} url An AMP article URL.\n   * @param {string} requestedBy Informational string about the entity that\n   *     requested the navigation.\n   * @return {boolean} Returns true if navigation message was sent to viewer.\n   *     Otherwise, returns false.\n   */\n  ;\n\n  _proto.navigateToAmpUrl = function navigateToAmpUrl(url, requestedBy) {\n    if (this.viewer_.hasCapability('a2a')) {\n      this.viewer_.sendMessage('a2aNavigate', (0, _object.dict)({\n        'url': url,\n        'requestedBy': requestedBy\n      }));\n      return true;\n    }\n\n    return false;\n  }\n  /**\n   * @return {!Array<string>}\n   * @private\n   */\n  ;\n\n  _proto.queryA2AFeatures_ = function queryA2AFeatures_() {\n    var meta = this.rootNode_.querySelector('meta[name=\"amp-to-amp-navigation\"]');\n\n    if (meta && meta.hasAttribute('content')) {\n      return meta.getAttribute('content').split(',').map(function (s) {\n        return s.trim();\n      });\n    }\n\n    return [];\n  }\n  /**\n   * Intercept any click on the current document and prevent any\n   * linking to an identifier from pushing into the history stack.\n   *\n   * This also handles custom protocols (e.g. whatsapp://) when iframed\n   * on iOS Safari.\n   *\n   * @param {!Event} e\n   * @private\n   */\n  ;\n\n  _proto.handle_ = function handle_(e) {\n    if (e.defaultPrevented) {\n      return;\n    }\n\n    var element = (0, _log.dev)().assertElement(e[AMP_CUSTOM_LINKER_TARGET] || e.target);\n    var target = (0, _dom.closestAncestorElementBySelector)(element, 'A');\n\n    if (!target || !target.href) {\n      return;\n    }\n\n    if (e.type == EVENT_TYPE_CLICK) {\n      this.handleClick_(target, e);\n    } else if (e.type == EVENT_TYPE_CONTEXT_MENU) {\n      this.handleContextMenuClick_(target, e);\n    }\n  }\n  /**\n   * @param {!Element} target\n   * @param {!Event} e\n   * @private\n   */\n  ;\n\n  _proto.handleClick_ = function handleClick_(target, e) {\n    this.expandVarsForAnchor_(target);\n    var tgtLoc = this.parseUrl_(target.href); // Handle AMP-to-AMP navigation if rel=amphtml.\n\n    if (this.handleA2AClick_(e, target, tgtLoc)) {\n      return;\n    } // Handle navigating to custom protocol if applicable.\n\n\n    if (this.handleCustomProtocolClick_(e, target, tgtLoc)) {\n      return;\n    } // In test mode, we're not able to properly fix the anchor tag's base URL.\n    // So, we have to use the (mocked) window's location instead.\n\n\n    var baseHref = (0, _mode.getMode)().test && !this.isEmbed_ ? this.ampdoc.win.location.href : '';\n    var curLoc = this.parseUrl_(baseHref);\n    var tgtHref = getHref(tgtLoc);\n    var curHref = getHref(curLoc);\n\n    if (tgtHref != curHref) {\n      // Only apply anchor mutator if this is an external navigation\n      this.applyAnchorMutators_(target, e);\n      tgtLoc = this.parseUrl_(target.href);\n    } // Finally, handle normal click-navigation behavior.\n\n\n    this.handleNavClick_(e, target, tgtLoc, curLoc);\n  }\n  /**\n   * @param {!Element} target\n   * @param {!Event} e\n   * @private\n   */\n  ;\n\n  _proto.handleContextMenuClick_ = function handleContextMenuClick_(target, e) {\n    // Handles contextmenu click. Note that currently this only deals\n    // with url variable substitution and expansion, as there is\n    // straightforward way of determining what the user clicked in the\n    // context menu, required for A2A navigation and custom link protocol\n    // handling.\n    // TODO(alabiaga): investigate fix for handling A2A and custom link\n    // protocols.\n    this.expandVarsForAnchor_(target);\n    this.applyAnchorMutators_(target, e);\n  }\n  /**\n   * Apply anchor transformations.\n   * @param {!Element} target\n   * @param {!Event} e\n   */\n  ;\n\n  _proto.applyAnchorMutators_ = function applyAnchorMutators_(target, e) {\n    this.anchorMutators_.forEach(function (anchorMutator) {\n      anchorMutator(target, e);\n    });\n  }\n  /**\n   * Apply URL transformations for AMP.navigateTo.\n   * @param {string} url\n   * @return {string}\n   */\n  ;\n\n  _proto.applyNavigateToMutators_ = function applyNavigateToMutators_(url) {\n    this.navigateToMutators_.forEach(function (mutator) {\n      url = mutator(url);\n    });\n    return url;\n  }\n  /**\n   * @param {!Element} el\n   * @private\n   */\n  ;\n\n  _proto.expandVarsForAnchor_ = function expandVarsForAnchor_(el) {\n    // First check if need to handle external link decoration.\n    var defaultExpandParamsUrl = null;\n\n    if (this.appendExtraParams_ && !this.isEmbed_) {\n      // Only decorate outgoing link when needed to and is not in FIE.\n      defaultExpandParamsUrl = (0, _impression.getExtraParamsUrl)(this.ampdoc.win, el);\n    }\n\n    var urlReplacements = _services.Services.urlReplacementsForDoc(el);\n\n    urlReplacements.maybeExpandLink(el, defaultExpandParamsUrl);\n  }\n  /**\n   * Handles clicking on a custom protocol link.\n   * Returns true if the navigation was handled. Otherwise, returns false.\n   * @param {!Event} e\n   * @param {!Element} target\n   * @param {!Location} location\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.handleCustomProtocolClick_ = function handleCustomProtocolClick_(e, target, location) {\n    // Handle custom protocols only if the document is iframed.\n    if (!this.isIframed_) {\n      return false;\n    }\n    /** @const {!Window} */\n\n\n    var win = (0, _types.toWin)(target.ownerDocument.defaultView);\n    var url = target.href;\n    var protocol = location.protocol; // On Safari iOS, custom protocol links will fail to open apps when the\n    // document is iframed - in order to go around this, we set the top.location\n    // to the custom protocol href.\n\n    var isFTP = protocol == 'ftp:'; // In case of FTP Links in embedded documents always open then in _blank.\n\n    if (isFTP) {\n      (0, _dom.openWindowDialog)(win, url, '_blank');\n      e.preventDefault();\n      return true;\n    }\n\n    var isNormalProtocol = /^(https?|mailto):$/.test(protocol);\n\n    if (this.isIosSafari_ && !isNormalProtocol) {\n      (0, _dom.openWindowDialog)(win, url, '_top'); // Without preventing default the page would should an alert error twice\n      // in the case where there's no app to handle the custom protocol.\n\n      e.preventDefault();\n      return true;\n    }\n\n    return false;\n  }\n  /**\n   * Handles clicking on an AMP link.\n   * Returns true if the navigation was handled. Otherwise, returns false.\n   * @param {!Event} e\n   * @param {!Element} target\n   * @param {!Location} location\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.handleA2AClick_ = function handleA2AClick_(e, target, location) {\n    if (!target.hasAttribute('rel')) {\n      return false;\n    }\n\n    var relations = target.getAttribute('rel').split(' ').map(function (s) {\n      return s.trim();\n    });\n\n    if (!relations.includes('amphtml')) {\n      return false;\n    } // The viewer may not support the capability for navigating AMP links.\n\n\n    if (this.navigateToAmpUrl(location.href, '<a rel=amphtml>')) {\n      e.preventDefault();\n      return true;\n    }\n\n    return false;\n  }\n  /**\n   * Handles clicking on a link with hash navigation.\n   * @param {!Event} e\n   * @param {!Element} target\n   * @param {!Location} tgtLoc\n   * @param {!Location} curLoc\n   * @private\n   */\n  ;\n\n  _proto.handleNavClick_ = function handleNavClick_(e, target, tgtLoc, curLoc) {\n    var tgtHref = getHref(tgtLoc);\n    var curHref = getHref(curLoc); // If the current target anchor link is the same origin + path\n    // as the current document then we know we are just linking to an\n    // identifier in the document. Otherwise, it's an external navigation.\n\n    if (!tgtLoc.hash || tgtHref != curHref) {\n      if (this.isEmbed_ || this.isInABox_) {\n        // Target in the embed must be either _top or _blank. If none specified,\n        // force to _blank.\n        var targetAttr = (target.getAttribute('target') || '').toLowerCase();\n\n        if (targetAttr != '_top' && targetAttr != '_blank') {\n          target.setAttribute('target', '_blank');\n        }\n\n        return; // bail early.\n      } // Accessibility fix for IE browser.\n      // Issue: anchor navigation in IE changes visual focus of the browser\n      // and shifts to the element being linked to,\n      // where the input focus stays where it was.\n      // @see https://humanwhocodes.com/blog/2013/01/15/fixing-skip-to-content-links/\n      // @see https://github.com/ampproject/amphtml/issues/18671\n\n\n      if (_services.Services.platformFor(this.ampdoc.win).isIe()) {\n        var internalTargetElmId = tgtLoc.hash.substring(1);\n        var internalElm = this.ampdoc.getElementById(internalTargetElmId);\n\n        if (internalElm) {\n          if (!/^(?:a|select|input|button|textarea)$/i.test(internalElm.tagName)) {\n            internalElm.tabIndex = -1;\n          }\n\n          (0, _dom.tryFocus)(internalElm);\n        }\n      }\n\n      return;\n    }\n\n    this.handleInternalNavigation_(e, tgtLoc, curLoc);\n  }\n  /**\n   * Handles clicking on an internal link\n   * @param {!Event} e\n   * @param {!Location} tgtLoc\n   * @param {!Location} curLoc\n   * @private\n   */\n  ;\n\n  _proto.handleInternalNavigation_ = function handleInternalNavigation_(e, tgtLoc, curLoc) {\n    var _this2 = this;\n\n    // We prevent default so that the current click does not push\n    // into the history stack as this messes up the external documents\n    // history which contains the amp document.\n    e.preventDefault(); // For an embed, do not perform scrolling or global history push - both have\n    // significant UX and browser problems.\n\n    if (this.isEmbed_) {\n      return;\n    } // Look for the referenced element.\n\n\n    var hash = tgtLoc.hash.slice(1);\n    var elem = null;\n\n    if (hash) {\n      var escapedHash = (0, _css.escapeCssSelectorIdent)(hash);\n      elem = this.rootNode_.getElementById(hash) || // Fallback to anchor[name] if element with id is not found.\n      // Linking to an anchor element with name is obsolete in html5.\n      this.rootNode_.\n      /*OK*/\n      querySelector(\"a[name=\\\"\" + escapedHash + \"\\\"]\");\n    } // If possible do update the URL with the hash. As explained above\n    // we do `replace` to avoid messing with the container's history.\n\n\n    if (tgtLoc.hash != curLoc.hash) {\n      this.history_.replaceStateForTarget(tgtLoc.hash).then(function () {\n        _this2.scrollToElement_(elem, hash);\n      });\n    } else {\n      // If the hash did not update just scroll to the element.\n      this.scrollToElement_(elem, hash);\n    }\n  }\n  /**\n   * @param {function(!Element, !Event)} callback\n   * @param {number} priority\n   */\n  ;\n\n  _proto.registerAnchorMutator = function registerAnchorMutator(callback, priority) {\n    this.anchorMutators_.enqueue(callback, priority);\n  }\n  /**\n   * @param {function(string)} callback\n   * @param {number} priority\n   */\n  ;\n\n  _proto.registerNavigateToMutator = function registerNavigateToMutator(callback, priority) {\n    this.navigateToMutators_.enqueue(callback, priority);\n  }\n  /**\n   * Scrolls the page to the given element.\n   * @param {?Element} elem\n   * @param {string} hash\n   * @private\n   */\n  ;\n\n  _proto.scrollToElement_ = function scrollToElement_(elem, hash) {\n    var _this3 = this;\n\n    // Scroll to the element if found.\n    if (elem) {\n      // The first call to scrollIntoView overrides browsers' default scrolling\n      // behavior. The second call insides setTimeout allows us to scroll to\n      // that element properly. Without doing this, the viewport will not catch\n      // the updated scroll position on iOS Safari and hence calculate the wrong\n      // scrollTop for the scrollbar jumping the user back to the top for\n      // failing to calculate the new jumped offset. Without the first call\n      // there will be a visual jump due to browser scroll. See\n      // https://github.com/ampproject/amphtml/issues/5334 for more details.\n      this.viewport_.\n      /*OK*/\n      scrollIntoView(elem);\n\n      _services.Services.timerFor(this.ampdoc.win).delay(function () {\n        return _this3.viewport_.\n        /*OK*/\n        scrollIntoView((0, _log.dev)().assertElement(elem));\n      }, 1);\n    } else {\n      (0, _log.dev)().warn(TAG, \"failed to find element with id=\" + hash + \" or a[name=\" + hash + \"]\");\n    }\n  }\n  /**\n   * @param {string} url\n   * @return {!Location}\n   * @private\n   */\n  ;\n\n  _proto.parseUrl_ = function parseUrl_(url) {\n    return _services.Services.urlForDoc(this.serviceContext_).parse(url);\n  };\n\n  return Navigation;\n}();\n/**\n * Handle click on links and replace variables in the click URL.\n * The function changes the actual href value and stores the\n * template in the ORIGINAL_HREF_ATTRIBUTE attribute\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Event} e\n */\n\n\nexports.Navigation = Navigation;\n\nfunction maybeExpandUrlParams(ampdoc, e) {\n  var target = (0, _dom.closestAncestorElementBySelector)((0, _log.dev)().assertElement(e.target), 'A');\n\n  if (!target || !target.href) {\n    // Not a click on a link.\n    return;\n  }\n\n  var hrefToExpand = target.getAttribute(ORIG_HREF_ATTRIBUTE) || target.getAttribute('href');\n\n  if (!hrefToExpand) {\n    return;\n  }\n\n  var vars = {\n    'CLICK_X': function CLICK_X() {\n      return e.pageX;\n    },\n    'CLICK_Y': function CLICK_Y() {\n      return e.pageY;\n    }\n  };\n\n  var newHref = _services.Services.urlReplacementsForDoc(target).expandUrlSync(hrefToExpand, vars, undefined,\n  /* opt_whitelist */\n  {\n    // For now we only allow to replace the click location vars\n    // and nothing else.\n    // NOTE: Addition to this whitelist requires additional review.\n    'CLICK_X': true,\n    'CLICK_Y': true\n  });\n\n  if (newHref != hrefToExpand) {\n    // Store original value so that later clicks can be processed with\n    // freshest values.\n    if (!target.getAttribute(ORIG_HREF_ATTRIBUTE)) {\n      target.setAttribute(ORIG_HREF_ATTRIBUTE, hrefToExpand);\n    }\n\n    target.setAttribute('href', newHref);\n  }\n}\n/**\n * Calculate and return the href from the Location\n * @param {!Location} location\n * @return {string}\n */\n\n\nfunction getHref(location) {\n  return \"\" + location.origin + location.pathname + location.search;\n}\n\n},{\"../css\":36,\"../dom\":41,\"../impression\":58,\"../log\":68,\"../mode\":70,\"../service\":79,\"../services\":123,\"../types\":131,\"../utils/object\":145,\"../utils/priority-queue\":146}],98:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installOwnersServiceForDoc = installOwnersServiceForDoc;\nexports.OwnersImpl = void 0;\n\nvar _ownersInterface = require(\"./owners-interface\");\n\nvar _resource = require(\"./resource\");\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\nvar _types = require(\"../types\");\n\nvar _service = require(\"../service\");\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n// TODO(powerivq)\n// Resource.setOwner, Resource.getOwner should be moved here.\n// ResourceState.NOT_BUILT might not be needed here.\n\n/**\n * @param {!Element|!Array<!Element>} elements\n * @return {!Array<!Element>}\n */\nfunction elements(elements) {\n  return (\n    /** @type {!Array<!Element>} */\n    (0, _types.isArray)(elements) ? elements : [elements]\n  );\n}\n/**\n * @implements {OwnersInterface}\n * @visibleForTesting\n */\n\n\nvar OwnersImpl =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  function OwnersImpl(ampdoc) {\n    /** @const @private {!./resources-interface.ResourcesInterface} */\n    this.resources_ = _services.Services.resourcesForDoc(ampdoc);\n  }\n  /** @override */\n\n\n  var _proto = OwnersImpl.prototype;\n\n  _proto.setOwner = function setOwner(element, owner) {\n    _resource.Resource.setOwner(element, owner);\n  }\n  /** @override */\n  ;\n\n  _proto.schedulePreload = function schedulePreload(parentElement, subElements) {\n    this.scheduleLayoutOrPreloadForSubresources_(this.resources_.getResourceForElement(parentElement),\n    /* layout */\n    false, elements(subElements));\n  }\n  /** @override */\n  ;\n\n  _proto.scheduleLayout = function scheduleLayout(parentElement, subElements) {\n    this.scheduleLayoutOrPreloadForSubresources_(this.resources_.getResourceForElement(parentElement),\n    /* layout */\n    true, elements(subElements));\n  }\n  /** @override */\n  ;\n\n  _proto.schedulePause = function schedulePause(parentElement, subElements) {\n    var parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n    this.findResourcesInElements_(parentResource, subElements, function (resource) {\n      resource.pause();\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.scheduleResume = function scheduleResume(parentElement, subElements) {\n    var parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n    this.findResourcesInElements_(parentResource, subElements, function (resource) {\n      resource.resume();\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.scheduleUnlayout = function scheduleUnlayout(parentElement, subElements) {\n    var parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n    this.findResourcesInElements_(parentResource, subElements, function (resource) {\n      resource.unlayout();\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.updateInViewport = function updateInViewport(parentElement, subElements, inLocalViewport) {\n    this.updateInViewportForSubresources_(this.resources_.getResourceForElement(parentElement), elements(subElements), inLocalViewport);\n  }\n  /** @override */\n  ;\n\n  _proto.requireLayout = function requireLayout(element, opt_parentPriority) {\n    var _this = this;\n\n    var promises = [];\n    this.discoverResourcesForElement_(element, function (resource) {\n      if (resource.getState() == _resource.ResourceState.LAYOUT_COMPLETE) {\n        return;\n      }\n\n      if (resource.getState() != _resource.ResourceState.LAYOUT_SCHEDULED) {\n        promises.push(resource.whenBuilt().then(function () {\n          resource.measure();\n\n          if (!resource.isDisplayed()) {\n            return;\n          }\n\n          _this.resources_.scheduleLayoutOrPreload(resource,\n          /* layout */\n          true, opt_parentPriority,\n          /* forceOutsideViewport */\n          true);\n\n          return resource.loadedOnce();\n        }));\n      } else if (resource.isDisplayed()) {\n        promises.push(resource.loadedOnce());\n      }\n    });\n    return Promise.all(promises);\n  }\n  /**\n   * Finds resources within the parent resource's shallow subtree.\n   * @param {!Resource} parentResource\n   * @param {!Array<!Element>} elements\n   * @param {function(!Resource)} callback\n   * @private\n   */\n  ;\n\n  _proto.findResourcesInElements_ = function findResourcesInElements_(parentResource, elements, callback) {\n    var _this2 = this;\n\n    elements.forEach(function (element) {\n      (0, _log.devAssert)(parentResource.element.contains(element));\n\n      _this2.discoverResourcesForElement_(element, callback);\n    });\n  }\n  /**\n   * @param {!Element} element\n   * @param {function(!Resource)} callback\n   */\n  ;\n\n  _proto.discoverResourcesForElement_ = function discoverResourcesForElement_(element, callback) {\n    // Breadth-first search.\n    if (element.classList.contains('i-amphtml-element')) {\n      callback(this.resources_.getResourceForElement(element)); // Also schedule amp-element that is a placeholder for the element.\n\n      var placeholder = element.getPlaceholder();\n\n      if (placeholder) {\n        this.discoverResourcesForElement_(placeholder, callback);\n      }\n    } else {\n      var ampElements = element.getElementsByClassName('i-amphtml-element');\n      var seen = [];\n\n      for (var i = 0; i < ampElements.length; i++) {\n        var ampElement = ampElements[i];\n        var covered = false;\n\n        for (var j = 0; j < seen.length; j++) {\n          if (seen[j].contains(ampElement)) {\n            covered = true;\n            break;\n          }\n        }\n\n        if (!covered) {\n          seen.push(ampElement);\n          callback(this.resources_.getResourceForElement(ampElement));\n        }\n      }\n    }\n  }\n  /**\n   * Schedules layout or preload for the sub-resources of the specified\n   * resource.\n   * @param {!Resource} parentResource\n   * @param {boolean} layout\n   * @param {!Array<!Element>} subElements\n   * @private\n   */\n  ;\n\n  _proto.scheduleLayoutOrPreloadForSubresources_ = function scheduleLayoutOrPreloadForSubresources_(parentResource, layout, subElements) {\n    var _this3 = this;\n\n    this.findResourcesInElements_(parentResource, subElements, function (resource) {\n      if (resource.getState() === _resource.ResourceState.NOT_BUILT) {\n        resource.whenBuilt().then(function () {\n          _this3.measureAndTryScheduleLayout_(resource, !layout, parentResource.getLayoutPriority());\n        });\n      } else {\n        _this3.measureAndTryScheduleLayout_(resource, !layout, parentResource.getLayoutPriority());\n      }\n    });\n  }\n  /**\n   * @param {!Resource} resource\n   * @param {boolean} isPreload\n   * @param {number=} opt_parentPriority\n   * @private\n   */\n  ;\n\n  _proto.measureAndTryScheduleLayout_ = function measureAndTryScheduleLayout_(resource, isPreload, opt_parentPriority) {\n    resource.measure();\n\n    if (resource.getState() === _resource.ResourceState.READY_FOR_LAYOUT && resource.isDisplayed()) {\n      this.resources_.scheduleLayoutOrPreload(resource, !isPreload, opt_parentPriority);\n    }\n  }\n  /**\n   * Updates inViewport state for the specified sub-resources of a resource.\n   * @param {!Resource} parentResource\n   * @param {!Array<!Element>} subElements\n   * @param {boolean} inLocalViewport\n   * @private\n   */\n  ;\n\n  _proto.updateInViewportForSubresources_ = function updateInViewportForSubresources_(parentResource, subElements, inLocalViewport) {\n    var inViewport = parentResource.isInViewport() && inLocalViewport;\n    this.findResourcesInElements_(parentResource, subElements, function (resource) {\n      resource.setInViewport(inViewport);\n    });\n  };\n\n  return OwnersImpl;\n}();\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nexports.OwnersImpl = OwnersImpl;\n\nfunction installOwnersServiceForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'owners', OwnersImpl);\n}\n\n},{\"../log\":68,\"../service\":79,\"../services\":123,\"../types\":131,\"./owners-interface\":99,\"./resource\":101}],99:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.OwnersInterface = void 0;\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* eslint-disable no-unused-vars */\n\n/**\n * @interface\n */\nvar OwnersInterface =\n/*#__PURE__*/\nfunction () {\n  function OwnersInterface() {}\n\n  var _proto = OwnersInterface.prototype;\n\n  /**\n   * Assigns an owner for the specified element. This means that the resources\n   * within this element will be managed by the owner and not Resources manager.\n   * @param {!Element} element\n   * @param {!AmpElement} owner\n   * @package\n   */\n  _proto.setOwner = function setOwner(element, owner) {}\n  /**\n   * Schedules preload for the specified sub-elements that are children of the\n   * parent element. The parent element may choose to send this signal either\n   * because it's an owner (see {@link setOwner}) or because it wants the\n   * preloads to be done sooner. In either case, both parent's and children's\n   * priority is observed when scheduling this work.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  ;\n\n  _proto.schedulePreload = function schedulePreload(parentElement, subElements) {}\n  /**\n   * Schedules layout for the specified sub-elements that are children of the\n   * parent element. The parent element may choose to send this signal either\n   * because it's an owner (see {@link setOwner}) or because it wants the\n   * layouts to be done sooner. In either case, both parent's and children's\n   * priority is observed when scheduling this work.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  ;\n\n  _proto.scheduleLayout = function scheduleLayout(parentElement, subElements) {}\n  /**\n   * Invokes `unload` on the elements' resource which in turn will invoke\n   * the `documentBecameInactive` callback on the custom element.\n   * Resources that call `schedulePause` must also call `scheduleResume`.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  ;\n\n  _proto.schedulePause = function schedulePause(parentElement, subElements) {}\n  /**\n   * Invokes `resume` on the elements' resource which in turn will invoke\n   * `resumeCallback` only on paused custom elements.\n   * Resources that call `schedulePause` must also call `scheduleResume`.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  ;\n\n  _proto.scheduleResume = function scheduleResume(parentElement, subElements) {}\n  /**\n   * Schedules unlayout for specified sub-elements that are children of the\n   * parent element. The parent element can choose to send this signal when\n   * it want to unload resources for its children.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  ;\n\n  _proto.scheduleUnlayout = function scheduleUnlayout(parentElement, subElements) {}\n  /**\n   * A parent resource, especially in when it's an owner (see {@link setOwner}),\n   * may request the Resources manager to update children's inViewport state.\n   * A child's inViewport state is a logical AND between inLocalViewport\n   * specified here and parent's own inViewport state.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   * @param {boolean} inLocalViewport\n   */\n  ;\n\n  _proto.updateInViewport = function updateInViewport(parentElement, subElements, inLocalViewport) {}\n  /**\n   * Requires the layout of the specified element or top-level sub-elements\n   * within.\n   * @param {!Element} element\n   * @param {number=} opt_parentPriority\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.requireLayout = function requireLayout(element, opt_parentPriority) {};\n\n  return OwnersInterface;\n}();\n/* eslint-enable no-unused-vars */\n\n\nexports.OwnersInterface = OwnersInterface;\n\n},{}],100:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installPlatformService = installPlatformService;\nexports.Platform = void 0;\n\nvar _service = require(\"../service\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A helper class that provides information about device/OS/browser currently\n * running.\n */\nvar Platform =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function Platform(win) {\n    /** @const @private {!Navigator} */\n    this.navigator_ =\n    /** @type {!Navigator} */\n    win.navigator;\n    /** @const @private */\n\n    this.win_ = win;\n  }\n  /**\n   * Whether the current platform an Android device.\n   * @return {boolean}\n   */\n\n\n  var _proto = Platform.prototype;\n\n  _proto.isAndroid = function isAndroid() {\n    return /Android/i.test(this.navigator_.userAgent);\n  }\n  /**\n   * Whether the current platform an iOS device.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isIos = function isIos() {\n    return /iPhone|iPad|iPod/i.test(this.navigator_.userAgent);\n  }\n  /**\n   * Whether the current browser is Safari.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isSafari = function isSafari() {\n    return /Safari/i.test(this.navigator_.userAgent) && !this.isChrome() && !this.isIe() && !this.isEdge() && !this.isFirefox() && !this.isOpera();\n  }\n  /**\n   * Whether the current browser is a Chrome browser.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isChrome = function isChrome() {\n    // Also true for MS Edge :)\n    return /Chrome|CriOS/i.test(this.navigator_.userAgent) && !this.isEdge() && !this.isOpera();\n  }\n  /**\n   * Whether the current browser is a Firefox browser.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isFirefox = function isFirefox() {\n    return /Firefox|FxiOS/i.test(this.navigator_.userAgent) && !this.isEdge();\n  }\n  /**\n   * Whether the current browser is an Opera browser.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isOpera = function isOpera() {\n    // Chrome UA on Android may include OPR<v> (build code referring to Oreo),\n    // however real Opera puts put a / after OPR and that's the only tell, so\n    // we check for OPR/ instead of OPR\n    return /OPR\\/|Opera|OPiOS/i.test(this.navigator_.userAgent);\n  }\n  /**\n   * Whether the current browser is a IE browser.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isIe = function isIe() {\n    return /Trident|MSIE|IEMobile/i.test(this.navigator_.userAgent);\n  }\n  /**\n   * Whether the current browser is an Edge browser.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isEdge = function isEdge() {\n    return /Edge/i.test(this.navigator_.userAgent);\n  }\n  /**\n   * Whether the current browser is based on the WebKit engine.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isWebKit = function isWebKit() {\n    return /WebKit/i.test(this.navigator_.userAgent) && !this.isEdge();\n  }\n  /**\n   * Whether the current browser is running on Windows.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isWindows = function isWindows() {\n    return /Windows/i.test(this.navigator_.userAgent);\n  }\n  /**\n   * Whether the current browser is isStandalone.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isStandalone = function isStandalone() {\n    return this.isIos() && this.navigator_.standalone || this.isChrome() && this.win_.matchMedia('(display-mode: standalone)').matches;\n  }\n  /**\n   * Whether the current platform matches a bot user agent.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isBot = function isBot() {\n    return /bot/i.test(this.navigator_.userAgent);\n  }\n  /**\n   * Returns the major version of the browser.\n   * @return {number}\n   */\n  ;\n\n  _proto.getMajorVersion = function getMajorVersion() {\n    if (this.isSafari()) {\n      return this.isIos() ? this.getIosMajorVersion() || 0 : this.evalMajorVersion_(/\\sVersion\\/(\\d+)/, 1);\n    }\n\n    if (this.isChrome()) {\n      return this.evalMajorVersion_(/(Chrome|CriOS)\\/(\\d+)/, 2);\n    }\n\n    if (this.isFirefox()) {\n      return this.evalMajorVersion_(/(Firefox|FxiOS)\\/(\\d+)/, 2);\n    }\n\n    if (this.isOpera()) {\n      return this.evalMajorVersion_(/(OPR|Opera|OPiOS)\\/(\\d+)/, 2);\n    }\n\n    if (this.isIe()) {\n      return this.evalMajorVersion_(/MSIE\\s(\\d+)/, 1);\n    }\n\n    if (this.isEdge()) {\n      return this.evalMajorVersion_(/Edge\\/(\\d+)/, 1);\n    }\n\n    return 0;\n  }\n  /**\n   * @param {!RegExp} expr\n   * @param {number} index The index in the result that's interpreted as the\n   *   major version (integer).\n   * @return {number}\n   */\n  ;\n\n  _proto.evalMajorVersion_ = function evalMajorVersion_(expr, index) {\n    if (!this.navigator_.userAgent) {\n      return 0;\n    }\n\n    var res = this.navigator_.userAgent.match(expr);\n\n    if (!res || index >= res.length) {\n      return 0;\n    }\n\n    return parseInt(res[index], 10);\n  }\n  /**\n   * Returns the minor ios version in string.\n   * The ios version can contain two numbers (10.2) or three numbers (10.2.1).\n   * Direct string equality check is not suggested, use startWith instead.\n   * @return {string}\n   */\n  ;\n\n  _proto.getIosVersionString = function getIosVersionString() {\n    if (!this.navigator_.userAgent) {\n      return '';\n    }\n\n    if (!this.isIos()) {\n      return '';\n    }\n\n    var version = this.navigator_.userAgent.match(/OS ([0-9]+[_.][0-9]+([_.][0-9]+)?)\\b/);\n\n    if (!version) {\n      return '';\n    }\n\n    version = version[1].replace(/_/g, '.');\n    return version;\n  }\n  /**\n   * Returns the major ios version in number.\n   * @return {?number}\n   */\n  ;\n\n  _proto.getIosMajorVersion = function getIosMajorVersion() {\n    var currentIosVersion = this.getIosVersionString();\n\n    if (currentIosVersion == '') {\n      return null;\n    }\n\n    return Number(currentIosVersion.split('.')[0]);\n  };\n\n  return Platform;\n}();\n/**\n * @param {!Window} window\n * @return {*} TODO(#23582): Specify return type\n */\n\n\nexports.Platform = Platform;\n\nfunction installPlatformService(window) {\n  return (0, _service.registerServiceBuilder)(window, 'platform', Platform);\n}\n\n},{\"../service\":79}],101:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.Resource = exports.ResourceState = void 0;\n\nvar _promise = require(\"../utils/promise\");\n\nvar _layout = require(\"../layout\");\n\nvar _services = require(\"../services\");\n\nvar _style = require(\"../style\");\n\nvar _log = require(\"../log\");\n\nvar _error = require(\"../error\");\n\nvar _layoutRect = require(\"../layout-rect\");\n\nvar _string = require(\"../string\");\n\nvar _types = require(\"../types\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG = 'Resource';\nvar RESOURCE_PROP_ = '__AMP__RESOURCE';\nvar OWNER_PROP_ = '__AMP__OWNER';\n/**\n * Resource state.\n *\n * @enum {number}\n */\n\nvar ResourceState = {\n  /**\n   * The resource has not been built yet. Measures, layouts, preloads or\n   * viewport signals are not allowed.\n   */\n  NOT_BUILT: 0,\n\n  /**\n   * The resource has been built, but not measured yet and not yet ready\n   * for layout.\n   */\n  NOT_LAID_OUT: 1,\n\n  /**\n   * The resource has been built and measured and ready for layout.\n   */\n  READY_FOR_LAYOUT: 2,\n\n  /**\n   * The resource is currently scheduled for layout.\n   */\n  LAYOUT_SCHEDULED: 3,\n\n  /**\n   * The resource has been laid out.\n   */\n  LAYOUT_COMPLETE: 4,\n\n  /**\n   * The latest resource's layout failed.\n   */\n  LAYOUT_FAILED: 5\n};\n/** @typedef {{\n  distance: (boolean|number),\n    viewportHeight: (number|undefined),\n    scrollPenalty: (number|undefined),\n  }} */\n\nexports.ResourceState = ResourceState;\nvar ViewportRatioDef;\n/**\n * A Resource binding for an AmpElement.\n * @package\n */\n\nvar Resource =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Element} element\n   * @return {!Resource}\n   */\n  Resource.forElement = function forElement(element) {\n    return (\n      /** @type {!Resource} */\n      (0, _log.devAssert)(Resource.forElementOptional(element), 'Missing resource prop on %s', element)\n    );\n  }\n  /**\n   * @param {!Element} element\n   * @return {Resource}\n   */\n  ;\n\n  Resource.forElementOptional = function forElementOptional(element) {\n    return (\n      /** @type {Resource} */\n      element[RESOURCE_PROP_]\n    );\n  }\n  /**\n   * Assigns an owner for the specified element. This means that the resources\n   * within this element will be managed by the owner and not Resources manager.\n   * @param {!Element} element\n   * @param {!AmpElement} owner\n   */\n  ;\n\n  Resource.setOwner = function setOwner(element, owner) {\n    (0, _log.devAssert)(owner.contains(element), 'Owner must contain the element');\n\n    if (Resource.forElementOptional(element)) {\n      Resource.forElementOptional(element).updateOwner(owner);\n    }\n\n    element[OWNER_PROP_] = owner; // Need to clear owner cache for all child elements\n\n    var cachedElements = element.getElementsByClassName('i-amphtml-element');\n\n    for (var i = 0; i < cachedElements.length; i++) {\n      var ele = cachedElements[i];\n\n      if (Resource.forElementOptional(ele)) {\n        Resource.forElementOptional(ele).updateOwner(undefined);\n      }\n    }\n  }\n  /**\n   * @param {number} id\n   * @param {!AmpElement} element\n   * @param {!./resources-interface.ResourcesInterface} resources\n   */\n  ;\n\n  function Resource(id, element, resources) {\n    element[RESOURCE_PROP_] = this;\n    /** @private {number} */\n\n    this.id_ = id;\n    /** @export @const {!AmpElement} */\n\n    this.element = element;\n    /** @export @const {string} */\n\n    this.debugid = element.tagName.toLowerCase() + '#' + id;\n    /** @const {!Window} */\n\n    this.hostWin = (0, _types.toWin)(element.ownerDocument.defaultView);\n    /** @const @private {!./resources-interface.ResourcesInterface} */\n\n    this.resources_ = resources;\n    /** @const @private {boolean} */\n\n    this.isPlaceholder_ = element.hasAttribute('placeholder');\n    /** @private {boolean} */\n\n    this.isBuilding_ = false;\n    /** @private {!AmpElement|undefined|null} */\n\n    this.owner_ = undefined;\n    /** @private {!ResourceState} */\n\n    this.state_ = element.isBuilt() ? ResourceState.NOT_LAID_OUT : ResourceState.NOT_BUILT;\n    /** @private {number} */\n\n    this.priorityOverride_ = -1;\n    /** @private {number} */\n\n    this.layoutCount_ = 0;\n    /** @private {*} */\n\n    this.lastLayoutError_ = null;\n    /** @private {boolean} */\n\n    this.isFixed_ = false;\n    /** @private {!../layout-rect.LayoutRectDef} */\n\n    this.layoutBox_ = (0, _layoutRect.layoutRectLtwh)(-10000, -10000, 0, 0);\n    /** @private {?../layout-rect.LayoutRectDef} */\n\n    this.initialLayoutBox_ = null;\n    /** @private {boolean} */\n\n    this.isMeasureRequested_ = false;\n    /**\n     * Really, this is a <number, !Deferred> map,\n     * but CC's type system can't handle it.\n     * @private {?Object<string, !Deferred>}\n     */\n\n    this.withViewportDeferreds_ = null;\n    /** @private {?Promise<undefined>} */\n\n    this.layoutPromise_ = null;\n    /**\n     * Pending change size that was requested but could not be satisfied.\n     * @private {!./resources-impl.SizeDef|undefined}\n     */\n\n    this.pendingChangeSize_ = undefined;\n    /** @private {boolean} */\n\n    this.loadedOnce_ = false;\n    var deferred = new _promise.Deferred();\n    /** @private @const {!Promise} */\n\n    this.loadPromise_ = deferred.promise;\n    /** @private {?Function} */\n\n    this.loadPromiseResolve_ = deferred.resolve;\n  }\n  /**\n   * Returns resource's ID.\n   * @return {number}\n   */\n\n\n  var _proto = Resource.prototype;\n\n  _proto.getId = function getId() {\n    return this.id_;\n  }\n  /**\n   * Update owner element\n   * @param {AmpElement|undefined} owner\n   */\n  ;\n\n  _proto.updateOwner = function updateOwner(owner) {\n    this.owner_ = owner;\n  }\n  /**\n   * Returns an owner element or null.\n   * @return {?AmpElement}\n   */\n  ;\n\n  _proto.getOwner = function getOwner() {\n    if (this.owner_ === undefined) {\n      for (var n = this.element; n; n = n.parentElement) {\n        if (n[OWNER_PROP_]) {\n          this.owner_ = n[OWNER_PROP_];\n          break;\n        }\n      }\n\n      if (this.owner_ === undefined) {\n        this.owner_ = null;\n      }\n    }\n\n    return this.owner_;\n  }\n  /**\n   * Whether the resource has an owner.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.hasOwner = function hasOwner() {\n    return !!this.getOwner();\n  }\n  /**\n   * Returns the resource's element priority.\n   * @return {number}\n   */\n  ;\n\n  _proto.getLayoutPriority = function getLayoutPriority() {\n    if (this.priorityOverride_ != -1) {\n      return this.priorityOverride_;\n    }\n\n    return this.element.getLayoutPriority();\n  }\n  /**\n   * Overrides the element's priority.\n   * @param {number} newPriority\n   */\n  ;\n\n  _proto.updateLayoutPriority = function updateLayoutPriority(newPriority) {\n    this.priorityOverride_ = newPriority;\n  }\n  /**\n   * Returns the resource's state. See {@link ResourceState} for details.\n   * @return {!ResourceState}\n   */\n  ;\n\n  _proto.getState = function getState() {\n    return this.state_;\n  }\n  /**\n   * Returns whether the resource has been fully built.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isBuilt = function isBuilt() {\n    return this.element.isBuilt();\n  }\n  /**\n   * Returns whether the resource is currently being built.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isBuilding = function isBuilding() {\n    return this.isBuilding_;\n  }\n  /**\n   * Returns promise that resolves when the element has been built.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.whenBuilt = function whenBuilt() {\n    // TODO(dvoytenko): merge with the standard BUILT signal.\n    return this.element.signals().whenSignal('res-built');\n  }\n  /**\n   * Requests the resource's element to be built. See {@link AmpElement.build}\n   * for details.\n   * @return {?Promise}\n   */\n  ;\n\n  _proto.build = function build() {\n    var _this = this;\n\n    if (this.isBuilding_ || !this.element.isUpgraded()) {\n      return null;\n    }\n\n    this.isBuilding_ = true;\n    return this.element.build().then(function () {\n      _this.isBuilding_ = false;\n      _this.state_ = ResourceState.NOT_LAID_OUT; // TODO(dvoytenko): merge with the standard BUILT signal.\n\n      _this.element.signals().signal('res-built');\n    }, function (reason) {\n      _this.maybeReportErrorOnBuildFailure(reason);\n\n      _this.isBuilding_ = false;\n\n      _this.element.signals().rejectSignal('res-built', reason);\n\n      throw reason;\n    });\n  }\n  /**\n   * @param {*} reason\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.maybeReportErrorOnBuildFailure = function maybeReportErrorOnBuildFailure(reason) {\n    if (!(0, _error.isBlockedByConsent)(reason)) {\n      (0, _log.dev)().error(TAG, 'failed to build:', this.debugid, reason);\n    }\n  }\n  /**\n   * Optionally hides or shows the element depending on the media query.\n   */\n  ;\n\n  _proto.applySizesAndMediaQuery = function applySizesAndMediaQuery() {\n    this.element.applySizesAndMediaQuery();\n  }\n  /**\n   * Instructs the element to change its size and transitions to the state\n   * awaiting the measure and possibly layout.\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef=} opt_newMargins\n   */\n  ;\n\n  _proto.changeSize = function changeSize(newHeight, newWidth, opt_newMargins) {\n    this.element.\n    /*OK*/\n    changeSize(newHeight, newWidth, opt_newMargins); // Schedule for re-measure and possible re-layout.\n\n    this.requestMeasure();\n  }\n  /**\n   * Informs the element that it's either overflown or not.\n   * @param {boolean} overflown\n   * @param {number|undefined} requestedHeight\n   * @param {number|undefined} requestedWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef|undefined} requestedMargins\n   */\n  ;\n\n  _proto.overflowCallback = function overflowCallback(overflown, requestedHeight, requestedWidth, requestedMargins) {\n    if (overflown) {\n      this.pendingChangeSize_ = {\n        height: requestedHeight,\n        width: requestedWidth,\n        margins: requestedMargins\n      };\n    }\n\n    this.element.overflowCallback(overflown, requestedHeight, requestedWidth, requestedMargins);\n  }\n  /** reset pending change sizes */\n  ;\n\n  _proto.resetPendingChangeSize = function resetPendingChangeSize() {\n    this.pendingChangeSize_ = undefined;\n  }\n  /**\n   * @return {!./resources-impl.SizeDef|undefined}\n   */\n  ;\n\n  _proto.getPendingChangeSize = function getPendingChangeSize() {\n    return this.pendingChangeSize_;\n  }\n  /**\n   * Time delay imposed by baseElement upgradeCallback.  If no\n   * upgradeCallback specified or not yet executed, delay is 0.\n   * @return {number}\n   */\n  ;\n\n  _proto.getUpgradeDelayMs = function getUpgradeDelayMs() {\n    return this.element.getUpgradeDelayMs();\n  }\n  /**\n   * Measures the resource's boundaries. An upgraded element will be\n   * transitioned to the \"ready for layout\" state.\n   */\n  ;\n\n  _proto.measure = function measure() {\n    // Check if the element is ready to be measured.\n    // Placeholders are special. They are technically \"owned\" by parent AMP\n    // elements, sized by parents, but laid out independently. This means\n    // that placeholders need to at least wait until the parent element\n    // has been stubbed. We can tell whether the parent has been stubbed\n    // by whether a resource has been attached to it.\n    if (this.isPlaceholder_ && this.element.parentElement && // Use prefix to recognize AMP element. This is necessary because stub\n    // may not be attached yet.\n    (0, _string.startsWith)(this.element.parentElement.tagName, 'AMP-') && !(RESOURCE_PROP_ in this.element.parentElement)) {\n      return;\n    }\n\n    this.isMeasureRequested_ = false; // TODO\n\n    var oldBox = this.layoutBox_;\n    this.measureViaResources_();\n    var box = this.layoutBox_; // Note that \"left\" doesn't affect readiness for the layout.\n\n    var sizeChanges = !(0, _layoutRect.layoutRectSizeEquals)(oldBox, box);\n\n    if (this.state_ == ResourceState.NOT_LAID_OUT || oldBox.top != box.top || sizeChanges) {\n      if (this.element.isUpgraded() && this.state_ != ResourceState.NOT_BUILT && (this.state_ == ResourceState.NOT_LAID_OUT || this.element.isRelayoutNeeded())) {\n        this.state_ = ResourceState.READY_FOR_LAYOUT;\n      }\n    }\n\n    if (!this.hasBeenMeasured()) {\n      this.initialLayoutBox_ = box;\n    }\n\n    this.element.updateLayoutBox(box, sizeChanges);\n  }\n  /** Use resources for measurement */\n  ;\n\n  _proto.measureViaResources_ = function measureViaResources_() {\n    var viewport = _services.Services.viewportForDoc(this.element);\n\n    var box = viewport.getLayoutRect(this.element);\n    this.layoutBox_ = box; // Calculate whether the element is currently is or in `position:fixed`.\n\n    var isFixed = false;\n\n    if (viewport.supportsPositionFixed() && this.isDisplayed()) {\n      var _this$resources_$getA = this.resources_.getAmpdoc(),\n          win = _this$resources_$getA.win;\n\n      var body = win.document.body;\n\n      for (var n = this.element; n && n != body; n = n.\n      /*OK*/\n      offsetParent) {\n        if (n.isAlwaysFixed && n.isAlwaysFixed()) {\n          isFixed = true;\n          break;\n        }\n\n        if (viewport.isDeclaredFixed(n) && (0, _style.computedStyle)(win, n).position == 'fixed') {\n          isFixed = true;\n          break;\n        }\n      }\n    }\n\n    this.isFixed_ = isFixed;\n\n    if (isFixed) {\n      // For fixed position elements, we need the relative position to the\n      // viewport. When accessing the layoutBox through #getLayoutBox, we'll\n      // return the new absolute position.\n      this.layoutBox_ = (0, _layoutRect.moveLayoutRect)(box, -viewport.getScrollLeft(), -viewport.getScrollTop());\n    }\n  }\n  /**\n   * Completes collapse: ensures that the element is `display:none` and\n   * updates layout box.\n   */\n  ;\n\n  _proto.completeCollapse = function completeCollapse() {\n    (0, _style.toggle)(this.element, false);\n    this.layoutBox_ = (0, _layoutRect.layoutRectLtwh)(this.layoutBox_.left, this.layoutBox_.top, 0, 0);\n    this.isFixed_ = false;\n    this.element.updateLayoutBox(this.getLayoutBox());\n    var owner = this.getOwner();\n\n    if (owner) {\n      owner.collapsedCallback(this.element);\n    }\n  }\n  /**\n   * Completes expand: ensures that the element is not `display:none` and\n   * updates measurements.\n   */\n  ;\n\n  _proto.completeExpand = function completeExpand() {\n    (0, _style.toggle)(this.element, true);\n    this.requestMeasure();\n  }\n  /**\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isMeasureRequested = function isMeasureRequested() {\n    return this.isMeasureRequested_;\n  }\n  /**\n   * Checks if the current resource has been measured.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.hasBeenMeasured = function hasBeenMeasured() {\n    return !!this.initialLayoutBox_;\n  }\n  /**\n   * Requests the element to be remeasured on the next pass.\n   */\n  ;\n\n  _proto.requestMeasure = function requestMeasure() {\n    this.isMeasureRequested_ = true;\n  }\n  /**\n   * Returns a previously measured layout box adjusted to the viewport. This\n   * mainly affects fixed-position elements that are adjusted to be always\n   * relative to the document position in the viewport.\n   * @return {!../layout-rect.LayoutRectDef}\n   */\n  ;\n\n  _proto.getLayoutBox = function getLayoutBox() {\n    if (!this.isFixed_) {\n      return this.layoutBox_;\n    }\n\n    var viewport = _services.Services.viewportForDoc(this.element);\n\n    return (0, _layoutRect.moveLayoutRect)(this.layoutBox_, viewport.getScrollLeft(), viewport.getScrollTop());\n  }\n  /**\n   * Returns a previously measured layout box relative to the page. The\n   * fixed-position elements are relative to the top of the document.\n   * @return {!../layout-rect.LayoutRectDef}\n   */\n  ;\n\n  _proto.getPageLayoutBox = function getPageLayoutBox() {\n    return this.layoutBox_;\n  }\n  /**\n   * Returns the resource's layout box relative to the page. It will be\n   * measured if the resource hasn't ever be measured.\n   *\n   * @return {!Promise<!../layout-rect.LayoutRectDef>}\n   */\n  ;\n\n  _proto.getPageLayoutBoxAsync = function getPageLayoutBoxAsync() {\n    var _this2 = this;\n\n    if (this.hasBeenMeasured()) {\n      return (0, _promise.tryResolve)(function () {\n        return _this2.getPageLayoutBox();\n      });\n    }\n\n    return _services.Services.vsyncFor(this.hostWin).measurePromise(function () {\n      _this2.measure();\n\n      return _this2.getPageLayoutBox();\n    });\n  }\n  /**\n   * Returns the first measured layout box.\n   * @return {!../layout-rect.LayoutRectDef}\n   */\n  ;\n\n  _proto.getInitialLayoutBox = function getInitialLayoutBox() {\n    // Before the first measure, there will be no initial layoutBox.\n    // Luckily, layoutBox will be present but essentially useless.\n    return this.initialLayoutBox_ || this.layoutBox_;\n  }\n  /**\n   * Whether the resource is displayed, i.e. if it has non-zero width and\n   * height.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isDisplayed = function isDisplayed() {\n    var isFluid = this.element.getLayout() == _layout.Layout.FLUID; // TODO(jridgewell): #getSize\n\n\n    var box = this.getLayoutBox();\n    var hasNonZeroSize = box.height > 0 && box.width > 0;\n    return (isFluid || hasNonZeroSize) && !!this.element.ownerDocument && !!this.element.ownerDocument.defaultView;\n  }\n  /**\n   * Whether the element is fixed according to the latest measurement.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isFixed = function isFixed() {\n    return this.isFixed_;\n  }\n  /**\n   * Whether the element's layout box overlaps with the specified rect.\n   * @param {!../layout-rect.LayoutRectDef} rect\n   * @return {boolean}\n   */\n  ;\n\n  _proto.overlaps = function overlaps(rect) {\n    return (0, _layoutRect.layoutRectsOverlap)(this.getLayoutBox(), rect);\n  }\n  /**\n   * Whether this element can be pre-rendered.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.prerenderAllowed = function prerenderAllowed() {\n    return this.element.prerenderAllowed();\n  }\n  /**\n   * Whether this element has render-blocking service.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isBuildRenderBlocking = function isBuildRenderBlocking() {\n    return this.element.isBuildRenderBlocking();\n  }\n  /**\n   * @param {number|boolean} viewport derived from renderOutsideViewport.\n   * @return {!Promise} resolves when underlying element is built and within the\n   *    viewport range given.\n   */\n  ;\n\n  _proto.whenWithinViewport = function whenWithinViewport(viewport) {\n    (0, _log.devAssert)(viewport !== false); // Resolve is already laid out or viewport is true.\n\n    if (!this.isLayoutPending() || viewport === true) {\n      return Promise.resolve();\n    } // See if pre-existing promise.\n\n\n    var viewportNum = (0, _log.dev)().assertNumber(viewport);\n    var key = String(viewportNum);\n\n    if (this.withViewportDeferreds_ && this.withViewportDeferreds_[key]) {\n      return this.withViewportDeferreds_[key].promise;\n    } // See if already within viewport multiplier.\n\n\n    if (this.isWithinViewportRatio(viewportNum)) {\n      return Promise.resolve();\n    } // return promise that will trigger when within viewport multiple.\n\n\n    this.withViewportDeferreds_ = this.withViewportDeferreds_ || {};\n    this.withViewportDeferreds_[key] = new _promise.Deferred();\n    return this.withViewportDeferreds_[key].promise;\n  }\n  /** @private resolves promises populated via whenWithinViewport. */\n  ;\n\n  _proto.resolveDeferredsWhenWithinViewports_ = function resolveDeferredsWhenWithinViewports_() {\n    if (!this.withViewportDeferreds_) {\n      return;\n    }\n\n    var viewportRatio = this.getDistanceViewportRatio();\n\n    for (var key in this.withViewportDeferreds_) {\n      if (this.isWithinViewportRatio(parseFloat(key), viewportRatio)) {\n        this.withViewportDeferreds_[key].resolve();\n        delete this.withViewportDeferreds_[key];\n      }\n    }\n  }\n  /** @return {!ViewportRatioDef} */\n  ;\n\n  _proto.getDistanceViewportRatio = function getDistanceViewportRatio() {\n    // Numeric interface, element is allowed to render outside viewport when it\n    // is within X times the viewport height of the current viewport.\n    var viewport = _services.Services.viewportForDoc(this.element);\n\n    var viewportBox = viewport.getRect();\n    var layoutBox = this.getLayoutBox();\n    var scrollDirection = this.resources_.getScrollDirection();\n    var scrollPenalty = 1;\n    var distance = 0;\n\n    if (viewportBox.right < layoutBox.left || viewportBox.left > layoutBox.right) {\n      // If outside of viewport's x-axis, element is not in viewport so return\n      // false.\n      return {\n        distance: false\n      };\n    }\n\n    if (viewportBox.bottom < layoutBox.top) {\n      // Element is below viewport\n      distance = layoutBox.top - viewportBox.bottom; // If we're scrolling away from the element\n\n      if (scrollDirection == -1) {\n        scrollPenalty = 2;\n      }\n    } else if (viewportBox.top > layoutBox.bottom) {\n      // Element is above viewport\n      distance = viewportBox.top - layoutBox.bottom; // If we're scrolling away from the element\n\n      if (scrollDirection == 1) {\n        scrollPenalty = 2;\n      }\n    } else {\n      // Element is in viewport so return true for all but boolean false.\n      return {\n        distance: true\n      };\n    }\n\n    return {\n      distance: distance,\n      scrollPenalty: scrollPenalty,\n      viewportHeight: viewportBox.height\n    };\n  }\n  /**\n   * @param {number|boolean} multiplier\n   * @param {ViewportRatioDef=} opt_viewportRatio\n   * @return {boolean} whether multiplier given is within viewport ratio\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.isWithinViewportRatio = function isWithinViewportRatio(multiplier, opt_viewportRatio) {\n    if (typeof multiplier === 'boolean') {\n      return multiplier;\n    }\n\n    var _ref = opt_viewportRatio || this.getDistanceViewportRatio(),\n        distance = _ref.distance,\n        scrollPenalty = _ref.scrollPenalty,\n        viewportHeight = _ref.viewportHeight;\n\n    if (typeof distance == 'boolean') {\n      return distance;\n    }\n\n    return distance < viewportHeight * multiplier / scrollPenalty;\n  }\n  /**\n   * Whether this is allowed to render when not in viewport.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.renderOutsideViewport = function renderOutsideViewport() {\n    // The exception is for owned resources, since they only attempt to\n    // render outside viewport when the owner has explicitly allowed it.\n    // TODO(jridgewell, #5803): Resources should be asking owner if it can\n    // prerender this resource, so that it can avoid expensive elements wayyy\n    // outside of viewport. For now, blindly trust that owner knows what it's\n    // doing.\n    this.resolveDeferredsWhenWithinViewports_();\n    return this.hasOwner() || this.isWithinViewportRatio(this.element.renderOutsideViewport());\n  }\n  /**\n   * Whether this is allowed to render when scheduler is idle but not in\n   * viewport.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.idleRenderOutsideViewport = function idleRenderOutsideViewport() {\n    return this.isWithinViewportRatio(this.element.idleRenderOutsideViewport());\n  }\n  /**\n   * Sets the resource's state to LAYOUT_SCHEDULED.\n   * @param {number} scheduleTime The time at which layout was scheduled.\n   */\n  ;\n\n  _proto.layoutScheduled = function layoutScheduled(scheduleTime) {\n    this.state_ = ResourceState.LAYOUT_SCHEDULED;\n    this.element.layoutScheduleTime = scheduleTime;\n  }\n  /**\n   * Undoes `layoutScheduled`.\n   */\n  ;\n\n  _proto.layoutCanceled = function layoutCanceled() {\n    this.state_ = this.hasBeenMeasured() ? ResourceState.READY_FOR_LAYOUT : ResourceState.NOT_LAID_OUT;\n  }\n  /**\n   * Starts the layout of the resource. Returns the promise that will yield\n   * once layout is complete. Only allowed to be called on a upgraded, built\n   * and displayed element.\n   * @return {!Promise}\n   * @package\n   */\n  ;\n\n  _proto.startLayout = function startLayout() {\n    var _this3 = this;\n\n    if (this.layoutPromise_) {\n      return this.layoutPromise_;\n    }\n\n    if (this.state_ == ResourceState.LAYOUT_COMPLETE) {\n      return Promise.resolve();\n    }\n\n    if (this.state_ == ResourceState.LAYOUT_FAILED) {\n      return Promise.reject(this.lastLayoutError_);\n    }\n\n    (0, _log.devAssert)(this.state_ != ResourceState.NOT_BUILT, 'Not ready to start layout: %s (%s)', this.debugid, this.state_);\n    (0, _log.devAssert)(this.isDisplayed(), 'Not displayed for layout: %s', this.debugid); // Unwanted re-layouts are ignored.\n\n    if (this.layoutCount_ > 0 && !this.element.isRelayoutNeeded()) {\n      (0, _log.dev)().fine(TAG, \"layout canceled since it wasn't requested:\", this.debugid, this.state_);\n      this.state_ = ResourceState.LAYOUT_COMPLETE;\n      return Promise.resolve();\n    }\n\n    (0, _log.dev)().fine(TAG, 'start layout:', this.debugid, 'count:', this.layoutCount_);\n    this.layoutCount_++;\n    this.state_ = ResourceState.LAYOUT_SCHEDULED;\n    var promise = new Promise(function (resolve, reject) {\n      _services.Services.vsyncFor(_this3.hostWin).mutate(function () {\n        try {\n          resolve(_this3.element.layoutCallback());\n        } catch (e) {\n          reject(e);\n        }\n      });\n    });\n    this.layoutPromise_ = promise.then(function () {\n      return _this3.layoutComplete_(true);\n    }, function (reason) {\n      return _this3.layoutComplete_(false, reason);\n    });\n    return this.layoutPromise_;\n  }\n  /**\n   * @param {boolean} success\n   * @param {*=} opt_reason\n   * @return {!Promise|undefined}\n   */\n  ;\n\n  _proto.layoutComplete_ = function layoutComplete_(success, opt_reason) {\n    if (this.loadPromiseResolve_) {\n      this.loadPromiseResolve_();\n      this.loadPromiseResolve_ = null;\n    }\n\n    this.layoutPromise_ = null;\n    this.loadedOnce_ = true;\n    this.state_ = success ? ResourceState.LAYOUT_COMPLETE : ResourceState.LAYOUT_FAILED;\n    this.lastLayoutError_ = opt_reason;\n\n    if (success) {\n      (0, _log.dev)().fine(TAG, 'layout complete:', this.debugid);\n    } else {\n      (0, _log.dev)().fine(TAG, 'loading failed:', this.debugid, opt_reason);\n      return Promise.reject(opt_reason);\n    }\n  }\n  /**\n   * Returns true if the resource layout has not completed or failed.\n   * @return {boolean}\n   * */\n  ;\n\n  _proto.isLayoutPending = function isLayoutPending() {\n    return this.state_ != ResourceState.LAYOUT_COMPLETE && this.state_ != ResourceState.LAYOUT_FAILED;\n  }\n  /**\n   * Returns a promise that is resolved when this resource is laid out\n   * for the first time and the resource was loaded. Note that the resource\n   * could be unloaded subsequently. This method returns resolved promise for\n   * sunch unloaded elements.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.loadedOnce = function loadedOnce() {\n    return this.loadPromise_;\n  }\n  /**\n   * @return {boolean} true if the resource has been loaded at least once.\n   */\n  ;\n\n  _proto.hasLoadedOnce = function hasLoadedOnce() {\n    return this.loadedOnce_;\n  }\n  /**\n   * Whether the resource is currently visible in the viewport.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isInViewport = function isInViewport() {\n    var isInViewport = this.element.isInViewport();\n\n    if (isInViewport) {\n      this.resolveDeferredsWhenWithinViewports_();\n    }\n\n    return isInViewport;\n  }\n  /**\n   * Updates the inViewport state of the element.\n   * @param {boolean} inViewport\n   */\n  ;\n\n  _proto.setInViewport = function setInViewport(inViewport) {\n    this.element.viewportCallback(inViewport);\n  }\n  /**\n   * Calls element's unlayoutCallback callback and resets state for\n   * relayout in case document becomes active again.\n   */\n  ;\n\n  _proto.unlayout = function unlayout() {\n    if (this.state_ == ResourceState.NOT_BUILT || this.state_ == ResourceState.NOT_LAID_OUT) {\n      return;\n    }\n\n    this.setInViewport(false);\n\n    if (this.element.unlayoutCallback()) {\n      this.element.togglePlaceholder(true);\n      this.state_ = ResourceState.NOT_LAID_OUT;\n      this.layoutCount_ = 0;\n      this.layoutPromise_ = null;\n    }\n  }\n  /**\n   * Returns the task ID for this resource.\n   * @param {string} localId\n   * @return {string}\n   */\n  ;\n\n  _proto.getTaskId = function getTaskId(localId) {\n    return this.debugid + '#' + localId;\n  }\n  /**\n   * Calls element's pauseCallback callback.\n   */\n  ;\n\n  _proto.pause = function pause() {\n    this.element.pauseCallback();\n\n    if (this.element.unlayoutOnPause()) {\n      this.unlayout();\n    }\n  }\n  /**\n   * Calls element's pauseCallback callback.\n   */\n  ;\n\n  _proto.pauseOnRemove = function pauseOnRemove() {\n    this.element.pauseCallback();\n  }\n  /**\n   * Calls element's resumeCallback callback.\n   */\n  ;\n\n  _proto.resume = function resume() {\n    this.element.resumeCallback();\n  }\n  /**\n   * Called when a previously visible element is no longer displayed.\n   */\n  ;\n\n  _proto.unload = function unload() {\n    this.pause();\n    this.unlayout();\n  }\n  /**\n   * Disconnect the resource. Mainly intended for embed resources that do not\n   * receive `disconnectedCallback` naturally via CE API.\n   */\n  ;\n\n  _proto.disconnect = function disconnect() {\n    delete this.element[RESOURCE_PROP_];\n    this.element.disconnect(\n    /* opt_pretendDisconnected */\n    true);\n  };\n\n  return Resource;\n}();\n\nexports.Resource = Resource;\n\n},{\"../error\":44,\"../layout\":66,\"../layout-rect\":65,\"../log\":68,\"../services\":123,\"../string\":126,\"../style\":128,\"../types\":131,\"../utils/promise\":147}],102:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installResourcesServiceForDoc = installResourcesServiceForDoc;\nexports.SizeDef = exports.ResourcesImpl = void 0;\n\nvar _promise = require(\"../utils/promise\");\n\nvar _finiteStateMachine = require(\"../finite-state-machine\");\n\nvar _focusHistory = require(\"../focus-history\");\n\nvar _pass = require(\"../pass\");\n\nvar _resourcesInterface = require(\"./resources-interface\");\n\nvar _resource = require(\"./resource\");\n\nvar _services = require(\"../services\");\n\nvar _taskQueue = require(\"./task-queue\");\n\nvar _visibilityState = require(\"../visibility-state\");\n\nvar _layoutRect = require(\"../layout-rect\");\n\nvar _dom = require(\"../dom\");\n\nvar _style = require(\"../style\");\n\nvar _log = require(\"../log\");\n\nvar _object = require(\"../utils/object\");\n\nvar _url = require(\"../url\");\n\nvar _ieMediaBug = require(\"./ie-media-bug\");\n\nvar _error = require(\"../error\");\n\nvar _experiments = require(\"../experiments\");\n\nvar _eventHelper = require(\"../event-helper\");\n\nvar _service = require(\"../service\");\n\nvar _array = require(\"../utils/array\");\n\nvar _chunk = require(\"../chunk\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG_ = 'Resources';\nvar LAYOUT_TASK_ID_ = 'L';\nvar LAYOUT_TASK_OFFSET_ = 0;\nvar PRELOAD_TASK_ID_ = 'P';\nvar PRELOAD_TASK_OFFSET_ = 2;\nvar PRIORITY_BASE_ = 10;\nvar PRIORITY_PENALTY_TIME_ = 1000;\nvar POST_TASK_PASS_DELAY_ = 1000;\nvar MUTATE_DEFER_DELAY_ = 500;\nvar FOCUS_HISTORY_TIMEOUT_ = 1000 * 60; // 1min\n\nvar FOUR_FRAME_DELAY_ = 70;\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   newMargins: !../layout-rect.LayoutMarginsChangeDef,\n *   currentMargins: !../layout-rect.LayoutMarginsDef\n * }}\n */\n\nvar MarginChangeDef;\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   resource: !Resource,\n *   newHeight: (number|undefined),\n *   newWidth: (number|undefined),\n *   marginChange: (!MarginChangeDef|undefined),\n *   event: (?Event|undefined),\n *   force: boolean,\n *   callback: (function(boolean)|undefined),\n * }}\n */\n\nvar ChangeSizeRequestDef;\n/**\n * @implements {ResourcesInterface}\n */\n\nvar ResourcesImpl =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  function ResourcesImpl(ampdoc) {\n    var _this = this;\n\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @const {!Window} */\n\n    this.win = ampdoc.win;\n    /** @const @private {!./viewer-interface.ViewerInterface} */\n\n    this.viewer_ = _services.Services.viewerForDoc(ampdoc);\n    /** @private {boolean} */\n\n    this.isRuntimeOn_ = this.viewer_.isRuntimeOn();\n    /**\n     * Used primarily for testing to allow build phase to proceed.\n     * @const @private {boolean}\n     */\n\n    this.isBuildOn_ = false;\n    /** @private {number} */\n\n    this.resourceIdCounter_ = 0;\n    /** @private @const {!Array<!Resource>} */\n\n    this.resources_ = [];\n    /** @private {number} */\n\n    this.addCount_ = 0;\n    /** @private {number} */\n\n    this.buildAttemptsCount_ = 0;\n    /** @private {boolean} */\n\n    this.visible_ = this.ampdoc.isVisible();\n    /** @private {number} */\n\n    this.prerenderSize_ = this.viewer_.getPrerenderSize();\n    /** @private {boolean} */\n\n    this.documentReady_ = false;\n    /**\n     * We want to do some work in the first pass after\n     * the document is ready.\n     * @private {boolean}\n     */\n\n    this.firstPassAfterDocumentReady_ = true;\n    /**\n     * Whether AMP has been fully initialized.\n     * @private {boolean}\n     */\n\n    this.ampInitialized_ = false;\n    /**\n     * We also adjust the timeout penalty shortly after the first pass.\n     * @private {number}\n     */\n\n    this.firstVisibleTime_ = -1;\n    /** @private {boolean} */\n\n    this.relayoutAll_ = true;\n    /**\n     * TODO(jridgewell): relayoutTop should be replaced with parent layer\n     * dirtying.\n     * @private {number}\n     */\n\n    this.relayoutTop_ = -1;\n    /** @private {time} */\n\n    this.lastScrollTime_ = 0;\n    /** @private {number} */\n\n    this.lastVelocity_ = 0;\n    /** @const @private {!Pass} */\n\n    this.pass_ = new _pass.Pass(this.win, function () {\n      return _this.doPass();\n    });\n    /** @const @private {!Pass} */\n\n    this.remeasurePass_ = new _pass.Pass(this.win, function () {\n      _this.relayoutAll_ = true;\n\n      _this.schedulePass();\n    });\n    /** @const {!TaskQueue} */\n\n    this.exec_ = new _taskQueue.TaskQueue();\n    /** @const {!TaskQueue} */\n\n    this.queue_ = new _taskQueue.TaskQueue();\n    /** @const {!function(./task-queue.TaskDef, !Object<string, *>):number} */\n\n    this.boundTaskScorer_ = this.calcTaskScore_.bind(this);\n    /**\n     * @private {!Array<!ChangeSizeRequestDef>}\n     */\n\n    this.requestsChangeSize_ = [];\n    /** @private {?Array<!Resource>} */\n\n    this.pendingBuildResources_ = [];\n    /** @private {boolean} */\n\n    this.isCurrentlyBuildingPendingResources_ = false;\n    /** @private @const {!./viewport/viewport-interface.ViewportInterface} */\n\n    this.viewport_ = _services.Services.viewportForDoc(this.ampdoc);\n    /** @private @const {!./vsync-impl.Vsync} */\n\n    this.vsync_ = _services.Services.\n    /*OK*/\n    vsyncFor(this.win);\n    /** @private @const {!FocusHistory} */\n\n    this.activeHistory_ = new _focusHistory.FocusHistory(this.win, FOCUS_HISTORY_TIMEOUT_);\n    /** @private {boolean} */\n\n    this.vsyncScheduled_ = false;\n    /** @private {number} */\n\n    this.contentHeight_ = 0;\n    /** @private {boolean} */\n\n    this.maybeChangeHeight_ = false;\n    /** @const @private {!Array<function()>} */\n\n    this.passCallbacks_ = [];\n    /** @const @private {!Deferred} */\n\n    this.firstPassDone_ = new _promise.Deferred();\n    /** @private @const {!FiniteStateMachine<!VisibilityState>} */\n\n    this.visibilityStateMachine_ = new _finiteStateMachine.FiniteStateMachine(this.ampdoc.getVisibilityState()); // When viewport is resized, we have to re-measure all elements.\n\n    this.viewport_.onChanged(function (event) {\n      _this.lastScrollTime_ = Date.now();\n      _this.lastVelocity_ = event.velocity;\n\n      if (event.relayoutAll) {\n        _this.relayoutAll_ = true;\n        _this.maybeChangeHeight_ = true;\n      }\n\n      _this.schedulePass();\n    });\n    this.viewport_.onScroll(function () {\n      _this.lastScrollTime_ = Date.now();\n    }); // When document becomes visible, e.g. from \"prerender\" mode, do a\n    // simple pass.\n\n    this.ampdoc.onVisibilityChanged(function () {\n      if (_this.firstVisibleTime_ == -1 && _this.ampdoc.isVisible()) {\n        _this.firstVisibleTime_ = Date.now();\n      }\n\n      _this.schedulePass();\n    });\n    this.viewer_.onRuntimeState(function (state) {\n      (0, _log.dev)().fine(TAG_, 'Runtime state:', state);\n      _this.isRuntimeOn_ = state;\n\n      _this.schedulePass(1);\n    });\n    this.activeHistory_.onFocus(function (element) {\n      _this.checkPendingChangeSize_(element);\n    }); // Schedule initial passes. This must happen in a startup task\n    // to avoid blocking body visible.\n\n    (0, _chunk.startupChunk)(this.ampdoc, function () {\n      _this.setupVisibilityStateMachine_(_this.visibilityStateMachine_);\n\n      _this.schedulePass(0);\n    });\n    this.rebuildDomWhenReady_();\n  }\n  /** @private */\n\n\n  var _proto = ResourcesImpl.prototype;\n\n  _proto.rebuildDomWhenReady_ = function rebuildDomWhenReady_() {\n    var _this2 = this;\n\n    // Ensure that we attempt to rebuild things when DOM is ready.\n    this.ampdoc.whenReady().then(function () {\n      _this2.documentReady_ = true;\n\n      _this2.buildReadyResources_();\n\n      _this2.pendingBuildResources_ = null;\n      var fixPromise = (0, _ieMediaBug.checkAndFix)(_this2.win);\n\n      var remeasure = function remeasure() {\n        return _this2.remeasurePass_.schedule();\n      };\n\n      if (fixPromise) {\n        fixPromise.then(remeasure);\n      } else {\n        // No promise means that there's no problem.\n        remeasure();\n      }\n\n      _this2.monitorInput_(); // Safari 10 and under incorrectly estimates font spacing for\n      // `@font-face` fonts. This leads to wild measurement errors. The best\n      // course of action is to remeasure everything on window.onload or font\n      // timeout (3s), whichever is earlier. This has to be done on the global\n      // window because this is where the fonts are always added.\n      // Unfortunately, `document.fonts.ready` cannot be used here due to\n      // https://bugs.webkit.org/show_bug.cgi?id=174030.\n      // See https://bugs.webkit.org/show_bug.cgi?id=174031 for more details.\n\n\n      Promise.race([(0, _eventHelper.loadPromise)(_this2.win), _services.Services.timerFor(_this2.win).promise(3100)]).then(remeasure); // Remeasure the document when all fonts loaded.\n\n      if (_this2.win.document.fonts && _this2.win.document.fonts.status != 'loaded') {\n        _this2.win.document.fonts.ready.then(remeasure);\n      }\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.get = function get() {\n    return this.resources_.slice(0);\n  }\n  /** @override */\n  ;\n\n  _proto.getAmpdoc = function getAmpdoc() {\n    return this.ampdoc;\n  }\n  /** @private */\n  ;\n\n  _proto.monitorInput_ = function monitorInput_() {\n    var _this3 = this;\n\n    var input = _services.Services.inputFor(this.win);\n\n    input.onTouchDetected(function (detected) {\n      _this3.toggleInputClass_('amp-mode-touch', detected);\n    }, true);\n    input.onMouseDetected(function (detected) {\n      _this3.toggleInputClass_('amp-mode-mouse', detected);\n    }, true);\n    input.onKeyboardStateChanged(function (active) {\n      _this3.toggleInputClass_('amp-mode-keyboard-active', active);\n    }, true);\n  }\n  /**\n   * @param {string} clazz\n   * @param {boolean} on\n   * @private\n   */\n  ;\n\n  _proto.toggleInputClass_ = function toggleInputClass_(clazz, on) {\n    var _this4 = this;\n\n    this.ampdoc.waitForBodyOpen().then(function (body) {\n      _this4.vsync_.mutate(function () {\n        body.classList.toggle(clazz, on);\n      });\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.getResourceForElement = function getResourceForElement(element) {\n    return _resource.Resource.forElement(element);\n  }\n  /** @override */\n  ;\n\n  _proto.getResourceForElementOptional = function getResourceForElementOptional(element) {\n    return _resource.Resource.forElementOptional(element);\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollDirection = function getScrollDirection() {\n    return Math.sign(this.lastVelocity_) || 1;\n  }\n  /** @override */\n  ;\n\n  _proto.add = function add(element) {\n    // Ensure the viewport is ready to accept the first element.\n    this.addCount_++;\n\n    if (this.addCount_ == 1) {\n      this.viewport_.ensureReadyForElements();\n    } // First check if the resource is being reparented and if it requires\n    // reconstruction. Only already built elements are eligible.\n\n\n    var resource = _resource.Resource.forElementOptional(element);\n\n    if (resource && resource.getState() != _resource.ResourceState.NOT_BUILT && !element.reconstructWhenReparented()) {\n      resource.requestMeasure();\n      (0, _log.dev)().fine(TAG_, 'resource reused:', resource.debugid);\n    } else {\n      // Create and add a new resource.\n      resource = new _resource.Resource(++this.resourceIdCounter_, element, this);\n      (0, _log.dev)().fine(TAG_, 'resource added:', resource.debugid);\n    }\n\n    this.resources_.push(resource);\n    this.remeasurePass_.schedule(1000);\n  }\n  /**\n   * Limits the number of elements being build in pre-render phase to\n   * a finite number. Returns false if the number has been reached.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isUnderBuildQuota_ = function isUnderBuildQuota_() {\n    // For pre-render we want to limit the amount of CPU used, so we limit\n    // the number of elements build. For pre-render to \"seem complete\"\n    // we only need to build elements in the first viewport. We can't know\n    // which are actually in the viewport (because the decision is pre-layout,\n    // so we use a heuristic instead.\n    // Most documents have 10 or less AMP tags. By building 20 we should not\n    // change the behavior for the vast majority of docs, and almost always\n    // catch everything in the first viewport.\n    return this.buildAttemptsCount_ < 20 || this.ampdoc.hasBeenVisible();\n  }\n  /**\n   * Builds the element if ready to be built, otherwise adds it to pending\n   * resources.\n   * @param {!Resource} resource\n   * @param {boolean=} checkForDupes\n   * @param {boolean=} scheduleWhenBuilt\n   * @param {boolean=} force\n   * @private\n   */\n  ;\n\n  _proto.buildOrScheduleBuildForResource_ = function buildOrScheduleBuildForResource_(resource, checkForDupes, scheduleWhenBuilt, force) {\n    if (checkForDupes === void 0) {\n      checkForDupes = false;\n    }\n\n    if (scheduleWhenBuilt === void 0) {\n      scheduleWhenBuilt = true;\n    }\n\n    if (force === void 0) {\n      force = false;\n    }\n\n    var buildingEnabled = this.isRuntimeOn_ || this.isBuildOn_; // During prerender mode, don't build elements that aren't allowed to be\n    // prerendered. This avoids wasting our prerender build quota.\n    // See isUnderBuildQuota_() for more details.\n\n    var shouldBuildResource = this.ampdoc.getVisibilityState() != _visibilityState.VisibilityState.PRERENDER || resource.prerenderAllowed();\n\n    if (buildingEnabled && shouldBuildResource) {\n      if (this.documentReady_) {\n        // Build resource immediately, the document has already been parsed.\n        this.buildResourceUnsafe_(resource, scheduleWhenBuilt, force);\n      } else if (!resource.isBuilt() && !resource.isBuilding()) {\n        if (!checkForDupes || !this.pendingBuildResources_.includes(resource)) {\n          // Otherwise add to pending resources and try to build any ready ones.\n          this.pendingBuildResources_.push(resource);\n          this.buildReadyResources_(scheduleWhenBuilt);\n        }\n      }\n    }\n  }\n  /**\n   * Builds resources that are ready to be built.\n   * @param {boolean=} scheduleWhenBuilt\n   * @private\n   */\n  ;\n\n  _proto.buildReadyResources_ = function buildReadyResources_(scheduleWhenBuilt) {\n    if (scheduleWhenBuilt === void 0) {\n      scheduleWhenBuilt = true;\n    }\n\n    // Avoid cases where elements add more elements inside of them\n    // and cause an infinite loop of building - see #3354 for details.\n    if (this.isCurrentlyBuildingPendingResources_) {\n      return;\n    }\n\n    try {\n      this.isCurrentlyBuildingPendingResources_ = true;\n      this.buildReadyResourcesUnsafe_(scheduleWhenBuilt);\n    } finally {\n      this.isCurrentlyBuildingPendingResources_ = false;\n    }\n  }\n  /**\n   * @param {boolean=} scheduleWhenBuilt\n   * @private\n   */\n  ;\n\n  _proto.buildReadyResourcesUnsafe_ = function buildReadyResourcesUnsafe_(scheduleWhenBuilt) {\n    if (scheduleWhenBuilt === void 0) {\n      scheduleWhenBuilt = true;\n    }\n\n    // This will loop over all current pending resources and those that\n    // get added by other resources build-cycle, this will make sure all\n    // elements get a chance to be built.\n    for (var i = 0; i < this.pendingBuildResources_.length; i++) {\n      var resource = this.pendingBuildResources_[i];\n\n      if (this.documentReady_ || (0, _dom.hasNextNodeInDocumentOrder)(resource.element, this.ampdoc.getRootNode())) {\n        // Remove resource before build to remove it from the pending list\n        // in either case the build succeed or throws an error.\n        this.pendingBuildResources_.splice(i--, 1);\n        this.buildResourceUnsafe_(resource, scheduleWhenBuilt);\n      }\n    }\n  }\n  /**\n   * @param {!Resource} resource\n   * @param {boolean} schedulePass\n   * @param {boolean=} force\n   * @return {?Promise}\n   * @private\n   */\n  ;\n\n  _proto.buildResourceUnsafe_ = function buildResourceUnsafe_(resource, schedulePass, force) {\n    var _this5 = this;\n\n    if (force === void 0) {\n      force = false;\n    }\n\n    if (!this.isUnderBuildQuota_() && !force && !resource.isBuildRenderBlocking()) {\n      return null;\n    }\n\n    var promise = resource.build();\n\n    if (!promise) {\n      return null;\n    }\n\n    this.buildAttemptsCount_++;\n\n    if (!schedulePass) {\n      return promise;\n    }\n\n    return promise.then(function () {\n      return _this5.schedulePass();\n    }, function (error) {\n      // Build failed: remove the resource. No other state changes are\n      // needed.\n      _this5.removeResource_(resource);\n\n      if (!(0, _error.isBlockedByConsent)(error)) {\n        throw error;\n      }\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.remove = function remove(element) {\n    var resource = _resource.Resource.forElementOptional(element);\n\n    if (!resource) {\n      return;\n    }\n\n    this.removeResource_(resource);\n  }\n  /**\n   * @param {!Resource} resource\n   * @private\n   */\n  ;\n\n  _proto.removeResource_ = function removeResource_(resource) {\n    var index = this.resources_.indexOf(resource);\n\n    if (index != -1) {\n      this.resources_.splice(index, 1);\n    }\n\n    if (resource.isBuilt()) {\n      resource.pauseOnRemove();\n    }\n\n    this.cleanupTasks_(resource,\n    /* opt_removePending */\n    true);\n    (0, _log.dev)().fine(TAG_, 'element removed:', resource.debugid);\n  }\n  /** @override */\n  ;\n\n  _proto.upgraded = function upgraded(element) {\n    var resource = _resource.Resource.forElement(element);\n\n    this.buildOrScheduleBuildForResource_(resource);\n    (0, _log.dev)().fine(TAG_, 'element upgraded:', resource.debugid);\n  }\n  /** @override */\n  ;\n\n  _proto.updateLayoutPriority = function updateLayoutPriority(element, newLayoutPriority) {\n    var resource = _resource.Resource.forElement(element);\n\n    resource.updateLayoutPriority(newLayoutPriority); // Update affected tasks\n\n    this.queue_.forEach(function (task) {\n      if (task.resource == resource) {\n        task.priority = newLayoutPriority;\n      }\n    });\n    this.schedulePass();\n  }\n  /** @override */\n  ;\n\n  _proto.changeSize = function changeSize(element, newHeight, newWidth, opt_callback, opt_newMargins) {\n    this.scheduleChangeSize_(_resource.Resource.forElement(element), newHeight, newWidth, opt_newMargins,\n    /* event */\n    undefined,\n    /* force */\n    true, opt_callback);\n  }\n  /** @override */\n  ;\n\n  _proto.attemptChangeSize = function attemptChangeSize(element, newHeight, newWidth, opt_newMargins, opt_event) {\n    var _this6 = this;\n\n    return new Promise(function (resolve, reject) {\n      _this6.scheduleChangeSize_(_resource.Resource.forElement(element), newHeight, newWidth, opt_newMargins, opt_event,\n      /* force */\n      false, function (success) {\n        if (success) {\n          resolve();\n        } else {\n          reject(new Error('changeSize attempt denied'));\n        }\n      });\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.measureElement = function measureElement(measurer) {\n    return this.vsync_.measurePromise(measurer);\n  }\n  /** @override */\n  ;\n\n  _proto.mutateElement = function mutateElement(element, mutator) {\n    return this.measureMutateElement(element, null, mutator);\n  }\n  /** @override */\n  ;\n\n  _proto.measureMutateElement = function measureMutateElement(element, measurer, mutator) {\n    return this.measureMutateElementResources_(element, measurer, mutator);\n  }\n  /**\n   * Handles element mutation (and measurement) APIs in the Resources system.\n   *\n   * @param {!Element} element\n   * @param {?function()} measurer\n   * @param {function()} mutator\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.measureMutateElementResources_ = function measureMutateElementResources_(element, measurer, mutator) {\n    var _this7 = this;\n\n    var calcRelayoutTop = function calcRelayoutTop() {\n      var box = _this7.viewport_.getLayoutRect(element);\n\n      if (box.width != 0 && box.height != 0) {\n        return box.top;\n      }\n\n      return -1;\n    };\n\n    var relayoutTop = -1; // TODO(jridgewell): support state\n\n    return this.vsync_.runPromise({\n      measure: function measure() {\n        if (measurer) {\n          measurer();\n        }\n\n        relayoutTop = calcRelayoutTop();\n      },\n      mutate: function mutate() {\n        mutator();\n\n        if (element.classList.contains('i-amphtml-element')) {\n          var r = _resource.Resource.forElement(element);\n\n          r.requestMeasure();\n        }\n\n        var ampElements = element.getElementsByClassName('i-amphtml-element');\n\n        for (var i = 0; i < ampElements.length; i++) {\n          var _r = _resource.Resource.forElement(ampElements[i]);\n\n          _r.requestMeasure();\n        }\n\n        if (relayoutTop != -1) {\n          _this7.setRelayoutTop_(relayoutTop);\n        }\n\n        _this7.schedulePass(FOUR_FRAME_DELAY_); // Need to measure again in case the element has become visible or\n        // shifted.\n\n\n        _this7.vsync_.measure(function () {\n          var updatedRelayoutTop = calcRelayoutTop();\n\n          if (updatedRelayoutTop != -1 && updatedRelayoutTop != relayoutTop) {\n            _this7.setRelayoutTop_(updatedRelayoutTop);\n\n            _this7.schedulePass(FOUR_FRAME_DELAY_);\n          }\n\n          _this7.maybeChangeHeight_ = true;\n        });\n      }\n    });\n  }\n  /**\n   * Dirties the cached element measurements after a mutation occurs.\n   *\n   * TODO(jridgewell): This API needs to be audited. Common practice is\n   * to pass the amp-element in as the root even though we are only\n   * mutating children. If the amp-element is passed, we invalidate\n   * everything in the parent layer above it, where only invalidating the\n   * amp-element was necessary (only children were mutated, only\n   * amp-element's scroll box is affected).\n   *\n   * @param {!Element} element\n   */\n  ;\n\n  _proto.dirtyElement = function dirtyElement(element) {\n    var relayoutAll = false;\n    var isAmpElement = element.classList.contains('i-amphtml-element');\n\n    if (isAmpElement) {\n      var r = _resource.Resource.forElement(element);\n\n      this.setRelayoutTop_(r.getLayoutBox().top);\n    } else {\n      relayoutAll = true;\n    }\n\n    this.schedulePass(FOUR_FRAME_DELAY_, relayoutAll);\n  }\n  /** @override */\n  ;\n\n  _proto.attemptCollapse = function attemptCollapse(element) {\n    var _this8 = this;\n\n    return new Promise(function (resolve, reject) {\n      _this8.scheduleChangeSize_(_resource.Resource.forElement(element), 0, 0,\n      /* newMargin */\n      undefined,\n      /* event */\n      undefined,\n      /* force */\n      false, function (success) {\n        if (success) {\n          var resource = _resource.Resource.forElement(element);\n\n          resource.completeCollapse();\n          resolve();\n        } else {\n          reject((0, _log.dev)().createExpectedError('collapse attempt denied'));\n        }\n      });\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.collapseElement = function collapseElement(element) {\n    var box = this.viewport_.getLayoutRect(element);\n\n    var resource = _resource.Resource.forElement(element);\n\n    if (box.width != 0 && box.height != 0) {\n      if ((0, _experiments.isExperimentOn)(this.win, 'dirty-collapse-element')) {\n        this.dirtyElement(element);\n      } else {\n        this.setRelayoutTop_(box.top);\n      }\n    }\n\n    resource.completeCollapse();\n    this.schedulePass(FOUR_FRAME_DELAY_);\n  }\n  /** @override */\n  ;\n\n  _proto.expandElement = function expandElement(element) {\n    var resource = _resource.Resource.forElement(element);\n\n    resource.completeExpand();\n    var owner = resource.getOwner();\n\n    if (owner) {\n      owner.expandedCallback(element);\n    }\n\n    this.schedulePass(FOUR_FRAME_DELAY_);\n  }\n  /** @override */\n  ;\n\n  _proto.schedulePass = function schedulePass(opt_delay, opt_relayoutAll) {\n    if (opt_relayoutAll) {\n      this.relayoutAll_ = true;\n    }\n\n    return this.pass_.schedule(opt_delay);\n  }\n  /**\n   * Schedules the work pass at the latest with the specified delay.\n   * @private\n   */\n  ;\n\n  _proto.schedulePassVsync_ = function schedulePassVsync_() {\n    var _this9 = this;\n\n    if (this.vsyncScheduled_) {\n      return;\n    }\n\n    this.vsyncScheduled_ = true;\n    this.vsync_.mutate(function () {\n      return _this9.doPass();\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.ampInitComplete = function ampInitComplete() {\n    this.ampInitialized_ = true;\n    this.schedulePass();\n  }\n  /** @override */\n  ;\n\n  _proto.onNextPass = function onNextPass(callback) {\n    this.passCallbacks_.push(callback);\n  }\n  /**\n   * Runs a pass immediately.\n   *\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.doPass = function doPass() {\n    var _this10 = this;\n\n    if (!this.isRuntimeOn_) {\n      (0, _log.dev)().fine(TAG_, 'runtime is off');\n      return;\n    }\n\n    this.visible_ = this.ampdoc.isVisible();\n    this.prerenderSize_ = this.viewer_.getPrerenderSize();\n    var firstPassAfterDocumentReady = this.documentReady_ && this.firstPassAfterDocumentReady_;\n\n    if (firstPassAfterDocumentReady) {\n      this.firstPassAfterDocumentReady_ = false;\n      var doc = this.win.document;\n\n      var documentInfo = _services.Services.documentInfoForDoc(this.ampdoc);\n\n      this.viewer_.sendMessage('documentLoaded', (0, _object.dict)({\n        'title': doc.title,\n        'sourceUrl': (0, _url.getSourceUrl)(this.ampdoc.getUrl()),\n        'serverLayout': doc.documentElement.hasAttribute('i-amphtml-element'),\n        'linkRels': documentInfo.linkRels,\n        'metaTags': documentInfo.metaTags\n      }),\n      /* cancelUnsent */\n      true);\n      this.contentHeight_ = this.viewport_.getContentHeight();\n      this.viewer_.sendMessage('documentHeight', (0, _object.dict)({\n        'height': this.contentHeight_\n      }),\n      /* cancelUnsent */\n      true);\n      (0, _log.dev)().fine(TAG_, 'document height on load: %s', this.contentHeight_);\n    }\n\n    var viewportSize = this.viewport_.getSize();\n    (0, _log.dev)().fine(TAG_, 'PASS: visible=', this.visible_, ', relayoutAll=', this.relayoutAll_, ', relayoutTop=', this.relayoutTop_, ', viewportSize=', viewportSize.width, viewportSize.height, ', prerenderSize=', this.prerenderSize_);\n    this.pass_.cancel();\n    this.vsyncScheduled_ = false;\n    this.visibilityStateMachine_.setState(this.ampdoc.getVisibilityState());\n\n    if (this.documentReady_ && this.ampInitialized_ && !this.ampdoc.signals().get(_resourcesInterface.READY_SCAN_SIGNAL)) {\n      // This signal mainly signifies that most of elements have been measured\n      // by now. This is mostly used to avoid measuring too many elements\n      // individually. This will be superceeded by layers API, e.g.\n      // \"layer measured\".\n      // May not be called in shadow mode.\n      this.ampdoc.signals().signal(_resourcesInterface.READY_SCAN_SIGNAL);\n    }\n\n    if (this.maybeChangeHeight_) {\n      this.maybeChangeHeight_ = false;\n      this.vsync_.measure(function () {\n        var measuredContentHeight = _this10.viewport_.getContentHeight();\n\n        if (measuredContentHeight != _this10.contentHeight_) {\n          _this10.viewer_.sendMessage('documentHeight', (0, _object.dict)({\n            'height': measuredContentHeight\n          }),\n          /* cancelUnsent */\n          true);\n\n          _this10.contentHeight_ = measuredContentHeight;\n          (0, _log.dev)().fine(TAG_, 'document height changed: %s', _this10.contentHeight_);\n\n          _this10.viewport_.contentHeightChanged();\n        }\n      });\n    }\n\n    for (var i = 0; i < this.passCallbacks_.length; i++) {\n      var fn = this.passCallbacks_[i];\n      fn();\n    }\n\n    this.passCallbacks_.length = 0;\n  }\n  /**\n   * Returns `true` when there's mutate work currently batched.\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.hasMutateWork_ = function hasMutateWork_() {\n    return this.requestsChangeSize_.length > 0;\n  }\n  /**\n   * Performs pre-discovery mutates.\n   * @private\n   */\n  ;\n\n  _proto.mutateWork_ = function mutateWork_() {\n    var _this11 = this;\n\n    // Read all necessary data before mutates.\n    // The height changing depends largely on the target element's position\n    // in the active viewport. When not in prerendering, we also consider the\n    // active viewport the part of the visible viewport below 10% from the top\n    // and above 25% from the bottom.\n    // This is basically the portion of the viewport where the reader is most\n    // likely focused right now. The main goal is to avoid drastic UI changes\n    // in that part of the content. The elements below the active viewport are\n    // freely resized. The elements above the viewport are resized and request\n    // scroll adjustment to avoid active viewport changing without user's\n    // action. The elements in the active viewport are not resized and instead\n    // the overflow callbacks are called.\n    var now = Date.now();\n    var viewportRect = this.viewport_.getRect();\n    var topOffset = viewportRect.height / 10;\n    var bottomOffset = viewportRect.height / 10;\n    var isScrollingStopped = Math.abs(this.lastVelocity_) < 1e-2 && now - this.lastScrollTime_ > MUTATE_DEFER_DELAY_ || now - this.lastScrollTime_ > MUTATE_DEFER_DELAY_ * 2; // TODO(jridgewell, #12780): Update resize rules to account for layers.\n\n    if (this.requestsChangeSize_.length > 0) {\n      (0, _log.dev)().fine(TAG_, 'change size requests:', this.requestsChangeSize_.length);\n      var requestsChangeSize = this.requestsChangeSize_;\n      this.requestsChangeSize_ = []; // Find minimum top position and run all mutates.\n\n      var minTop = -1;\n      var scrollAdjSet = [];\n      var aboveVpHeightChange = 0;\n\n      for (var i = 0; i < requestsChangeSize.length; i++) {\n        var request = requestsChangeSize[i];\n        var resource =\n        /** @type {!ChangeSizeRequestDef} */\n        request.resource,\n            event = request.event;\n        var box = resource.getLayoutBox();\n        var topMarginDiff = 0;\n        var bottomMarginDiff = 0;\n        var leftMarginDiff = 0;\n        var rightMarginDiff = 0;\n        var topUnchangedBoundary = box.top,\n            bottomDisplacedBoundary = box.bottom;\n        var newMargins = undefined;\n\n        if (request.marginChange) {\n          newMargins = request.marginChange.newMargins;\n          var margins = request.marginChange.currentMargins;\n\n          if (newMargins.top != undefined) {\n            topMarginDiff = newMargins.top - margins.top;\n          }\n\n          if (newMargins.bottom != undefined) {\n            bottomMarginDiff = newMargins.bottom - margins.bottom;\n          }\n\n          if (newMargins.left != undefined) {\n            leftMarginDiff = newMargins.left - margins.left;\n          }\n\n          if (newMargins.right != undefined) {\n            rightMarginDiff = newMargins.right - margins.right;\n          }\n\n          if (topMarginDiff) {\n            topUnchangedBoundary = box.top - margins.top;\n          }\n\n          if (bottomMarginDiff) {\n            // The lowest boundary of the element that would appear to be\n            // resized as a result of this size change. If the bottom margin is\n            // being changed then it is the bottom edge of the margin box,\n            // otherwise it is the bottom edge of the layout box as set above.\n            bottomDisplacedBoundary = box.bottom + margins.bottom;\n          }\n        }\n\n        var heightDiff = request.newHeight - box.height;\n        var widthDiff = request.newWidth - box.width; // Check resize rules. It will either resize element immediately, or\n        // wait until scrolling stops or will call the overflow callback.\n\n        var resize = false;\n\n        if (heightDiff == 0 && topMarginDiff == 0 && bottomMarginDiff == 0 && widthDiff == 0 && leftMarginDiff == 0 && rightMarginDiff == 0) {// 1. Nothing to resize.\n        } else if (request.force || !this.visible_) {\n          // 2. An immediate execution requested or the document is hidden.\n          resize = true;\n        } else if (this.activeHistory_.hasDescendantsOf(resource.element) || event && event.userActivation && event.userActivation.hasBeenActive) {\n          // 3. Active elements are immediately resized. The assumption is that\n          // the resize is triggered by the user action or soon after.\n          resize = true;\n        } else if (topUnchangedBoundary >= viewportRect.bottom - bottomOffset || topMarginDiff == 0 && box.bottom + Math.min(heightDiff, 0) >= viewportRect.bottom - bottomOffset) {\n          // 4. Elements under viewport are resized immediately, but only if\n          // an element's boundary is not changed above the viewport after\n          // resize.\n          resize = true;\n        } else if (viewportRect.top > 1 && bottomDisplacedBoundary <= viewportRect.top + topOffset) {\n          // 5. Elements above the viewport can only be resized if we are able\n          // to compensate the height change by setting scrollTop and only if\n          // the page has already been scrolled by some amount (1px due to iOS).\n          // Otherwise the scrolling might move important things like the menu\n          // bar out of the viewport at initial page load.\n          if (heightDiff < 0 && viewportRect.top + aboveVpHeightChange < -heightDiff) {\n            // Do nothing if height abobe viewport height can't compensate\n            // height decrease\n            continue;\n          } // Can only resized when scrollinghas stopped,\n          // otherwise defer util next cycle.\n\n\n          if (isScrollingStopped) {\n            // These requests will be executed in the next animation cycle and\n            // adjust the scroll position.\n            aboveVpHeightChange = aboveVpHeightChange + heightDiff;\n            scrollAdjSet.push(request);\n          } else {\n            // Defer till next cycle.\n            this.requestsChangeSize_.push(request);\n          }\n\n          continue;\n        } else if (this.elementNearBottom_(resource, box)) {\n          // 6. Elements close to the bottom of the document (not viewport)\n          // are resized immediately.\n          resize = true;\n        } else if (heightDiff < 0 || topMarginDiff < 0 || bottomMarginDiff < 0) {// 7. The new height (or one of the margins) is smaller than the\n          // current one.\n        } else if (request.newHeight == box.height && this.isWidthOnlyReflowFreeExpansion_(resource.element, request.newWidth || 0)) {\n          // 8. Element is in viewport, but this is a width-only expansion that\n          // should not cause reflow.\n          resize = true;\n        } else {\n          // 9. Element is in viewport don't resize and try overflow callback\n          // instead.\n          request.resource.overflowCallback(\n          /* overflown */\n          true, request.newHeight, request.newWidth, newMargins);\n        }\n\n        if (resize) {\n          if (box.top >= 0) {\n            minTop = minTop == -1 ? box.top : Math.min(minTop, box.top);\n          }\n\n          request.resource.\n          /*OK*/\n          changeSize(request.newHeight, request.newWidth, newMargins);\n          request.resource.overflowCallback(\n          /* overflown */\n          false, request.newHeight, request.newWidth, newMargins);\n          this.maybeChangeHeight_ = true;\n        }\n\n        if (request.callback) {\n          request.callback(\n          /* hasSizeChanged */\n          resize);\n        }\n      }\n\n      if (minTop != -1) {\n        this.setRelayoutTop_(minTop);\n      } // Execute scroll-adjusting resize requests, if any.\n\n\n      if (scrollAdjSet.length > 0) {\n        this.vsync_.run({\n          measure: function measure(state) {\n            state.\n            /*OK*/\n            scrollHeight = _this11.viewport_.\n            /*OK*/\n            getScrollHeight();\n            state.\n            /*OK*/\n            scrollTop = _this11.viewport_.\n            /*OK*/\n            getScrollTop();\n          },\n          mutate: function mutate(state) {\n            var minTop = -1;\n            scrollAdjSet.forEach(function (request) {\n              var box = request.resource.getLayoutBox();\n              minTop = minTop == -1 ? box.top : Math.min(minTop, box.top);\n              request.resource.\n              /*OK*/\n              changeSize(request.newHeight, request.newWidth, request.marginChange ? request.marginChange.newMargins : undefined);\n\n              if (request.callback) {\n                request.callback(\n                /* hasSizeChanged */\n                true);\n              }\n            });\n\n            if (minTop != -1) {\n              _this11.setRelayoutTop_(minTop);\n            } // Sync is necessary here to avoid UI jump in the next frame.\n\n\n            var newScrollHeight = _this11.viewport_.\n            /*OK*/\n            getScrollHeight();\n\n            if (newScrollHeight != state.\n            /*OK*/\n            scrollHeight) {\n              _this11.viewport_.setScrollTop(state.\n              /*OK*/\n              scrollTop + (newScrollHeight - state.\n              /*OK*/\n              scrollHeight));\n            }\n\n            _this11.maybeChangeHeight_ = true;\n          }\n        }, {});\n      }\n    }\n  }\n  /**\n   * Returns true if reflow will not be caused by expanding the given element's\n   * width to the given amount.\n   * @param {!Element} element\n   * @param {number} width\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isWidthOnlyReflowFreeExpansion_ = function isWidthOnlyReflowFreeExpansion_(element, width) {\n    var parent = element.parentElement; // If the element has siblings, it's possible that a width-expansion will\n    // cause some of them to be pushed down.\n\n    if (!parent || parent.childElementCount > 1) {\n      return false;\n    }\n\n    var parentWidth = parent.getImpl && parent.getImpl().getLayoutWidth() || -1; // Reflow will not happen if the parent element is at least as wide as the\n    // new width.\n\n    return parentWidth >= width;\n  }\n  /**\n   * Returns true if element is within 15% and 1000px of document bottom.\n   * Caller can provide current/initial layout boxes as an optimization.\n   * @param {!./resource.Resource} resource\n   * @param {!../layout-rect.LayoutRectDef=} opt_layoutBox\n   * @param {!../layout-rect.LayoutRectDef=} opt_initialLayoutBox\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.elementNearBottom_ = function elementNearBottom_(resource, opt_layoutBox, opt_initialLayoutBox) {\n    var contentHeight = this.viewport_.getContentHeight();\n    var threshold = Math.max(contentHeight * 0.85, contentHeight - 1000);\n    var box = opt_layoutBox || resource.getLayoutBox();\n    var initialBox = opt_initialLayoutBox || resource.getInitialLayoutBox();\n    return box.bottom >= threshold || initialBox.bottom >= threshold;\n  }\n  /**\n   * @param {number} relayoutTop\n   * @private\n   */\n  ;\n\n  _proto.setRelayoutTop_ = function setRelayoutTop_(relayoutTop) {\n    if (this.relayoutTop_ == -1) {\n      this.relayoutTop_ = relayoutTop;\n    } else {\n      this.relayoutTop_ = Math.min(relayoutTop, this.relayoutTop_);\n    }\n  }\n  /**\n   * Reschedules change size request when an overflown element is activated.\n   * @param {!Element} element\n   * @private\n   */\n  ;\n\n  _proto.checkPendingChangeSize_ = function checkPendingChangeSize_(element) {\n    var resourceElement = (0, _dom.closest)(element, function (el) {\n      return !!_resource.Resource.forElementOptional(el);\n    });\n\n    if (!resourceElement) {\n      return;\n    }\n\n    var resource = _resource.Resource.forElement(resourceElement);\n\n    var pendingChangeSize = resource.getPendingChangeSize();\n\n    if (pendingChangeSize !== undefined) {\n      this.scheduleChangeSize_(resource, pendingChangeSize.height, pendingChangeSize.width, pendingChangeSize.margins,\n      /* event */\n      undefined,\n      /* force */\n      true);\n    }\n  }\n  /**\n   * Discovers work that needs to be done since the last pass. If viewport\n   * has changed, it will try to build new elements, measure changed elements,\n   * and schedule layouts and preloads within a reasonable distance of the\n   * current viewport. Finally, this process also updates inViewport state\n   * of changed elements.\n   *\n   * Layouts and preloads are not executed immediately, but instead scheduled\n   * in the queue with different priorities.\n   *\n   * @private\n   */\n  ;\n\n  _proto.discoverWork_ = function discoverWork_() {\n    var _this12 = this;\n\n    // TODO(dvoytenko): vsync separation may be needed for different phases\n    var now = Date.now(); // Ensure all resources layout phase complete; when relayoutAll is requested\n    // force re-layout.\n\n    var relayoutAll = this.relayoutAll_;\n    this.relayoutAll_ = false;\n    var relayoutTop = this.relayoutTop_;\n    this.relayoutTop_ = -1; // Phase 1: Build and relayout as needed. All mutations happen here.\n\n    var relayoutCount = 0;\n    var remeasureCount = 0;\n\n    for (var i = 0; i < this.resources_.length; i++) {\n      var r = this.resources_[i];\n\n      if (r.getState() == _resource.ResourceState.NOT_BUILT && !r.isBuilding()) {\n        this.buildOrScheduleBuildForResource_(r,\n        /* checkForDupes */\n        true);\n      }\n\n      if (relayoutAll || !r.hasBeenMeasured() || r.getState() == _resource.ResourceState.NOT_LAID_OUT) {\n        r.applySizesAndMediaQuery();\n        relayoutCount++;\n      }\n\n      if (r.isMeasureRequested()) {\n        remeasureCount++;\n      }\n    } // Phase 2: Remeasure if there were any relayouts. Unfortunately, currently\n    // there's no way to optimize this. All reads happen here.\n\n\n    var toUnload;\n\n    if (relayoutCount > 0 || remeasureCount > 0 || relayoutAll || relayoutTop != -1) {\n      for (var _i = 0; _i < this.resources_.length; _i++) {\n        var _r2 = this.resources_[_i];\n\n        if (_r2.hasOwner() && !_r2.isMeasureRequested()) {\n          // If element has owner, and measure is not requested, do nothing.\n          continue;\n        }\n\n        if (relayoutAll || _r2.getState() == _resource.ResourceState.NOT_LAID_OUT || !_r2.hasBeenMeasured() || _r2.isMeasureRequested() || relayoutTop != -1 && _r2.getLayoutBox().bottom >= relayoutTop) {\n          var wasDisplayed = _r2.isDisplayed();\n\n          _r2.measure();\n\n          if (wasDisplayed && !_r2.isDisplayed()) {\n            if (!toUnload) {\n              toUnload = [];\n            }\n\n            toUnload.push(_r2);\n          }\n        }\n      }\n    } // Unload all in one cycle.\n\n\n    if (toUnload) {\n      this.vsync_.mutate(function () {\n        toUnload.forEach(function (r) {\n          r.unload();\n\n          _this12.cleanupTasks_(r);\n        });\n      });\n    }\n\n    var viewportRect = this.viewport_.getRect(); // Load viewport = viewport + 3x up/down when document is visible or\n    // depending on prerenderSize in pre-render mode.\n\n    var loadRect;\n\n    if (this.visible_) {\n      loadRect = (0, _layoutRect.expandLayoutRect)(viewportRect, 0.25, 2);\n    } else if (this.prerenderSize_ > 0) {\n      loadRect = (0, _layoutRect.expandLayoutRect)(viewportRect, 0, this.prerenderSize_ - 1);\n    } else {\n      loadRect = null;\n    }\n\n    var visibleRect = this.visible_ ? // When the doc is visible, consider the viewport to be 25% larger,\n    // to minimize effect from small scrolling and notify things that\n    // they are in viewport just before they are actually visible.\n    (0, _layoutRect.expandLayoutRect)(viewportRect, 0.25, 0.25) : viewportRect; // Phase 3: Trigger \"viewport enter/exit\" events.\n\n    for (var _i2 = 0; _i2 < this.resources_.length; _i2++) {\n      var _r3 = this.resources_[_i2];\n\n      if (_r3.getState() == _resource.ResourceState.NOT_BUILT || _r3.hasOwner()) {\n        continue;\n      } // Note that when the document is not visible, neither are any of its\n      // elements to reduce CPU cycles.\n      // TODO(dvoytenko, #3434): Reimplement the use of `isFixed` with\n      // layers. This is currently a short-term fix to the problem that\n      // the fixed elements get incorrect top coord.\n\n\n      var shouldBeInViewport = this.visible_ && _r3.isDisplayed() && _r3.overlaps(visibleRect);\n\n      _r3.setInViewport(shouldBeInViewport);\n    } // Phase 4: Schedule elements for layout within a reasonable distance from\n    // current viewport.\n\n\n    if (loadRect) {\n      for (var _i3 = 0; _i3 < this.resources_.length; _i3++) {\n        var _r4 = this.resources_[_i3]; // TODO(dvoytenko): This extra build has to be merged with the\n        // scheduleLayoutOrPreload method below.\n        // Force build for all resources visible, measured, and in the viewport.\n\n        if (!_r4.isBuilt() && !_r4.hasOwner() && _r4.hasBeenMeasured() && _r4.isDisplayed() && _r4.overlaps(loadRect)) {\n          this.buildOrScheduleBuildForResource_(_r4,\n          /* checkForDupes */\n          true,\n          /* scheduleWhenBuilt */\n          undefined,\n          /* force */\n          true);\n        }\n\n        if (_r4.getState() != _resource.ResourceState.READY_FOR_LAYOUT || _r4.hasOwner()) {\n          continue;\n        } // TODO(dvoytenko, #3434): Reimplement the use of `isFixed` with\n        // layers. This is currently a short-term fix to the problem that\n        // the fixed elements get incorrect top coord.\n\n\n        if (_r4.isDisplayed() && _r4.overlaps(loadRect)) {\n          this.scheduleLayoutOrPreload(_r4,\n          /* layout */\n          true);\n        }\n      }\n    }\n\n    if (this.visible_ && this.exec_.getSize() == 0 && this.queue_.getSize() == 0 && now > this.exec_.getLastDequeueTime() + 5000) {\n      // Phase 5: Idle Render Outside Viewport layout: layout up to 4 items\n      // with idleRenderOutsideViewport true\n      var idleScheduledCount = 0;\n\n      for (var _i4 = 0; _i4 < this.resources_.length && idleScheduledCount < 4; _i4++) {\n        var _r5 = this.resources_[_i4];\n\n        if (_r5.getState() == _resource.ResourceState.READY_FOR_LAYOUT && !_r5.hasOwner() && _r5.isDisplayed() && _r5.idleRenderOutsideViewport()) {\n          (0, _log.dev)().fine(TAG_, 'idleRenderOutsideViewport layout:', _r5.debugid);\n          this.scheduleLayoutOrPreload(_r5,\n          /* layout */\n          false);\n          idleScheduledCount++;\n        }\n      } // Phase 6: Idle layout: layout more if we are otherwise not doing much.\n      // TODO(dvoytenko): document/estimate IDLE timeouts and other constants\n\n\n      for (var _i5 = 0; _i5 < this.resources_.length && idleScheduledCount < 4; _i5++) {\n        var _r6 = this.resources_[_i5];\n\n        if (_r6.getState() == _resource.ResourceState.READY_FOR_LAYOUT && !_r6.hasOwner() && _r6.isDisplayed()) {\n          (0, _log.dev)().fine(TAG_, 'idle layout:', _r6.debugid);\n          this.scheduleLayoutOrPreload(_r6,\n          /* layout */\n          false);\n          idleScheduledCount++;\n        }\n      }\n    }\n  }\n  /**\n   * Dequeues layout and preload tasks from the queue and initiates their\n   * execution.\n   *\n   * There are two main drivers to dequeueing: a task's score and timeout. The\n   * score is built based on the resource's priority and viewport location\n   * (see {@link calcTaskScore_}). Timeout depends on the priority and age\n   * of tasks currently in the execution pool (see {@link calcTaskTimeout_}).\n   *\n   * @return {!time}\n   * @private\n   */\n  ;\n\n  _proto.work_ = function work_() {\n    var now = Date.now();\n    var timeout = -1;\n    var state = Object.create(null);\n    var task = this.queue_.peek(this.boundTaskScorer_, state);\n\n    while (task) {\n      timeout = this.calcTaskTimeout_(task);\n      (0, _log.dev)().fine(TAG_, 'peek from queue:', task.id, 'sched at', task.scheduleTime, 'score', this.boundTaskScorer_(task, state), 'timeout', timeout);\n\n      if (timeout > 16) {\n        break;\n      }\n\n      this.queue_.dequeue(task); // Do not override a task in execution. This task will have to wait\n      // until the current one finished the execution.\n\n      var executing = this.exec_.getTaskById(task.id);\n\n      if (executing) {\n        // Reschedule post execution.\n        var reschedule = this.reschedule_.bind(this, task);\n        executing.promise.then(reschedule, reschedule);\n      } else {\n        task.resource.measure();\n\n        if (this.isLayoutAllowed_(task.resource, task.forceOutsideViewport)) {\n          task.promise = task.callback();\n          task.startTime = now;\n          (0, _log.dev)().fine(TAG_, 'exec:', task.id, 'at', task.startTime);\n          this.exec_.enqueue(task);\n          task.promise.then(this.taskComplete_.bind(this, task, true), this.taskComplete_.bind(this, task, false)).catch(\n          /** @type {function (*)} */\n          _error.reportError);\n        } else {\n          (0, _log.dev)().fine(TAG_, 'cancelled', task.id);\n          task.resource.layoutCanceled();\n        }\n      }\n\n      task = this.queue_.peek(this.boundTaskScorer_, state);\n      timeout = -1;\n    }\n\n    (0, _log.dev)().fine(TAG_, 'queue size:', this.queue_.getSize());\n    (0, _log.dev)().fine(TAG_, 'exec size:', this.exec_.getSize());\n\n    if (timeout >= 0) {\n      // Still tasks in the queue, but we took too much time.\n      // Schedule the next work pass.\n      return timeout;\n    } // No tasks left in the queue.\n    // Schedule the next idle pass.\n\n\n    var nextPassDelay = (now - this.exec_.getLastDequeueTime()) * 2;\n    nextPassDelay = Math.max(Math.min(30000, nextPassDelay), 5000);\n    return nextPassDelay;\n  }\n  /**\n   * Calculates the task's score. A task with the lowest score will be dequeued\n   * from the queue the first.\n   *\n   * There are three components of the score: element's priority, operation or\n   * offset priority and viewport priority.\n   *\n   * Element's priority is constant of the element's name. E.g. amp-img has a\n   * priority of 0, while amp-ad has a priority of 2.\n   *\n   * The operation (offset) priority is the priority of the task. A layout is\n   * a high-priority task while preload is a lower-priority task.\n   *\n   * Viewport priority is a function of the distance of the element from the\n   * currently visible viewports. The elements in the visible viewport get\n   * higher priority and further away from the viewport get lower priority.\n   * This priority also depends on whether or not the user is scrolling towards\n   * this element or away from it.\n   *\n   * @param {!./task-queue.TaskDef} task\n   * @param {!Object<string, *>} unusedCache\n   * @return {number}\n   * @private\n   */\n  ;\n\n  _proto.calcTaskScore_ = function calcTaskScore_(task, unusedCache) {\n    // TODO(jridgewell): these should be taking into account the active\n    // scroller, which may not be the root scroller. Maybe a weighted average\n    // of \"scroller scrolls necessary\" to see the element.\n    // Demo at https://output.jsbin.com/hicigom/quiet\n    var viewport = this.viewport_.getRect();\n    var box = task.resource.getLayoutBox();\n    var posPriority = Math.floor((box.top - viewport.top) / viewport.height);\n\n    if (Math.sign(posPriority) != this.getScrollDirection()) {\n      posPriority *= 2;\n    }\n\n    posPriority = Math.abs(posPriority);\n    return task.priority * PRIORITY_BASE_ + posPriority;\n  }\n  /**\n   * Calculates the timeout of a task. The timeout depends on two main factors:\n   * the priorities of the tasks currently in the execution pool and their age.\n   * The timeout is calculated against each task in the execution pool and the\n   * maximum value is returned.\n   *\n   * A task is penalized with higher timeout values when it's lower in priority\n   * than the task in the execution pool. However, this penalty is judged\n   * against the age of the executing task. If it has been in executing for\n   * some time, the penalty is reduced.\n   *\n   * @param {!./task-queue.TaskDef} task\n   * @private\n   */\n  ;\n\n  _proto.calcTaskTimeout_ = function calcTaskTimeout_(task) {\n    var now = Date.now();\n\n    if (this.exec_.getSize() == 0) {\n      // If we've never been visible, return 0. This follows the previous\n      // behavior of not delaying tasks when there's nothing to do.\n      if (this.firstVisibleTime_ === -1) {\n        return 0;\n      } // Scale off the first visible time, so penalized tasks must wait a\n      // second or two to run. After we have been visible for a time, we no\n      // longer have to wait.\n\n\n      var penalty = task.priority * PRIORITY_PENALTY_TIME_;\n      return Math.max(penalty - (now - this.firstVisibleTime_), 0);\n    }\n\n    var timeout = 0;\n    this.exec_.forEach(function (other) {\n      // Higher priority tasks get the head start. Currently 500ms per a drop\n      // in priority (note that priority is 10-based).\n      var penalty = Math.max((task.priority - other.priority) * PRIORITY_PENALTY_TIME_, 0); // TODO(dvoytenko): Consider running total and not maximum.\n\n      timeout = Math.max(timeout, penalty - (now - other.startTime));\n    });\n    return timeout;\n  }\n  /**\n   * @param {!./task-queue.TaskDef} task\n   * @private\n   */\n  ;\n\n  _proto.reschedule_ = function reschedule_(task) {\n    if (!this.queue_.getTaskById(task.id)) {\n      this.queue_.enqueue(task);\n    }\n  }\n  /**\n   * @param {!./task-queue.TaskDef} task\n   * @param {boolean} success\n   * @param {*=} opt_reason\n   * @return {!Promise|undefined}\n   * @private\n   */\n  ;\n\n  _proto.taskComplete_ = function taskComplete_(task, success, opt_reason) {\n    this.exec_.dequeue(task);\n    this.schedulePass(POST_TASK_PASS_DELAY_);\n\n    if (!success) {\n      (0, _log.dev)().info(TAG_, 'task failed:', task.id, task.resource.debugid, opt_reason);\n      return Promise.reject(opt_reason);\n    }\n  }\n  /**\n   * Schedules change of the element's height.\n   * @param {!Resource} resource\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef|undefined} newMargins\n   * @param {?Event|undefined} event\n   * @param {boolean} force\n   * @param {function(boolean)=} opt_callback A callback function\n   * @private\n   */\n  ;\n\n  _proto.scheduleChangeSize_ = function scheduleChangeSize_(resource, newHeight, newWidth, newMargins, event, force, opt_callback) {\n    var _this13 = this;\n\n    if (resource.hasBeenMeasured() && !newMargins) {\n      this.completeScheduleChangeSize_(resource, newHeight, newWidth, undefined, event, force, opt_callback);\n    } else {\n      // This is a rare case since most of times the element itself schedules\n      // resize requests. However, this case is possible when another element\n      // requests resize of a controlled element. This also happens when a\n      // margin size change is requested, since existing margins have to be\n      // measured in this instance.\n      this.vsync_.measure(function () {\n        if (!resource.hasBeenMeasured()) {\n          resource.measure();\n        }\n\n        var marginChange = newMargins ? {\n          newMargins: newMargins,\n          currentMargins: _this13.getLayoutMargins_(resource)\n        } : undefined;\n\n        _this13.completeScheduleChangeSize_(resource, newHeight, newWidth, marginChange, event, force, opt_callback);\n      });\n    }\n  }\n  /**\n   * Returns the layout margins for the resource.\n   * @param {!Resource} resource\n   * @return {!../layout-rect.LayoutMarginsDef}\n   * @private\n   */\n  ;\n\n  _proto.getLayoutMargins_ = function getLayoutMargins_(resource) {\n    var style = (0, _style.computedStyle)(this.win, resource.element);\n    return {\n      top: parseInt(style.marginTop, 10) || 0,\n      right: parseInt(style.marginRight, 10) || 0,\n      bottom: parseInt(style.marginBottom, 10) || 0,\n      left: parseInt(style.marginLeft, 10) || 0\n    };\n  }\n  /**\n   * @param {!Resource} resource\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!MarginChangeDef|undefined} marginChange\n   * @param {?Event|undefined} event\n   * @param {boolean} force\n   * @param {function(boolean)=} opt_callback A callback function\n   * @private\n   */\n  ;\n\n  _proto.completeScheduleChangeSize_ = function completeScheduleChangeSize_(resource, newHeight, newWidth, marginChange, event, force, opt_callback) {\n    resource.resetPendingChangeSize();\n    var layoutBox = resource.getPageLayoutBox();\n\n    if ((newHeight === undefined || newHeight == layoutBox.height) && (newWidth === undefined || newWidth == layoutBox.width) && (marginChange === undefined || !(0, _layoutRect.areMarginsChanged)(marginChange.currentMargins, marginChange.newMargins))) {\n      if (newHeight === undefined && newWidth === undefined && marginChange === undefined) {\n        (0, _log.dev)().error(TAG_, 'attempting to change size with undefined dimensions', resource.debugid);\n      } // Nothing to do.\n\n\n      if (opt_callback) {\n        opt_callback(\n        /* success */\n        true);\n      }\n\n      return;\n    }\n\n    var request = null;\n\n    for (var i = 0; i < this.requestsChangeSize_.length; i++) {\n      if (this.requestsChangeSize_[i].resource == resource) {\n        request = this.requestsChangeSize_[i];\n        break;\n      }\n    }\n\n    if (request) {\n      request.newHeight = newHeight;\n      request.newWidth = newWidth;\n      request.marginChange = marginChange;\n      request.event = event;\n      request.force = force || request.force;\n      request.callback = opt_callback;\n    } else {\n      this.requestsChangeSize_.push(\n      /** {!ChangeSizeRequestDef} */\n      {\n        resource: resource,\n        newHeight: newHeight,\n        newWidth: newWidth,\n        marginChange: marginChange,\n        event: event,\n        force: force,\n        callback: opt_callback\n      });\n    }\n\n    this.schedulePassVsync_();\n  }\n  /**\n   * Returns whether the resource should be preloaded at this time.\n   * The element must be measured by this time.\n   * @param {!Resource} resource\n   * @param {boolean} forceOutsideViewport\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.isLayoutAllowed_ = function isLayoutAllowed_(resource, forceOutsideViewport) {\n    // Only built and displayed elements can be loaded.\n    if (resource.getState() == _resource.ResourceState.NOT_BUILT || !resource.isDisplayed()) {\n      return false;\n    } // Don't schedule elements when we're not visible, or in prerender mode\n    // (and they can't prerender).\n\n\n    if (!this.visible_) {\n      if (this.ampdoc.getVisibilityState() != _visibilityState.VisibilityState.PRERENDER || !resource.prerenderAllowed()) {\n        return false;\n      }\n    } // The element has to be in its rendering corridor.\n\n\n    if (!forceOutsideViewport && !resource.isInViewport() && !resource.renderOutsideViewport() && !resource.idleRenderOutsideViewport()) {\n      return false;\n    }\n\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.scheduleLayoutOrPreload = function scheduleLayoutOrPreload(resource, layout, opt_parentPriority, opt_forceOutsideViewport) {\n    (0, _log.devAssert)(resource.getState() != _resource.ResourceState.NOT_BUILT && resource.isDisplayed(), 'Not ready for layout: %s (%s)', resource.debugid, resource.getState());\n    var forceOutsideViewport = opt_forceOutsideViewport || false;\n\n    if (!this.isLayoutAllowed_(resource, forceOutsideViewport)) {\n      return;\n    }\n\n    if (layout) {\n      this.schedule_(resource, LAYOUT_TASK_ID_, LAYOUT_TASK_OFFSET_, opt_parentPriority || 0, forceOutsideViewport, resource.startLayout.bind(resource));\n    } else {\n      this.schedule_(resource, PRELOAD_TASK_ID_, PRELOAD_TASK_OFFSET_, opt_parentPriority || 0, forceOutsideViewport, resource.startLayout.bind(resource));\n    }\n  }\n  /**\n   * Schedules a task.\n   * @param {!Resource} resource\n   * @param {string} localId\n   * @param {number} priorityOffset\n   * @param {number} parentPriority\n   * @param {boolean} forceOutsideViewport\n   * @param {function():!Promise} callback\n   * @private\n   */\n  ;\n\n  _proto.schedule_ = function schedule_(resource, localId, priorityOffset, parentPriority, forceOutsideViewport, callback) {\n    var taskId = resource.getTaskId(localId);\n    var task = {\n      id: taskId,\n      resource: resource,\n      priority: Math.max(resource.getLayoutPriority(), parentPriority) + priorityOffset,\n      forceOutsideViewport: forceOutsideViewport,\n      callback: callback,\n      scheduleTime: Date.now(),\n      startTime: 0,\n      promise: null\n    };\n    (0, _log.dev)().fine(TAG_, 'schedule:', task.id, 'at', task.scheduleTime); // Only schedule a new task if there's no one enqueued yet or if this task\n    // has a higher priority.\n\n    var queued = this.queue_.getTaskById(taskId);\n\n    if (!queued || task.priority < queued.priority) {\n      if (queued) {\n        this.queue_.dequeue(queued);\n      }\n\n      this.queue_.enqueue(task);\n      this.schedulePass(this.calcTaskTimeout_(task));\n    }\n\n    task.resource.layoutScheduled(task.scheduleTime);\n  }\n  /**\n   * @return {!Promise} when first pass executed.\n   */\n  ;\n\n  _proto.whenFirstPass = function whenFirstPass() {\n    return this.firstPassDone_.promise;\n  }\n  /**\n   * Calls iterator on each sub-resource\n   * @param {!FiniteStateMachine<!VisibilityState>} vsm\n   */\n  ;\n\n  _proto.setupVisibilityStateMachine_ = function setupVisibilityStateMachine_(vsm) {\n    var _this14 = this;\n\n    var prerender = _visibilityState.VisibilityState.PRERENDER,\n        visible = _visibilityState.VisibilityState.VISIBLE,\n        hidden = _visibilityState.VisibilityState.HIDDEN,\n        paused = _visibilityState.VisibilityState.PAUSED,\n        inactive = _visibilityState.VisibilityState.INACTIVE;\n\n    var doWork = function doWork() {\n      // If viewport size is 0, the manager will wait for the resize event.\n      var viewportSize = _this14.viewport_.getSize();\n\n      if (viewportSize.height > 0 && viewportSize.width > 0) {\n        if (_this14.hasMutateWork_()) {\n          _this14.mutateWork_();\n        }\n\n        _this14.discoverWork_();\n\n        var delay = _this14.work_();\n\n        if (_this14.hasMutateWork_()) {\n          // Overflow mutate work.\n          delay = Math.min(delay, MUTATE_DEFER_DELAY_);\n        }\n\n        if (_this14.visible_) {\n          if (_this14.schedulePass(delay)) {\n            (0, _log.dev)().fine(TAG_, 'next pass:', delay);\n          } else {\n            (0, _log.dev)().fine(TAG_, 'pass already scheduled');\n          }\n        } else {\n          (0, _log.dev)().fine(TAG_, 'document is not visible: no scheduling');\n        }\n\n        _this14.firstPassDone_.resolve();\n      }\n    };\n\n    var noop = function noop() {};\n\n    var pause = function pause() {\n      _this14.resources_.forEach(function (r) {\n        return r.pause();\n      });\n    };\n\n    var unload = function unload() {\n      _this14.resources_.forEach(function (r) {\n        r.unload();\n\n        _this14.cleanupTasks_(r);\n      });\n\n      _this14.unselectText_();\n    };\n\n    var resume = function resume() {\n      _this14.resources_.forEach(function (r) {\n        return r.resume();\n      });\n\n      doWork();\n    };\n\n    vsm.addTransition(prerender, prerender, doWork);\n    vsm.addTransition(prerender, visible, doWork);\n    vsm.addTransition(prerender, hidden, doWork);\n    vsm.addTransition(prerender, inactive, doWork);\n    vsm.addTransition(prerender, paused, doWork);\n    vsm.addTransition(visible, visible, doWork);\n    vsm.addTransition(visible, hidden, doWork);\n    vsm.addTransition(visible, inactive, unload);\n    vsm.addTransition(visible, paused, pause);\n    vsm.addTransition(hidden, visible, doWork);\n    vsm.addTransition(hidden, hidden, doWork);\n    vsm.addTransition(hidden, inactive, unload);\n    vsm.addTransition(hidden, paused, pause);\n    vsm.addTransition(inactive, visible, resume);\n    vsm.addTransition(inactive, hidden, resume);\n    vsm.addTransition(inactive, inactive, noop);\n    vsm.addTransition(inactive, paused, doWork);\n    vsm.addTransition(paused, visible, resume);\n    vsm.addTransition(paused, hidden, doWork);\n    vsm.addTransition(paused, inactive, unload);\n    vsm.addTransition(paused, paused, noop);\n  }\n  /**\n   * Unselects any selected text\n   * @private\n   */\n  ;\n\n  _proto.unselectText_ = function unselectText_() {\n    try {\n      this.win.getSelection().removeAllRanges();\n    } catch (e) {// Selection API not supported.\n    }\n  }\n  /**\n   * Cleanup task queues from tasks for elements that has been unloaded.\n   * @param {Resource} resource\n   * @param {boolean=} opt_removePending Whether to remove from pending\n   *     build resources.\n   * @private\n   */\n  ;\n\n  _proto.cleanupTasks_ = function cleanupTasks_(resource, opt_removePending) {\n    if (resource.getState() == _resource.ResourceState.NOT_LAID_OUT) {\n      // If the layout promise for this resource has not resolved yet, remove\n      // it from the task queues to make sure this resource can be rescheduled\n      // for layout again later on.\n      // TODO(mkhatib): Think about how this might affect preload tasks once the\n      // prerender change is in.\n      this.queue_.purge(function (task) {\n        return task.resource == resource;\n      });\n      this.exec_.purge(function (task) {\n        return task.resource == resource;\n      });\n      (0, _array.remove)(this.requestsChangeSize_, function (request) {\n        return request.resource === resource;\n      });\n    }\n\n    if (resource.getState() == _resource.ResourceState.NOT_BUILT && opt_removePending && this.pendingBuildResources_) {\n      var pendingIndex = this.pendingBuildResources_.indexOf(resource);\n\n      if (pendingIndex != -1) {\n        this.pendingBuildResources_.splice(pendingIndex, 1);\n      }\n    }\n  };\n\n  return ResourcesImpl;\n}();\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   height: (number|undefined),\n *   width: (number|undefined),\n *   margins: (!../layout-rect.LayoutMarginsChangeDef|undefined)\n * }}\n */\n\n\nexports.ResourcesImpl = ResourcesImpl;\nvar SizeDef;\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\nexports.SizeDef = SizeDef;\n\nfunction installResourcesServiceForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'resources', ResourcesImpl);\n}\n\n},{\"../chunk\":30,\"../dom\":41,\"../error\":44,\"../event-helper\":46,\"../experiments\":47,\"../finite-state-machine\":50,\"../focus-history\":51,\"../layout-rect\":65,\"../log\":68,\"../pass\":72,\"../service\":79,\"../services\":123,\"../style\":128,\"../url\":134,\"../utils/array\":135,\"../utils/object\":145,\"../utils/promise\":147,\"../visibility-state\":151,\"./ie-media-bug\":94,\"./resource\":101,\"./resources-interface\":103,\"./task-queue\":106}],103:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ResourcesInterface = exports.READY_SCAN_SIGNAL = void 0;\n\nvar _mutatorInterface = require(\"./mutator-interface\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/** @const {string} */\nvar READY_SCAN_SIGNAL = 'ready-scan';\n/* eslint-disable no-unused-vars */\n\n/**\n * @interface\n */\n\nexports.READY_SCAN_SIGNAL = READY_SCAN_SIGNAL;\n\nvar ResourcesInterface =\n/*#__PURE__*/\nfunction (_MutatorInterface) {\n  _inheritsLoose(ResourcesInterface, _MutatorInterface);\n\n  function ResourcesInterface() {\n    return _MutatorInterface.apply(this, arguments) || this;\n  }\n\n  var _proto = ResourcesInterface.prototype;\n\n  /**\n   * Returns a list of resources.\n   * @return {!Array<!./resource.Resource>}\n   * @export\n   */\n  _proto.get = function get() {}\n  /**\n   * @return {!./ampdoc-impl.AmpDoc}\n   */\n  ;\n\n  _proto.getAmpdoc = function getAmpdoc() {}\n  /**\n   * Returns the {@link Resource} instance corresponding to the specified AMP\n   * Element. If no Resource is found, the exception is thrown.\n   * @param {!AmpElement} element\n   * @return {!./resource.Resource}\n   */\n  ;\n\n  _proto.getResourceForElement = function getResourceForElement(element) {}\n  /**\n   * Returns the {@link Resource} instance corresponding to the specified AMP\n   * Element. Returns null if no resource is found.\n   * @param {!AmpElement} element\n   * @return {?./resource.Resource}\n   */\n  ;\n\n  _proto.getResourceForElementOptional = function getResourceForElementOptional(element) {}\n  /**\n   * Returns the direction the user last scrolled.\n   *  - -1 for scrolling up\n   *  - 1 for scrolling down\n   *  - Defaults to 1\n   * TODO(lannka): this method should not belong to resources.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollDirection = function getScrollDirection() {}\n  /**\n   * Signals that an element has been added to the DOM. Resources manager\n   * will start tracking it from this point on.\n   * @param {!AmpElement} element\n   */\n  ;\n\n  _proto.add = function add(element) {}\n  /**\n   * Signals that an element has been upgraded to the DOM. Resources manager\n   * will perform build and enable layout/viewport signals for this element.\n   * @param {!AmpElement} element\n   */\n  ;\n\n  _proto.upgraded = function upgraded(element) {}\n  /**\n   * Signals that an element has been removed to the DOM. Resources manager\n   * will stop tracking it from this point on.\n   * @param {!AmpElement} element\n   */\n  ;\n\n  _proto.remove = function remove(element) {}\n  /**\n   * Schedules layout or preload for the specified resource.\n   * @param {!./resource.Resource} resource\n   * @param {boolean} layout\n   * @param {number=} opt_parentPriority\n   * @param {boolean=} opt_forceOutsideViewport\n   * @package\n   */\n  ;\n\n  _proto.scheduleLayoutOrPreload = function scheduleLayoutOrPreload(resource, layout, opt_parentPriority, opt_forceOutsideViewport) {}\n  /**\n   * Schedules the work pass at the latest with the specified delay.\n   * @param {number=} opt_delay\n   * @param {boolean=} opt_relayoutAll\n   * @return {boolean}\n   */\n  ;\n\n  _proto.schedulePass = function schedulePass(opt_delay, opt_relayoutAll) {}\n  /**\n   * Registers a callback to be called when the next pass happens.\n   * @param {function()} callback\n   */\n  ;\n\n  _proto.onNextPass = function onNextPass(callback) {}\n  /**\n   * @return {!Promise} when first pass executed.\n   */\n  ;\n\n  _proto.whenFirstPass = function whenFirstPass() {}\n  /**\n   * Called when main AMP binary is fully initialized.\n   * May never be called in Shadow Mode.\n   */\n  ;\n\n  _proto.ampInitComplete = function ampInitComplete() {}\n  /**\n   * Updates the priority of the resource. If there are tasks currently\n   * scheduled, their priority is updated as well.\n   * @param {!Element} element\n   * @param {number} newLayoutPriority\n   */\n  ;\n\n  _proto.updateLayoutPriority = function updateLayoutPriority(element, newLayoutPriority) {};\n\n  return ResourcesInterface;\n}(_mutatorInterface.MutatorInterface);\n/* eslint-enable no-unused-vars */\n\n\nexports.ResourcesInterface = ResourcesInterface;\n\n},{\"./mutator-interface\":96}],104:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getAutofocusElementForShowAction = getAutofocusElementForShowAction;\nexports.installStandardActionsForDoc = installStandardActionsForDoc;\nexports.StandardActions = void 0;\n\nvar _actionConstants = require(\"../action-constants\");\n\nvar _layout = require(\"../layout\");\n\nvar _services = require(\"../services\");\n\nvar _style = require(\"../style\");\n\nvar _log = require(\"../log\");\n\nvar _service = require(\"../service\");\n\nvar _types = require(\"../types\");\n\nvar _string = require(\"../string\");\n\nvar _dom = require(\"../dom\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nfunction isShowable(element) {\n  return element.hasAttribute('hidden');\n}\n/**\n * @param {!Element} element\n * @return {?Element}\n * @visibleForTesting\n */\n\n\nfunction getAutofocusElementForShowAction(element) {\n  if (element.hasAttribute('autofocus')) {\n    return element;\n  }\n\n  return element.querySelector('[autofocus]');\n}\n/** @const {string} */\n\n\nvar TAG = 'STANDARD-ACTIONS';\n/**\n * Regular expression that identifies AMP CSS classes with 'i-amphtml-' prefixes.\n * @type {!RegExp}\n */\n\nvar AMP_CSS_RE = /^i-amphtml-/;\n/**\n * This service contains implementations of some of the most typical actions,\n * such as hiding DOM elements.\n * @implements {../service.EmbeddableService}\n * @private Visible for testing.\n */\n\nvar StandardActions =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Window=} opt_win\n   */\n  function StandardActions(ampdoc, opt_win) {\n    // TODO(#22733): remove subroooting once ampdoc-fie is launched.\n\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    var context = opt_win ? opt_win.document.documentElement : ampdoc.getHeadNode();\n    /** @const @private {!./resources-interface.ResourcesInterface} */\n\n    this.resources_ = _services.Services.resourcesForDoc(ampdoc);\n    /** @const @private {!./viewport/viewport-interface.ViewportInterface} */\n\n    this.viewport_ = _services.Services.viewportForDoc(ampdoc); // Explicitly not setting `Action` as a member to scope installation to one\n    // method and for bundle size savings. \n\n    this.installActions_(_services.Services.actionServiceForDoc(context));\n  }\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n\n\n  StandardActions.installInEmbedWindow = function installInEmbedWindow(embedWin, ampdoc) {\n    (0, _service.installServiceInEmbedScope)(embedWin, 'standard-actions', new StandardActions(ampdoc, embedWin));\n  }\n  /**\n   * @param {!./action-impl.ActionService} actionService\n   * @private\n   */\n  ;\n\n  var _proto = StandardActions.prototype;\n\n  _proto.installActions_ = function installActions_(actionService) {\n    actionService.addGlobalTarget('AMP', this.handleAmpTarget_.bind(this)); // All standard actions require high trust by default via\n    // addGlobalMethodHandler.\n\n    actionService.addGlobalMethodHandler('hide', this.handleHide_.bind(this));\n    actionService.addGlobalMethodHandler('show', this.handleShow_.bind(this));\n    actionService.addGlobalMethodHandler('toggleVisibility', this.handleToggle_.bind(this));\n    actionService.addGlobalMethodHandler('scrollTo', this.handleScrollTo_.bind(this));\n    actionService.addGlobalMethodHandler('focus', this.handleFocus_.bind(this));\n    actionService.addGlobalMethodHandler('toggleClass', this.handleToggleClass_.bind(this));\n  }\n  /**\n   * Handles global `AMP` actions.\n   * See `amp-actions-and-events.md` for details.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @throws If the invocation method is unrecognized.\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleAmpTarget_ = function handleAmpTarget_(invocation) {\n    // All global `AMP` actions require high trust.\n    if (!invocation.satisfiesTrust(_actionConstants.ActionTrust.HIGH)) {\n      return null;\n    }\n\n    var node = invocation.node,\n        method = invocation.method,\n        args = invocation.args;\n    var win = (node.ownerDocument || node).defaultView;\n\n    switch (method) {\n      case 'pushState':\n      case 'setState':\n        var element = node.nodeType === Node.DOCUMENT_NODE ? node.documentElement : node;\n        return _services.Services.bindForDocOrNull(element).then(function (bind) {\n          (0, _log.userAssert)(bind, 'AMP-BIND is not installed.');\n          return bind.invoke(invocation);\n        });\n\n      case 'navigateTo':\n        return this.handleNavigateTo_(invocation);\n\n      case 'closeOrNavigateTo':\n        return this.handleCloseOrNavigateTo_(invocation);\n\n      case 'scrollTo':\n        (0, _log.userAssert)(args['id'], 'AMP.scrollTo must provide element ID');\n        invocation.node = (0, _log.dev)().assertElement((0, _service.getAmpdoc)(node).getElementById(args['id']), 'scrollTo element ID must exist on page');\n        return this.handleScrollTo_(invocation);\n\n      case 'goBack':\n        _services.Services.historyForDoc(this.ampdoc).goBack();\n\n        return null;\n\n      case 'print':\n        win.print();\n        return null;\n\n      case 'optoutOfCid':\n        return _services.Services.cidForDoc(this.ampdoc).then(function (cid) {\n          return cid.optOut();\n        }).catch(function (reason) {\n          (0, _log.dev)().error(TAG, 'Failed to opt out of CID', reason);\n        });\n    }\n\n    throw (0, _log.user)().createError('Unknown AMP action ', method);\n  }\n  /**\n   * Handles the `navigateTo` action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {!Promise}\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleNavigateTo_ = function handleNavigateTo_(invocation) {\n    var _this = this;\n\n    var node = invocation.node,\n        caller = invocation.caller,\n        method = invocation.method,\n        args = invocation.args;\n    var win = (node.ownerDocument || node).defaultView; // Some components have additional constraints on allowing navigation.\n\n    var permission = Promise.resolve();\n\n    if ((0, _string.startsWith)(caller.tagName, 'AMP-')) {\n      permission = caller.getImpl().then(function (impl) {\n        if (typeof impl.throwIfCannotNavigate == 'function') {\n          impl.throwIfCannotNavigate();\n        }\n      });\n    }\n\n    return permission.then(function () {\n      _services.Services.navigationForDoc(_this.ampdoc).navigateTo(win, args['url'], \"AMP.\" + method, {\n        target: args['target'],\n        opener: args['opener']\n      });\n    },\n    /* onrejected */\n    function (e) {\n      (0, _log.user)().error(TAG, e.message);\n    });\n  }\n  /**\n   * Handles the `handleCloseOrNavigateTo_` action.\n   * This action tries to close the requesting window if allowed, otherwise\n   * navigates the window.\n   *\n   * Window can be closed only from top-level documents that have an opener.\n   * Without an opener or if embedded, it will deny the close method.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {!Promise}\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleCloseOrNavigateTo_ = function handleCloseOrNavigateTo_(invocation) {\n    var node = invocation.node;\n    var win = (node.ownerDocument || node).defaultView; // Don't allow closing if embedded in iframe or does not have an opener or\n    // embedded in a multi-doc shadowDOM case.\n    // Note that browser denies win.close in some of these cases already anyway,\n    // so not every check here is strictly needed but works as a short-circuit.\n\n    var hasParent = win.parent != win;\n    var canBeClosed = win.opener && this.ampdoc.isSingleDoc() && !hasParent;\n    var wasClosed = false;\n\n    if (canBeClosed) {\n      // Browser may still deny win.close() call, that would be reflected\n      // synchronously in win.closed\n      win.close();\n      wasClosed = win.closed;\n    }\n\n    if (!wasClosed) {\n      return this.handleNavigateTo_(invocation);\n    }\n\n    return Promise.resolve();\n  }\n  /**\n   * Handles the `scrollTo` action where given an element, we smooth scroll to\n   * it with the given animation duration.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleScrollTo_ = function handleScrollTo_(invocation) {\n    var node = (0, _log.dev)().assertElement(invocation.node);\n    var args = invocation.args; // Duration and position are optional.\n    // Default values are set by the viewport service, so they're passed through\n    // when undefined or invalid.\n\n    var posOrUndef = args && args['position'];\n    var durationOrUndef = args && args['duration'];\n\n    if (posOrUndef && !['top', 'bottom', 'center'].includes(posOrUndef)) {\n      posOrUndef = undefined;\n    }\n\n    if (!(0, _types.isFiniteNumber)(durationOrUndef)) {\n      durationOrUndef = undefined;\n    } // Animate the scroll\n    // Should return a promise instead of null\n\n\n    return this.viewport_.animateScrollIntoView(node, posOrUndef, durationOrUndef);\n  }\n  /**\n   * Handles the `focus` action where given an element, we give it focus\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleFocus_ = function handleFocus_(invocation) {\n    var node = (0, _log.dev)().assertElement(invocation.node); // Set focus\n\n    (0, _dom.tryFocus)(node);\n    return null;\n  }\n  /**\n   * Handles \"hide\" action. This is a very simple action where \"display: none\"\n   * is applied to the target element.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleHide_ = function handleHide_(invocation) {\n    var target = (0, _log.dev)().assertElement(invocation.node);\n    this.resources_.mutateElement(target, function () {\n      if (target.classList.contains('i-amphtml-element')) {\n        target.\n        /*OK*/\n        collapse();\n      } else {\n        (0, _style.toggle)(target, false);\n      }\n    });\n    return null;\n  }\n  /**\n   * Handles \"show\" action. This is a very simple action where \"display: none\"\n   * is removed from the target element.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleShow_ = function handleShow_(_ref) {\n    var _this2 = this;\n\n    var node = _ref.node;\n    var target = (0, _log.dev)().assertElement(node);\n    var ownerWindow = (0, _types.toWin)(target.ownerDocument.defaultView);\n\n    if (target.classList.contains((0, _layout.getLayoutClass)(_layout.Layout.NODISPLAY))) {\n      (0, _log.user)().warn(TAG, 'Elements with layout=nodisplay cannot be dynamically shown.', target);\n      return null;\n    }\n\n    this.resources_.measureElement(function () {\n      if ((0, _style.computedStyle)(ownerWindow, target).display == 'none' && !isShowable(target)) {\n        (0, _log.user)().warn(TAG, 'Elements can only be dynamically shown when they have the ' + '\"hidden\" attribute set or when they were dynamically hidden.', target);\n      }\n    });\n    var autofocusElOrNull = getAutofocusElementForShowAction(target); // iOS only honors focus in sync operations.\n\n    if (autofocusElOrNull && _services.Services.platformFor(ownerWindow).isIos()) {\n      this.handleShowSync_(target, autofocusElOrNull);\n    } else {\n      this.resources_.mutateElement(target, function () {\n        _this2.handleShowSync_(target, autofocusElOrNull);\n      });\n    }\n\n    return null;\n  }\n  /**\n   * @param {!Element} target\n   * @param {?Element} autofocusElOrNull\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleShowSync_ = function handleShowSync_(target, autofocusElOrNull) {\n    if (target.classList.contains('i-amphtml-element')) {\n      target.\n      /*OK*/\n      expand();\n    } else {\n      (0, _style.toggle)(target, true);\n    }\n\n    if (autofocusElOrNull) {\n      (0, _dom.tryFocus)(autofocusElOrNull);\n    }\n  }\n  /**\n   * Handles \"toggle\" action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleToggle_ = function handleToggle_(invocation) {\n    if (isShowable((0, _log.dev)().assertElement(invocation.node))) {\n      return this.handleShow_(invocation);\n    }\n\n    return this.handleHide_(invocation);\n  }\n  /**\n   * Handles \"toggleClass\" action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  ;\n\n  _proto.handleToggleClass_ = function handleToggleClass_(invocation) {\n    var target = (0, _log.dev)().assertElement(invocation.node);\n    var args = invocation.args;\n    var className = (0, _log.user)().assertString(args['class'], \"Argument 'class' must be a string.\"); // prevent toggling of amp internal classes\n\n    if (AMP_CSS_RE.test(className)) {\n      return null;\n    }\n\n    this.resources_.mutateElement(target, function () {\n      if (args['force'] !== undefined) {\n        // must be boolean, won't do type conversion\n        var shouldForce = (0, _log.user)().assertBoolean(args['force'], \"Optional argument 'force' must be a boolean.\");\n        target.classList.toggle(className, shouldForce);\n      } else {\n        target.classList.toggle(className);\n      }\n    });\n    return null;\n  };\n\n  return StandardActions;\n}();\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nexports.StandardActions = StandardActions;\n\nfunction installStandardActionsForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'standard-actions', StandardActions,\n  /* opt_instantiate */\n  true);\n}\n\n},{\"../action-constants\":23,\"../dom\":41,\"../layout\":66,\"../log\":68,\"../service\":79,\"../services\":123,\"../string\":126,\"../style\":128,\"../types\":131}],105:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installStorageServiceForDoc = installStorageServiceForDoc;\nexports.ViewerStorageBinding = exports.LocalStorageBinding = exports.Store = exports.Storage = void 0;\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\nvar _object = require(\"../utils/object\");\n\nvar _url = require(\"../url\");\n\nvar _json = require(\"../json\");\n\nvar _service = require(\"../service\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const */\nvar TAG = 'Storage';\n/** @const */\n\nvar MAX_VALUES_PER_ORIGIN = 8;\n/**\n * The storage API. This is an API equivalent to the Web LocalStorage API but\n * extended to all AMP embedding scenarios.\n *\n * The storage is done per source origin. See `get`, `set` and `remove` methods\n * for more info.\n *\n * @see https://html.spec.whatwg.org/multipage/webstorage.html\n * @private Visible for testing only.\n */\n\nvar Storage =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!../service/viewer-interface.ViewerInterface} viewer\n   * @param {!StorageBindingDef} binding\n   */\n  function Storage(ampdoc, viewer, binding) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @private @const {!../service/viewer-interface.ViewerInterface} */\n\n    this.viewer_ = viewer;\n    /** @private @const {!StorageBindingDef} */\n\n    this.binding_ = binding;\n    /** @const @private {string} */\n\n    this.origin_ = (0, _url.getSourceOrigin)(this.ampdoc.win.location);\n    /** @private {?Promise<!Store>} */\n\n    this.storePromise_ = null;\n  }\n  /**\n   * @return {!Storage}\n   * @protected\n   */\n\n\n  var _proto = Storage.prototype;\n\n  _proto.start_ = function start_() {\n    this.listenToBroadcasts_();\n    return this;\n  }\n  /**\n   * Returns the promise that yields the value of the property for the specified\n   * key.\n   * @param {string} name\n   * @return {!Promise<*>}\n   */\n  ;\n\n  _proto.get = function get(name) {\n    return this.getStore_().then(function (store) {\n      return store.get(name);\n    });\n  }\n  /**\n   * Saves the value (restricted to boolean value) of the specified property.\n   * Returns the promise that's resolved when the operation completes.\n   * @param {string} name\n   * @param {*} value\n   * @param {boolean=} opt_isUpdate\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.set = function set(name, value, opt_isUpdate) {\n    (0, _log.devAssert)(typeof value == 'boolean', 'Only boolean values accepted');\n    return this.setNonBoolean(name, value, opt_isUpdate);\n  }\n  /**\n   * Saves the value of the specified property. Returns the promise that's\n   * resolved when the operation completes.\n   * Note: More restrict privacy review is required to store non boolean value.\n   * @param {string} name\n   * @param {*} value\n   * @param {boolean=} opt_isUpdate\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.setNonBoolean = function setNonBoolean(name, value, opt_isUpdate) {\n    return this.saveStore_(function (store) {\n      return store.set(name, value, opt_isUpdate);\n    });\n  }\n  /**\n   * Removes the specified property. Returns the promise that's resolved when\n   * the operation completes.\n   * @param {string} name\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.remove = function remove(name) {\n    return this.saveStore_(function (store) {\n      return store.remove(name);\n    });\n  }\n  /**\n   * @return {!Promise<!Store>}\n   * @private\n   */\n  ;\n\n  _proto.getStore_ = function getStore_() {\n    if (!this.storePromise_) {\n      this.storePromise_ = this.binding_.loadBlob(this.origin_).then(function (blob) {\n        return blob ? (0, _json.parseJson)(atob(blob)) : {};\n      }).catch(function (reason) {\n        (0, _log.dev)().expectedError(TAG, 'Failed to load store: ', reason);\n        return {};\n      }).then(function (obj) {\n        return new Store(obj);\n      });\n    }\n\n    return this.storePromise_;\n  }\n  /**\n   * @param {function(!Store)} mutator\n   * @return {!Promise}\n   * @private\n   */\n  ;\n\n  _proto.saveStore_ = function saveStore_(mutator) {\n    var _this = this;\n\n    return this.getStore_().then(function (store) {\n      mutator(store); // Need to encode stored object to avoid plain text,\n      // but doesn't need to be base64encode. Can convert to some other\n      // encoding method for further improvement.\n\n      var blob = btoa(JSON.stringify(store.obj));\n      return _this.binding_.saveBlob(_this.origin_, blob);\n    }).then(this.broadcastReset_.bind(this));\n  }\n  /** @private */\n  ;\n\n  _proto.listenToBroadcasts_ = function listenToBroadcasts_() {\n    var _this2 = this;\n\n    this.viewer_.onBroadcast(function (message) {\n      if (message['type'] == 'amp-storage-reset' && message['origin'] == _this2.origin_) {\n        (0, _log.dev)().fine(TAG, 'Received reset message');\n        _this2.storePromise_ = null;\n      }\n    });\n  }\n  /** @private */\n  ;\n\n  _proto.broadcastReset_ = function broadcastReset_() {\n    (0, _log.dev)().fine(TAG, 'Broadcasted reset message');\n    this.viewer_.broadcast(\n    /** @type {!JsonObject} */\n    {\n      'type': 'amp-storage-reset',\n      'origin': this.origin_\n    });\n  };\n\n  return Storage;\n}();\n/**\n * The implementation of store logic for get, set and remove.\n *\n * The structure of the store is equivalent to the following typedef:\n * ```\n * {\n *   vv: !Object<key(string), !{\n *     v: *,\n *     t: time\n *   }>\n * }\n * ```\n *\n * @private Visible for testing only.\n */\n\n\nexports.Storage = Storage;\n\nvar Store =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!JsonObject} obj\n   * @param {number=} opt_maxValues\n   */\n  function Store(obj, opt_maxValues) {\n    /** @const {!JsonObject} */\n    this.obj =\n    /** @type {!JsonObject} */\n    (0, _json.recreateNonProtoObject)(obj);\n    /** @private @const {number} */\n\n    this.maxValues_ = opt_maxValues || MAX_VALUES_PER_ORIGIN;\n    /** @private @const {!Object<string, !JsonObject>} */\n\n    this.values_ = this.obj['vv'] || Object.create(null);\n\n    if (!this.obj['vv']) {\n      this.obj['vv'] = this.values_;\n    }\n  }\n  /**\n   * @param {string} name\n   * @return {*|undefined}\n   */\n\n\n  var _proto2 = Store.prototype;\n\n  _proto2.get = function get(name) {\n    // The structure is {key: {v: *, t: time}}\n    var item = this.values_[name];\n    return item ? item['v'] : undefined;\n  }\n  /**\n   * Set the storage value along with the current timestamp.\n   * When opt_isUpdated is true, timestamp will be the creation timestamp,\n   * the stored value will be updated w/o updating timestamp.\n   * @param {string} name\n   * @param {*} value\n   * @param {boolean=} opt_isUpdate\n   */\n  ;\n\n  _proto2.set = function set(name, value, opt_isUpdate) {\n    (0, _log.devAssert)(name != '__proto__' && name != 'prototype', 'Name is not allowed: %s', name); // The structure is {key: {v: *, t: time}}\n\n    if (this.values_[name] !== undefined) {\n      var item = this.values_[name];\n      var timestamp = Date.now();\n\n      if (opt_isUpdate) {\n        // Update value w/o timestamp\n        timestamp = item['t'];\n      }\n\n      item['v'] = value;\n      item['t'] = timestamp;\n    } else {\n      this.values_[name] = (0, _object.dict)({\n        'v': value,\n        't': Date.now()\n      });\n    } // Purge old values.\n\n\n    var keys = Object.keys(this.values_);\n\n    if (keys.length > this.maxValues_) {\n      var minTime = Infinity;\n      var minKey = null;\n\n      for (var i = 0; i < keys.length; i++) {\n        var _item = this.values_[keys[i]];\n\n        if (_item['t'] < minTime) {\n          minKey = keys[i];\n          minTime = _item['t'];\n        }\n      }\n\n      if (minKey) {\n        delete this.values_[minKey];\n      }\n    }\n  }\n  /**\n   * @param {string} name\n   */\n  ;\n\n  _proto2.remove = function remove(name) {\n    // The structure is {key: {v: *, t: time}}\n    delete this.values_[name];\n  };\n\n  return Store;\n}();\n/**\n * A binding provides the specific implementation of storage technology.\n * @interface\n */\n\n\nexports.Store = Store;\n\nvar StorageBindingDef =\n/*#__PURE__*/\nfunction () {\n  function StorageBindingDef() {}\n\n  var _proto3 = StorageBindingDef.prototype;\n\n  /**\n   * Returns the promise that yields the store blob for the specified origin.\n   * @param {string} unusedOrigin\n   * @return {!Promise<?string>}\n   */\n  _proto3.loadBlob = function loadBlob(unusedOrigin) {}\n  /**\n   * Saves the store blob for the specified origin and returns the promise\n   * that's resolved when the operation completes.\n   * @param {string} unusedOrigin\n   * @param {string} unusedBlob\n   * @return {!Promise}\n   */\n  ;\n\n  _proto3.saveBlob = function saveBlob(unusedOrigin, unusedBlob) {};\n\n  return StorageBindingDef;\n}();\n/**\n * Storage implementation using Web LocalStorage API.\n * @implements {StorageBindingDef}\n * @private Visible for testing only.\n */\n\n\nvar LocalStorageBinding =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function LocalStorageBinding(win) {\n    /** @const {!Window} */\n    this.win = win;\n    /** @private @const {boolean} */\n\n    this.isLocalStorageSupported_ = this.checkIsLocalStorageSupported_();\n\n    if (!this.isLocalStorageSupported_) {\n      var error = new Error('localStorage not supported.');\n      (0, _log.dev)().expectedError(TAG, error);\n    }\n  }\n  /**\n   * Determines whether localStorage API is supported by ensuring it is declared\n   * and does not throw an exception when used.\n   * @return {boolean}\n   * @private\n   */\n\n\n  var _proto4 = LocalStorageBinding.prototype;\n\n  _proto4.checkIsLocalStorageSupported_ = function checkIsLocalStorageSupported_() {\n    try {\n      if (!('localStorage' in this.win)) {\n        return false;\n      } // We do not care about the value fetched from local storage; we only care\n      // whether the call throws an exception or not.  As such, we can look up\n      // any arbitrary key.\n\n\n      this.win.localStorage.getItem('test');\n      return true;\n    } catch (e) {\n      return false;\n    }\n  }\n  /**\n   * @param {string} origin\n   * @return {string}\n   * @private\n   */\n  ;\n\n  _proto4.getKey_ = function getKey_(origin) {\n    return \"amp-store:\" + origin;\n  }\n  /** @override */\n  ;\n\n  _proto4.loadBlob = function loadBlob(origin) {\n    var _this3 = this;\n\n    return new Promise(function (resolve) {\n      if (!_this3.isLocalStorageSupported_) {\n        resolve(null);\n        return;\n      }\n\n      resolve(_this3.win.localStorage.getItem(_this3.getKey_(origin)));\n    });\n  }\n  /** @override */\n  ;\n\n  _proto4.saveBlob = function saveBlob(origin, blob) {\n    var _this4 = this;\n\n    return new Promise(function (resolve) {\n      if (!_this4.isLocalStorageSupported_) {\n        resolve();\n        return;\n      }\n\n      _this4.win.localStorage.setItem(_this4.getKey_(origin), blob);\n\n      resolve();\n    });\n  };\n\n  return LocalStorageBinding;\n}();\n/**\n * Storage implementation delegated to the Viewer.\n * @implements {StorageBindingDef}\n * @private Visible for testing only.\n */\n\n\nexports.LocalStorageBinding = LocalStorageBinding;\n\nvar ViewerStorageBinding =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!../service/viewer-interface.ViewerInterface} viewer\n   */\n  function ViewerStorageBinding(viewer) {\n    /** @private @const {!../service/viewer-interface.ViewerInterface} */\n    this.viewer_ = viewer;\n  }\n  /** @override */\n\n\n  var _proto5 = ViewerStorageBinding.prototype;\n\n  _proto5.loadBlob = function loadBlob(origin) {\n    return this.viewer_.sendMessageAwaitResponse('loadStore', (0, _object.dict)({\n      'origin': origin\n    })).then(function (response) {\n      return response['blob'];\n    });\n  }\n  /** @override */\n  ;\n\n  _proto5.saveBlob = function saveBlob(origin, blob) {\n    return (\n      /** @type {!Promise} */\n      this.viewer_.sendMessageAwaitResponse('saveStore', (0, _object.dict)({\n        'origin': origin,\n        'blob': blob\n      }))\n    );\n  };\n\n  return ViewerStorageBinding;\n}();\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nexports.ViewerStorageBinding = ViewerStorageBinding;\n\nfunction installStorageServiceForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'storage', function () {\n    var viewer = _services.Services.viewerForDoc(ampdoc);\n\n    var overrideStorage = parseInt(viewer.getParam('storage'), 10);\n    var binding = overrideStorage ? new ViewerStorageBinding(viewer) : new LocalStorageBinding(ampdoc.win);\n    return new Storage(ampdoc, viewer, binding).start_();\n  },\n  /* opt_instantiate */\n  true);\n}\n\n},{\"../json\":63,\"../log\":68,\"../service\":79,\"../services\":123,\"../url\":134,\"../utils/object\":145}],106:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.TaskQueue = exports.TaskDef = void 0;\n\nvar _log = require(\"../log\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The internal structure for the task.\n * @typedef {{\n *   id: string,\n *   resource: !./resource.Resource,\n *   priority: number,\n *   forceOutsideViewport: boolean,\n *   callback: function(),\n *   scheduleTime: time,\n *   startTime: time,\n *   promise: (?Promise|undefined)\n * }}\n */\nvar TaskDef;\n/**\n * @typedef {Object<string, *>}\n */\n\nexports.TaskDef = TaskDef;\nvar PeekStateDef;\n/**\n * A scheduling queue for Resources.\n *\n * @package\n */\n\nvar TaskQueue =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates an instance of TaskQueue.\n   */\n  function TaskQueue() {\n    /** @private @const {!Array<!TaskDef>} */\n    this.tasks_ = [];\n    /** @private @const {!Object<string, !TaskDef>} */\n\n    this.taskIdMap_ = {};\n    /** @private {!time} */\n\n    this.lastEnqueueTime_ = 0;\n    /** @private {!time} */\n\n    this.lastDequeueTime_ = 0;\n  }\n  /**\n   * Size of the queue.\n   * @return {number}\n   */\n\n\n  var _proto = TaskQueue.prototype;\n\n  _proto.getSize = function getSize() {\n    return this.tasks_.length;\n  }\n  /**\n   * Last time a task was enqueued.\n   * @return {!time}\n   */\n  ;\n\n  _proto.getLastEnqueueTime = function getLastEnqueueTime() {\n    return this.lastEnqueueTime_;\n  }\n  /**\n   * Last time a task was dequeued.\n   * @return {!time}\n   */\n  ;\n\n  _proto.getLastDequeueTime = function getLastDequeueTime() {\n    return this.lastDequeueTime_;\n  }\n  /**\n   * Returns the task with the specified ID or null.\n   * @param {string} taskId\n   * @return {?TaskDef}\n   */\n  ;\n\n  _proto.getTaskById = function getTaskById(taskId) {\n    return this.taskIdMap_[taskId] || null;\n  }\n  /**\n   * Enqueues the task. If the task is already in the queue, the error is\n   * thrown.\n   * @param {!TaskDef} task\n   */\n  ;\n\n  _proto.enqueue = function enqueue(task) {\n    (0, _log.devAssert)(!this.taskIdMap_[task.id], 'Task already enqueued: %s', task.id);\n    this.tasks_.push(task);\n    this.taskIdMap_[task.id] = task;\n    this.lastEnqueueTime_ = Date.now();\n  }\n  /**\n   * Dequeues the task and returns \"true\" if dequeueing is successful. Otherwise\n   * returns \"false\", e.g. when this task is not currently enqueued.\n   * @param {!TaskDef} task\n   * @return {boolean}\n   */\n  ;\n\n  _proto.dequeue = function dequeue(task) {\n    var existing = this.taskIdMap_[task.id];\n    var dequeued = this.removeAtIndex(task, this.tasks_.indexOf(existing));\n\n    if (!dequeued) {\n      return false;\n    }\n\n    this.lastDequeueTime_ = Date.now();\n    return true;\n  }\n  /**\n   * Returns the task with the minimal score based on the provided scoring\n   * callback.\n   * @param {function(!TaskDef, !PeekStateDef):number} scorer\n   * @param {!PeekStateDef} state\n   * @return {?TaskDef}\n   */\n  ;\n\n  _proto.peek = function peek(scorer, state) {\n    var minScore = 1e6;\n    var minTask = null;\n\n    for (var i = 0; i < this.tasks_.length; i++) {\n      var task = this.tasks_[i];\n      var score = scorer(task, state);\n\n      if (score < minScore) {\n        minScore = score;\n        minTask = task;\n      }\n    }\n\n    return minTask;\n  }\n  /**\n   * Iterates over all tasks in queue in the insertion order.\n   * @param {function(!TaskDef)} callback\n   */\n  ;\n\n  _proto.forEach = function forEach(callback) {\n    this.tasks_.forEach(callback);\n  }\n  /**\n   * Removes the task and returns \"true\" if dequeueing is successful. Otherwise\n   * returns \"false\", e.g. when this task is not currently enqueued.\n   * @param {!TaskDef} task\n   * @param {number} index of the task to remove.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.removeAtIndex = function removeAtIndex(task, index) {\n    var existing = this.taskIdMap_[task.id];\n\n    if (!existing || this.tasks_[index] != existing) {\n      return false;\n    }\n\n    this.tasks_.splice(index, 1);\n    delete this.taskIdMap_[task.id];\n    return true;\n  }\n  /**\n   * Removes tasks in queue that pass the callback test.\n   * @param {function(!TaskDef):boolean} callback Return true to remove the task.\n   */\n  ;\n\n  _proto.purge = function purge(callback) {\n    var index = this.tasks_.length;\n\n    while (index--) {\n      if (callback(this.tasks_[index])) {\n        this.removeAtIndex(this.tasks_[index], index);\n      }\n    }\n  };\n\n  return TaskQueue;\n}();\n\nexports.TaskQueue = TaskQueue;\n\n},{\"../log\":68}],107:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installTemplatesService = installTemplatesService;\nexports.registerExtendedTemplate = registerExtendedTemplate;\nexports.Templates = exports.BaseTemplate = void 0;\n\nvar _promise = require(\"../utils/promise\");\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\nvar _service = require(\"../service\");\n\nvar _dom = require(\"../dom\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview\n * For the set of decisions made on templating see:\n * {@link https://docs.google.com/document/d/1q-5MPQHnOHLF_uL7lQsGZdzuBgrPTkCy2PdRP-YCbOw/edit#}\n */\n\n/**\n * @typedef {function(new:BaseTemplate, !Element, !Window)}\n */\nvar TemplateClassDef;\n/** @private @const {string} */\n\nvar PROP_ = '__AMP_IMPL_';\n/** @private @const {string} */\n\nvar PROP_PROMISE_ = '__AMP_WAIT_';\n/**\n * The interface that is implemented by all templates.\n */\n\nvar BaseTemplate =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Element} element\n   * @param {!Window} win\n   */\n  function BaseTemplate(element, win) {\n    /** @public @const */\n    this.element = element;\n    /** @public @const {!Window} */\n\n    this.win = element.ownerDocument.defaultView || win;\n    /** @private @const */\n\n    this.viewer_ = _services.Services.viewerForDoc(this.element);\n    this.compileCallback();\n  }\n  /**\n   * Override in subclass if the element needs to compile the template.\n   * @protected\n   */\n\n\n  var _proto = BaseTemplate.prototype;\n\n  _proto.compileCallback = function compileCallback() {} // Subclasses may override.\n\n  /**\n   * Bypasses template rendering and directly sets HTML. Should only be used\n   * for server-side rendering case. To be implemented by subclasses.\n   * @param {string} unusedData\n   * @return {!Element}\n   */\n  ;\n\n  _proto.setHtml = function setHtml(unusedData) {\n    throw new Error('Not implemented');\n  }\n  /**\n   * To be implemented by subclasses.\n   * @param {!JsonObject|string} unusedData\n   * @return {!Element}\n   */\n  ;\n\n  _proto.render = function render(unusedData) {\n    throw new Error('Not implemented');\n  }\n  /**\n   * Helps the template implementation to unwrap the root element. The root\n   * element can be unwrapped only when it contains a single element or a\n   * single element surrounded by empty text nodes.\n   * @param {!Element} root\n   * @return {!Element}\n   * @protected @final\n   */\n  ;\n\n  _proto.unwrap = function unwrap(root) {\n    var singleElement = null;\n\n    for (var n = root.firstChild; n != null; n = n.nextSibling) {\n      if (n.nodeType ==\n      /* TEXT */\n      3) {\n        if (n.textContent.trim()) {\n          // Non-empty text node - can't unwrap.\n          singleElement = null;\n          break;\n        }\n      } else if (n.nodeType ==\n      /* COMMENT */\n      8) {// Ignore comments.\n      } else if (n.nodeType ==\n      /* ELEMENT */\n      1) {\n        if (!singleElement) {\n          singleElement = (0, _log.dev)().assertElement(n);\n        } else {\n          // This is not the first element - can't unwrap.\n          singleElement = null;\n          break;\n        }\n      } else {\n        singleElement = null;\n      }\n    }\n\n    return singleElement || root;\n  }\n  /**\n   * @protected @final\n   * @return {boolean}\n   */\n  ;\n\n  _proto.viewerCanRenderTemplates = function viewerCanRenderTemplates() {\n    return this.viewer_.hasCapability('viewerRenderTemplate');\n  };\n\n  return BaseTemplate;\n}();\n/**\n */\n\n\nexports.BaseTemplate = BaseTemplate;\n\nvar Templates =\n/*#__PURE__*/\nfunction () {\n  /** @param {!Window} win */\n  function Templates(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n    /**\n     * A map from template type to template's class promise.\n     * @private @const {!Object<string, !Promise<!TemplateClassDef>>}\n     */\n\n    this.templateClassMap_ = {};\n    /**\n     * A map from template type to template's class promise. This is a transient\n     * storage. As soon as the template class loaded, the entry is removed.\n     * @private @const {!Object<string, function(!TemplateClassDef)>}\n     */\n\n    this.templateClassResolvers_ = {};\n  }\n  /**\n   * Inserts the specified template element.\n   * @param {!Element} templateElement\n   * @param {string} html\n   * @return {!Promise<!Element>}\n   */\n\n\n  var _proto2 = Templates.prototype;\n\n  _proto2.setHtmlForTemplate = function setHtmlForTemplate(templateElement, html) {\n    var _this = this;\n\n    return this.getImplementation_(templateElement).then(function (impl) {\n      return _this.setHtml_(impl, html);\n    });\n  }\n  /**\n   * Renders the specified template element using the supplied data.\n   * @param {!Element} templateElement\n   * @param {!JsonObject} data\n   * @return {!Promise<!Element>}\n   */\n  ;\n\n  _proto2.renderTemplate = function renderTemplate(templateElement, data) {\n    var _this2 = this;\n\n    return this.getImplementation_(templateElement).then(function (impl) {\n      return _this2.render_(impl, data);\n    });\n  }\n  /**\n   * Renders the specified template element using the supplied array of data\n   * and returns an array of resulting elements.\n   * @param {!Element} templateElement\n   * @param {!Array<!JsonObject>} array\n   * @return {!Promise<!Array<!Element>>}\n   */\n  ;\n\n  _proto2.renderTemplateArray = function renderTemplateArray(templateElement, array) {\n    var _this3 = this;\n\n    if (array.length == 0) {\n      return Promise.resolve([]);\n    }\n\n    return this.getImplementation_(templateElement).then(function (impl) {\n      return array.map(function (item) {\n        return _this3.render_(impl, item);\n      });\n    });\n  }\n  /**\n   * Discovers the template for the specified parent and renders it using the\n   * supplied data. The template can be specified either via \"template\"\n   * attribute  or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element.\n   * @param {!Element} parent\n   * @param {!JsonObject} data\n   * @param {string=} opt_querySelector\n   * @return {!Promise<!Element>}\n   */\n  ;\n\n  _proto2.findAndRenderTemplate = function findAndRenderTemplate(parent, data, opt_querySelector) {\n    return this.renderTemplate(this.findTemplate(parent, opt_querySelector), data);\n  }\n  /**\n   * Discovers the already rendered template for the specified parent and\n   * inserts it in the DOM. The template can be specified either via \"template\"\n   * attribute  or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element.\n   * @param {!Element} parent\n   * @param {string} html\n   * @param {string=} opt_querySelector\n   * @return {!Promise<!Element>}\n   */\n  ;\n\n  _proto2.findAndSetHtmlForTemplate = function findAndSetHtmlForTemplate(parent, html, opt_querySelector) {\n    return this.setHtmlForTemplate(this.findTemplate(parent, opt_querySelector), html);\n  }\n  /**\n   * Discovers the template for the specified parent and renders it using the\n   * supplied array of data. The template can be specified either via \"template\"\n   * attribute or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element. Returns\n   * the array of the rendered elements.\n   * @param {!Element} parent\n   * @param {!Array<!JsonObject>} array\n   * @param {string=} opt_querySelector\n   * @return {!Promise<!Array<!Element>>}\n   */\n  ;\n\n  _proto2.findAndRenderTemplateArray = function findAndRenderTemplateArray(parent, array, opt_querySelector) {\n    return this.renderTemplateArray(this.findTemplate(parent, opt_querySelector), array);\n  }\n  /**\n   * Detect if a template is present inside the parent.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {boolean}\n   */\n  ;\n\n  _proto2.hasTemplate = function hasTemplate(parent, opt_querySelector) {\n    return !!this.maybeFindTemplate(parent, opt_querySelector);\n  }\n  /**\n   * Find a specified template inside the parent. Fail if the template is\n   * not present.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {!Element}\n   */\n  ;\n\n  _proto2.findTemplate = function findTemplate(parent, opt_querySelector) {\n    var templateElement = this.maybeFindTemplate(parent, opt_querySelector);\n    (0, _log.userAssert)(templateElement, 'Template not found for %s', parent);\n    var templateTagName = templateElement.tagName;\n    (0, _log.userAssert)(templateTagName == 'TEMPLATE' || templateTagName == 'SCRIPT' && templateElement.getAttribute('type') === 'text/plain', 'Template must be defined in a <template> or ' + '<script type=\"text/plain\"> tag');\n    return templateElement;\n  }\n  /**\n   * Find a specified template inside the parent. Returns null if not present.\n   * The template can be specified either via \"template\" attribute or as a\n   * child \"template\" element. When specified via \"template\" attribute,\n   * the value indicates the ID of the template element. The template\n   * can be defined either via the <template> or <script> tag.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {?Element}\n   */\n  ;\n\n  _proto2.maybeFindTemplate = function maybeFindTemplate(parent, opt_querySelector) {\n    var templateId = parent.getAttribute('template');\n\n    if (templateId) {\n      return (0, _dom.rootNodeFor)(parent).getElementById(templateId);\n    } else if (opt_querySelector) {\n      return (0, _dom.scopedQuerySelector)(parent, opt_querySelector);\n    } else {\n      return parent.querySelector('template, script');\n    }\n  }\n  /**\n   * Returns the promise that will eventually yield the template implementation\n   * for the specified template element.\n   * @param {!Element} element\n   * @return {!Promise<!BaseTemplate>}\n   * @private\n   */\n  ;\n\n  _proto2.getImplementation_ = function getImplementation_(element) {\n    var _this4 = this;\n\n    /** @const {!BaseTemplate} */\n    var impl = element[PROP_];\n\n    if (impl) {\n      return Promise.resolve(impl);\n    }\n\n    var type = '';\n    var tagName = element.tagName;\n\n    if (tagName == 'TEMPLATE') {\n      type = element.getAttribute('type');\n    } else if (tagName == 'SCRIPT') {\n      type = element.getAttribute('template');\n    }\n\n    (0, _log.userAssert)(type, 'Type must be specified: %s', element);\n    var promise = element[PROP_PROMISE_];\n\n    if (promise) {\n      return promise;\n    }\n\n    promise = this.waitForTemplateClass_(element, type).then(function (templateClass) {\n      var impl = element[PROP_] = new templateClass(element, _this4.win_);\n      delete element[PROP_PROMISE_];\n      return impl;\n    });\n    element[PROP_PROMISE_] = promise;\n    return promise;\n  }\n  /**\n   * Returns the promise that will eventually yield the template class. This\n   * will wait until the actual template script has been downloaded and parsed.\n   * @param {!Element} element\n   * @param {string} type\n   * @return {!Promise<!TemplateClassDef>}\n   * @private\n   */\n  ;\n\n  _proto2.waitForTemplateClass_ = function waitForTemplateClass_(element, type) {\n    if (this.templateClassMap_[type]) {\n      return this.templateClassMap_[type];\n    }\n\n    var deferred = new _promise.Deferred();\n    var promise = deferred.promise,\n        resolve = deferred.resolve;\n    this.templateClassMap_[type] = promise;\n    this.templateClassResolvers_[type] = resolve;\n    return promise;\n  }\n  /**\n   * Registers an extended template. This function should typically be called\n   * through the registerTemplate method on the AMP runtime.\n   * @param {string} type\n   * @param {!TemplateClassDef} templateClass\n   * @private\n   * @restricted\n   */\n  ;\n\n  _proto2.registerTemplate_ = function registerTemplate_(type, templateClass) {\n    if (!this.templateClassMap_[type]) {\n      this.templateClassMap_[type] = Promise.resolve(templateClass);\n    } else {\n      var resolver = this.templateClassResolvers_[type];\n      (0, _log.userAssert)(resolver, 'Duplicate template type: %s', type);\n      delete this.templateClassResolvers_[type];\n      resolver(templateClass);\n    }\n  }\n  /**\n   * @param {!BaseTemplate} impl\n   * @param {!JsonObject} data\n   * @return {!Element}\n   * @private\n   */\n  ;\n\n  _proto2.render_ = function render_(impl, data) {\n    return impl.render(data);\n  }\n  /**\n   * @param {!BaseTemplate} impl\n   * @param {string} html\n   * @return {!Element}\n   * @private\n   */\n  ;\n\n  _proto2.setHtml_ = function setHtml_(impl, html) {\n    return impl.setHtml(html);\n  };\n\n  return Templates;\n}();\n/**\n * @param {!Window} win\n */\n\n\nexports.Templates = Templates;\n\nfunction installTemplatesService(win) {\n  (0, _service.registerServiceBuilder)(win, 'templates', Templates);\n}\n/**\n * Registers an extended template. This function should typically be called\n * through the registerTemplate method on the AMP runtime.\n * @param {!Window} win\n * @param {string} type\n * @param {!TemplateClassDef} templateClass\n * @return {undefined}\n */\n\n\nfunction registerExtendedTemplate(win, type, templateClass) {\n  var templatesService = (0, _service.getService)(win, 'templates');\n  return templatesService.registerTemplate_(type, templateClass);\n}\n\n},{\"../dom\":41,\"../log\":68,\"../service\":79,\"../services\":123,\"../utils/promise\":147}],108:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installTimerService = installTimerService;\nexports.installTimerInEmbedWindow = installTimerInEmbedWindow;\nexports.cancelTimersForTesting = cancelTimersForTesting;\nexports.Timer = void 0;\n\nvar _mode = require(\"../mode\");\n\nvar _service = require(\"../service\");\n\nvar _error = require(\"../error\");\n\nvar _log = require(\"../log\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG = 'timer';\nvar timersForTesting;\n/**\n * Helper with all things Timer.\n */\n\nvar Timer =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function Timer(win) {\n    /** @const {!Window} */\n    this.win = win;\n    /** @private @const {!Promise}  */\n\n    this.resolved_ = this.win.Promise.resolve();\n    this.taskCount_ = 0;\n    this.canceled_ = {};\n    /** @const {number} */\n\n    this.startTime_ = Date.now();\n  }\n  /**\n   * Returns time since start in milliseconds.\n   * @return {number}\n   */\n\n\n  var _proto = Timer.prototype;\n\n  _proto.timeSinceStart = function timeSinceStart() {\n    return Date.now() - this.startTime_;\n  }\n  /**\n   * Runs the provided callback after the specified delay. This uses a micro\n   * task for 0 or no specified time. This means that the delay will actually\n   * be close to 0 and this will NOT yield to the event queue.\n   *\n   * Returns the timer ID that can be used to cancel the timer (cancel method).\n   * @param {function()} callback\n   * @param {number=} opt_delay\n   * @return {number|string}\n   */\n  ;\n\n  _proto.delay = function delay(callback, opt_delay) {\n    var _this = this;\n\n    if (!opt_delay) {\n      // For a delay of zero,  schedule a promise based micro task since\n      // they are predictably fast.\n      var id = 'p' + this.taskCount_++;\n      this.resolved_.then(function () {\n        if (_this.canceled_[id]) {\n          delete _this.canceled_[id];\n          return;\n        }\n\n        callback();\n      }).catch(_error.reportError);\n      return id;\n    }\n\n    var wrapped = function wrapped() {\n      try {\n        callback();\n      } catch (e) {\n        (0, _error.reportError)(e);\n        throw e;\n      }\n    };\n\n    var index = this.win.setTimeout(wrapped, opt_delay);\n\n    if ((0, _mode.getMode)().test) {\n      if (!timersForTesting) {\n        timersForTesting = [];\n      }\n\n      timersForTesting.push(index);\n    }\n\n    return index;\n  }\n  /**\n   * Cancels the previously scheduled callback.\n   * @param {number|string|null} timeoutId\n   */\n  ;\n\n  _proto.cancel = function cancel(timeoutId) {\n    if (typeof timeoutId == 'string') {\n      this.canceled_[timeoutId] = true;\n      return;\n    }\n\n    this.win.clearTimeout(timeoutId);\n  }\n  /**\n   * Returns a promise that will resolve after the delay. Optionally, the\n   * resolved value can be provided as opt_result argument.\n   * @param {number=} opt_delay\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.promise = function promise(opt_delay) {\n    var _this2 = this;\n\n    return new this.win.Promise(function (resolve) {\n      // Avoid wrapping in closure if no specific result is produced.\n      var timerKey = _this2.delay(resolve, opt_delay);\n\n      if (timerKey == -1) {\n        throw new Error('Failed to schedule timer.');\n      }\n    });\n  }\n  /**\n   * Returns a promise that will fail after the specified delay. Optionally,\n   * this method can take opt_racePromise parameter. In this case, the\n   * resulting promise will either fail when the specified delay expires or\n   * will resolve based on the opt_racePromise, whichever happens first.\n   * @param {number} delay\n   * @param {?Promise<RESULT>|undefined} opt_racePromise\n   * @param {string=} opt_message\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   */\n  ;\n\n  _proto.timeoutPromise = function timeoutPromise(delay, opt_racePromise, opt_message) {\n    var _this3 = this;\n\n    var timerKey;\n    var delayPromise = new this.win.Promise(function (_resolve, reject) {\n      timerKey = _this3.delay(function () {\n        reject((0, _log.user)().createError(opt_message || 'timeout'));\n      }, delay);\n\n      if (timerKey == -1) {\n        throw new Error('Failed to schedule timer.');\n      }\n    });\n\n    if (!opt_racePromise) {\n      return delayPromise;\n    }\n\n    var cancel = function cancel() {\n      _this3.cancel(timerKey);\n    };\n\n    opt_racePromise.then(cancel, cancel);\n    return this.win.Promise.race([delayPromise, opt_racePromise]);\n  }\n  /**\n   * Returns a promise that resolves after `predicate` returns true.\n   * Polls with interval `delay`\n   * @param {number} delay\n   * @param {function():boolean} predicate\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.poll = function poll(delay, predicate) {\n    var _this4 = this;\n\n    return new this.win.Promise(function (resolve) {\n      var interval = _this4.win.setInterval(function () {\n        if (predicate()) {\n          _this4.win.clearInterval(interval);\n\n          resolve();\n        }\n      }, delay);\n    });\n  };\n\n  return Timer;\n}();\n/**\n * @param {!Window} window\n */\n\n\nexports.Timer = Timer;\n\nfunction installTimerService(window) {\n  (0, _service.registerServiceBuilder)(window, TAG, Timer);\n}\n/**\n * @param {!Window} embedWin\n */\n\n\nfunction installTimerInEmbedWindow(embedWin) {\n  (0, _service.installServiceInEmbedScope)(embedWin, TAG, new Timer(embedWin));\n}\n/**\n * Cancels all timers scheduled during the current test\n */\n\n\nfunction cancelTimersForTesting() {\n  if (!timersForTesting) {\n    return;\n  }\n\n  timersForTesting.forEach(clearTimeout);\n  timersForTesting = null;\n}\n\n},{\"../error\":44,\"../log\":68,\"../mode\":70,\"../service\":79}],109:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.Expander = exports.NOENCODE_WHITELIST = void 0;\n\nvar _object = require(\"../../utils/object\");\n\nvar _log = require(\"../../log\");\n\nvar _string = require(\"../../string\");\n\nvar _promise = require(\"../../utils/promise\");\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @private @const {string} */\nvar PARSER_IGNORE_FLAG = '`';\n/** @private @const {string} */\n\nvar TAG = 'Expander';\n/** A whitelist for replacements whose values should not be %-encoded. */\n\n/** @const {Object<string, boolean>} */\n\nvar NOENCODE_WHITELIST = {\n  'ANCESTOR_ORIGIN': true\n};\n/** Rudamentary parser to handle nested Url replacement. */\n\nexports.NOENCODE_WHITELIST = NOENCODE_WHITELIST;\n\nvar Expander =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Link this instance of parser to the calling UrlReplacment\n   * @param {?../variable-source.VariableSource} variableSource the keywords to replace\n   * @param {!Object<string, *>=} opt_bindings additional one-off bindings\n   * @param {!Object<string, *>=} opt_collectVars Object passed in to collect\n   *   variable resolutions.\n   * @param {boolean=} opt_sync If the method should resolve syncronously.\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of names\n   *   that can be substituted.\n   * @param {boolean=} opt_noEncode Should not urlEncode macro resolution.\n   */\n  function Expander(variableSource, opt_bindings, opt_collectVars, opt_sync, opt_whiteList, opt_noEncode) {\n    /** @const {?../variable-source.VariableSource} */\n    this.variableSource_ = variableSource;\n    /**@const {!Object<string, *>|undefined} */\n\n    this.bindings_ = opt_bindings; // TODO(ccordry): Remove this output object passed into constructor.\n\n    /**@const {!Object<string, *>|undefined} */\n\n    this.collectVars_ = opt_collectVars;\n    /**@const {boolean|undefined} */\n\n    this.sync_ = opt_sync;\n    /**@const {!Object<string, boolean>|undefined} */\n\n    this.whiteList_ = opt_whiteList;\n    /**@const {boolean|undefined} */\n\n    this.encode_ = !opt_noEncode;\n  }\n  /**\n   * take the template url and return a promise of its evaluated value\n   * @param {string} url url to be substituted\n   * @return {!Promise<string>|string}\n   */\n\n\n  var _proto = Expander.prototype;\n\n  _proto.expand = function expand(url) {\n    if (!url.length) {\n      return this.sync_ ? url : Promise.resolve(url);\n    }\n\n    var expr = this.variableSource_.getExpr(this.bindings_, this.whiteList_);\n    var matches = this.findMatches_(url, expr); // if no keywords move on\n\n    if (!matches.length) {\n      return this.sync_ ? url : Promise.resolve(url);\n    }\n\n    return this.parseUrlRecursively_(url, matches);\n  }\n  /**\n   * Return any macros that exist in the given url.\n   * @param {string} url\n   * @return {!Array}\n   */\n  ;\n\n  _proto.getMacroNames = function getMacroNames(url) {\n    var expr = this.variableSource_.getExpr(this.bindings_, this.whiteList_);\n    var matches = url.match(expr);\n\n    if (matches) {\n      return matches;\n    }\n\n    return [];\n  }\n  /**\n   * Structures the regex matching into the desired format\n   * @param {string} url url to be substituted\n   * @param {RegExp} expression regex containing all keywords\n   * @return {Array<Object<string, string|number>>} array of objects representing\n   *  matching keywords\n   */\n  ;\n\n  _proto.findMatches_ = function findMatches_(url, expression) {\n    var matches = [];\n    url.replace(expression, function (match, name, startPosition) {\n      var length = match.length;\n      var stopPosition = length + startPosition - 1;\n      var info = {\n        start: startPosition,\n        stop: stopPosition,\n        name: name,\n        length: length\n      };\n      matches.push(info);\n    });\n    return matches;\n  }\n  /**\n   * @param {string} url\n   * @param {!Array<Object<string, string|number>>} matches Array of objects\n   *   representing matching keywords.\n   * @return {!Promise<string>|string}\n   */\n  ;\n\n  _proto.parseUrlRecursively_ = function parseUrlRecursively_(url, matches) {\n    var _this = this;\n\n    var stack = [];\n    var urlIndex = 0;\n    var matchIndex = 0;\n    var match = matches[matchIndex];\n    var numOfPendingCalls = 0;\n    var ignoringChars = false;\n    var nextArgShouldBeRaw = false;\n\n    var evaluateNextLevel = function evaluateNextLevel(encode) {\n      var builder = '';\n      var results = [];\n      var args = [];\n\n      while (urlIndex < url.length && matchIndex <= matches.length) {\n        if (match && urlIndex === match.start) {\n          // Collect any chars that may be prefixing the macro, if we are in\n          // a nested context trim the args.\n          if (builder.trim().length) {\n            results.push(numOfPendingCalls ? (0, _string.trimStart)(builder) : builder);\n          } // If we know we are at the start of a macro, we figure out how to\n          // resolve it, and move our pointer to after the token.\n\n\n          var binding = void 0; // Find out where this macro is coming from. Could be from the passed\n          // in optional bindings, or the global variable source.\n\n          if (_this.bindings_ && (0, _object.hasOwn)(_this.bindings_, match.name)) {\n            // Macro is from optional bindings.\n            binding = {\n              // This construction helps us save the match name and determine\n              // precedence of resolution choices in #expandBinding_ later.\n              name: match.name,\n              prioritized: _this.bindings_[match.name],\n              encode: encode\n            };\n          } else {\n            // Macro is from the global source.\n            binding = Object.assign({}, _this.variableSource_.get(match.name), {\n              name: match.name,\n              encode: encode\n            });\n          }\n\n          urlIndex = match.stop + 1;\n          match = matches[++matchIndex];\n\n          if (url[urlIndex] === '(') {\n            // When we see a `(` we know we need to resolve one level deeper\n            // before continuing. We push the binding in the stack for\n            // resolution later, and then make the recursive call.\n            urlIndex++;\n            numOfPendingCalls++;\n            stack.push(binding);\n            results.push(evaluateNextLevel(\n            /* encode */\n            false));\n          } else {\n            // Many macros do not take arguments, in this case we do not need to\n            // recurse, we just start resolution in it's position.\n            results.push(_this.evaluateBinding_(binding));\n          }\n\n          builder = '';\n        } else if (url[urlIndex] === PARSER_IGNORE_FLAG) {\n          if (!ignoringChars) {\n            ignoringChars = true;\n            nextArgShouldBeRaw = true;\n            (0, _log.userAssert)(builder.trim() === '', \"The substring \\\"\" + builder + \"\\\" was lost during url-replacement. \" + 'Please ensure the url syntax is correct');\n            builder = '';\n          } else {\n            ignoringChars = false;\n          }\n\n          urlIndex++;\n        } else if (numOfPendingCalls && url[urlIndex] === ',' && !ignoringChars) {\n          // Commas tell us to create a new argument when in nested context and\n          // not ignoring them due to backticks. We push any string built so far,\n          // create a new array for the next argument, and reset our string\n          // builder.\n          if (builder.length) {\n            var nextArg = nextArgShouldBeRaw ? builder : builder.trim();\n            results.push(nextArg);\n            nextArgShouldBeRaw = false;\n          }\n\n          args.push(results);\n          results = []; // Support existing two comma format by pushing an empty string as\n          // argument. eg CLIENT_ID(__ga,,ga-url)\n\n          if (url[urlIndex + 1] === ',') {\n            args.push(['']);\n            urlIndex++;\n          }\n\n          builder = '';\n          urlIndex++;\n        } // Invoke a function on every right parenthesis unless the stack is\n        // empty. This is where we actually evaluate any macro that takes an\n        // argument. We pop the macro resover off the stack, and take anying left\n        // in our string builder and add it as the final section of the final\n        // arg. Then we call the resolver.\n        else if (numOfPendingCalls && url[urlIndex] === ')' && !ignoringChars) {\n            urlIndex++;\n            numOfPendingCalls--;\n\n            var _binding = stack.pop();\n\n            var _nextArg = nextArgShouldBeRaw ? builder : builder.trim();\n\n            if (_nextArg) {\n              results.push(_nextArg);\n            }\n\n            args.push(results);\n            nextArgShouldBeRaw = false;\n\n            var value = _this.evaluateBinding_(_binding,\n            /* opt_args */\n            args);\n\n            return value;\n          } else {\n            // This is the most common case. Just building a string as we walk\n            // along.\n            builder += url[urlIndex];\n            urlIndex++;\n          } // Capture any trailing characters.\n\n\n        if (urlIndex === url.length && builder.length) {\n          results.push(builder);\n        }\n      } // TODO: If there is a single item in results, we should preserve it's\n      // type when returning here and the async version below.\n\n\n      if (_this.sync_) {\n        return results.join('');\n      }\n\n      return Promise.all(results).then(function (promiseArray) {\n        return promiseArray.join('');\n      }).catch(function (e) {\n        (0, _log.rethrowAsync)(e);\n        return '';\n      });\n    };\n\n    return evaluateNextLevel(this.encode_);\n  }\n  /**\n   * Called when a binding is ready to be resolved. Determines which version of\n   * binding to use and if syncronous or asyncronous version should be called.\n   * @param {Object<string, *>} bindingInfo An object containing the name of\n   *    macro and value to be resolved.\n   * @param {Array=} opt_args Arguments passed to the macro. Arguments come as\n   *    an array of arrays that will be eventually passed to a function.apply\n   *    invocation. For example: FOO(BARBAR, 123) => When we are ready to evaluate\n   *    the FOO binding opt_args will be [[Result of BAR, Result of BAR], [123]].\n   *    This structure is so that the outer array will have the correct number of\n   *    arguments, but we still can resolve each macro separately.\n   * @return {string|!Promise<string>}\n   */\n  ;\n\n  _proto.evaluateBinding_ = function evaluateBinding_(bindingInfo, opt_args) {\n    var encode = bindingInfo.encode,\n        name = bindingInfo.name;\n    var binding;\n\n    if (bindingInfo.prioritized != undefined) {\n      // Has to explicity check for undefined because bindingInfo.priorityized\n      // could not be a function but a false value. For example {FOO: 0}\n      // If a binding is passed in through the bindings argument it always takes\n      // precedence.\n      binding = bindingInfo.prioritized;\n    } else if (this.sync_ && bindingInfo.sync != undefined) {\n      // Use the sync resolution if avaliable when called synchronously.\n      binding = bindingInfo.sync;\n    } else if (this.sync_) {\n      // If there is no sync resolution we can not wait.\n      (0, _log.user)().error(TAG, 'ignoring async replacement key: ', bindingInfo.name);\n      binding = '';\n    } else {\n      // Prefer the async over the sync but it may not exist.\n      binding = bindingInfo.async || bindingInfo.sync;\n    } // We should only ever encode the top level resolution, or not at all.\n\n\n    var shouldEncode = encode && !NOENCODE_WHITELIST[name];\n\n    if (this.sync_) {\n      var result = this.evaluateBindingSync_(binding, name, opt_args);\n      return shouldEncode ? encodeURIComponent(result) : result;\n    } else {\n      return this.evaluateBindingAsync_(binding, name, opt_args).then(function (result) {\n        return shouldEncode ? encodeURIComponent(result) : result;\n      });\n    }\n  }\n  /**\n   * Resolves binding to value to be substituted asyncronously.\n   * @param {*} binding Container for sync/async resolutions.\n   * @param {string} name\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   * @return {!Promise<string>} Resolved value.\n   */\n  ;\n\n  _proto.evaluateBindingAsync_ = function evaluateBindingAsync_(binding, name, opt_args) {\n    var _this2 = this;\n\n    var value;\n\n    try {\n      if (typeof binding === 'function') {\n        if (opt_args) {\n          value = this.processArgsAsync_(opt_args).then(function (args) {\n            return binding.apply(null, args);\n          });\n        } else {\n          value = (0, _promise.tryResolve)(binding);\n        }\n      } else {\n        value = Promise.resolve(binding);\n      }\n\n      return value.then(function (val) {\n        _this2.maybeCollectVars_(name, val, opt_args);\n\n        var result;\n\n        if (val == null) {\n          result = '';\n        } else {\n          result = val;\n        }\n\n        return result;\n      }).catch(function (e) {\n        (0, _log.rethrowAsync)(e);\n\n        _this2.maybeCollectVars_(name, '', opt_args);\n\n        return Promise.resolve('');\n      });\n    } catch (e) {\n      // Report error, but do not disrupt URL replacement. This will\n      // interpolate as the empty string.\n      (0, _log.rethrowAsync)(e);\n      this.maybeCollectVars_(name, '', opt_args);\n      return Promise.resolve('');\n    }\n  }\n  /**\n   * Flattens the inner layer of an array of arrays so that the result can be\n   * passed to a function.apply call. Must wait for any inner macros to resolve.\n   * This will cast all arguments to string before calling the macro.\n   *  [[Result of BAR, Result of BAR], 123]. => ['resultresult', '123']\n   * @param {!Array<!Array>} argsArray\n   * @return {!Promise<Array<string>>}\n   */\n  ;\n\n  _proto.processArgsAsync_ = function processArgsAsync_(argsArray) {\n    return Promise.all(argsArray.map(function (argArray) {\n      return Promise.all(argArray).then(function (resolved) {\n        return resolved.join('');\n      });\n    }));\n  }\n  /**\n   * Resolves binding to value to be substituted asyncronously.\n   * @param {*} binding Container for sync/async resolutions.\n   * @param {string} name\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   * @return {string} Resolved value.\n   */\n  ;\n\n  _proto.evaluateBindingSync_ = function evaluateBindingSync_(binding, name, opt_args) {\n    try {\n      var value = binding;\n\n      if (typeof binding === 'function') {\n        value = binding.apply(null, this.processArgsSync_(opt_args));\n      }\n\n      var result;\n\n      if (value && value.then) {\n        // If binding is passed in as opt_binding we try to resolve it and it\n        // may return a promise. NOTE: We do not collect this discarded value,\n        // even if collectVars exists.\n        (0, _log.user)().error(TAG, 'ignoring async macro resolution');\n        result = '';\n      } else if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\n        // Normal case.\n        this.maybeCollectVars_(name, value, opt_args); // TODO: We should try to preserve type here.\n\n        result = value.toString();\n      } else {\n        // Most likely a broken binding gets us here.\n        this.maybeCollectVars_(name, '', opt_args);\n        result = '';\n      }\n\n      return result;\n    } catch (e) {\n      // Report error, but do not disrupt URL replacement. This will\n      // interpolate as the empty string.\n      (0, _log.rethrowAsync)(e);\n      this.maybeCollectVars_(name, '', opt_args);\n      return '';\n    }\n  }\n  /**\n   * Flattens the inner layer of an array of arrays so that the result can be\n   * passed to a function.apply call. Will not wait for any promise to resolve.\n   * This will cast all arguments to string before calling the macro.\n   *  [[Result of BAR, Result of BAR], 123]. => ['resultresult', '123']\n   * @param {Array<!Array>|undefined} argsArray\n   * @return {Array<string>|undefined}\n   */\n  ;\n\n  _proto.processArgsSync_ = function processArgsSync_(argsArray) {\n    if (!argsArray) {\n      return argsArray;\n    }\n\n    return argsArray.map(function (argArray) {\n      return argArray.join('');\n    });\n  }\n  /**\n   * Collect vars if given the optional object. Handles formatting of kv pairs.\n   * @param {string} name Name of the macro.\n   * @param {*} value Raw macro resolution value.\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   */\n  ;\n\n  _proto.maybeCollectVars_ = function maybeCollectVars_(name, value, opt_args) {\n    if (!this.collectVars_) {\n      return;\n    }\n\n    var args = '';\n\n    if (opt_args) {\n      var rawArgs = opt_args.filter(function (arg) {\n        return arg !== '';\n      }).join(',');\n      args = \"(\" + rawArgs + \")\";\n    }\n\n    this.collectVars_[\"\" + name + args] = value || '';\n  };\n\n  return Expander;\n}();\n\nexports.Expander = Expander;\n\n},{\"../../log\":68,\"../../string\":126,\"../../utils/object\":145,\"../../utils/promise\":147}],110:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installUrlForDoc = installUrlForDoc;\nexports.Url = void 0;\n\nvar _lruCache = require(\"../utils/lru-cache\");\n\nvar _url = require(\"../url\");\n\nvar _service = require(\"../service\");\n\nvar _config = require(\"../config\");\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar SERVICE = 'url';\n/**\n * @implements {../service.EmbeddableService}\n */\n\nvar Url =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_rootNode\n   */\n  function Url(ampdoc, opt_rootNode) {\n    // TODO(#22733): remove subroooting once ampdoc-fie is launched.\n    var root = opt_rootNode || ampdoc.getRootNode();\n    var doc = root.ownerDocument || root;\n    /** @private @const {!HTMLAnchorElement} */\n\n    this.anchor_ =\n    /** @type {!HTMLAnchorElement} */\n    doc.createElement('a');\n    /** @private @const {!LruCache} */\n\n    this.cache_ = new _lruCache.LruCache(100);\n  }\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n\n\n  Url.installInEmbedWindow = function installInEmbedWindow(embedWin, ampdoc) {\n    (0, _service.installServiceInEmbedScope)(embedWin, SERVICE, new Url(ampdoc, embedWin.document));\n  }\n  /**\n   * Parses the URL in the context of the current document.\n   *\n   * @param {string} url\n   * @param {boolean=} opt_nocache\n   * @return {!Location}\n   */\n  ;\n\n  var _proto = Url.prototype;\n\n  _proto.parse = function parse(url, opt_nocache) {\n    return (0, _url.parseUrlWithA)(this.anchor_, url, opt_nocache ? null : this.cache_);\n  }\n  /**\n   * @param {string|!Location} url\n   * @return {!Location}\n   * @private\n   */\n  ;\n\n  _proto.parse_ = function parse_(url) {\n    if (typeof url !== 'string') {\n      return url;\n    }\n\n    return this.parse(url);\n  }\n  /**\n   * Returns whether the URL has valid protocol.\n   * Deep link protocol is valid, but not javascript etc.\n   * @param {string|!Location} url\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isProtocolValid = function isProtocolValid(url) {\n    return (0, _url.isProtocolValid)(url);\n  }\n  /**\n   * Returns the source origin of an AMP document for documents served\n   * on a proxy origin or directly.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {string} The source origin of the URL.\n   */\n  ;\n\n  _proto.getSourceOrigin = function getSourceOrigin(url) {\n    return (0, _url.getSourceOrigin)(this.parse_(url));\n  }\n  /**\n   * Returns the source URL of an AMP document for documents served\n   * on a proxy origin or directly.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {string}\n   */\n  ;\n\n  _proto.getSourceUrl = function getSourceUrl(url) {\n    return (0, _url.getSourceUrl)(this.parse_(url));\n  }\n  /**\n   * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n   * assert.\n   *\n   * Provides an exception for localhost.\n   *\n   * @param {?string|undefined} urlString\n   * @param {!Element|string} elementContext Element where the url was found.\n   * @param {string=} sourceName Used for error messages.\n   * @return {string}\n   */\n  ;\n\n  _proto.assertHttpsUrl = function assertHttpsUrl(urlString, elementContext, sourceName) {\n    if (sourceName === void 0) {\n      sourceName = 'source';\n    }\n\n    return (0, _url.assertHttpsUrl)(urlString, elementContext, sourceName);\n  }\n  /**\n   * Asserts that a given url is an absolute HTTP or HTTPS URL.\n   * @param {string} urlString\n   * @return {string}\n   */\n  ;\n\n  _proto.assertAbsoluteHttpOrHttpsUrl = function assertAbsoluteHttpOrHttpsUrl(urlString) {\n    return (0, _url.assertAbsoluteHttpOrHttpsUrl)(urlString);\n  }\n  /**\n   * Returns whether the URL has the origin of a proxy.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isProxyOrigin = function isProxyOrigin(url) {\n    return (0, _url.isProxyOrigin)(this.parse_(url));\n  }\n  /**\n   * Returns `true` if the URL is secure: either HTTPS or localhost (for\n   * testing).\n   * @param {string} url\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isSecure = function isSecure(url) {\n    return (0, _url.isSecureUrlDeprecated)(this.parse_(url));\n  }\n  /**\n   * Returns the correct origin for a given window.\n   * @param {!Window} win\n   * @return {string} origin\n   */\n  ;\n\n  _proto.getWinOrigin = function getWinOrigin(win) {\n    return win.origin || this.parse_(win.location.href).origin;\n  }\n  /**\n   * If the resource URL is referenced from the publisher's origin,\n   * convert the URL to be referenced from the cache.\n   * @param {string} resourceUrl The URL of the document to load\n   * @return {string}\n   */\n  ;\n\n  _proto.getCdnUrlOnOrigin = function getCdnUrlOnOrigin(resourceUrl) {\n    if ((0, _url.isProxyOrigin)(resourceUrl)) {\n      return resourceUrl;\n    }\n\n    var _this$parse_ = this.parse_(resourceUrl),\n        host = _this$parse_.host,\n        hash = _this$parse_.hash,\n        pathname = _this$parse_.pathname,\n        search = _this$parse_.search;\n\n    var encodedHost = encodeURIComponent(host);\n    return _config.urls.cdn + \"/c/\" + encodedHost + pathname + search + hash;\n  };\n\n  return Url;\n}();\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nexports.Url = Url;\n\nfunction installUrlForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, SERVICE, Url,\n  /* opt_instantiate */\n  true);\n}\n\n},{\"../config\":32,\"../service\":79,\"../url\":134,\"../utils/lru-cache\":143}],111:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.extractClientIdFromGaCookie = extractClientIdFromGaCookie;\nexports.installUrlReplacementsServiceForDoc = installUrlReplacementsServiceForDoc;\nexports.installUrlReplacementsForEmbed = installUrlReplacementsForEmbed;\nexports.UrlReplacements = exports.GlobalVariableSource = void 0;\n\nvar _variableSource = require(\"./variable-source\");\n\nvar _url = require(\"../url\");\n\nvar _log = require(\"../log\");\n\nvar _service = require(\"../service\");\n\nvar _expander = require(\"./url-expander/expander\");\n\nvar _services = require(\"../services\");\n\nvar _windowInterface = require(\"../window-interface\");\n\nvar _impression = require(\"../impression.js\");\n\nvar _object = require(\"../utils/object\");\n\nvar _internalVersion = require(\"../internal-version\");\n\nvar _promise = require(\"../utils/promise\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/** @private @const {string} */\nvar TAG = 'UrlReplacements';\nvar EXPERIMENT_DELIMITER = '!';\nvar VARIANT_DELIMITER = '.';\nvar GEO_DELIM = ',';\nvar ORIGINAL_HREF_PROPERTY = 'amp-original-href';\nvar ORIGINAL_VALUE_PROPERTY = 'amp-original-value';\n/**\n * Returns a function that executes method on a new Date instance. This is a\n * byte saving hack.\n *\n * @param {string} method\n * @return {!SyncResolverDef}\n */\n\nfunction dateMethod(method) {\n  return function () {\n    return new Date()[method]();\n  };\n}\n/**\n * Returns a function that returns property of screen. This is a byte saving\n * hack.\n *\n * @param {!Screen} screen\n * @param {string} property\n * @return {!SyncResolverDef}\n */\n\n\nfunction screenProperty(screen, property) {\n  return function () {\n    return screen[property];\n  };\n}\n/**\n * Class to provide variables that pertain to top level AMP window.\n */\n\n\nvar GlobalVariableSource =\n/*#__PURE__*/\nfunction (_VariableSource) {\n  _inheritsLoose(GlobalVariableSource, _VariableSource);\n\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  function GlobalVariableSource(ampdoc) {\n    var _this;\n\n    _this = _VariableSource.call(this, ampdoc) || this;\n    /** @private {?Promise<?ShareTrackingFragmentsDef>} */\n\n    _this.shareTrackingFragments_ = null;\n    return _this;\n  }\n  /**\n   * Utility function for setting resolver for timing data that supports\n   * sync and async.\n   * @param {string} varName\n   * @param {string} startEvent\n   * @param {string=} endEvent\n   * @return {!VariableSource}\n   * @private\n   */\n\n\n  var _proto = GlobalVariableSource.prototype;\n\n  _proto.setTimingResolver_ = function setTimingResolver_(varName, startEvent, endEvent) {\n    var _this2 = this;\n\n    return this.setBoth(varName, function () {\n      return (0, _variableSource.getTimingDataSync)(_this2.ampdoc.win, startEvent, endEvent);\n    }, function () {\n      return (0, _variableSource.getTimingDataAsync)(_this2.ampdoc.win, startEvent, endEvent);\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.initialize = function initialize() {\n    var _this3 = this;\n\n    var win = this.ampdoc.win;\n    var element = this.ampdoc.getHeadNode();\n    /** @const {!./viewport/viewport-interface.ViewportInterface} */\n\n    var viewport = _services.Services.viewportForDoc(this.ampdoc); // Returns a random value for cache busters.\n\n\n    this.set('RANDOM', function () {\n      return Math.random();\n    }); // Provides a counter starting at 1 per given scope.\n\n    var counterStore = Object.create(null);\n    this.set('COUNTER', function (scope) {\n      return counterStore[scope] = (counterStore[scope] | 0) + 1;\n    }); // Returns the canonical URL for this AMP document.\n\n    this.set('CANONICAL_URL', function () {\n      return _this3.getDocInfo_().canonicalUrl;\n    }); // Returns the host of the canonical URL for this AMP document.\n\n    this.set('CANONICAL_HOST', function () {\n      return (0, _url.parseUrlDeprecated)(_this3.getDocInfo_().canonicalUrl).host;\n    }); // Returns the hostname of the canonical URL for this AMP document.\n\n    this.set('CANONICAL_HOSTNAME', function () {\n      return (0, _url.parseUrlDeprecated)(_this3.getDocInfo_().canonicalUrl).hostname;\n    }); // Returns the path of the canonical URL for this AMP document.\n\n    this.set('CANONICAL_PATH', function () {\n      return (0, _url.parseUrlDeprecated)(_this3.getDocInfo_().canonicalUrl).pathname;\n    }); // Returns the referrer URL.\n\n    this.setAsync('DOCUMENT_REFERRER',\n    /** @type {AsyncResolverDef} */\n    function () {\n      return _services.Services.viewerForDoc(_this3.ampdoc).getReferrerUrl();\n    }); // Like DOCUMENT_REFERRER, but returns null if the referrer is of\n    // same domain or the corresponding CDN proxy.\n\n    this.setAsync('EXTERNAL_REFERRER',\n    /** @type {AsyncResolverDef} */\n    function () {\n      return _services.Services.viewerForDoc(_this3.ampdoc).getReferrerUrl().then(function (referrer) {\n        if (!referrer) {\n          return null;\n        }\n\n        var referrerHostname = (0, _url.parseUrlDeprecated)((0, _url.getSourceUrl)(referrer)).hostname;\n\n        var currentHostname = _windowInterface.WindowInterface.getHostname(win);\n\n        return referrerHostname === currentHostname ? null : referrer;\n      });\n    }); // Returns the title of this AMP document.\n\n    this.set('TITLE', function () {\n      // The environment may override the title and set originalTitle. Prefer\n      // that if available.\n      var doc = win.document;\n      return doc['originalTitle'] || doc.title;\n    }); // Returns the URL for this AMP document.\n\n    this.set('AMPDOC_URL', function () {\n      return (0, _url.removeFragment)(_this3.addReplaceParamsIfMissing_(win.location.href));\n    }); // Returns the host of the URL for this AMP document.\n\n    this.set('AMPDOC_HOST', function () {\n      var url = (0, _url.parseUrlDeprecated)(win.location.href);\n      return url && url.host;\n    }); // Returns the hostname of the URL for this AMP document.\n\n    this.set('AMPDOC_HOSTNAME', function () {\n      var url = (0, _url.parseUrlDeprecated)(win.location.href);\n      return url && url.hostname;\n    }); // Returns the Source URL for this AMP document.\n\n    var expandSourceUrl = function expandSourceUrl() {\n      var docInfo = _this3.getDocInfo_();\n\n      return (0, _url.removeFragment)(_this3.addReplaceParamsIfMissing_(docInfo.sourceUrl));\n    };\n\n    this.setBoth('SOURCE_URL', function () {\n      return expandSourceUrl();\n    }, function () {\n      return (0, _impression.getTrackImpressionPromise)().then(function () {\n        return expandSourceUrl();\n      });\n    }); // Returns the host of the Source URL for this AMP document.\n\n    this.set('SOURCE_HOST', function () {\n      return (0, _url.parseUrlDeprecated)(_this3.getDocInfo_().sourceUrl).host;\n    }); // Returns the hostname of the Source URL for this AMP document.\n\n    this.set('SOURCE_HOSTNAME', function () {\n      return (0, _url.parseUrlDeprecated)(_this3.getDocInfo_().sourceUrl).hostname;\n    }); // Returns the path of the Source URL for this AMP document.\n\n    this.set('SOURCE_PATH', function () {\n      return (0, _url.parseUrlDeprecated)(_this3.getDocInfo_().sourceUrl).pathname;\n    }); // Returns a random string that will be the constant for the duration of\n    // single page view. It should have sufficient entropy to be unique for\n    // all the page views a single user is making at a time.\n\n    this.set('PAGE_VIEW_ID', function () {\n      return _this3.getDocInfo_().pageViewId;\n    }); // Returns a random string that will be the constant for the duration of\n    // single page view. It should have sufficient entropy to be unique for\n    // all the page views a single user is making at a time.\n\n    this.setAsync('PAGE_VIEW_ID_64', function () {\n      return _this3.getDocInfo_().pageViewId64;\n    });\n    this.setBoth('QUERY_PARAM', function (param, defaultValue) {\n      if (defaultValue === void 0) {\n        defaultValue = '';\n      }\n\n      return _this3.getQueryParamData_(param, defaultValue);\n    }, function (param, defaultValue) {\n      if (defaultValue === void 0) {\n        defaultValue = '';\n      }\n\n      return (0, _impression.getTrackImpressionPromise)().then(function () {\n        return _this3.getQueryParamData_(param, defaultValue);\n      });\n    }); // Returns the value of the given field name in the fragment query string.\n    // Second parameter is an optional default value.\n    // For example, if location is 'pub.com/amp.html?x=1#y=2' then\n    // FRAGMENT_PARAM(y) returns '2' and FRAGMENT_PARAM(z, 3) returns 3.\n\n    this.set('FRAGMENT_PARAM', function (param, defaultValue) {\n      if (defaultValue === void 0) {\n        defaultValue = '';\n      }\n\n      return _this3.getFragmentParamData_(param, defaultValue);\n    }); // Returns the first item in the ancestorOrigins array, if available.\n\n    this.setAsync('ANCESTOR_ORIGIN', this.getViewerIntegrationValue_('ancestorOrigin', 'ANCESTOR_ORIGIN'));\n    /**\n     * Stores client ids that were generated during this page view\n     * indexed by scope.\n     * @type {?Object<string, string>}\n     */\n\n    var clientIds = null; // Synchronous alternative. Only works for scopes that were previously\n    // requested using the async method.\n\n    this.setBoth('CLIENT_ID', function (scope) {\n      if (!clientIds) {\n        return null;\n      }\n\n      return clientIds[scope];\n    }, function (scope, opt_userNotificationId, opt_cookieName) {\n      (0, _log.userAssert)(scope, 'The first argument to CLIENT_ID, the fallback' +\n      /*OK*/\n      ' Cookie name, is required');\n      var consent = Promise.resolve(); // If no `opt_userNotificationId` argument is provided then\n      // assume consent is given by default.\n\n      if (opt_userNotificationId) {\n        consent = _services.Services.userNotificationManagerForDoc(element).then(function (service) {\n          return service.get(opt_userNotificationId);\n        });\n      }\n\n      return _services.Services.cidForDoc(_this3.ampdoc).then(function (cid) {\n        return cid.get({\n          /** @type {string} */\n          scope: scope,\n          createCookieIfNotPresent: true,\n          cookieName: opt_cookieName\n        }, consent);\n      }).then(function (cid) {\n        if (!clientIds) {\n          clientIds = Object.create(null);\n        } // A temporary work around to extract Client ID from _ga cookie. #5761\n        // TODO: replace with \"filter\" when it's in place. #2198\n\n\n        var cookieName = opt_cookieName || scope;\n\n        if (cid && cookieName == '_ga') {\n          if (typeof cid === 'string') {\n            cid = extractClientIdFromGaCookie(cid);\n          } else {\n            // TODO(@jridgewell, #11120): remove once #11120 is figured out.\n            // Do not log the CID directly, that's PII.\n            (0, _log.dev)().error(TAG, 'non-string cid, what is it?', Object.keys(cid));\n          }\n        }\n\n        clientIds[scope] = cid;\n        return cid;\n      });\n    }); // Returns assigned variant name for the given experiment.\n\n    this.setAsync('VARIANT',\n    /** @type {AsyncResolverDef} */\n    function (experiment) {\n      return _this3.getVariantsValue_(function (variants) {\n        var variant = variants[\n        /** @type {string} */\n        experiment];\n        (0, _log.userAssert)(variant !== undefined, 'The value passed to VARIANT() is not a valid experiment name:' + experiment); // When no variant assigned, use reserved keyword 'none'.\n\n        return variant === null ? 'none' :\n        /** @type {string} */\n        variant;\n      }, 'VARIANT');\n    }); // Returns all assigned experiment variants in a serialized form.\n\n    this.setAsync('VARIANTS',\n    /** @type {AsyncResolverDef} */\n    function () {\n      return _this3.getVariantsValue_(function (variants) {\n        var experiments = [];\n\n        for (var experiment in variants) {\n          var variant = variants[experiment];\n          experiments.push(experiment + VARIANT_DELIMITER + (variant || 'none'));\n        }\n\n        return experiments.join(EXPERIMENT_DELIMITER);\n      }, 'VARIANTS');\n    }); // Returns assigned geo value for geoType or all groups.\n\n    this.setAsync('AMP_GEO',\n    /** @type {AsyncResolverDef} */\n    function (geoType) {\n      return _this3.getGeo_(function (geos) {\n        if (geoType) {\n          (0, _log.userAssert)(geoType === 'ISOCountry', 'The value passed to AMP_GEO() is not valid name:' + geoType);\n          return (\n            /** @type {string} */\n            geos[geoType] || 'unknown'\n          );\n        }\n\n        return (\n          /** @type {string} */\n          geos.matchedISOCountryGroups.join(GEO_DELIM)\n        );\n      }, 'AMP_GEO');\n    }); // Attempt to returns user location data if available, otherwise null.\n\n    this.setAsync('AMP_USER_LOCATION',\n    /** @type {AsyncResolverDef} */\n    function (type) {\n      // Type may be \"\",\"lat\",\"lon\", and undefined\n      return _this3.getUserLocation_(function (userLocationService) {\n        return userLocationService.getReplacementLocation('AMP_USER_LOCATION', type);\n      }, 'AMP_USER_LOCATION');\n    }); // Returns user location data only if available,\n    // and waits for the user to approve.\n\n    this.setAsync('AMP_USER_LOCATION_POLL',\n    /** @type {AsyncResolverDef} */\n    function (type) {\n      // Type may be \"\",\"lat\",\"lon\", and undefined\n      return _this3.getUserLocation_(function (userLocationService) {\n        return userLocationService.getReplacementLocation('AMP_USER_LOCATION_POLL', type,\n        /*opt_poll*/\n        true);\n      }, 'AMP_USER_LOCATION_POLL');\n    }); // Returns incoming share tracking fragment.\n\n    this.setAsync('SHARE_TRACKING_INCOMING',\n    /** @type {AsyncResolverDef} */\n    function () {\n      return _this3.getShareTrackingValue_(function (fragments) {\n        return fragments.incomingFragment;\n      }, 'SHARE_TRACKING_INCOMING');\n    }); // Returns outgoing share tracking fragment.\n\n    this.setAsync('SHARE_TRACKING_OUTGOING',\n    /** @type {AsyncResolverDef} */\n    function () {\n      return _this3.getShareTrackingValue_(function (fragments) {\n        return fragments.outgoingFragment;\n      }, 'SHARE_TRACKING_OUTGOING');\n    }); // Returns the number of milliseconds since 1 Jan 1970 00:00:00 UTC.\n\n    this.set('TIMESTAMP', dateMethod('getTime')); // Returns the human readable timestamp in format of\n    // 2011-01-01T11:11:11.612Z.\n\n    this.set('TIMESTAMP_ISO', dateMethod('toISOString')); // Returns the user's time-zone offset from UTC, in minutes.\n\n    this.set('TIMEZONE', dateMethod('getTimezoneOffset')); // Returns the IANA timezone code\n\n    this.set('TIMEZONE_CODE', function () {\n      var tzCode;\n\n      if ('Intl' in win && 'DateTimeFormat' in win.Intl) {\n        // It could be undefined (i.e. IE11)\n        tzCode = new Intl.DateTimeFormat().resolvedOptions().timeZone;\n      }\n\n      return tzCode || '';\n    }); // Returns a promise resolving to viewport.getScrollTop.\n\n    this.set('SCROLL_TOP', function () {\n      return viewport.getScrollTop();\n    }); // Returns a promise resolving to viewport.getScrollLeft.\n\n    this.set('SCROLL_LEFT', function () {\n      return viewport.getScrollLeft();\n    }); // Returns a promise resolving to viewport.getScrollHeight.\n\n    this.set('SCROLL_HEIGHT', function () {\n      return viewport.getScrollHeight();\n    }); // Returns a promise resolving to viewport.getScrollWidth.\n\n    this.set('SCROLL_WIDTH', function () {\n      return viewport.getScrollWidth();\n    }); // Returns the viewport height.\n\n    this.set('VIEWPORT_HEIGHT', function () {\n      return viewport.getHeight();\n    }); // Returns the viewport width.\n\n    this.set('VIEWPORT_WIDTH', function () {\n      return viewport.getWidth();\n    });\n    var screen = win.screen; // Returns screen.width.\n\n    this.set('SCREEN_WIDTH', screenProperty(screen, 'width')); // Returns screen.height.\n\n    this.set('SCREEN_HEIGHT', screenProperty(screen, 'height')); // Returns screen.availHeight.\n\n    this.set('AVAILABLE_SCREEN_HEIGHT', screenProperty(screen, 'availHeight')); // Returns screen.availWidth.\n\n    this.set('AVAILABLE_SCREEN_WIDTH', screenProperty(screen, 'availWidth')); // Returns screen.ColorDepth.\n\n    this.set('SCREEN_COLOR_DEPTH', screenProperty(screen, 'colorDepth')); // Returns document characterset.\n\n    this.set('DOCUMENT_CHARSET', function () {\n      var doc = win.document;\n      return doc.characterSet || doc.charset;\n    }); // Returns the browser language.\n\n    this.set('BROWSER_LANGUAGE', function () {\n      var nav = win.navigator;\n      return (nav.language || nav.userLanguage || nav.browserLanguage || '').toLowerCase();\n    }); // Returns the user agent.\n\n    this.set('USER_AGENT', function () {\n      return win.navigator.userAgent;\n    }); // Returns the time it took to load the whole page. (excludes amp-* elements\n    // that are not rendered by the system yet.)\n\n    this.setTimingResolver_('PAGE_LOAD_TIME', 'navigationStart', 'loadEventStart'); // Returns the time it took to perform DNS lookup for the domain.\n\n    this.setTimingResolver_('DOMAIN_LOOKUP_TIME', 'domainLookupStart', 'domainLookupEnd'); // Returns the time it took to connect to the server.\n\n    this.setTimingResolver_('TCP_CONNECT_TIME', 'connectStart', 'connectEnd'); // Returns the time it took for server to start sending a response to the\n    // request.\n\n    this.setTimingResolver_('SERVER_RESPONSE_TIME', 'requestStart', 'responseStart'); // Returns the time it took to download the page.\n\n    this.setTimingResolver_('PAGE_DOWNLOAD_TIME', 'responseStart', 'responseEnd'); // Returns the time it took for redirects to complete.\n\n    this.setTimingResolver_('REDIRECT_TIME', 'navigationStart', 'fetchStart'); // Returns the time it took for DOM to become interactive.\n\n    this.setTimingResolver_('DOM_INTERACTIVE_TIME', 'navigationStart', 'domInteractive'); // Returns the time it took for content to load.\n\n    this.setTimingResolver_('CONTENT_LOAD_TIME', 'navigationStart', 'domContentLoadedEventStart'); // Access: Reader ID.\n\n    this.setAsync('ACCESS_READER_ID',\n    /** @type {AsyncResolverDef} */\n    function () {\n      return _this3.getAccessValue_(function (accessService) {\n        return accessService.getAccessReaderId();\n      }, 'ACCESS_READER_ID');\n    }); // Access: data from the authorization response.\n\n    this.setAsync('AUTHDATA',\n    /** @type {AsyncResolverDef} */\n    function (field) {\n      (0, _log.userAssert)(field, 'The first argument to AUTHDATA, the field, is required');\n      return _this3.getAccessValue_(function (accessService) {\n        return accessService.getAuthdataField(field);\n      }, 'AUTHDATA');\n    }); // Returns an identifier for the viewer.\n\n    this.setAsync('VIEWER', function () {\n      return _services.Services.viewerForDoc(_this3.ampdoc).getViewerOrigin().then(function (viewer) {\n        return viewer == undefined ? '' : viewer;\n      });\n    }); // Returns the total engaged time since the content became viewable.\n\n    this.setAsync('TOTAL_ENGAGED_TIME', function () {\n      return _services.Services.activityForDoc(element).then(function (activity) {\n        return activity.getTotalEngagedTime();\n      });\n    }); // Returns the incremental engaged time since the last push under the\n    // same name.\n\n    this.setAsync('INCREMENTAL_ENGAGED_TIME', function (name, reset) {\n      return _services.Services.activityForDoc(element).then(function (activity) {\n        return activity.getIncrementalEngagedTime(\n        /** @type {string} */\n        name, reset !== 'false');\n      });\n    });\n    this.set('NAV_TIMING', function (startAttribute, endAttribute) {\n      (0, _log.userAssert)(startAttribute, 'The first argument to NAV_TIMING, the ' + 'start attribute name, is required');\n      return (0, _variableSource.getTimingDataSync)(win,\n      /**@type {string}*/\n      startAttribute,\n      /**@type {string}*/\n      endAttribute);\n    });\n    this.setAsync('NAV_TIMING', function (startAttribute, endAttribute) {\n      (0, _log.userAssert)(startAttribute, 'The first argument to NAV_TIMING, the ' + 'start attribute name, is required');\n      return (0, _variableSource.getTimingDataAsync)(win,\n      /**@type {string}*/\n      startAttribute,\n      /**@type {string}*/\n      endAttribute);\n    });\n    this.set('NAV_TYPE', function () {\n      return (0, _variableSource.getNavigationData)(win, 'type');\n    });\n    this.set('NAV_REDIRECT_COUNT', function () {\n      return (0, _variableSource.getNavigationData)(win, 'redirectCount');\n    }); // returns the AMP version number\n\n    this.set('AMP_VERSION', function () {\n      return (0, _internalVersion.internalRuntimeVersion)();\n    });\n    this.set('BACKGROUND_STATE', function () {\n      return _this3.ampdoc.isVisible() ? '0' : '1';\n    });\n    this.setAsync('VIDEO_STATE', function (id, property) {\n      var root = _this3.ampdoc.getRootNode();\n\n      var video = (0, _log.user)().assertElement(root.getElementById(\n      /** @type {string} */\n      id), \"Could not find an element with id=\\\"\" + id + \"\\\" for VIDEO_STATE\");\n      return _services.Services.videoManagerForDoc(_this3.ampdoc).getAnalyticsDetails(video).then(function (details) {\n        return details ? details[property] : '';\n      });\n    });\n    this.setAsync('STORY_PAGE_INDEX', this.getStoryValue_('pageIndex', 'STORY_PAGE_INDEX'));\n    this.setAsync('STORY_PAGE_ID', this.getStoryValue_('pageId', 'STORY_PAGE_ID'));\n    this.setAsync('FIRST_CONTENTFUL_PAINT', function () {\n      return (0, _promise.tryResolve)(function () {\n        return _services.Services.performanceFor(win).getFirstContentfulPaint();\n      });\n    });\n    this.setAsync('FIRST_VIEWPORT_READY', function () {\n      return (0, _promise.tryResolve)(function () {\n        return _services.Services.performanceFor(win).getFirstViewportReady();\n      });\n    });\n    this.setAsync('MAKE_BODY_VISIBLE', function () {\n      return (0, _promise.tryResolve)(function () {\n        return _services.Services.performanceFor(win).getMakeBodyVisible();\n      });\n    });\n    this.setAsync('AMP_STATE', function (key) {\n      // This is safe since AMP_STATE is not an A4A whitelisted variable.\n      var root = _this3.ampdoc.getRootNode();\n\n      var element =\n      /** @type {!Element|!ShadowRoot} */\n      root.documentElement || root;\n      return _services.Services.bindForDocOrNull(element).then(function (bind) {\n        if (!bind) {\n          return '';\n        }\n\n        return bind.getStateValue(\n        /** @type {string} */\n        key);\n      });\n    });\n  }\n  /**\n   * Merges any replacement parameters into a given URL's query string,\n   * preferring values set in the original query string.\n   * @param {string} orig The original URL\n   * @return {string} The resulting URL\n   * @private\n   */\n  ;\n\n  _proto.addReplaceParamsIfMissing_ = function addReplaceParamsIfMissing_(orig) {\n    var _this$getDocInfo_ =\n    /** @type {!Object} */\n    this.getDocInfo_(),\n        replaceParams = _this$getDocInfo_.replaceParams;\n\n    if (!replaceParams) {\n      return orig;\n    }\n\n    return (0, _url.addMissingParamsToUrl)((0, _url.removeAmpJsParamsFromUrl)(orig), replaceParams);\n  }\n  /**\n   * Return the document info for the current ampdoc.\n   * @return {./document-info-impl.DocumentInfoDef}\n   */\n  ;\n\n  _proto.getDocInfo_ = function getDocInfo_() {\n    return _services.Services.documentInfoForDoc(this.ampdoc);\n  }\n  /**\n   * Resolves the value via access service. If access service is not configured,\n   * the resulting value is `null`.\n   * @param {function(!../../extensions/amp-access/0.1/access-vars.AccessVars):(T|!Promise<T>)} getter\n   * @param {string} expr\n   * @return {T|null}\n   * @template T\n   * @private\n   */\n  ;\n\n  _proto.getAccessValue_ = function getAccessValue_(getter, expr) {\n    var element = this.ampdoc.getHeadNode();\n    return Promise.all([_services.Services.accessServiceForDocOrNull(element), _services.Services.subscriptionsServiceForDocOrNull(element)]).then(function (services) {\n      var service =\n      /** @type {?../../extensions/amp-access/0.1/access-vars.AccessVars} */\n      services[0] || services[1];\n\n      if (!service) {\n        // Access/subscriptions service is not installed.\n        (0, _log.user)().error(TAG, 'Access or subsciptions service is not installed to access: ', expr);\n        return null;\n      }\n\n      return getter(service);\n    });\n  }\n  /**\n   * Return the QUERY_PARAM from the current location href\n   * @param {string} param\n   * @param {string} defaultValue\n   * @return {string}\n   * @private\n   */\n  ;\n\n  _proto.getQueryParamData_ = function getQueryParamData_(param, defaultValue) {\n    (0, _log.userAssert)(param, 'The first argument to QUERY_PARAM, the query string ' + 'param is required');\n    var url = (0, _url.parseUrlDeprecated)((0, _url.removeAmpJsParamsFromUrl)(this.ampdoc.win.location.href));\n    var params = (0, _url.parseQueryString)(url.search);\n\n    var _this$getDocInfo_2 = this.getDocInfo_(),\n        replaceParams = _this$getDocInfo_2.replaceParams;\n\n    if (typeof params[param] !== 'undefined') {\n      return params[param];\n    }\n\n    if (replaceParams && typeof replaceParams[param] !== 'undefined') {\n      return (\n        /** @type {string} */\n        replaceParams[param]\n      );\n    }\n\n    return defaultValue;\n  }\n  /**\n   * Return the FRAGMENT_PARAM from the original location href\n   * @param {*} param\n   * @param {string} defaultValue\n   * @return {string}\n   * @private\n   */\n  ;\n\n  _proto.getFragmentParamData_ = function getFragmentParamData_(param, defaultValue) {\n    (0, _log.userAssert)(param, 'The first argument to FRAGMENT_PARAM, the fragment string ' + 'param is required');\n    (0, _log.userAssert)(typeof param == 'string', 'param should be a string');\n    var hash = this.ampdoc.win.location.originalHash;\n    var params = (0, _url.parseQueryString)(hash);\n    return params[param] === undefined ? defaultValue : params[param];\n  }\n  /**\n   * Resolves the value via amp-experiment's variants service.\n   * @param {function(!Object<string, string>):(?string)} getter\n   * @param {string} expr\n   * @return {!Promise<?string>}\n   * @template T\n   * @private\n   */\n  ;\n\n  _proto.getVariantsValue_ = function getVariantsValue_(getter, expr) {\n    return _services.Services.variantsForDocOrNull(this.ampdoc.getHeadNode()).then(function (variants) {\n      (0, _log.userAssert)(variants, 'To use variable %s, amp-experiment should be configured', expr);\n      return variants.getVariants();\n    }).then(function (variantsMap) {\n      return getter(variantsMap);\n    });\n  }\n  /**\n   * Resolves the value via geo service.\n   * @param {function(Object<string, string>)} getter\n   * @param {string} expr\n   * @return {!Promise<Object<string,(string|Array<string>)>>}\n   * @template T\n   * @private\n   */\n  ;\n\n  _proto.getGeo_ = function getGeo_(getter, expr) {\n    var element = this.ampdoc.getHeadNode();\n    return _services.Services.geoForDocOrNull(element).then(function (geo) {\n      (0, _log.userAssert)(geo, 'To use variable %s, amp-geo should be configured', expr);\n      return getter(geo);\n    });\n  }\n  /**\n   * Resolves the value via the user location service.\n   * @param {function(Object<string, string>)} getter\n   * @param {string} expr\n   * @return {!Promise<Object<string,(string|Array<string>)>>}\n   * @template T\n   * @private\n   */\n  ;\n\n  _proto.getUserLocation_ = function getUserLocation_(getter, expr) {\n    var element = this.ampdoc.getHeadNode();\n    return _services.Services.userLocationForDocOrNull(element).then(function (userLocationService) {\n      (0, _log.userAssert)(userLocationService, 'To use variable %s, amp-user-location should be configured', expr);\n      return getter(userLocationService);\n    });\n  }\n  /**\n   * Resolves the value via amp-share-tracking's service.\n   * @param {function(!ShareTrackingFragmentsDef):T} getter\n   * @param {string} expr\n   * @return {!Promise<T>}\n   * @template T\n   * @private\n   */\n  ;\n\n  _proto.getShareTrackingValue_ = function getShareTrackingValue_(getter, expr) {\n    if (!this.shareTrackingFragments_) {\n      this.shareTrackingFragments_ = _services.Services.shareTrackingForOrNull(this.ampdoc.win);\n    }\n\n    return this.shareTrackingFragments_.then(function (fragments) {\n      (0, _log.userAssert)(fragments, 'To use variable %s, amp-share-tracking should be configured', expr);\n      return getter(\n      /** @type {!ShareTrackingFragmentsDef} */\n      fragments);\n    });\n  }\n  /**\n   * Resolves the value via amp-story's service.\n   * @param {string} property\n   * @param {string} name\n   * @return {!AsyncResolverDef}\n   * @private\n   */\n  ;\n\n  _proto.getStoryValue_ = function getStoryValue_(property, name) {\n    var _this4 = this;\n\n    return function () {\n      var service = _services.Services.storyVariableServiceForOrNull(_this4.ampdoc.win);\n\n      return service.then(function (storyVariables) {\n        (0, _log.userAssert)(storyVariables, 'To use variable %s amp-story should be configured', name);\n        return storyVariables[property];\n      });\n    };\n  }\n  /**\n   * Resolves the value via amp-viewer-integration's service.\n   * @param {string} property\n   * @param {string} name\n   * @return {!AsyncResolverDef}\n   * @private\n   */\n  ;\n\n  _proto.getViewerIntegrationValue_ = function getViewerIntegrationValue_(property, name) {\n    var _this5 = this;\n\n    return (\n      /** @type {!AsyncResolverDef} */\n      function (param, defaultValue) {\n        if (defaultValue === void 0) {\n          defaultValue = '';\n        }\n\n        var service = _services.Services.viewerIntegrationVariableServiceForOrNull(_this5.ampdoc.win);\n\n        return service.then(function (viewerIntegrationVariables) {\n          (0, _log.userAssert)(viewerIntegrationVariables, 'To use variable %s amp-viewer-integration must be installed', name);\n          return viewerIntegrationVariables[property](param, defaultValue);\n        });\n      }\n    );\n  };\n\n  return GlobalVariableSource;\n}(_variableSource.VariableSource);\n/**\n * This class replaces substitution variables with their values.\n * Document new values in ../spec/amp-var-substitutions.md\n * @package For export\n */\n\n\nexports.GlobalVariableSource = GlobalVariableSource;\n\nvar UrlReplacements =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!VariableSource} variableSource\n   */\n  function UrlReplacements(ampdoc, variableSource) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @type {VariableSource} */\n\n    this.variableSource_ = variableSource;\n  }\n  /**\n   * Synchronously expands the provided source by replacing all known variables\n   * with their resolved values. Optional `opt_bindings` can be used to add new\n   * variables or override existing ones.  Any async bindings are ignored.\n   * @param {string} source\n   * @param {!Object<string, (ResolverReturnDef|!SyncResolverDef)>=} opt_bindings\n   * @param {!Object<string, ResolverReturnDef>=} opt_collectVars\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of\n   *     names that can be substituted.\n   * @return {string}\n   */\n\n\n  var _proto2 = UrlReplacements.prototype;\n\n  _proto2.expandStringSync = function expandStringSync(source, opt_bindings, opt_collectVars, opt_whiteList) {\n    return (\n      /** @type {string} */\n      new _expander.Expander(this.variableSource_, opt_bindings, opt_collectVars,\n      /* opt_sync */\n      true, opt_whiteList,\n      /* opt_noEncode */\n      true).\n      /*OK*/\n      expand(source)\n    );\n  }\n  /**\n   * Expands the provided source by replacing all known variables with their\n   * resolved values. Optional `opt_bindings` can be used to add new variables\n   * or override existing ones.\n   * @param {string} source\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_whiteList\n   * @return {!Promise<string>}\n   */\n  ;\n\n  _proto2.expandStringAsync = function expandStringAsync(source, opt_bindings, opt_whiteList) {\n    return (\n      /** @type {!Promise<string>} */\n      new _expander.Expander(this.variableSource_, opt_bindings,\n      /* opt_collectVars */\n      undefined,\n      /* opt_sync */\n      undefined, opt_whiteList,\n      /* opt_noEncode */\n      true).\n      /*OK*/\n      expand(source)\n    );\n  }\n  /**\n   * Synchronously expands the provided URL by replacing all known variables\n   * with their resolved values. Optional `opt_bindings` can be used to add new\n   * variables or override existing ones.  Any async bindings are ignored.\n   * @param {string} url\n   * @param {!Object<string, (ResolverReturnDef|!SyncResolverDef)>=} opt_bindings\n   * @param {!Object<string, ResolverReturnDef>=} opt_collectVars\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of\n   *     names that can be substituted.\n   * @return {string}\n   */\n  ;\n\n  _proto2.expandUrlSync = function expandUrlSync(url, opt_bindings, opt_collectVars, opt_whiteList) {\n    return this.ensureProtocolMatches_(url,\n    /** @type {string} */\n    new _expander.Expander(this.variableSource_, opt_bindings, opt_collectVars,\n    /* opt_sync */\n    true, opt_whiteList).\n    /*OK*/\n    expand(url));\n  }\n  /**\n   * Expands the provided URL by replacing all known variables with their\n   * resolved values. Optional `opt_bindings` can be used to add new variables\n   * or override existing ones.\n   * @param {string} url\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of names\n   *     that can be substituted.\n   * @param {boolean=} opt_noEncode should not encode URL\n   * @return {!Promise<string>}\n   */\n  ;\n\n  _proto2.expandUrlAsync = function expandUrlAsync(url, opt_bindings, opt_whiteList, opt_noEncode) {\n    var _this6 = this;\n\n    return (\n      /** @type {!Promise<string>} */\n      new _expander.Expander(this.variableSource_, opt_bindings,\n      /* opt_collectVars */\n      undefined,\n      /* opt_sync */\n      undefined, opt_whiteList, opt_noEncode).\n      /*OK*/\n      expand(url).then(function (replacement) {\n        return _this6.ensureProtocolMatches_(url, replacement);\n      })\n    );\n  }\n  /**\n   * Expands an input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @return {!Promise<string>}\n   */\n  ;\n\n  _proto2.expandInputValueAsync = function expandInputValueAsync(element) {\n    return (\n      /** @type {!Promise<string>} */\n      this.expandInputValue_(element,\n      /*opt_sync*/\n      false)\n    );\n  }\n  /**\n   * Expands an input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @return {string} Replaced string for testing\n   */\n  ;\n\n  _proto2.expandInputValueSync = function expandInputValueSync(element) {\n    return (\n      /** @type {string} */\n      this.expandInputValue_(element,\n      /*opt_sync*/\n      true)\n    );\n  }\n  /**\n   * Expands in input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @param {boolean=} opt_sync\n   * @return {string|!Promise<string>}\n   */\n  ;\n\n  _proto2.expandInputValue_ = function expandInputValue_(element, opt_sync) {\n    (0, _log.devAssert)(element.tagName == 'INPUT' && (element.getAttribute('type') || '').toLowerCase() == 'hidden', 'Input value expansion only works on hidden input fields: %s', element);\n    var whitelist = this.getWhitelistForElement_(element);\n\n    if (!whitelist) {\n      return opt_sync ? element.value : Promise.resolve(element.value);\n    }\n\n    if (element[ORIGINAL_VALUE_PROPERTY] === undefined) {\n      element[ORIGINAL_VALUE_PROPERTY] = element.value;\n    }\n\n    var result = new _expander.Expander(this.variableSource_,\n    /* opt_bindings */\n    undefined,\n    /* opt_collectVars */\n    undefined,\n    /* opt_sync */\n    opt_sync,\n    /* opt_whitelist */\n    whitelist).\n    /*OK*/\n    expand(element[ORIGINAL_VALUE_PROPERTY] || element.value);\n\n    if (opt_sync) {\n      return element.value = result;\n    }\n\n    return result.then(function (newValue) {\n      element.value = newValue;\n      return newValue;\n    });\n  }\n  /**\n   * Returns a replacement whitelist from elements' data-amp-replace attribute.\n   * @param {!Element} element\n   * @param {!Object<string, boolean>=} opt_supportedReplacement Optional supported\n   * replacement that filters whitelist to a subset.\n   * @return {!Object<string, boolean>|undefined}\n   */\n  ;\n\n  _proto2.getWhitelistForElement_ = function getWhitelistForElement_(element, opt_supportedReplacement) {\n    var whitelist = element.getAttribute('data-amp-replace');\n\n    if (!whitelist) {\n      return;\n    }\n\n    var requestedReplacements = {};\n    whitelist.trim().split(/\\s+/).forEach(function (replacement) {\n      if (!opt_supportedReplacement || (0, _object.hasOwn)(opt_supportedReplacement, replacement)) {\n        requestedReplacements[replacement] = true;\n      } else {\n        (0, _log.user)().warn('URL', 'Ignoring unsupported replacement', replacement);\n      }\n    });\n    return requestedReplacements;\n  }\n  /**\n   * Returns whether variable substitution is allowed for given url.\n   * @param {!Location} url\n   * @return {boolean}\n   */\n  ;\n\n  _proto2.isAllowedOrigin_ = function isAllowedOrigin_(url) {\n    var docInfo = _services.Services.documentInfoForDoc(this.ampdoc);\n\n    if (url.origin == (0, _url.parseUrlDeprecated)(docInfo.canonicalUrl).origin || url.origin == (0, _url.parseUrlDeprecated)(docInfo.sourceUrl).origin) {\n      return true;\n    }\n\n    var meta = this.ampdoc.getRootNode().querySelector('meta[name=amp-link-variable-allowed-origin]');\n\n    if (meta && meta.hasAttribute('content')) {\n      var whitelist = meta.getAttribute('content').trim().split(/\\s+/);\n\n      for (var i = 0; i < whitelist.length; i++) {\n        if (url.origin == (0, _url.parseUrlDeprecated)(whitelist[i]).origin) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n  /**\n   * Replaces values in the link of an anchor tag if\n   * - the link opts into it (via data-amp-replace argument)\n   * - the destination is the source or canonical origin of this doc.\n   * @param {!Element} element An anchor element.\n   * @param {?string} defaultUrlParams to expand link if caller request.\n   * @return {string|undefined} Replaced string for testing\n   */\n  ;\n\n  _proto2.maybeExpandLink = function maybeExpandLink(element, defaultUrlParams) {\n    (0, _log.devAssert)(element.tagName == 'A');\n    var supportedReplacements = {\n      'CLIENT_ID': true,\n      'QUERY_PARAM': true,\n      'PAGE_VIEW_ID': true,\n      'PAGE_VIEW_ID_64': true,\n      'NAV_TIMING': true\n    };\n    var additionalUrlParameters = element.getAttribute('data-amp-addparams') || '';\n    var whitelist = this.getWhitelistForElement_(element, supportedReplacements);\n\n    if (!whitelist && !additionalUrlParameters && !defaultUrlParams) {\n      return;\n    } // ORIGINAL_HREF_PROPERTY has the value of the href \"pre-replacement\".\n    // We set this to the original value before doing any work and use it\n    // on subsequent replacements, so that each run gets a fresh value.\n\n\n    var href = (0, _log.dev)().assertString(element[ORIGINAL_HREF_PROPERTY] || element.getAttribute('href'));\n    var url = (0, _url.parseUrlDeprecated)(href);\n\n    if (element[ORIGINAL_HREF_PROPERTY] == null) {\n      element[ORIGINAL_HREF_PROPERTY] = href;\n    }\n\n    if (additionalUrlParameters) {\n      href = (0, _url.addParamsToUrl)(href, (0, _url.parseQueryString)(additionalUrlParameters));\n    }\n\n    var isAllowedOrigin = this.isAllowedOrigin_(url);\n\n    if (!isAllowedOrigin) {\n      if (whitelist) {\n        (0, _log.user)().warn('URL', 'Ignoring link replacement %s' + \" because the link does not go to the document's\" + ' source, canonical, or whitelisted origin.', href);\n      }\n\n      return element.href = href;\n    } // Note that defaultUrlParams is treated differently than\n    // additionalUrlParameters in two ways #1: If the outgoing url origin is not\n    // whitelisted: additionalUrlParameters are always appended by not expanded,\n    // defaultUrlParams will not be appended. #2: If the expansion function is\n    // not whitelisted: additionalUrlParamters will not be expanded,\n    // defaultUrlParams will by default support QUERY_PARAM, and will still be\n    // expanded.\n\n\n    if (defaultUrlParams) {\n      if (!whitelist || !whitelist['QUERY_PARAM']) {\n        // override whitelist and expand defaultUrlParams;\n        var overrideWhitelist = {\n          'QUERY_PARAM': true\n        };\n        defaultUrlParams = this.expandUrlSync(defaultUrlParams,\n        /* opt_bindings */\n        undefined,\n        /* opt_collectVars */\n        undefined,\n        /* opt_whitelist */\n        overrideWhitelist);\n      }\n\n      href = (0, _url.addParamsToUrl)(href, (0, _url.parseQueryString)(defaultUrlParams));\n    }\n\n    if (whitelist) {\n      href = this.expandUrlSync(href,\n      /* opt_bindings */\n      undefined,\n      /* opt_collectVars */\n      undefined,\n      /* opt_whitelist */\n      whitelist);\n    }\n\n    return element.href = href;\n  }\n  /**\n   * Collects all substitutions in the provided URL and expands them to the\n   * values for known variables. Optional `opt_bindings` can be used to add\n   * new variables or override existing ones.\n   * @param {string} url\n   * @param {!Object<string, *>=} opt_bindings\n   * @return {!Promise<!Object<string, *>>}\n   */\n  ;\n\n  _proto2.collectVars = function collectVars(url, opt_bindings) {\n    var vars = Object.create(null);\n    return new _expander.Expander(this.variableSource_, opt_bindings, vars).\n    /*OK*/\n    expand(url).then(function () {\n      return vars;\n    });\n  }\n  /**\n   * Collects substitutions in the `src` attribute of the given element\n   * that are _not_ whitelisted via `data-amp-replace` opt-in attribute.\n   * @param {!Element} element\n   * @return {!Array<string>}\n   */\n  ;\n\n  _proto2.collectUnwhitelistedVarsSync = function collectUnwhitelistedVarsSync(element) {\n    var url = element.getAttribute('src');\n    var macroNames = new _expander.Expander(this.variableSource_).getMacroNames(url);\n    var whitelist = this.getWhitelistForElement_(element);\n\n    if (whitelist) {\n      return macroNames.filter(function (v) {\n        return !whitelist[v];\n      });\n    } else {\n      // All vars are unwhitelisted if the element has no whitelist.\n      return macroNames;\n    }\n  }\n  /**\n   * Ensures that the protocol of the original url matches the protocol of the\n   * replacement url. Returns the replacement if they do, the original if they\n   * do not.\n   * @param {string} url\n   * @param {string} replacement\n   * @return {string}\n   */\n  ;\n\n  _proto2.ensureProtocolMatches_ = function ensureProtocolMatches_(url, replacement) {\n    var newProtocol = (0, _url.parseUrlDeprecated)(replacement,\n    /* opt_nocache */\n    true).protocol;\n    var oldProtocol = (0, _url.parseUrlDeprecated)(url,\n    /* opt_nocache */\n    true).protocol;\n\n    if (newProtocol != oldProtocol) {\n      (0, _log.user)().error(TAG, 'Illegal replacement of the protocol: ', url);\n      return url;\n    }\n\n    (0, _log.userAssert)((0, _url.isProtocolValid)(replacement), 'The replacement url has invalid protocol: %s', replacement);\n    return replacement;\n  }\n  /**\n   * @return {VariableSource}\n   */\n  ;\n\n  _proto2.getVariableSource = function getVariableSource() {\n    return this.variableSource_;\n  };\n\n  return UrlReplacements;\n}();\n/**\n * Extracts client ID from a _ga cookie.\n * https://developers.google.com/analytics/devguides/collection/analyticsjs/cookies-user-id\n * @param {string} gaCookie\n * @return {string}\n */\n\n\nexports.UrlReplacements = UrlReplacements;\n\nfunction extractClientIdFromGaCookie(gaCookie) {\n  return gaCookie.replace(/^(GA1|1)\\.[\\d-]+\\./, '');\n}\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nfunction installUrlReplacementsServiceForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'url-replace', function (doc) {\n    return new UrlReplacements(doc, new GlobalVariableSource(doc));\n  });\n}\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Window} embedWin\n * @param {!VariableSource} varSource\n */\n\n\nfunction installUrlReplacementsForEmbed(ampdoc, embedWin, varSource) {\n  (0, _service.installServiceInEmbedScope)(embedWin, 'url-replace', new UrlReplacements(ampdoc, varSource));\n}\n/**\n * @typedef {{incomingFragment: string, outgoingFragment: string}}\n */\n\n\nvar ShareTrackingFragmentsDef;\n\n},{\"../impression.js\":58,\"../internal-version\":61,\"../log\":68,\"../service\":79,\"../services\":123,\"../url\":134,\"../utils/object\":145,\"../utils/promise\":147,\"../window-interface\":152,\"./url-expander/expander\":109,\"./variable-source\":112}],112:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getTimingDataAsync = getTimingDataAsync;\nexports.getTimingDataSync = getTimingDataSync;\nexports.getNavigationData = getNavigationData;\nexports.VariableSource = exports.AsyncResolverDef = exports.SyncResolverDef = exports.ResolverReturnDef = void 0;\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\nvar _types = require(\"../types\");\n\nvar _eventHelper = require(\"../event-helper\");\n\nvar _documentReady = require(\"../document-ready\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @typedef {string|number|boolean|undefined|null} */\nvar ResolverReturnDef;\n/** @typedef {function(...string):ResolverReturnDef} */\n\nexports.ResolverReturnDef = ResolverReturnDef;\nvar SyncResolverDef;\n/** @typedef {function(...string):!Promise<ResolverReturnDef>} */\n\nexports.SyncResolverDef = SyncResolverDef;\nvar AsyncResolverDef;\n/** @typedef {{sync: SyncResolverDef, async: AsyncResolverDef}} */\n\nexports.AsyncResolverDef = AsyncResolverDef;\nvar ReplacementDef;\n/**\n * A list of events that the navTiming needs to wait for.\n * Sort event in order\n * @enum {number}\n */\n\nvar WAITFOR_EVENTS = {\n  VIEWER_FIRST_VISIBLE: 1,\n  DOCUMENT_COMPLETE: 2,\n  LOAD: 3,\n  LOAD_END: 4\n};\n/**\n * A list of events on which event they should wait\n * @const {!Object<string, WAITFOR_EVENTS>}\n */\n\nvar NAV_TIMING_WAITFOR_EVENTS = {\n  // ready on viewer first visible\n  'navigationStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'redirectStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'redirectEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'fetchStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'domainLookupStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'domainLookupEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'connectStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'secureConnectionStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'connectEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'requestStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'responseStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'responseEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  // ready on document complte\n  'domLoading': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domInteractive': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domContentLoaded': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domComplete': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  // ready on load\n  'loadEventStart': WAITFOR_EVENTS.LOAD,\n  // ready on load complete\n  'loadEventEnd': WAITFOR_EVENTS.LOAD_END\n};\n/**\n * Returns navigation timing information based on the start and end events.\n * The data for the timing events is retrieved from performance.timing API.\n * If start and end events are both given, the result is the difference between\n * the two. If only start event is given, the result is the timing value at\n * start event.\n * @param {!Window} win\n * @param {string} startEvent\n * @param {string=} endEvent\n * @return {!Promise<ResolverReturnDef>}\n */\n\nfunction getTimingDataAsync(win, startEvent, endEvent) {\n  // Fallback to load event if we don't know what to wait for\n  var startWaitForEvent = NAV_TIMING_WAITFOR_EVENTS[startEvent] || WAITFOR_EVENTS.LOAD;\n  var endWaitForEvent = endEvent ? NAV_TIMING_WAITFOR_EVENTS[endEvent] || WAITFOR_EVENTS.LOAD : startWaitForEvent;\n  var waitForEvent = Math.max(startWaitForEvent, endWaitForEvent); // set wait for onload to be default\n\n  var readyPromise;\n\n  if (waitForEvent === WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE) {\n    readyPromise = Promise.resolve();\n  } else if (waitForEvent === WAITFOR_EVENTS.DOCUMENT_COMPLETE) {\n    readyPromise = (0, _documentReady.whenDocumentComplete)(win.document);\n  } else if (waitForEvent === WAITFOR_EVENTS.LOAD) {\n    readyPromise = (0, _eventHelper.loadPromise)(win);\n  } else if (waitForEvent === WAITFOR_EVENTS.LOAD_END) {\n    // performance.timing.loadEventEnd returns 0 before the load event handler\n    // has terminated, that's when the load event is completed.\n    // To wait for the event handler to terminate, wait 1ms and defer to the\n    // event loop.\n    var timer = _services.Services.timerFor(win);\n\n    readyPromise = (0, _eventHelper.loadPromise)(win).then(function () {\n      return timer.promise(1);\n    });\n  }\n\n  (0, _log.devAssert)(readyPromise, 'waitForEvent not supported ' + waitForEvent);\n  return readyPromise.then(function () {\n    return getTimingDataSync(win, startEvent, endEvent);\n  });\n}\n/**\n * Returns navigation timing information based on the start and end events.\n * The data for the timing events is retrieved from performance.timing API.\n * If start and end events are both given, the result is the difference between\n * the two. If only start event is given, the result is the timing value at\n * start event. Enforces synchronous evaluation.\n * @param {!Window} win\n * @param {string} startEvent\n * @param {string=} endEvent\n * @return {ResolverReturnDef} undefined if API is not available, empty string\n *    if it is not yet available, or value as string\n */\n\n\nfunction getTimingDataSync(win, startEvent, endEvent) {\n  var timingInfo = win['performance'] && win['performance']['timing'];\n\n  if (!timingInfo || timingInfo['navigationStart'] == 0) {\n    // Navigation timing API is not supported.\n    return;\n  }\n\n  var metric = endEvent === undefined ? timingInfo[startEvent] : timingInfo[endEvent] - timingInfo[startEvent];\n\n  if (!(0, _types.isFiniteNumber)(metric) || metric < 0) {\n    // The metric is not supported.\n    return;\n  } else {\n    return metric;\n  }\n}\n/**\n * Returns navigation information from the current browsing context.\n * @param {!Window} win\n * @param {string} attribute\n * @return {ResolverReturnDef}\n * @private\n */\n\n\nfunction getNavigationData(win, attribute) {\n  var navigationInfo = win['performance'] && win['performance']['navigation'];\n\n  if (!navigationInfo || navigationInfo[attribute] === undefined) {\n    // PerformanceNavigation interface is not supported or attribute is not\n    // implemented.\n    return;\n  }\n\n  return navigationInfo[attribute];\n}\n/**\n * A class to provide variable substitution related features. Extend this class\n * and override initialize() to add more supported variables.\n */\n\n\nvar VariableSource =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  function VariableSource(ampdoc) {\n    /** @protected @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @private @const {!Object<string, !ReplacementDef>} */\n\n    this.replacements_ = Object.create(null);\n    /** @private {boolean} */\n\n    this.initialized_ = false;\n    this.getUrlMacroWhitelist_();\n  }\n  /**\n   * Lazily initialize the default replacements.\n   * @private\n   */\n\n\n  var _proto = VariableSource.prototype;\n\n  _proto.initialize_ = function initialize_() {\n    this.initialize();\n    this.initialized_ = true;\n  }\n  /**\n   * Override this method to set all the variables supported by derived class.\n   */\n  ;\n\n  _proto.initialize = function initialize() {} // Needs to be implemented by derived classes.\n\n  /**\n   * Method exists to assist stubbing in tests.\n   * @param {string} name\n   * @return {!ReplacementDef}\n   */\n  ;\n\n  _proto.get = function get(name) {\n    if (!this.initialized_) {\n      this.initialize_();\n    }\n\n    return this.replacements_[name];\n  }\n  /**\n   * Sets a synchronous value resolver for the variable with the specified name.\n   * The value resolver may optionally take an extra parameter.\n   * Can be called in conjunction with setAsync to allow for additional\n   * asynchronous resolver where expand will use async and expandSync the sync\n   * version.\n   * @param {string} varName\n   * @param {!SyncResolverDef} syncResolver\n   * @return {!VariableSource}\n   */\n  ;\n\n  _proto.set = function set(varName, syncResolver) {\n    (0, _log.devAssert)(varName.indexOf('RETURN') == -1);\n    this.replacements_[varName] = this.replacements_[varName] || {\n      sync: undefined,\n      async: undefined\n    };\n    this.replacements_[varName].sync = syncResolver;\n    return this;\n  }\n  /**\n   * Sets an async value resolver for the variable with the specified name.\n   * The value resolver may optionally take an extra parameter.\n   * Can be called in conjuction with setAsync to allow for additional\n   * asynchronous resolver where expand will use async and expandSync the sync\n   * version.\n   * @param {string} varName\n   * @param {!AsyncResolverDef} asyncResolver\n   * @return {!VariableSource}\n   */\n  ;\n\n  _proto.setAsync = function setAsync(varName, asyncResolver) {\n    (0, _log.devAssert)(varName.indexOf('RETURN') == -1);\n    this.replacements_[varName] = this.replacements_[varName] || {\n      sync: undefined,\n      async: undefined\n    };\n    this.replacements_[varName].async = asyncResolver;\n    return this;\n  }\n  /**\n   * Helper method to set both sync and async resolvers.\n   * @param {string} varName\n   * @param {!SyncResolverDef} syncResolver\n   * @param {!AsyncResolverDef} asyncResolver\n   * @return {!VariableSource}\n   */\n  ;\n\n  _proto.setBoth = function setBoth(varName, syncResolver, asyncResolver) {\n    return this.set(varName, syncResolver).setAsync(varName, asyncResolver);\n  }\n  /**\n   * Returns a Regular expression that can be used to detect all the variables\n   * in a template.\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of names\n   *   that can be substituted.\n   * @return {!RegExp}\n   */\n  ;\n\n  _proto.getExpr = function getExpr(opt_bindings, opt_whiteList) {\n    if (!this.initialized_) {\n      this.initialize_();\n    }\n\n    var all = Object.assign({}, this.replacements_, opt_bindings);\n    return this.buildExpr_(Object.keys(all), opt_whiteList);\n  }\n  /**\n   * @param {!Array<string>} keys\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of names\n   *   that can be substituted.\n   * @return {!RegExp}\n   * @private\n   */\n  ;\n\n  _proto.buildExpr_ = function buildExpr_(keys, opt_whiteList) {\n    var _this = this;\n\n    // If a whitelist is present, the keys must belong to the whitelist.\n    // We filter the keys one last time to ensure no unwhitelisted key is\n    // allowed.\n    if (this.getUrlMacroWhitelist_()) {\n      keys = keys.filter(function (key) {\n        return _this.getUrlMacroWhitelist_().includes(key);\n      });\n    } // If a whitelist is passed into the call to GlobalVariableSource.expand_\n    // then we only resolve values contained in the whitelist.\n\n\n    if (opt_whiteList) {\n      keys = keys.filter(function (key) {\n        return opt_whiteList[key];\n      });\n    }\n\n    if (keys.length === 0) {\n      var regexThatMatchesNothing = /_^/g; // lgtm [js/regex/unmatchable-caret]\n\n      return regexThatMatchesNothing;\n    } // The keys must be sorted to ensure that the longest keys are considered\n    // first. This avoids a problem where a RANDOM conflicts with RANDOM_ONE.\n\n\n    keys.sort(function (s1, s2) {\n      return s2.length - s1.length;\n    }); // Keys that start with a `$` need to be escaped so that they do not\n    // interfere with the regex that is constructed.\n\n    var escaped = keys.map(function (key) {\n      if (key[0] === '$') {\n        return '\\\\' + key;\n      }\n\n      return key;\n    });\n    var all = escaped.join('|'); // Match the given replacement patterns, as well as optionally\n    // arguments to the replacement behind it in parentheses.\n    // Example string that match\n    // FOO_BAR\n    // FOO_BAR(arg1)\n    // FOO_BAR(arg1,arg2)\n    // FOO_BAR(arg1, arg2)\n\n    var regexStr = '\\\\$?(' + all + ')';\n    return new RegExp(regexStr, 'g');\n  }\n  /**\n   * @return {?Array<string>} The whitelist of allowed AMP variables. (if provided in\n   *     a meta tag).\n   * @private\n   */\n  ;\n\n  _proto.getUrlMacroWhitelist_ = function getUrlMacroWhitelist_() {\n    if (this.variableWhitelist_) {\n      return this.variableWhitelist_;\n    }\n\n    var _this$ampdoc$getRootN = this.ampdoc.getRootNode(),\n        head = _this$ampdoc$getRootN.head;\n\n    if (!head) {\n      return null;\n    } // A meta[name=\"amp-allowed-url-macros\"] tag, if present,\n    // contains, in its content attribute, a whitelist of variable substitution.\n\n\n    var meta = head.querySelector('meta[name=\"amp-allowed-url-macros\"]');\n\n    if (!meta) {\n      return null;\n    }\n    /**\n     * The whitelist of variables allowed for variable substitution.\n     * @private {?Array<string>}\n     */\n\n\n    this.variableWhitelist_ = meta.getAttribute('content').split(',').map(function (variable) {\n      return variable.trim();\n    });\n    return this.variableWhitelist_;\n  };\n\n  return VariableSource;\n}();\n\nexports.VariableSource = VariableSource;\n\n},{\"../document-ready\":39,\"../event-helper\":46,\"../log\":68,\"../services\":123,\"../types\":131}],113:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ViewerCidApi = void 0;\n\nvar _services = require(\"../services\");\n\nvar _object = require(\"../utils/object\");\n\nvar _url = require(\"../url\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Exposes CID API if provided by the Viewer.\n */\nvar ViewerCidApi =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates an instance of ViewerCidApi.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  function ViewerCidApi(ampdoc) {\n    /** @private {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n    /** @private {!./viewer-interface.ViewerInterface} */\n\n    this.viewer_ = _services.Services.viewerForDoc(this.ampdoc_);\n\n    var _Services$documentInf = _services.Services.documentInfoForDoc(this.ampdoc_),\n        canonicalUrl = _Services$documentInf.canonicalUrl;\n    /** @private {?string} */\n\n\n    this.canonicalOrigin_ = canonicalUrl ? (0, _url.parseUrlDeprecated)(canonicalUrl).origin : null;\n  }\n  /**\n   * Resolves to true if Viewer is trusted and supports CID API.\n   * @return {!Promise<boolean>}\n   */\n\n\n  var _proto = ViewerCidApi.prototype;\n\n  _proto.isSupported = function isSupported() {\n    if (!this.viewer_.hasCapability('cid')) {\n      return Promise.resolve(false);\n    }\n\n    return this.viewer_.isTrustedViewer();\n  }\n  /**\n   * Returns scoped CID retrieved from the Viewer.\n   * @param {string|undefined} apiKey\n   * @param {string} scope\n   * @return {!Promise<?JsonObject|string|undefined>}\n   */\n  ;\n\n  _proto.getScopedCid = function getScopedCid(apiKey, scope) {\n    var payload = (0, _object.dict)({\n      'scope': scope,\n      'clientIdApi': !!apiKey,\n      'canonicalOrigin': this.canonicalOrigin_\n    });\n\n    if (apiKey) {\n      payload['apiKey'] = apiKey;\n    }\n\n    return this.viewer_.sendMessageAwaitResponse('cid', payload);\n  };\n\n  return ViewerCidApi;\n}();\n\nexports.ViewerCidApi = ViewerCidApi;\n\n},{\"../services\":123,\"../url\":134,\"../utils/object\":145}],114:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installViewerServiceForDoc = installViewerServiceForDoc;\nexports.ViewerImpl = exports.Capability = void 0;\n\nvar _promise = require(\"../utils/promise\");\n\nvar _observable = require(\"../observable\");\n\nvar _services = require(\"../services\");\n\nvar _viewerInterface = require(\"./viewer-interface\");\n\nvar _visibilityState = require(\"../visibility-state\");\n\nvar _log = require(\"../log\");\n\nvar _array = require(\"../utils/array\");\n\nvar _url = require(\"../url\");\n\nvar _dom = require(\"../dom\");\n\nvar _object = require(\"../utils/object\");\n\nvar _service = require(\"../service\");\n\nvar _error = require(\"../error\");\n\nvar _string = require(\"../string\");\n\nvar _config = require(\"../config\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG_ = 'Viewer';\n/** @enum {string} */\n\nvar Capability = {\n  VIEWER_RENDER_TEMPLATE: 'viewerRenderTemplate'\n};\n/**\n * Duration in milliseconds to wait for viewerOrigin to be set before an empty\n * string is returned.\n * @const\n * @private {number}\n */\n\nexports.Capability = Capability;\nvar VIEWER_ORIGIN_TIMEOUT_ = 1000;\n/**\n * Prefixes to remove when trimming a hostname for comparison.\n * @const\n * @private {!RegExp}\n */\n\nvar TRIM_ORIGIN_PATTERN_ = /^(https?:\\/\\/)((www[0-9]*|web|ftp|wap|home|mobile|amp|m)\\.)+/i;\n/**\n * An AMP representation of the Viewer. This class doesn't do any work itself\n * but instead delegates everything to the actual viewer. This class and the\n * actual Viewer are connected via \"AMP.viewer\" using three methods:\n * {@link getParam}, {@link receiveMessage} and {@link setMessageDeliverer}.\n * @implements {ViewerInterface}\n * @package Visible for type.\n */\n\nvar ViewerImpl =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  function ViewerImpl(ampdoc) {\n    var _this = this;\n\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @const {!Window} */\n\n    this.win = ampdoc.win;\n    /** @private @const {boolean} */\n\n    this.isIframed_ = (0, _dom.isIframed)(this.win);\n    /** @private {boolean} */\n\n    this.isRuntimeOn_ = true;\n    /** @private {boolean} */\n\n    this.overtakeHistory_ = false;\n    /** @private {number} */\n\n    this.prerenderSize_ = 1;\n    /** @private {!Object<string, !Observable<!JsonObject>>} */\n\n    this.messageObservables_ = (0, _object.map)();\n    /** @private {!Object<string, !./viewer-interface.RequestResponderDef>} */\n\n    this.messageResponders_ = (0, _object.map)();\n    /** @private {!Observable<boolean>} */\n\n    this.runtimeOnObservable_ = new _observable.Observable();\n    /** @private {!Observable<!JsonObject>} */\n\n    this.broadcastObservable_ = new _observable.Observable();\n    /**\n     * @private {?function(string, (?JsonObject|string|undefined), boolean):\n     *     (Promise<*>|undefined)}\n     */\n\n    this.messageDeliverer_ = null;\n    /** @private {?string} */\n\n    this.messagingOrigin_ = null;\n    /**\n     * @private {!Array<!{\n     *   eventType: string,\n     *   data: (?JsonObject|string|undefined),\n     *   awaitResponse: boolean,\n     *   responsePromise: (Promise<*>|undefined),\n     *   responseResolver: function(*)\n     * }>}\n     */\n\n    this.messageQueue_ = [];\n    /**\n     * Subset of this.params_ that only contains parameters in the URL hash,\n     * e.g. \"#foo=bar\".\n     * @const @private {!Object<string, string>}\n     */\n\n    this.hashParams_ = (0, _object.map)();\n\n    if (ampdoc.isSingleDoc()) {\n      Object.assign(this.hashParams_, (0, _url.parseQueryString)(this.win.location.hash));\n    }\n\n    this.isRuntimeOn_ = !parseInt(ampdoc.getParam('off'), 10);\n    (0, _log.dev)().fine(TAG_, '- runtimeOn:', this.isRuntimeOn_);\n    this.overtakeHistory_ = !!(parseInt(ampdoc.getParam('history'), 10) || this.overtakeHistory_);\n    (0, _log.dev)().fine(TAG_, '- history:', this.overtakeHistory_);\n    (0, _log.dev)().fine(TAG_, '- visibilityState:', this.ampdoc.getVisibilityState());\n    this.prerenderSize_ = parseInt(ampdoc.getParam('prerenderSize'), 10) || this.prerenderSize_;\n    (0, _log.dev)().fine(TAG_, '- prerenderSize:', this.prerenderSize_);\n    /**\n     * Whether the AMP document is embedded in a Chrome Custom Tab.\n     * @private {?boolean}\n     */\n\n    this.isCctEmbedded_ = null;\n    /**\n     * Whether the AMP document was served by a proxy.\n     * @private @const {boolean}\n     */\n\n    this.isProxyOrigin_ = (0, _url.isProxyOrigin)((0, _url.parseUrlDeprecated)(this.ampdoc.win.location.href));\n    var messagingDeferred = new _promise.Deferred();\n    /** @const @private {!Function} */\n\n    this.messagingReadyResolver_ = messagingDeferred.resolve;\n    /** @const @private {?Promise} */\n\n    this.messagingReadyPromise_ = this.initMessagingChannel_(messagingDeferred.promise);\n    /** @private {?Promise<boolean>} */\n\n    this.isTrustedViewer_ = null;\n    /** @private {?Promise<string>} */\n\n    this.viewerOrigin_ = null;\n    var referrerParam = ampdoc.getParam('referrer');\n    /** @private {string} */\n\n    this.unconfirmedReferrerUrl_ = this.isEmbedded() && referrerParam != null && this.isTrustedAncestorOrigins_() !== false ? referrerParam : this.win.document.referrer;\n    /** @const @private {!Promise<string>} */\n\n    this.referrerUrl_ = new Promise(function (resolve) {\n      if (_this.isEmbedded() && ampdoc.getParam('referrer') != null) {\n        // Viewer override, but only for whitelisted viewers. Only allowed for\n        // iframed documents.\n        _this.isTrustedViewer().then(function (isTrusted) {\n          if (isTrusted) {\n            resolve(ampdoc.getParam('referrer'));\n          } else {\n            resolve(_this.win.document.referrer);\n\n            if (_this.unconfirmedReferrerUrl_ != _this.win.document.referrer) {\n              (0, _log.dev)().expectedError(TAG_, 'Untrusted viewer referrer override: ' + _this.unconfirmedReferrerUrl_ + ' at ' + _this.messagingOrigin_);\n              _this.unconfirmedReferrerUrl_ = _this.win.document.referrer;\n            }\n          }\n        });\n      } else {\n        resolve(_this.win.document.referrer);\n      }\n    });\n    /** @private {string} */\n\n    this.resolvedViewerUrl_ = (0, _url.removeFragment)(this.win.location.href || '');\n    /** @const @private {!Promise<string>} */\n\n    this.viewerUrl_ = new Promise(function (resolve) {\n      /** @const {?string} */\n      var viewerUrlOverride = ampdoc.getParam('viewerUrl');\n\n      if (_this.isEmbedded() && viewerUrlOverride) {\n        // Viewer override, but only for whitelisted viewers. Only allowed for\n        // iframed documents.\n        _this.isTrustedViewer().then(function (isTrusted) {\n          if (isTrusted) {\n            _this.resolvedViewerUrl_ = (0, _log.devAssert)(viewerUrlOverride);\n          } else {\n            (0, _log.dev)().expectedError(TAG_, 'Untrusted viewer url override: ' + viewerUrlOverride + ' at ' + _this.messagingOrigin_);\n          }\n\n          resolve(_this.resolvedViewerUrl_);\n        });\n      } else {\n        resolve(_this.resolvedViewerUrl_);\n      }\n    }); // Remove hash when we have an incoming click tracking string\n    // (see impression.js).\n\n    if (this.hashParams_['click']) {\n      var newUrl = (0, _url.removeFragment)(this.win.location.href);\n\n      if (newUrl != this.win.location.href && this.win.history.replaceState) {\n        // Persist the hash that we removed has location.originalHash.\n        // This is currently used by mode.js to infer development mode.\n        if (!this.win.location.originalHash) {\n          this.win.location.originalHash = this.win.location.hash;\n        }\n\n        this.win.history.replaceState({}, '', newUrl);\n        delete this.hashParams_['click'];\n        (0, _log.dev)().fine(TAG_, 'replace fragment:' + this.win.location.href);\n      }\n    } // This fragment may get cleared by impression tracking. If so, it will be\n    // restored afterward.\n\n\n    this.ampdoc.whenFirstVisible().then(function () {\n      _this.maybeUpdateFragmentForCct();\n    });\n  }\n  /**\n   * Initialize messaging channel with Viewer host.\n   * This promise will resolve when communications channel has been\n   * established or timeout in 20 seconds. The timeout is needed to avoid\n   * this promise becoming a memory leak with accumulating undelivered\n   * messages. The promise is only available when the document is embedded.\n   *\n   * @param {!Promise} messagingPromise\n   * @return {?Promise}\n   * @private\n   */\n\n\n  var _proto = ViewerImpl.prototype;\n\n  _proto.initMessagingChannel_ = function initMessagingChannel_(messagingPromise) {\n    var isEmbedded = !!(this.isIframed_ && !this.win.__AMP_TEST_IFRAME && ( // Checking param \"origin\", as we expect all viewers to provide it.\n    // See https://github.com/ampproject/amphtml/issues/4183\n    // There appears to be a bug under investigation where the\n    // origin is sometimes failed to be detected. Since failure mode\n    // if we fail to initialize communication is very bad, we also check\n    // for visibilityState.\n    // After https://github.com/ampproject/amphtml/issues/6070\n    // is fixed we should probably only keep the amp_js_v check here.\n    this.ampdoc.getParam('origin') || this.ampdoc.getParam('visibilityState') || // Parent asked for viewer JS. We must be embedded.\n    this.win.location.search.indexOf('amp_js_v') != -1) || this.isWebviewEmbedded() || this.isCctEmbedded() || !this.ampdoc.isSingleDoc());\n\n    if (!isEmbedded) {\n      return null;\n    }\n\n    return _services.Services.timerFor(this.win).timeoutPromise(20000, messagingPromise, 'initMessagingChannel').catch(function (reason) {\n      var error = getChannelError(\n      /** @type {!Error|string|undefined} */\n      reason);\n      (0, _error.reportError)(error);\n      throw error;\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.getAmpDoc = function getAmpDoc() {\n    return this.ampdoc;\n  }\n  /** @override */\n  ;\n\n  _proto.getParam = function getParam(name) {\n    return this.ampdoc.getParam(name);\n  }\n  /** @override */\n  ;\n\n  _proto.hasCapability = function hasCapability(name) {\n    var capabilities = this.ampdoc.getParam('cap');\n\n    if (!capabilities) {\n      return false;\n    } // TODO(@cramforce): Consider caching the split.\n\n\n    return capabilities.split(',').indexOf(name) != -1;\n  }\n  /** @override */\n  ;\n\n  _proto.isEmbedded = function isEmbedded() {\n    return !!this.messagingReadyPromise_;\n  }\n  /** @override */\n  ;\n\n  _proto.isWebviewEmbedded = function isWebviewEmbedded() {\n    return !this.isIframed_ && this.ampdoc.getParam('webview') == '1';\n  }\n  /** @override */\n  ;\n\n  _proto.isCctEmbedded = function isCctEmbedded() {\n    if (this.isCctEmbedded_ != null) {\n      return this.isCctEmbedded_;\n    }\n\n    this.isCctEmbedded_ = false;\n\n    if (!this.isIframed_) {\n      var queryParams = (0, _url.parseQueryString)(this.win.location.search);\n      this.isCctEmbedded_ = queryParams['amp_gsa'] === '1' && (0, _string.startsWith)(queryParams['amp_js_v'] || '', 'a');\n    }\n\n    return this.isCctEmbedded_;\n  }\n  /** @override */\n  ;\n\n  _proto.isProxyOrigin = function isProxyOrigin() {\n    return this.isProxyOrigin_;\n  }\n  /** @override */\n  ;\n\n  _proto.maybeUpdateFragmentForCct = function maybeUpdateFragmentForCct() {\n    if (!this.isCctEmbedded()) {\n      return;\n    } // CCT only works with versions of Chrome that support the history API.\n\n\n    if (!this.win.history.replaceState) {\n      return;\n    }\n\n    var sourceOrigin = (0, _url.getSourceOrigin)(this.win.location.href);\n\n    var _Services$documentInf = _services.Services.documentInfoForDoc(this.ampdoc),\n        canonicalUrl = _Services$documentInf.canonicalUrl;\n\n    var canonicalSourceOrigin = (0, _url.getSourceOrigin)(canonicalUrl);\n\n    if (this.hasRoughlySameOrigin_(sourceOrigin, canonicalSourceOrigin)) {\n      this.hashParams_['ampshare'] = canonicalUrl;\n      this.win.history.replaceState({}, '', '#' + (0, _url.serializeQueryString)(\n      /** @type {!JsonObject} */\n      this.hashParams_));\n    }\n  }\n  /**\n   * Compares URLs to determine if they match once common subdomains are\n   * removed. Everything else must match.\n   * @param {string} first Origin to compare.\n   * @param {string} second Origin to compare.\n   * @return {boolean} Whether the origins match without subdomains.\n   * @private\n   */\n  ;\n\n  _proto.hasRoughlySameOrigin_ = function hasRoughlySameOrigin_(first, second) {\n    var trimOrigin = function trimOrigin(origin) {\n      if (origin.split('.').length > 2) {\n        return origin.replace(TRIM_ORIGIN_PATTERN_, '$1');\n      }\n\n      return origin;\n    };\n\n    return trimOrigin(first) == trimOrigin(second);\n  }\n  /** @override */\n  ;\n\n  _proto.isRuntimeOn = function isRuntimeOn() {\n    return this.isRuntimeOn_;\n  }\n  /** @override */\n  ;\n\n  _proto.toggleRuntime = function toggleRuntime() {\n    this.isRuntimeOn_ = !this.isRuntimeOn_;\n    (0, _log.dev)().fine(TAG_, 'Runtime state:', this.isRuntimeOn_);\n    this.runtimeOnObservable_.fire(this.isRuntimeOn_);\n  }\n  /** @override */\n  ;\n\n  _proto.onRuntimeState = function onRuntimeState(handler) {\n    return this.runtimeOnObservable_.add(handler);\n  }\n  /** @override */\n  ;\n\n  _proto.isOvertakeHistory = function isOvertakeHistory() {\n    return this.overtakeHistory_;\n  }\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  ;\n\n  _proto.getVisibilityState = function getVisibilityState() {\n    return this.ampdoc.getVisibilityState();\n  }\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  ;\n\n  _proto.isVisible = function isVisible() {\n    return this.ampdoc.isVisible();\n  }\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  ;\n\n  _proto.hasBeenVisible = function hasBeenVisible() {\n    return this.ampdoc.hasBeenVisible();\n  }\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  ;\n\n  _proto.whenFirstVisible = function whenFirstVisible() {\n    return this.ampdoc.whenFirstVisible();\n  }\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  ;\n\n  _proto.whenNextVisible = function whenNextVisible() {\n    return this.ampdoc.whenNextVisible();\n  }\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  ;\n\n  _proto.getFirstVisibleTime = function getFirstVisibleTime() {\n    return this.ampdoc.getFirstVisibleTime();\n  }\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  ;\n\n  _proto.getLastVisibleTime = function getLastVisibleTime() {\n    return this.ampdoc.getLastVisibleTime();\n  }\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  ;\n\n  _proto.onVisibilityChanged = function onVisibilityChanged(handler) {\n    return this.ampdoc.onVisibilityChanged(handler);\n  }\n  /**\n   * Sets the viewer defined visibility state.\n   * @param {?string|undefined} state\n   * @private\n   */\n  ;\n\n  _proto.setVisibilityState_ = function setVisibilityState_(state) {\n    if (!state) {\n      return;\n    }\n\n    state = (0, _log.dev)().assertEnumValue(_visibilityState.VisibilityState, state, 'VisibilityState'); // The viewer is informing us we are not currently active because we are\n    // being pre-rendered, or the user swiped to another doc (or closed the\n    // viewer). Unfortunately, the viewer sends HIDDEN instead of PRERENDER or\n    // INACTIVE, though we know better.\n\n    if (state === _visibilityState.VisibilityState.HIDDEN) {\n      state = this.ampdoc.getLastVisibleTime() != null ? _visibilityState.VisibilityState.INACTIVE : _visibilityState.VisibilityState.PRERENDER;\n    }\n\n    this.ampdoc.overrideVisibilityState(state);\n    (0, _log.dev)().fine(TAG_, 'visibilitychange event:', this.ampdoc.getVisibilityState());\n  }\n  /** @override */\n  ;\n\n  _proto.getPrerenderSize = function getPrerenderSize() {\n    return this.prerenderSize_;\n  }\n  /** @override */\n  ;\n\n  _proto.getResolvedViewerUrl = function getResolvedViewerUrl() {\n    return this.resolvedViewerUrl_;\n  }\n  /**\n   * Returns the promise that will yield the viewer URL value. It's by default\n   * the current page's URL. The trusted viewers are allowed to override this\n   * value.\n   * @return {!Promise<string>}\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.getViewerUrl = function getViewerUrl() {\n    return this.viewerUrl_;\n  }\n  /** @override */\n  ;\n\n  _proto.maybeGetMessagingOrigin = function maybeGetMessagingOrigin() {\n    return this.messagingOrigin_;\n  }\n  /** @override */\n  ;\n\n  _proto.getUnconfirmedReferrerUrl = function getUnconfirmedReferrerUrl() {\n    return this.unconfirmedReferrerUrl_;\n  }\n  /** @override */\n  ;\n\n  _proto.getReferrerUrl = function getReferrerUrl() {\n    return this.referrerUrl_;\n  }\n  /** @override */\n  ;\n\n  _proto.isTrustedViewer = function isTrustedViewer() {\n    var _this2 = this;\n\n    if (!this.isTrustedViewer_) {\n      var isTrustedAncestorOrigins = this.isTrustedAncestorOrigins_();\n      this.isTrustedViewer_ = isTrustedAncestorOrigins !== undefined ? Promise.resolve(isTrustedAncestorOrigins) : this.messagingReadyPromise_.then(function (origin) {\n        return origin ? _this2.isTrustedViewerOrigin_(origin) : false;\n      });\n    }\n\n    return (\n      /** @type {!Promise<boolean>} */\n      this.isTrustedViewer_\n    );\n  }\n  /**\n   * Whether the viewer is has been whitelisted for more sensitive operations\n   * by looking at the ancestorOrigins.\n   * @return {boolean|undefined}\n   */\n  ;\n\n  _proto.isTrustedAncestorOrigins_ = function isTrustedAncestorOrigins_() {\n    if (!this.isEmbedded()) {\n      // Not embedded in IFrame - can't trust the viewer.\n      return false;\n    } else if (this.win.location.ancestorOrigins && !this.isWebviewEmbedded() && !this.isCctEmbedded()) {\n      // Ancestors when available take precedence. This is the main API used\n      // for this determination. Fallback is only done when this API is not\n      // supported by the browser.\n      return this.win.location.ancestorOrigins.length > 0 && this.isTrustedViewerOrigin_(this.win.location.ancestorOrigins[0]);\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.getViewerOrigin = function getViewerOrigin() {\n    if (!this.viewerOrigin_) {\n      var origin;\n\n      if (!this.isEmbedded()) {\n        // Viewer is only determined for iframed documents at this time.\n        origin = '';\n      } else if (this.win.location.ancestorOrigins && this.win.location.ancestorOrigins.length > 0) {\n        origin = this.win.location.ancestorOrigins[0];\n      }\n\n      this.viewerOrigin_ = origin !== undefined ? Promise.resolve(origin) : _services.Services.timerFor(this.win).timeoutPromise(VIEWER_ORIGIN_TIMEOUT_, this.messagingReadyPromise_).catch(function () {\n        return '';\n      });\n    }\n\n    return (\n      /** @type {!Promise<string>} */\n      this.viewerOrigin_\n    );\n  }\n  /**\n   * @param {string} urlString\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.isTrustedViewerOrigin_ = function isTrustedViewerOrigin_(urlString) {\n    /** @const {!Location} */\n    var url = (0, _url.parseUrlDeprecated)(urlString);\n    var protocol = url.protocol; // Mobile WebView x-thread is allowed.\n\n    if (protocol == 'x-thread:') {\n      return true;\n    }\n\n    if (protocol != 'https:') {\n      // Non-https origins are never trusted.\n      return false;\n    }\n\n    return _config.urls.trustedViewerHosts.some(function (th) {\n      return th.test(url.hostname);\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.onMessage = function onMessage(eventType, handler) {\n    var observable = this.messageObservables_[eventType];\n\n    if (!observable) {\n      observable = new _observable.Observable();\n      this.messageObservables_[eventType] = observable;\n    }\n\n    return observable.add(handler);\n  }\n  /** @override */\n  ;\n\n  _proto.onMessageRespond = function onMessageRespond(eventType, responder) {\n    var _this3 = this;\n\n    this.messageResponders_[eventType] = responder;\n    return function () {\n      if (_this3.messageResponders_[eventType] === responder) {\n        delete _this3.messageResponders_[eventType];\n      }\n    };\n  }\n  /** @override */\n  ;\n\n  _proto.receiveMessage = function receiveMessage(eventType, data, unusedAwaitResponse) {\n    if (eventType == 'visibilitychange') {\n      if (data['prerenderSize'] !== undefined) {\n        this.prerenderSize_ = data['prerenderSize'];\n        (0, _log.dev)().fine(TAG_, '- prerenderSize change:', this.prerenderSize_);\n      }\n\n      this.setVisibilityState_(data['state']);\n      return Promise.resolve();\n    }\n\n    if (eventType == 'broadcast') {\n      this.broadcastObservable_.fire(\n      /** @type {!JsonObject|undefined} */\n      data);\n      return Promise.resolve();\n    }\n\n    var observable = this.messageObservables_[eventType];\n\n    if (observable) {\n      observable.fire(data);\n    }\n\n    var responder = this.messageResponders_[eventType];\n\n    if (responder) {\n      return responder(data);\n    } else if (observable) {\n      return Promise.resolve();\n    }\n\n    (0, _log.dev)().fine(TAG_, 'unknown message:', eventType);\n    return undefined;\n  }\n  /** @override */\n  ;\n\n  _proto.setMessageDeliverer = function setMessageDeliverer(deliverer, origin) {\n    var _this4 = this;\n\n    if (this.messageDeliverer_) {\n      throw new Error('message channel can only be initialized once');\n    }\n\n    if (origin == null) {\n      throw new Error('message channel must have an origin');\n    }\n\n    (0, _log.dev)().fine(TAG_, 'message channel established with origin: ', origin);\n    this.messageDeliverer_ = deliverer;\n    this.messagingOrigin_ = origin;\n    this.messagingReadyResolver_(origin);\n\n    if (this.messageQueue_.length > 0) {\n      var queue = this.messageQueue_.slice(0);\n      this.messageQueue_ = [];\n      queue.forEach(function (message) {\n        var responsePromise = _this4.messageDeliverer_(message.eventType, message.data, message.awaitResponse);\n\n        if (message.awaitResponse) {\n          message.responseResolver(responsePromise);\n        }\n      });\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.sendMessage = function sendMessage(eventType, data, cancelUnsent) {\n    if (cancelUnsent === void 0) {\n      cancelUnsent = false;\n    }\n\n    this.sendMessageInternal_(eventType, data, cancelUnsent, false);\n  }\n  /** @override */\n  ;\n\n  _proto.sendMessageAwaitResponse = function sendMessageAwaitResponse(eventType, data, cancelUnsent) {\n    if (cancelUnsent === void 0) {\n      cancelUnsent = false;\n    }\n\n    return this.sendMessageInternal_(eventType, data, cancelUnsent, true);\n  }\n  /**\n   * Sends the message to the viewer.\n   *\n   * @param {string} eventType\n   * @param {?JsonObject|string|undefined} data\n   * @param {boolean} cancelUnsent\n   * @param {boolean} awaitResponse\n   * @return {!Promise<(?JsonObject|string|undefined)>} the response promise\n   */\n  ;\n\n  _proto.sendMessageInternal_ = function sendMessageInternal_(eventType, data, cancelUnsent, awaitResponse) {\n    var _this5 = this;\n\n    if (this.messageDeliverer_) {\n      // Certain message deliverers return fake \"Promise\" instances called\n      // \"Thenables\". Convert from these values into trusted Promise instances,\n      // assimilating with the resolved (or rejected) internal value.\n      return (\n        /** @type {!Promise<?JsonObject|string|undefined>} */\n        (0, _promise.tryResolve)(function () {\n          return _this5.messageDeliverer_(eventType,\n          /** @type {?JsonObject|string|undefined} */\n          data, awaitResponse);\n        })\n      );\n    }\n\n    if (!this.messagingReadyPromise_) {\n      if (awaitResponse) {\n        return Promise.reject(getChannelError());\n      } else {\n        return Promise.resolve();\n      }\n    }\n\n    if (!cancelUnsent) {\n      return this.messagingReadyPromise_.then(function () {\n        return _this5.messageDeliverer_(eventType, data, awaitResponse);\n      });\n    }\n\n    var found = (0, _array.findIndex)(this.messageQueue_, function (m) {\n      return m.eventType == eventType;\n    });\n    var message;\n\n    if (found != -1) {\n      message = this.messageQueue_.splice(found, 1)[0];\n      message.data = data;\n      message.awaitResponse = message.awaitResponse || awaitResponse;\n    } else {\n      var deferred = new _promise.Deferred();\n      var responsePromise = deferred.promise,\n          responseResolver = deferred.resolve;\n      message = {\n        eventType: eventType,\n        data: data,\n        awaitResponse: awaitResponse,\n        responsePromise: responsePromise,\n        responseResolver: responseResolver\n      };\n    }\n\n    this.messageQueue_.push(message);\n    return message.responsePromise;\n  }\n  /** @override */\n  ;\n\n  _proto.broadcast = function broadcast(message) {\n    if (!this.messagingReadyPromise_) {\n      // Messaging is not expected.\n      return Promise.resolve(false);\n    }\n\n    return this.sendMessageInternal_('broadcast', message, false, false).then(function () {\n      return true;\n    }, function () {\n      return false;\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.onBroadcast = function onBroadcast(handler) {\n    return this.broadcastObservable_.add(handler);\n  }\n  /** @override */\n  ;\n\n  _proto.whenMessagingReady = function whenMessagingReady() {\n    return this.messagingReadyPromise_;\n  }\n  /** @override */\n  ;\n\n  _proto.replaceUrl = function replaceUrl(newUrl) {\n    if (!newUrl || !this.ampdoc.isSingleDoc() || !this.win.history.replaceState) {\n      return;\n    }\n\n    try {\n      // The origin and source origin must match.\n      var url = (0, _url.parseUrlDeprecated)(this.win.location.href);\n      var replaceUrl = (0, _url.parseUrlDeprecated)((0, _url.removeFragment)(newUrl) + this.win.location.hash);\n\n      if (url.origin == replaceUrl.origin && (0, _url.getSourceOrigin)(url) == (0, _url.getSourceOrigin)(replaceUrl)) {\n        this.win.history.replaceState({}, '', replaceUrl.href);\n        this.win.location.originalHref = url.href;\n        (0, _log.dev)().fine(TAG_, 'replace url:' + replaceUrl.href);\n      }\n    } catch (e) {\n      (0, _log.dev)().error(TAG_, 'replaceUrl failed', e);\n    }\n  };\n\n  return ViewerImpl;\n}();\n/**\n * Creates an error for the case where a channel cannot be established.\n * @param {*=} opt_reason\n * @return {!Error}\n */\n\n\nexports.ViewerImpl = ViewerImpl;\n\nfunction getChannelError(opt_reason) {\n  if (opt_reason instanceof Error) {\n    opt_reason = (0, _log.duplicateErrorIfNecessary)(opt_reason);\n    opt_reason.message = 'No messaging channel: ' + opt_reason.message;\n    return opt_reason;\n  }\n\n  return new Error('No messaging channel: ' + opt_reason);\n}\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nfunction installViewerServiceForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'viewer', ViewerImpl,\n  /* opt_instantiate */\n  true);\n}\n\n},{\"../config\":32,\"../dom\":41,\"../error\":44,\"../log\":68,\"../observable\":71,\"../service\":79,\"../services\":123,\"../string\":126,\"../url\":134,\"../utils/array\":135,\"../utils/object\":145,\"../utils/promise\":147,\"../visibility-state\":151,\"./viewer-interface\":115}],115:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ViewerInterface = exports.RequestResponderDef = void 0;\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @typedef {function(!JsonObject):(!Promise|undefined)}\n */\nvar RequestResponderDef;\n/* eslint-disable no-unused-vars */\n\n/**\n * @interface\n */\n\nexports.RequestResponderDef = RequestResponderDef;\n\nvar ViewerInterface =\n/*#__PURE__*/\nfunction () {\n  function ViewerInterface() {}\n\n  var _proto = ViewerInterface.prototype;\n\n  /**\n   * @return {!./ampdoc-impl.AmpDoc}\n   */\n  _proto.getAmpDoc = function getAmpDoc() {}\n  /**\n   * Returns the value of a viewer's startup parameter with the specified\n   * name or \"undefined\" if the parameter wasn't defined at startup time.\n   * TODO(#22733): deprecate/remove when ampdoc-fie is launched. Be careful that it's\n   * exported. Need to make sure it's not used externally.\n   * @param {string} name\n   * @return {?string}\n   * @export\n   */\n  ;\n\n  _proto.getParam = function getParam(name) {}\n  /**\n   * Viewers can communicate their \"capabilities\" and this method allows\n   * checking them.\n   * @param {string} name Of the capability.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.hasCapability = function hasCapability(name) {}\n  /**\n   * Whether the document is embedded in a viewer.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isEmbedded = function isEmbedded() {}\n  /**\n   * Whether the document is embedded in a webview.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isWebviewEmbedded = function isWebviewEmbedded() {}\n  /**\n   * Whether the document is embedded in a Chrome Custom Tab.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isCctEmbedded = function isCctEmbedded() {}\n  /**\n   * Whether the document was served by a proxy.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isProxyOrigin = function isProxyOrigin() {}\n  /**\n   * Update the URL fragment with data needed to support custom tabs. This will\n   * not clear query string parameters, but will clear the fragment.\n   */\n  ;\n\n  _proto.maybeUpdateFragmentForCct = function maybeUpdateFragmentForCct() {}\n  /**\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isRuntimeOn = function isRuntimeOn() {}\n  /**\n   */\n  ;\n\n  _proto.toggleRuntime = function toggleRuntime() {}\n  /**\n   * @param {function(boolean)} handler\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onRuntimeState = function onRuntimeState(handler) {}\n  /**\n   * Whether the viewer overtakes the history for AMP document. If yes,\n   * the viewer must implement history messages \"pushHistory\" and \"popHistory\"\n   * and emit message \"historyPopped\"\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isOvertakeHistory = function isOvertakeHistory() {}\n  /**\n   * How much the viewer has requested the runtime to prerender the document.\n   * The values are in number of screens.\n   * @return {number}\n   */\n  ;\n\n  _proto.getPrerenderSize = function getPrerenderSize() {}\n  /**\n   * Returns the resolved viewer URL value. It's by default the current page's\n   * URL. The trusted viewers are allowed to override this value.\n   * @return {string}\n   */\n  ;\n\n  _proto.getResolvedViewerUrl = function getResolvedViewerUrl() {}\n  /**\n   * Possibly return the messaging origin if set. This would be the origin\n   * of the parent viewer.\n   * @return {?string}\n   */\n  ;\n\n  _proto.maybeGetMessagingOrigin = function maybeGetMessagingOrigin() {}\n  /**\n   * Returns an unconfirmed \"referrer\" URL that can be optionally customized by\n   * the viewer. Consider using `getReferrerUrl()` instead, which returns the\n   * promise that will yield the confirmed \"referrer\" URL.\n   * @return {string}\n   */\n  ;\n\n  _proto.getUnconfirmedReferrerUrl = function getUnconfirmedReferrerUrl() {}\n  /**\n   * Returns the promise that will yield the confirmed \"referrer\" URL. This\n   * URL can be optionally customized by the viewer, but viewer is required\n   * to be a trusted viewer.\n   * @return {!Promise<string>}\n   */\n  ;\n\n  _proto.getReferrerUrl = function getReferrerUrl() {}\n  /**\n   * Whether the viewer has been whitelisted for more sensitive operations\n   * such as customizing referrer.\n   * @return {!Promise<boolean>}\n   */\n  ;\n\n  _proto.isTrustedViewer = function isTrustedViewer() {}\n  /**\n   * Returns the promise that resolves to URL representing the origin of the\n   * viewer. If the document is not embedded or if a viewer origin can't be\n   * found, empty string is returned.\n   * @return {!Promise<string>}\n   */\n  ;\n\n  _proto.getViewerOrigin = function getViewerOrigin() {}\n  /**\n   * Adds a eventType listener for viewer events.\n   * @param {string} eventType\n   * @param {function(!JsonObject)} handler\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onMessage = function onMessage(eventType, handler) {}\n  /**\n   * Adds a eventType listener for viewer events.\n   * @param {string} eventType\n   * @param {!RequestResponderDef} responder\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onMessageRespond = function onMessageRespond(eventType, responder) {}\n  /**\n   * Requests AMP document to receive a message from Viewer.\n   * @param {string} eventType\n   * @param {!JsonObject} data\n   * @param {boolean} unusedAwaitResponse\n   * @return {(!Promise<*>|undefined)}\n   * @export\n   */\n  ;\n\n  _proto.receiveMessage = function receiveMessage(eventType, data, unusedAwaitResponse) {}\n  /**\n   * Provides a message delivery mechanism by which AMP document can send\n   * messages to the viewer.\n   * @param {function(string, (?JsonObject|string|undefined), boolean):\n   *     (!Promise<*>|undefined)} deliverer\n   * @param {string} origin\n   * @export\n   */\n  ;\n\n  _proto.setMessageDeliverer = function setMessageDeliverer(deliverer, origin) {}\n  /**\n   * Sends the message to the viewer without waiting for any response.\n   * If cancelUnsent is true, the previous message of the same message type will\n   * be canceled.\n   *\n   * This is a restricted API.\n   *\n   * @param {string} eventType\n   * @param {?JsonObject|string|undefined} data\n   * @param {boolean=} cancelUnsent\n   */\n  ;\n\n  _proto.sendMessage = function sendMessage(eventType, data, cancelUnsent) {\n    if (cancelUnsent === void 0) {\n      cancelUnsent = false;\n    }\n  }\n  /**\n   * Sends the message to the viewer and wait for response.\n   * If cancelUnsent is true, the previous message of the same message type will\n   * be canceled.\n   *\n   * This is a restricted API.\n   *\n   * @param {string} eventType\n   * @param {?JsonObject|string|undefined} data\n   * @param {boolean=} cancelUnsent\n   * @return {!Promise<(?JsonObject|string|undefined)>} the response promise\n   */\n  ;\n\n  _proto.sendMessageAwaitResponse = function sendMessageAwaitResponse(eventType, data, cancelUnsent) {\n    if (cancelUnsent === void 0) {\n      cancelUnsent = false;\n    }\n  }\n  /**\n   * Broadcasts a message to all other AMP documents under the same viewer. It\n   * will attempt to deliver messages when the messaging channel has been\n   * established, but it will not fail if the channel is timed out.\n   *\n   * @param {!JsonObject} message\n   * @return {!Promise<boolean>} a Promise of success or not\n   */\n  ;\n\n  _proto.broadcast = function broadcast(message) {}\n  /**\n   * Registers receiver for the broadcast events.\n   * @param {function(!JsonObject)} handler\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onBroadcast = function onBroadcast(handler) {}\n  /**\n   * Resolves when there is a messaging channel established with the viewer.\n   * Will be null if no messaging is needed like in an non-embedded document.\n   * Deprecated: do not use. sendMessage and sendMessageAwaitResponse already\n   *             wait for messaging channel ready.\n   * @return {?Promise}\n   */\n  ;\n\n  _proto.whenMessagingReady = function whenMessagingReady() {}\n  /**\n   * Replace the document url with the viewer provided new replaceUrl.\n   * @param {?string} newUrl\n   */\n  ;\n\n  _proto.replaceUrl = function replaceUrl(newUrl) {};\n\n  return ViewerInterface;\n}();\n/* eslint-enable no-unused-vars */\n\n\nexports.ViewerInterface = ViewerInterface;\n\n},{}],116:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.marginBottomOfLastChild = marginBottomOfLastChild;\nexports.ViewportBindingDef = void 0;\n\nvar _style = require(\"../../style\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * ViewportBindingDef is an interface that defines an underlying technology\n * behind the {@link ViewportInterface}.\n * @interface\n */\nvar ViewportBindingDef =\n/*#__PURE__*/\nfunction () {\n  function ViewportBindingDef() {}\n\n  var _proto = ViewportBindingDef.prototype;\n\n  /**\n   * Called before a first AMP element is added to resources. The final\n   * preparations must be completed here. Called in the mutate context.\n   */\n  _proto.ensureReadyForElements = function ensureReadyForElements() {}\n  /**\n   * Add listeners for global resources.\n   */\n  ;\n\n  _proto.connect = function connect() {}\n  /**\n   * Remove listeners for global resources.\n   */\n  ;\n\n  _proto.disconnect = function disconnect() {}\n  /**\n   * Returns the width of top border if this type of viewport needs border\n   * offsetting. This is currently only needed for iOS to avoid scroll freeze.\n   * @return {number}\n   */\n  ;\n\n  _proto.getBorderTop = function getBorderTop() {}\n  /**\n   * Whether the binding requires fixed elements to be transfered to a\n   * independent fixed layer.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.requiresFixedLayerTransfer = function requiresFixedLayerTransfer() {}\n  /**\n   * Whether the binding requires the global window's `scrollTo` to be\n   * indirected via methods of this binding.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.overrideGlobalScrollTo = function overrideGlobalScrollTo() {}\n  /**\n   * Whether the binding supports fix-positioned elements.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.supportsPositionFixed = function supportsPositionFixed() {}\n  /**\n   * Register a callback for scroll events.\n   * @param {function()} unusedCallback\n   */\n  ;\n\n  _proto.onScroll = function onScroll(unusedCallback) {}\n  /**\n   * Register a callback for resize events.\n   * @param {function()} unusedCallback\n   */\n  ;\n\n  _proto.onResize = function onResize(unusedCallback) {}\n  /**\n   * Updates binding with the new padding.\n   * @param {number} unusedPaddingTop\n   */\n  ;\n\n  _proto.updatePaddingTop = function updatePaddingTop(unusedPaddingTop) {}\n  /**\n   * Updates binding with the new padding when hiding viewer header.\n   * @param {boolean} unusedTransient\n   * @param {number} unusedLastPaddingTop\n   */\n  ;\n\n  _proto.hideViewerHeader = function hideViewerHeader(unusedTransient, unusedLastPaddingTop) {}\n  /**\n   * Updates binding with the new padding when showing viewer header.\n   * @param {boolean} unusedTransient\n   * @param {number} unusedPaddingTop\n   */\n  ;\n\n  _proto.showViewerHeader = function showViewerHeader(unusedTransient, unusedPaddingTop) {}\n  /**\n   * Disable the scrolling by setting overflow: hidden.\n   * Should only be used for temporarily disabling scroll.\n   */\n  ;\n\n  _proto.disableScroll = function disableScroll() {}\n  /**\n   * Reset the scrolling by removing overflow: hidden.\n   */\n  ;\n\n  _proto.resetScroll = function resetScroll() {}\n  /**\n   * Updates the viewport whether it's currently in the lightbox or a normal\n   * mode.\n   * @param {boolean} unusedLightboxMode\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.updateLightboxMode = function updateLightboxMode(unusedLightboxMode) {}\n  /**\n   * Returns the size of the viewport.\n   * @return {!{width: number, height: number}}\n   */\n  ;\n\n  _proto.getSize = function getSize() {}\n  /**\n   * Returns the top scroll position for the viewport.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollTop = function getScrollTop() {}\n  /**\n   * Sets scroll top position to the specified value or the nearest possible.\n   * @param {number} unusedScrollTop\n   */\n  ;\n\n  _proto.setScrollTop = function setScrollTop(unusedScrollTop) {}\n  /**\n   * Returns the left scroll position for the viewport.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollLeft = function getScrollLeft() {}\n  /**\n   * Returns the scroll width of the content of the document.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollWidth = function getScrollWidth() {}\n  /**\n   * Returns the scroll height of the content of the document, including the\n   * padding top for the viewer header.\n   * The scrollHeight will be the viewport height if there's not enough content\n   * to fill up the viewport.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollHeight = function getScrollHeight() {}\n  /**\n   * Returns the height of the content of the document, including the\n   * padding top for the viewer header.\n   * contentHeight will match scrollHeight in all cases unless the viewport is\n   * taller than the content.\n   * @return {number}\n   */\n  ;\n\n  _proto.getContentHeight = function getContentHeight() {}\n  /**\n   * Resource manager signals to the viewport that content height is changed\n   * and some action may need to be taken.\n   * @restricted Use is restricted due to potentially very heavy performance\n   *   impact. Can only be called when not actively scrolling.\n   */\n  ;\n\n  _proto.contentHeightChanged = function contentHeightChanged() {}\n  /**\n   * Returns the rect of the element within the document.\n   * @param {!Element} unusedEl\n   * @param {number=} unusedScrollLeft Optional arguments that the caller may\n   *     pass in, if they cached these values and would like to avoid\n   *     remeasure. Requires appropriate updating the values on scroll.\n   * @param {number=} unusedScrollTop Same comment as above.\n   * @return {!../../layout-rect.LayoutRectDef}\n   */\n  ;\n\n  _proto.getLayoutRect = function getLayoutRect(unusedEl, unusedScrollLeft, unusedScrollTop) {}\n  /**\n   * Returns the client rect of the current window.\n   * @return {Promise<null>|Promise<!../../layout-rect.LayoutRectDef>}\n   */\n  ;\n\n  _proto.getRootClientRectAsync = function getRootClientRectAsync() {}\n  /**\n   * Returns the element considered the root scroller for this binding.\n   * @return {!Element}\n   */\n  ;\n\n  _proto.getScrollingElement = function getScrollingElement() {}\n  /**\n   * Whether the root scroller is a native root scroller (behaves like a\n   * viewport), or an overflow scroller (scrolls like an element).\n   * @return {boolean}\n   */\n  ;\n\n  _proto.getScrollingElementScrollsLikeViewport = function getScrollingElementScrollsLikeViewport() {};\n\n  return ViewportBindingDef;\n}();\n/**\n * Returns the margin-bottom of the last child of `element` that affects\n * document height (is static/relative position with non-zero height),\n * if any. Otherwise, returns 0.\n *\n * TODO(choumx): This is a weird location, so refactor to improve code sharing\n * among implementations of ViewportBindingDef generally.\n *\n * @param {!Window} win\n * @param {!Element} element\n * @return {number}\n */\n\n\nexports.ViewportBindingDef = ViewportBindingDef;\n\nfunction marginBottomOfLastChild(win, element) {\n  var style;\n\n  for (var n = element.lastElementChild; n; n = n.previousElementSibling) {\n    var r = n.\n    /*OK*/\n    getBoundingClientRect();\n\n    if (r.height > 0) {\n      var s = (0, _style.computedStyle)(win, n);\n\n      if (s.position == 'static' || s.position == 'relative') {\n        style = s;\n        break;\n      }\n    }\n  }\n\n  return style ? parseInt(style.marginBottom, 10) : 0;\n}\n\n},{\"../../style\":128}],117:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ViewportBindingIosEmbedWrapper_ = void 0;\n\nvar _observable = require(\"../../observable\");\n\nvar _services = require(\"../../services\");\n\nvar _viewportBindingDef = require(\"./viewport-binding-def\");\n\nvar _style = require(\"../../style\");\n\nvar _log = require(\"../../log\");\n\nvar _experiments = require(\"../../experiments\");\n\nvar _layoutRect = require(\"../../layout-rect\");\n\nvar _dom = require(\"../../dom\");\n\nvar _documentReady = require(\"../../document-ready\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG_ = 'Viewport';\n/**\n * Implementation of ViewportBindingDef based for iframed iOS case where iframes\n * are not scrollable. Scrolling accomplished here by inserting a scrollable\n * wrapper `<html id=\"i-amphtml-wrapper\">` inside the `<html>` element and\n * reparenting the original `<body>` inside.\n *\n * @implements {ViewportBindingDef}\n * @visibleForTesting\n */\n\nvar ViewportBindingIosEmbedWrapper_ =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function ViewportBindingIosEmbedWrapper_(win) {\n    var _this = this;\n\n    /** @const {!Window} */\n    this.win = win;\n    /** @protected {!../vsync-impl.Vsync} */\n\n    this.vsync_ = _services.Services.vsyncFor(win);\n    var doc = this.win.document;\n    var documentElement = doc.documentElement;\n    var topClasses = documentElement.className;\n    documentElement.classList.add('i-amphtml-ios-embed');\n    var wrapper = doc.createElement('html');\n    /** @private @const {!Element} */\n\n    this.wrapper_ = wrapper;\n    wrapper.id = 'i-amphtml-wrapper';\n    wrapper.className = topClasses;\n    /** @private @const {!Observable} */\n\n    this.scrollObservable_ = new _observable.Observable();\n    /** @private @const {!Observable} */\n\n    this.resizeObservable_ = new _observable.Observable();\n    /** @const {function()} */\n\n    this.boundScrollEventListener_ = this.onScrolled_.bind(this); // eslint-disable-next-line jsdoc/require-returns\n\n    /** @const {function()} */\n\n    this.boundResizeEventListener_ = function () {\n      return _this.resizeObservable_.fire();\n    };\n    /** @private {number} */\n\n\n    this.paddingTop_ = 0; // Setup UI.\n\n    /** @private {boolean} */\n\n    this.setupDone_ = false;\n    (0, _dom.waitForBodyOpen)(doc, this.setup_.bind(this)); // Set overscroll (`-webkit-overflow-scrolling: touch`) later to avoid\n    // iOS rendering bugs. See #8798 for details.\n\n    (0, _documentReady.whenDocumentReady)(doc).then(function () {\n      documentElement.classList.add('i-amphtml-ios-overscroll');\n    });\n    (0, _log.dev)().fine(TAG_, 'initialized ios-embed-wrapper viewport');\n  }\n  /** @override */\n\n\n  var _proto = ViewportBindingIosEmbedWrapper_.prototype;\n\n  _proto.ensureReadyForElements = function ensureReadyForElements() {\n    this.setup_();\n  }\n  /** @private */\n  ;\n\n  _proto.setup_ = function setup_() {\n    if (this.setupDone_) {\n      return;\n    }\n\n    this.setupDone_ = true; // Embedded scrolling on iOS is rather complicated. IFrames cannot be sized\n    // and be scrollable. Sizing iframe by scrolling height has a big negative\n    // that \"fixed\" position is essentially impossible. The only option we\n    // found is to reset scrolling on the AMP doc, which wraps the natural BODY\n    // inside the `overflow:auto` element. For reference, here are related\n    // iOS issues (Chrome issues are also listed for reference):\n    // - https://code.google.com/p/chromium/issues/detail?id=2891\n    // - https://code.google.com/p/chromium/issues/detail?id=157855\n    // - https://bugs.webkit.org/show_bug.cgi?id=106133\n    // - https://bugs.webkit.org/show_bug.cgi?id=149264\n\n    var doc = this.win.document;\n    var body = (0, _log.dev)().assertElement(doc.body, 'body is not available');\n    doc.documentElement.appendChild(this.wrapper_);\n    this.wrapper_.appendChild(body); // Redefine `document.body`, otherwise it'd be `null`.\n\n    Object.defineProperty(doc, 'body', {\n      get: function get() {\n        return body;\n      }\n    }); // Make sure the scroll position is adjusted correctly.\n\n    this.onScrolled_();\n  }\n  /** @override */\n  ;\n\n  _proto.connect = function connect() {\n    this.win.addEventListener('resize', this.boundResizeEventListener_);\n    this.wrapper_.addEventListener('scroll', this.boundScrollEventListener_);\n  }\n  /** @override */\n  ;\n\n  _proto.disconnect = function disconnect() {\n    this.win.removeEventListener('resize', this.boundResizeEventListener_);\n    this.wrapper_.removeEventListener('scroll', this.boundScrollEventListener_);\n  }\n  /** @override */\n  ;\n\n  _proto.getBorderTop = function getBorderTop() {\n    // iOS needs an extra pixel to avoid scroll freezing.\n    return 1;\n  }\n  /** @override */\n  ;\n\n  _proto.requiresFixedLayerTransfer = function requiresFixedLayerTransfer() {\n    if (!(0, _experiments.isExperimentOn)(this.win, 'ios-fixed-no-transfer')) {\n      return true;\n    } // The jumping fixed elements have been fixed in iOS 12.2.\n\n\n    var iosVersion = parseFloat(_services.Services.platformFor(this.win).getIosVersionString());\n    return iosVersion < 12.2;\n  }\n  /** @override */\n  ;\n\n  _proto.overrideGlobalScrollTo = function overrideGlobalScrollTo() {\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.supportsPositionFixed = function supportsPositionFixed() {\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.onScroll = function onScroll(callback) {\n    this.scrollObservable_.add(callback);\n  }\n  /** @override */\n  ;\n\n  _proto.onResize = function onResize(callback) {\n    this.resizeObservable_.add(callback);\n  }\n  /** @override */\n  ;\n\n  _proto.updatePaddingTop = function updatePaddingTop(paddingTop) {\n    this.paddingTop_ = paddingTop;\n    (0, _style.setImportantStyles)(this.wrapper_, {\n      'padding-top': (0, _style.px)(paddingTop)\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.hideViewerHeader = function hideViewerHeader(transient, unusedLastPaddingTop) {\n    if (!transient) {\n      this.updatePaddingTop(0);\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.showViewerHeader = function showViewerHeader(transient, paddingTop) {\n    if (!transient) {\n      this.updatePaddingTop(paddingTop);\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.disableScroll = function disableScroll() {\n    // TODO(jridgewell): Recursively disable scroll\n    this.wrapper_.classList.add('i-amphtml-scroll-disabled');\n  }\n  /** @override */\n  ;\n\n  _proto.resetScroll = function resetScroll() {\n    // TODO(jridgewell): Recursively disable scroll\n    this.wrapper_.classList.remove('i-amphtml-scroll-disabled');\n  }\n  /** @override */\n  ;\n\n  _proto.updateLightboxMode = function updateLightboxMode(unusedLightboxMode) {\n    // The layout is always accurate.\n    return Promise.resolve();\n  }\n  /** @override */\n  ;\n\n  _proto.getSize = function getSize() {\n    return {\n      width: this.win.\n      /*OK*/\n      innerWidth,\n      height: this.win.\n      /*OK*/\n      innerHeight\n    };\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollTop = function getScrollTop() {\n    return this.wrapper_.\n    /*OK*/\n    scrollTop;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollLeft = function getScrollLeft() {\n    // The wrapper is set to overflow-x: hidden so the document cannot be\n    // scrolled horizontally. The scrollLeft will always be 0.\n    return 0;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollWidth = function getScrollWidth() {\n    return this.wrapper_.\n    /*OK*/\n    scrollWidth;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollHeight = function getScrollHeight() {\n    return this.wrapper_.\n    /*OK*/\n    scrollHeight;\n  }\n  /** @override */\n  ;\n\n  _proto.getContentHeight = function getContentHeight() {\n    // The wrapped body, not this.wrapper_ itself, will have the correct height.\n    var content = this.win.document.body;\n\n    var _content$getBoundingC = content.\n    /*OK*/\n    getBoundingClientRect(),\n        height = _content$getBoundingC.height; // Unlike other viewport bindings, there's no need to include the\n    // rect top since the wrapped body accounts for the top margin of children.\n    // However, the parent's padding-top (this.paddingTop_) must be added.\n    // As of Safari 12.1.1, the getBoundingClientRect().height does not include\n    // the bottom margin of children and there's no other API that does.\n\n\n    var childMarginBottom = (0, _viewportBindingDef.marginBottomOfLastChild)(this.win, content);\n    var style = (0, _style.computedStyle)(this.win, content);\n    return parseInt(style.marginTop, 10) + this.paddingTop_ + height + childMarginBottom + parseInt(style.marginBottom, 10);\n  }\n  /** @override */\n  ;\n\n  _proto.contentHeightChanged = function contentHeightChanged() {}\n  /** @override */\n  ;\n\n  _proto.getLayoutRect = function getLayoutRect(el, opt_scrollLeft, opt_scrollTop) {\n    var b = el.\n    /*OK*/\n    getBoundingClientRect();\n    var scrollTop = opt_scrollTop != undefined ? opt_scrollTop : this.getScrollTop();\n    var scrollLeft = opt_scrollLeft != undefined ? opt_scrollLeft : this.getScrollLeft();\n    return (0, _layoutRect.layoutRectLtwh)(Math.round(b.left + scrollLeft), Math.round(b.top + scrollTop), Math.round(b.width), Math.round(b.height));\n  }\n  /** @override */\n  ;\n\n  _proto.getRootClientRectAsync = function getRootClientRectAsync() {\n    return Promise.resolve(null);\n  }\n  /** @override */\n  ;\n\n  _proto.setScrollTop = function setScrollTop(scrollTop) {\n    // If scroll top is 0, it's set to 1 to avoid scroll-freeze issue. See\n    // `onScrolled_` for more details.\n    this.wrapper_.\n    /*OK*/\n    scrollTop = scrollTop || 1;\n  }\n  /**\n   * @param {!Event=} opt_event\n   * @private\n   */\n  ;\n\n  _proto.onScrolled_ = function onScrolled_(opt_event) {\n    // Scroll document into a safe position to avoid scroll freeze on iOS.\n    // This means avoiding scrollTop to be minimum (0) or maximum value.\n    // This is very sad but very necessary. See #330 for more details.\n    // Unfortunately, the same is very expensive to do on the bottom, due to\n    // costly scrollHeight.\n    if (this.wrapper_.\n    /*OK*/\n    scrollTop == 0) {\n      this.wrapper_.\n      /*OK*/\n      scrollTop = 1;\n\n      if (opt_event) {\n        opt_event.preventDefault();\n      }\n    }\n\n    if (opt_event) {\n      this.scrollObservable_.fire();\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollingElement = function getScrollingElement() {\n    return this.wrapper_;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollingElementScrollsLikeViewport = function getScrollingElementScrollsLikeViewport() {\n    return false;\n  };\n\n  return ViewportBindingIosEmbedWrapper_;\n}();\n\nexports.ViewportBindingIosEmbedWrapper_ = ViewportBindingIosEmbedWrapper_;\n\n},{\"../../document-ready\":39,\"../../dom\":41,\"../../experiments\":47,\"../../layout-rect\":65,\"../../log\":68,\"../../observable\":71,\"../../services\":123,\"../../style\":128,\"./viewport-binding-def\":116}],118:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ViewportBindingNatural_ = void 0;\n\nvar _observable = require(\"../../observable\");\n\nvar _services = require(\"../../services\");\n\nvar _viewportBindingDef = require(\"./viewport-binding-def\");\n\nvar _style = require(\"../../style\");\n\nvar _log = require(\"../../log\");\n\nvar _layoutRect = require(\"../../layout-rect\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG_ = 'Viewport';\n/**\n * Implementation of ViewportBindingDef based on the native window. It assumes\n * that the native window is sized properly and events represent the actual\n * scroll/resize events. This mode is applicable to a standalone document\n * display or when an iframe has a fixed size.\n *\n * Visible for testing.\n *\n * @implements {ViewportBindingDef}\n */\n\nvar ViewportBindingNatural_ =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!../ampdoc-impl.AmpDoc} ampdoc\n   */\n  function ViewportBindingNatural_(ampdoc) {\n    var _this = this;\n\n    /** @const {!../ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n    /** @const {!Window} */\n\n    this.win = ampdoc.win;\n    /** @const {!../../service/platform-impl.Platform} */\n\n    this.platform_ = _services.Services.platformFor(this.win);\n    /** @private @const {!Observable} */\n\n    this.scrollObservable_ = new _observable.Observable();\n    /** @private @const {!Observable} */\n\n    this.resizeObservable_ = new _observable.Observable();\n    /**\n     * See `handleScrollEvent_` for details.\n     * @private @const {boolean}\n     */\n\n    this.resetScrollX_ = this.platform_.isIos() && this.win.parent !== this.win;\n    /** @const {function()} */\n\n    this.boundScrollEventListener_ = this.handleScrollEvent_.bind(this); // eslint-disable-next-line jsdoc/require-returns\n\n    /** @const {function()} */\n\n    this.boundResizeEventListener_ = function () {\n      return _this.resizeObservable_.fire();\n    };\n\n    (0, _log.dev)().fine(TAG_, 'initialized natural viewport');\n  }\n  /** @private */\n\n\n  var _proto = ViewportBindingNatural_.prototype;\n\n  _proto.handleScrollEvent_ = function handleScrollEvent_() {\n    if (this.resetScrollX_ && this.getScrollingElement().\n    /*OK*/\n    scrollLeft > 0) {\n      // In the iframed iOS Safari case the `touch-action` and\n      // `overscroll-behavior` are not observed which leads to the overscroll\n      // bugs on the horizontal axis. The solution is to reset the horizontal\n      // scrolling in this case. See b/140131460 for more details.\n      this.getScrollingElement().\n      /*OK*/\n      scrollLeft = 0;\n    }\n\n    this.scrollObservable_.fire();\n  }\n  /** @override */\n  ;\n\n  _proto.connect = function connect() {\n    this.win.addEventListener('scroll', this.boundScrollEventListener_);\n    this.win.addEventListener('resize', this.boundResizeEventListener_);\n  }\n  /** @override */\n  ;\n\n  _proto.disconnect = function disconnect() {\n    this.win.removeEventListener('scroll', this.boundScrollEventListener_);\n    this.win.removeEventListener('resize', this.boundResizeEventListener_);\n  }\n  /** @override */\n  ;\n\n  _proto.ensureReadyForElements = function ensureReadyForElements() {} // Nothing.\n\n  /** @override */\n  ;\n\n  _proto.getBorderTop = function getBorderTop() {\n    return 0;\n  }\n  /** @override */\n  ;\n\n  _proto.requiresFixedLayerTransfer = function requiresFixedLayerTransfer() {\n    return false;\n  }\n  /** @override */\n  ;\n\n  _proto.overrideGlobalScrollTo = function overrideGlobalScrollTo() {\n    return false;\n  }\n  /** @override */\n  ;\n\n  _proto.supportsPositionFixed = function supportsPositionFixed() {\n    return true;\n  }\n  /** @override */\n  ;\n\n  _proto.onScroll = function onScroll(callback) {\n    this.scrollObservable_.add(callback);\n  }\n  /** @override */\n  ;\n\n  _proto.onResize = function onResize(callback) {\n    this.resizeObservable_.add(callback);\n  }\n  /** @override */\n  ;\n\n  _proto.updatePaddingTop = function updatePaddingTop(paddingTop) {\n    (0, _style.setImportantStyles)(this.win.document.documentElement, {\n      'padding-top': (0, _style.px)(paddingTop)\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.hideViewerHeader = function hideViewerHeader(transient, unusedLastPaddingTop) {\n    if (!transient) {\n      this.updatePaddingTop(0);\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.showViewerHeader = function showViewerHeader(transient, paddingTop) {\n    if (!transient) {\n      this.updatePaddingTop(paddingTop);\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.disableScroll = function disableScroll() {\n    // TODO(jridgewell): Recursively disable scroll\n    this.win.document.documentElement.classList.add('i-amphtml-scroll-disabled');\n  }\n  /** @override */\n  ;\n\n  _proto.resetScroll = function resetScroll() {\n    // TODO(jridgewell): Recursively disable scroll\n    this.win.document.documentElement.classList.remove('i-amphtml-scroll-disabled');\n  }\n  /** @override */\n  ;\n\n  _proto.updateLightboxMode = function updateLightboxMode(unusedLightboxMode) {\n    // The layout is always accurate.\n    return Promise.resolve();\n  }\n  /** @override */\n  ;\n\n  _proto.getSize = function getSize() {\n    // Prefer window innerWidth/innerHeight but fall back to\n    // documentElement clientWidth/clientHeight.\n    // documentElement./*OK*/clientHeight is buggy on iOS Safari\n    // and thus cannot be used.\n    var winWidth = this.win.\n    /*OK*/\n    innerWidth;\n    var winHeight = this.win.\n    /*OK*/\n    innerHeight;\n\n    if (winWidth && winHeight) {\n      return {\n        width: winWidth,\n        height: winHeight\n      };\n    }\n\n    var el = this.win.document.documentElement;\n    return {\n      width: el.\n      /*OK*/\n      clientWidth,\n      height: el.\n      /*OK*/\n      clientHeight\n    };\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollTop = function getScrollTop() {\n    var pageScrollTop = this.getScrollingElement().\n    /*OK*/\n    scrollTop || this.win.\n    /*OK*/\n    pageYOffset;\n\n    var _this$ampdoc$getRootN = this.ampdoc.getRootNode(),\n        host = _this$ampdoc$getRootN.host;\n\n    return host ? pageScrollTop - host.\n    /*OK*/\n    offsetTop : pageScrollTop;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollLeft = function getScrollLeft() {\n    // The html is set to overflow-x: hidden so the document cannot be\n    // scrolled horizontally. The scrollLeft will always be 0.\n    return 0;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollWidth = function getScrollWidth() {\n    return this.getScrollingElement().\n    /*OK*/\n    scrollWidth;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollHeight = function getScrollHeight() {\n    return this.getScrollingElement().\n    /*OK*/\n    scrollHeight;\n  }\n  /** @override */\n  ;\n\n  _proto.getContentHeight = function getContentHeight() {\n    // Don't use scrollHeight, since it returns `MAX(viewport_height,\n    // document_height)` (we only want the latter), and it doesn't account\n    // for margins. Also, don't use documentElement's rect height because\n    // there's no workable analog for either ios-embed-* modes.\n    var content = this.getScrollingElement();\n    var rect = content.\n    /*OK*/\n    getBoundingClientRect(); // The Y-position of `content` can be offset by the vertical margin\n    // of its first child, and this is _not_ accounted for in `rect.height`.\n    // This causes smaller than expected content height, so add it manually.\n    // Note this \"top\" value already includes padding-top of ancestor elements\n    // and getBorderTop().\n\n    var top = rect.top + this.getScrollTop(); // As of Safari 12.1.1, the getBoundingClientRect().height does not include\n    // the bottom margin of children and there's no other API that does.\n\n    var childMarginBottom = _services.Services.platformFor(this.win).isSafari() ? (0, _viewportBindingDef.marginBottomOfLastChild)(this.win, content) : 0;\n    var style = (0, _style.computedStyle)(this.win, content);\n    return top + parseInt(style.marginTop, 10) + rect.height + childMarginBottom + parseInt(style.marginBottom, 10);\n  }\n  /** @override */\n  ;\n\n  _proto.contentHeightChanged = function contentHeightChanged() {} // Nothing to do here.\n\n  /** @override */\n  ;\n\n  _proto.getLayoutRect = function getLayoutRect(el, opt_scrollLeft, opt_scrollTop) {\n    var b = el.\n    /*OK*/\n    getBoundingClientRect();\n    var scrollTop = opt_scrollTop != undefined ? opt_scrollTop : this.getScrollTop();\n    var scrollLeft = opt_scrollLeft != undefined ? opt_scrollLeft : this.getScrollLeft();\n    return (0, _layoutRect.layoutRectLtwh)(Math.round(b.left + scrollLeft), Math.round(b.top + scrollTop), Math.round(b.width), Math.round(b.height));\n  }\n  /** @override */\n  ;\n\n  _proto.getRootClientRectAsync = function getRootClientRectAsync() {\n    return Promise.resolve(null);\n  }\n  /** @override */\n  ;\n\n  _proto.setScrollTop = function setScrollTop(scrollTop) {\n    this.getScrollingElement().\n    /*OK*/\n    scrollTop = scrollTop;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollingElement = function getScrollingElement() {\n    var doc = this.win.document;\n\n    if (doc.\n    /*OK*/\n    scrollingElement) {\n      return doc.\n      /*OK*/\n      scrollingElement;\n    }\n\n    if (doc.body && // Due to https://bugs.webkit.org/show_bug.cgi?id=106133, WebKit\n    // browsers have to use `body` and NOT `documentElement` for\n    // scrolling purposes. This has mostly being resolved via\n    // `scrollingElement` property, but this branch is still necessary\n    // for backward compatibility purposes.\n    this.platform_.isWebKit()) {\n      return doc.body;\n    }\n\n    return doc.documentElement;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollingElementScrollsLikeViewport = function getScrollingElementScrollsLikeViewport() {\n    return true;\n  };\n\n  return ViewportBindingNatural_;\n}();\n\nexports.ViewportBindingNatural_ = ViewportBindingNatural_;\n\n},{\"../../layout-rect\":65,\"../../log\":68,\"../../observable\":71,\"../../services\":123,\"../../style\":128,\"./viewport-binding-def\":116}],119:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.parseViewportMeta = parseViewportMeta;\nexports.stringifyViewportMeta = stringifyViewportMeta;\nexports.updateViewportMetaString = updateViewportMetaString;\nexports.installViewportServiceForDoc = installViewportServiceForDoc;\nexports.ViewportImpl = void 0;\n\nvar _animation = require(\"../../animation\");\n\nvar _fixedLayer = require(\"./../fixed-layer\");\n\nvar _observable = require(\"../../observable\");\n\nvar _services = require(\"../../services\");\n\nvar _viewportBindingDef = require(\"./viewport-binding-def\");\n\nvar _viewportBindingIosEmbedWrapper = require(\"./viewport-binding-ios-embed-wrapper\");\n\nvar _viewportBindingNatural = require(\"./viewport-binding-natural\");\n\nvar _viewportInterface = require(\"./viewport-interface\");\n\nvar _visibilityState = require(\"../../visibility-state\");\n\nvar _math = require(\"../../utils/math\");\n\nvar _dom = require(\"../../dom\");\n\nvar _style = require(\"../../style\");\n\nvar _log = require(\"../../log\");\n\nvar _object = require(\"../../utils/object\");\n\nvar _iframeHelper = require(\"../../iframe-helper\");\n\nvar _mode = require(\"../../mode\");\n\nvar _service = require(\"../../service\");\n\nvar _experiments = require(\"../../experiments\");\n\nvar _layoutRect = require(\"../../layout-rect\");\n\nvar _transition = require(\"../../transition\");\n\nvar _promise = require(\"../../utils/promise\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TAG_ = 'Viewport';\n/**\n * This object represents the viewport. It tracks scroll position, resize\n * and other events and notifies interesting parties when viewport has changed\n * and how.\n *\n * @implements {ViewportInterface}\n */\n\nvar ViewportImpl =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!../ampdoc-impl.AmpDoc} ampdoc\n   * @param {!ViewportBindingDef} binding\n   * @param {!../viewer-interface.ViewerInterface} viewer\n   */\n  function ViewportImpl(ampdoc, binding, viewer) {\n    var _this = this;\n\n    var win = ampdoc.win;\n    /** @const {!../ampdoc-impl.AmpDoc} */\n\n    this.ampdoc = ampdoc;\n    /**\n     * Some viewport operations require the global document.\n     * @private @const {!Document}\n     */\n\n    this.globalDoc_ = this.ampdoc.win.document;\n    /** @const {!ViewportBindingDef} */\n\n    this.binding_ = binding;\n    /** @const {!../viewer-interface.ViewerInterface} */\n\n    this.viewer_ = viewer;\n    /**\n     * Used to cache the rect of the viewport.\n     * @private {?../../layout-rect.LayoutRectDef}\n     */\n\n    this.rect_ = null;\n    /**\n     * Used to cache the size of the viewport. Also used as last known size,\n     * so users should call getSize early on to get a value. The timing should\n     * be chosen to avoid extra style recalcs.\n     * @private {{width: number, height: number}|null}\n     */\n\n    this.size_ = null;\n    /** @private {?number} */\n\n    this.\n    /*OK*/\n    scrollTop_ = null;\n    /** @private {boolean} */\n\n    this.scrollAnimationFrameThrottled_ = false;\n    /** @private {?number} */\n\n    this.\n    /*OK*/\n    scrollLeft_ = null;\n    /** @private {number} */\n\n    this.paddingTop_ = Number(viewer.getParam('paddingTop') || 0);\n    /** @private {number} */\n\n    this.lastPaddingTop_ = 0;\n    /** @private {!../timer-impl.Timer} */\n\n    this.timer_ = _services.Services.timerFor(win);\n    /** @private {!../vsync-impl.Vsync} */\n\n    this.vsync_ = _services.Services.vsyncFor(win);\n    /** @private {boolean} */\n\n    this.scrollTracking_ = false;\n    /** @private {number} */\n\n    this.scrollCount_ = 0;\n    /** @private @const {!Observable<!./viewport-interface.ViewportChangedEventDef>} */\n\n    this.changeObservable_ = new _observable.Observable();\n    /** @private @const {!Observable} */\n\n    this.scrollObservable_ = new _observable.Observable();\n    /** @private @const {!Observable<!./viewport-interface.ViewportResizedEventDef>} */\n\n    this.resizeObservable_ = new _observable.Observable();\n    /** @private {?Element|undefined} */\n\n    this.viewportMeta_ = undefined;\n    /** @private {string|undefined} */\n\n    this.originalViewportMetaString_ = undefined;\n    /** @private @const {!FixedLayer} */\n\n    this.fixedLayer_ = new _fixedLayer.FixedLayer(ampdoc, this.vsync_, this.binding_.getBorderTop(), this.paddingTop_, this.binding_.requiresFixedLayerTransfer());\n    ampdoc.whenReady().then(function () {\n      return _this.fixedLayer_.setup();\n    });\n    this.viewer_.onMessage('viewport', this.updateOnViewportEvent_.bind(this));\n    this.viewer_.onMessage('scroll', this.viewerSetScrollTop_.bind(this));\n    this.viewer_.onMessage('disableScroll', this.disableScrollEventHandler_.bind(this));\n    this.binding_.updatePaddingTop(this.paddingTop_);\n    this.binding_.onScroll(this.scroll_.bind(this));\n    this.binding_.onResize(this.resize_.bind(this));\n    this.onScroll(this.sendScrollMessage_.bind(this));\n    /** @private {boolean} */\n\n    this.visible_ = false;\n    this.ampdoc.onVisibilityChanged(this.updateVisibility_.bind(this));\n    this.updateVisibility_(); // Top-level mode classes.\n\n    var globalDocElement = this.globalDoc_.documentElement;\n\n    if (ampdoc.isSingleDoc()) {\n      globalDocElement.classList.add('i-amphtml-singledoc');\n    }\n\n    if (viewer.isEmbedded()) {\n      globalDocElement.classList.add('i-amphtml-embedded');\n    } else {\n      globalDocElement.classList.add('i-amphtml-standalone');\n    }\n\n    if ((0, _dom.isIframed)(win)) {\n      globalDocElement.classList.add('i-amphtml-iframed');\n    }\n\n    if (viewer.getParam('webview') === '1') {\n      globalDocElement.classList.add('i-amphtml-webview');\n    } // To avoid browser restore scroll position when traverse history\n\n\n    if ((0, _dom.isIframed)(win) && 'scrollRestoration' in win.history) {\n      win.history.scrollRestoration = 'manual';\n    } // Override global scrollTo if requested.\n\n\n    if (this.binding_.overrideGlobalScrollTo()) {\n      try {\n        Object.defineProperty(win, 'scrollTo', {\n          value: function value(x, y) {\n            return _this.setScrollTop(y);\n          }\n        });\n        ['pageYOffset', 'scrollY'].forEach(function (prop) {\n          Object.defineProperty(win, prop, {\n            get: function get() {\n              return _this.getScrollTop();\n            }\n          });\n        });\n      } catch (e) {// Ignore errors.\n      }\n    }\n  }\n  /** @override */\n\n\n  var _proto = ViewportImpl.prototype;\n\n  _proto.dispose = function dispose() {\n    this.binding_.disconnect();\n  }\n  /** @override */\n  ;\n\n  _proto.ensureReadyForElements = function ensureReadyForElements() {\n    this.binding_.ensureReadyForElements();\n  }\n  /** @private */\n  ;\n\n  _proto.updateVisibility_ = function updateVisibility_() {\n    var visible = this.ampdoc.isVisible();\n\n    if (visible != this.visible_) {\n      this.visible_ = visible;\n\n      if (visible) {\n        this.binding_.connect();\n\n        if (this.size_) {\n          // If the size has already been intialized, check it again in case\n          // the size has changed between `disconnect` and `connect`.\n          this.resize_();\n        }\n      } else {\n        this.binding_.disconnect();\n      }\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.getPaddingTop = function getPaddingTop() {\n    return this.paddingTop_;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollTop = function getScrollTop() {\n    if (this.\n    /*OK*/\n    scrollTop_ == null) {\n      this.\n      /*OK*/\n      scrollTop_ = this.binding_.getScrollTop();\n    }\n\n    return this.\n    /*OK*/\n    scrollTop_;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollLeft = function getScrollLeft() {\n    if (this.\n    /*OK*/\n    scrollLeft_ == null) {\n      this.\n      /*OK*/\n      scrollLeft_ = this.binding_.getScrollLeft();\n    }\n\n    return this.\n    /*OK*/\n    scrollLeft_;\n  }\n  /** @override */\n  ;\n\n  _proto.setScrollTop = function setScrollTop(scrollPos) {\n    this.\n    /*OK*/\n    scrollTop_ = null;\n    this.binding_.setScrollTop(scrollPos);\n  }\n  /** @override */\n  ;\n\n  _proto.updatePaddingBottom = function updatePaddingBottom(paddingBottom) {\n    this.ampdoc.waitForBodyOpen().then(function (body) {\n      (0, _style.setStyle)(body, 'borderBottom', paddingBottom + \"px solid transparent\");\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.getSize = function getSize() {\n    if (this.size_) {\n      return this.size_;\n    }\n\n    this.size_ = this.binding_.getSize();\n\n    if (this.size_.width == 0 || this.size_.height == 0) {\n      // Only report when the visibility is \"visible\" or \"prerender\".\n      var visibilityState = this.ampdoc.getVisibilityState();\n\n      if (visibilityState == _visibilityState.VisibilityState.PRERENDER || visibilityState == _visibilityState.VisibilityState.VISIBLE) {\n        if (Math.random() < 0.01) {\n          (0, _log.dev)().error(TAG_, 'viewport has zero dimensions');\n        }\n      }\n    }\n\n    return this.size_;\n  }\n  /** @override */\n  ;\n\n  _proto.getHeight = function getHeight() {\n    return this.getSize().height;\n  }\n  /** @override */\n  ;\n\n  _proto.getWidth = function getWidth() {\n    return this.getSize().width;\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollWidth = function getScrollWidth() {\n    return this.binding_.getScrollWidth();\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollHeight = function getScrollHeight() {\n    return this.binding_.getScrollHeight();\n  }\n  /** @override */\n  ;\n\n  _proto.getContentHeight = function getContentHeight() {\n    return this.binding_.getContentHeight();\n  }\n  /** @override */\n  ;\n\n  _proto.contentHeightChanged = function contentHeightChanged() {\n    this.binding_.contentHeightChanged();\n  }\n  /** @override */\n  ;\n\n  _proto.getRect = function getRect() {\n    if (this.rect_ == null) {\n      var scrollTop = this.getScrollTop();\n      var scrollLeft = this.getScrollLeft();\n      var size = this.getSize();\n      this.rect_ = (0, _layoutRect.layoutRectLtwh)(scrollLeft, scrollTop, size.width, size.height);\n    }\n\n    return this.rect_;\n  }\n  /** @override */\n  ;\n\n  _proto.getLayoutRect = function getLayoutRect(el) {\n    var scrollLeft = this.getScrollLeft();\n    var scrollTop = this.getScrollTop(); // Go up the window hierarchy through friendly iframes.\n\n    var frameElement = (0, _service.getParentWindowFrameElement)(el, this.ampdoc.win);\n\n    if (frameElement) {\n      var b = this.binding_.getLayoutRect(el, 0, 0);\n      var c = this.binding_.getLayoutRect(frameElement, scrollLeft, scrollTop);\n      return (0, _layoutRect.layoutRectLtwh)(Math.round(b.left + c.left), Math.round(b.top + c.top), Math.round(b.width), Math.round(b.height));\n    }\n\n    return this.binding_.getLayoutRect(el, scrollLeft, scrollTop);\n  }\n  /** @override */\n  ;\n\n  _proto.getClientRectAsync = function getClientRectAsync(el) {\n    var local = this.vsync_.measurePromise(function () {\n      return el.\n      /*OK*/\n      getBoundingClientRect();\n    });\n    var root = this.binding_.getRootClientRectAsync();\n    var frameElement = (0, _service.getParentWindowFrameElement)(el, this.ampdoc.win);\n\n    if (frameElement) {\n      root = this.vsync_.measurePromise(function () {\n        return frameElement.\n        /*OK*/\n        getBoundingClientRect();\n      });\n    }\n\n    return Promise.all([local, root]).then(function (values) {\n      var l = values[0];\n      var r = values[1];\n\n      if (!r) {\n        return (0, _layoutRect.layoutRectFromDomRect)(l);\n      }\n\n      return (0, _layoutRect.moveLayoutRect)(l, r.left, r.top);\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.supportsPositionFixed = function supportsPositionFixed() {\n    return this.binding_.supportsPositionFixed();\n  }\n  /** @override */\n  ;\n\n  _proto.isDeclaredFixed = function isDeclaredFixed(element) {\n    return this.fixedLayer_.isDeclaredFixed(element);\n  }\n  /** @override */\n  ;\n\n  _proto.scrollIntoView = function scrollIntoView(element) {\n    var _this2 = this;\n\n    return this.getScrollingContainerFor_(element).then(function (parent) {\n      return _this2.scrollIntoViewInternal_(element, parent);\n    });\n  }\n  /**\n   * @param {!Element} element\n   * @param {!Element} parent\n   */\n  ;\n\n  _proto.scrollIntoViewInternal_ = function scrollIntoViewInternal_(element, parent) {\n    var _this3 = this;\n\n    var elementTop = this.binding_.getLayoutRect(element).top;\n    var newScrollTopPromise = (0, _promise.tryResolve)(function () {\n      return Math.max(0, elementTop - _this3.paddingTop_);\n    });\n    newScrollTopPromise.then(function (newScrollTop) {\n      return _this3.setElementScrollTop_(parent, newScrollTop);\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.animateScrollIntoView = function animateScrollIntoView(element, pos, opt_duration, opt_curve) {\n    var _this4 = this;\n\n    if (pos === void 0) {\n      pos = 'top';\n    }\n\n    (0, _log.devAssert)(!opt_curve || opt_duration !== undefined, \"Curve without duration doesn't make sense.\");\n    return this.getScrollingContainerFor_(element).then(function (parent) {\n      return _this4.animateScrollWithinParent(element, parent, (0, _log.dev)().assertString(pos), opt_duration, opt_curve);\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.animateScrollWithinParent = function animateScrollWithinParent(element, parent, pos, opt_duration, opt_curve) {\n    var _this5 = this;\n\n    (0, _log.devAssert)(!opt_curve || opt_duration !== undefined, \"Curve without duration doesn't make sense.\");\n    var elementRect = this.binding_.getLayoutRect(element);\n\n    var _ref = this.isScrollingElement_(parent) ? this.getSize() : this.getLayoutRect(parent),\n        parentHeight = _ref.height;\n\n    var offset;\n\n    switch (pos) {\n      case 'bottom':\n        offset = -parentHeight + elementRect.height;\n        break;\n\n      case 'center':\n        offset = -parentHeight / 2 + elementRect.height / 2;\n        break;\n\n      default:\n        offset = 0;\n        break;\n    }\n\n    return this.getElementScrollTop_(parent).then(function (curScrollTop) {\n      var calculatedScrollTop = elementRect.top - _this5.paddingTop_ + offset;\n      var newScrollTop = Math.max(0, calculatedScrollTop);\n\n      if (newScrollTop == curScrollTop) {\n        return;\n      }\n\n      return _this5.interpolateScrollIntoView_(parent, curScrollTop, newScrollTop, opt_duration, opt_curve);\n    });\n  }\n  /**\n   * @param {!Element} parent\n   * @param {number} curScrollTop\n   * @param {number} newScrollTop\n   * @param {number=} opt_duration\n   * @param {string=} curve\n   * @private\n   */\n  ;\n\n  _proto.interpolateScrollIntoView_ = function interpolateScrollIntoView_(parent, curScrollTop, newScrollTop, opt_duration, curve) {\n    var _this6 = this;\n\n    if (curve === void 0) {\n      curve = 'ease-in';\n    }\n\n    var duration = opt_duration !== undefined ? (0, _log.dev)().assertNumber(opt_duration) : getDefaultScrollAnimationDuration(curScrollTop, newScrollTop);\n    /** @const {!TransitionDef<number>} */\n\n    var interpolate = (0, _transition.numeric)(curScrollTop, newScrollTop);\n    return _animation.Animation.animate(parent, function (position) {\n      _this6.setElementScrollTop_(parent, interpolate(position));\n    }, duration, curve).thenAlways(function () {\n      _this6.setElementScrollTop_(parent, newScrollTop);\n    });\n  }\n  /**\n   * @param {!Element} element\n   * @return {!Promise<!Element>}\n   */\n  ;\n\n  _proto.getScrollingContainerFor_ = function getScrollingContainerFor_(element) {\n    var _this7 = this;\n\n    return this.vsync_.measurePromise(function () {\n      return (0, _dom.closestAncestorElementBySelector)(element, '.i-amphtml-scrollable') || _this7.binding_.getScrollingElement();\n    });\n  }\n  /**\n   * @param {!Element} element\n   * @param {number} scrollTop\n   */\n  ;\n\n  _proto.setElementScrollTop_ = function setElementScrollTop_(element, scrollTop) {\n    if (this.isScrollingElement_(element)) {\n      this.binding_.setScrollTop(scrollTop);\n      return;\n    }\n\n    this.vsync_.mutate(function () {\n      element.\n      /*OK*/\n      scrollTop = scrollTop;\n    });\n  }\n  /**\n   * @param {!Element} element\n   * @return {!Promise<number>}\n   */\n  ;\n\n  _proto.getElementScrollTop_ = function getElementScrollTop_(element) {\n    var _this8 = this;\n\n    if (this.isScrollingElement_(element)) {\n      return (0, _promise.tryResolve)(function () {\n        return _this8.getScrollTop();\n      });\n    }\n\n    return this.vsync_.measurePromise(function () {\n      return element.\n      /*OK*/\n      scrollTop;\n    });\n  }\n  /**\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isScrollingElement_ = function isScrollingElement_(element) {\n    return element == this.binding_.getScrollingElement();\n  }\n  /** @override */\n  ;\n\n  _proto.getScrollingElement = function getScrollingElement() {\n    return this.binding_.getScrollingElement();\n  }\n  /** @override */\n  ;\n\n  _proto.onChanged = function onChanged(handler) {\n    return this.changeObservable_.add(handler);\n  }\n  /** @override */\n  ;\n\n  _proto.onScroll = function onScroll(handler) {\n    return this.scrollObservable_.add(handler);\n  }\n  /** @override */\n  ;\n\n  _proto.onResize = function onResize(handler) {\n    return this.resizeObservable_.add(handler);\n  }\n  /** @override */\n  ;\n\n  _proto.enterLightboxMode = function enterLightboxMode(opt_requestingElement, opt_onComplete) {\n    this.viewer_.sendMessage('requestFullOverlay', (0, _object.dict)(),\n    /* cancelUnsent */\n    true);\n    this.enterOverlayMode();\n    this.fixedLayer_.enterLightbox(opt_requestingElement, opt_onComplete);\n\n    if (opt_requestingElement) {\n      this.maybeEnterFieLightboxMode((0, _log.dev)().assertElement(opt_requestingElement));\n    }\n\n    return this.binding_.updateLightboxMode(true);\n  }\n  /** @override */\n  ;\n\n  _proto.leaveLightboxMode = function leaveLightboxMode(opt_requestingElement) {\n    this.viewer_.sendMessage('cancelFullOverlay', (0, _object.dict)(),\n    /* cancelUnsent */\n    true);\n    this.fixedLayer_.leaveLightbox();\n    this.leaveOverlayMode();\n\n    if (opt_requestingElement) {\n      this.maybeLeaveFieLightboxMode((0, _log.dev)().assertElement(opt_requestingElement));\n    }\n\n    return this.binding_.updateLightboxMode(false);\n  }\n  /**\n   * @return {boolean}\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.isLightboxExperimentOn = function isLightboxExperimentOn() {\n    return (0, _experiments.isExperimentOn)(this.ampdoc.win, 'amp-lightbox-a4a-proto');\n  }\n  /**\n   * Enters frame lightbox mode if under a Friendly Iframe Embed.\n   * @param {!Element} requestingElement\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.maybeEnterFieLightboxMode = function maybeEnterFieLightboxMode(requestingElement) {\n    var fieOptional = this.getFriendlyIframeEmbed_(requestingElement);\n\n    if (fieOptional) {\n      (0, _log.devAssert)(this.isLightboxExperimentOn(), 'Lightbox mode for A4A is only available when ' + \"'amp-lightbox-a4a-proto' experiment is on\");\n      fieOptional.enterFullOverlayMode();\n    }\n  }\n  /**\n   * Leaves frame lightbox mode if under a Friendly Iframe Embed.\n   * @param {!Element} requestingElement\n   * @visibleForTesting\n   */\n  ;\n\n  _proto.maybeLeaveFieLightboxMode = function maybeLeaveFieLightboxMode(requestingElement) {\n    var fieOptional = this.getFriendlyIframeEmbed_(requestingElement);\n\n    if (fieOptional) {\n      (0, _log.devAssert)(fieOptional).leaveFullOverlayMode();\n    }\n  }\n  /**\n   * Get FriendlyIframeEmbed if available.\n   * @param {!Element} element Element supposedly inside the FIE.\n   * @return {?../../friendly-iframe-embed.FriendlyIframeEmbed}\n   * @private\n   */\n  ;\n\n  _proto.getFriendlyIframeEmbed_ = function getFriendlyIframeEmbed_(element) {\n    var iframeOptional = (0, _service.getParentWindowFrameElement)(element, this.ampdoc.win);\n    return iframeOptional && (0, _iframeHelper.getFriendlyIframeEmbedOptional)(\n    /** @type {!HTMLIFrameElement} */\n    (0, _log.dev)().assertElement(iframeOptional));\n  }\n  /** @override */\n  ;\n\n  _proto.enterOverlayMode = function enterOverlayMode() {\n    this.disableTouchZoom();\n    this.disableScroll();\n  }\n  /** @override */\n  ;\n\n  _proto.leaveOverlayMode = function leaveOverlayMode() {\n    this.resetScroll();\n    this.restoreOriginalTouchZoom();\n  }\n  /** @override */\n  ;\n\n  _proto.disableScroll = function disableScroll() {\n    var _this9 = this;\n\n    var win = this.ampdoc.win;\n    var documentElement = win.document.documentElement;\n    var requestedMarginRight; // Calculate the scrollbar width so we can set it as a right margin. This\n    // is so that we do not cause content to shift when we disable scroll on\n    // platforms that have a width-taking scrollbar.\n\n    this.vsync_.measure(function () {\n      var existingMargin = (0, _style.computedStyle)(win, documentElement).marginRight;\n      var scrollbarWidth = (0, _dom.getVerticalScrollbarWidth)(_this9.ampdoc.win);\n      requestedMarginRight = parseInt(existingMargin, 10) + scrollbarWidth;\n    });\n    this.vsync_.mutate(function () {\n      (0, _style.setStyle)(documentElement, 'margin-right', requestedMarginRight, 'px');\n\n      _this9.binding_.disableScroll();\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.resetScroll = function resetScroll() {\n    var _this10 = this;\n\n    var win = this.ampdoc.win;\n    var documentElement = win.document.documentElement;\n    this.vsync_.mutate(function () {\n      (0, _style.setStyle)(documentElement, 'margin-right', '');\n\n      _this10.binding_.resetScroll();\n    });\n  }\n  /** @override */\n  ;\n\n  _proto.resetTouchZoom = function resetTouchZoom() {\n    var _this11 = this;\n\n    var windowHeight = this.ampdoc.win.\n    /*OK*/\n    innerHeight;\n    var documentHeight = this.globalDoc_.documentElement.\n    /*OK*/\n    clientHeight;\n\n    if (windowHeight && documentHeight && windowHeight === documentHeight) {\n      // This code only works when scrollbar overlay content and take no space,\n      // which is fine on mobile. For non-mobile devices this code is\n      // irrelevant.\n      return;\n    }\n\n    if (this.disableTouchZoom()) {\n      this.timer_.delay(function () {\n        _this11.restoreOriginalTouchZoom();\n      }, 50);\n    }\n  }\n  /** @override */\n  ;\n\n  _proto.disableTouchZoom = function disableTouchZoom() {\n    var viewportMeta = this.getViewportMeta_();\n\n    if (!viewportMeta) {\n      // This should never happen in a valid AMP document, thus shortcircuit.\n      return false;\n    } // Setting maximum-scale=1 and user-scalable=no zooms page back to normal\n    // and prohibit further default zooming.\n\n\n    var newValue = updateViewportMetaString(viewportMeta.content, {\n      'maximum-scale': '1',\n      'user-scalable': 'no'\n    });\n    return this.setViewportMetaString_(newValue);\n  }\n  /** @override */\n  ;\n\n  _proto.restoreOriginalTouchZoom = function restoreOriginalTouchZoom() {\n    if (this.originalViewportMetaString_ !== undefined) {\n      return this.setViewportMetaString_(this.originalViewportMetaString_);\n    }\n\n    return false;\n  }\n  /** @override */\n  ;\n\n  _proto.updateFixedLayer = function updateFixedLayer() {\n    this.fixedLayer_.update();\n  }\n  /** @override */\n  ;\n\n  _proto.addToFixedLayer = function addToFixedLayer(element, opt_forceTransfer) {\n    return this.fixedLayer_.addElement(element, opt_forceTransfer);\n  }\n  /** @override */\n  ;\n\n  _proto.removeFromFixedLayer = function removeFromFixedLayer(element) {\n    this.fixedLayer_.removeElement(element);\n  }\n  /**\n   * Updates touch zoom meta data. Returns `true` if any actual\n   * changes have been done.\n   * @param {string} viewportMetaString\n   * @return {boolean}\n   */\n  ;\n\n  _proto.setViewportMetaString_ = function setViewportMetaString_(viewportMetaString) {\n    var viewportMeta = this.getViewportMeta_();\n\n    if (viewportMeta && viewportMeta.content != viewportMetaString) {\n      (0, _log.dev)().fine(TAG_, 'changed viewport meta to:', viewportMetaString);\n      viewportMeta.content = viewportMetaString;\n      return true;\n    }\n\n    return false;\n  }\n  /**\n   * @return {?Element}\n   * @private\n   */\n  ;\n\n  _proto.getViewportMeta_ = function getViewportMeta_() {\n    if ((0, _dom.isIframed)(this.ampdoc.win)) {\n      // An embedded document does not control its viewport meta tag.\n      return null;\n    }\n\n    if (this.viewportMeta_ === undefined) {\n      this.viewportMeta_ =\n      /** @type {?HTMLMetaElement} */\n      this.globalDoc_.querySelector('meta[name=viewport]');\n\n      if (this.viewportMeta_) {\n        this.originalViewportMetaString_ = this.viewportMeta_.content;\n      }\n    }\n\n    return this.viewportMeta_;\n  }\n  /**\n   * @param {!JsonObject} data\n   * @private\n   */\n  ;\n\n  _proto.viewerSetScrollTop_ = function viewerSetScrollTop_(data) {\n    var targetScrollTop = data['scrollTop'];\n    this.setScrollTop(targetScrollTop);\n  }\n  /**\n   * @param {!JsonObject} data\n   * @private\n   */\n  ;\n\n  _proto.updateOnViewportEvent_ = function updateOnViewportEvent_(data) {\n    var _this12 = this;\n\n    var paddingTop = data['paddingTop'];\n    var duration = data['duration'] || 0;\n    var curve = data['curve'];\n    /** @const {boolean} */\n\n    var transient = data['transient'];\n\n    if (paddingTop == undefined || paddingTop == this.paddingTop_) {\n      return;\n    }\n\n    this.lastPaddingTop_ = this.paddingTop_;\n    this.paddingTop_ = paddingTop;\n    var animPromise = this.animateFixedElements_(duration, curve, transient);\n\n    if (paddingTop < this.lastPaddingTop_) {\n      this.binding_.hideViewerHeader(transient, this.lastPaddingTop_);\n      return;\n    }\n\n    animPromise.then(function () {\n      _this12.binding_.showViewerHeader(transient, paddingTop);\n    });\n  }\n  /**\n   * @param {!JsonObject} data\n   * @private\n   */\n  ;\n\n  _proto.disableScrollEventHandler_ = function disableScrollEventHandler_(data) {\n    if (!!data) {\n      this.disableScroll();\n    } else {\n      this.resetScroll();\n    }\n  }\n  /**\n   * @param {number} duration\n   * @param {string} curve\n   * @param {boolean} transient\n   * @return {!Promise}\n   * @private\n   */\n  ;\n\n  _proto.animateFixedElements_ = function animateFixedElements_(duration, curve, transient) {\n    var _this13 = this;\n\n    this.fixedLayer_.updatePaddingTop(this.paddingTop_, transient);\n\n    if (duration <= 0) {\n      return Promise.resolve();\n    } // Add transit effect on position fixed element\n\n\n    var tr = (0, _transition.numeric)(this.lastPaddingTop_ - this.paddingTop_, 0);\n    return _animation.Animation.animate(this.ampdoc.getRootNode(), function (time) {\n      var p = tr(time);\n\n      _this13.fixedLayer_.transformMutate(\"translateY(\" + p + \"px)\");\n    }, duration, curve).thenAlways(function () {\n      _this13.fixedLayer_.transformMutate(null);\n    });\n  }\n  /**\n   * @param {boolean} relayoutAll\n   * @param {number} velocity\n   * @private\n   */\n  ;\n\n  _proto.changed_ = function changed_(relayoutAll, velocity) {\n    var size = this.getSize();\n    var scrollTop = this.getScrollTop();\n    var scrollLeft = this.getScrollLeft();\n    (0, _log.dev)().fine(TAG_, 'changed event:', 'relayoutAll=', relayoutAll, 'top=', scrollTop, 'left=', scrollLeft, 'bottom=', scrollTop + size.height, 'velocity=', velocity);\n    this.changeObservable_.fire({\n      relayoutAll: relayoutAll,\n      top: scrollTop,\n      left: scrollLeft,\n      width: size.width,\n      height: size.height,\n      velocity: velocity\n    });\n  }\n  /** @private */\n  ;\n\n  _proto.scroll_ = function scroll_() {\n    var _this14 = this;\n\n    this.rect_ = null;\n    this.scrollCount_++;\n    this.scrollLeft_ = this.binding_.getScrollLeft();\n    var newScrollTop = this.binding_.getScrollTop();\n\n    if (newScrollTop < 0) {\n      // iOS and some other browsers use negative values of scrollTop for\n      // overscroll. Overscroll does not affect the viewport and thus should\n      // be ignored here.\n      return;\n    }\n\n    this.scrollTop_ = newScrollTop;\n\n    if (!this.scrollTracking_) {\n      this.scrollTracking_ = true;\n      var now = Date.now(); // Wait 2 frames and then request an animation frame.\n\n      this.timer_.delay(function () {\n        _this14.vsync_.measure(function () {\n          _this14.throttledScroll_(now, newScrollTop);\n        });\n      }, 36);\n    }\n\n    this.scrollObservable_.fire();\n  }\n  /**\n   * This method is called about every 3 frames (assuming 60hz) and it\n   * is called in a vsync measure task.\n   * @param {number} referenceTime Time when the scroll measurement, that\n   *     triggered this call made, was made.\n   * @param {number} referenceTop Scrolltop at that time.\n   * @private\n   */\n  ;\n\n  _proto.throttledScroll_ = function throttledScroll_(referenceTime, referenceTop) {\n    var _this15 = this;\n\n    this.scrollTop_ = this.binding_.getScrollTop();\n    /**  @const {number} */\n\n    var newScrollTop = this.scrollTop_;\n    var now = Date.now();\n    var velocity = 0;\n\n    if (now != referenceTime) {\n      velocity = (newScrollTop - referenceTop) / (now - referenceTime);\n    }\n\n    (0, _log.dev)().fine(TAG_, 'scroll: scrollTop=' + newScrollTop + '; velocity=' + velocity);\n\n    if (Math.abs(velocity) < 0.03) {\n      this.changed_(\n      /* relayoutAll */\n      false, velocity);\n      this.scrollTracking_ = false;\n    } else {\n      this.timer_.delay(function () {\n        return _this15.vsync_.measure(_this15.throttledScroll_.bind(_this15, now, newScrollTop));\n      }, 20);\n    }\n  }\n  /**\n   * Send scroll message via the viewer per animation frame\n   * @private\n   */\n  ;\n\n  _proto.sendScrollMessage_ = function sendScrollMessage_() {\n    var _this16 = this;\n\n    if (!this.scrollAnimationFrameThrottled_) {\n      this.scrollAnimationFrameThrottled_ = true;\n      this.vsync_.measure(function () {\n        _this16.scrollAnimationFrameThrottled_ = false;\n\n        _this16.viewer_.sendMessage('scroll', (0, _object.dict)({\n          'scrollTop': _this16.getScrollTop()\n        }),\n        /* cancelUnsent */\n        true);\n      });\n    }\n  }\n  /** @private */\n  ;\n\n  _proto.resize_ = function resize_() {\n    var _this17 = this;\n\n    this.rect_ = null;\n    var oldSize = this.size_;\n    this.size_ = null; // Need to recalc.\n\n    var newSize = this.getSize();\n    this.fixedLayer_.update().then(function () {\n      var widthChanged = !oldSize || oldSize.width != newSize.width;\n\n      _this17.changed_(\n      /*relayoutAll*/\n      widthChanged, 0);\n\n      var sizeChanged = widthChanged || oldSize.height != newSize.height;\n\n      if (sizeChanged) {\n        _this17.resizeObservable_.fire({\n          relayoutAll: widthChanged,\n          width: newSize.width,\n          height: newSize.height\n        });\n      }\n    });\n  };\n\n  return ViewportImpl;\n}();\n/**\n * Parses viewport meta value. It usually looks like:\n * ```\n * width=device-width,initial-scale=1,minimum-scale=1\n * ```\n * @param {string} content\n * @return {!Object<string, (string|undefined)>}\n * @private Visible for testing only.\n */\n\n\nexports.ViewportImpl = ViewportImpl;\n\nfunction parseViewportMeta(content) {\n  // Ex: width=device-width,initial-scale=1,minimal-ui\n  var params = Object.create(null);\n\n  if (!content) {\n    return params;\n  }\n\n  var pairs = content.split(/,|;/);\n\n  for (var i = 0; i < pairs.length; i++) {\n    var pair = pairs[i];\n    var split = pair.split('=');\n    var name = split[0].trim();\n    var value = split[1];\n    value = (value || '').trim();\n\n    if (name) {\n      params[name] = value;\n    }\n  }\n\n  return params;\n}\n/**\n * Stringifies viewport meta value based on the provided map. It usually looks\n * like:\n * ```\n * width=device-width,initial-scale=1,minimum-scale=1\n * ```\n * @param {!Object<string, string>} params\n * @return {string}\n * @private Visible for testing only.\n */\n\n\nfunction stringifyViewportMeta(params) {\n  // Ex: width=device-width,initial-scale=1,minimal-ui\n  var content = '';\n\n  for (var k in params) {\n    if (content.length > 0) {\n      content += ',';\n    }\n\n    if (params[k]) {\n      content += k + '=' + params[k];\n    } else {\n      content += k;\n    }\n  }\n\n  return content;\n}\n/**\n * This method makes a minimal effort to keep the original viewport string\n * unchanged if in fact none of the values have been updated. Returns the\n * updated string or the `currentValue` if no changes were necessary.\n *\n * @param {string} currentValue\n * @param {!Object<string, string|undefined>} updateParams\n * @return {string}\n * @private Visible for testing only.\n */\n\n\nfunction updateViewportMetaString(currentValue, updateParams) {\n  var params = parseViewportMeta(currentValue);\n  var changed = false;\n\n  for (var k in updateParams) {\n    if (params[k] !== updateParams[k]) {\n      changed = true;\n\n      if (updateParams[k] !== undefined) {\n        params[k] =\n        /** @type {string} */\n        updateParams[k];\n      } else {\n        delete params[k];\n      }\n    }\n  }\n\n  if (!changed) {\n    return currentValue;\n  }\n\n  return stringifyViewportMeta(params);\n}\n/**\n * Calculates a default duration for a scrollTop animation.\n * @param {number} scrollTopA commutative with b.\n * @param {number} scrollTopB commutative with a.\n * @param {number=} max in ms. default 500ms.\n * @return {number}\n */\n\n\nfunction getDefaultScrollAnimationDuration(scrollTopA, scrollTopB, max) {\n  if (max === void 0) {\n    max = 500;\n  }\n\n  // 65% of scroll  to ms, eg 1000px -> 650ms, integer between 0 and max\n  return Math.floor((0, _math.clamp)(0.65 * Math.abs(scrollTopA - scrollTopB), 0, max));\n}\n/**\n * @param {!../ampdoc-impl.AmpDoc} ampdoc\n * @return {!ViewportImpl}\n * @private\n */\n\n\nfunction createViewport(ampdoc) {\n  var viewer = _services.Services.viewerForDoc(ampdoc);\n\n  var win = ampdoc.win;\n  var binding;\n\n  if (ampdoc.isSingleDoc() && getViewportType(win, viewer) == ViewportType.NATURAL_IOS_EMBED) {\n    binding = new _viewportBindingIosEmbedWrapper.ViewportBindingIosEmbedWrapper_(win);\n  } else {\n    binding = new _viewportBindingNatural.ViewportBindingNatural_(ampdoc);\n  }\n\n  return new ViewportImpl(ampdoc, binding, viewer);\n}\n/**\n * The type of the viewport.\n * @enum {string}\n */\n\n\nvar ViewportType = {\n  /**\n   * Viewer leaves sizing and scrolling up to the AMP document's window.\n   */\n  NATURAL: 'natural',\n\n  /**\n   * This is AMP-specific type and doesn't come from viewer. This is the type\n   * that AMP sets when Viewer has requested \"natural\" viewport on a iOS\n   * device.\n   * See:\n   * https://github.com/ampproject/amphtml/blob/master/spec/amp-html-layout.md\n   */\n  NATURAL_IOS_EMBED: 'natural-ios-embed'\n};\n/**\n * @param {!Window} win\n * @param {!../viewer-interface.ViewerInterface} viewer\n * @return {string}\n */\n\nfunction getViewportType(win, viewer) {\n  var viewportType = viewer.getParam('viewportType') || ViewportType.NATURAL;\n\n  if (!_services.Services.platformFor(win).isIos() || viewportType != ViewportType.NATURAL) {\n    return viewportType;\n  }\n\n  var isIosIframeScrollableOn = (0, _experiments.isExperimentOn)(win, 'ios-scrollable-iframe'); // Enable iOS Embedded mode so that it's easy to test against a more\n  // realistic iOS environment w/o an iframe.\n\n  if (!(0, _dom.isIframed)(win) && ((0, _mode.getMode)(win).localDev || (0, _mode.getMode)(win).development) && !isIosIframeScrollableOn) {\n    return ViewportType.NATURAL_IOS_EMBED;\n  } // Enable iOS Embedded mode for iframed tests (e.g. integration tests).\n\n\n  if ((0, _dom.isIframed)(win) && (0, _mode.getMode)(win).test) {\n    return ViewportType.NATURAL_IOS_EMBED;\n  } // Override to ios-embed for iframe-viewer mode.\n\n\n  if ((0, _dom.isIframed)(win) && viewer.isEmbedded() && !isIosIframeScrollableOn) {\n    return ViewportType.NATURAL_IOS_EMBED;\n  }\n\n  return viewportType;\n}\n/**\n * @param {!../ampdoc-impl.AmpDoc} ampdoc\n */\n\n\nfunction installViewportServiceForDoc(ampdoc) {\n  (0, _service.registerServiceBuilderForDoc)(ampdoc, 'viewport', createViewport,\n  /* opt_instantiate */\n  true);\n}\n\n},{\"../../animation\":28,\"../../dom\":41,\"../../experiments\":47,\"../../iframe-helper\":57,\"../../layout-rect\":65,\"../../log\":68,\"../../mode\":70,\"../../observable\":71,\"../../service\":79,\"../../services\":123,\"../../style\":128,\"../../transition\":130,\"../../utils/math\":144,\"../../utils/object\":145,\"../../utils/promise\":147,\"../../visibility-state\":151,\"./../fixed-layer\":91,\"./viewport-binding-def\":116,\"./viewport-binding-ios-embed-wrapper\":117,\"./viewport-binding-natural\":118,\"./viewport-interface\":120}],120:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.ViewportInterface = exports.ViewportResizedEventDef = exports.ViewportChangedEventDef = void 0;\n\nvar _service = require(\"../../service\");\n\nfunction _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; subClass.__proto__ = superClass; }\n\n/**\n * @typedef {{\n *   relayoutAll: boolean,\n *   top: number,\n *   left: number,\n *   width: number,\n *   height: number,\n *   velocity: number\n * }}\n */\nvar ViewportChangedEventDef;\n/**\n * @typedef {{\n *   relayoutAll: boolean,\n *   width: number,\n *   height: number\n * }}\n */\n\nexports.ViewportChangedEventDef = ViewportChangedEventDef;\nvar ViewportResizedEventDef;\n/* eslint-disable no-unused-vars */\n\n/**\n * @interface\n */\n\nexports.ViewportResizedEventDef = ViewportResizedEventDef;\n\nvar ViewportInterface =\n/*#__PURE__*/\nfunction (_Disposable) {\n  _inheritsLoose(ViewportInterface, _Disposable);\n\n  function ViewportInterface() {\n    return _Disposable.apply(this, arguments) || this;\n  }\n\n  var _proto = ViewportInterface.prototype;\n\n  /**\n   * Called before a first AMP element is added to resources. Called in the\n   * mutate context.\n   */\n  _proto.ensureReadyForElements = function ensureReadyForElements() {}\n  /**\n   * Returns the top padding mandated by the viewer.\n   * @return {number}\n   */\n  ;\n\n  _proto.getPaddingTop = function getPaddingTop() {}\n  /**\n   * Returns the viewport's vertical scroll position.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollTop = function getScrollTop() {}\n  /**\n   * Returns the viewport's horizontal scroll position.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollLeft = function getScrollLeft() {}\n  /**\n   * Sets the desired scroll position on the viewport.\n   * @param {number} scrollPos\n   */\n  ;\n\n  _proto.setScrollTop = function setScrollTop(scrollPos) {}\n  /**\n   * Sets the body padding bottom to the specified value.\n   * @param {number} paddingBottom\n   */\n  ;\n\n  _proto.updatePaddingBottom = function updatePaddingBottom(paddingBottom) {}\n  /**\n   * Returns the size of the viewport.\n   * @return {!{width: number, height: number}}\n   */\n  ;\n\n  _proto.getSize = function getSize() {}\n  /**\n   * Returns the height of the viewport.\n   * @return {number}\n   */\n  ;\n\n  _proto.getHeight = function getHeight() {}\n  /**\n   * Returns the width of the viewport.\n   * @return {number}\n   */\n  ;\n\n  _proto.getWidth = function getWidth() {}\n  /**\n   * Returns the scroll width of the content of the document. Note that this\n   * method is not cached since we there's no indication when it might change.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollWidth = function getScrollWidth() {}\n  /**\n   * Returns the scroll height of the content of the document, including the\n   * padding top for the viewer header.\n   * The scrollHeight will be the viewport height if there's not enough content\n   * to fill up the viewport.\n   * Note that this method is not cached since we there's no indication when\n   * it might change.\n   * @return {number}\n   */\n  ;\n\n  _proto.getScrollHeight = function getScrollHeight() {}\n  /**\n   * Returns the height of the content of the document, including the\n   * padding top for the viewer header.\n   * contentHeight will match scrollHeight in all cases unless the viewport is\n   * taller than the content.\n   * Note that this method is not cached since we there's no indication when\n   * it might change.\n   * @return {number}\n   */\n  ;\n\n  _proto.getContentHeight = function getContentHeight() {}\n  /**\n   * Resource manager signals to the viewport that content height is changed\n   * and some action may need to be taken.\n   * @restricted Use is restricted due to potentially very heavy performance\n   *   impact. Can only be called when not actively scrolling.\n   */\n  ;\n\n  _proto.contentHeightChanged = function contentHeightChanged() {}\n  /**\n   * Returns the rect of the viewport which includes scroll positions and size.\n   * @return {!../../layout-rect.LayoutRectDef}}\n   */\n  ;\n\n  _proto.getRect = function getRect() {}\n  /**\n   * Returns the rect of the element within the document.\n   * Note that this function should be called in vsync measure. Please consider\n   * using `getLayoutRectAsync` instead.\n   * @param {!Element} el\n   * @return {!../../layout-rect.LayoutRectDef}\n   */\n  ;\n\n  _proto.getLayoutRect = function getLayoutRect(el) {}\n  /**\n   * Returns the clientRect of the element.\n   * Note: This method does not taking intersection into account.\n   * @param {!Element} el\n   * @return {!Promise<!../../layout-rect.LayoutRectDef>}\n   */\n  ;\n\n  _proto.getClientRectAsync = function getClientRectAsync(el) {}\n  /**\n   * Whether the binding supports fix-positioned elements.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.supportsPositionFixed = function supportsPositionFixed() {}\n  /**\n   * Whether the element is declared as fixed in any of the user's stylesheets.\n   * Will include any matches, not necessarily currently fixed elements.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  ;\n\n  _proto.isDeclaredFixed = function isDeclaredFixed(element) {}\n  /**\n   * Scrolls element into view much like Element. scrollIntoView does but\n   * in the AMP/Viewer environment.\n   * @param {!Element} element\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.scrollIntoView = function scrollIntoView(element) {}\n  /**\n   * Scrolls element into view much like Element. scrollIntoView does but\n   * in the AMP/Viewer environment. Adds animation for the sccrollIntoView\n   * transition.\n   *\n   * @param {!Element} element\n   * @param {string=} pos (takes one of 'top', 'bottom', 'center')\n   * @param {number=} opt_duration\n   * @param {string=} opt_curve\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.animateScrollIntoView = function animateScrollIntoView(element, pos, opt_duration, opt_curve) {\n    if (pos === void 0) {\n      pos = 'top';\n    }\n  }\n  /**\n   * @param {!Element} element\n   * @param {!Element} parent Should be scrollable.\n   * @param {string} pos (takes one of 'top', 'bottom', 'center')\n   * @param {number=} opt_duration\n   * @param {string=} opt_curve\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.animateScrollWithinParent = function animateScrollWithinParent(element, parent, pos, opt_duration, opt_curve) {}\n  /**\n   * @return {!Element}\n   */\n  ;\n\n  _proto.getScrollingElement = function getScrollingElement() {}\n  /**\n   * Registers the handler for ViewportChangedEventDef events.\n   * @param {function(!ViewportChangedEventDef)} handler\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onChanged = function onChanged(handler) {}\n  /**\n   * Registers the handler for scroll events. These events DO NOT contain\n   * scrolling offset and it's discouraged to read scrolling offset in the\n   * event handler. The primary use case for this handler is to inform that\n   * scrolling might be going on. To get more information {@link onChanged}\n   * handler should be used.\n   * @param {function()} handler\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onScroll = function onScroll(handler) {}\n  /**\n   * Registers the handler for ViewportResizedEventDef events.\n   *\n   * Note that there is a known bug in Webkit that causes window.innerWidth\n   * and window.innerHeight values to be incorrect after resize. A temporary\n   * fix is to add a 500 ms delay before computing these values.\n   * Link: https://bugs.webkit.org/show_bug.cgi?id=170595\n   *\n   * @param {function(!ViewportResizedEventDef)} handler\n   * @return {!UnlistenDef}\n   */\n  ;\n\n  _proto.onResize = function onResize(handler) {}\n  /**\n   * Instruct the viewport to enter lightbox mode.\n   * @param {!Element=} opt_requestingElement Must be provided to be able to\n   *     enter lightbox mode under FIE cases.\n   * @param {!Promise=} opt_onComplete Optional promise that's resolved when\n   *     the caller finishes opening the lightbox e.g. transition animations.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.enterLightboxMode = function enterLightboxMode(opt_requestingElement, opt_onComplete) {}\n  /**\n   * Instruct the viewport to leave lightbox mode.\n   * @param {!Element=} opt_requestingElement Must be provided to be able to\n   *     enter lightbox mode under FIE cases.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.leaveLightboxMode = function leaveLightboxMode(opt_requestingElement) {}\n  /**\n   * Instruct the viewport to enter overlay mode.\n   */\n  ;\n\n  _proto.enterOverlayMode = function enterOverlayMode() {}\n  /**\n   * Instruct the viewport to leave overlay mode.\n   */\n  ;\n\n  _proto.leaveOverlayMode = function leaveOverlayMode() {}\n  /**\n   * Disable the scrolling by setting overflow: hidden.\n   * Should only be used for temporarily disabling scroll.\n   */\n  ;\n\n  _proto.disableScroll = function disableScroll() {}\n  /**\n   * Reset the scrolling by removing overflow: hidden.\n   */\n  ;\n\n  _proto.resetScroll = function resetScroll() {}\n  /**\n   * Resets touch zoom to initial scale of 1.\n   */\n  ;\n\n  _proto.resetTouchZoom = function resetTouchZoom() {}\n  /**\n   * Disables touch zoom on this viewport. Returns `true` if any actual\n   * changes have been done.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.disableTouchZoom = function disableTouchZoom() {}\n  /**\n   * Restores original touch zoom parameters. Returns `true` if any actual\n   * changes have been done.\n   * @return {boolean}\n   */\n  ;\n\n  _proto.restoreOriginalTouchZoom = function restoreOriginalTouchZoom() {}\n  /**\n   * Updates the fixed layer.\n   */\n  ;\n\n  _proto.updateFixedLayer = function updateFixedLayer() {}\n  /**\n   * Adds the element to the fixed layer.\n   * @param {!Element} element\n   * @param {boolean=} opt_forceTransfer If set to true , then the element needs\n   *    to be forcefully transferred to the fixed layer.\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.addToFixedLayer = function addToFixedLayer(element, opt_forceTransfer) {}\n  /**\n   * Removes the element from the fixed layer.\n   * @param {!Element} element\n   */\n  ;\n\n  _proto.removeFromFixedLayer = function removeFromFixedLayer(element) {};\n\n  return ViewportInterface;\n}(_service.Disposable);\n/* eslint-enable no-unused-vars */\n\n\nexports.ViewportInterface = ViewportInterface;\n\n},{\"../../service\":79}],121:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.vsyncForTesting = vsyncForTesting;\nexports.installVsyncService = installVsyncService;\nexports.Vsync = void 0;\n\nvar _promise = require(\"../utils/promise\");\n\nvar _jankMeter = require(\"./jank-meter\");\n\nvar _pass = require(\"../pass\");\n\nvar _services = require(\"../services\");\n\nvar _documentVisibility = require(\"../utils/document-visibility\");\n\nvar _error = require(\"../error\");\n\nvar _log = require(\"../log\");\n\nvar _service = require(\"../service\");\n\nvar _timerImpl = require(\"./timer-impl\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {time} */\nvar FRAME_TIME = 16;\n/**\n * @typedef {!Object<string, *>}\n */\n\nvar VsyncStateDef;\n/**\n * @typedef {{\n *   measure: (function(!VsyncStateDef):undefined|undefined),\n *   mutate: (function(!VsyncStateDef):undefined|undefined)\n * }}\n */\n\nvar VsyncTaskSpecDef;\n/**\n * Abstraction over requestAnimationFrame (rAF) that batches DOM read (measure)\n * and write (mutate) tasks in a single frame, to eliminate layout thrashing.\n *\n * NOTE: If the document is invisible due to prerendering (this includes\n * application-level prerendering where the doc is rendered in a hidden\n * iframe or webview), then no frame will be scheduled.\n * @package Visible for type.\n * @implements {../service.Disposable}\n */\n\nvar Vsync =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function Vsync(win) {\n    /** @const {!Window} */\n    this.win = win;\n    /** @private @const {!./ampdoc-impl.AmpDocService} */\n\n    this.ampdocService_ = _services.Services.ampdocServiceFor(this.win);\n    /** @private @const {function(function())}  */\n\n    this.raf_ = this.getRaf_();\n    /**\n     * Tasks to run in the next frame.\n     * @private {!Array<!VsyncTaskSpecDef>}\n     */\n\n    this.tasks_ = [];\n    /**\n     * Double buffer for tasks.\n     * @private {!Array<!VsyncTaskSpecDef>}\n     */\n\n    this.nextTasks_ = [];\n    /**\n     * States for tasks in the next frame in the same order.\n     * @private {!Array<!VsyncStateDef>}\n     */\n\n    this.states_ = [];\n    /**\n     * Double buffer for states.\n     * @private {!Array<!VsyncStateDef>}\n     */\n\n    this.nextStates_ = [];\n    /**\n     * Whether a new animation frame has been scheduled.\n     * @private {boolean}\n     */\n\n    this.scheduled_ = false;\n    /** @private {?Promise} */\n\n    this.nextFramePromise_ = null;\n    /** @protected {?function()} */\n\n    this.nextFrameResolver_ = null;\n    /** @const {!Function} */\n\n    this.boundRunScheduledTasks_ = this.runScheduledTasks_.bind(this);\n    /**\n     * If the doc is invisible we use this instead of rAF because rAF\n     * does not run in that scenario.\n     * However, we only do this for non-animation tasks as running\n     * animations doesn't make sense when not visible.\n     * @const {!Pass}\n     */\n\n    this.invisiblePass_ = new _pass.Pass(this.win, this.boundRunScheduledTasks_, FRAME_TIME);\n    /**\n     * Similar to this.invisiblePass_, but backing up a real rAF call. If we\n     * somehow failed to know that we are throttled we use a timer (which\n     * may also be throttled but at least runs eventually) to make sure\n     * we continue to get work done.\n     * @const {!Pass}\n     */\n\n    this.backupPass_ = new _pass.Pass(this.win, this.boundRunScheduledTasks_, // We cancel this when rAF fires and really only want it to fire\n    // if rAF doesn't work at all.\n    FRAME_TIME * 2.5); // When the document changes visibility, vsync has to reschedule the queue\n    // processing.\n\n    /** @private {function()} */\n\n    this.boundOnVisibilityChanged_ = this.onVisibilityChanged_.bind(this);\n\n    if (this.ampdocService_.isSingleDoc()) {\n      // In a single-doc mode, the visibility of the doc == global visibility.\n      // Thus, it's more efficient to only listen to it once.\n      this.ampdocService_.getSingleDoc().onVisibilityChanged(this.boundOnVisibilityChanged_);\n    } else {\n      // In multi-doc mode, we track separately the global visibility and\n      // per-doc visibility when necessary.\n      (0, _documentVisibility.addDocumentVisibilityChangeListener)(this.win.document, this.boundOnVisibilityChanged_);\n    }\n    /** @private {!JankMeter} */\n\n\n    this.jankMeter_ = new _jankMeter.JankMeter(this.win);\n  }\n  /** @override */\n\n\n  var _proto = Vsync.prototype;\n\n  _proto.dispose = function dispose() {\n    (0, _documentVisibility.removeDocumentVisibilityChangeListener)(this.win.document, this.boundOnVisibilityChanged_);\n  }\n  /** @private */\n  ;\n\n  _proto.onVisibilityChanged_ = function onVisibilityChanged_() {\n    if (this.scheduled_) {\n      this.forceSchedule_();\n    }\n  }\n  /**\n   * Runs vsync task: measure followed by mutate.\n   *\n   * If state is not provided, the value passed to the measure and mutate\n   * will be undefined.\n   *\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   */\n  ;\n\n  _proto.run = function run(task, opt_state) {\n    this.tasks_.push(task);\n    this.states_.push(opt_state || undefined);\n    this.schedule_();\n  }\n  /**\n   * Runs vsync task: measure followed by mutate. Returns the promise that\n   * will be resolved as soon as the task has been completed.\n   *\n   * If state is not provided, the value passed to the measure and mutate\n   * will be undefined.\n   *\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.runPromise = function runPromise(task, opt_state) {\n    this.run(task, opt_state);\n\n    if (this.nextFramePromise_) {\n      return this.nextFramePromise_;\n    }\n\n    var deferred = new _promise.Deferred();\n    this.nextFrameResolver_ = deferred.resolve;\n    return this.nextFramePromise_ = deferred.promise;\n  }\n  /**\n   * Creates a function that will call {@link run} method.\n   * @param {!VsyncTaskSpecDef} task\n   * @return {function(!VsyncStateDef=)}\n   */\n  ;\n\n  _proto.createTask = function createTask(task) {\n    var _this = this;\n\n    return (\n      /** @type {function(!VsyncStateDef=)} */\n      function (opt_state) {\n        _this.run(task, opt_state);\n      }\n    );\n  }\n  /**\n   * Runs the mutate operation via vsync.\n   * @param {function():undefined} mutator\n   */\n  ;\n\n  _proto.mutate = function mutate(mutator) {\n    this.run({\n      measure: undefined,\n      // For uniform hidden class.\n      mutate: mutator\n    });\n  }\n  /**\n   * Runs `mutate` wrapped in a promise.\n   * @param {function():undefined} mutator\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.mutatePromise = function mutatePromise(mutator) {\n    return this.runPromise({\n      measure: undefined,\n      mutate: mutator\n    });\n  }\n  /**\n   * Runs the measure operation via vsync.\n   * @param {function():undefined} measurer\n   */\n  ;\n\n  _proto.measure = function measure(measurer) {\n    this.run({\n      measure: measurer,\n      mutate: undefined // For uniform hidden class.\n\n    });\n  }\n  /**\n   * Runs `measure` wrapped in a promise.\n   * @param {function():TYPE} measurer\n   * @return {!Promise<TYPE>}\n   * @template TYPE\n   */\n  ;\n\n  _proto.measurePromise = function measurePromise(measurer) {\n    var _this2 = this;\n\n    return new Promise(function (resolve) {\n      _this2.measure(function () {\n        resolve(measurer());\n      });\n    });\n  }\n  /**\n   * Whether the runtime is allowed to animate at this time.\n   * @param {!Node} contextNode\n   * @return {boolean}\n   */\n  ;\n\n  _proto.canAnimate = function canAnimate(contextNode) {\n    return this.canAnimate_((0, _log.devAssert)(contextNode));\n  }\n  /**\n   * @param {!Node=} opt_contextNode\n   * @return {boolean}\n   * @private\n   */\n  ;\n\n  _proto.canAnimate_ = function canAnimate_(opt_contextNode) {\n    // Window level: animations allowed only when global window is visible.\n    if ((0, _documentVisibility.isDocumentHidden)(this.win.document)) {\n      return false;\n    } // Single doc: animations allowed when single doc is visible.\n\n\n    if (this.ampdocService_.isSingleDoc()) {\n      return this.ampdocService_.getSingleDoc().isVisible();\n    } // Multi-doc: animations depend on the state of the relevant doc.\n\n\n    if (opt_contextNode) {\n      var ampdoc = this.ampdocService_.getAmpDocIfAvailable(opt_contextNode);\n      return !ampdoc || ampdoc.isVisible();\n    }\n\n    return true;\n  }\n  /**\n   * Runs the animation vsync task. This operation can only run when animations\n   * are allowed. Otherwise, this method returns `false` and exits.\n   * @param {!Node} contextNode\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   * @return {boolean}\n   */\n  ;\n\n  _proto.runAnim = function runAnim(contextNode, task, opt_state) {\n    // Do not request animation frames when the document is not visible.\n    if (!this.canAnimate_(contextNode)) {\n      (0, _log.dev)().warn('VSYNC', 'Did not schedule a vsync request, because document was invisible');\n      return false;\n    }\n\n    this.run(task, opt_state);\n    return true;\n  }\n  /**\n   * Creates an animation vsync task. This operation can only run when\n   * animations are allowed. Otherwise, this closure returns `false` and exits.\n   * @param {!Node} contextNode\n   * @param {!VsyncTaskSpecDef} task\n   * @return {function(!VsyncStateDef=):boolean}\n   */\n  ;\n\n  _proto.createAnimTask = function createAnimTask(contextNode, task) {\n    var _this3 = this;\n\n    return (\n      /** @type {function(!VsyncStateDef=):boolean} */\n      function (opt_state) {\n        return _this3.runAnim(contextNode, task, opt_state);\n      }\n    );\n  }\n  /**\n   * Runs the series of mutates until the mutator returns a false value.\n   * @param {!Node} contextNode\n   * @param {function(time, time, !VsyncStateDef):boolean} mutator The\n   *   mutator callback. Only expected to do DOM writes, not reads. If the\n   *   returned value is true, the vsync task will be repeated, otherwise it\n   *   will be completed. The arguments are: timeSinceStart:time,\n   *   timeSincePrev:time and state:VsyncStateDef.\n   * @param {number=} opt_timeout Optional timeout that will force the series\n   *   to complete and reject the promise.\n   * @return {!Promise} Returns the promise that will either resolve on when\n   *   the vsync series are completed or reject in case of failure, such as\n   *   timeout.\n   */\n  ;\n\n  _proto.runAnimMutateSeries = function runAnimMutateSeries(contextNode, mutator, opt_timeout) {\n    var _this4 = this;\n\n    if (!this.canAnimate_(contextNode)) {\n      return Promise.reject((0, _error.cancellation)());\n    }\n\n    return new Promise(function (resolve, reject) {\n      var startTime = Date.now();\n      var prevTime = 0;\n\n      var task = _this4.createAnimTask(contextNode, {\n        mutate: function mutate(state) {\n          var timeSinceStart = Date.now() - startTime;\n          var res = mutator(timeSinceStart, timeSinceStart - prevTime, state);\n\n          if (!res) {\n            resolve();\n          } else if (opt_timeout && timeSinceStart > opt_timeout) {\n            reject(new Error('timeout'));\n          } else {\n            prevTime = timeSinceStart;\n            task(state);\n          }\n        }\n      });\n\n      task({});\n    });\n  }\n  /** @private */\n  ;\n\n  _proto.schedule_ = function schedule_() {\n    if (this.scheduled_) {\n      return;\n    } // Schedule actual animation frame and then run tasks.\n\n\n    this.scheduled_ = true;\n    this.jankMeter_.onScheduled();\n    this.forceSchedule_();\n  }\n  /** @private */\n  ;\n\n  _proto.forceSchedule_ = function forceSchedule_() {\n    if (this.canAnimate_()) {\n      this.raf_(this.boundRunScheduledTasks_);\n      this.backupPass_.schedule();\n    } else {\n      this.invisiblePass_.schedule();\n    }\n  }\n  /**\n   * Runs all scheduled tasks. This is typically called in an RAF\n   * callback. Tests may call this method to force execution of\n   * tasks without waiting.\n   * @private\n   */\n  ;\n\n  _proto.runScheduledTasks_ = function runScheduledTasks_() {\n    this.backupPass_.cancel();\n    this.scheduled_ = false;\n    this.jankMeter_.onRun();\n    var tasks = this.tasks_,\n        states = this.states_,\n        resolver = this.nextFrameResolver_;\n    this.nextFrameResolver_ = null;\n    this.nextFramePromise_ = null; // Double buffering\n\n    this.tasks_ = this.nextTasks_;\n    this.states_ = this.nextStates_;\n\n    for (var i = 0; i < tasks.length; i++) {\n      if (tasks[i].measure) {\n        if (!callTask_(tasks[i].measure, states[i])) {\n          // Ensure that the mutate is not executed when measure fails.\n          tasks[i].mutate = undefined;\n        }\n      }\n    }\n\n    for (var _i = 0; _i < tasks.length; _i++) {\n      if (tasks[_i].mutate) {\n        callTask_(tasks[_i].mutate, states[_i]);\n      }\n    } // Swap last arrays into double buffer.\n\n\n    this.nextTasks_ = tasks;\n    this.nextStates_ = states;\n    this.nextTasks_.length = 0;\n    this.nextStates_.length = 0;\n\n    if (resolver) {\n      resolver();\n    }\n  }\n  /**\n   * @return {function(function())} requestAnimationFrame or polyfill.\n   */\n  ;\n\n  _proto.getRaf_ = function getRaf_() {\n    var _this5 = this;\n\n    var raf = this.win.requestAnimationFrame || this.win.webkitRequestAnimationFrame;\n\n    if (raf) {\n      return raf.bind(this.win);\n    }\n\n    var lastTime = 0;\n    return function (fn) {\n      var now = Date.now(); // By default we take 16ms between frames, but if the last frame is say\n      // 10ms ago, we only want to wait 6ms.\n\n      var timeToCall = Math.max(0, FRAME_TIME - (now - lastTime));\n      lastTime = now + timeToCall;\n\n      _this5.win.setTimeout(fn, timeToCall);\n    };\n  };\n\n  return Vsync;\n}();\n/**\n * For optimization reasons to stop try/catch from blocking optimization.\n * @param {function(!VsyncStateDef):undefined|undefined} callback\n * @param {!VsyncStateDef} state\n * @return {boolean}\n * @noinline\n */\n\n\nexports.Vsync = Vsync;\n\nfunction callTask_(callback, state) {\n  (0, _log.devAssert)(callback);\n\n  try {\n    var ret = callback(state);\n\n    if (ret !== undefined) {\n      (0, _log.dev)().error('VSYNC', 'callback returned a value but vsync cannot propogate it: %s', callback.toString());\n    }\n  } catch (e) {\n    (0, _log.rethrowAsync)(e);\n    return false;\n  }\n\n  return true;\n}\n/**\n * @param {!Window} window\n * @return {!Vsync}\n */\n\n\nfunction vsyncForTesting(window) {\n  installVsyncService(window);\n  return (0, _service.getService)(window, 'vsync');\n}\n/**\n * @param {!Window} window\n */\n\n\nfunction installVsyncService(window) {\n  (0, _timerImpl.installTimerService)(window);\n  (0, _service.registerServiceBuilder)(window, 'vsync', Vsync);\n}\n\n},{\"../error\":44,\"../log\":68,\"../pass\":72,\"../service\":79,\"../services\":123,\"../utils/document-visibility\":138,\"../utils/promise\":147,\"./jank-meter\":95,\"./timer-impl\":108}],122:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.xhrServiceForTesting = xhrServiceForTesting;\nexports.installXhrService = installXhrService;\nexports.Xhr = void 0;\n\nvar _services = require(\"../services\");\n\nvar _xhrUtils = require(\"../utils/xhr-utils\");\n\nvar _url = require(\"../url\");\n\nvar _service = require(\"../service\");\n\nvar _formDataWrapper = require(\"../form-data-wrapper\");\n\nvar _log = require(\"../log\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A service that polyfills Fetch API for use within AMP.\n *\n * @package Visible for type.\n * @visibleForTesting\n */\nvar Xhr =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Window} win\n   */\n  function Xhr(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    var ampdocService = _services.Services.ampdocServiceFor(win); // The isSingleDoc check is required because if in shadow mode, this will\n    // throw a console error because the shellShadowDoc_ is not set when\n    // fetching the amp doc. So either the test-bind-impl or test pre setup in\n    // shadow mode tests needs to be fixed or there is a bug in ampdoc impl\n    // getAmpDoc.\n    // TODO(alabiaga): This should be investigated and fixed\n\n    /** @private {?./ampdoc-impl.AmpDoc} */\n\n\n    this.ampdocSingle_ = ampdocService.isSingleDoc() ? ampdocService.getSingleDoc() : null;\n  }\n  /**\n   * We want to call `fetch_` unbound from any context since it could\n   * be either the native fetch or our polyfill.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef} init\n   * @return {!Promise<!Response>}\n   * @private\n   */\n\n\n  var _proto = Xhr.prototype;\n\n  _proto.fetch_ = function fetch_(input, init) {\n    var _this = this,\n        _arguments = arguments;\n\n    return (0, _xhrUtils.getViewerInterceptResponse)(this.win, this.ampdocSingle_, input, init).then(function (interceptorResponse) {\n      if (interceptorResponse) {\n        return interceptorResponse;\n      } // After this point, both the native `fetch` and the `fetch` polyfill\n      // will expect a native `FormData` object in the `body` property, so\n      // the native `FormData` object needs to be unwrapped.\n\n\n      if ((0, _formDataWrapper.isFormDataWrapper)(init.body)) {\n        var formDataWrapper =\n        /** @type {!FormDataWrapperInterface} */\n        init.body;\n        init.body = formDataWrapper.getFormData();\n      }\n\n      return _this.win.fetch.apply(null, _arguments);\n    });\n  }\n  /**\n   * Performs the final initialization and requests the fetch. It does two\n   * main things:\n   * - It adds \"__amp_source_origin\" URL parameter with source origin\n   * USE WITH CAUTION: setting ampCors to false disables AMP source origin check\n   * but allows for caching resources cross pages.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef=} init\n   * @return {!Promise<!Response>}\n   * @private\n   */\n  ;\n\n  _proto.fetchAmpCors_ = function fetchAmpCors_(input, init) {\n    if (init === void 0) {\n      init = {};\n    }\n\n    input = (0, _xhrUtils.setupInput)(this.win, input, init);\n    init = (0, _xhrUtils.setupAMPCors)(this.win, input, init);\n    return this.fetch_(input, init).then(function (response) {\n      return response;\n    }, function (reason) {\n      var targetOrigin = (0, _url.parseUrlDeprecated)(input).origin;\n      throw (0, _log.user)().createExpectedError('XHR', \"Failed fetching (\" + targetOrigin + \"/...):\", reason && reason.message);\n    });\n  }\n  /**\n   * Fetches a JSON response. Note this returns the response object, not the\n   * response's JSON. #fetchJson merely sets up the request to accept JSON.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {?FetchInitDef=} opt_init\n   * @return {!Promise<!Response>}\n   */\n  ;\n\n  _proto.fetchJson = function fetchJson(input, opt_init) {\n    return this.fetch(input, (0, _xhrUtils.setupJsonFetchInit)(opt_init));\n  }\n  /**\n   * Fetches a text response. Note this returns the response object, not the\n   * response's text. #fetchText merely sets up the request to accept text.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {?FetchInitDef=} opt_init\n   * @return {!Promise<!Response>}\n   */\n  ;\n\n  _proto.fetchText = function fetchText(input, opt_init) {\n    return this.fetch(input, (0, _xhrUtils.setupInit)(opt_init, 'text/plain'));\n  }\n  /**\n   * @param {string} input URL\n   * @param {?FetchInitDef=} opt_init Fetch options object.\n   * @return {!Promise<!Response>}\n   */\n  ;\n\n  _proto.fetch = function fetch(input, opt_init) {\n    var init = (0, _xhrUtils.setupInit)(opt_init);\n    return this.fetchAmpCors_(input, init).then(function (response) {\n      return (0, _xhrUtils.assertSuccess)(response);\n    });\n  }\n  /**\n   * Sends the request, awaits result and confirms that it was successful.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef=} opt_init\n   * @return {!Promise}\n   */\n  ;\n\n  _proto.sendSignal = function sendSignal(input, opt_init) {\n    return this.fetchAmpCors_(input, opt_init).then(function (response) {\n      return (0, _xhrUtils.assertSuccess)(response);\n    });\n  }\n  /**\n   * Add \"__amp_source_origin\" query parameter to the URL. Ideally, we'd be\n   * able to set a header (e.g. AMP-Source-Origin), but this will force\n   * preflight request on all CORS request.\n   * @param {!Window} win\n   * @param {string} url\n   * @return {string}\n   */\n  ;\n\n  _proto.getCorsUrl = function getCorsUrl(win, url) {\n    return (0, _url.getCorsUrl)(win, url);\n  };\n\n  return Xhr;\n}();\n/**\n * @param {!Window} window\n * @return {!Xhr}\n */\n\n\nexports.Xhr = Xhr;\n\nfunction xhrServiceForTesting(window) {\n  installXhrService(window);\n  return (0, _service.getService)(window, 'xhr');\n}\n/**\n * @param {!Window} window\n */\n\n\nfunction installXhrService(window) {\n  (0, _service.registerServiceBuilder)(window, 'xhr', Xhr);\n}\n\n},{\"../form-data-wrapper\":52,\"../log\":68,\"../service\":79,\"../services\":123,\"../url\":134,\"../utils/xhr-utils\":150}],123:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.Services = exports.SubscriptionService = void 0;\n\nvar _service = require(\"./service\");\n\nvar _elementService = require(\"./element-service\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @typedef {!../extensions/amp-subscriptions/0.1/amp-subscriptions.SubscriptionService} */\nvar SubscriptionService;\nexports.SubscriptionService = SubscriptionService;\n\nvar Services =\n/*#__PURE__*/\nfunction () {\n  function Services() {}\n\n  /**\n   * Hint: Add extensions folder path to compile.js with\n   * warnings cannot find modules.\n   */\n\n  /**\n   * Returns a promise for the Access service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  Services.accessServiceForDoc = function accessServiceForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>} */\n      (0, _elementService.getElementServiceForDoc)(element, 'access', 'amp-access')\n    );\n  }\n  /**\n   * Returns a promise for the Access service or a promise for null if the\n   * service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  ;\n\n  Services.accessServiceForDocOrNull = function accessServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'access', 'amp-access')\n    );\n  }\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!SubscriptionService>}\n   */\n  ;\n\n  Services.subscriptionsServiceForDoc = function subscriptionsServiceForDoc(element) {\n    return (\n      /** @type {!Promise<!SubscriptionService>} */\n      (0, _elementService.getElementServiceForDoc)(element, 'subscriptions', 'amp-subscriptions')\n    );\n  }\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?SubscriptionService>}\n   */\n  ;\n\n  Services.subscriptionsServiceForDocOrNull = function subscriptionsServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?SubscriptionService>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'subscriptions', 'amp-subscriptions')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/action-impl.ActionService}\n   */\n  ;\n\n  Services.actionServiceForDoc = function actionServiceForDoc(element) {\n    return (\n      /** @type {!./service/action-impl.ActionService} */\n      (0, _service.getExistingServiceForDocInEmbedScope)(element, 'action')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/standard-actions-impl.StandardActions}\n   */\n  ;\n\n  Services.standardActionsForDoc = function standardActionsForDoc(element) {\n    return (\n      /** @type {!./service/standard-actions-impl.StandardActions} */\n      (0, _service.getExistingServiceForDocInEmbedScope)(element, 'standard-actions')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>}\n   */\n  ;\n\n  Services.activityForDoc = function activityForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>} */\n      (0, _elementService.getElementServiceForDoc)(element, 'activity', 'amp-analytics')\n    );\n  }\n  /**\n   * Returns the global instance of the `AmpDocService` service that can be\n   * used to resolve an ampdoc for any node: either in the single-doc or\n   * shadow-doc environment.\n   * @param {!Window} window\n   * @return {!./service/ampdoc-impl.AmpDocService}\n   */\n  ;\n\n  Services.ampdocServiceFor = function ampdocServiceFor(window) {\n    return (\n      /** @type {!./service/ampdoc-impl.AmpDocService} */\n      (0, _service.getService)(window, 'ampdoc')\n    );\n  }\n  /**\n   * Returns the AmpDoc for the specified context node.\n   * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrAmpDoc\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  ;\n\n  Services.ampdoc = function ampdoc(nodeOrAmpDoc) {\n    return (0, _service.getAmpdoc)(nodeOrAmpDoc);\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @param {boolean=} loadAnalytics\n   * @return {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  ;\n\n  Services.analyticsForDoc = function analyticsForDoc(element, loadAnalytics) {\n    if (loadAnalytics === void 0) {\n      loadAnalytics = false;\n    }\n\n    if (loadAnalytics) {\n      // Get Extensions service and force load analytics extension.\n      var ampdoc = (0, _service.getAmpdoc)(element);\n      Services.extensionsFor(ampdoc.win).\n      /*OK*/\n      installExtensionForDoc(ampdoc, 'amp-analytics');\n    }\n\n    return (\n      /** @type {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */\n      (0, _elementService.getElementServiceForDoc)(element, 'amp-analytics-instrumentation', 'amp-analytics')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  ;\n\n  Services.analyticsForDocOrNull = function analyticsForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'amp-analytics-instrumentation', 'amp-analytics')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/batched-xhr-impl.BatchedXhr}\n   */\n  ;\n\n  Services.batchedXhrFor = function batchedXhrFor(window) {\n    return (\n      /** @type {!./service/batched-xhr-impl.BatchedXhr} */\n      (0, _service.getService)(window, 'batched-xhr')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>}\n   */\n  ;\n\n  Services.bindForDocOrNull = function bindForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>} */\n      (0, _elementService.getElementServiceIfAvailableForDocInEmbedScope)(element, 'bind', 'amp-bind')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/cid-impl.CidDef>}\n   */\n  ;\n\n  Services.cidForDoc = function cidForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!Promise<!./service/cid-impl.CidDef>} */\n      (0, _service.getServicePromiseForDoc)(elementOrAmpDoc, 'cid')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/navigation.Navigation}\n   */\n  ;\n\n  Services.navigationForDoc = function navigationForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!./service/navigation.Navigation} */\n      (0, _service.getServiceForDoc)(elementOrAmpDoc, 'navigation')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n   */\n  ;\n\n  Services.loaderServiceForDoc = function loaderServiceForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>} */\n      (0, _elementService.getElementServiceForDoc)(element, 'loader', 'amp-loader')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>}\n   */\n  ;\n\n  Services.standaloneServiceForDoc = function standaloneServiceForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>} */\n      (0, _elementService.getElementServiceForDoc)(element, 'standalone', 'amp-standalone')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/crypto-impl.Crypto}\n   */\n  ;\n\n  Services.cryptoFor = function cryptoFor(window) {\n    return (\n      /** @type {!./service/crypto-impl.Crypto} */\n      (0, _service.getService)(window, 'crypto')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/document-info-impl.DocumentInfoDef} Info about the doc\n   */\n  ;\n\n  Services.documentInfoForDoc = function documentInfoForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!./service/document-info-impl.DocInfo} */\n      (0, _service.getServiceForDoc)(elementOrAmpDoc, 'documentInfo').get()\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/extensions-impl.Extensions}\n   */\n  ;\n\n  Services.extensionsFor = function extensionsFor(window) {\n    return (\n      /** @type {!./service/extensions-impl.Extensions} */\n      (0, _service.getService)(window, 'extensions')\n    );\n  }\n  /**\n   * Returns a service to register callbacks we wish to execute when an\n   * amp-form is submitted.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>}\n   */\n  ;\n\n  Services.formSubmitForDoc = function formSubmitForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>} */\n      (0, _service.getServicePromiseForDoc)(elementOrAmpDoc, 'form-submit-service')\n    );\n  }\n  /**\n   * Returns service to listen for `hidden` attribute mutations.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/hidden-observer-impl.HiddenObserver}\n   */\n  ;\n\n  Services.hiddenObserverForDoc = function hiddenObserverForDoc(element) {\n    return (\n      /** @type {!./service/hidden-observer-impl.HiddenObserver} */\n      (0, _service.getExistingServiceForDocInEmbedScope)(element, 'hidden-observer')\n    );\n  }\n  /**\n   * Returns service implemented in service/history-impl.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/history-impl.History}\n   */\n  ;\n\n  Services.historyForDoc = function historyForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!./service/history-impl.History} */\n      (0, _service.getServiceForDoc)(elementOrAmpDoc, 'history')\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {!./input.Input}\n   */\n  ;\n\n  Services.inputFor = function inputFor(win) {\n    return (0, _service.getService)(win, 'input');\n  }\n  /**s\n   * Returns a promise for the Inputmask service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>}\n   */\n  ;\n\n  Services.inputmaskServiceForDocOrNull = function inputmaskServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'inputmask', 'amp-inputmask')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/owners-interface.OwnersInterface}\n   */\n  ;\n\n  Services.ownersForDoc = function ownersForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!./service/owners-interface.OwnersInterface} */\n      (0, _service.getServiceForDoc)(elementOrAmpDoc, 'owners')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  ;\n\n  Services.performanceFor = function performanceFor(window) {\n    return (\n      /** @type {!./service/performance-impl.Performance}*/\n      (0, _service.getService)(window, 'performance')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  ;\n\n  Services.performanceForOrNull = function performanceForOrNull(window) {\n    return (\n      /** @type {!./service/performance-impl.Performance}*/\n      (0, _service.getExistingServiceOrNull)(window, 'performance')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/platform-impl.Platform}\n   */\n  ;\n\n  Services.platformFor = function platformFor(window) {\n    return (\n      /** @type {!./service/platform-impl.Platform} */\n      (0, _service.getService)(window, 'platform')\n    );\n  }\n  /**\n   * Not installed by default; must be installed in extension code before use.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/position-observer/position-observer-impl.PositionObserver}\n   * @throws If the service is not installed.\n   */\n  ;\n\n  Services.positionObserverForDoc = function positionObserverForDoc(element) {\n    return (\n      /** @type {!./service/position-observer/position-observer-impl.PositionObserver} */\n      (0, _service.getServiceForDoc)(element, 'position-observer')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/resources-interface.ResourcesInterface}\n   */\n  ;\n\n  Services.resourcesForDoc = function resourcesForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!./service/resources-interface.ResourcesInterface} */\n      (0, _service.getServiceForDoc)(elementOrAmpDoc, 'resources')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/resources-interface.ResourcesInterface>}\n   */\n  ;\n\n  Services.resourcesPromiseForDoc = function resourcesPromiseForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!Promise<!./service/resources-interface.ResourcesInterface>} */\n      (0, _service.getServicePromiseForDoc)(elementOrAmpDoc, 'resources')\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?{incomingFragment: string, outgoingFragment: string}>}\n   */\n  ;\n\n  Services.shareTrackingForOrNull = function shareTrackingForOrNull(win) {\n    return (\n      /** @type {!Promise<?{incomingFragment: string, outgoingFragment: string}>} */\n      (0, _elementService.getElementServiceIfAvailable)(win, 'share-tracking', 'amp-share-tracking', true)\n    );\n  }\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/variable-service.StoryVariableDef>}\n   */\n  ;\n\n  Services.storyVariableServiceForOrNull = function storyVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/variable-service.StoryVariableDef>} */\n      (0, _elementService.getElementServiceIfAvailable)(win, 'story-variable', 'amp-story', true)\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService}\n   */\n  ;\n\n  Services.storyVariableService = function storyVariableService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService} */\n      (0, _service.getExistingServiceOrNull)(win, 'story-variable')\n    );\n  }\n  /**\n   * Version of the story store service depends on which version of amp-story\n   * the publisher is loading. They all have the same implementation.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService|?../extensions/amp-story/0.1/amp-story-store-service.AmpStoryStoreService>}\n   */\n  ;\n\n  Services.storyStoreServiceForOrNull = function storyStoreServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService|?../extensions/amp-story/0.1/amp-story-store-service.AmpStoryStoreService>} */\n      (0, _elementService.getElementServiceIfAvailable)(win, 'story-store', 'amp-story')\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService}\n   */\n  ;\n\n  Services.storyStoreService = function storyStoreService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService} */\n      (0, _service.getExistingServiceOrNull)(win, 'story-store')\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService}\n   */\n  ;\n\n  Services.storyMediaQueryService = function storyMediaQueryService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService} */\n      (0, _service.getExistingServiceOrNull)(win, 'story-media-query')\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService}\n   */\n  ;\n\n  Services.storyRequestService = function storyRequestService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService} */\n      (0, _service.getExistingServiceOrNull)(win, 'story-request')\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService}\n   */\n  ;\n\n  Services.mediaPerformanceMetricsService = function mediaPerformanceMetricsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService} */\n      (0, _service.getExistingServiceOrNull)(win, 'media-performance-metrics')\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {!Promise<?./service/localization.LocalizationService>}\n   */\n  ;\n\n  Services.localizationServiceForOrNull = function localizationServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?./service/localization.LocalizationService>} */\n      (0, _elementService.getElementServiceIfAvailable)(win, 'localization', 'amp-story', true)\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {!./service/localization.LocalizationService}\n   */\n  ;\n\n  Services.localizationService = function localizationService(win) {\n    return (0, _service.getService)(win, 'localization');\n  }\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>}\n   */\n  ;\n\n  Services.storyAnalyticsServiceForOrNull = function storyAnalyticsServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>} */\n      (0, _elementService.getElementServiceIfAvailable)(win, 'story-analytics', 'amp-story', true)\n    );\n  }\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService}\n   */\n  ;\n\n  Services.storyAnalyticsService = function storyAnalyticsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService} */\n      (0, _service.getExistingServiceOrNull)(win, 'story-analytics')\n    );\n  }\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!../extensions/amp-story/0.1/amp-story-store-service.AmpStoryStoreService}\n   */\n  ;\n\n  Services.storyStoreServiceV01 = function storyStoreServiceV01(win) {\n    return (0, _service.getService)(win, 'story-store');\n  }\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!../extensions/amp-story/0.1/amp-story-request-service.AmpStoryRequestService}\n   */\n  ;\n\n  Services.storyRequestServiceV01 = function storyRequestServiceV01(win) {\n    return (0, _service.getService)(win, 'story-request-v01');\n  }\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?./service/localization.LocalizationService>}\n   */\n  ;\n\n  Services.localizationServiceForOrNullV01 = function localizationServiceForOrNullV01(win) {\n    return (\n      /** @type {!Promise<?./service/localization.LocalizationService>} */\n      (0, _elementService.getElementServiceIfAvailable)(win, 'localization-v01', 'amp-story', true)\n    );\n  }\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!./service/localization.LocalizationService}\n   */\n  ;\n\n  Services.localizationServiceV01 = function localizationServiceV01(win) {\n    return (0, _service.getService)(win, 'localization-v01');\n  }\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-viewer-integration/0.1/variable-service.ViewerIntegrationVariableDef>}\n   */\n  ;\n\n  Services.viewerIntegrationVariableServiceForOrNull = function viewerIntegrationVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-viewer-integration/0.1/variable-service.ViewerIntegrationVariableDef>} */\n      (0, _elementService.getElementServiceIfAvailable)(win, 'viewer-integration-variable', 'amp-viewer-integration', true)\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>}\n   */\n  ;\n\n  Services.webAnimationServiceFor = function webAnimationServiceFor(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>} */\n      (0, _elementService.getElementServiceForDoc)(element, 'web-animation', 'amp-animation')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   */\n  ;\n\n  Services.storageForDoc = function storageForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!Promise<!./service/storage-impl.Storage>} */\n      (0, _service.getServicePromiseForDoc)(elementOrAmpDoc, 'storage')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/template-impl.Templates}\n   */\n  ;\n\n  Services.templatesFor = function templatesFor(window) {\n    return (\n      /** @type {!./service/template-impl.Templates} */\n      (0, _service.getService)(window, 'templates')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/timer-impl.Timer}\n   */\n  ;\n\n  Services.timerFor = function timerFor(window) {\n    // TODO(alabiaga): This will always return the top window's Timer service.\n    return (\n      /** @type {!./service/timer-impl.Timer} */\n      (0, _service.getService)(window, 'timer')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-replacements-impl.UrlReplacements}\n   */\n  ;\n\n  Services.urlReplacementsForDoc = function urlReplacementsForDoc(element) {\n    return (\n      /** @type {!./service/url-replacements-impl.UrlReplacements} */\n      (0, _service.getExistingServiceForDocInEmbedScope)(element, 'url-replace')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>}\n   */\n  ;\n\n  Services.userNotificationManagerForDoc = function userNotificationManagerForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>} */\n      (0, _elementService.getElementServiceForDoc)(element, 'userNotificationManager', 'amp-user-notification')\n    );\n  }\n  /**\n   * Returns a promise for the consentPolicy Service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>}\n   */\n  ;\n\n  Services.consentPolicyServiceForDocOrNull = function consentPolicyServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'consentPolicyManager', 'amp-consent')\n    );\n  }\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>}\n   */\n  ;\n\n  Services.geoForDocOrNull = function geoForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'geo', 'amp-geo', true)\n    );\n  }\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-user-location/0.1/user-location-service.UserLocationService>}\n   */\n  ;\n\n  Services.userLocationForDocOrNull = function userLocationForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-user-location/0.1/user-location-service.UserLocationService>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'user-location', 'amp-user-location', true)\n    );\n  }\n  /**\n   * Unlike most service getters, passing `Node` is necessary for some FIE-scope\n   * services since sometimes we only have the FIE Document for context.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-impl.Url}\n   */\n  ;\n\n  Services.urlForDoc = function urlForDoc(element) {\n    return (\n      /** @type {!./service/url-impl.Url} */\n      (0, _service.getExistingServiceForDocInEmbedScope)(element, 'url')\n    );\n  }\n  /**\n   * Returns a promise for the experiment variants or a promise for null if it\n   * is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>}\n   */\n  ;\n\n  Services.variantsForDocOrNull = function variantsForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'variant', 'amp-experiment', true)\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/video-manager-impl.VideoManager}\n   */\n  ;\n\n  Services.videoManagerForDoc = function videoManagerForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!./service/video-manager-impl.VideoManager} */\n      (0, _service.getServiceForDoc)(elementOrAmpDoc, 'video-manager')\n    );\n  }\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-viewer-assistance/0.1/amp-viewer-assistance.AmpViewerAssistance>}\n   */\n  ;\n\n  Services.viewerAssistanceForDocOrNull = function viewerAssistanceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-viewer-assistance/0.1/amp-viewer-assistance.AmpViewerAssistance>} */\n      (0, _elementService.getElementServiceIfAvailableForDoc)(element, 'amp-viewer-assistance', 'amp-viewer-assistance')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewer-interface.ViewerInterface}\n   */\n  ;\n\n  Services.viewerForDoc = function viewerForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!./service/viewer-interface.ViewerInterface} */\n      (0, _service.getServiceForDoc)(elementOrAmpDoc, 'viewer')\n    );\n  }\n  /**\n   * Returns promise for the viewer. This is an unusual case and necessary only\n   * for services that need reference to the viewer before it has been\n   * initialized. Most of the code, however, just should use `viewerForDoc`.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/viewer-interface.ViewerInterface>}\n   */\n  ;\n\n  Services.viewerPromiseForDoc = function viewerPromiseForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!Promise<!./service/viewer-interface.ViewerInterface>} */\n      (0, _service.getServicePromiseForDoc)(elementOrAmpDoc, 'viewer')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  ;\n\n  Services.vsyncFor = function vsyncFor(window) {\n    return (\n      /** @type {!./service/vsync-impl.Vsync} */\n      (0, _service.getService)(window, 'vsync')\n    );\n  }\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  ;\n\n  Services.viewportForDoc = function viewportForDoc(elementOrAmpDoc) {\n    return (\n      /** @type {!./service/viewport/viewport-interface.ViewportInterface} */\n      (0, _service.getServiceForDoc)(elementOrAmpDoc, 'viewport')\n    );\n  }\n  /**\n   * @param {!Window} window\n   * @return {!./service/xhr-impl.Xhr}\n   */\n  ;\n\n  Services.xhrFor = function xhrFor(window) {\n    return (\n      /** @type {!./service/xhr-impl.Xhr} */\n      (0, _service.getService)(window, 'xhr')\n    );\n  };\n\n  return Services;\n}();\n\nexports.Services = Services;\n\n},{\"./element-service\":42,\"./service\":79}],124:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.parseSizeList = parseSizeList;\nexports.SizeList = void 0;\n\nvar _layout = require(\"./layout\");\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A single option within a SizeList.\n * @typedef {{\n *   mediaQuery: (string|undefined),\n *   size: (!./layout.LengthDef)\n * }}\n */\nvar SizeListOptionDef;\n/**\n * Parses the text representation of \"sizes\" into SizeList object.\n *\n * There could be any number of size options within the SizeList. They are tried\n * in the order they were defined. The final size option must not have \"media\"\n * condition specified. All other size options must have \"media\" condition\n * specified.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img#Attributes\n * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n * @param {string} s\n * @param {boolean=} opt_allowPercentAsLength when parsing heights\n * @return {!SizeList}\n */\n\nfunction parseSizeList(s, opt_allowPercentAsLength) {\n  var sSizes = s.split(',');\n  (0, _log.userAssert)(sSizes.length > 0, 'sizes has to have at least one size');\n  var sizes = [];\n  sSizes.forEach(function (sSize) {\n    sSize = sSize.replace(/\\s+/g, ' ').trim();\n\n    if (sSize.length == 0) {\n      return;\n    }\n\n    var mediaStr;\n    var sizeStr; // Process the expression from the end.\n\n    var lastChar = sSize.charAt(sSize.length - 1);\n    var div;\n    var func = false;\n\n    if (lastChar == ')') {\n      // Value is the CSS function, e.g. `calc(50vw + 10px)`.\n      func = true; // First, skip to the opening paren.\n\n      var parens = 1;\n      div = sSize.length - 2;\n\n      for (; div >= 0; div--) {\n        var c = sSize.charAt(div);\n\n        if (c == '(') {\n          parens--;\n        } else if (c == ')') {\n          parens++;\n        }\n\n        if (parens == 0) {\n          break;\n        }\n      } // Then, skip to the begining to the function's name.\n\n\n      var funcEnd = div - 1;\n\n      if (div > 0) {\n        div--;\n\n        for (; div >= 0; div--) {\n          var _c = sSize.charAt(div);\n\n          if (!(_c == '%' || _c == '-' || _c == '_' || _c >= 'a' && _c <= 'z' || _c >= 'A' && _c <= 'Z' || _c >= '0' && _c <= '9')) {\n            break;\n          }\n        }\n      }\n\n      (0, _log.userAssert)(div < funcEnd, 'Invalid CSS function in \"%s\"', sSize);\n    } else {\n      // Value is the length or a percent: accept a wide range of values,\n      // including invalid values - they will be later asserted to conform\n      // to exact CSS length or percent value.\n      div = sSize.length - 2;\n\n      for (; div >= 0; div--) {\n        var _c2 = sSize.charAt(div);\n\n        if (!(_c2 == '%' || _c2 == '.' || _c2 >= 'a' && _c2 <= 'z' || _c2 >= 'A' && _c2 <= 'Z' || _c2 >= '0' && _c2 <= '9')) {\n          break;\n        }\n      }\n    }\n\n    if (div >= 0) {\n      mediaStr = sSize.substring(0, div + 1).trim();\n      sizeStr = sSize.substring(div + 1).trim();\n    } else {\n      sizeStr = sSize;\n      mediaStr = undefined;\n    }\n\n    sizes.push({\n      mediaQuery: mediaStr,\n      size: func ? sizeStr : opt_allowPercentAsLength ? (0, _layout.assertLengthOrPercent)(sizeStr) : (0, _layout.assertLength)(sizeStr)\n    });\n  });\n  return new SizeList(sizes);\n}\n/**\n * A SizeList object contains one or more sizes as typically seen in \"sizes\"\n * attribute.\n *\n * See \"select\" method for details on how the size selection is performed.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img#Attributes\n * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n */\n\n\nvar SizeList =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Array<!SizeListOptionDef>} sizes\n   */\n  function SizeList(sizes) {\n    (0, _log.userAssert)(sizes.length > 0, 'SizeList must have at least one option');\n    /** @private @const {!Array<!SizeListOptionDef>} */\n\n    this.sizes_ = sizes; // All sources except for last must have a media query. The last one must\n    // not.\n\n    for (var i = 0; i < sizes.length; i++) {\n      var option = sizes[i];\n\n      if (i < sizes.length - 1) {\n        (0, _log.userAssert)(option.mediaQuery, 'All options except for the last must have a media condition');\n      } else {\n        (0, _log.userAssert)(!option.mediaQuery, 'The last option must not have a media condition');\n      }\n    }\n  }\n  /**\n   * Selects the first size that matches media conditions. If no options match,\n   * the last option is returned.\n   *\n   * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n   * @param {!Window} win\n   * @return {!./layout.LengthDef|string}\n   */\n\n\n  var _proto = SizeList.prototype;\n\n  _proto.select = function select(win) {\n    var sizes = this.sizes_;\n    var length = sizes.length - 1; // Iterate all but the last size\n\n    for (var i = 0; i < length; i++) {\n      var option = sizes[i]; // Only the last item (which we don't iterate) has an undefined\n      // mediaQuery.\n\n      var query =\n      /** @type {string} */\n      option.mediaQuery;\n\n      if (win.matchMedia(query).matches) {\n        return option.size;\n      }\n    } // Returns the last size in the SizeList, which is the default.\n\n\n    return sizes[length].size;\n  };\n\n  return SizeList;\n}();\n\nexports.SizeList = SizeList;\n\n},{\"./layout\":66,\"./log\":68}],125:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.htmlFor = htmlFor;\nexports.svgFor = svgFor;\nexports.htmlRefs = htmlRefs;\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object.js\");\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar htmlContainer;\nvar svgContainer;\n/**\n * Creates the html helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\n\nfunction htmlFor(nodeOrDoc) {\n  var doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n\n  if (!htmlContainer || htmlContainer.ownerDocument !== doc) {\n    htmlContainer = doc.createElement('div');\n  }\n\n  return html;\n}\n/**\n * Creates the svg helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\n\n\nfunction svgFor(nodeOrDoc) {\n  var doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n\n  if (!svgContainer || svgContainer.ownerDocument !== svgContainer) {\n    svgContainer = doc.createElementNS('http://www.w3.org/2000/svg', 'svg');\n  }\n\n  return svg;\n}\n/**\n * A tagged template literal helper to generate static SVG trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const circle = svg`<circle cx=\"60\" cy=\"60\" r=\"22\"></circle>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\n\n\nfunction svg(strings) {\n  return createNode(svgContainer, strings);\n}\n/**\n * A tagged template literal helper to generate static DOM trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const div = html`<div><span></span></div>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\n\n\nfunction html(strings) {\n  return createNode(htmlContainer, strings);\n}\n/**\n * Helper used by html and svg string literal functions.\n * @param {!Element} container\n * @param {!Array<string>} strings\n * @return {!Element}\n */\n\n\nfunction createNode(container, strings) {\n  (0, _log.devAssert)(strings.length === 1, 'Improper html template tag usage.');\n  container.\n  /*OK*/\n  innerHTML = strings[0];\n  var el = container.firstElementChild;\n  (0, _log.devAssert)(el, 'No elements in template');\n  (0, _log.devAssert)(!el.nextElementSibling, 'Too many root elements in template'); // Clear to free memory.\n\n  container.removeChild(el);\n  return el;\n}\n/**\n * Queries an element for all elements with a \"ref\" attribute, removing\n * the attribute afterwards.\n * Returns a named map of all ref elements.\n *\n * @param {!Element} root\n * @return {!Object<string, !Element>}\n */\n\n\nfunction htmlRefs(root) {\n  var elements = root.querySelectorAll('[ref]');\n  var refs = (0, _object.map)();\n\n  for (var i = 0; i < elements.length; i++) {\n    var element = elements[i];\n    var ref = (0, _log.devAssert)(element.getAttribute('ref'), 'Empty ref attr');\n    element.removeAttribute('ref');\n    (0, _log.devAssert)(refs[ref] === undefined, 'Duplicate ref');\n    refs[ref] = element;\n  }\n\n  return refs;\n}\n\n},{\"./log\":68,\"./utils/object.js\":145}],126:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.dashToCamelCase = dashToCamelCase;\nexports.camelCaseToDash = camelCaseToDash;\nexports.dashToUnderline = dashToUnderline;\nexports.endsWith = endsWith;\nexports.startsWith = startsWith;\nexports.includes = includes;\nexports.expandTemplate = expandTemplate;\nexports.stringHash32 = stringHash32;\nexports.trimEnd = trimEnd;\nexports.trimStart = trimStart;\nexports.padStart = padStart;\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} _match\n * @param {string} character\n * @return {string}\n */\nfunction toUpperCase(_match, character) {\n  return character.toUpperCase();\n}\n/**\n * @param {string} match\n * @return {string}\n */\n\n\nfunction prependDashAndToLowerCase(match) {\n  return '-' + match.toLowerCase();\n}\n/**\n * @param {string} name Attribute name containing dashes.\n * @return {string} Dashes removed and successive character sent to upper case.\n * visibleForTesting\n */\n\n\nfunction dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, toUpperCase);\n}\n/**\n * Converts a string that is in camelCase to one that is in dash-case.\n *\n * @param {string} string The string to convert.\n * @return {string} The string in dash-case.\n */\n\n\nfunction camelCaseToDash(string) {\n  return string.replace(/(?!^)[A-Z]/g, prependDashAndToLowerCase);\n}\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes replaced by underlines.\n */\n\n\nfunction dashToUnderline(name) {\n  return name.replace('-', '_');\n}\n/**\n * Polyfill for String.prototype.endsWith.\n * @param {string} string\n * @param {string} suffix\n * @return {boolean}\n */\n\n\nfunction endsWith(string, suffix) {\n  var index = string.length - suffix.length;\n  return index >= 0 && string.indexOf(suffix, index) == index;\n}\n/**\n * Polyfill for String.prototype.startsWith.\n * @param {string} string\n * @param {string} prefix\n * @return {boolean}\n */\n\n\nfunction startsWith(string, prefix) {\n  if (prefix.length > string.length) {\n    return false;\n  }\n\n  return string.lastIndexOf(prefix, 0) == 0;\n}\n/**\n * Polyfill for String.prototype.includes.\n * @param {string} string\n * @param {string} substring\n * @param {number=} start\n * @return {boolean}\n */\n\n\nfunction includes(string, substring, start) {\n  if (typeof start !== 'number') {\n    start = 0;\n  }\n\n  if (start + substring.length > string.length) {\n    return false;\n  }\n\n  return string.indexOf(substring, start) !== -1;\n}\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=} opt_maxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n * @return {string}\n */\n\n\nfunction expandTemplate(template, getter, opt_maxIterations) {\n  var maxIterations = opt_maxIterations || 1;\n\n  var _loop = function _loop(i) {\n    var matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, function (_a, b) {\n      matches++;\n      return getter(b);\n    });\n\n    if (!matches) {\n      return \"break\";\n    }\n  };\n\n  for (var i = 0; i < maxIterations; i++) {\n    var _ret = _loop(i);\n\n    if (_ret === \"break\") break;\n  }\n\n  return template;\n}\n/**\n * Hash function djb2a\n * This is intended to be a simple, fast hashing function using minimal code.\n * It does *not* have good cryptographic properties.\n * @param {string} str\n * @return {string} 32-bit unsigned hash of the string\n */\n\n\nfunction stringHash32(str) {\n  var length = str.length;\n  var hash = 5381;\n\n  for (var i = 0; i < length; i++) {\n    hash = hash * 33 ^ str.charCodeAt(i);\n  } // Convert from 32-bit signed to unsigned.\n\n\n  return String(hash >>> 0);\n}\n/**\n * Trims a string on the end, removing whitespace characters.\n * @param {string} str  A string to trim.\n * @return {string} The string, with trailing whitespace removed.\n */\n\n\nfunction trimEnd(str) {\n  // TODO(sparhami) Does this get inlined for an ES2019 build?\n  if (str.trimEnd) {\n    return str.trimEnd();\n  }\n\n  return ('_' + str).trim().slice(1);\n}\n/**\n * Trims any leading whitespace from a string.\n * @param {string} str  A string to trim.\n * @return {string} The string, with leading whitespace removed.\n */\n\n\nfunction trimStart(str) {\n  if (str.trimStart) {\n    return str.trimStart();\n  }\n\n  return (str + '_').trim().slice(0, -1);\n}\n/**\n * Pads the beginning of a string with a substring to a target length.\n * @param {string} s\n * @param {number} targetLength\n * @param {string} padString\n * @return {*} TODO(#23582): Specify return type\n */\n\n\nfunction padStart(s, targetLength, padString) {\n  if (s.length >= targetLength) {\n    return s;\n  }\n\n  targetLength = targetLength - s.length;\n  var padding = padString;\n\n  while (targetLength > padding.length) {\n    padding += padString;\n  }\n\n  return padding.slice(0, targetLength) + s;\n}\n\n},{}],127:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.installStylesForDoc = installStylesForDoc;\nexports.installStylesLegacy = installStylesLegacy;\nexports.installCssTransformer = installCssTransformer;\nexports.setBodyMadeVisibleForTesting = setBodyMadeVisibleForTesting;\nexports.makeBodyVisible = makeBodyVisible;\nexports.makeBodyVisibleRecovery = makeBodyVisibleRecovery;\nexports.bodyAlwaysVisible = bodyAlwaysVisible;\n\nvar _commonSignals = require(\"./common-signals\");\n\nvar _services = require(\"./services\");\n\nvar _log = require(\"./log\");\n\nvar _service = require(\"./service\");\n\nvar _dom = require(\"./dom\");\n\nvar _object = require(\"./utils/object\");\n\nvar _style = require(\"./style\");\n\nvar _renderDelayingServices = require(\"./render-delaying-services\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar TRANSFORMER_PROP = '__AMP_CSS_TR';\nvar STYLE_MAP_PROP = '__AMP_CSS_SM';\n/**\n * Adds the given css text to the given ampdoc.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc The ampdoc that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\n\nfunction installStylesForDoc(ampdoc, cssText, cb, opt_isRuntimeCss, opt_ext) {\n  var cssRoot = ampdoc.getHeadNode();\n  var style = insertStyleElement(cssRoot, maybeTransform(cssRoot, cssText), opt_isRuntimeCss || false, opt_ext || null);\n\n  if (cb) {\n    var rootNode = ampdoc.getRootNode(); // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n\n    if (styleLoaded(rootNode, style)) {\n      cb(style);\n      return style;\n    } // Poll until styles are available.\n\n\n    var interval = setInterval(function () {\n      if (styleLoaded(rootNode, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n\n  return style;\n}\n/**\n * Adds the given css text to the given document.\n * TODO(dvoytenko, #22733): Remove this method once FIE/ampdoc migration is\n * done.\n *\n * @param {!Document} doc The document that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are\n *     available. Not using a promise, because this is synchronous when\n *     possible. for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\n\n\nfunction installStylesLegacy(doc, cssText, cb, opt_isRuntimeCss, opt_ext) {\n  var style = insertStyleElement((0, _log.dev)().assertElement(doc.head), cssText, opt_isRuntimeCss || false, opt_ext || null);\n\n  if (cb) {\n    // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n    if (styleLoaded(doc, style)) {\n      cb(style);\n      return style;\n    } // Poll until styles are available.\n\n\n    var interval = setInterval(function () {\n      if (styleLoaded(doc, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n\n  return style;\n}\n/**\n * Creates the properly configured style element.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @param {boolean} isRuntimeCss\n * @param {?string} ext\n * @return {!Element}\n */\n\n\nfunction insertStyleElement(cssRoot, cssText, isRuntimeCss, ext) {\n  var styleMap = cssRoot[STYLE_MAP_PROP];\n\n  if (!styleMap) {\n    styleMap = cssRoot[STYLE_MAP_PROP] = (0, _object.map)();\n  }\n\n  var isExtCss = !isRuntimeCss && ext && ext != 'amp-custom' && ext != 'amp-keyframes';\n  var key = isRuntimeCss ? 'amp-runtime' : isExtCss ? \"amp-extension=\" + ext : null; // Check if it has already been created or discovered.\n\n  if (key) {\n    var existing = getExistingStyleElement(cssRoot, styleMap, key);\n\n    if (existing) {\n      if (existing.textContent !== cssText) {\n        existing.textContent = cssText;\n      }\n\n      return existing;\n    }\n  } // Create the new style element and append to cssRoot.\n\n\n  var doc = cssRoot.ownerDocument || cssRoot;\n  var style = doc.createElement('style');\n  style.\n  /*OK*/\n  textContent = cssText;\n  var afterElement = null; // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n\n  if (isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else if (isExtCss) {\n    style.setAttribute('amp-extension', ext || '');\n    afterElement = (0, _log.dev)().assertElement(getExistingStyleElement(cssRoot, styleMap, 'amp-runtime'));\n  } else {\n    if (ext) {\n      style.setAttribute(ext, '');\n    }\n\n    afterElement = cssRoot.lastChild;\n  }\n\n  (0, _dom.insertAfterOrAtStart)(cssRoot, style, afterElement);\n\n  if (key) {\n    styleMap[key] = style;\n  }\n\n  return style;\n}\n/**\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {!Object<string, !Element>} styleMap\n * @param {string} key\n * @return {?Element}\n */\n\n\nfunction getExistingStyleElement(cssRoot, styleMap, key) {\n  // Already cached.\n  if (styleMap[key]) {\n    return styleMap[key];\n  } // Check if the style has already been added by the server layout.\n\n\n  var existing = cssRoot.\n  /*OK*/\n  querySelector(\"style[\" + key + \"]\");\n\n  if (existing) {\n    styleMap[key] = existing;\n    return existing;\n  } // Nothing found.\n\n\n  return null;\n}\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {function(string):string} transformer\n */\n\n\nfunction installCssTransformer(cssRoot, transformer) {\n  cssRoot[TRANSFORMER_PROP] = transformer;\n}\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @return {string}\n */\n\n\nfunction maybeTransform(cssRoot, cssText) {\n  var transformer = cssRoot[TRANSFORMER_PROP];\n  return transformer ? transformer(cssText) : cssText;\n}\n/** @private {boolean} */\n\n\nvar bodyMadeVisible = false;\n/**\n * @param {boolean} value\n * @visibleForTesting\n */\n\nfunction setBodyMadeVisibleForTesting(value) {\n  bodyMadeVisible = value;\n}\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\n\n\nfunction makeBodyVisible(doc) {\n  (0, _log.devAssert)(doc.defaultView, 'Passed in document must have a defaultView');\n  var win =\n  /** @type {!Window} */\n  doc.defaultView;\n  (0, _dom.waitForBodyOpenPromise)(doc).then(function () {\n    return (0, _renderDelayingServices.waitForServices)(win);\n  }).catch(function (reason) {\n    (0, _log.rethrowAsync)(reason);\n    return [];\n  }).then(function (services) {\n    bodyMadeVisible = true;\n    setBodyVisibleStyles(doc);\n    var ampdoc = (0, _service.getAmpdoc)(doc);\n    ampdoc.signals().signal(_commonSignals.CommonSignals.RENDER_START);\n\n    if (services.length > 0) {\n      var resources = _services.Services.resourcesForDoc(doc.documentElement);\n\n      resources.\n      /*OK*/\n      schedulePass(1,\n      /* relayoutAll */\n      true);\n    }\n\n    try {\n      var perf = _services.Services.performanceFor(win);\n\n      perf.tick('mbv');\n      perf.flush();\n    } catch (e) {}\n  });\n}\n/**\n * Set the document's body opacity to 1. Called in error cases.\n * @param {!Document} doc The document who's body we should make visible.\n */\n\n\nfunction makeBodyVisibleRecovery(doc) {\n  (0, _log.devAssert)(doc.defaultView, 'Passed in document must have a defaultView');\n\n  if (bodyMadeVisible) {\n    return;\n  }\n\n  bodyMadeVisible = true;\n  setBodyVisibleStyles(doc);\n}\n/**\n * Make sure that body exists, and make it visible.\n * @param {!Document} doc\n */\n\n\nfunction setBodyVisibleStyles(doc) {\n  (0, _style.setStyles)((0, _log.dev)().assertElement(doc.body), {\n    opacity: 1,\n    visibility: 'visible',\n    'animation': 'none'\n  });\n}\n/**\n * Indicates that the body is always visible. For instance, in case of PWA.\n * This check is on a module level variable, and could be problematic if you are\n * relying on this function across different binaries.\n * @param {!Window} unusedWin\n */\n\n\nfunction bodyAlwaysVisible(unusedWin) {\n  bodyMadeVisible = true;\n}\n/**\n * Checks whether a style element was registered in the DOM.\n * @param {!Document|!ShadowRoot} doc\n * @param {!Element} style\n * @return {boolean}\n */\n\n\nfunction styleLoaded(doc, style) {\n  var sheets = doc.styleSheets;\n\n  for (var i = 0; i < sheets.length; i++) {\n    var sheet = sheets[i];\n\n    if (sheet.ownerNode == style) {\n      return true;\n    }\n  }\n\n  return false;\n}\n\n},{\"./common-signals\":31,\"./dom\":41,\"./log\":68,\"./render-delaying-services\":78,\"./service\":79,\"./services\":123,\"./style\":128,\"./utils/object\":145}],128:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.camelCaseToTitleCase = camelCaseToTitleCase;\nexports.getVendorJsPropertyName = getVendorJsPropertyName;\nexports.setImportantStyles = setImportantStyles;\nexports.setStyle = setStyle;\nexports.getStyle = getStyle;\nexports.setStyles = setStyles;\nexports.assertNotDisplay = assertNotDisplay;\nexports.assertDoesNotContainDisplay = assertDoesNotContainDisplay;\nexports.setInitialDisplay = setInitialDisplay;\nexports.toggle = toggle;\nexports.px = px;\nexports.deg = deg;\nexports.translateX = translateX;\nexports.translate = translate;\nexports.scale = scale;\nexports.rotate = rotate;\nexports.removeAlphaFromColor = removeAlphaFromColor;\nexports.computedStyle = computedStyle;\nexports.resetStyles = resetStyles;\nexports.propagateObjectFitStyles = propagateObjectFitStyles;\n\nvar _log = require(\"./log\");\n\nvar _object = require(\"./utils/object.js\");\n\nvar _string = require(\"./string\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\n\n/** @type {Object<string, string>} */\nvar propertyNameCache;\n/** @const {!Array<string>} */\n\nvar vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n/**\n * @export\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\n\nfunction camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n/**\n  Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\n\n\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (var i = 0; i < vendorPrefixes.length; i++) {\n    var propertyName = vendorPrefixes[i] + titleCase;\n\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n\n  return '';\n}\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @export\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\n\n\nfunction getVendorJsPropertyName(style, camelCase, opt_bypassCache) {\n  if ((0, _string.startsWith)(camelCase, '--')) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n\n  if (!propertyNameCache) {\n    propertyNameCache = (0, _object.map)();\n  }\n\n  var propertyName = propertyNameCache[camelCase];\n\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n\n    if (style[camelCase] === undefined) {\n      var titleCase = camelCaseToTitleCase(camelCase);\n      var prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n\n    if (!opt_bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n\n  return propertyName;\n}\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\n\n\nfunction setImportantStyles(element, styles) {\n  var style = element.style;\n\n  for (var k in styles) {\n    style.setProperty(getVendorJsPropertyName(style, k), styles[k].toString(), 'important');\n  }\n}\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {?Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\n\n\nfunction setStyle(element, property, value, opt_units, opt_bypassCache) {\n  var propertyName = getVendorJsPropertyName(element.style, property, opt_bypassCache);\n\n  if (propertyName) {\n    element.style[propertyName] =\n    /** @type {string} */\n    opt_units ? value + opt_units : value;\n  }\n}\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\n\n\nfunction getStyle(element, property, opt_bypassCache) {\n  var propertyName = getVendorJsPropertyName(element.style, property, opt_bypassCache);\n\n  if (!propertyName) {\n    return undefined;\n  }\n\n  return element.style[propertyName];\n}\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\n\n\nfunction setStyles(element, styles) {\n  for (var k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n/**\n * Asserts that the style is not the `display` style.\n * This is the only possible way to pass a dynamic style to setStyle.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {string} style\n * @return {string}\n */\n\n\nfunction assertNotDisplay(style) {\n  if (style === 'display') {\n    (0, _log.dev)().error('STYLE', '`display` style detected. You must use toggle instead.');\n  }\n\n  return style;\n}\n/**\n * Asserts that the styles does not contain the `display` style.\n * This is the only possible way to pass a dynamic styles object to setStyles\n * and setImportantStyles.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {!Object<string, *>} styles\n * @return {!Object<string, *>}\n */\n\n\nfunction assertDoesNotContainDisplay(styles) {\n  if ('display' in styles) {\n    (0, _log.dev)().error('STYLE', '`display` style detected in styles. You must use toggle instead.');\n  }\n\n  return styles;\n}\n/**\n * Sets the initial display style of an element. This is a last resort. If you\n * can set the initial display using CSS, YOU MUST.\n * DO NOT USE THIS TO ARBITRARILY SET THE DISPLAY STYLE AFTER INITIAL SETUP.\n *\n * @param {!Element} el\n * @param {string} value\n */\n\n\nfunction setInitialDisplay(el, value) {\n  var style = el.style;\n  (0, _log.devAssert)(value !== '' && value !== 'none', 'Initial display value must not be \"none\". Use toggle instead.');\n  (0, _log.devAssert)(!style['display'], 'setInitialDisplay MUST NOT be used for ' + 'resetting the display style. If you are looking for display:none ' + 'toggling, use toggle instead.');\n  style['display'] = value;\n}\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\n\n\nfunction toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = element.hasAttribute('hidden');\n  }\n\n  if (opt_display) {\n    element.removeAttribute('hidden');\n  } else {\n    element.setAttribute('hidden', '');\n  }\n}\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\n\n\nfunction px(value) {\n  return value + \"px\";\n}\n/**\n * Returns a degree value.\n * @param {number} value\n * @return {string}\n */\n\n\nfunction deg(value) {\n  return value + \"deg\";\n}\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\n\n\nfunction translateX(value) {\n  if (typeof value == 'string') {\n    return \"translateX(\" + value + \")\";\n  }\n\n  return \"translateX(\" + px(value) + \")\";\n}\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\n\n\nfunction translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n\n  if (opt_y === undefined) {\n    return \"translate(\" + x + \")\";\n  }\n\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n\n  return \"translate(\" + x + \", \" + opt_y + \")\";\n}\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\n\n\nfunction scale(value) {\n  return \"scale(\" + value + \")\";\n}\n/**\n * Returns a \"rotate\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\n\n\nfunction rotate(value) {\n  if (typeof value == 'number') {\n    value = deg(value);\n  }\n\n  return \"rotate(\" + value + \")\";\n}\n/**\n * Remove alpha value from a rgba color value.\n * Return the new color property with alpha equals if has the alpha value.\n * Caller needs to make sure the input color value is a valid rgba/rgb value\n * @param {string} rgbaColor\n * @return {string}\n */\n\n\nfunction removeAlphaFromColor(rgbaColor) {\n  return rgbaColor.replace(/\\(([^,]+),([^,]+),([^,)]+),[^)]+\\)/g, '($1,$2,$3, 1)');\n}\n/**\n * Gets the computed style of the element. The helper is necessary to enforce\n * the possible `null` value returned by a buggy Firefox.\n *\n * @param {!Window} win\n * @param {!Element} el\n * @return {!Object<string, string>}\n */\n\n\nfunction computedStyle(win, el) {\n  var style =\n  /** @type {?CSSStyleDeclaration} */\n  win.getComputedStyle(el);\n  return (\n    /** @type {!Object<string, string>} */\n    style || (0, _object.map)()\n  );\n}\n/**\n * Resets styles that were set dynamically (i.e. inline)\n * @param {!Element} element\n * @param {!Array<string>} properties\n */\n\n\nfunction resetStyles(element, properties) {\n  for (var i = 0; i < properties.length; i++) {\n    setStyle(element, properties[i], null);\n  }\n}\n/**\n * Propagates the object-fit/position element attributes as styles.\n * @param {!Element} fromEl ie: amp-img\n * @param {!Element} toEl ie: the img within amp-img\n */\n\n\nfunction propagateObjectFitStyles(fromEl, toEl) {\n  if (fromEl.hasAttribute('object-fit')) {\n    setStyle(toEl, 'object-fit', fromEl.getAttribute('object-fit'));\n  }\n\n  if (fromEl.hasAttribute('object-position')) {\n    setStyle(toEl, 'object-position', fromEl.getAttribute('object-position'));\n  }\n}\n\n},{\"./log\":68,\"./string\":126,\"./utils/object.js\":145}],129:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.normtimeDef = exports.timeDef = void 0;\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Absolute time in milliseconds.\n * @typedef {number}\n */\nvar timeDef;\n/**\n * Number between 0 and 1 that designates normalized time, as in \"from start to\n * end\".\n * @typedef {number}\n */\n\nexports.timeDef = timeDef;\nvar normtimeDef;\nexports.normtimeDef = normtimeDef;\n\n},{}],130:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.all = all;\nexports.concat = concat;\nexports.withCurve = withCurve;\nexports.setStyles = setStyles;\nexports.numeric = numeric;\nexports.spring = spring;\nexports.px = px;\nexports.translateX = translateX;\nexports.translateY = translateY;\nexports.translate = translate;\nexports.scale = scale;\nexports.NOOP = void 0;\n\nvar st = _interopRequireWildcard(require(\"./style\"));\n\nvar _curve = require(\"./curve\");\n\nfunction _getRequireWildcardCache() { if (typeof WeakMap !== \"function\") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar NOOP = function NOOP(unusedTime) {\n  return null;\n};\n/**\n * Returns a transition that combines a number of other transitions and\n * invokes them all in parallel.\n * @param {!Array<!TransitionDef>} transitions\n * @return {!TransitionDef<void>}\n */\n\n\nexports.NOOP = NOOP;\n\nfunction all(transitions) {\n  return function (time, complete) {\n    for (var i = 0; i < transitions.length; i++) {\n      var tr = transitions[i];\n      tr(time, complete);\n    }\n  };\n}\n/**\n * Returns a transition that combines the string result of other string-based\n * transitions such as transform and scale using the given opt_delimiter.\n * @param {!Array<!TransitionDef<string>>} transitions\n * @param {string=} opt_delimiter Defaults to a single whitespace.\n * @return {!TransitionDef<string>}\n */\n\n\nfunction concat(transitions, opt_delimiter) {\n  if (opt_delimiter === void 0) {\n    opt_delimiter = ' ';\n  }\n\n  return function (time, complete) {\n    var results = [];\n\n    for (var i = 0; i < transitions.length; i++) {\n      var tr = transitions[i];\n      var result = tr(time, complete);\n\n      if (typeof result == 'string') {\n        results.push(result);\n      }\n    }\n\n    return results.join(opt_delimiter);\n  };\n}\n/**\n * Returns the specified transition with the time curved via specified curve\n * function.\n * @param {!TransitionDef<RESULT>} transition\n * @param {!./curve.CurveDef|string} curve\n * @return {!TransitionDef<RESULT>}\n * @template RESULT\n */\n\n\nfunction withCurve(transition, curve) {\n  /** @const {?./curve.CurveDef} */\n  var curveFn = (0, _curve.getCurve)(curve);\n  return function (time, complete) {\n    return transition(complete ? 1 : curveFn(time), complete);\n  };\n}\n/**\n * A transition that sets the CSS style of the specified element. The styles\n * a specified as a map from CSS property names to transition functions for\n * each of these properties.\n * @param {!Element} element\n * @param {!Object<string, !TransitionDef>} styles\n * @return {!TransitionDef<void>}\n */\n\n\nfunction setStyles(element, styles) {\n  return function (time, complete) {\n    for (var k in styles) {\n      (0, st.setStyle)(element, (0, st.assertNotDisplay)(k), styles[k](time, complete));\n    }\n  };\n}\n/**\n * A basic numeric interpolation.\n * @param {number} start\n * @param {number} end\n * @return {!TransitionDef<number>}\n */\n\n\nfunction numeric(start, end) {\n  return function (time) {\n    return start + (end - start) * time;\n  };\n}\n/**\n * Spring numeric interpolation.\n * @param {number} start\n * @param {number} end\n * @param {number} extended\n * @param {number} threshold\n * @return {!TransitionDef<number>}\n */\n\n\nfunction spring(start, end, extended, threshold) {\n  if (end == extended) {\n    return function (time) {\n      return numeric(start, end)(time);\n    };\n  }\n\n  return function (time) {\n    if (time < threshold) {\n      return start + (extended - start) * (time / threshold);\n    }\n\n    return extended + (end - extended) * ((time - threshold) / (1 - threshold));\n  };\n}\n/**\n * Adds \"px\" units.\n * @param {!TransitionDef<number>} transition\n * @return {!TransitionDef<string>}\n */\n\n\nfunction px(transition) {\n  return function (time) {\n    return transition(time) + 'px';\n  };\n}\n/**\n * A transition for \"translateX\" of CSS \"transform\" property.\n * @param {!TransitionDef<number|string>} transition\n * @return {!TransitionDef<string>}\n */\n\n\nfunction translateX(transition) {\n  return function (time) {\n    var res = transition(time);\n\n    if (typeof res == 'string') {\n      return \"translateX(\" + res + \")\";\n    }\n\n    return \"translateX(\" + res + \"px)\";\n  };\n}\n/**\n * A transition for \"translateY\" of CSS \"transform\" property.\n * @param {!TransitionDef<number|string>} transition\n * @return {!TransitionDef<string>}\n */\n\n\nfunction translateY(transition) {\n  return function (time) {\n    var res = transition(time);\n\n    if (typeof res == 'string') {\n      return \"translateY(\" + res + \")\";\n    }\n\n    return \"translateY(\" + res + \"px)\";\n  };\n}\n/**\n * A transition for \"translate(x, y)\" of CSS \"transform\" property.\n * @param {!TransitionDef<number|string>} transitionX\n * @param {!TransitionDef<number|string>|undefined} opt_transitionY\n * @return {!TransitionDef<string>}\n */\n\n\nfunction translate(transitionX, opt_transitionY) {\n  return function (time) {\n    var x = transitionX(time);\n\n    if (typeof x == 'number') {\n      x = st.px(x);\n    }\n\n    if (!opt_transitionY) {\n      return \"translate(\" + x + \")\";\n    }\n\n    var y = opt_transitionY(time);\n\n    if (typeof y == 'number') {\n      y = st.px(y);\n    }\n\n    return \"translate(\" + x + \",\" + y + \")\";\n  };\n}\n/**\n * A transition for \"scale\" of CSS \"transform\" property.\n * @param {!TransitionDef<number|string>} transition\n * @return {!TransitionDef<string>}\n */\n\n\nfunction scale(transition) {\n  return function (time) {\n    return \"scale(\" + transition(time) + \")\";\n  };\n}\n\n},{\"./curve\":37,\"./style\":128}],131:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.isArray = isArray;\nexports.toArray = toArray;\nexports.isObject = isObject;\nexports.isFiniteNumber = isFiniteNumber;\nexports.isEnumValue = isEnumValue;\nexports.toWin = toWin;\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* @const */\nvar toString_ = Object.prototype.toString;\n/**\n * Returns the ECMA [[Class]] of a value\n * @param {*} value\n * @return {string}\n */\n\nfunction toString(value) {\n  return toString_.call(value);\n}\n/**\n * Determines if value is actually an Array.\n * @param {*} value\n * @return {boolean}\n */\n\n\nfunction isArray(value) {\n  return Array.isArray(value);\n}\n/**\n * Converts an array-like object to an array.\n * @param {?IArrayLike<T>|string} arrayLike\n * @return {!Array<T>}\n * @template T\n */\n\n\nfunction toArray(arrayLike) {\n  return arrayLike ? Array.prototype.slice.call(arrayLike) : [];\n}\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\n\n\nfunction isObject(value) {\n  return toString(value) === '[object Object]';\n}\n/**\n * Determines if value is of number type and finite.\n * NaN and Infinity are not considered a finite number.\n * String numbers are not considered numbers.\n * @param {*} value\n * @return {boolean}\n */\n\n\nfunction isFiniteNumber(value) {\n  return typeof value === 'number' && isFinite(value);\n}\n/**\n * Checks whether `s` is a valid value of `enumObj`.\n *\n * @param {!Object<T>} enumObj\n * @param {T} s\n * @return {boolean}\n * @template T\n */\n\n\nfunction isEnumValue(enumObj, s) {\n  for (var k in enumObj) {\n    if (enumObj[k] === s) {\n      return true;\n    }\n  }\n\n  return false;\n}\n/**\n * Externs declare that access `defaultView` from `document` or\n * `ownerDocument` is of type `(Window|null)` but most of our parameter types\n * assume that it is never null. This is OK in practice as we ever only get\n * null on disconnected documents or old IE.\n * This helper function casts it into just a simple Window return type.\n *\n * @param {!Window|null} winOrNull\n * @return {!Window}\n */\n\n\nfunction toWin(winOrNull) {\n  return (\n    /** @type {!Window} */\n    winOrNull\n  );\n}\n\n},{}],132:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.parseQueryString_ = parseQueryString_;\n\nvar _urlTryDecodeUriComponent = require(\"./url-try-decode-uri-component\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nvar regex = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * DO NOT import the function from this file. Instead, import parseQueryString\n * from `src/url.js`.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\n\nfunction parseQueryString_(queryString) {\n  var params =\n  /** @type {!JsonObject} */\n  Object.create(null);\n\n  if (!queryString) {\n    return params;\n  }\n\n  var match;\n\n  while (match = regex.exec(queryString)) {\n    var name = (0, _urlTryDecodeUriComponent.tryDecodeUriComponent_)(match[1], match[1]);\n    var value = match[2] ? (0, _urlTryDecodeUriComponent.tryDecodeUriComponent_)(match[2].replace(/\\+/g, ' '), match[2]) : '';\n    params[name] = value;\n  }\n\n  return params;\n}\n\n},{\"./url-try-decode-uri-component\":133}],133:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.tryDecodeUriComponent_ = tryDecodeUriComponent_;\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * DO NOT import the function from this file. Instead, import\n * tryDecodeUriComponent from `src/url.js`.\n *\n * @param {string} component\n * @param {string=} fallback\n * @return {string}\n */\nfunction tryDecodeUriComponent_(component, fallback) {\n  if (fallback === void 0) {\n    fallback = '';\n  }\n\n  try {\n    return decodeURIComponent(component);\n  } catch (e) {\n    return fallback;\n  }\n}\n\n},{}],134:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getWinOrigin = getWinOrigin;\nexports.parseUrlDeprecated = parseUrlDeprecated;\nexports.parseUrlWithA = parseUrlWithA;\nexports.appendEncodedParamStringToUrl = appendEncodedParamStringToUrl;\nexports.addParamToUrl = addParamToUrl;\nexports.addParamsToUrl = addParamsToUrl;\nexports.addMissingParamsToUrl = addMissingParamsToUrl;\nexports.serializeQueryString = serializeQueryString;\nexports.isSecureUrlDeprecated = isSecureUrlDeprecated;\nexports.assertHttpsUrl = assertHttpsUrl;\nexports.assertAbsoluteHttpOrHttpsUrl = assertAbsoluteHttpOrHttpsUrl;\nexports.parseQueryString = parseQueryString;\nexports.removeFragment = removeFragment;\nexports.getFragment = getFragment;\nexports.isProxyOrigin = isProxyOrigin;\nexports.getProxyServingType = getProxyServingType;\nexports.isLocalhostOrigin = isLocalhostOrigin;\nexports.isProtocolValid = isProtocolValid;\nexports.removeAmpJsParamsFromUrl = removeAmpJsParamsFromUrl;\nexports.removeSearch = removeSearch;\nexports.removeParamsFromSearch = removeParamsFromSearch;\nexports.getSourceUrl = getSourceUrl;\nexports.getSourceOrigin = getSourceOrigin;\nexports.resolveRelativeUrl = resolveRelativeUrl;\nexports.resolveRelativeUrlFallback_ = resolveRelativeUrlFallback_;\nexports.getCorsUrl = getCorsUrl;\nexports.checkCorsUrl = checkCorsUrl;\nexports.tryDecodeUriComponent = tryDecodeUriComponent;\nexports.SOURCE_ORIGIN_PARAM = void 0;\n\nvar _lruCache = require(\"./utils/lru-cache\");\n\nvar _object = require(\"./utils/object\");\n\nvar _string = require(\"./string\");\n\nvar _mode = require(\"./mode\");\n\nvar _types = require(\"./types\");\n\nvar _urlParseQueryString = require(\"./url-parse-query-string\");\n\nvar _urlTryDecodeUriComponent = require(\"./url-try-decode-uri-component\");\n\nvar _config = require(\"./config\");\n\nvar _log = require(\"./log\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @type {!JsonObject}\n */\nvar SERVING_TYPE_PREFIX = (0, _object.dict)({\n  // No viewer\n  'c': true,\n  // In viewer\n  'v': true,\n  // Ad landing page\n  'a': true,\n  // Ad\n  'ad': true,\n  // Actions viewer\n  'action': true\n});\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\n\nvar a;\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {LruCache}\n */\n\nvar cache;\n/** @private @const Matches amp_js_* parameters in query string. */\n\nvar AMP_JS_PARAMS_REGEX = /[?&]amp_js[^&]*/;\n/** @private @const Matches amp_gsa parameters in query string. */\n\nvar AMP_GSA_PARAMS_REGEX = /[?&]amp_gsa[^&]*/;\n/** @private @const Matches amp_r parameters in query string. */\n\nvar AMP_R_PARAMS_REGEX = /[?&]amp_r[^&]*/;\n/** @private @const Matches amp_kit parameters in query string. */\n\nvar AMP_KIT_PARAMS_REGEX = /[?&]amp_kit[^&]*/;\n/** @private @const Matches usqp parameters from goog experiment in query string. */\n\nvar GOOGLE_EXPERIMENT_PARAMS_REGEX = /[?&]usqp[^&]*/;\nvar INVALID_PROTOCOLS = [\n/*eslint no-script-url: 0*/\n'javascript:',\n/*eslint no-script-url: 0*/\n'data:',\n/*eslint no-script-url: 0*/\n'vbscript:'];\n/** @const {string} */\n\nvar SOURCE_ORIGIN_PARAM = '__amp_source_origin';\n/**\n * Returns the correct origin for a given window.\n * @param {!Window} win\n * @return {string} origin\n */\n\nexports.SOURCE_ORIGIN_PARAM = SOURCE_ORIGIN_PARAM;\n\nfunction getWinOrigin(win) {\n  return win.origin || parseUrlDeprecated(win.location.href).origin;\n}\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {string} url\n * @param {boolean=} opt_nocache\n * @return {!Location}\n */\n\n\nfunction parseUrlDeprecated(url, opt_nocache) {\n  if (!a) {\n    a =\n    /** @type {!HTMLAnchorElement} */\n    self.document.createElement('a');\n    cache = self.__AMP_URL_CACHE || (self.__AMP_URL_CACHE = new _lruCache.LruCache(100));\n  }\n\n  return parseUrlWithA(a, url, opt_nocache ? null : cache);\n}\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {!HTMLAnchorElement} a\n * @param {string} url\n * @param {LruCache=} opt_cache\n * @return {!Location}\n * @restricted\n */\n\n\nfunction parseUrlWithA(a, url, opt_cache) {\n  if (opt_cache && opt_cache.has(url)) {\n    return opt_cache.get(url);\n  }\n\n  a.href = url; // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick #3449.\n\n  if (!a.protocol) {\n    a.href = a.href;\n  }\n\n  var info =\n  /** @type {!Location} */\n  {\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash,\n    origin: null // Set below.\n\n  }; // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  } // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n\n\n  if (info.protocol == 'http:' && info.port == 80 || info.protocol == 'https:' && info.port == 443) {\n    info.port = '';\n    info.host = info.hostname;\n  } // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n\n\n  var origin;\n\n  if (a.origin && a.origin != 'null') {\n    origin = a.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    origin = info.href;\n  } else {\n    origin = info.protocol + '//' + info.host;\n  }\n\n  info.origin = origin; // Freeze during testing to avoid accidental mutation.\n\n  var frozen = (0, _mode.getMode)().test && Object.freeze ? Object.freeze(info) : info;\n\n  if (opt_cache) {\n    opt_cache.put(url, frozen);\n  }\n\n  return frozen;\n}\n/**\n * Appends the string just before the fragment part (or optionally\n * to the front of the query string) of the URL.\n * @param {string} url\n * @param {string} paramString\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\n\n\nfunction appendEncodedParamStringToUrl(url, paramString, opt_addToFront) {\n  if (!paramString) {\n    return url;\n  }\n\n  var mainAndFragment = url.split('#', 2);\n  var mainAndQuery = mainAndFragment[0].split('?', 2);\n  var newUrl = mainAndQuery[0] + (mainAndQuery[1] ? opt_addToFront ? \"?\" + paramString + \"&\" + mainAndQuery[1] : \"?\" + mainAndQuery[1] + \"&\" + paramString : \"?\" + paramString);\n  newUrl += mainAndFragment[1] ? \"#\" + mainAndFragment[1] : '';\n  return newUrl;\n}\n/**\n * Appends a query string field and value to a url. `key` and `value`\n * will be ran through `encodeURIComponent` before appending.\n * @param {string} url\n * @param {string} key\n * @param {string} value\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\n\n\nfunction addParamToUrl(url, key, value, opt_addToFront) {\n  var field = encodeURIComponent(key) + \"=\" + encodeURIComponent(value);\n  return appendEncodedParamStringToUrl(url, field, opt_addToFront);\n}\n/**\n * Appends query string fields and values to a url. The `params` objects'\n * `key`s and `value`s will be transformed into query string keys/values.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\n\n\nfunction addParamsToUrl(url, params) {\n  return appendEncodedParamStringToUrl(url, serializeQueryString(params));\n}\n/**\n * Append query string fields and values to a url, only if the key does not\n * exist in current query string.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\n\n\nfunction addMissingParamsToUrl(url, params) {\n  var location = parseUrlDeprecated(url);\n  var existingParams = parseQueryString(location.search);\n  var paramsToAdd = (0, _object.dict)({});\n  var keys = Object.keys(params);\n\n  for (var i = 0; i < keys.length; i++) {\n    if (!(0, _object.hasOwn)(existingParams, keys[i])) {\n      paramsToAdd[keys[i]] = params[keys[i]];\n    }\n  }\n\n  return addParamsToUrl(url, paramsToAdd);\n}\n/**\n * Serializes the passed parameter map into a query string with both keys\n * and values encoded.\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\n\n\nfunction serializeQueryString(params) {\n  var s = [];\n\n  for (var k in params) {\n    var v = params[k];\n\n    if (v == null) {\n      continue;\n    } else if ((0, _types.isArray)(v)) {\n      for (var i = 0; i < v.length; i++) {\n        var sv =\n        /** @type {string} */\n        v[i];\n        s.push(encodeURIComponent(k) + \"=\" + encodeURIComponent(sv));\n      }\n    } else {\n      var _sv =\n      /** @type {string} */\n      v;\n      s.push(encodeURIComponent(k) + \"=\" + encodeURIComponent(_sv));\n    }\n  }\n\n  return s.join('&');\n}\n/**\n * Returns `true` if the URL is secure: either HTTPS or localhost (for testing).\n * @param {string|!Location} url\n * @return {boolean}\n */\n\n\nfunction isSecureUrlDeprecated(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  return url.protocol == 'https:' || url.hostname == 'localhost' || url.hostname == '127.0.0.1' || (0, _string.endsWith)(url.hostname, '.localhost');\n}\n/**\n * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n * assert.\n *\n * Provides an exception for localhost.\n *\n * @param {?string|undefined} urlString\n * @param {!Element|string} elementContext Element where the url was found.\n * @param {string=} sourceName Used for error messages.\n * @return {string}\n */\n\n\nfunction assertHttpsUrl(urlString, elementContext, sourceName) {\n  if (sourceName === void 0) {\n    sourceName = 'source';\n  }\n\n  (0, _log.userAssert)(urlString != null, '%s %s must be available', elementContext, sourceName); // (erwinm, #4560): type cast necessary until #4560 is fixed.\n\n  var theUrlString =\n  /** @type {string} */\n  urlString;\n  (0, _log.userAssert)(isSecureUrlDeprecated(theUrlString) || /^(\\/\\/)/.test(theUrlString), '%s %s must start with ' + '\"https://\" or \"//\" or be relative and served from ' + 'either https or from localhost. Invalid value: %s', elementContext, sourceName, theUrlString);\n  return theUrlString;\n}\n/**\n * Asserts that a given url is an absolute HTTP or HTTPS URL.\n * @param {string} urlString\n * @return {string}\n */\n\n\nfunction assertAbsoluteHttpOrHttpsUrl(urlString) {\n  (0, _log.userAssert)(/^https?\\:/i.test(urlString), 'URL must start with \"http://\" or \"https://\". Invalid value: %s', urlString);\n  return parseUrlDeprecated(urlString).href;\n}\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * This function is implemented in a separate file to avoid a circular\n * dependency.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\n\n\nfunction parseQueryString(queryString) {\n  return (0, _urlParseQueryString.parseQueryString_)(queryString);\n}\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\n\n\nfunction removeFragment(url) {\n  var index = url.indexOf('#');\n\n  if (index == -1) {\n    return url;\n  }\n\n  return url.substring(0, index);\n}\n/**\n * Returns the fragment from the URL. If the URL doesn't contain fragment,\n * the empty string is returned.\n * @param {string} url\n * @return {string}\n */\n\n\nfunction getFragment(url) {\n  var index = url.indexOf('#');\n\n  if (index == -1) {\n    return '';\n  }\n\n  return url.substring(index);\n}\n/**\n * Returns whether the URL has the origin of a proxy.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\n\n\nfunction isProxyOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  return _config.urls.cdnProxyRegex.test(url.origin);\n}\n/**\n * For proxy-origin URLs, returns the serving type. Otherwise, returns null.\n * E.g., 'https://amp-com.cdn.ampproject.org/a/s/amp.com/amp_document.html'\n * returns 'a'.\n * @param {string|!Location} url URL of an AMP document.\n * @return {?string}\n */\n\n\nfunction getProxyServingType(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  if (!isProxyOrigin(url)) {\n    return null;\n  }\n\n  var path = url.pathname.split('/', 2);\n  return path[1];\n}\n/**\n * Returns whether the URL origin is localhost.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\n\n\nfunction isLocalhostOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  return _config.urls.localhostRegex.test(url.origin);\n}\n/**\n * Returns whether the URL has valid protocol.\n * Deep link protocol is valid, but not javascript etc.\n * @param {string|!Location} url\n * @return {boolean}\n */\n\n\nfunction isProtocolValid(url) {\n  if (!url) {\n    return true;\n  }\n\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  return !INVALID_PROTOCOLS.includes(url.protocol);\n}\n/**\n * Returns a URL without AMP JS parameters.\n * @param {string} url\n * @return {string}\n */\n\n\nfunction removeAmpJsParamsFromUrl(url) {\n  var parsed = parseUrlDeprecated(url);\n  var search = removeAmpJsParamsFromSearch(parsed.search);\n  return parsed.origin + parsed.pathname + search + parsed.hash;\n}\n/**\n * Returns a URL without a query string.\n * @param {string} url\n * @return {string}\n */\n\n\nfunction removeSearch(url) {\n  var index = url.indexOf('?');\n\n  if (index == -1) {\n    return url;\n  }\n\n  var fragment = getFragment(url);\n  return url.substring(0, index) + fragment;\n}\n/**\n * Removes parameters that start with amp js parameter pattern and returns the\n * new search string.\n * @param {string} urlSearch\n * @return {string}\n */\n\n\nfunction removeAmpJsParamsFromSearch(urlSearch) {\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n\n  var search = urlSearch.replace(AMP_JS_PARAMS_REGEX, '').replace(AMP_GSA_PARAMS_REGEX, '').replace(AMP_R_PARAMS_REGEX, '').replace(AMP_KIT_PARAMS_REGEX, '').replace(GOOGLE_EXPERIMENT_PARAMS_REGEX, '').replace(/^[?&]/, ''); // Removes first ? or &.\n\n  return search ? '?' + search : '';\n}\n/**\n * Removes parameters with param name and returns the new search string.\n * @param {string} urlSearch\n * @param {string} paramName\n * @return {string}\n */\n\n\nfunction removeParamsFromSearch(urlSearch, paramName) {\n  // TODO: reuse the function in removeAmpJsParamsFromSearch. Accept paramNames\n  // as an array.\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n\n  var paramRegex = new RegExp(\"[?&]\" + paramName + \"=[^&]*\", 'g');\n  var search = urlSearch.replace(paramRegex, '').replace(/^[?&]/, '');\n  return search ? '?' + search : '';\n}\n/**\n * Returns the source URL of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string}\n */\n\n\nfunction getSourceUrl(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  } // Not a proxy URL - return the URL itself.\n\n\n  if (!isProxyOrigin(url)) {\n    return url.href;\n  } // A proxy URL.\n  // Example path that is being matched here.\n  // https://cdn.ampproject.org/c/s/www.origin.com/foo/\n  // The /s/ is optional and signals a secure origin.\n\n\n  var path = url.pathname.split('/');\n  var prefix = path[1];\n  (0, _log.userAssert)(SERVING_TYPE_PREFIX[prefix], 'Unknown path prefix in url %s', url.href);\n  var domainOrHttpsSignal = path[2];\n  var origin = domainOrHttpsSignal == 's' ? 'https://' + decodeURIComponent(path[3]) : 'http://' + decodeURIComponent(domainOrHttpsSignal); // Sanity test that what we found looks like a domain.\n\n  (0, _log.userAssert)(origin.indexOf('.') > 0, 'Expected a . in origin %s', origin);\n  path.splice(1, domainOrHttpsSignal == 's' ? 3 : 2);\n  return origin + path.join('/') + removeAmpJsParamsFromSearch(url.search) + (url.hash || '');\n}\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n */\n\n\nfunction getSourceOrigin(url) {\n  return parseUrlDeprecated(getSourceUrl(url)).origin;\n}\n/**\n * Returns absolute URL resolved based on the relative URL and the base.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n */\n\n\nfunction resolveRelativeUrl(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n\n  if (typeof URL == 'function') {\n    return new URL(relativeUrlString, baseUrl.href).toString();\n  }\n\n  return resolveRelativeUrlFallback_(relativeUrlString, baseUrl);\n}\n/**\n * Fallback for URL resolver when URL class is not available.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n * @private Visible for testing.\n */\n\n\nfunction resolveRelativeUrlFallback_(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n\n  relativeUrlString = relativeUrlString.replace(/\\\\/g, '/');\n  var relativeUrl = parseUrlDeprecated(relativeUrlString); // Absolute URL.\n\n  if ((0, _string.startsWith)(relativeUrlString.toLowerCase(), relativeUrl.protocol)) {\n    return relativeUrl.href;\n  } // Protocol-relative URL.\n\n\n  if ((0, _string.startsWith)(relativeUrlString, '//')) {\n    return baseUrl.protocol + relativeUrlString;\n  } // Absolute path.\n\n\n  if ((0, _string.startsWith)(relativeUrlString, '/')) {\n    return baseUrl.origin + relativeUrlString;\n  } // Relative path.\n\n\n  return baseUrl.origin + baseUrl.pathname.replace(/\\/[^/]*$/, '/') + relativeUrlString;\n}\n/**\n * Add \"__amp_source_origin\" query parameter to the URL.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\n\n\nfunction getCorsUrl(win, url) {\n  checkCorsUrl(url);\n  var sourceOrigin = getSourceOrigin(win.location.href);\n  return addParamToUrl(url, SOURCE_ORIGIN_PARAM, sourceOrigin);\n}\n/**\n * Checks if the url has __amp_source_origin and throws if it does.\n * @param {string} url\n */\n\n\nfunction checkCorsUrl(url) {\n  var parsedUrl = parseUrlDeprecated(url);\n  var query = parseQueryString(parsedUrl.search);\n  (0, _log.userAssert)(!(SOURCE_ORIGIN_PARAM in query), 'Source origin is not allowed in %s', url);\n}\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * @param {string} component\n * @param {string=} opt_fallback\n * @return {string}\n */\n\n\nfunction tryDecodeUriComponent(component, opt_fallback) {\n  return (0, _urlTryDecodeUriComponent.tryDecodeUriComponent_)(component, opt_fallback);\n}\n\n},{\"./config\":32,\"./log\":68,\"./mode\":70,\"./string\":126,\"./types\":131,\"./url-parse-query-string\":132,\"./url-try-decode-uri-component\":133,\"./utils/lru-cache\":143,\"./utils/object\":145}],135:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.areEqualOrdered = areEqualOrdered;\nexports.remove = remove;\nexports.findIndex = findIndex;\nexports.fromIterator = fromIterator;\nexports.pushIfNotExist = pushIfNotExist;\nexports.lastItem = lastItem;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Compares if two arrays contains exactly same elements of same number\n * of same order. Note that it does NOT handle NaN case as expected.\n *\n * @param {!Array<T>} arr1\n * @param {!Array<T>} arr2\n * @return {boolean}\n * @template T\n */\nfunction areEqualOrdered(arr1, arr2) {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n\n  for (var i = 0; i < arr1.length; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n\n  return true;\n}\n/**\n * Removes elements that shouldRemove returns true for from the array.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} shouldRemove\n * @return {!Array<T>}\n * @template T\n */\n\n\nfunction remove(array, shouldRemove) {\n  var removed = [];\n  var index = 0;\n\n  for (var i = 0; i < array.length; i++) {\n    var item = array[i];\n\n    if (shouldRemove(item, i, array)) {\n      removed.push(item);\n    } else {\n      if (index < i) {\n        array[index] = item;\n      }\n\n      index++;\n    }\n  }\n\n  if (index < array.length) {\n    array.length = index;\n  }\n\n  return removed;\n}\n/**\n * Returns the index of the first element matching the predicate.\n * Like Array#findIndex.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {number}\n * @template T\n */\n\n\nfunction findIndex(array, predicate) {\n  for (var i = 0; i < array.length; i++) {\n    if (predicate(array[i], i, array)) {\n      return i;\n    }\n  }\n\n  return -1;\n}\n/**\n * Converts the given iterator to an array.\n *\n * @param {!Iterator<T>} iterator\n * @return {Array<T>}\n * @template T\n */\n\n\nfunction fromIterator(iterator) {\n  var array = [];\n\n  for (var e = iterator.next(); !e.done; e = iterator.next()) {\n    array.push(e.value);\n  }\n\n  return array;\n}\n/**\n * Adds item to array if it is not already present.\n *\n * @param {Array<T>} array\n * @param {T} item\n * @template T\n */\n\n\nfunction pushIfNotExist(array, item) {\n  if (array.indexOf(item) < 0) {\n    array.push(item);\n  }\n}\n/**\n * Returns the last item in an array.\n *\n * @param {Array<T>} array\n * @template T\n * @return {?T}\n */\n\n\nfunction lastItem(array) {\n  return array[array.length - 1];\n}\n\n},{}],136:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.base64UrlDecodeToBytes = base64UrlDecodeToBytes;\nexports.base64DecodeToBytes = base64DecodeToBytes;\nexports.base64UrlEncodeFromBytes = base64UrlEncodeFromBytes;\nexports.base64UrlEncodeFromString = base64UrlEncodeFromString;\nexports.base64UrlDecodeFromString = base64UrlDecodeFromString;\nexports.base64EncodeFromBytes = base64EncodeFromBytes;\n\nvar _bytes = require(\"./bytes\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Character mapping from base64url to base64.\n * @const {!Object<string, string>}\n */\nvar base64UrlDecodeSubs = {\n  '-': '+',\n  '_': '/',\n  '.': '='\n};\n/**\n * Character mapping from base64 to base64url.\n * @const {!Object<string, string>}\n */\n\nvar base64UrlEncodeSubs = {\n  '+': '-',\n  '/': '_',\n  '=': '.'\n};\n/**\n * Converts a string which is in base64url encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\n\nfunction base64UrlDecodeToBytes(str) {\n  var encoded = atob(str.replace(/[-_.]/g, function (ch) {\n    return base64UrlDecodeSubs[ch];\n  }));\n  return (0, _bytes.stringToBytes)(encoded);\n}\n/**\n * Converts a string which is in base64 encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\n\n\nfunction base64DecodeToBytes(str) {\n  return (0, _bytes.stringToBytes)(atob(str));\n}\n/**\n * Converts a bytes array into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {!Uint8Array} bytes\n * @return {string}\n */\n\n\nfunction base64UrlEncodeFromBytes(bytes) {\n  var str = (0, _bytes.bytesToString)(bytes);\n  return btoa(str).replace(/[+/=]/g, function (ch) {\n    return base64UrlEncodeSubs[ch];\n  });\n}\n/**\n * Converts a string into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {string} str\n * @return {string}\n */\n\n\nfunction base64UrlEncodeFromString(str) {\n  var bytes = (0, _bytes.utf8Encode)(str);\n  return base64UrlEncodeFromBytes(bytes);\n}\n/**\n * Decode a base64url encoded string by `base64UrlEncodeFromString`\n * @param {string} str\n * @return {string}\n */\n\n\nfunction base64UrlDecodeFromString(str) {\n  var bytes = base64UrlDecodeToBytes(str);\n  return (0, _bytes.utf8Decode)(bytes);\n}\n/**\n * Converts a bytes array into base64 encoded string.\n * @param {!Uint8Array} bytes\n * @return {string}\n */\n\n\nfunction base64EncodeFromBytes(bytes) {\n  return btoa((0, _bytes.bytesToString)(bytes));\n}\n\n},{\"./bytes\":137}],137:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.utf8Decode = utf8Decode;\nexports.utf8Encode = utf8Encode;\nexports.stringToBytes = stringToBytes;\nexports.bytesToString = bytesToString;\nexports.bytesToUInt32 = bytesToUInt32;\nexports.getCryptoRandomBytesArray = getCryptoRandomBytesArray;\n\nvar _log = require(\"../log\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Interpret a byte array as a UTF-8 string.\n * @param {!BufferSource} bytes\n * @return {string}\n */\nfunction utf8Decode(bytes) {\n  if (typeof TextDecoder !== 'undefined') {\n    return new TextDecoder('utf-8').decode(bytes);\n  }\n\n  var asciiString = bytesToString(new Uint8Array(bytes.buffer || bytes));\n  return decodeURIComponent(escape(asciiString));\n}\n/**\n * Turn a string into UTF-8 bytes.\n * @param {string} string\n * @return {!Uint8Array}\n */\n\n\nfunction utf8Encode(string) {\n  if (typeof TextEncoder !== 'undefined') {\n    return new TextEncoder('utf-8').encode(string);\n  }\n\n  return stringToBytes(unescape(encodeURIComponent(string)));\n}\n/**\n * Converts a string which holds 8-bit code points, such as the result of atob,\n * into a Uint8Array with the corresponding bytes.\n * If you have a string of characters, you probably want to be using utf8Encode.\n * @param {string} str\n * @return {!Uint8Array}\n */\n\n\nfunction stringToBytes(str) {\n  var bytes = new Uint8Array(str.length);\n\n  for (var i = 0; i < str.length; i++) {\n    var charCode = str.charCodeAt(i);\n    (0, _log.devAssert)(charCode <= 255, 'Characters must be in range [0,255]');\n    bytes[i] = charCode;\n  }\n\n  return bytes;\n}\n/**\n * Converts a 8-bit bytes array into a string\n * @param {!Uint8Array} bytes\n * @return {string}\n */\n\n\nfunction bytesToString(bytes) {\n  // Intentionally avoids String.fromCharCode.apply so we don't suffer a\n  // stack overflow. #10495, https://jsperf.com/bytesToString-2\n  var array = new Array(bytes.length);\n\n  for (var i = 0; i < bytes.length; i++) {\n    array[i] = String.fromCharCode(bytes[i]);\n  }\n\n  return array.join('');\n}\n/**\n * Converts a 4-item byte array to an unsigned integer.\n * Assumes bytes are big endian.\n * @param {!Uint8Array} bytes\n * @return {number}\n */\n\n\nfunction bytesToUInt32(bytes) {\n  if (bytes.length != 4) {\n    throw new Error('Received byte array with length != 4');\n  }\n\n  var val = (bytes[0] & 0xff) << 24 | (bytes[1] & 0xff) << 16 | (bytes[2] & 0xff) << 8 | bytes[3] & 0xff; // Convert to unsigned.\n\n  return val >>> 0;\n}\n/**\n * Generate a random bytes array with specific length using\n * win.crypto.getRandomValues. Return null if it is not available.\n * @param {!Window} win\n * @param {number} length\n * @return {?Uint8Array}\n */\n\n\nfunction getCryptoRandomBytesArray(win, length) {\n  if (!win.crypto || !win.crypto.getRandomValues) {\n    return null;\n  } // Widely available in browsers we support:\n  // http://caniuse.com/#search=getRandomValues\n\n\n  var uint8array = new Uint8Array(length);\n  win.crypto.getRandomValues(uint8array);\n  return uint8array;\n}\n\n},{\"../log\":68}],138:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.getDocumentVisibilityState = getDocumentVisibilityState;\nexports.isDocumentHidden = isDocumentHidden;\nexports.addDocumentVisibilityChangeListener = addDocumentVisibilityChangeListener;\nexports.removeDocumentVisibilityChangeListener = removeDocumentVisibilityChangeListener;\n\nvar _visibilityState = require(\"../visibility-state\");\n\nvar _style = require(\"../style\");\n\n/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {!Document} doc\n * @return {!VisibilityState}\n */\nfunction getDocumentVisibilityState(doc) {\n  // New API: `document.visibilityState` property.\n  var visibilityStateProp = (0, _style.getVendorJsPropertyName)(doc, 'visibilityState', true);\n\n  if (doc[visibilityStateProp]) {\n    return doc[visibilityStateProp];\n  } // Old API: `document.hidden` property.\n\n\n  var hiddenProp = (0, _style.getVendorJsPropertyName)(doc, 'hidden', true);\n\n  if (doc[hiddenProp]) {\n    return doc[hiddenProp] ? _visibilityState.VisibilityState.HIDDEN : _visibilityState.VisibilityState.VISIBLE;\n  }\n\n  return _visibilityState.VisibilityState.VISIBLE;\n}\n/**\n * Returns the value of \"document.hidden\" property. The reasons why it may\n * not be visible include document in a non-active tab or when the document\n * is being pre-rendered via link with rel=\"prerender\".\n * @param {!Document} doc\n * @return {boolean}\n */\n\n\nfunction isDocumentHidden(doc) {\n  return getDocumentVisibilityState(doc) != _visibilityState.VisibilityState.VISIBLE;\n}\n/**\n * @param {!Document} doc\n * @param {function()} handler\n */\n\n\nfunction addDocumentVisibilityChangeListener(doc, handler) {\n  if (!doc.addEventListener) {\n    return;\n  }\n\n  var visibilityChangeEvent = getVisibilityChangeEvent(doc);\n\n  if (visibilityChangeEvent) {\n    doc.addEventListener(visibilityChangeEvent, handler);\n  }\n}\n/**\n * @param {!Document} doc\n * @param {function()} handler\n */\n\n\nfunction removeDocumentVisibilityChangeListener(doc, handler) {\n  if (!doc.removeEventListener) {\n    return;\n  }\n\n  var visibilityChangeEvent = getVisibilityChangeEvent(doc);\n\n  if (visibilityChangeEvent) {\n    doc.removeEventListener(visibilityChangeEvent, handler);\n  }\n}\n/**\n * @param {!Document} doc\n * @return {?string}\n */\n\n\nfunction getVisibilityChangeEvent(doc) {\n  var hiddenProp = (0, _style.getVendorJsPropertyName)(doc, 'hidden', true);\n  var vendorStop = hiddenProp.indexOf('Hidden');\n  return vendorStop != -1 ? hiddenProp.substring(0, vendorStop) + 'Visibilitychange' : 'visibilitychange';\n}\n\n},{\"../style\":128,\"../visibility-state\":151}],139:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.domFingerprintPlain = domFingerprintPlain;\nexports.DomFingerprint = void 0;\n\nvar _string = require(\"../string\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Gets a string of concatenated element names and relative positions\n * of the DOM element and its parentElement's (up to 25).  Relative position\n * is the index of nodes with this tag within the parent's children.\n * The order is from the inner to outer nodes in DOM hierarchy.\n *\n * If a DOM hierarchy is the following:\n *\n * <div id='id1' ...>\n *   <div id='id2' ...>\n *     <table ...>       // table:0\n *       <tr>            // tr:0\n *         <td>...</td>  // td:0\n *         <td>          // td:1\n *           <amp-ad ...></amp-ad>\n *         </td>\n *       </tr>\n *       <tr>...</tr>    // tr:1\n *     </table>\n *   </div>\n * </div>\n *\n * With the amp-ad element passed in:\n * 'amp-ad.0,td.1,tr.0,table.0,div/id2.0,div/id1.0'\n *\n * Note: 25 is chosen arbitrarily.\n *\n * @param {?Element} element DOM node from which to get fingerprint.\n * @return {string} Concatenated element ids.\n */\nfunction domFingerprintPlain(element) {\n  var ids = [];\n  var level = 0;\n\n  while (element && element.nodeType ==\n  /* element */\n  1 && level < 25) {\n    var id = '';\n\n    if (element.id) {\n      id = \"/\" + element.id;\n    }\n\n    var nodeName = element.nodeName.toLowerCase();\n    ids.push(\"\" + nodeName + id + indexWithinParent(element));\n    level++;\n    element = element.parentElement;\n  }\n\n  return ids.join();\n}\n\nvar DomFingerprint =\n/*#__PURE__*/\nfunction () {\n  function DomFingerprint() {}\n\n  /**\n   * Calculates ad slot DOM fingerprint.  This key is intended to\n   * identify \"same\" ad unit across many page views. This is\n   * based on where the ad appears within the page's DOM structure.\n   *\n   * @param {?Element} element The DOM element from which to collect\n   *     the DOM chain element IDs.  If null, DOM chain element IDs are not\n   *     included in the hash.\n   * @return {string} The ad unit hash key string.\n   */\n  DomFingerprint.generate = function generate(element) {\n    return (0, _string.stringHash32)(domFingerprintPlain(element));\n  };\n\n  return DomFingerprint;\n}();\n/**\n * Gets a string showing the index of an element within\n * the children of its parent, counting only nodes with the same tag.\n * Stop at 25, just to have a limit.\n * @param {!Element} element DOM node to get index of.\n * @return {string} '.<index>' or ''.\n */\n\n\nexports.DomFingerprint = DomFingerprint;\n\nfunction indexWithinParent(element) {\n  var nodeName = element.nodeName; // Find my index within my parent's children\n\n  var i = 0;\n  var count = 0;\n  var sibling = element.previousElementSibling; // Different browsers have different children.\n  // So count only nodes with the same tag.\n  // Use a limit for the tags, so that different browsers get the same\n  // count. So 25 and higher all return no index.\n\n  while (sibling && count < 25 && i < 100) {\n    if (sibling.nodeName == nodeName) {\n      count++;\n    }\n\n    i++;\n    sibling = sibling.previousElementSibling;\n  } // If we got to the end, then the count is accurate; otherwise skip count.\n\n\n  return count < 25 && i < 100 ? \".\" + count : '';\n}\n\n},{\"../string\":126}],140:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.once = once;\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n// TODO(rsimha, #15334): Enable this rule.\n\n/* eslint jsdoc/check-types: 0 */\n\n/**\n * Creates a function that is evaluated only once and returns the cached result\n * subsequently.\n *\n * Please note that `once` only takes the function definition into account,\n * so it will return the same cached value even when the arguments are\n * different.\n *\n * @param {function(...):T} fn\n * @return {function(...):T}\n * @template T\n */\nfunction once(fn) {\n  var evaluated = false;\n  var retValue = null;\n  var callback = fn;\n  return function () {\n    if (!evaluated) {\n      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n        args[_key] = arguments[_key];\n      }\n\n      retValue = callback.apply(self, args);\n      evaluated = true;\n      callback = null; // GC\n    }\n\n    return retValue;\n  };\n}\n\n},{}],141:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.guaranteeSrcForSrcsetUnsupportedBrowsers = guaranteeSrcForSrcsetUnsupportedBrowsers;\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Sets the img src to the first url in the srcset if srcset is defined but\n * src is not for browsers that do not support srcset.\n * @param {!Element} img\n */\nfunction guaranteeSrcForSrcsetUnsupportedBrowsers(img) {\n  // The <img> tag does not have a src and does not support srcset\n  if (!img.hasAttribute('src') && 'srcset' in img == false) {\n    var srcset = img.getAttribute('srcset');\n    var matches = /\\S+/.exec(srcset);\n\n    if (matches == null) {\n      return;\n    }\n\n    var srcseturl = matches[0];\n    img.setAttribute('src', srcseturl);\n  }\n}\n\n},{}],142:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.Keys = exports.KeyCodes = void 0;\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @enum {number}\n */\nvar KeyCodes = {\n  ENTER: 13,\n  ESCAPE: 27,\n  SPACE: 32,\n  LEFT_ARROW: 37,\n  UP_ARROW: 38,\n  RIGHT_ARROW: 39,\n  DOWN_ARROW: 40\n};\n/**\n * @enum {string}\n */\n\nexports.KeyCodes = KeyCodes;\nvar Keys = {\n  ENTER: 'Enter',\n  ESCAPE: 'Escape',\n  SPACE: ' ',\n  LEFT_ARROW: 'ArrowLeft',\n  UP_ARROW: 'ArrowUp',\n  RIGHT_ARROW: 'ArrowRight',\n  DOWN_ARROW: 'ArrowDown',\n  TAB: 'Tab',\n  BACKSPACE: 'Backspace',\n  HOME: 'Home',\n  END: 'End'\n};\nexports.Keys = Keys;\n\n},{}],143:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.LruCache = void 0;\n\nvar _log = require(\"../log\");\n\n/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const {string} */\nvar TAG = 'lru-cache';\n/**\n * @template T\n */\n\nvar LruCache =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {number} capacity\n   */\n  function LruCache(capacity) {\n    /** @private @const {number} */\n    this.capacity_ = capacity;\n    /** @private {number} */\n\n    this.size_ = 0;\n    /**\n     * An incrementing counter to define the last access.\n     * @private {number}\n     */\n\n    this.access_ = 0;\n    /** @private {!Object<(number|string), {payload: T, access: number}>} */\n\n    this.cache_ = Object.create(null);\n  }\n  /**\n   * Returns whether key is cached.\n   *\n   * @param {number|string} key\n   * @return {boolean}\n   */\n\n\n  var _proto = LruCache.prototype;\n\n  _proto.has = function has(key) {\n    return !!this.cache_[key];\n  }\n  /**\n   * @param {number|string} key\n   * @return {T} The cached payload.\n   */\n  ;\n\n  _proto.get = function get(key) {\n    var cacheable = this.cache_[key];\n\n    if (cacheable) {\n      cacheable.access = ++this.access_;\n      return cacheable.payload;\n    }\n\n    return undefined;\n  }\n  /**\n   * @param {number|string} key\n   * @param {T} payload The payload to cache.\n   */\n  ;\n\n  _proto.put = function put(key, payload) {\n    if (!this.has(key)) {\n      this.size_++;\n    }\n\n    this.cache_[key] = {\n      payload: payload,\n      access: this.access_\n    };\n    this.evict_();\n  }\n  /**\n   * Evicts the oldest cache entry, if we've exceeded capacity.\n   */\n  ;\n\n  _proto.evict_ = function evict_() {\n    if (this.size_ <= this.capacity_) {\n      return;\n    }\n\n    (0, _log.dev)().warn(TAG, 'Trimming LRU cache');\n    var cache = this.cache_;\n    var oldest = this.access_ + 1;\n    var oldestKey;\n\n    for (var key in cache) {\n      var access = cache[key].access;\n\n      if (access < oldest) {\n        oldest = access;\n        oldestKey = key;\n      }\n    }\n\n    if (oldestKey !== undefined) {\n      delete cache[oldestKey];\n      this.size_--;\n    }\n  };\n\n  return LruCache;\n}();\n\nexports.LruCache = LruCache;\n\n},{\"../log\":68}],144:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.mapRange = mapRange;\nexports.mod = mod;\nexports.clamp = clamp;\nexports.boundValue = boundValue;\nexports.magnitude = magnitude;\nexports.distance = distance;\nexports.polarToCartesian = polarToCartesian;\nexports.sum = sum;\n\nvar _log = require(\"../log\");\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Maps a value in a first range to its equivalent in a second range\n * Ex.: 5 in the range [0,10] gives 60 in the range[40,80]\n *\n * NOTE: lower/upper bounds on the source range are detected automatically,\n * however the bounds on the target range are not altered (thus the target\n * range could be decreasing).\n * Ex1: 8 in the range [0, 10] gives 2 in the range [10, 0]\n * Ex2: also, 8 in the range [10, 0] gives 2 in the range [10, 0]\n *\n * NOTE: Input value is enforced to be bounded inside the source range\n * Ex1: -2 in the range [0, 10] is interpreted as 0 and thus gives 40 in [40,80]\n * Ex2: 19 in the range [0, 5] is interpreted as 5 and thus gives 80 in [40,80]\n *\n * @param {number} val the value in the source range\n * @param {number} min1 the lower bound of the source range\n * @param {number} max1 the upper bound of the source range\n * @param {number} min2 the lower bound of the target range\n * @param {number} max2 the upper bound of the target range\n * @return {number} the equivalent value in the target range\n */\nfunction mapRange(val, min1, max1, min2, max2) {\n  var max1Bound = max1;\n  var min1Bound = min1;\n\n  if (min1 > max1) {\n    max1Bound = min1;\n    min1Bound = max1;\n  }\n\n  if (val < min1Bound) {\n    val = min1Bound;\n  } else if (val > max1Bound) {\n    val = max1Bound;\n  }\n\n  return (val - min1) * (max2 - min2) / (max1 - min1) + min2;\n}\n/**\n * Computes the modulus of values `a` and `b`.\n *\n * This is needed because the % operator in JavaScript doesn't implement\n * modulus behavior as can be seen by the spec here:\n * http://www.ecma-international.org/ecma-262/5.1/#sec-11.5.3.\n * It instead is used to obtain the remainder of a division.\n * This function uses the remainder (%) operator to determine the modulus.\n * Derived from here:\n * https://stackoverflow.com/questions/25726760/javascript-modular-arithmetic/47354356#47354356\n *\n * @param {number} a\n * @param {number} b\n * @return {number} returns the modulus of the two numbers.\n * @example\n *\n * _.min(10, 5);\n * // => 0\n *\n * _.mod(-1, 5);\n * // => 4\n */\n\n\nfunction mod(a, b) {\n  return a > 0 && b > 0 ? a % b : (a % b + b) % b;\n}\n/**\n * Restricts a number to be in the given min/max range. The minimum value must\n * be less than or equal to the maximum value.\n *\n * Examples:\n * clamp(0.5, 0, 1) -> 0.5\n * clamp(1.5, 0, 1) -> 1\n * clamp(-0.5, 0, 1) -> 0\n *\n * @param {number} val the value to clamp.\n * @param {number} min the lower bound.\n * @param {number} max the upper bound.\n * @return {number} the clamped value.\n */\n\n\nfunction clamp(val, min, max) {\n  (0, _log.devAssert)(min <= max, 'Minimum value is greater than the maximum.');\n  return Math.min(Math.max(val, min), max);\n}\n/**\n * Returns value bound to min and max values +/- extent. The lower bound must\n * be less than or equal to the upper bound.\n * @param {number} val the value to bound.\n * @param {number} min the lower bound.\n * @param {number} max the upper bound\n * @param {number} extent the allowed extent beyond the bounds.\n * @return {number} the bounded value.\n */\n\n\nfunction boundValue(val, min, max, extent) {\n  (0, _log.devAssert)(min <= max, 'Lower bound is greater than the upper bound.');\n  return clamp(val, min - extent, max + extent);\n}\n/**\n * Returns the length of a vector given in X- and Y-coordinates.\n * @param {number} deltaX distance in the X direction.\n * @param {number} deltaY distance in the Y direction.\n * @return {number} the magnitude of the vector.\n */\n\n\nfunction magnitude(deltaX, deltaY) {\n  return Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n}\n/**\n * Returns the distance between two points.\n * @param {number} x1 X-coordinate of the first point.\n * @param {number} y1 Y-coordinate of the first point.\n * @param {number} x2 X-coordinate of the second point.\n * @param {number} y2 Y-coordinate of the second point.\n * @return {number} the distance between the two points.\n */\n\n\nfunction distance(x1, y1, x2, y2) {\n  return magnitude(x2 - x1, y2 - y1);\n}\n/**\n * @param {number} centerX\n * @param {number} centerY\n * @param {number} radius\n * @param {number} angleInDegrees\n * @return {{\n *  x: number,\n *  y: number,\n * }}\n */\n\n\nfunction polarToCartesian(centerX, centerY, radius, angleInDegrees) {\n  var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;\n  return {\n    x: centerX + radius * Math.cos(angleInRadians),\n    y: centerY + radius * Math.sin(angleInRadians)\n  };\n}\n/**\n * Sums up the values of the given array and returns the result\n * @param {Array<number>} values\n * @return {number}\n */\n\n\nfunction sum(values) {\n  return values.reduce(function (a, b) {\n    return a + b;\n  });\n}\n\n},{\"../log\":68}],145:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.map = map;\nexports.dict = dict;\nexports.hasOwn = hasOwn;\nexports.ownProperty = ownProperty;\nexports.deepMerge = deepMerge;\nexports.omit = omit;\n\nvar _types = require(\"../types\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* @const */\nvar hasOwn_ = Object.prototype.hasOwnProperty;\n/**\n * Returns a map-like object.\n * If opt_initial is provided, copies its own properties into the\n * newly created object.\n * @param {T=} opt_initial This should typically be an object literal.\n * @return {T}\n * @template T\n */\n\nfunction map(opt_initial) {\n  var obj = Object.create(null);\n\n  if (opt_initial) {\n    Object.assign(obj, opt_initial);\n  }\n\n  return obj;\n}\n/**\n * Return an empty JsonObject or makes the passed in object literal\n * an JsonObject.\n * The JsonObject type is just a simple object that is at-dict.\n * See\n * https://github.com/google/closure-compiler/wiki/@struct-and-@dict-Annotations\n * for what a dict is type-wise.\n * The linter enforces that the argument is, in fact, at-dict like.\n * @param {!Object=} opt_initial\n * @return {!JsonObject}\n */\n\n\nfunction dict(opt_initial) {\n  // We do not copy. The linter enforces that the passed in object is a literal\n  // and thus the caller cannot have a reference to it.\n  return (\n    /** @type {!JsonObject} */\n    opt_initial || {}\n  );\n}\n/**\n * Checks if the given key is a property in the map.\n *\n * @param {T}  obj a map like property.\n * @param {string}  key\n * @return {boolean}\n * @template T\n */\n\n\nfunction hasOwn(obj, key) {\n  return hasOwn_.call(obj, key);\n}\n/**\n * Returns obj[key] iff key is obj's own property (is not inherited).\n * Otherwise, returns undefined.\n *\n * @param {Object} obj\n * @param {string} key\n * @return {*}\n */\n\n\nfunction ownProperty(obj, key) {\n  if (hasOwn(obj, key)) {\n    return obj[key];\n  } else {\n    return undefined;\n  }\n}\n/**\n * Deep merges source into target.\n *\n * @param {!Object} target\n * @param {!Object} source\n * @param {number} depth The maximum merge depth. If exceeded, Object.assign\n *                       will be used instead.\n * @return {!Object}\n * @throws {Error} If source contains a circular reference.\n * Note: Only nested objects are deep-merged, primitives and arrays are not.\n */\n\n\nfunction deepMerge(target, source, depth) {\n  if (depth === void 0) {\n    depth = 10;\n  }\n\n  // Keep track of seen objects to detect recursive references.\n  var seen = [];\n  /** @type {!Array<{t: !Object, s: !Object, d: number}>} */\n\n  var queue = [];\n  queue.push({\n    t: target,\n    s: source,\n    d: 0\n  }); // BFS to ensure objects don't have recursive references at shallower depths.\n\n  var _loop = function _loop() {\n    var _queue$shift = queue.shift(),\n        t = _queue$shift.t,\n        s = _queue$shift.s,\n        d = _queue$shift.d;\n\n    if (seen.includes(s)) {\n      throw new Error('Source object has a circular reference.');\n    }\n\n    seen.push(s);\n\n    if (t === s) {\n      return \"continue\";\n    }\n\n    if (d > depth) {\n      Object.assign(t, s);\n      return \"continue\";\n    }\n\n    Object.keys(s).forEach(function (key) {\n      var newValue = s[key]; // Perform a deep merge IFF both target and source have the same key\n      // whose corresponding values are objects.\n\n      if (hasOwn(t, key)) {\n        var oldValue = t[key];\n\n        if ((0, _types.isObject)(newValue) && (0, _types.isObject)(oldValue)) {\n          queue.push({\n            t: oldValue,\n            s: newValue,\n            d: d + 1\n          });\n          return;\n        }\n      }\n\n      t[key] = newValue;\n    });\n  };\n\n  while (queue.length > 0) {\n    var _ret = _loop();\n\n    if (_ret === \"continue\") continue;\n  }\n\n  return target;\n}\n/**\n * @param {!Object} o An object to remove properties from\n * @param {!Array<string>} props A list of properties to remove from the Object\n * @return {!Object} An object with the given properties removed\n */\n\n\nfunction omit(o, props) {\n  return Object.keys(o).reduce(function (acc, key) {\n    if (!props.includes(key)) {\n      acc[key] = o[key];\n    }\n\n    return acc;\n  }, {});\n}\n\n},{\"../types\":131}],146:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.default = void 0;\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A priority queue backed with sorted array.\n * @template T\n */\nvar PriorityQueue =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates an instance of PriorityQueue.\n   */\n  function PriorityQueue() {\n    /** @private @const {Array<{item: T, priority: number}>} */\n    this.queue_ = [];\n  }\n  /**\n   * Returns the max priority item without dequeueing it.\n   * @return {T}\n   */\n\n\n  var _proto = PriorityQueue.prototype;\n\n  _proto.peek = function peek() {\n    var l = this.queue_.length;\n\n    if (!l) {\n      return null;\n    }\n\n    return this.queue_[l - 1].item;\n  }\n  /**\n   * Enqueues an item with the given priority.\n   * @param {T} item\n   * @param {number} priority\n   */\n  ;\n\n  _proto.enqueue = function enqueue(item, priority) {\n    if (isNaN(priority)) {\n      throw new Error('Priority must not be NaN.');\n    }\n\n    var i = this.binarySearch_(priority);\n    this.queue_.splice(i, 0, {\n      item: item,\n      priority: priority\n    });\n  }\n  /**\n   * Returns index at which item with `target` priority should be inserted.\n   * @param {number} target\n   * @return {number}\n   * @private\n   */\n  ;\n\n  _proto.binarySearch_ = function binarySearch_(target) {\n    var i = -1;\n    var lo = 0;\n    var hi = this.queue_.length;\n\n    while (lo <= hi) {\n      i = Math.floor((lo + hi) / 2); // This means `target` is the new max priority in the queue.\n\n      if (i === this.queue_.length) {\n        break;\n      } // Stop searching once p[i] >= target AND p[i-1] < target.\n      // This way, we'll return the index of the first occurence of `target`\n      // priority (if any), which preserves FIFO order of same-priority items.\n\n\n      if (this.queue_[i].priority < target) {\n        lo = i + 1;\n      } else if (i > 0 && this.queue_[i - 1].priority >= target) {\n        hi = i - 1;\n      } else {\n        break;\n      }\n    }\n\n    return i;\n  }\n  /**\n   * @param {function(T)} callback\n   */\n  ;\n\n  _proto.forEach = function forEach(callback) {\n    var index = this.queue_.length;\n\n    while (index--) {\n      callback(this.queue_[index].item);\n    }\n  }\n  /**\n   * Dequeues the max priority item.\n   * Items with the same priority are dequeued in FIFO order.\n   * @return {T}\n   */\n  ;\n\n  _proto.dequeue = function dequeue() {\n    if (!this.queue_.length) {\n      return null;\n    }\n\n    return this.queue_.pop().item;\n  }\n  /**\n   * The number of items in the queue.\n   * @return {number}\n   */\n  ;\n\n  _createClass(PriorityQueue, [{\n    key: \"length\",\n    get: function get() {\n      return this.queue_.length;\n    }\n  }]);\n\n  return PriorityQueue;\n}();\n\nexports.default = PriorityQueue;\n\n},{}],147:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.tryResolve = tryResolve;\nexports.some = some;\nexports.LastAddedResolver = exports.Deferred = void 0;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns a Deferred struct, which holds a pending promise and its associated\n * resolve and reject functions.\n *\n * This is preferred instead of creating a Promise instance to extract the\n * resolve/reject functions yourself:\n *\n * ```\n * // Avoid doing\n * let resolve;\n * const promise = new Promise(res => {\n *   resolve = res;\n * });\n *\n * // Good\n * const deferred = new Deferred();\n * const { promise, resolve } = deferred;\n * ```\n *\n * @template T\n */\nvar Deferred =\n/**\n * Creates an instance of Deferred.\n */\nfunction Deferred() {\n  var resolve, reject;\n  /**\n   * @const {!Promise<T>}\n   */\n\n  this.promise = new\n  /*OK*/\n  Promise(function (res, rej) {\n    resolve = res;\n    reject = rej;\n  });\n  /**\n   * @const {function(T=)}\n   */\n\n  this.resolve = resolve;\n  /**\n   * @const {function(*=)}\n   */\n\n  this.reject = reject;\n};\n/**\n * Creates a promise resolved to the return value of fn.\n * If fn sync throws, it will cause the promise to reject.\n *\n * @param {function():T} fn\n * @return {!Promise<T>}\n * @template T\n */\n\n\nexports.Deferred = Deferred;\n\nfunction tryResolve(fn) {\n  return new Promise(function (resolve) {\n    resolve(fn());\n  });\n}\n/**\n * Returns a promise which resolves if a threshold amount of the given promises\n * resolve, and rejects otherwise.\n * @param {!Array<!Promise>} promises The array of promises to test.\n * @param {number} count The number of promises that must resolve for the\n *     returned promise to resolve.\n * @return {!Promise} A promise that resolves if any of the given promises\n *     resolve, and which rejects otherwise.\n */\n\n\nfunction some(promises, count) {\n  if (count === void 0) {\n    count = 1;\n  }\n\n  return new Promise(function (resolve, reject) {\n    count = Math.max(count, 0);\n    var extra = promises.length - count;\n\n    if (extra < 0) {\n      reject(new Error('not enough promises to resolve'));\n    }\n\n    if (promises.length == 0) {\n      resolve([]);\n    }\n\n    var values = [];\n    var reasons = [];\n\n    var onFulfilled = function onFulfilled(value) {\n      if (values.length < count) {\n        values.push(value);\n      }\n\n      if (values.length == count) {\n        resolve(values);\n      }\n    };\n\n    var onRejected = function onRejected(reason) {\n      if (reasons.length <= extra) {\n        reasons.push(reason);\n      }\n\n      if (reasons.length > extra) {\n        reject(reasons);\n      }\n    };\n\n    for (var i = 0; i < promises.length; i++) {\n      Promise.resolve(promises[i]).then(onFulfilled, onRejected);\n    }\n  });\n}\n/**\n * Resolves with the result of the last promise added.\n * @implements {IThenable}\n */\n\n\nvar LastAddedResolver =\n/*#__PURE__*/\nfunction () {\n  /**\n   * @param {!Array<!Promise>=} opt_promises\n   */\n  function LastAddedResolver(opt_promises) {\n    var resolve_, reject_;\n    /** @private @const {!Promise} */\n\n    this.promise_ = new Promise(function (resolve, reject) {\n      resolve_ = resolve;\n      reject_ = reject;\n    });\n    /** @private */\n\n    this.resolve_ = resolve_;\n    /** @private */\n\n    this.reject_ = reject_;\n    /** @private */\n\n    this.count_ = 0;\n\n    if (opt_promises) {\n      for (var i = 0; i < opt_promises.length; i++) {\n        this.add(opt_promises[i]);\n      }\n    }\n  }\n  /**\n   * Add a promise to possibly be resolved.\n   * @param {!Promise} promise\n   * @return {!Promise}\n   */\n\n\n  var _proto = LastAddedResolver.prototype;\n\n  _proto.add = function add(promise) {\n    var _this = this;\n\n    var countAtAdd = ++this.count_;\n    Promise.resolve(promise).then(function (result) {\n      if (_this.count_ === countAtAdd) {\n        _this.resolve_(result);\n      }\n    }, function (error) {\n      // Don't follow behavior of Promise.all and Promise.race error so that\n      // this will only reject when most recently added promise fails.\n      if (_this.count_ === countAtAdd) {\n        _this.reject_(error);\n      }\n    });\n    return this.promise_;\n  }\n  /** @override */\n  ;\n\n  _proto.then = function then(opt_resolve, opt_reject) {\n    return this.promise_.then(opt_resolve, opt_reject);\n  };\n\n  return LastAddedResolver;\n}();\n\nexports.LastAddedResolver = LastAddedResolver;\n\n},{}],148:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.throttle = throttle;\nexports.debounce = debounce;\n\n/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Wraps a given callback and applies a rate limit.\n * It throttles the calls so that no consequent calls have time interval\n * smaller than the given minimal interval.\n *\n * @param {!Window} win\n * @param {function(...*)} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...*)}\n */\nfunction throttle(win, callback, minInterval) {\n  var locker = 0;\n  var nextCallArgs = null;\n  /**\n   * @param {!Object} args\n   */\n\n  function fire(args) {\n    nextCallArgs = null; // Lock the fire for minInterval milliseconds\n\n    locker = win.setTimeout(waiter, minInterval);\n    callback.apply(null, args);\n  }\n  /**\n   * Waiter function\n   */\n\n\n  function waiter() {\n    locker = 0; // If during the period there're invocations queued up, fire once.\n\n    if (nextCallArgs) {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function () {\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    if (locker) {\n      nextCallArgs = args;\n    } else {\n      fire(args);\n    }\n  };\n}\n/**\n * Wraps a given callback and applies a wait timer, so that minInterval\n * milliseconds must pass since the last call before the callback is actually\n * invoked.\n *\n * @param {!Window} win\n * @param {function(...*)} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...*)}\n */\n\n\nfunction debounce(win, callback, minInterval) {\n  var locker = 0;\n  var timestamp = 0;\n  var nextCallArgs = null;\n  /**\n   * @param {?Array} args\n   */\n\n  function fire(args) {\n    nextCallArgs = null;\n    callback.apply(null, args);\n  }\n  /**\n   * Wait function for debounce\n   */\n\n\n  function waiter() {\n    locker = 0;\n    var remaining = minInterval - (win.Date.now() - timestamp);\n\n    if (remaining > 0) {\n      locker = win.setTimeout(waiter, remaining);\n    } else {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function () {\n    timestamp = win.Date.now();\n\n    for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n      args[_key2] = arguments[_key2];\n    }\n\n    nextCallArgs = args;\n\n    if (!locker) {\n      locker = win.setTimeout(waiter, minInterval);\n    }\n  };\n}\n\n},{}],149:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.Signals = void 0;\n\nvar _promise2 = require(\"./promise\");\n\nvar _object = require(\"./object\");\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * This object tracts signals and allows blocking until a signal has been\n * received.\n */\nvar Signals =\n/*#__PURE__*/\nfunction () {\n  /**\n   * Creates an instance of Signals.\n   */\n  function Signals() {\n    /**\n     * A mapping from a signal name to the signal response: either time or\n     * an error.\n     * @private @const {!Object<string, (time|!Error)>}\n     */\n    this.map_ = (0, _object.map)();\n    /**\n     * A mapping from a signal name to the signal promise, resolve and reject.\n     * Only allocated when promise has been requested.\n     * @private {?Object<string, {\n     *   promise: !Promise,\n     *   resolve: (function(time)|undefined),\n     *   reject: (function(!Error)|undefined)\n     * }>}\n     */\n\n    this.promiseMap_ = null;\n  }\n  /**\n   * Returns the current known value of the signal. If signal is not yet\n   * available, `null` is returned.\n   * @param {string} name\n   * @return {number|!Error|null}\n   */\n\n\n  var _proto = Signals.prototype;\n\n  _proto.get = function get(name) {\n    var v = this.map_[name];\n    return v == null ? null : v;\n  }\n  /**\n   * Returns the promise that's resolved when the signal is triggered. The\n   * resolved value is the time of the signal.\n   * @param {string} name\n   * @return {!Promise<time>}\n   */\n  ;\n\n  _proto.whenSignal = function whenSignal(name) {\n    var promiseStruct = this.promiseMap_ && this.promiseMap_[name];\n\n    if (!promiseStruct) {\n      var result = this.map_[name];\n\n      if (result != null) {\n        // Immediately resolve signal.\n        var promise = typeof result == 'number' ? Promise.resolve(result) : Promise.reject(result);\n        promiseStruct = {\n          promise: promise\n        };\n      } else {\n        // Allocate the promise/resolver for when the signal arrives in the\n        // future.\n        var deferred = new _promise2.Deferred();\n        var _promise = deferred.promise,\n            resolve = deferred.resolve,\n            reject = deferred.reject;\n        promiseStruct = {\n          promise: _promise,\n          resolve: resolve,\n          reject: reject\n        };\n      }\n\n      if (!this.promiseMap_) {\n        this.promiseMap_ = (0, _object.map)();\n      }\n\n      this.promiseMap_[name] = promiseStruct;\n    }\n\n    return promiseStruct.promise;\n  }\n  /**\n   * Triggers the signal with the specified name on the element. The time is\n   * optional; if not provided, the current time is used. The associated\n   * promise is resolved with the resulting time.\n   * @param {string} name\n   * @param {time=} opt_time\n   */\n  ;\n\n  _proto.signal = function signal(name, opt_time) {\n    if (this.map_[name] != null) {\n      // Do not duplicate signals.\n      return;\n    }\n\n    var time = opt_time || Date.now();\n    this.map_[name] = time;\n    var promiseStruct = this.promiseMap_ && this.promiseMap_[name];\n\n    if (promiseStruct && promiseStruct.resolve) {\n      promiseStruct.resolve(time);\n      promiseStruct.resolve = undefined;\n      promiseStruct.reject = undefined;\n    }\n  }\n  /**\n   * Rejects the signal. Indicates that the signal will never succeed. The\n   * associated signal is rejected.\n   * @param {string} name\n   * @param {!Error} error\n   */\n  ;\n\n  _proto.rejectSignal = function rejectSignal(name, error) {\n    if (this.map_[name] != null) {\n      // Do not duplicate signals.\n      return;\n    }\n\n    this.map_[name] = error;\n    var promiseStruct = this.promiseMap_ && this.promiseMap_[name];\n\n    if (promiseStruct && promiseStruct.reject) {\n      promiseStruct.reject(error);\n      promiseStruct.resolve = undefined;\n      promiseStruct.reject = undefined;\n    }\n  }\n  /**\n   * Resets all signals.\n   * @param {string} name\n   */\n  ;\n\n  _proto.reset = function reset(name) {\n    if (this.map_[name]) {\n      delete this.map_[name];\n    } // Reset promise it has already been resolved.\n\n\n    var promiseStruct = this.promiseMap_ && this.promiseMap_[name];\n\n    if (promiseStruct && !promiseStruct.resolve) {\n      delete this.promiseMap_[name];\n    }\n  };\n\n  return Signals;\n}();\n\nexports.Signals = Signals;\n\n},{\"./object\":145,\"./promise\":147}],150:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.toStructuredCloneable = toStructuredCloneable;\nexports.fromStructuredCloneable = fromStructuredCloneable;\nexports.getViewerInterceptResponse = getViewerInterceptResponse;\nexports.setupInput = setupInput;\nexports.setupInit = setupInit;\nexports.setupAMPCors = setupAMPCors;\nexports.setupJsonFetchInit = setupJsonFetchInit;\nexports.assertSuccess = assertSuccess;\nexports.getViewerAuthTokenIfAvailable = getViewerAuthTokenIfAvailable;\n\nvar _services = require(\"../services\");\n\nvar _log = require(\"../log\");\n\nvar _object = require(\"./object\");\n\nvar _array = require(\"./array\");\n\nvar _url = require(\"../url\");\n\nvar _mode = require(\"../mode\");\n\nvar _types = require(\"../types\");\n\nvar _experiments = require(\"../experiments\");\n\nvar _formDataWrapper = require(\"../form-data-wrapper\");\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @private @const {!Array<string>} */\nvar allowedMethods_ = ['GET', 'POST'];\n/** @private @const {!Array<function(*):boolean>} */\n\nvar allowedJsonBodyTypes_ = [_types.isArray, _types.isObject];\n/**\n * Serializes a fetch request so that it can be passed to `postMessage()`,\n * i.e., can be cloned using the\n * [structured clone algorithm](http://mdn.io/Structured_clone_algorithm).\n *\n * The request is serialized in the following way:\n *\n * 1. If the `init.body` is a `FormData`, set content-type header to\n * `multipart/form-data` and transform `init.body` into an\n * `!Array<!Array<string>>` holding the list of form entries, where each\n * element in the array is a form entry (key-value pair) represented as a\n * 2-element array.\n *\n * 2. Return a new object having properties `input` and the transformed\n * `init`.\n *\n * The serialized request is assumed to be de-serialized in the following way:\n *\n * 1.If content-type header starts with `multipart/form-data`\n * (case-insensitive), transform the entry array in `init.body` into a\n * `FormData` object.\n *\n * 2. Pass `input` and transformed `init` to `fetch` (or the constructor of\n * `Request`).\n *\n * Currently only `FormData` used in `init.body` is handled as it's the only\n * type being used in AMP runtime that needs serialization. The `Headers` type\n * also needs serialization, but callers should not be passing `Headers`\n * object in `init`, as that fails `fetchPolyfill` on browsers that don't\n * support fetch. Some serialization-needing types for `init.body` such as\n * `ArrayBuffer` and `Blob` are already supported by the structured clone\n * algorithm. Other serialization-needing types such as `URLSearchParams`\n * (which is not supported in IE and Safari) and `FederatedCredentials` are\n * not used in AMP runtime.\n *\n * @param {string} input The URL of the XHR to convert to structured\n *     cloneable.\n * @param {!FetchInitDef} init The options of the XHR to convert to structured\n *     cloneable.\n * @return {{input: string, init: !FetchInitDef}} The serialized structurally-\n *     cloneable request.\n * @private\n */\n\nfunction toStructuredCloneable(input, init) {\n  var newInit = Object.assign({}, init);\n\n  if ((0, _formDataWrapper.isFormDataWrapper)(init.body)) {\n    var wrapper =\n    /** @type {!FormDataWrapperInterface} */\n    init.body;\n    newInit.headers['Content-Type'] = 'multipart/form-data;charset=utf-8';\n    newInit.body = (0, _array.fromIterator)(wrapper.entries());\n  }\n\n  return {\n    input: input,\n    init: newInit\n  };\n}\n/**\n * De-serializes a fetch response that was made possible to be passed to\n * `postMessage()`, i.e., can be cloned using the\n * [structured clone algorithm](http://mdn.io/Structured_clone_algorithm).\n *\n * The response is assumed to be serialized in the following way:\n *\n * 1. Transform the entries in the headers of the response into an\n * `!Array<!Array<string>>` holding the list of header entries, where each\n * element in the array is a header entry (key-value pair) represented as a\n * 2-element array. The header key is case-insensitive.\n *\n * 2. Include the header entry list and `status` and `statusText` properties\n * of the response in as `headers`, `status` and `statusText` properties of\n * `init`.\n *\n * 3. Include the body of the response serialized as string in `body`.\n *\n * 4. Return a new object having properties `body` and `init`.\n *\n * The response is de-serialized in the following way:\n *\n * 1. If the `Response` type is supported and `responseType` is not\n * document, pass `body` and `init` directly to the constructor of `Response`.\n *\n * 2. Otherwise, populate a fake XHR object to pass to `FetchResponse` as if\n * the response is returned by the fetch polyfill.\n *\n * 3. If `responseType` is `document`, also parse the body and populate\n * `responseXML` as a `Document` type.\n *\n * @param {JsonObject|string|undefined} response The structurally-cloneable\n *     response to convert back to a regular Response.\n * @param {string|undefined} responseType The original response type used to\n *     initiate the XHR.\n * @return {!Response} The deserialized regular response.\n * @private\n */\n\n\nfunction fromStructuredCloneable(response, responseType) {\n  (0, _log.userAssert)((0, _types.isObject)(response), 'Object expected: %s', response);\n  var isDocumentType = responseType == 'document';\n\n  if (!isDocumentType) {\n    // Use native `Response` type if available for performance. If response\n    // type is `document`, we must fall back to `FetchResponse` polyfill\n    // because callers would then rely on the `responseXML` property being\n    // present, which is not supported by the Response type.\n    return new Response(response['body'], response['init']);\n  }\n\n  var lowercasedHeaders = (0, _object.map)();\n  var data = {\n    status: 200,\n    statusText: 'OK',\n\n    /**\n     * @param {string} name\n     * @return {string}\n     */\n    getResponseHeader: function getResponseHeader(name) {\n      return lowercasedHeaders[String(name).toLowerCase()] || null;\n    }\n  };\n\n  if (response['init']) {\n    var init = response['init'];\n\n    if ((0, _types.isArray)(init.headers)) {\n      init.headers.forEach(function (entry) {\n        var headerName = entry[0];\n        var headerValue = entry[1];\n        lowercasedHeaders[String(headerName).toLowerCase()] = String(headerValue);\n      });\n    }\n\n    if (init.status) {\n      data.status = parseInt(init.status, 10);\n    }\n\n    if (init.statusText) {\n      data.statusText = String(init.statusText);\n    }\n  }\n\n  return new Response(response['body'] ? String(response['body']) : '', data);\n}\n/**\n * Intercepts the XHR and proxies it through the viewer if necessary.\n *\n * XHRs are intercepted if all of the following are true:\n * - The AMP doc is in single doc mode\n * - The requested resource is not a 1p request.\n * - The viewer has the `xhrInterceptor` capability\n * - The Viewer is a trusted viewer or AMP is currently in developement mode\n * - The AMP doc is opted-in for XHR interception (`<html>` tag has\n *   `allow-xhr-interception` attribute)\n *\n * @param {!Window} win\n * @param {?../service/ampdoc-impl.AmpDoc} ampdocSingle\n * @param {string} input The URL of the XHR which may get intercepted.\n * @param {!FetchInitDef} init The options of the XHR which may get\n *     intercepted.\n * @return {!Promise<!Response|undefined>}\n *     A response returned by the interceptor if XHR is intercepted or\n *     `Promise<undefined>` otherwise.\n * @private\n */\n\n\nfunction getViewerInterceptResponse(win, ampdocSingle, input, init) {\n  if (!ampdocSingle) {\n    return Promise.resolve();\n  }\n\n  var whenUnblocked = init.prerenderSafe ? Promise.resolve() : ampdocSingle.whenFirstVisible();\n\n  var viewer = _services.Services.viewerForDoc(ampdocSingle);\n\n  var urlIsProxy = (0, _url.isProxyOrigin)(input);\n  var viewerCanIntercept = viewer.hasCapability('xhrInterceptor');\n  var interceptorDisabledForLocalDev = init.bypassInterceptorForDev && (0, _mode.getMode)(win).localDev;\n\n  if (urlIsProxy || !viewerCanIntercept || interceptorDisabledForLocalDev) {\n    return whenUnblocked;\n  }\n\n  var htmlElement = ampdocSingle.getRootNode().documentElement;\n  var docOptedIn = htmlElement.hasAttribute('allow-xhr-interception');\n\n  if (!docOptedIn) {\n    return whenUnblocked;\n  }\n\n  return whenUnblocked.then(function () {\n    return viewer.isTrustedViewer();\n  }).then(function (viewerTrusted) {\n    if (!(viewerTrusted || (0, _mode.getMode)(win).localDev || (0, _experiments.isExperimentOn)(win, 'untrusted-xhr-interception'))) {\n      return;\n    }\n\n    var messagePayload = (0, _object.dict)({\n      'originalRequest': toStructuredCloneable(input, init)\n    });\n    return viewer.sendMessageAwaitResponse('xhr', messagePayload).then(function (response) {\n      return fromStructuredCloneable(response, init.responseType);\n    });\n  });\n}\n/**\n * Sets up URL based on ampCors\n * @param {!Window} win\n * @param {string} input\n * @param {!FetchInitDef} init The options of the XHR which may get\n * intercepted.\n * @return {string}\n */\n\n\nfunction setupInput(win, input, init) {\n  (0, _log.devAssert)(typeof input == 'string', 'Only URL supported: %s', input);\n\n  if (init.ampCors !== false) {\n    input = (0, _url.getCorsUrl)(win, input);\n  }\n\n  return input;\n}\n/**\n * Sets up and normalizes the FetchInitDef\n *\n * @param {?FetchInitDef=} opt_init Fetch options object.\n * @param {string=} opt_accept The HTTP Accept header value.\n * @return {!FetchInitDef}\n */\n\n\nfunction setupInit(opt_init, opt_accept) {\n  var init = opt_init || {}; // In particular, Firefox does not tolerate `null` values for\n  // `credentials`.\n\n  var creds = init.credentials;\n  (0, _log.devAssert)(creds === undefined || creds == 'include' || creds == 'omit', 'Only credentials=include|omit support: %s', creds);\n  init.method = normalizeMethod_(init.method);\n  init.headers = init.headers || (0, _object.dict)({});\n\n  if (opt_accept) {\n    init.headers['Accept'] = opt_accept;\n  } // In edge a `TypeMismatchError` is thrown when body is set to null.\n\n\n  (0, _log.devAssert)(init.body !== null, 'fetch `body` can not be `null`');\n  return init;\n}\n/**\n *\n * Sets up AMPSpecific CORS headers.\n * @param {!Window} win\n * @param {string} input\n * @param {?FetchInitDef=} init\n * @return {!FetchInitDef}\n */\n\n\nfunction setupAMPCors(win, input, init) {\n  init = init || {}; // For some same origin requests, add AMP-Same-Origin: true header to allow\n  // publishers to validate that this request came from their own origin.\n\n  var currentOrigin = (0, _url.getWinOrigin)(win);\n  var targetOrigin = (0, _url.parseUrlDeprecated)(input).origin;\n\n  if (currentOrigin == targetOrigin) {\n    init['headers'] = init['headers'] || {};\n    init['headers']['AMP-Same-Origin'] = 'true';\n  }\n\n  return init;\n}\n/**\n * @param {?FetchInitDef=} init\n * @return {!FetchInitDef}\n */\n\n\nfunction setupJsonFetchInit(init) {\n  var fetchInit = setupInit(init, 'application/json');\n\n  if (fetchInit.method == 'POST' && !(0, _formDataWrapper.isFormDataWrapper)(fetchInit.body)) {\n    // Assume JSON strict mode where only objects or arrays are allowed\n    // as body.\n    (0, _log.devAssert)(allowedJsonBodyTypes_.some(function (test) {\n      return test(fetchInit.body);\n    }), 'body must be of type object or array. %s', fetchInit.body); // Content should be 'text/plain' to avoid CORS preflight.\n\n    fetchInit.headers['Content-Type'] = fetchInit.headers['Content-Type'] || 'text/plain;charset=utf-8';\n    var headerContentType = fetchInit.headers['Content-Type']; // Cast is valid, because we checked that it is not form data above.\n\n    if (headerContentType === 'application/x-www-form-urlencoded') {\n      fetchInit.body = (0, _url.serializeQueryString)(\n      /** @type {!JsonObject} */\n      fetchInit.body);\n    } else {\n      fetchInit.body = JSON.stringify(\n      /** @type {!JsonObject} */\n      fetchInit.body);\n    }\n  }\n\n  return fetchInit;\n}\n/**\n * Normalized method name by uppercasing.\n * @param {string|undefined} method\n * @return {string}\n * @private\n */\n\n\nfunction normalizeMethod_(method) {\n  if (method === undefined) {\n    return 'GET';\n  }\n\n  method = method.toUpperCase();\n  (0, _log.devAssert)(allowedMethods_.includes(method), 'Only one of %s is currently allowed. Got %s', allowedMethods_.join(', '), method);\n  return method;\n}\n/**\n * If 415 or in the 5xx range.\n * @param {number} status\n * @return {boolean}\n */\n\n\nfunction isRetriable(status) {\n  return status == 415 || status >= 500 && status < 600;\n}\n/**\n * Returns the response if successful or otherwise throws an error.\n * @param {!Response} response\n * @return {!Promise<!Response>}\n * @private Visible for testing\n */\n\n\nfunction assertSuccess(response) {\n  return new Promise(function (resolve) {\n    if (response.ok) {\n      return resolve(response);\n    }\n\n    var status = response.status;\n    var err = (0, _log.user)().createError(\"HTTP error \" + status);\n    err.retriable = isRetriable(status); // TODO(@jridgewell, #9448): Callers who need the response should\n    // skip processing.\n\n    err.response = response;\n    throw err;\n  });\n}\n/**\n * Returns a promise resolving to a string identity token if the element\n * contains the 'crossorigin' attribute and the amp-viewer-assistance extension\n * is present. Resolves to undefined otherwise.\n * @param {!Element} element\n * @return {!Promise<undefined>}\n */\n\n\nfunction getViewerAuthTokenIfAvailable(element) {\n  var crossOriginAttr = element.getAttribute('crossorigin');\n\n  if (crossOriginAttr && crossOriginAttr.trim() === 'amp-viewer-auth-token-via-post') {\n    return _services.Services.viewerAssistanceForDocOrNull(element).then(function (va) {\n      (0, _log.userAssert)(va, 'crossorigin=\"amp-viewer-auth-token-post\" ' + 'requires amp-viewer-assistance extension.');\n      return va.getIdTokenPromise();\n    }) // If crossorigin attr is present, resolve with token or empty string.\n    .then(function (token) {\n      return token || '';\n    }).catch(function () {\n      return '';\n    });\n  } // If crossorigin attribute is missing, always resolve with undefined.\n\n\n  return Promise.resolve(undefined);\n}\n\n},{\"../experiments\":47,\"../form-data-wrapper\":52,\"../log\":68,\"../mode\":70,\"../services\":123,\"../types\":131,\"../url\":134,\"./array\":135,\"./object\":145}],151:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.VisibilityState = void 0;\n\n/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Visibility state of the AMP document.\n * @enum {string}\n */\nvar VisibilityState = {\n  /**\n   * The AMP document is being pre-rendered before being shown.\n   */\n  PRERENDER: 'prerender',\n\n  /**\n   * The AMP document is currently active and visible.\n   */\n  VISIBLE: 'visible',\n\n  /**\n   * The AMP document is active but the browser tab or AMP app is not.\n   */\n  HIDDEN: 'hidden',\n\n  /**\n   * The AMP document is visible, but the user has started swiping away from\n   * it. The runtime may stop active playback.\n   */\n  PAUSED: 'paused',\n\n  /**\n   * The AMP document is no longer active because the user swiped away or\n   * closed the viewer. The document may become visible again later.\n   */\n  INACTIVE: 'inactive'\n};\nexports.VisibilityState = VisibilityState;\n\n},{}],152:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.WindowInterface = void 0;\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * An interface to interact with browser window object.\n * Mainly used to mock out read only APIs in test.\n * See test-helper.js#mockWindowInterface\n */\nvar WindowInterface =\n/*#__PURE__*/\nfunction () {\n  function WindowInterface() {}\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {!Location}\n   */\n  WindowInterface.getLocation = function getLocation(win) {\n    return win.location;\n  }\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  ;\n\n  WindowInterface.getDocumentReferrer = function getDocumentReferrer(win) {\n    return win.document.referrer;\n  }\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  ;\n\n  WindowInterface.getHostname = function getHostname(win) {\n    return win.location.hostname;\n  }\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  ;\n\n  WindowInterface.getUserAgent = function getUserAgent(win) {\n    return win.navigator.userAgent;\n  }\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  ;\n\n  WindowInterface.getUserLanguage = function getUserLanguage(win) {\n    return win.navigator.userLanguage || win.navigator.language;\n  }\n  /**\n   * @static\n   * @return {number}\n   */\n  ;\n\n  WindowInterface.getDevicePixelRatio = function getDevicePixelRatio() {\n    // No matter the window, the device-pixel-ratio is always one.\n    return self.devicePixelRatio || 1;\n  }\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {function(string,(ArrayBufferView|Blob|FormData|null|string)=):boolean|undefined}\n   */\n  ;\n\n  WindowInterface.getSendBeacon = function getSendBeacon(win) {\n    if (!win.navigator.sendBeacon) {\n      return undefined;\n    }\n\n    return win.navigator.sendBeacon.bind(win.navigator);\n  }\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {function(new:XMLHttpRequest)}\n   */\n  ;\n\n  WindowInterface.getXMLHttpRequest = function getXMLHttpRequest(win) {\n    return win.XMLHttpRequest;\n  }\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {function(new:Image)}\n   */\n  ;\n\n  WindowInterface.getImage = function getImage(win) {\n    return win.Image;\n  };\n\n  return WindowInterface;\n}();\n\nexports.WindowInterface = WindowInterface;\n\n},{}],153:[function(require,module,exports){\n\"use strict\";\n\nexports.__esModule = true;\nexports.cssEscape = cssEscape;\n\n/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */\n\n/**\n * This regex consists of 4 matching capture groups and one (non-matching) fallback:\n *\n * - (\\0), catch the null terminator character so it may be replaced by UTF\n *   Replacement Char\n * - ^(-)$, catch a solitary dash char, so that it may be backslash escaped.\n *   This is a separate capture group so that the legal-chars (group 4) doesn't\n *   capture it first, since that group doesn't need to escape its dash.\n * - ([\\x01-\\x1f\\x7f]|^-?[0-9]), catch a UTF control char, or any leading\n *   number (with an optional leading dash). The control or the number (but not\n *   the leading dash) must be hex-escaped,.\n * - ([\\x80-\\uffff0-9a-zA-Z_-]+), catch legal-chars, with the exception of a\n *   solitary dash, which will already have matched in group 1.\n * - [^], finally, a catch-all that allows us to backslash escape the char.\n *\n * Together, this matches everything necessary for CSS.escape.\n */\nvar regex = /(\\0)|^(-)$|([\\x01-\\x1f\\x7f]|^-?[0-9])|([\\x80-\\uffff0-9a-zA-Z_-]+)|[^]/g;\n\nfunction escaper(match, nil, dash, hexEscape, chars) {\n  // Chars is the legal-chars (group 4) capture\n  if (chars) {\n    return chars;\n  } // Nil is the null terminator (group 1) capture\n\n\n  if (nil) {\n    return \"\\uFFFD\";\n  } // Both UTF control chars, and leading numbers (with optional leading dash)\n  // (group 3) must be backslash escaped with a trailing space.  Funnily, the\n  // leading dash must not be escaped, but the number. :shrug:\n\n\n  if (hexEscape) {\n    return match.slice(0, -1) + '\\\\' + match.slice(-1).charCodeAt(0).toString(16) + ' ';\n  } // Finally, the solitary dash and the catch-all chars require backslash\n  // escaping.\n\n\n  return '\\\\' + match;\n}\n/**\n * https://drafts.csswg.org/cssom/#serialize-an-identifier\n * @param {string} value\n * @return {string}\n */\n\n\nfunction cssEscape(value) {\n  return String(value).replace(regex, escaper);\n}\n\n},{}]},{},[16])\n\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {cloudflareIsA4AEnabled} from '../extensions/amp-ad-network-cloudflare-impl/0.1/cloudflare-a4a-config';\nimport {gmosspIsA4AEnabled} from '../extensions/amp-ad-network-gmossp-impl/0.1/gmossp-a4a-config';\nimport {map} from '../src/utils/object';\nimport {tripleliftIsA4AEnabled} from '../extensions/amp-ad-network-triplelift-impl/0.1/triplelift-a4a-config';\n\n/**\n * Registry for A4A (AMP Ads for AMPHTML pages) \"is supported\" predicates.\n * If an ad network, {@code ${NETWORK}}, is registered in this object, then the\n * {@code <amp-ad type=\"${NETWORK}\">} implementation will look up its predicate\n * here. If there is a predicate and it and returns {@code true}, then\n * {@code amp-ad} will attempt to render the ad via the A4A pathway (fetch\n * ad creative via early XHR CORS request; verify that it is validated AMP;\n * and then render directly in the host page by splicing into the host DOM).\n * Otherwise, it will attempt to render the ad via the existing \"3p iframe\"\n * pathway (delay load into a cross-domain iframe).\n *\n * @type {!Object<string, function(!Window, !Element): boolean>}\n */\nlet a4aRegistry;\n\n/**\n * Returns the a4a registry map\n * @return {Object}\n */\nexport function getA4ARegistry() {\n  if (!a4aRegistry) {\n    a4aRegistry = map({\n      'adsense': () => true,\n      'adzerk': () => true,\n      'doubleclick': () => true,\n      'triplelift': tripleliftIsA4AEnabled,\n      'cloudflare': cloudflareIsA4AEnabled,\n      'gmossp': gmosspIsA4AEnabled,\n      'fake': () => true,\n      // TODO: Add new ad network implementation \"is enabled\" functions here.\n      // Note: if you add a function here that requires a new \"import\", above,\n      // you'll probably also need to add a whitelist exception to\n      // build-system/test-configs/dep-check-config.js in the\n      // \"filesMatching: 'ads/**/*.js'\" rule.\n    });\n  }\n\n  return a4aRegistry;\n}\n\n/**\n * An object mapping signing server names to their corresponding URLs.\n * @type {!Object<string, string>}\n */\nexport const signingServerURLs = {\n  'google': 'https://cdn.ampproject.org/amp-ad-verifying-keyset.json',\n  'google-dev': 'https://cdn.ampproject.org/amp-ad-verifying-keyset-dev.json',\n  'cloudflare': 'https://amp.cloudflare.com/amp-ad-verifying-keyset.json',\n  'cloudflare-dev':\n    'https://amp.cloudflare.com/amp-ad-verifying-keyset-dev.json',\n};\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {jsonConfiguration} from '../src/json';\n\n/**\n * @typedef {{\n *   prefetch: (string|undefined),\n *   preconnect: (string|undefined),\n *   renderStartImplemented: (boolean|undefined),\n *   clientIdScope: (string|undefined),\n *   clientIdCookieName: (string|undefined),\n *   consentHandlingOverride: (boolean|undefined),\n *   remoteHTMLDisabled: (boolean|undefined),\n *   fullWidthHeightRatio: (number|undefined),\n * }}\n */\nlet AdNetworkConfigDef;\n\n/**\n * The config of each ad network.\n * Please keep the list alphabetic order.\n *\n * yourNetworkName: {  // This is the \"type\" attribute of <amp-ad>\n *\n *   // List of URLs for prefetch\n *   prefetch: string|array\n *\n *   // List of hosts for preconnect\n *   preconnect: string|array\n *\n *   // The scope used to provide CIDs to ads\n *   clientIdScope: string\n *\n *   // The cookie name to store the CID. In absence, `clientIdScope` is used.\n *   clientIdCookieName: string\n *\n *   // If the ad network is willing to override the consent handling, which\n *   // by default is blocking ad load until the consent is accepted.\n *   consentHandlingOverride: boolean\n *\n *   // Whether render-start API has been implemented\n *   // We highly recommend all networks to implement the API,\n *   // see details in the README.md\n *   renderStartImplemented: boolean\n *\n *   // The width / height ratio for full width ad units.\n *   // If absent, it means the network does not support full width ad units.\n *   // Example value: 1.2\n *   fullWidthHeightRatio: number\n * }\n *\n * @const {!Object<string, !JsonObject>}\n */\nconst adConfig = jsonConfiguration({\n  '_ping_': {\n    renderStartImplemented: true,\n    clientIdScope: '_PING_',\n    consentHandlingOverride: true,\n  },\n\n  '1wo': {},\n\n  '24smi': {\n    prefetch: 'https://jsn.24smi.net/smi.js',\n    preconnect: 'https://data.24smi.net',\n  },\n\n  'a8': {\n    prefetch: 'https://statics.a8.net/amp/ad.js',\n    renderStartImplemented: true,\n  },\n\n  'a9': {\n    prefetch: 'https://z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US',\n  },\n\n  'accesstrade': {\n    prefetch: 'https://h.accesstrade.net/js/amp/amp.js',\n  },\n\n  'adagio': {\n    prefetch: 'https://js-ssl.neodatagroup.com/adagio_amp.js',\n    preconnect: [\n      'https://ad-aws-it.neodatagroup.com',\n      'https://tracker.neodatagroup.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'adblade': {\n    prefetch: 'https://web.adblade.com/js/ads/async/show.js',\n    preconnect: [\n      'https://staticd.cdn.adblade.com',\n      'https://static.adblade.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'adbutler': {\n    prefetch: 'https://servedbyadbutler.com/app.js',\n  },\n\n  'adform': {},\n\n  'adfox': {\n    prefetch: 'https://yastatic.net/pcode/adfox/loader.js',\n    renderStartImplemented: true,\n  },\n\n  'adgeneration': {\n    prefetch: 'https://i.socdm.com/sdk/js/adg-script-loader.js',\n  },\n\n  'adglare': {\n    renderStartImplemented: true,\n  },\n\n  'adhese': {\n    renderStartImplemented: true,\n  },\n\n  'adincube': {\n    renderStartImplemented: true,\n  },\n\n  'adition': {},\n\n  'adman': {},\n\n  'admanmedia': {\n    renderStartImplemented: true,\n  },\n\n  'admixer': {\n    renderStartImplemented: true,\n    preconnect: ['https://inv-nets.admixer.net', 'https://cdn.admixer.net'],\n  },\n\n  'adocean': {\n    consentHandlingOverride: true,\n  },\n\n  'adop': {},\n\n  'adpicker': {\n    renderStartImplemented: true,\n  },\n\n  'adplugg': {\n    prefetch: 'https://www.adplugg.com/serve/js/ad.js',\n    renderStartImplemented: true,\n  },\n\n  'adpon': {\n    prefetch: 'https://ad.adpon.jp/amp.js',\n    clientIdScope: 'AMP_ECID_ADPON',\n  },\n\n  'adreactor': {},\n\n  'adsensor': {\n    prefetch: 'https://wfpscripts.webspectator.com/amp/adsensor-amp.js',\n    clientIdScope: 'amp_ecid_adensor',\n    renderStartImplemented: true,\n  },\n  'adsloom': {\n    clientIdScope: 'AMP_ECID_ADSLOOM',\n  },\n  'adsnative': {\n    prefetch: 'https://static.adsnative.com/static/js/render.v1.js',\n    preconnect: 'https://api.adsnative.com',\n  },\n\n  'adspeed': {\n    preconnect: 'https://g.adspeed.net',\n    renderStartImplemented: true,\n  },\n\n  'adspirit': {},\n\n  'adstir': {\n    prefetch: 'https://js.ad-stir.com/js/adstir_async.js',\n    preconnect: 'https://ad.ad-stir.com',\n  },\n\n  'adstyle': {\n    prefetch: 'https://widgets.ad.style/amp.js',\n    preconnect: ['https://w.ad.style'],\n  },\n\n  'adtech': {\n    prefetch: 'https://s.aolcdn.com/os/ads/adsWrapper3.js',\n    preconnect: ['https://mads.at.atwola.com', 'https://aka-cdn.adtechus.com'],\n  },\n\n  'adthrive': {\n    prefetch: ['https://www.googletagservices.com/tag/js/gpt.js'],\n    preconnect: [\n      'https://partner.googleadservices.com',\n      'https://securepubads.g.doubleclick.net',\n      'https://tpc.googlesyndication.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'adunity': {\n    preconnect: ['https://content.adunity.com'],\n    renderStartImplemented: true,\n  },\n\n  'aduptech': {\n    prefetch: 'https://s.d.adup-tech.com/jsapi',\n    preconnect: ['https://d.adup-tech.com', 'https://m.adup-tech.com'],\n    renderStartImplemented: true,\n  },\n\n  'adventive': {\n    preconnect: ['https://ads.adventive.com', 'https://amp.adventivedev.com'],\n    renderStartImplemented: true,\n  },\n\n  'adverline': {\n    prefetch: 'https://ads.adverline.com/richmedias/amp.js',\n    preconnect: ['https://adnext.fr'],\n    renderStartImplemented: true,\n  },\n\n  'adverticum': {},\n\n  'advertserve': {\n    renderStartImplemented: true,\n  },\n\n  'adyoulike': {\n    consentHandlingOverride: true,\n    prefetch: 'https://fo-static.omnitagjs.com/amp.js',\n    renderStartImplemented: true,\n  },\n\n  'adzerk': {},\n\n  'affiliateb': {\n    prefetch: 'https://track.affiliate-b.com/amp/a.js',\n    renderStartImplemented: true,\n  },\n\n  'aja': {\n    prefetch: [\n      'https://cdn.as.amanad.adtdp.com/sdk/asot-amp.js',\n      'https://cdn.as.amanad.adtdp.com/sdk/asot-v2.js',\n    ],\n    preconnect: ['https://ad.as.amanad.adtdp.com'],\n  },\n\n  'appvador': {\n    prefetch: [\n      'https://cdn.apvdr.com/js/VastAdUnit.min.js',\n      'https://cdn.apvdr.com/js/VideoAd.min.js',\n      'https://cdn.apvdr.com/js/VideoAd3PAS.min.js',\n      'https://cdn.apvdr.com/js/VideoAdAutoPlay.min.js',\n      'https://cdn.apvdr.com/js/VideoAdNative.min.js',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'amoad': {\n    prefetch: ['https://j.amoad.com/js/a.js', 'https://j.amoad.com/js/n.js'],\n    preconnect: [\n      'https://d.amoad.com',\n      'https://i.amoad.com',\n      'https://m.amoad.com',\n      'https://v.amoad.com',\n    ],\n  },\n\n  'aniview': {\n    renderStartImplemented: true,\n  },\n\n  'appnexus': {\n    prefetch: 'https://acdn.adnxs.com/ast/ast.js',\n    preconnect: 'https://ib.adnxs.com',\n    renderStartImplemented: true,\n  },\n\n  'atomx': {\n    prefetch: 'https://s.ato.mx/p.js',\n  },\n\n  'beaverads': {\n    renderStartImplemented: true,\n  },\n\n  'beopinion': {\n    prefetch: 'https://widget.beopinion.com/sdk.js',\n    preconnect: [\n      'https://t.beopinion.com',\n      'https://s.beopinion.com',\n      'https://data.beopinion.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'bidtellect': {},\n\n  'blade': {\n    prefetch: 'https://sdk.streamrail.com/blade/sr.blade.js',\n    renderStartImplemented: true,\n  },\n\n  'brainy': {},\n\n  'bringhub': {\n    renderStartImplemented: true,\n    preconnect: ['https://static.bh-cdn.com', 'https://core-api.bringhub.io'],\n  },\n\n  'broadstreetads': {\n    prefetch: 'https://cdn.broadstreetads.com/init-2.min.js',\n  },\n\n  'caajainfeed': {\n    prefetch: ['https://cdn.amanad.adtdp.com/sdk/ajaamp.js'],\n    preconnect: ['https://ad.amanad.adtdp.com'],\n  },\n\n  'capirs': {\n    renderStartImplemented: true,\n  },\n\n  'caprofitx': {\n    prefetch: [\n      'https://cdn.caprofitx.com/pfx.min.js',\n      'https://cdn.caprofitx.com/tags/amp/profitx_amp.js',\n    ],\n    preconnect: 'https://ad.caprofitx.adtdp.com',\n  },\n\n  'cedato': {\n    renderStartImplemented: true,\n  },\n\n  'chargeads': {}, // Deprecated, to be removed on 2019-05-23\n\n  'colombia': {\n    prefetch: 'https://static.clmbtech.com/ad/commons/js/colombia-amp.js',\n  },\n\n  'conative': {\n    renderStartImplemented: true,\n  },\n\n  'connatix': {\n    renderStartImplemented: true,\n  },\n\n  'contentad': {},\n\n  'criteo': {\n    prefetch: 'https://static.criteo.net/js/ld/publishertag.js',\n    preconnect: 'https://cas.criteo.com',\n  },\n\n  'csa': {\n    prefetch: 'https://www.google.com/adsense/search/ads.js',\n  },\n\n  'dable': {\n    preconnect: [\n      'https://static.dable.io',\n      'https://api.dable.io',\n      'https://images.dable.io',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'directadvert': {\n    renderStartImplemented: true,\n  },\n\n  'distroscale': {\n    preconnect: [\n      'https://c.jsrdn.com',\n      'https://s.jsrdn.com',\n      'https://i.jsrdn.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'dotandads': {\n    prefetch: 'https://amp.ad.dotandad.com/dotandadsAmp.js',\n    preconnect: 'https://bal.ad.dotandad.com',\n  },\n  'dynad': {\n    preconnect: ['https://t.dynad.net', 'https://tm.jsuol.com.br'],\n  },\n  'eadv': {\n    renderStartImplemented: true,\n    clientIdScope: 'AMP_ECID_EADV',\n    prefetch: [\n      'https://www.eadv.it/track/esr.min.js',\n      'https://www.eadv.it/track/ead.min.js',\n    ],\n  },\n\n  'eas': {\n    prefetch: 'https://amp.emediate.eu/amp.v0.js',\n    renderStartImplemented: true,\n  },\n\n  'empower': {\n    prefetch: 'https://cdn.empower.net/sdk/amp-ad.min.js',\n    renderStartImplemented: true,\n  },\n\n  'engageya': {},\n\n  'epeex': {},\n\n  'eplanning': {\n    prefetch: 'https://us.img.e-planning.net/layers/epl-amp.js',\n  },\n\n  'ezoic': {\n    prefetch: [\n      'https://www.googletagservices.com/tag/js/gpt.js',\n      'https://g.ezoic.net/ezoic/ampad.js',\n    ],\n    clientIdScope: 'AMP_ECID_EZOIC',\n    consentHandlingOverride: true,\n  },\n\n  'f1e': {\n    prefetch: 'https://img.ak.impact-ad.jp/util/f1e_amp.min.js',\n  },\n\n  'f1h': {\n    preconnect: 'https://img.ak.impact-ad.jp',\n    renderStartImplemented: true,\n  },\n\n  'fake': {},\n\n  'felmat': {\n    prefetch: 'https://t.felmat.net/js/fmamp.js',\n    renderStartImplemented: true,\n  },\n\n  'flite': {},\n\n  'fluct': {\n    preconnect: [\n      'https://cdn-fluct.sh.adingo.jp',\n      'https://s.sh.adingo.jp',\n      'https://i.adingo.jp',\n    ],\n  },\n\n  'forkmedia': {\n    prefetch: 'https://delivery.forkcdn.com/rappio/inread/v1.1/amp/inread.js',\n    renderStartImplemented: true,\n  },\n\n  'freewheel': {\n    prefetch: 'https://cdn.stickyadstv.com/prime-time/fw-amp.min.js',\n    renderStartImplemented: true,\n  },\n\n  'fusion': {\n    prefetch: 'https://assets.adtomafusion.net/fusion/latest/fusion-amp.min.js',\n  },\n\n  'genieessp': {\n    prefetch: 'https://js.gsspcln.jp/l/amp.js',\n  },\n\n  'giraff': {\n    renderStartImplemented: true,\n  },\n\n  'gmossp': {\n    prefetch: 'https://cdn.gmossp-sp.jp/ads/amp.js',\n  },\n\n  'gumgum': {\n    prefetch: 'https://js.gumgum.com/slot.js',\n    renderStartImplemented: true,\n  },\n\n  'holder': {\n    prefetch: 'https://i.holder.com.ua/js2/holder/ajax/ampv1.js',\n    preconnect: 'https://h.holder.com.ua',\n    renderStartImplemented: true,\n  },\n\n  'ibillboard': {},\n\n  'idealmedia': {\n    renderStartImplemented: true,\n    preconnect: [\n      'https://jsc.idealmedia.io',\n      'https://servicer.idealmedia.io',\n      'https://s-img.idealmedia.io/',\n    ],\n  },\n\n  'imedia': {\n    prefetch: 'https://i.imedia.cz/js/im3.js',\n    renderStartImplemented: true,\n  },\n\n  'imobile': {\n    prefetch: 'https://spamp.i-mobile.co.jp/script/amp.js',\n    preconnect: 'https://spad.i-mobile.co.jp',\n  },\n  'imonomy': {\n    renderStartImplemented: true,\n  },\n  'improvedigital': {},\n\n  'industrybrains': {\n    prefetch: 'https://web.industrybrains.com/js/ads/async/show.js',\n    preconnect: [\n      'https://staticd.cdn.industrybrains.com',\n      'https://static.industrybrains.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'inmobi': {\n    prefetch: 'https://cf.cdn.inmobi.com/ad/inmobi.secure.js',\n    renderStartImplemented: true,\n  },\n\n  'innity': {\n    prefetch: 'https://cdn.innity.net/admanager.js',\n    preconnect: 'https://as.innity.com',\n    renderStartImplemented: true,\n  },\n\n  'insticator': {\n    preconnect: 'https://d3lcz8vpax4lo2.cloudfront.net', // can also be array if more than one URL needed\n    renderStartImplemented: true,\n  },\n\n  'invibes': {\n    prefetch: 'https://k.r66net.com/GetAmpLink',\n    renderStartImplemented: true,\n    consentHandlingOverride: true,\n  },\n\n  'ix': {\n    prefetch: ['https://js-sec.indexww.com/apl/amp.js'],\n    preconnect: 'https://as-sec.casalemedia.com',\n    renderStartImplemented: true,\n  },\n\n  'jubna': {},\n\n  'kargo': {},\n\n  'kiosked': {\n    renderStartImplemented: true,\n  },\n\n  'kixer': {\n    prefetch: 'https://cdn.kixer.com/ad/load.js',\n    renderStartImplemented: true,\n  },\n\n  'kuadio': {},\n\n  'lentainform': {\n    renderStartImplemented: true,\n    preconnect: [\n      'https://jsc.lentainform.com',\n      'https://servicer.lentainform.com',\n      'https://s-img.lentainform.com',\n    ],\n  },\n\n  'ligatus': {\n    prefetch: 'https://ssl.ligatus.com/render/ligrend.js',\n    renderStartImplemented: true,\n  },\n\n  'lockerdome': {\n    prefetch: 'https://cdn2.lockerdomecdn.com/_js/amp.js',\n    renderStartImplemented: true,\n  },\n\n  'logly': {\n    preconnect: ['https://l.logly.co.jp', 'https://cdn.logly.co.jp'],\n    renderStartImplemented: true,\n  },\n\n  'loka': {\n    prefetch: 'https://loka-cdn.akamaized.net/scene/amp.js',\n    preconnect: [\n      'https://scene-front.lokaplatform.com',\n      'https://loka-materials.akamaized.net',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'mads': {\n    prefetch: 'https://eu2.madsone.com/js/tags.js',\n  },\n\n  'mantis-display': {\n    prefetch: 'https://assets.mantisadnetwork.com/mantodea.min.js',\n    preconnect: [\n      'https://mantodea.mantisadnetwork.com',\n      'https://res.cloudinary.com',\n      'https://resize.mantisadnetwork.com',\n    ],\n  },\n\n  'mantis-recommend': {\n    prefetch: 'https://assets.mantisadnetwork.com/recommend.min.js',\n    preconnect: [\n      'https://mantodea.mantisadnetwork.com',\n      'https://resize.mantisadnetwork.com',\n    ],\n  },\n\n  'mediaimpact': {\n    prefetch: 'https://ec-ns.sascdn.com/diff/251/pages/amp_default.js',\n    preconnect: [\n      'https://ww251.smartadserver.com',\n      'https://static.sascdn.com/',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'medianet': {\n    preconnect: 'https://contextual.media.net',\n    renderStartImplemented: true,\n  },\n\n  'mediavine': {\n    prefetch: 'https://amp.mediavine.com/wrapper.min.js',\n    preconnect: [\n      'https://partner.googleadservices.com',\n      'https://securepubads.g.doubleclick.net',\n      'https://tpc.googlesyndication.com',\n    ],\n    renderStartImplemented: true,\n    consentHandlingOverride: true,\n  },\n\n  'medyanet': {\n    renderStartImplemented: true,\n  },\n\n  'meg': {\n    renderStartImplemented: true,\n  },\n\n  'mgid': {\n    renderStartImplemented: true,\n    preconnect: [\n      'https://jsc.mgid.com',\n      'https://servicer.mgid.com',\n      'https://s-img.mgid.com',\n    ],\n  },\n\n  'microad': {\n    prefetch: 'https://j.microad.net/js/camp.js',\n    preconnect: [\n      'https://s-rtb.send.microad.jp',\n      'https://s-rtb.send.microadinc.com',\n      'https://cache.send.microad.jp',\n      'https://cache.send.microadinc.com',\n      'https://deb.send.microad.jp',\n    ],\n  },\n\n  'miximedia': {\n    renderStartImplemented: true,\n  },\n\n  'mixpo': {\n    prefetch: 'https://cdn.mixpo.com/js/loader.js',\n    preconnect: ['https://player1.mixpo.com', 'https://player2.mixpo.com'],\n  },\n\n  'monetizer101': {\n    renderStartImplemented: true,\n  },\n\n  'mox': {\n    prefetch: [\n      'https://ad.mox.tv/js/amp.min.js',\n      'https://ad.mox.tv/mox/mwayss_invocation.min.js',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'mytarget': {\n    prefetch: 'https://ad.mail.ru/static/ads-async.js',\n    renderStartImplemented: true,\n  },\n\n  'mywidget': {\n    preconnect: 'https://likemore-fe.go.mail.ru',\n    prefetch: 'https://likemore-go.imgsmail.ru/widget_amp.js',\n    renderStartImplemented: true,\n  },\n\n  'nativeroll': {\n    prefetch: 'https://cdn01.nativeroll.tv/js/seedr-player.min.js',\n  },\n\n  'nativo': {\n    prefetch: 'https://s.ntv.io/serve/load.js',\n  },\n\n  'navegg': {\n    renderStartImplemented: true,\n  },\n\n  'nend': {\n    prefetch: 'https://js1.nend.net/js/amp.js',\n    preconnect: ['https://output.nend.net', 'https://img1.nend.net'],\n  },\n\n  'netletix': {\n    preconnect: ['https://call.netzathleten-media.de'],\n    renderStartImplemented: true,\n  },\n\n  'noddus': {\n    prefetch: 'https://noddus.com/amp_loader.js',\n    renderStartImplemented: true,\n  },\n\n  'nokta': {\n    prefetch: 'https://static.virgul.com/theme/mockups/noktaamp/ampjs.js',\n    renderStartImplemented: true,\n  },\n\n  'nws': {},\n\n  'onead': {\n    prefetch: 'https://ad-specs.guoshipartners.com/static/js/onead-amp.min.js',\n    renderStartImplemented: true,\n  },\n\n  'onnetwork': {\n    renderStartImplemented: true,\n  },\n\n  'openadstream': {},\n\n  'openx': {\n    prefetch: 'https://www.googletagservices.com/tag/js/gpt.js',\n    preconnect: [\n      'https://partner.googleadservices.com',\n      'https://securepubads.g.doubleclick.net',\n      'https://tpc.googlesyndication.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'opinary': {},\n\n  'outbrain': {\n    renderStartImplemented: true,\n    prefetch: 'https://widgets.outbrain.com/widgetAMP/outbrainAMP.min.js',\n    preconnect: ['https://odb.outbrain.com'],\n    consentHandlingOverride: true,\n  },\n\n  'pixels': {\n    prefetch: 'https://cdn.adsfactor.net/amp/pixels-amp.min.js',\n    clientIdCookieName: '__AF',\n    renderStartImplemented: true,\n  },\n\n  'plista': {},\n\n  'polymorphicads': {\n    prefetch: 'https://www.polymorphicads.jp/js/amp.js',\n    preconnect: [\n      'https://img.polymorphicads.jp',\n      'https://ad.polymorphicads.jp',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'popin': {\n    renderStartImplemented: true,\n  },\n\n  'postquare': {},\n\n  'pressboard': {\n    renderStartImplemented: true,\n  },\n\n  'promoteiq': {},\n\n  'pubexchange': {},\n\n  'pubguru': {\n    renderStartImplemented: true,\n  },\n\n  'pubmatic': {\n    prefetch: 'https://ads.pubmatic.com/AdServer/js/amp.js',\n  },\n\n  'pubmine': {\n    prefetch: ['https://s.pubmine.com/head.js'],\n    preconnect: 'https://delivery.g.switchadhub.com',\n    renderStartImplemented: true,\n  },\n\n  'puffnetwork': {\n    prefetch: 'https://static.puffnetwork.com/amp_ad.js',\n    renderStartImplemented: true,\n  },\n\n  'pulsepoint': {\n    prefetch: 'https://ads.contextweb.com/TagPublish/getjs.static.js',\n    preconnect: 'https://tag.contextweb.com',\n  },\n\n  'purch': {\n    prefetch: 'https://ramp.purch.com/serve/creative_amp.js',\n    renderStartImplemented: true,\n  },\n\n  'quoraad': {\n    prefetch: 'https://a.quora.com/amp_ad.js',\n    preconnect: 'https://ampad.quora.com',\n    renderStartImplemented: true,\n  },\n\n  'rbinfox': {\n    renderStartImplemented: true,\n  },\n\n  'readmo': {\n    renderStartImplemented: true,\n  },\n\n  'realclick': {\n    renderStartImplemented: true,\n  },\n\n  'recomad': {\n    renderStartImplemented: true,\n  },\n\n  'relap': {\n    renderStartImplemented: true,\n  },\n\n  'revcontent': {\n    prefetch:\n      'https://labs-cdn.revcontent.com/build/amphtml/revcontent.amp.min.js',\n    preconnect: [\n      'https://trends.revcontent.com',\n      'https://cdn.revcontent.com',\n      'https://img.revcontent.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'revjet': {\n    prefetch: 'https://cdn.revjet.com/~cdn/JS/03/amp.js',\n    renderStartImplemented: true,\n  },\n\n  'rfp': {\n    prefetch: 'https://js.rfp.fout.jp/rfp-amp.js',\n    preconnect: 'https://ad.rfp.fout.jp',\n    renderStartImplemented: true,\n  },\n\n  'rnetplus': {},\n\n  'rubicon': {},\n\n  'runative': {\n    prefetch: 'https://cdn.run-syndicate.com/sdk/v1/n.js',\n    renderStartImplemented: true,\n  },\n\n  'sas': {\n    renderStartImplemented: true,\n  },\n\n  'seedingalliance': {},\n\n  'sekindo': {\n    renderStartImplemented: true,\n  },\n\n  'sharethrough': {\n    renderStartImplemented: true,\n  },\n\n  'shemedia': {\n    prefetch: [\n      'https://securepubads.g.doubleclick.net/tag/js/gpt.js',\n      'https://ads.shemedia.com/static/amp.js',\n    ],\n    preconnect: [\n      'https://partner.googleadservices.com',\n      'https://tpc.googlesyndication.com',\n      'https://ads.blogherads.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'sklik': {\n    prefetch: 'https://c.imedia.cz/js/amp.js',\n  },\n\n  'slimcutmedia': {\n    preconnect: [\n      'https://sb.freeskreen.com',\n      'https://static.freeskreen.com',\n      'https://video.freeskreen.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'smartadserver': {\n    prefetch: 'https://ec-ns.sascdn.com/diff/js/amp.v0.js',\n    preconnect: 'https://static.sascdn.com',\n    renderStartImplemented: true,\n  },\n\n  'smartclip': {\n    prefetch: 'https://cdn.smartclip.net/amp/amp.v0.js',\n    preconnect: 'https://des.smartclip.net',\n    renderStartImplemented: true,\n  },\n\n  'smi2': {\n    renderStartImplemented: true,\n  },\n\n  'smilewanted': {\n    prefetch: 'https://prebid.smilewanted.com/amp/amp.js',\n    preconnect: 'https://static.smilewanted.com',\n    renderStartImplemented: true,\n  },\n\n  'sogouad': {\n    prefetch: 'https://theta.sogoucdn.com/wap/js/aw.js',\n    renderStartImplemented: true,\n  },\n\n  'sortable': {\n    prefetch: 'https://www.googletagservices.com/tag/js/gpt.js',\n    preconnect: [\n      'https://tags-cdn.deployads.com',\n      'https://partner.googleadservices.com',\n      'https://securepubads.g.doubleclick.net',\n      'https://tpc.googlesyndication.com',\n    ],\n    renderStartImplemented: true,\n  },\n\n  'sovrn': {\n    prefetch: 'https://ap.lijit.com/www/sovrn_amp/sovrn_ads.js',\n  },\n\n  'speakol': {\n    renderStartImplemented: true,\n  },\n\n  'spotx': {\n    preconnect: 'https://js.spotx.tv',\n    renderStartImplemented: true,\n  },\n\n  'strossle': {\n    preconnect: [\n      'https://amp.spklw.com',\n      'https://widgets.sprinklecontent.com',\n      'https://images.sprinklecontent.com',\n    ],\n  },\n\n  'sunmedia': {\n    prefetch: 'https://vod.addevweb.com/sunmedia/amp/ads/sunmedia.js',\n    preconnect: 'https://static.addevweb.com',\n    renderStartImplemented: true,\n  },\n\n  'svknative': {\n    renderStartImplemented: true,\n    prefetch: 'https://widget.svk-native.ru/js/embed.js',\n  },\n\n  'swoop': {\n    prefetch: 'https://www.swoop-amp.com/amp.js',\n    preconnect: ['https://www.swpsvc.com', 'https://client.swpcld.com'],\n    renderStartImplemented: true,\n  },\n\n  'taboola': {},\n\n  'tcsemotion': {\n    prefetch: 'https://ads.tcsemotion.com/www/delivery/amphb.js',\n    renderStartImplemented: true,\n  },\n\n  'teads': {\n    prefetch: 'https://a.teads.tv/media/format/v3/teads-format.min.js',\n    preconnect: [\n      'https://cdn2.teads.tv',\n      'https://t.teads.tv',\n      'https://r.teads.tv',\n    ],\n    consentHandlingOverride: true,\n  },\n\n  'torimochi': {\n    renderStartImplemented: true,\n  },\n\n  'tracdelight': {\n    prefetch: 'https://scripts.tracdelight.io/amp.js',\n    renderStartImplemented: true,\n  },\n\n  'triplelift': {},\n\n  'trugaze': {\n    clientIdScope: '__tg_amp',\n    renderStartImplemented: true,\n  },\n\n  'uas': {\n    prefetch: 'https://ads.pubmatic.com/AdServer/js/phoenix.js',\n  },\n\n  'ucfunnel': {\n    renderStartImplemented: true,\n  },\n\n  'uzou': {\n    preconnect: ['https://speee-ad.akamaized.net'],\n    renderStartImplemented: true,\n  },\n\n  'unruly': {\n    prefetch: 'https://video.unrulymedia.com/native/native-loader.js',\n    renderStartImplemented: true,\n  },\n\n  'valuecommerce': {\n    prefetch: 'https://amp.valuecommerce.com/amp_bridge.js',\n    preconnect: ['https://ad.jp.ap.valuecommerce.com'],\n    renderStartImplemented: true,\n  },\n\n  'videointelligence': {\n    preconnect: 'https://s.vi-serve.com',\n    renderStartImplemented: true,\n  },\n\n  'videonow': {\n    renderStartImplemented: true,\n  },\n\n  'viralize': {\n    renderStartImplemented: true,\n  },\n\n  'vmfive': {\n    prefetch: 'https://man.vm5apis.com/dist/adn-web-sdk.js',\n    preconnect: ['https://vawpro.vm5apis.com', 'https://vahfront.vm5apis.com'],\n    renderStartImplemented: true,\n  },\n\n  'webediads': {\n    prefetch: 'https://eu1.wbdds.com/amp.min.js',\n    preconnect: ['https://goutee.top', 'https://mediaathay.org.uk'],\n    renderStartImplemented: true,\n  },\n\n  'weborama-display': {\n    prefetch: [\n      'https://cstatic.weborama.fr/js/advertiserv2/adperf_launch_1.0.0_scrambled.js',\n      'https://cstatic.weborama.fr/js/advertiserv2/adperf_core_1.0.0_scrambled.js',\n    ],\n  },\n\n  'widespace': {},\n\n  'wisteria': {\n    renderStartImplemented: true,\n  },\n\n  'wpmedia': {\n    prefetch: 'https://std.wpcdn.pl/wpjslib/wpjslib-amp.js',\n    preconnect: ['https://www.wp.pl', 'https://v.wpimg.pl'],\n    renderStartImplemented: true,\n  },\n\n  'xlift': {\n    prefetch: 'https://cdn.x-lift.jp/resources/common/xlift_amp.js',\n    renderStartImplemented: true,\n  },\n\n  'yahoo': {\n    prefetch: 'https://s.yimg.com/os/ampad/display.js',\n    preconnect: 'https://us.adserver.yahoo.com',\n  },\n\n  'yahoojp': {\n    prefetch: [\n      'https://s.yimg.jp/images/listing/tool/yads/ydn/amp/amp.js',\n      'https://yads.c.yimg.jp/js/yads.js',\n    ],\n    preconnect: 'https://yads.yahoo.co.jp',\n  },\n\n  'yahoonativeads': {\n    renderStartImplemented: true,\n  },\n\n  'yandex': {\n    prefetch: 'https://yastatic.net/partner-code/loaders/context_amp.js',\n    renderStartImplemented: true,\n  },\n\n  'yengo': {\n    renderStartImplemented: true,\n  },\n\n  'yieldbot': {\n    prefetch: [\n      'https://cdn.yldbt.com/js/yieldbot.intent.amp.js',\n      'https://msg.yldbt.com/js/ybmsg.html',\n    ],\n    preconnect: 'https://i.yldbt.com',\n  },\n\n  'yieldmo': {\n    prefetch: 'https://static.yieldmo.com/ym.1.js',\n    preconnect: ['https://s.yieldmo.com', 'https://ads.yieldmo.com'],\n    renderStartImplemented: true,\n  },\n\n  'yieldone': {\n    prefetch: 'https://img.ak.impact-ad.jp/ic/pone/commonjs/yone-amp.js',\n  },\n\n  'yieldpro': {\n    preconnect: 'https://creatives.yieldpro.eu',\n    renderStartImplemented: true,\n  },\n\n  'zedo': {\n    prefetch: 'https://ss3.zedo.com/gecko/tag/Gecko.amp.min.js',\n    renderStartImplemented: true,\n  },\n\n  'zen': {\n    prefetch: 'https://zen.yandex.ru/widget-loader',\n    preconnect: ['https://yastatic.net/'],\n    renderStartImplemented: true,\n  },\n\n  'zergnet': {},\n\n  'zucks': {\n    preconnect: [\n      'https://j.zucks.net.zimg.jp',\n      'https://sh.zucks.net',\n      'https://k.zucks.net',\n      'https://static.zucks.net.zimg.jp',\n    ],\n  },\n\n  'baidu': {\n    prefetch: 'https://dup.baidustatic.com/js/dm.js',\n    renderStartImplemented: true,\n  },\n});\n\nexport {adConfig};\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @typedef {{name: string, value: (string|number|null)}} */\nexport let QueryParameterDef;\n\n/**\n * Builds a URL from query parameters, truncating to a maximum length if\n * necessary.\n * @param {string} baseUrl scheme, domain, and path for the URL.\n * @param {!Object<string,string|number|null>} queryParams query parameters for\n *     the URL.\n * @param {number} maxLength length to truncate the URL to if necessary.\n * @param {?QueryParameterDef=} opt_truncationQueryParam query parameter to\n *     append to the URL iff any query parameters were truncated.\n * @return {string} the fully constructed URL.\n */\nexport function buildUrl(\n  baseUrl,\n  queryParams,\n  maxLength,\n  opt_truncationQueryParam\n) {\n  const encodedParams = [];\n  const encodedTruncationParam =\n    opt_truncationQueryParam &&\n    !(\n      opt_truncationQueryParam.value == null ||\n      opt_truncationQueryParam.value === ''\n    )\n      ? encodeURIComponent(opt_truncationQueryParam.name) +\n        '=' +\n        encodeURIComponent(String(opt_truncationQueryParam.value))\n      : null;\n  let capacity = maxLength - baseUrl.length;\n  if (encodedTruncationParam) {\n    capacity -= encodedTruncationParam.length + 1;\n  }\n  const keys = Object.keys(queryParams);\n  for (let i = 0; i < keys.length; i++) {\n    const key = keys[i];\n    const value = queryParams[key];\n    if (value == null || value === '') {\n      continue;\n    }\n    const encodedNameAndSep = encodeURIComponent(key) + '=';\n    const encodedValue = encodeURIComponent(String(value));\n    const fullLength = encodedNameAndSep.length + encodedValue.length + 1;\n    if (fullLength > capacity) {\n      const truncatedValue = encodedValue\n        .substr(0, capacity - encodedNameAndSep.length - 1)\n        // Don't end with a partially truncated escape sequence\n        .replace(/%\\w?$/, '');\n      if (truncatedValue) {\n        encodedParams.push(encodedNameAndSep + truncatedValue);\n      }\n      if (encodedTruncationParam) {\n        encodedParams.push(encodedTruncationParam);\n      }\n      break;\n    }\n    encodedParams.push(encodedNameAndSep + encodedValue);\n    capacity -= fullLength;\n  }\n  if (!encodedParams.length) {\n    return baseUrl;\n  }\n  return baseUrl + '?' + encodedParams.join('&');\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Machinery for doing \"traffic-level\" experiments.  That is, rather than\n * a single user choosing to opt-in to an experimental version of a module,\n * this framework allows you to do randomized, controlled experiments on all\n * AMP page loads to, for example, test relative performance or look for\n * impacts on click-throughs.\n */\n\nimport {EXPERIMENT_ATTRIBUTE, mergeExperimentIds} from './utils';\nimport {\n  ExperimentInfo, // eslint-disable-line no-unused-vars\n} from '../../../src/experiments';\nimport {Services} from '../../../src/services';\nimport {parseQueryString} from '../../../src/url';\n\n/** @typedef {{\n *    control: string,\n *    experiment: string\n *  }} */\nexport let A4aExperimentBranches;\n\n/** @type {string} @private */\nexport const MANUAL_EXPERIMENT_ID = '117152632';\n\n/**\n * Experiment IDs used to identify single pass experiments.\n *\n * @enum {string}\n */\nexport const SINGLE_PASS_EXPERIMENT_IDS = {\n  MULTI_PASS: '21063529',\n  SINGLE_PASS: '21063530',\n};\n\n/**\n * @param {!Window} win\n * @param {!Element} element Ad tag Element.\n * @return {?string} experiment extracted from page url.\n */\nexport function extractUrlExperimentId(win, element) {\n  const expParam =\n    Services.ampdoc(element).getParam('exp') ||\n    parseQueryString(win.location.search)['exp'];\n  if (!expParam) {\n    return null;\n  }\n  // Allow for per type experiment control with Doubleclick key set for 'da'\n  // and AdSense using 'aa'.  Fallback to 'a4a' if type specific is missing.\n  const expKeys = [\n    (element.getAttribute('type') || '').toLowerCase() == 'doubleclick'\n      ? 'da'\n      : 'aa',\n    'a4a',\n  ];\n  let arg;\n  let match;\n  expKeys.forEach(\n    key =>\n      (arg =\n        arg ||\n        ((match = new RegExp(`(?:^|,)${key}:(-?\\\\d+)`).exec(expParam)) &&\n          match[1]))\n  );\n  return arg || null;\n}\n\n/**\n * Sets of experiment IDs can be attached to Elements via attributes.  In\n * that case, we encode them as a string containing a comma-separated list\n * of experiment IDs.  This parses a comma-separated list from a string into\n * a list of ID strings.  If the input string is empty or null, this returns\n * the empty list.  This does no validity checking on the ID formats -- for\n * that, use validateExperimentIds.\n *\n * @param {?string} idString  String to parse.\n * @return {!Array<string>}  List of experiment IDs (possibly empty).\n * @see validateExperimentIds\n */\nexport function parseExperimentIds(idString) {\n  if (idString) {\n    return idString.split(',');\n  }\n  return [];\n}\n\n/**\n * Checks whether the given element is a member of the given experiment branch.\n * I.e., whether the element's data-experiment-id attribute contains the id\n * value (possibly because the host page URL contains a 'exp=a4a:X' parameter\n * and #maybeSetExperimentFromUrl has added the appropriate EID).\n *\n * @param {!Element} element Element to check for membership in a specific\n *   experiment.\n * @param {?string} id Experiment ID to check for on `element`.\n * @return {boolean}\n */\nexport function isInExperiment(element, id) {\n  return parseExperimentIds(element.getAttribute(EXPERIMENT_ATTRIBUTE)).some(\n    x => {\n      return x === id;\n    }\n  );\n}\n\n/**\n * Checks whether the given element is a member of the 'manually triggered\n * \"experiment\" branch'.  I.e., whether the element's data-experiment-id\n * attribute contains the MANUAL_EXPERIMENT_ID value (hopefully because the\n * user has manually specified 'exp=a4a:-1' in the host page URL and\n * #maybeSetExperimentFromUrl has added it).\n *\n * @param {!Element} element  Element to check for manual experiment membership.\n * @return {boolean}\n */\nexport function isInManualExperiment(element) {\n  return isInExperiment(element, MANUAL_EXPERIMENT_ID);\n}\n\n/**\n * Checks that all string experiment IDs in a list are syntactically valid\n * (integer base 10).\n *\n * @param {!Array<string>} idList  List of experiment IDs.  Can be empty.\n * @return {boolean} Whether all list elements are valid experiment IDs.\n */\nexport function validateExperimentIds(idList) {\n  return idList.every(id => {\n    return !isNaN(parseInt(id, 10));\n  });\n}\n\n/**\n * Adds a single experimentID to an element iff it's a valid experiment ID.\n * No-ops if the experimentId is undefined.\n *\n * @param {string|undefined} experimentId  ID to add to the element.\n * @param {Element} element to add the experiment ID to.\n */\nexport function addExperimentIdToElement(experimentId, element) {\n  if (!experimentId) {\n    return;\n  }\n  const currentEids = element.getAttribute(EXPERIMENT_ATTRIBUTE);\n  if (currentEids && validateExperimentIds(parseExperimentIds(currentEids))) {\n    element.setAttribute(\n      EXPERIMENT_ATTRIBUTE,\n      mergeExperimentIds([experimentId], currentEids)\n    );\n  } else {\n    element.setAttribute(EXPERIMENT_ATTRIBUTE, experimentId);\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CONSENT_POLICY_STATE} from '../../../src/consent-state';\nimport {DomFingerprint} from '../../../src/utils/dom-fingerprint';\nimport {Services} from '../../../src/services';\nimport {buildUrl} from './shared/url-builder';\nimport {dev, devAssert} from '../../../src/log';\nimport {dict} from '../../../src/utils/object';\nimport {\n  getBinaryType,\n  isExperimentOn,\n  toggleExperiment,\n} from '../../../src/experiments';\nimport {getConsentPolicyState} from '../../../src/consent';\nimport {getMeasuredResources} from '../../../src/ini-load';\nimport {getMode} from '../../../src/mode';\nimport {getOrCreateAdCid} from '../../../src/ad-cid';\nimport {getTimingDataSync} from '../../../src/service/variable-source';\nimport {internalRuntimeVersion} from '../../../src/internal-version';\nimport {parseJson} from '../../../src/json';\nimport {whenUpgradedToCustomElement} from '../../../src/dom';\n\n/** @type {string}  */\nconst AMP_ANALYTICS_HEADER = 'X-AmpAnalytics';\n\n/** @const {number} */\nconst MAX_URL_LENGTH = 15360;\n\n/** @enum {string} */\nconst AmpAdImplementation = {\n  AMP_AD_XHR_TO_IFRAME: '2',\n  AMP_AD_XHR_TO_IFRAME_OR_AMP: '3',\n  AMP_AD_IFRAME_GET: '5',\n};\n\n/** @const {!Object} */\nexport const ValidAdContainerTypes = {\n  'AMP-CAROUSEL': 'ac',\n  'AMP-FX-FLYING-CARPET': 'fc',\n  'AMP-LIGHTBOX': 'lb',\n  'AMP-STICKY-AD': 'sa',\n};\n\n/**\n * See `VisibilityState` enum.\n * @const {!Object<string, string>}\n */\nconst visibilityStateCodes = {\n  'visible': '1',\n  'hidden': '2',\n  'prerender': '3',\n  'unloaded': '5',\n};\n\n/** @const {string} */\nexport const QQID_HEADER = 'X-QQID';\n\n/** @type {string} */\nexport const SANDBOX_HEADER = 'amp-ff-sandbox';\n\n/**\n * Element attribute that stores experiment IDs.\n *\n * Note: This attribute should be used only for tracking experimental\n * implementations of AMP tags, e.g., by AMPHTML implementors.  It should not be\n * added by a publisher page.\n *\n * @const {string}\n * @visibleForTesting\n */\nexport const EXPERIMENT_ATTRIBUTE = 'data-experiment-id';\n\n/** @typedef {{urls: !Array<string>}}\n */\nexport let AmpAnalyticsConfigDef;\n\n/**\n * @typedef {{instantLoad: boolean, writeInBody: boolean}}\n */\nexport let NameframeExperimentConfig;\n\n/**\n * @const {!./shared/url-builder.QueryParameterDef}\n * @visibleForTesting\n */\nexport const TRUNCATION_PARAM = {name: 'trunc', value: '1'};\n\n/** @const {Object} */\nconst CDN_PROXY_REGEXP = /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org((\\/.*)|($))+/;\n\n/**\n * Returns the value of some navigation timing parameter.\n * Feature detection is used for safety on browsers that do not support the\n * performance API.\n * @param {!Window} win\n * @param {string} timingEvent The name of the timing event, e.g.\n *     'navigationStart' or 'domContentLoadEventStart'.\n * @return {number}\n */\nfunction getNavigationTiming(win, timingEvent) {\n  return (\n    (win['performance'] &&\n      win['performance']['timing'] &&\n      win['performance']['timing'][timingEvent]) ||\n    0\n  );\n}\n\n/**\n * Check whether Google Ads supports the A4A rendering pathway is valid for the\n * environment by ensuring native crypto support and page originated in the\n * {@code cdn.ampproject.org} CDN <em>or</em> we must be running in local\n * dev mode.\n *\n * @param {!Window} win  Host window for the ad.\n * @return {boolean}  Whether Google Ads should attempt to render via the A4A\n *   pathway.\n */\nexport function isGoogleAdsA4AValidEnvironment(win) {\n  return (\n    supportsNativeCrypto(win) &&\n    (!!isCdnProxy(win) || getMode(win).localDev || getMode(win).test)\n  );\n}\n\n/**\n * Checks whether native crypto is supported for win.\n * @param {!Window} win  Host window for the ad.\n * @return {boolean} Whether native crypto is supported.\n */\nexport function supportsNativeCrypto(win) {\n  return win.crypto && (win.crypto.subtle || win.crypto.webkitSubtle);\n}\n\n/**\n * @param {!AMP.BaseElement} ampElement The element on whose lifecycle this\n *    reporter will be reporting.\n * @return {boolean} whether reporting is enabled for this element\n */\nexport function isReportingEnabled(ampElement) {\n  // Carve-outs: We only want to enable profiling pingbacks when:\n  //   - The ad is from one of the Google networks (AdSense or Doubleclick).\n  //   - The ad slot is in the A4A-vs-3p amp-ad control branch (either via\n  //     internal, client-side selection or via external, Google Search\n  //     selection).\n  //   - We haven't turned off profiling via the rate controls in\n  //     build-system/global-config/{canary,prod}-config.json\n  // If any of those fail, we use the `BaseLifecycleReporter`, which is a\n  // a no-op (sends no pings).\n  const type = ampElement.element.getAttribute('type');\n  const {win} = ampElement;\n  // In local dev mode, neither the canary nor prod config files is available,\n  // so manually set the profiling rate, for testing/dev.\n  if (getMode(ampElement.win).localDev && !getMode(ampElement.win).test) {\n    toggleExperiment(win, 'a4aProfilingRate', true, true);\n  }\n  return (\n    (type == 'doubleclick' || type == 'adsense') &&\n    isExperimentOn(win, 'a4aProfilingRate')\n  );\n}\n\n/**\n * Has side-effect of incrementing ifi counter on window.\n * @param {!../../../extensions/amp-a4a/0.1/amp-a4a.AmpA4A} a4a\n * @param {!Array<string>=} opt_experimentIds Any experiments IDs (in addition\n *     to those specified on the ad element) that should be included in the\n *     request.\n * @return {!Object<string,null|number|string>} block level parameters\n */\nexport function googleBlockParameters(a4a, opt_experimentIds) {\n  const {element: adElement, win} = a4a;\n  const slotRect = a4a.getPageLayoutBox();\n  const iframeDepth = iframeNestingDepth(win);\n  const enclosingContainers = getEnclosingContainerTypes(adElement);\n  let eids = adElement.getAttribute('data-experiment-id');\n  if (opt_experimentIds) {\n    eids = mergeExperimentIds(opt_experimentIds, eids);\n  }\n  return {\n    'adf': DomFingerprint.generate(adElement),\n    'nhd': iframeDepth,\n    'eid': eids,\n    'adx': slotRect.left,\n    'ady': slotRect.top,\n    'oid': '2',\n    'act': enclosingContainers.length ? enclosingContainers.join() : null,\n  };\n}\n\n/**\n * @param {!Window} win\n * @param {string} type matching typing attribute.\n * @param {function(!Element):string} groupFn\n * @return {!Promise<!Object<string,!Array<!Promise<!../../../src/base-element.BaseElement>>>>}\n */\nexport function groupAmpAdsByType(win, type, groupFn) {\n  // Look for amp-ad elements of correct type or those contained within\n  // standard container type.  Note that display none containers will not be\n  // included as they will never be measured.\n  // TODO(keithwrightbos): what about slots that become measured due to removal\n  // of display none (e.g. user resizes viewport and media selector makes\n  // visible).\n  const ampAdSelector = r =>\n    r.element./*OK*/ querySelector(`amp-ad[type=${type}]`);\n  const {documentElement} = win.document;\n  const ampdoc = Services.ampdoc(documentElement);\n  return (\n    getMeasuredResources(ampdoc, win, r => {\n      const isAmpAdType =\n        r.element.tagName == 'AMP-AD' && r.element.getAttribute('type') == type;\n      if (isAmpAdType) {\n        return true;\n      }\n      const isAmpAdContainerElement =\n        Object.keys(ValidAdContainerTypes).includes(r.element.tagName) &&\n        !!ampAdSelector(r);\n      return isAmpAdContainerElement;\n    })\n      // Need to wait on any contained element resolution followed by build\n      // of child ad.\n      .then(resources =>\n        Promise.all(\n          resources.map(resource => {\n            if (resource.element.tagName == 'AMP-AD') {\n              return resource.element;\n            }\n            // Must be container element so need to wait for child amp-ad to\n            // be upgraded.\n            return whenUpgradedToCustomElement(\n              dev().assertElement(ampAdSelector(resource))\n            );\n          })\n        )\n      )\n      // Group by networkId.\n      .then(elements =>\n        elements.reduce((result, element) => {\n          const groupId = groupFn(element);\n          (result[groupId] || (result[groupId] = [])).push(element.getImpl());\n          return result;\n        }, {})\n      )\n  );\n}\n\n/**\n * @param {! ../../../extensions/amp-a4a/0.1/amp-a4a.AmpA4A} a4a\n * @param {number} startTime\n * @return {!Promise<!Object<string,null|number|string>>}\n */\nexport function googlePageParameters(a4a, startTime) {\n  const {win} = a4a;\n  const ampDoc = a4a.getAmpDoc();\n  // Do not wait longer than 1 second to retrieve referrer to ensure\n  // viewer integration issues do not cause ad requests to hang indefinitely.\n  const referrerPromise = Services.timerFor(win)\n    .timeoutPromise(1000, Services.viewerForDoc(ampDoc).getReferrerUrl())\n    .catch(() => {\n      dev().expectedError('AMP-A4A', 'Referrer timeout!');\n      return '';\n    });\n  const domLoading = getNavigationTiming(win, 'domLoading');\n  return Promise.all([\n    getOrCreateAdCid(ampDoc, 'AMP_ECID_GOOGLE', '_ga'),\n    referrerPromise,\n  ]).then(promiseResults => {\n    const clientId = promiseResults[0];\n    const referrer = promiseResults[1];\n    const {pageViewId, canonicalUrl} = Services.documentInfoForDoc(ampDoc);\n    // Read by GPT for GA/GPT integration.\n    win.gaGlobal = win.gaGlobal || {cid: clientId, hid: pageViewId};\n    const {screen} = win;\n    const viewport = Services.viewportForDoc(ampDoc);\n    const viewportRect = viewport.getRect();\n    const viewportSize = viewport.getSize();\n    const visibilityState = ampDoc.getVisibilityState();\n    return {\n      'is_amp': a4a.isXhrAllowed()\n        ? AmpAdImplementation.AMP_AD_XHR_TO_IFRAME_OR_AMP\n        : AmpAdImplementation.AMP_AD_IFRAME_GET,\n      'amp_v': internalRuntimeVersion(),\n      'd_imp': '1',\n      'c': getCorrelator(win, ampDoc, clientId),\n      'ga_cid': win.gaGlobal.cid || null,\n      'ga_hid': win.gaGlobal.hid || null,\n      'dt': startTime,\n      'biw': viewportRect.width,\n      'bih': viewportRect.height,\n      'u_aw': screen ? screen.availWidth : null,\n      'u_ah': screen ? screen.availHeight : null,\n      'u_cd': screen ? screen.colorDepth : null,\n      'u_w': screen ? screen.width : null,\n      'u_h': screen ? screen.height : null,\n      'u_tz': -new Date().getTimezoneOffset(),\n      'u_his': getHistoryLength(win),\n      'isw': win != win.top ? viewportSize.width : null,\n      'ish': win != win.top ? viewportSize.height : null,\n      'art': getAmpRuntimeTypeParameter(win),\n      'vis': visibilityStateCodes[visibilityState] || '0',\n      'scr_x': viewport.getScrollLeft(),\n      'scr_y': viewport.getScrollTop(),\n      'bc': getBrowserCapabilitiesBitmap(win) || null,\n      'debug_experiment_id':\n        (/(?:#|,)deid=([\\d,]+)/i.exec(win.location.hash) || [])[1] || null,\n      'url': canonicalUrl || null,\n      'top': win != win.top ? topWindowUrlOrDomain(win) : null,\n      'loc': win.location.href == canonicalUrl ? null : win.location.href,\n      'ref': referrer || null,\n      'bdt': domLoading ? startTime - domLoading : null,\n    };\n  });\n}\n\n/**\n * @param {!../../../extensions/amp-a4a/0.1/amp-a4a.AmpA4A} a4a\n * @param {string} baseUrl\n * @param {number} startTime\n * @param {!Object<string,null|number|string>} parameters\n * @param {!Array<string>=} opt_experimentIds Any experiments IDs (in addition\n *     to those specified on the ad element) that should be included in the\n *     request.\n * @return {!Promise<string>}\n */\nexport function googleAdUrl(\n  a4a,\n  baseUrl,\n  startTime,\n  parameters,\n  opt_experimentIds\n) {\n  // TODO: Maybe add checks in case these promises fail.\n  const blockLevelParameters = googleBlockParameters(a4a, opt_experimentIds);\n  return googlePageParameters(a4a, startTime).then(pageLevelParameters => {\n    Object.assign(parameters, blockLevelParameters, pageLevelParameters);\n    return truncAndTimeUrl(baseUrl, parameters, startTime);\n  });\n}\n\n/**\n * @param {string} baseUrl\n * @param {!Object<string,null|number|string>} parameters\n * @param {number} startTime\n * @return {string}\n */\nexport function truncAndTimeUrl(baseUrl, parameters, startTime) {\n  return (\n    buildUrl(baseUrl, parameters, MAX_URL_LENGTH - 10, TRUNCATION_PARAM) +\n    '&dtd=' +\n    elapsedTimeWithCeiling(Date.now(), startTime)\n  );\n}\n\n/**\n * @param {!Window} win\n * @return {number}\n */\nfunction iframeNestingDepth(win) {\n  let w = win;\n  let depth = 0;\n  while (w != w.parent && depth < 100) {\n    w = w.parent;\n    depth++;\n  }\n  devAssert(w == win.top);\n  return depth;\n}\n\n/**\n * @param {!Window} win\n * @return {number}\n */\nfunction getHistoryLength(win) {\n  // We have seen cases where accessing history length causes errors.\n  try {\n    return win.history.length;\n  } catch (e) {\n    return 0;\n  }\n}\n\n/**\n * @param {string} url\n * @return {string} hostname portion of url\n * @visibleForTesting\n */\nexport function extractHost(url) {\n  return (/^(?:https?:\\/\\/)?([^\\/\\?:]+)/i.exec(url) || [])[1] || url;\n}\n\n/**\n * @param {!Window} win\n * @return {?string}\n */\nfunction topWindowUrlOrDomain(win) {\n  const {ancestorOrigins} = win.location;\n  if (ancestorOrigins) {\n    const {origin} = win.location;\n    const topOrigin = ancestorOrigins[ancestorOrigins.length - 1];\n    if (origin == topOrigin) {\n      return win.top.location.hostname;\n    }\n    const secondFromTop = secondWindowFromTop(win);\n    if (\n      secondFromTop == win ||\n      origin == ancestorOrigins[ancestorOrigins.length - 2]\n    ) {\n      return extractHost(secondFromTop./*OK*/ document.referrer);\n    }\n    return extractHost(topOrigin);\n  } else {\n    try {\n      return win.top.location.hostname;\n    } catch (e) {}\n    const secondFromTop = secondWindowFromTop(win);\n    try {\n      return extractHost(secondFromTop./*OK*/ document.referrer);\n    } catch (e) {}\n    return null;\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {!Window}\n */\nfunction secondWindowFromTop(win) {\n  let secondFromTop = win;\n  let depth = 0;\n  while (secondFromTop.parent != secondFromTop.parent.parent && depth < 100) {\n    secondFromTop = secondFromTop.parent;\n    depth++;\n  }\n  devAssert(secondFromTop.parent == win.top);\n  return secondFromTop;\n}\n\n/**\n * @param {number} time\n * @param {number} start\n * @return {(number|string)}\n */\nfunction elapsedTimeWithCeiling(time, start) {\n  const duration = time - start;\n  if (duration >= 1e6) {\n    return 'M';\n  } else if (duration >= 0) {\n    return duration;\n  }\n  return '-M';\n}\n\n/**\n * `nodeOrDoc` must be passed for correct behavior in shadow AMP (PWA) case.\n * @param {!Window} win\n * @param {!Element|!../../../src/service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string=} opt_cid\n * @return {number} The correlator.\n */\nexport function getCorrelator(win, elementOrAmpDoc, opt_cid) {\n  if (!win.ampAdPageCorrelator) {\n    win.ampAdPageCorrelator = isExperimentOn(win, 'exp-new-correlator')\n      ? Math.floor(4503599627370496 * Math.random())\n      : makeCorrelator(\n          Services.documentInfoForDoc(elementOrAmpDoc).pageViewId,\n          opt_cid\n        );\n  }\n  return win.ampAdPageCorrelator;\n}\n\n/**\n * @param {string} pageViewId\n * @param {string=} opt_clientId\n * @return {number}\n */\nfunction makeCorrelator(pageViewId, opt_clientId) {\n  const pageViewIdNumeric = Number(pageViewId || 0);\n  if (opt_clientId) {\n    return pageViewIdNumeric + (opt_clientId.replace(/\\D/g, '') % 1e6) * 1e6;\n  } else {\n    // In this case, pageViewIdNumeric is only 4 digits => too low entropy\n    // to be useful as a page correlator.  So synthesize one from scratch.\n    // 4503599627370496 == 2^52.  The guaranteed range of JS Number is at least\n    // 2^53 - 1.\n    return Math.floor(4503599627370496 * Math.random());\n  }\n}\n\n/**\n * Collect additional dimensions for the brdim parameter.\n * @param {!Window} win The window for which we read the browser dimensions.\n * @param {{width: number, height: number}|null} viewportSize\n * @return {string}\n * @visibleForTesting\n */\nexport function additionalDimensions(win, viewportSize) {\n  // Some browsers throw errors on some of these.\n  let screenX, screenY, outerWidth, outerHeight, innerWidth, innerHeight;\n  try {\n    screenX = win.screenX;\n    screenY = win.screenY;\n  } catch (e) {}\n  try {\n    outerWidth = win.outerWidth;\n    outerHeight = win.outerHeight;\n  } catch (e) {}\n  try {\n    innerWidth = viewportSize.width;\n    innerHeight = viewportSize.height;\n  } catch (e) {}\n  return [\n    win.screenLeft,\n    win.screenTop,\n    screenX,\n    screenY,\n    win.screen ? win.screen.availWidth : undefined,\n    win.screen ? win.screen.availTop : undefined,\n    outerWidth,\n    outerHeight,\n    innerWidth,\n    innerHeight,\n  ].join();\n}\n\n/**\n * Returns amp-analytics config for a new CSI trigger.\n * @param {string} on The name of the analytics trigger.\n * @param {!Object<string, string>} params Params to be included on the ping.\n * @return {!JsonObject}\n */\nfunction csiTrigger(on, params) {\n  return dict({\n    'on': on,\n    'request': 'csi',\n    'sampleSpec': {\n      // Pings are sampled on a per-pageview basis. A prefix is included in the\n      // sampleOn spec so that the hash is orthogonal to any other sampling in\n      // amp.\n      'sampleOn': 'a4a-csi-${pageViewId}',\n      'threshold': 1, // 1% sample\n    },\n    'selector': 'amp-ad',\n    'selectionMethod': 'closest',\n    'extraUrlParams': params,\n  });\n}\n\n/**\n * Returns amp-analytics config for Google ads network impls.\n * @return {!JsonObject}\n */\nexport function getCsiAmpAnalyticsConfig() {\n  return dict({\n    'requests': {\n      'csi': 'https://csi.gstatic.com/csi?',\n    },\n    'transport': {'xhrpost': false},\n    'triggers': {\n      'adRequestStart': csiTrigger('ad-request-start', {\n        // afs => ad fetch start\n        'met.a4a': 'afs_lvt.${viewerLastVisibleTime}~afs.${time}',\n      }),\n      'adResponseEnd': csiTrigger('ad-response-end', {\n        // afe => ad fetch end\n        'met.a4a': 'afe.${time}',\n      }),\n      'adRenderStart': csiTrigger('ad-render-start', {\n        // ast => ad schedule time\n        // ars => ad render start\n        'met.a4a':\n          'ast.${scheduleTime}~ars_lvt.${viewerLastVisibleTime}~ars.${time}',\n        'qqid': '${qqid}',\n      }),\n      'adIframeLoaded': csiTrigger('ad-iframe-loaded', {\n        // ail => ad iframe loaded\n        'met.a4a': 'ail.${time}',\n      }),\n    },\n    'extraUrlParams': {\n      's': 'ampad',\n      'ctx': '2',\n      'c': '${correlator}',\n      'slotId': '${slotId}',\n      // Time that the beacon was actually sent. Note that there can be delays\n      // between the time at which the event is fired and when ${nowMs} is\n      // evaluated when the URL is built by amp-analytics.\n      'puid': '${requestCount}~${timestamp}',\n    },\n  });\n}\n\n/**\n * Returns variables to be included in the amp-analytics event for A4A.\n * @param {string} analyticsTrigger The name of the analytics trigger.\n * @param {!AMP.BaseElement} a4a The A4A element.\n * @param {?string} qqid The query ID or null if the query ID has not been set\n *     yet.\n * @return {!JsonObject}\n */\nexport function getCsiAmpAnalyticsVariables(analyticsTrigger, a4a, qqid) {\n  const {win} = a4a;\n  const ampdoc = a4a.getAmpDoc();\n  const navStart = getNavigationTiming(win, 'navigationStart');\n  const vars = /** @type {!JsonObject} */ ({\n    'correlator': getCorrelator(win, ampdoc),\n    'slotId': a4a.element.getAttribute('data-amp-slot-index'),\n    'viewerLastVisibleTime': ampdoc.getLastVisibleTime() - navStart,\n  });\n  if (qqid) {\n    vars['qqid'] = qqid;\n  }\n  if (analyticsTrigger == 'ad-render-start') {\n    vars['scheduleTime'] = a4a.element.layoutScheduleTime - navStart;\n  }\n  return vars;\n}\n\n/**\n * Extracts configuration used to build amp-analytics element for active view.\n *\n * @param {!../../../extensions/amp-a4a/0.1/amp-a4a.AmpA4A} a4a\n * @param {!Headers} responseHeaders\n *   XHR service FetchResponseHeaders object containing the response\n *   headers.\n * @return {?JsonObject} config or null if invalid/missing.\n */\nexport function extractAmpAnalyticsConfig(a4a, responseHeaders) {\n  if (!responseHeaders.has(AMP_ANALYTICS_HEADER)) {\n    return null;\n  }\n  try {\n    const analyticsConfig = parseJson(\n      responseHeaders.get(AMP_ANALYTICS_HEADER)\n    );\n    devAssert(Array.isArray(analyticsConfig['url']));\n    const urls = analyticsConfig['url'];\n    if (!urls.length) {\n      return null;\n    }\n\n    const config = /** @type {JsonObject}*/ ({\n      'transport': {'beacon': false, 'xhrpost': false},\n      'triggers': {\n        'continuousVisible': {\n          'on': 'visible',\n          'visibilitySpec': {\n            'selector': 'amp-ad',\n            'selectionMethod': 'closest',\n            'visiblePercentageMin': 50,\n            'continuousTimeMin': 1000,\n          },\n        },\n      },\n    });\n\n    // Discover and build visibility endpoints.\n    const requests = dict();\n    for (let idx = 1; idx <= urls.length; idx++) {\n      // TODO: Ensure url is valid and not freeform JS?\n      requests[`visibility${idx}`] = `${urls[idx - 1]}`;\n    }\n    // Security review needed here.\n    config['requests'] = requests;\n    config['triggers']['continuousVisible']['request'] = Object.keys(requests);\n    return config;\n  } catch (err) {\n    dev().error(\n      'AMP-A4A',\n      'Invalid analytics',\n      err,\n      responseHeaders.get(AMP_ANALYTICS_HEADER)\n    );\n  }\n  return null;\n}\n\n/**\n * Add new experiment IDs to a (possibly empty) existing set of experiment IDs.\n * The {@code currentIdString} may be {@code null} or {@code ''}, but if it is\n * populated, it must contain a comma-separated list of integer experiment IDs\n * (per {@code parseExperimentIds()}).  Returns the new set of IDs, encoded\n * as a comma-separated list.  Does not de-duplicate ID entries.\n *\n * @param {!Array<string>} newIds IDs to merge in. Should contain stringified\n *     integer (base 10) experiment IDs.\n * @param {?string} currentIdString  If present, a string containing a\n *   comma-separated list of integer experiment IDs.\n * @return {string}  New experiment list string, including newId iff it is\n *   a valid (integer) experiment ID.\n * @see parseExperimentIds, validateExperimentIds\n */\nexport function mergeExperimentIds(newIds, currentIdString) {\n  const newIdString = newIds.filter(newId => Number(newId)).join(',');\n  currentIdString = currentIdString || '';\n  return (\n    currentIdString + (currentIdString && newIdString ? ',' : '') + newIdString\n  );\n}\n\n/**\n * Adds two CSI signals to the given amp-analytics configuration object, one\n * for render-start, and one for ini-load.\n *\n * @param {!Window} win\n * @param {!Element} element The ad slot.\n * @param {!JsonObject} config The original config object.\n * @param {?string} qqid\n * @param {boolean} isVerifiedAmpCreative\n * @return {?JsonObject} config or null if invalid/missing.\n */\nexport function addCsiSignalsToAmpAnalyticsConfig(\n  win,\n  element,\n  config,\n  qqid,\n  isVerifiedAmpCreative\n) {\n  // Add CSI pingbacks.\n  const correlator = getCorrelator(win, element);\n  const slotId = Number(element.getAttribute('data-amp-slot-index'));\n  const eids = encodeURIComponent(element.getAttribute(EXPERIMENT_ATTRIBUTE));\n  const adType = element.getAttribute('type');\n  const initTime = Number(\n    getTimingDataSync(win, 'navigationStart') || Date.now()\n  );\n  const deltaTime = Math.round(\n    win.performance && win.performance.now\n      ? win.performance.now()\n      : Date.now() - initTime\n  );\n  const baseCsiUrl =\n    'https://csi.gstatic.com/csi?s=a4a' +\n    `&c=${correlator}&slotId=${slotId}&qqid.${slotId}=${qqid}` +\n    `&dt=${initTime}` +\n    (eids != 'null' ? `&e.${slotId}=${eids}` : '') +\n    `&rls=${internalRuntimeVersion()}&adt.${slotId}=${adType}`;\n  const isAmpSuffix = isVerifiedAmpCreative ? 'Friendly' : 'CrossDomain';\n  config['triggers']['continuousVisibleIniLoad'] = {\n    'on': 'ini-load',\n    'selector': 'amp-ad',\n    'selectionMethod': 'closest',\n    'request': 'iniLoadCsi',\n  };\n  config['triggers']['continuousVisibleRenderStart'] = {\n    'on': 'render-start',\n    'selector': 'amp-ad',\n    'selectionMethod': 'closest',\n    'request': 'renderStartCsi',\n  };\n  config['requests']['iniLoadCsi'] =\n    baseCsiUrl + `&met.a4a.${slotId}=iniLoadCsi${isAmpSuffix}.${deltaTime}`;\n  config['requests']['renderStartCsi'] =\n    baseCsiUrl + `&met.a4a.${slotId}=renderStartCsi${isAmpSuffix}.${deltaTime}`;\n\n  // Add CSI ping for visibility.\n  config['requests']['visibilityCsi'] =\n    baseCsiUrl + `&met.a4a.${slotId}=visibilityCsi.${deltaTime}`;\n  config['triggers']['continuousVisible']['request'].push('visibilityCsi');\n  return config;\n}\n\n/**\n * Returns an array of two-letter codes representing the amp-ad containers\n * enclosing the given ad element.\n *\n * @param {!Element} adElement\n * @return {!Array<string>}\n */\nexport function getEnclosingContainerTypes(adElement) {\n  const containerTypeSet = {};\n  for (\n    let el = adElement.parentElement, counter = 0;\n    el && counter < 20;\n    el = el.parentElement, counter++\n  ) {\n    const tagName = el.tagName.toUpperCase();\n    if (ValidAdContainerTypes[tagName]) {\n      containerTypeSet[ValidAdContainerTypes[tagName]] = true;\n    }\n  }\n  return Object.keys(containerTypeSet);\n}\n\n/**\n * Appends parameter to ad request indicating error state so long as error\n * parameter is not already present or url has been truncated.\n * @param {string} adUrl used for network request\n * @param {string} parameterValue to be appended\n * @return {string|undefined} potentially modified url, undefined\n */\nexport function maybeAppendErrorParameter(adUrl, parameterValue) {\n  devAssert(!!adUrl && !!parameterValue);\n  // Add parameter indicating error so long as the url has not already been\n  // truncated and error parameter is not already present.  Note that we assume\n  // that added, error parameter length will be less than truncation parameter\n  // so adding will not cause length to exceed maximum.\n  if (\n    new RegExp(\n      `[?|&](${encodeURIComponent(TRUNCATION_PARAM.name)}=` +\n        `${encodeURIComponent(String(TRUNCATION_PARAM.value))}|aet=[^&]*)$`\n    ).test(adUrl)\n  ) {\n    return;\n  }\n  const modifiedAdUrl = adUrl + `&aet=${parameterValue}`;\n  devAssert(modifiedAdUrl.length <= MAX_URL_LENGTH);\n  return modifiedAdUrl;\n}\n\n/**\n * Returns a numerical code representing the binary type.\n * @param {string} type\n * @return {?string}\n */\nexport function getBinaryTypeNumericalCode(type) {\n  return (\n    {\n      'production': '0',\n      'control': '1',\n      'canary': '2',\n      'rc': '3',\n      'experimentA': '10',\n      'experimentB': '11',\n      'experimentC': '12',\n      'nomod': '42',\n      'mod': '43',\n    }[type] || null\n  );\n}\n\n/** @const {!RegExp} */\nconst IDENTITY_DOMAIN_REGEXP_ = /\\.google\\.(?:com?\\.)?[a-z]{2,3}$/;\n\n/** @typedef {{\n      token: (string|undefined),\n      jar: (string|undefined),\n      pucrd: (string|undefined),\n      freshLifetimeSecs: (number|undefined),\n      validLifetimeSecs: (number|undefined),\n      fetchTimeMs: (number|undefined)\n   }} */\nexport let IdentityToken;\n\n/**\n * @param {!Window} win\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampDoc\n * @param {?string} consentPolicyId\n * @return {!Promise<!IdentityToken>}\n */\nexport function getIdentityToken(win, ampDoc, consentPolicyId) {\n  // If configured to use amp-consent, delay request until consent state is\n  // resolved.\n  win['goog_identity_prom'] =\n    win['goog_identity_prom'] ||\n    (consentPolicyId\n      ? getConsentPolicyState(ampDoc.getHeadNode(), consentPolicyId)\n      : Promise.resolve(CONSENT_POLICY_STATE.UNKNOWN_NOT_REQUIRED)\n    ).then(consentState =>\n      consentState == CONSENT_POLICY_STATE.INSUFFICIENT ||\n      consentState == CONSENT_POLICY_STATE.UNKNOWN\n        ? /** @type {!IdentityToken} */ ({})\n        : executeIdentityTokenFetch(win, ampDoc)\n    );\n  return /** @type {!Promise<!IdentityToken>} */ (win['goog_identity_prom']);\n}\n\n/**\n * @param {!Window} win\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampDoc\n * @param {number=} redirectsRemaining (default 1)\n * @param {string=} domain\n * @param {number=} startTime\n * @return {!Promise<!IdentityToken>}\n */\nfunction executeIdentityTokenFetch(\n  win,\n  ampDoc,\n  redirectsRemaining = 1,\n  domain = undefined,\n  startTime = Date.now()\n) {\n  const url = getIdentityTokenRequestUrl(win, ampDoc, domain);\n  return Services.xhrFor(win)\n    .fetchJson(url, {\n      mode: 'cors',\n      method: 'GET',\n      ampCors: false,\n      credentials: 'include',\n    })\n    .then(res => res.json())\n    .then(obj => {\n      const token = obj['newToken'];\n      const jar = obj['1p_jar'] || '';\n      const pucrd = obj['pucrd'] || '';\n      const freshLifetimeSecs = parseInt(obj['freshLifetimeSecs'] || '', 10);\n      const validLifetimeSecs = parseInt(obj['validLifetimeSecs'] || '', 10);\n      const altDomain = obj['altDomain'];\n      const fetchTimeMs = Date.now() - startTime;\n      if (IDENTITY_DOMAIN_REGEXP_.test(altDomain)) {\n        if (!redirectsRemaining--) {\n          // Max redirects, log?\n          return {fetchTimeMs};\n        }\n        return executeIdentityTokenFetch(\n          win,\n          ampDoc,\n          redirectsRemaining,\n          altDomain,\n          startTime\n        );\n      } else if (\n        freshLifetimeSecs > 0 &&\n        validLifetimeSecs > 0 &&\n        typeof token == 'string'\n      ) {\n        return {\n          token,\n          jar,\n          pucrd,\n          freshLifetimeSecs,\n          validLifetimeSecs,\n          fetchTimeMs,\n        };\n      }\n      // returning empty\n      return {fetchTimeMs};\n    })\n    .catch(unusedErr => {\n      // TODO log?\n      return {};\n    });\n}\n\n/**\n * @param {!Window} win\n * @param {!../../../src/service/ampdoc-impl.AmpDoc} ampDoc\n * @param {string=} domain\n * @return {string} url\n * @visibleForTesting\n */\nexport function getIdentityTokenRequestUrl(win, ampDoc, domain = undefined) {\n  if (!domain && win != win.top && win.location.ancestorOrigins) {\n    const matches = IDENTITY_DOMAIN_REGEXP_.exec(\n      win.location.ancestorOrigins[win.location.ancestorOrigins.length - 1]\n    );\n    domain = (matches && matches[0]) || undefined;\n  }\n  domain = domain || '.google.com';\n  const canonical = extractHost(\n    Services.documentInfoForDoc(ampDoc).canonicalUrl\n  );\n  return `https://adservice${domain}/adsid/integrator.json?domain=${canonical}`;\n}\n\n/**\n * Returns whether we are running on the AMP CDN.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isCdnProxy(win) {\n  return CDN_PROXY_REGEXP.test(win.location.origin);\n}\n\n/**\n * Populates the fields of the given Nameframe experiment config object.\n * @param {!Headers} headers\n * @param {!NameframeExperimentConfig} nameframeConfig\n */\nexport function setNameframeExperimentConfigs(headers, nameframeConfig) {\n  const nameframeExperimentHeader = headers.get('amp-nameframe-exp');\n  if (nameframeExperimentHeader) {\n    nameframeExperimentHeader.split(';').forEach(config => {\n      if (config == 'instantLoad' || config == 'writeInBody') {\n        nameframeConfig[config] = true;\n      }\n    });\n  }\n}\n\n/**\n * Enum for browser capabilities. NOTE: Since JS is 32-bit, do not add anymore\n * than 32 capabilities to this enum.\n * @enum {number}\n */\nconst Capability = {\n  SVG_SUPPORTED: 1 << 0,\n  SANDBOXING_ALLOW_TOP_NAVIGATION_BY_USER_ACTIVATION_SUPPORTED: 1 << 1,\n  SANDBOXING_ALLOW_POPUPS_TO_ESCAPE_SANDBOX_SUPPORTED: 1 << 2,\n};\n\n/**\n * Returns a bitmap representing what features are supported by this browser.\n * @param {!Window} win\n * @return {number}\n */\nfunction getBrowserCapabilitiesBitmap(win) {\n  let browserCapabilities = 0;\n  const doc = win.document;\n  if (win.SVGElement && doc.createElementNS) {\n    browserCapabilities |= Capability.SVG_SUPPORTED;\n  }\n  const iframeEl = doc.createElement('iframe');\n  if (iframeEl.sandbox && iframeEl.sandbox.supports) {\n    if (iframeEl.sandbox.supports('allow-top-navigation-by-user-activation')) {\n      browserCapabilities |=\n        Capability.SANDBOXING_ALLOW_TOP_NAVIGATION_BY_USER_ACTIVATION_SUPPORTED;\n    }\n    if (iframeEl.sandbox.supports('allow-popups-to-escape-sandbox')) {\n      browserCapabilities |=\n        Capability.SANDBOXING_ALLOW_POPUPS_TO_ESCAPE_SANDBOX_SUPPORTED;\n    }\n  }\n  return browserCapabilities;\n}\n\n/**\n * Returns an enum value representing the AMP binary type, or null if this is a\n * canonical page.\n * @param {!Window} win\n * @return {?string} The binary type enum.\n * @visibleForTesting\n */\nexport function getAmpRuntimeTypeParameter(win) {\n  const art = getBinaryTypeNumericalCode(getBinaryType(win));\n  return isCdnProxy(win) && art != '0' ? art : null;\n}\n","/** @noinline */ export const cssText = \"html{overflow-x:hidden!important}html.i-amphtml-fie{height:100%!important;width:100%!important}html:not([amp4ads]),html:not([amp4ads]) body{height:auto!important}html:not([amp4ads]) body{margin:0!important}body{-webkit-text-size-adjust:100%;-moz-text-size-adjust:100%;-ms-text-size-adjust:100%;text-size-adjust:100%}html.i-amphtml-singledoc.i-amphtml-embedded{-ms-touch-action:pan-y;touch-action:pan-y}html.i-amphtml-fie>body,html.i-amphtml-singledoc>body{overflow:visible!important}html.i-amphtml-fie:not(.i-amphtml-inabox)>body,html.i-amphtml-singledoc:not(.i-amphtml-inabox)>body{position:relative!important}html.i-amphtml-webview>body{overflow-x:hidden!important;overflow-y:visible!important;min-height:100vh!important}html.i-amphtml-ios-embed-legacy>body{overflow-x:hidden!important;overflow-y:auto!important;position:absolute!important}html.i-amphtml-ios-embed{overflow-y:auto!important;position:static}#i-amphtml-wrapper{overflow-x:hidden!important;overflow-y:auto!important;position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;margin:0!important;display:block!important}html.i-amphtml-ios-embed.i-amphtml-ios-overscroll,html.i-amphtml-ios-embed.i-amphtml-ios-overscroll>#i-amphtml-wrapper{-webkit-overflow-scrolling:touch!important}#i-amphtml-wrapper>body{position:relative!important;border-top:1px solid transparent!important}#i-amphtml-wrapper+body{visibility:visible}#i-amphtml-wrapper+body .i-amphtml-lightbox-element,#i-amphtml-wrapper+body[i-amphtml-lightbox]{visibility:hidden}#i-amphtml-wrapper+body[i-amphtml-lightbox] .i-amphtml-lightbox-element{visibility:visible}#i-amphtml-wrapper.i-amphtml-scroll-disabled,.i-amphtml-scroll-disabled{overflow-x:hidden!important;overflow-y:hidden!important}amp-instagram{padding:54px 0px 0px!important;background-color:#fff}amp-iframe iframe{box-sizing:border-box!important}[amp-access][amp-access-hide]{display:none}[subscriptions-dialog],body:not(.i-amphtml-subs-ready) [subscriptions-action],body:not(.i-amphtml-subs-ready) [subscriptions-section]{display:none!important}amp-experiment,amp-live-list>[update],amp-share-tracking{display:none}.i-amphtml-jank-meter{position:fixed;background-color:rgba(232,72,95,0.5);bottom:0;right:0;color:#fff;font-size:16px;z-index:1000;padding:5px}amp-list[resizable-children]>.i-amphtml-loading-container.amp-hidden{display:none!important}amp-list[load-more] [load-more-button],amp-list[load-more] [load-more-end],amp-list[load-more] [load-more-failed],amp-list[load-more] [load-more-loading]{display:none}amp-story-page,amp-story[standalone]{min-height:1px!important;display:block!important;height:100%!important;margin:0!important;padding:0!important;overflow:hidden!important;width:100%!important}amp-story[standalone]{background-color:#202125!important;position:relative!important}amp-story-page{background-color:#757575}amp-story .amp-active>div{display:none!important}amp-story-page:not(:first-of-type):not([distance]):not([active]){transform:translateY(1000vh)!important}amp-autocomplete{position:relative!important;display:inline-block!important}amp-autocomplete>input{padding:.5rem;border:1px solid rgba(0,0,0,0.33)}.i-amphtml-autocomplete-results,amp-autocomplete>input{font-size:1rem;line-height:1.5rem}[amp-fx^=fly-in]{visibility:hidden}\\n/*# sourceURL=/css/ampdoc.css*/\"","/** @noinline */ export const cssText = \"[hidden]{display:none!important}.i-amphtml-element{display:inline-block}.i-amphtml-blurry-placeholder{transition:opacity 0.3s cubic-bezier(0.0,0.0,0.2,1)!important}[layout=nodisplay]:not(.i-amphtml-element){display:none!important}.i-amphtml-layout-fixed,[layout=fixed][width][height]:not(.i-amphtml-layout-fixed){display:inline-block;position:relative}.i-amphtml-layout-responsive,[layout=responsive][width][height]:not(.i-amphtml-layout-responsive),[width][height][sizes]:not(.i-amphtml-layout-responsive){display:block;position:relative}.i-amphtml-layout-intrinsic{display:inline-block;position:relative;max-width:100%}.i-amphtml-intrinsic-sizer{max-width:100%;display:block!important}.i-amphtml-layout-container,.i-amphtml-layout-fixed-height,[layout=container],[layout=fixed-height][height]{display:block;position:relative}.i-amphtml-layout-fill,[layout=fill]:not(.i-amphtml-layout-fill){display:block;overflow:hidden!important;position:absolute;top:0;left:0;bottom:0;right:0}.i-amphtml-layout-flex-item,[layout=flex-item]:not(.i-amphtml-layout-flex-item){display:block;position:relative;-ms-flex:1 1 auto;flex:1 1 auto}.i-amphtml-layout-fluid{position:relative}.i-amphtml-layout-size-defined{overflow:hidden!important}.i-amphtml-layout-awaiting-size{position:absolute!important;top:auto!important;bottom:auto!important}i-amphtml-sizer{display:block!important}.i-amphtml-blurry-placeholder,.i-amphtml-fill-content{display:block;height:0;max-height:100%;max-width:100%;min-height:100%;min-width:100%;width:0;margin:auto}.i-amphtml-layout-size-defined .i-amphtml-fill-content{position:absolute;top:0;left:0;bottom:0;right:0}.i-amphtml-layout-intrinsic .i-amphtml-sizer{max-width:100%}.i-amphtml-replaced-content,.i-amphtml-screen-reader{padding:0!important;border:none!important}.i-amphtml-screen-reader{position:fixed!important;top:0px!important;left:0px!important;width:4px!important;height:4px!important;opacity:0!important;overflow:hidden!important;margin:0!important;display:block!important;visibility:visible!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:8px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:12px!important}.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader~.i-amphtml-screen-reader{left:16px!important}.i-amphtml-unresolved{position:relative;overflow:hidden!important}.i-amphtml-select-disabled{-webkit-user-select:none!important;-moz-user-select:none!important;-ms-user-select:none!important;user-select:none!important}.i-amphtml-notbuilt,[layout]:not(.i-amphtml-element){position:relative;overflow:hidden!important;color:transparent!important}.i-amphtml-notbuilt:not(.i-amphtml-layout-container)>*,[layout]:not([layout=container]):not(.i-amphtml-element)>*{display:none}.i-amphtml-ghost{visibility:hidden!important}.i-amphtml-element>[placeholder],[layout]:not(.i-amphtml-element)>[placeholder]{display:block}.i-amphtml-element>[placeholder].amp-hidden,.i-amphtml-element>[placeholder].hidden{visibility:hidden}.i-amphtml-element:not(.amp-notsupported)>[fallback],.i-amphtml-layout-container>[placeholder].amp-hidden,.i-amphtml-layout-container>[placeholder].hidden{display:none}.i-amphtml-layout-size-defined>[fallback],.i-amphtml-layout-size-defined>[placeholder]{position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;z-index:1}.i-amphtml-notbuilt>[placeholder]{display:block!important}.i-amphtml-hidden-by-media-query{display:none!important}.i-amphtml-element-error{background:red!important;color:#fff!important;position:relative!important}.i-amphtml-element-error:before{content:attr(error-message)}i-amp-scroll-container,i-amphtml-scroll-container{position:absolute;top:0;left:0;right:0;bottom:0;display:block}i-amp-scroll-container.amp-active,i-amphtml-scroll-container.amp-active{overflow:auto;-webkit-overflow-scrolling:touch}.i-amphtml-loading-container{display:block!important;pointer-events:none;z-index:1}.i-amphtml-notbuilt>.i-amphtml-loading-container{display:block!important}.i-amphtml-loading-container.amp-hidden{visibility:hidden}.i-amphtml-element>[overflow]{cursor:pointer;position:relative;z-index:2;visibility:hidden}.i-amphtml-element>[overflow].amp-visible{visibility:visible}template{display:none!important}.amp-border-box,.amp-border-box *,.amp-border-box :after,.amp-border-box :before{box-sizing:border-box}amp-pixel{display:none!important}amp-analytics,amp-story-auto-ads{position:fixed!important;top:0!important;width:1px!important;height:1px!important;overflow:hidden!important;visibility:hidden}html.i-amphtml-fie>amp-analytics{position:initial!important}[visible-when-invalid]:not(.visible),amp-list [fetch-error],form [submit-error],form [submit-success],form [submitting]{display:none}amp-accordion{display:block!important}amp-accordion>section{float:none!important}amp-accordion>section>*{float:none!important;display:block!important;overflow:hidden!important;position:relative!important}amp-accordion,amp-accordion>section{margin:0}amp-accordion>section>:last-child{display:none!important}amp-accordion>section[expanded]>:last-child{display:block!important}\\n/*# sourceURL=/css/ampshared.css*/\"","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from '../src/base-element';\nimport {Layout, isLayoutSizeDefined} from '../src/layout';\nimport {dev} from '../src/log';\nimport {guaranteeSrcForSrcsetUnsupportedBrowsers} from '../src/utils/img';\nimport {isExperimentOn} from '../src/experiments';\nimport {listen} from '../src/event-helper';\nimport {propagateObjectFitStyles, setImportantStyles} from '../src/style';\nimport {registerElement} from '../src/service/custom-element-registry';\n\n/** @const {string} */\nconst TAG = 'amp-img';\n\n/**\n * Attributes to propagate to internal image when changed externally.\n * @type {!Array<string>}\n */\nconst ATTRIBUTES_TO_PROPAGATE = [\n  'alt',\n  'title',\n  'referrerpolicy',\n  'aria-label',\n  'aria-describedby',\n  'aria-labelledby',\n  'srcset',\n  'src',\n  'sizes',\n];\n\nexport class AmpImg extends BaseElement {\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n\n    /** @private {boolean} */\n    this.allowImgLoadFallback_ = true;\n\n    /** @private {boolean} */\n    this.prerenderAllowed_ = true;\n\n    /** @private {?Element} */\n    this.img_ = null;\n\n    /** @private {?UnlistenDef} */\n    this.unlistenLoad_ = null;\n\n    /** @private {?UnlistenDef} */\n    this.unlistenError_ = null;\n\n    /**\n     * The current width used by the automatically generated sizes attribute\n     * @private {number}\n     * */\n    this.sizesWidth_ = 0;\n  }\n\n  /** @override */\n  mutatedAttributesCallback(mutations) {\n    if (this.img_) {\n      const attrs = ATTRIBUTES_TO_PROPAGATE.filter(\n        value => mutations[value] !== undefined\n      );\n      // Mutating src should override existing srcset, so remove the latter.\n      if (\n        mutations['src'] &&\n        !mutations['srcset'] &&\n        this.element.hasAttribute('srcset')\n      ) {\n        // propagateAttributes() will remove [srcset] from this.img_.\n        this.element.removeAttribute('srcset');\n        attrs.push('srcset');\n\n        this.user().warn(\n          TAG,\n          'Removed [srcset] since [src] was mutated. Recommend adding a ' +\n            '[srcset] binding to support responsive images.',\n          this.element\n        );\n      }\n      this.propagateAttributes(\n        attrs,\n        this.img_,\n        /* opt_removeMissingAttrs */ true\n      );\n      guaranteeSrcForSrcsetUnsupportedBrowsers(this.img_);\n    }\n  }\n\n  /** @override */\n  onMeasureChanged() {\n    this.maybeGenerateSizes_(/* sync */ false);\n  }\n\n  /** @override */\n  preconnectCallback(onLayout) {\n    // NOTE(@wassgha): since parseSrcset is computationally expensive and can\n    // not be inside the `buildCallback`, we went with preconnecting to the\n    // `src` url if it exists or the first srcset url.\n    const src = this.element.getAttribute('src');\n    if (src) {\n      this.preconnect.url(src, onLayout);\n    } else {\n      const srcset = this.element.getAttribute('srcset');\n      if (!srcset) {\n        return;\n      }\n      // We try to find the first url in the srcset\n      const srcseturl = /\\S+/.exec(srcset);\n      // Connect to the first url if it exists\n      if (srcseturl) {\n        this.preconnect.url(srcseturl[0], onLayout);\n      }\n    }\n  }\n\n  /** @override */\n  firstAttachedCallback() {\n    if (this.element.hasAttribute('noprerender')) {\n      this.prerenderAllowed_ = false;\n    }\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return isLayoutSizeDefined(layout);\n  }\n\n  /**\n   * Create the actual image element and set up instance variables.\n   * Called lazily in the first `#layoutCallback`.\n   */\n  initialize_() {\n    if (this.img_) {\n      return;\n    }\n    // If this amp-img IS the fallback then don't allow it to have its own\n    // fallback to stop from nested fallback abuse.\n    this.allowImgLoadFallback_ = !this.element.hasAttribute('fallback');\n\n    // For inabox SSR, image will have been written directly to DOM so no need\n    // to recreate.  Calling appendChild again will have no effect.\n    if (this.element.hasAttribute('i-amphtml-ssr')) {\n      this.img_ = this.element.querySelector('img');\n    }\n    this.img_ = this.img_ || new Image();\n    this.img_.setAttribute('decoding', 'async');\n    if (this.element.id) {\n      this.img_.setAttribute('amp-img-id', this.element.id);\n    }\n\n    // Remove role=img otherwise this breaks screen-readers focus and\n    // only read \"Graphic\" when using only 'alt'.\n    if (this.element.getAttribute('role') == 'img') {\n      this.element.removeAttribute('role');\n      this.user().error(\n        TAG,\n        'Setting role=img on amp-img elements breaks ' +\n          'screen readers please just set alt or ARIA attributes, they will ' +\n          'be correctly propagated for the underlying <img> element.'\n      );\n    }\n\n    // It is important to call this before setting `srcset` attribute.\n    this.maybeGenerateSizes_(/* sync setAttribute */ true);\n    this.propagateAttributes(ATTRIBUTES_TO_PROPAGATE, this.img_);\n    guaranteeSrcForSrcsetUnsupportedBrowsers(this.img_);\n    this.applyFillContent(this.img_, true);\n    propagateObjectFitStyles(this.element, this.img_);\n\n    this.element.appendChild(this.img_);\n  }\n\n  /**\n   * This function automatically generates sizes for amp-imgs without\n   * the sizes attribute.\n   * @param {boolean} sync Whether to immediately make the change or schedule\n   *     via mutateElement.\n   * @private\n   */\n  maybeGenerateSizes_(sync) {\n    if (!this.img_) {\n      return;\n    }\n    // No need to generate sizes if already present.\n    const sizes = this.element.getAttribute('sizes');\n    if (sizes) {\n      return;\n    }\n    // Sizes is useless without the srcset attribute or if the srcset\n    // attribute uses the x descriptor.\n    const srcset = this.element.getAttribute('srcset');\n    if (!srcset || /[0-9]+x(?:,|$)/.test(srcset)) {\n      return;\n    }\n\n    const width = this.getLayoutWidth();\n    if (!this.shouldSetSizes_(width)) {\n      return;\n    }\n\n    const viewportWidth = this.getViewport().getWidth();\n\n    const entry = `(max-width: ${viewportWidth}px) ${width}px, `;\n    let defaultSize = width + 'px';\n\n    if (this.getLayout() !== Layout.FIXED) {\n      const ratio = Math.round((width * 100) / viewportWidth);\n      defaultSize = Math.max(ratio, 100) + 'vw';\n    }\n\n    const generatedSizes = entry + defaultSize;\n\n    if (sync) {\n      this.img_.setAttribute('sizes', generatedSizes);\n    } else {\n      this.mutateElement(() => {\n        this.img_.setAttribute('sizes', generatedSizes);\n      });\n    }\n    this.sizesWidth_ = width;\n  }\n\n  /**\n   * @param {number} newWidth\n   * @return {boolean}\n   * @private\n   */\n  shouldSetSizes_(newWidth) {\n    if (!this.img_.hasAttribute('sizes')) {\n      return true;\n    }\n    return newWidth > this.sizesWidth_;\n  }\n\n  /** @override */\n  prerenderAllowed() {\n    return this.prerenderAllowed_;\n  }\n\n  /** @override */\n  reconstructWhenReparented() {\n    return false;\n  }\n\n  /** @override */\n  layoutCallback() {\n    this.initialize_();\n    const img = dev().assertElement(this.img_);\n    this.unlistenLoad_ = listen(img, 'load', () => this.hideFallbackImg_());\n    this.unlistenError_ = listen(img, 'error', () => this.onImgLoadingError_());\n    if (this.getLayoutWidth() <= 0) {\n      return Promise.resolve();\n    }\n    return this.loadPromise(img);\n  }\n\n  /** @override */\n  unlayoutCallback() {\n    if (this.unlistenError_) {\n      this.unlistenError_();\n      this.unlistenError_ = null;\n    }\n    if (this.unlistenLoad_) {\n      this.unlistenLoad_();\n      this.unlistenLoad_ = null;\n    }\n    return true;\n  }\n\n  /** @override */\n  firstLayoutCompleted() {\n    const placeholder = this.getPlaceholder();\n    if (\n      placeholder &&\n      placeholder.classList.contains('i-amphtml-blurry-placeholder') &&\n      isExperimentOn(this.win, 'blurry-placeholder')\n    ) {\n      setImportantStyles(placeholder, {'opacity': 0});\n    } else {\n      this.togglePlaceholder(false);\n    }\n  }\n\n  /**\n   * @private\n   */\n  hideFallbackImg_() {\n    if (\n      !this.allowImgLoadFallback_ &&\n      this.img_.classList.contains('i-amphtml-ghost')\n    ) {\n      this.getVsync().mutate(() => {\n        this.img_.classList.remove('i-amphtml-ghost');\n        this.toggleFallback(false);\n      });\n    }\n  }\n\n  /**\n   * If the image fails to load, show a fallback or placeholder instead.\n   * @private\n   */\n  onImgLoadingError_() {\n    if (this.allowImgLoadFallback_) {\n      this.getVsync().mutate(() => {\n        this.img_.classList.add('i-amphtml-ghost');\n        this.toggleFallback(true);\n        // Hide placeholders, as browsers that don't support webp\n        // Would show the placeholder underneath a transparent fallback\n        this.togglePlaceholder(false);\n      });\n      this.allowImgLoadFallback_ = false;\n    }\n  }\n}\n\n/**\n * @param {!Window} win Destination window for the new element.\n * @this {undefined}  // Make linter happy\n */\nexport function installImg(win) {\n  registerElement(win, TAG, AmpImg);\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from '../src/base-element';\nimport {Layout, isLayoutSizeDefined} from '../src/layout';\nimport {registerElement} from '../src/service/custom-element-registry';\n\nclass AmpLayout extends BaseElement {\n  /** @override */\n  isLayoutSupported(layout) {\n    return layout == Layout.CONTAINER || isLayoutSizeDefined(layout);\n  }\n\n  /** @override */\n  buildCallback() {\n    if (this.getLayout() == Layout.CONTAINER) {\n      return;\n    }\n    const container = this.win.document.createElement('div');\n    this.applyFillContent(container);\n    this.getRealChildNodes().forEach(child => {\n      container.appendChild(child);\n    });\n    this.element.appendChild(container);\n  }\n\n  /** @override */\n  prerenderAllowed() {\n    // Allow amp-layout to be built in prerender mode.\n    return true;\n  }\n}\n\n/**\n * @param {!Window} win Destination window for the new element.\n */\nexport function installLayout(win) {\n  registerElement(win, 'amp-layout', AmpLayout);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from '../src/base-element';\nimport {Services} from '../src/services';\nimport {createPixel} from '../src/pixel';\nimport {dev, userAssert} from '../src/log';\nimport {registerElement} from '../src/service/custom-element-registry';\n\nconst TAG = 'amp-pixel';\n\n/**\n * A simple analytics instrument. Fires as an impression signal.\n */\nexport class AmpPixel extends BaseElement {\n  /** @override */\n  constructor(element) {\n    super(element);\n\n    /** @private {?Promise<!Image>} */\n    this.triggerPromise_ = null;\n  }\n\n  /** @override */\n  isLayoutSupported(unusedLayout) {\n    // No matter what layout is: the pixel is always non-displayed.\n    return true;\n  }\n\n  /** @override */\n  buildCallback() {\n    // Element is invisible.\n    this.element.setAttribute('aria-hidden', 'true');\n\n    /** @private {?string} */\n    this.referrerPolicy_ = this.element.getAttribute('referrerpolicy');\n    if (this.referrerPolicy_) {\n      // Safari doesn't support referrerPolicy yet. We're using an\n      // iframe based trick to remove referrer, which apparently can\n      // only do \"no-referrer\".\n      userAssert(\n        this.referrerPolicy_ == 'no-referrer',\n        `${TAG}: invalid \"referrerpolicy\" value \"${this.referrerPolicy_}\".` +\n          ' Only \"no-referrer\" is supported'\n      );\n    }\n    if (\n      this.element.hasAttribute('i-amphtml-ssr') &&\n      this.element.querySelector('img')\n    ) {\n      dev().info(TAG, 'inabox img already present');\n      return;\n    }\n    // Trigger, but only when visible.\n    this.getAmpDoc()\n      .whenFirstVisible()\n      .then(this.trigger_.bind(this));\n  }\n\n  /**\n   * Triggers the signal.\n   * @return {*} TODO(#23582): Specify return type\n   * @private\n   */\n  trigger_() {\n    if (this.triggerPromise_) {\n      // TODO(dvoytenko, #8780): monitor, confirm if there's a bug and remove.\n      dev().error(TAG, 'duplicate pixel');\n      return this.triggerPromise_;\n    }\n    // Delay(1) provides a rudimentary \"idle\" signal.\n    // TODO(dvoytenko): use an improved idle signal when available.\n    this.triggerPromise_ = Services.timerFor(this.win)\n      .promise(1)\n      .then(() => {\n        const src = this.element.getAttribute('src');\n        if (!src) {\n          return;\n        }\n        return Services.urlReplacementsForDoc(this.element)\n          .expandUrlAsync(this.assertSource_(src))\n          .then(src => {\n            const pixel = createPixel(this.win, src, this.referrerPolicy_);\n            dev().info(TAG, 'pixel triggered: ', src);\n            return pixel;\n          });\n      });\n  }\n\n  /**\n   * @param {?string} src\n   * @return {string}\n   * @private\n   */\n  assertSource_(src) {\n    userAssert(\n      /^(https\\:\\/\\/|\\/\\/)/i.test(src),\n      'The <amp-pixel> src attribute must start with ' +\n        '\"https://\" or \"//\". Invalid value: ' +\n        src\n    );\n    return /** @type {string} */ (src);\n  }\n}\n\n/**\n * @param {!Window} win Destination window for the new element.\n */\nexport function installPixel(win) {\n  registerElement(win, TAG, AmpPixel);\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {\n  VariableSource,\n  getNavigationData,\n  getTimingDataAsync,\n  getTimingDataSync,\n} from '../../../src/service/variable-source';\nimport {user, userAssert} from '../../../src/log';\n\nconst WHITELISTED_VARIABLES = [\n  'AMPDOC_HOST',\n  'AMPDOC_HOSTNAME',\n  'AMPDOC_URL',\n  'AMP_VERSION',\n  'AVAILABLE_SCREEN_HEIGHT',\n  'AVAILABLE_SCREEN_WIDTH',\n  'BACKGROUND_STATE',\n  'BROWSER_LANGUAGE',\n  'CANONICAL_HOST',\n  'CANONICAL_HOSTNAME',\n  'CANONICAL_PATH',\n  'CANONICAL_URL',\n  'COUNTER',\n  'DOCUMENT_CHARSET',\n  'DOCUMENT_REFERRER',\n  'FIRST_CONTENTFUL_PAINT',\n  'FIRST_VIEWPORT_READY',\n  'MAKE_BODY_VISIBLE',\n  'PAGE_VIEW_ID',\n  'RANDOM',\n  'SCREEN_COLOR_DEPTH',\n  'SCREEN_HEIGHT',\n  'SCREEN_WIDTH',\n  'SCROLL_HEIGHT',\n  'SCROLL_LEFT',\n  'SCROLL_TOP',\n  'SCROLL_WIDTH',\n  'SHARE_TRACKING_INCOMING',\n  'SHARE_TRACKING_OUTGOING',\n  'SOURCE_HOST',\n  'SOURCE_HOSTNAME',\n  'SOURCE_PATH',\n  'SOURCE_URL',\n  'TIMESTAMP',\n  'TIMEZONE',\n  'TIMEZONE_CODE',\n  'TITLE',\n  'TOTAL_ENGAGED_TIME',\n  'USER_AGENT',\n  'VARIANT',\n  'VARIANTS',\n  'VIEWER',\n  'VIEWPORT_HEIGHT',\n  'VIEWPORT_WIDTH',\n];\n\n/** Provides A4A specific variable substitution. */\nexport class A4AVariableSource extends VariableSource {\n  /**\n   * @param  {!../../../src/service/ampdoc-impl.AmpDoc} parentAmpdoc\n   * @param  {!Window} embedWin\n   */\n  constructor(parentAmpdoc, embedWin) {\n    super(parentAmpdoc);\n\n    // Use parent URL replacements service for fallback.\n    const headNode = parentAmpdoc.getHeadNode();\n    const urlReplacements = Services.urlReplacementsForDoc(headNode);\n\n    /** @private {VariableSource} global variable source for fallback. */\n    this.globalVariableSource_ = urlReplacements.getVariableSource();\n\n    /** @private {!Window} */\n    this.win_ = embedWin;\n  }\n\n  /** @override */\n  initialize() {\n    // Initiate whitelisted varaibles first in case the resolver function needs\n    // to be overwritten.\n    for (let v = 0; v < WHITELISTED_VARIABLES.length; v++) {\n      const varName = WHITELISTED_VARIABLES[v];\n      const resolvers = this.globalVariableSource_.get(varName);\n      this.set(varName, resolvers.sync).setAsync(varName, resolvers.async);\n    }\n\n    this.set('NAV_TIMING', (startAttribute, endAttribute) => {\n      userAssert(\n        startAttribute,\n        'The first argument to NAV_TIMING, the' +\n          ' start attribute name, is required'\n      );\n      return getTimingDataSync(\n        this.win_,\n        /**@type {string}*/ (startAttribute),\n        /**@type {string}*/ (endAttribute)\n      );\n    }).setAsync('NAV_TIMING', (startAttribute, endAttribute) => {\n      userAssert(\n        startAttribute,\n        'The first argument to NAV_TIMING, the' +\n          ' start attribute name, is required'\n      );\n      return getTimingDataAsync(\n        this.win_,\n        /**@type {string}*/ (startAttribute),\n        /**@type {string}*/ (endAttribute)\n      );\n    });\n\n    this.set('NAV_TYPE', () => {\n      return getNavigationData(this.win_, 'type');\n    });\n\n    this.set('NAV_REDIRECT_COUNT', () => {\n      return getNavigationData(this.win_, 'redirectCount');\n    });\n\n    this.set(\n      'HTML_ATTR',\n      /** @type {function(...*)} */ (this.htmlAttributeBinding_.bind(this))\n    );\n\n    this.set('CLIENT_ID', () => null);\n  }\n\n  /**\n   * Provides a binding for getting attributes from the DOM.\n   * Most such bindings are provided in src/service/url-replacements-impl, but\n   * this one needs access to this.win_.document, which if the amp-analytics\n   * tag is contained within an amp-ad tag will NOT be the parent/publisher\n   * page. Hence the need to put it here.\n   * @param {string} cssSelector Elements matching this selector will be\n   *     included, provided they have at least one of the attributeNames\n   *     set, up to a max of 10. May be URI encoded.\n   * @param {...string} var_args Additional params will be the names of\n   *     attributes whose values will be returned. There should be at least 1.\n   * @return {string} A stringified JSON array containing one member for each\n   *     matching element. Each member will contain the names and values of the\n   *     specified attributes, if the corresponding element has that attribute.\n   *     Note that if an element matches the cssSelected but has none of the\n   *     requested attributes, then nothing will be included in the array\n   *     for that element.\n   */\n  htmlAttributeBinding_(cssSelector, var_args) {\n    // Generate an error if cssSelector matches more than this many elements\n    const HTML_ATTR_MAX_ELEMENTS_TO_TRAVERSE = 20;\n\n    // Of the elements matched by cssSelector, see which contain one or more\n    // of the specified attributes, and return an array of at most this many.\n    const HTML_ATTR_MAX_ELEMENTS_TO_RETURN = 10;\n\n    // Only allow at most this many attributeNames to be specified.\n    const HTML_ATTR_MAX_ATTRS = 10;\n\n    const TAG = 'A4AVariableSource';\n\n    const attributeNames = Array.prototype.slice.call(arguments, 1);\n    if (!cssSelector || !attributeNames.length) {\n      return '[]';\n    }\n    if (attributeNames.length > HTML_ATTR_MAX_ATTRS) {\n      user().error(TAG, `At most ${HTML_ATTR_MAX_ATTRS} may be requested.`);\n      return '[]';\n    }\n    cssSelector = decodeURI(cssSelector);\n    let elements;\n    try {\n      elements = this.win_.document.querySelectorAll(cssSelector);\n    } catch (e) {\n      user().error(TAG, `Invalid selector: ${cssSelector}`);\n      return '[]';\n    }\n    if (elements.length > HTML_ATTR_MAX_ELEMENTS_TO_TRAVERSE) {\n      user().error(\n        TAG,\n        'CSS selector may match at most ' +\n          `${HTML_ATTR_MAX_ELEMENTS_TO_TRAVERSE} elements.`\n      );\n      return '[]';\n    }\n    const result = [];\n    for (\n      let i = 0;\n      i < elements.length && result.length < HTML_ATTR_MAX_ELEMENTS_TO_RETURN;\n      ++i\n    ) {\n      const currentResult = {};\n      let foundAtLeastOneAttr = false;\n      for (let j = 0; j < attributeNames.length; ++j) {\n        const attributeName = attributeNames[j];\n        if (elements[i].hasAttribute(attributeName)) {\n          currentResult[attributeName] = elements[i].getAttribute(\n            attributeName\n          );\n          foundAtLeastOneAttr = true;\n        }\n      }\n      if (foundAtLeastOneAttr) {\n        result.push(currentResult);\n      }\n    }\n    return JSON.stringify(result);\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {A4AVariableSource} from './a4a-variable-source';\nimport {\n  CONSENT_POLICY_STATE, // eslint-disable-line no-unused-vars\n} from '../../../src/consent-state';\nimport {Layout, LayoutPriority, isLayoutSizeDefined} from '../../../src/layout';\nimport {\n  SINGLE_PASS_EXPERIMENT_IDS,\n  addExperimentIdToElement,\n} from '../../../ads/google/a4a/traffic-experiments';\nimport {Services} from '../../../src/services';\nimport {SignatureVerifier, VerificationStatus} from './signature-verifier';\nimport {\n  applySandbox,\n  generateSentinel,\n  getDefaultBootstrapBaseUrl,\n} from '../../../src/3p-frame';\nimport {assertHttpsUrl, tryDecodeUriComponent} from '../../../src/url';\nimport {cancellation, isCancellation} from '../../../src/error';\nimport {createElementWithAttributes} from '../../../src/dom';\nimport {\n  dev,\n  devAssert,\n  duplicateErrorIfNecessary,\n  user,\n} from '../../../src/log';\nimport {dict} from '../../../src/utils/object';\nimport {\n  getAmpAdRenderOutsideViewport,\n  incrementLoadingAds,\n  is3pThrottled,\n} from '../../amp-ad/0.1/concurrent-load';\nimport {\n  getConsentPolicyInfo,\n  getConsentPolicyState,\n} from '../../../src/consent';\nimport {getContextMetadata} from '../../../src/iframe-attributes';\nimport {getMode} from '../../../src/mode';\nimport {insertAnalyticsElement} from '../../../src/extension-analytics';\nimport {\n  installFriendlyIframeEmbed,\n  setFriendlyIframeEmbedVisible,\n} from '../../../src/friendly-iframe-embed';\nimport {installUrlReplacementsForEmbed} from '../../../src/service/url-replacements-impl';\nimport {isAdPositionAllowed} from '../../../src/ad-helper';\nimport {isArray, isEnumValue, isObject} from '../../../src/types';\nimport {parseJson} from '../../../src/json';\nimport {setStyle} from '../../../src/style';\nimport {signingServerURLs} from '../../../ads/_a4a-config';\nimport {triggerAnalyticsEvent} from '../../../src/analytics';\nimport {tryResolve} from '../../../src/utils/promise';\nimport {utf8Decode} from '../../../src/utils/bytes';\n\n/** @type {Array<string>} */\nconst METADATA_STRINGS = [\n  '<script amp-ad-metadata type=application/json>',\n  '<script type=\"application/json\" amp-ad-metadata>',\n  '<script type=application/json amp-ad-metadata>',\n];\n\n// TODO(tdrl): Temporary, while we're verifying whether SafeFrame is an\n// acceptable solution to the 'Safari on iOS doesn't fetch iframe src from\n// cache' issue.  See https://github.com/ampproject/amphtml/issues/5614\n/** @type {string} */\nexport const DEFAULT_SAFEFRAME_VERSION = '1-0-23';\n\n/** @const {string} */\nexport const CREATIVE_SIZE_HEADER = 'X-CreativeSize';\n\n/** @type {string} @visibleForTesting */\nexport const RENDERING_TYPE_HEADER = 'X-AmpAdRender';\n\n/** @type {string} @visibleForTesting */\nexport const SAFEFRAME_VERSION_HEADER = 'X-AmpSafeFrameVersion';\n\n/** @type {string} @visibleForTesting */\nexport const EXPERIMENT_FEATURE_HEADER_NAME = 'amp-ff-exps';\n\n/** @type {string} */\nconst TAG = 'amp-a4a';\n\n/** @type {string} */\nexport const NO_CONTENT_RESPONSE = 'NO-CONTENT-RESPONSE';\n\n/** @type {string} */\nexport const NETWORK_FAILURE = 'NETWORK-FAILURE';\n\n/** @type {string} */\nexport const INVALID_SPSA_RESPONSE = 'INVALID-SPSA-RESPONSE';\n\n/** @type {string} */\nexport const IFRAME_GET = 'IFRAME-GET';\n\n/** @enum {string} */\nexport const XORIGIN_MODE = {\n  CLIENT_CACHE: 'client_cache',\n  SAFEFRAME: 'safeframe',\n  NAMEFRAME: 'nameframe',\n  IFRAME_GET: 'iframe_get',\n};\n\n/** @type {!Object} @private */\nconst SHARED_IFRAME_PROPERTIES = dict({\n  'frameborder': '0',\n  'allowfullscreen': '',\n  'allowtransparency': '',\n  'scrolling': 'no',\n  'marginwidth': '0',\n  'marginheight': '0',\n});\n\n/** @typedef {{width: number, height: number}} */\nexport let SizeInfoDef;\n\n/** @typedef {{\n      minifiedCreative: string,\n      customElementExtensions: !Array<string>,\n      customStylesheets: !Array<{href: string}>,\n      images: (Array<string>|undefined),\n      ctaType: (string|undefined),\n      ctaUrl: (string|undefined),\n    }} */\nexport let CreativeMetaDataDef;\n\n/**\n * Name of A4A lifecycle triggers.\n * @enum {string}\n */\nexport const AnalyticsTrigger = {\n  AD_REQUEST_START: 'ad-request-start',\n  AD_RESPONSE_END: 'ad-response-end',\n  AD_RENDER_START: 'ad-render-start',\n  AD_RENDER_END: 'ad-render-end',\n  AD_IFRAME_LOADED: 'ad-iframe-loaded',\n  // This trigger is not part of the normal ads lifecycle and only fires when an\n  // ad is refreshed.\n  AD_REFRESH: 'ad-refresh',\n};\n\n/**\n * Maps the names of lifecycle events to analytics triggers.\n * @const {!Object<string, !AnalyticsTrigger>}\n */\nconst LIFECYCLE_STAGE_TO_ANALYTICS_TRIGGER = {\n  'adRequestStart': AnalyticsTrigger.AD_REQUEST_START,\n  'adRequestEnd': AnalyticsTrigger.AD_RESPONSE_END,\n  'renderFriendlyStart': AnalyticsTrigger.AD_RENDER_START,\n  'renderCrossDomainStart': AnalyticsTrigger.AD_RENDER_START,\n  'renderSafeFrameStart': AnalyticsTrigger.AD_RENDER_START,\n  'renderFriendlyEnd': AnalyticsTrigger.AD_RENDER_END,\n  'renderCrossDomainEnd': AnalyticsTrigger.AD_RENDER_END,\n  'friendlyIframeIniLoad': AnalyticsTrigger.AD_IFRAME_LOADED,\n  'crossDomainIframeLoaded': AnalyticsTrigger.AD_IFRAME_LOADED,\n};\n\n/**\n * Utility function that ensures any error thrown is handled by optional\n * onError handler (if none provided or handler throws, error is swallowed and\n * undefined is returned).\n * @param {!Function} fn to protect\n * @param {T=} inThis An optional object to use as the 'this' object\n *    when calling the function.  If not provided, undefined is bound as this\n *    when calling function.\n * @param {function(this:T, !Error, ...*):?=} onError function given error\n *    and arguments provided to function call.\n * @return {!Function} protected function\n * @template T\n * @visibleForTesting\n */\nexport function protectFunctionWrapper(\n  fn,\n  inThis = undefined,\n  onError = undefined\n) {\n  return (...fnArgs) => {\n    try {\n      return fn.apply(inThis, fnArgs);\n    } catch (err) {\n      if (onError) {\n        try {\n          // Ideally we could use [err, ...var_args] but linter disallows\n          // spread so instead using unshift :(\n          fnArgs.unshift(err);\n          return onError.apply(inThis, fnArgs);\n        } catch (captureErr) {\n          // swallow error if error handler throws.\n        }\n      }\n      // In the event of no optional on error function or its execution throws,\n      // return undefined.\n      return undefined;\n    }\n  };\n}\n\n/** Abstract class for AMP Ad Fast Fetch enabled networks */\nexport class AmpA4A extends AMP.BaseElement {\n  // TODO: Add more error handling throughout code.\n  // TODO: Handle creatives that do not fill.\n\n  /**\n   * @param {!Element} element\n   */\n  constructor(element) {\n    super(element);\n    devAssert(AMP.AmpAdUIHandler);\n    devAssert(AMP.AmpAdXOriginIframeHandler);\n\n    /** @private {?Promise<undefined>} */\n    this.keysetPromise_ = null;\n\n    /** @private {?Promise<?CreativeMetaDataDef>} */\n    this.adPromise_ = null;\n\n    /**\n     * @private {number} unique ID of the currently executing promise to allow\n     * for cancellation.\n     */\n    this.promiseId_ = 0;\n\n    /** @private {?string} */\n    this.adUrl_ = null;\n\n    /** @private {?../../../src/friendly-iframe-embed.FriendlyIframeEmbed} */\n    this.friendlyIframeEmbed_ = null;\n\n    /** @type {?AMP.AmpAdUIHandler} */\n    this.uiHandler = null;\n\n    /** @private {?AMP.AmpAdXOriginIframeHandler} */\n    this.xOriginIframeHandler_ = null;\n\n    /** @private {boolean} whether creative has been verified as AMP */\n    this.isVerifiedAmpCreative_ = false;\n\n    /** @private {?ArrayBuffer} */\n    this.creativeBody_ = null;\n\n    /**\n     * Initialize this with the slot width/height attributes, and override\n     * later with what the network implementation returns via extractSize.\n     * Note: Either value may be 'auto' (i.e., non-numeric).\n     *\n     * @private {?({width, height}|../../../src/layout-rect.LayoutRectDef)}\n     */\n    this.creativeSize_ = null;\n\n    /** @private {?../../../src/layout-rect.LayoutRectDef} */\n    this.originalSlotSize_ = null;\n\n    /**\n     * Note(keithwrightbos) - ensure the default here is null so that ios\n     * uses safeframe when response header is not specified.\n     * @private {?XORIGIN_MODE}\n     */\n    this.experimentalNonAmpCreativeRenderMethod_ = this.getNonAmpCreativeRenderingMethod();\n\n    /**\n     * Gets a notion of current time, in ms.  The value is not necessarily\n     * absolute, so should be used only for computing deltas.  When available,\n     * the performance system will be used; otherwise Date.now() will be\n     * returned.\n     *\n     * @const {function():number}\n     */\n    this.getNow_ =\n      this.win.performance && this.win.performance.now\n        ? this.win.performance.now.bind(this.win.performance)\n        : Date.now;\n\n    /** @const {string} */\n    this.sentinel = generateSentinel(window);\n\n    /**\n     * Used to indicate whether this slot should be collapsed or not. Marked\n     * true if the ad response has status 204, is null, or has a null\n     * arrayBuffer.\n     * @private {boolean}\n     */\n    this.isCollapsed_ = false;\n\n    /**\n     * Frame in which the creative renders (friendly if validated AMP, xdomain\n     * otherwise).\n     * @type {?HTMLIFrameElement}\n     */\n    this.iframe = null;\n\n    /**\n     * TODO(keithwrightbos) - remove once resume behavior is verified.\n     * {boolean} whether most recent ad request was generated as part\n     *    of resume callback.\n     */\n    this.fromResumeCallback = false;\n\n    /** @type {string} */\n    this.safeframeVersion = DEFAULT_SAFEFRAME_VERSION;\n\n    /**\n     * @protected {boolean} Indicates whether the ad is currently in the\n     *    process of being refreshed.\n     */\n    this.isRefreshing = false;\n\n    /** @protected {boolean} */\n    this.isRelayoutNeededFlag = false;\n\n    /**\n     * Mapping of feature name to value extracted from ad response header\n     * amp-ff-exps with comma separated pairs of '=' separated key/value.\n     * @type {!Object<string,string>}\n     */\n    this.postAdResponseExperimentFeatures = {};\n\n    /**\n     * The configuration for amp-analytics. If null, no amp-analytics element\n     * will be inserted and no analytics events will be fired.\n     * This will be initialized inside of buildCallback.\n     * @private {?JsonObject}\n     */\n    this.a4aAnalyticsConfig_ = null;\n\n    /**\n     * The amp-analytics element that for this impl's analytics config. It will\n     * be null before buildCallback() executes or if the impl does not provide\n     * an analytice config.\n     * @private {?Element}\n     * @visibleForTesting\n     */\n    this.a4aAnalyticsElement_ = null;\n\n    /**\n     * Indicates that this slot is a single page ad within an AMP story.\n     * @type {boolean}\n     */\n    this.isSinglePageStoryAd = false;\n  }\n\n  /** @override */\n  getLayoutPriority() {\n    // Priority used for scheduling preload and layout callback.  Because\n    // AMP creatives will be injected as part of the promise chain created\n    // within onLayoutMeasure, this is only relevant to non-AMP creatives\n    // therefore we want this to match the 3p priority.\n    const isPWA = !this.element.getAmpDoc().isSingleDoc();\n    // give the ad higher priority if it is inside a PWA\n    return isPWA ? LayoutPriority.METADATA : LayoutPriority.ADS;\n  }\n\n  /** @override */\n  isLayoutSupported(layout) {\n    return isLayoutSizeDefined(layout);\n  }\n\n  /** @override */\n  isRelayoutNeeded() {\n    return this.isRelayoutNeededFlag;\n  }\n\n  /** @override\n      @return {!Promise|undefined}\n  */\n  buildCallback() {\n    this.creativeSize_ = {\n      width: this.element.getAttribute('width'),\n      height: this.element.getAttribute('height'),\n    };\n    const upgradeDelayMs = Math.round(this.getResource().getUpgradeDelayMs());\n    dev().info(\n      TAG,\n      `upgradeDelay ${this.element.getAttribute('type')}: ${upgradeDelayMs}`\n    );\n\n    this.uiHandler = new AMP.AmpAdUIHandler(this);\n\n    const verifier = signatureVerifierFor(this.win);\n    this.keysetPromise_ = this.getAmpDoc()\n      .whenFirstVisible()\n      .then(() => {\n        this.getSigningServiceNames().forEach(signingServiceName => {\n          verifier.loadKeyset(signingServiceName);\n        });\n      });\n\n    this.a4aAnalyticsConfig_ = this.getA4aAnalyticsConfig();\n    if (this.a4aAnalyticsConfig_) {\n      // TODO(warrengm): Consider having page-level singletons for networks that\n      // use the same config for all ads.\n      this.a4aAnalyticsElement_ = insertAnalyticsElement(\n        this.element,\n        this.a4aAnalyticsConfig_,\n        true /* loadAnalytics */\n      );\n    }\n\n    this.isSinglePageStoryAd = this.element.hasAttribute('amp-story');\n  }\n\n  /** @override */\n  renderOutsideViewport() {\n    // Ensure non-verified AMP creatives are throttled.\n    if (\n      !this.isVerifiedAmpCreative_ &&\n      is3pThrottled(this.win) &&\n      !this.inNonAmpPreferenceExp()\n    ) {\n      return false;\n    }\n    // Otherwise the ad is good to go.\n    const elementCheck = getAmpAdRenderOutsideViewport(this.element);\n    return elementCheck !== null ? elementCheck : super.renderOutsideViewport();\n  }\n\n  /**\n   * To be overridden by network specific implementation indicating if element\n   * (and environment generally) are valid for sending XHR queries.\n   * @return {boolean} whether element is valid and ad request should be\n   *    sent.  If false, no ad request is sent and slot will be collapsed if\n   *    possible.\n   */\n  isValidElement() {\n    return true;\n  }\n\n  /**\n   * Returns the creativeSize, which is the size extracted from the ad response.\n   * @return {?({width, height}|../../../src/layout-rect.LayoutRectDef)}\n   */\n  getCreativeSize() {\n    return this.creativeSize_;\n  }\n\n  /**\n   * @return {boolean|number} whether ad request should be delayed until\n   *    renderOutsideViewport is met or if number, the amount of viewports.\n   */\n  delayAdRequestEnabled() {\n    return false;\n  }\n\n  /**\n   * Returns preconnect urls for A4A. Ad network should overwrite in their\n   * Fast Fetch implementation and return an array of urls for the runtime to\n   * preconnect to.\n   * @return {!Array<string>}\n   */\n  getPreconnectUrls() {\n    return [];\n  }\n\n  /**\n   * Returns prefetch urls for A4A. Ad network should overwrite in their\n   * Fast Fetch implementation and return an array of urls for the runtime to\n   * prefetch.\n   * @return {!Array<string>}\n   */\n  getPrefetchUrls() {\n    return [];\n  }\n\n  /**\n   * Returns true if this element was loaded from an amp-ad element.  For use by\n   * network-specific implementations that don't want to allow themselves to be\n   * embedded directly into a page.\n   * @return {boolean}\n   */\n  isAmpAdElement() {\n    return (\n      this.element.tagName == 'AMP-AD' || this.element.tagName == 'AMP-EMBED'\n    );\n  }\n\n  /**\n   * Prefetches and preconnects URLs related to the ad using adPreconnect\n   * registration which assumes ad request domain used for 3p is applicable.\n   * @param {boolean=} unusedOnLayout\n   * @override\n   */\n  preconnectCallback(unusedOnLayout) {\n    const preconnect = this.getPreconnectUrls();\n    // NOTE(keithwrightbos): Does not take isValidElement into account so could\n    // preconnect unnecessarily, however it is assumed that isValidElement\n    // matches amp-ad loader predicate such that A4A impl does not load.\n    if (preconnect) {\n      preconnect.forEach(p => {\n        this.preconnect.url(p, /*opt_preloadAs*/ true);\n      });\n    }\n  }\n\n  /** @override */\n  resumeCallback() {\n    // FIE that was not destroyed on unlayoutCallback does not require a new\n    // ad request.\n    if (this.friendlyIframeEmbed_) {\n      return;\n    }\n    this.fromResumeCallback = true;\n    // If layout of page has not changed, onLayoutMeasure will not be called\n    // so do so explicitly.\n    const resource = this.getResource();\n    if (resource.hasBeenMeasured() && !resource.isMeasureRequested()) {\n      this.onLayoutMeasure();\n    }\n  }\n\n  /**\n   * @return {!../../../src/service/resource.Resource}\n   * @visibleForTesting\n   */\n  getResource() {\n    return this.element.getResources().getResourceForElement(this.element);\n  }\n\n  /**\n   * @return {boolean} whether adPromise was initialized (indicator of\n   *    element validity).\n   * @protected\n   */\n  hasAdPromise() {\n    return !!this.adPromise_;\n  }\n\n  /**\n   * Should only be called after XHR response headers have been processed and\n   * postAdResponseExperimentFeatures is populated.\n   * @return {boolean} whether in experiment giving non-AMP creatives same\n   *    benefits as AMP (increased priority, no throttle)\n   * @visibleForTesting\n   */\n  inNonAmpPreferenceExp() {\n    return (\n      !!this.postAdResponseExperimentFeatures['pref_neutral_enabled'] &&\n      ['adsense', 'doubleclick'].includes(this.element.getAttribute('type'))\n    );\n  }\n\n  /**\n   * @return {boolean} whether environment/element should initialize ad request\n   *    promise chain.\n   * @private\n   */\n  shouldInitializePromiseChain_() {\n    const slotRect = this.getIntersectionElementLayoutBox();\n    if (\n      this.getLayout() != Layout.FLUID &&\n      (slotRect.height == 0 || slotRect.width == 0)\n    ) {\n      dev().fine(\n        TAG,\n        'onLayoutMeasure canceled due height/width 0',\n        this.element\n      );\n      return false;\n    }\n    if (!isAdPositionAllowed(this.element, this.win)) {\n      user().warn(\n        TAG,\n        `<${this.element.tagName}> is not allowed to be ` +\n          `placed in elements with position:fixed: ${this.element}`\n      );\n      return false;\n    }\n    // OnLayoutMeasure can be called when page is in prerender so delay until\n    // visible.  Assume that it is ok to call isValidElement as it should\n    // only being looking at window, immutable properties (i.e. location) and\n    // its element ancestry.\n    if (!this.isValidElement()) {\n      // TODO(kjwright): collapse?\n      user().warn(\n        TAG,\n        this.element.getAttribute('type'),\n        'Amp ad element ignored as invalid',\n        this.element\n      );\n      return false;\n    }\n    return true;\n  }\n\n  /** @override */\n  onLayoutMeasure() {\n    this.initiateAdRequest();\n  }\n\n  /**\n   * This is the entry point into the ad promise chain.\n   *\n   * Calling this function will initiate the following sequence of events: ad\n   * url construction, ad request issuance, creative verification, and metadata\n   * parsing.\n   *\n   * @protected\n   */\n  initiateAdRequest() {\n    if (this.xOriginIframeHandler_) {\n      this.xOriginIframeHandler_.onLayoutMeasure();\n    }\n    if (this.adPromise_ || !this.shouldInitializePromiseChain_()) {\n      return;\n    }\n\n    // Increment unique promise ID so that if its value changes within the\n    // promise chain due to cancel from unlayout, the promise will be rejected.\n    ++this.promiseId_;\n\n    // Shorthand for: reject promise if current promise chain is out of date.\n    const checkStillCurrent = this.verifyStillCurrent();\n\n    // Return value from this chain: True iff rendering was \"successful\"\n    // (i.e., shouldn't try to render later via iframe); false iff should\n    // try to render later in iframe.\n    // Cases to handle in this chain:\n    //   - Everything ok  => Render; return true\n    //   - Empty network response returned => Don't render; return true\n    //   - Can't parse creative out of response => Don't render; return false\n    //   - Can parse, but creative is empty => Don't render; return true\n    //   - Validation fails => return false\n    //   - Rendering fails => return false\n    //   - Chain cancelled => don't return; drop error\n    //   - Uncaught error otherwise => don't return; percolate error up\n    this.adPromise_ = this.getAmpDoc()\n      .whenFirstVisible()\n      .then(() => {\n        checkStillCurrent();\n        // See if experiment that delays request until slot is within\n        // renderOutsideViewport. Within render outside viewport will not\n        // resolve if already within viewport thus the check for already\n        // meeting the definition as opposed to waiting on the promise.\n        const delay = this.delayAdRequestEnabled();\n        if (delay) {\n          return this.getResource().whenWithinViewport(\n            typeof delay == 'number' ? delay : this.renderOutsideViewport()\n          );\n        }\n      })\n      // Possibly block on amp-consent.\n      /** @return {!Promise<Array<Promise>>} */\n      .then(() => {\n        checkStillCurrent();\n        const consentPolicyId = super.getConsentPolicy();\n\n        if (consentPolicyId) {\n          const consentStatePromise = getConsentPolicyState(\n            this.element,\n            consentPolicyId\n          ).catch(err => {\n            user().error(TAG, 'Error determining consent state', err);\n            return CONSENT_POLICY_STATE.UNKNOWN;\n          });\n\n          const consentStringPromise = getConsentPolicyInfo(\n            this.element,\n            consentPolicyId\n          ).catch(err => {\n            user().error(TAG, 'Error determining consent string', err);\n            return null;\n          });\n\n          return Promise.all([consentStatePromise, consentStringPromise]);\n        }\n\n        return Promise.resolve([null, null]);\n      })\n      // This block returns the ad URL, if one is available.\n      /** @return {!Promise<?string>} */\n      .then(consentResponse => {\n        checkStillCurrent();\n\n        const consentState = consentResponse[0];\n        const consentString = consentResponse[1];\n\n        return /** @type {!Promise<?string>} */ (this.getAdUrl(\n          consentState,\n          this.tryExecuteRealTimeConfig_(consentState, consentString)\n        ));\n      })\n      // This block returns the (possibly empty) response to the XHR request.\n      /** @return {!Promise<?Response>} */\n      .then(adUrl => {\n        checkStillCurrent();\n        this.adUrl_ = adUrl;\n        // If we should skip the XHR, we will instead request and render\n        // by simply writing a frame into the page using\n        // renderViaIframeGet\n        if (!this.isXhrAllowed() && !!this.adUrl_) {\n          this.experimentalNonAmpCreativeRenderMethod_ =\n            XORIGIN_MODE.IFRAME_GET;\n          return Promise.reject(IFRAME_GET);\n        }\n        return adUrl && this.sendXhrRequest(adUrl);\n      })\n      // The following block returns either the response (as a\n      // {bytes, headers} object), or null if no response is available /\n      // response is empty.\n      /** @return {?Promise<?{bytes: !ArrayBuffer, headers: !Headers}>} */\n      .then(fetchResponse => {\n        checkStillCurrent();\n        this.maybeTriggerAnalyticsEvent_('adRequestEnd');\n        // If the response is null (can occur for non-200 responses)  or\n        // arrayBuffer is null, force collapse.\n        if (\n          !fetchResponse ||\n          !fetchResponse.arrayBuffer ||\n          fetchResponse.headers.has('amp-ff-empty-creative')\n        ) {\n          this.forceCollapse();\n          return Promise.reject(NO_CONTENT_RESPONSE);\n        }\n        if (\n          fetchResponse.headers &&\n          fetchResponse.headers.has(EXPERIMENT_FEATURE_HEADER_NAME)\n        ) {\n          this.populatePostAdResponseExperimentFeatures_(\n            fetchResponse.headers.get(EXPERIMENT_FEATURE_HEADER_NAME)\n          );\n        }\n        if (\n          getMode().localDev &&\n          this.win.location &&\n          this.win.location.search\n        ) {\n          // Allow for setting experiment features via query param which\n          // will potentially override values returned in response.\n          const match = /(?:\\?|&)a4a_feat_exp=([^&]+)/.exec(\n            this.win.location.search\n          );\n          if (match && match[1]) {\n            dev().info(TAG, `Using debug exp features: ${match[1]}`);\n            this.populatePostAdResponseExperimentFeatures_(\n              tryDecodeUriComponent(match[1])\n            );\n          }\n        }\n        // TODO(tdrl): Temporary, while we're verifying whether SafeFrame is\n        // an acceptable solution to the 'Safari on iOS doesn't fetch\n        // iframe src from cache' issue.  See\n        // https://github.com/ampproject/amphtml/issues/5614\n        const method = this.getNonAmpCreativeRenderingMethod(\n          fetchResponse.headers.get(RENDERING_TYPE_HEADER)\n        );\n        this.experimentalNonAmpCreativeRenderMethod_ = method;\n        if (\n          this.experimentalNonAmpCreativeRenderMethod_ == XORIGIN_MODE.NAMEFRAME\n        ) {\n          this.preconnect.preload(\n            getDefaultBootstrapBaseUrl(this.win, 'nameframe')\n          );\n        }\n        const safeframeVersionHeader = fetchResponse.headers.get(\n          SAFEFRAME_VERSION_HEADER\n        );\n        if (\n          /^[0-9-]+$/.test(safeframeVersionHeader) &&\n          safeframeVersionHeader != DEFAULT_SAFEFRAME_VERSION\n        ) {\n          this.safeframeVersion = safeframeVersionHeader;\n          this.preconnect.preload(this.getSafeframePath());\n        }\n        // Note: Resolving a .then inside a .then because we need to capture\n        // two fields of fetchResponse, one of which is, itself, a promise,\n        // and one of which isn't.  If we just return\n        // fetchResponse.arrayBuffer(), the next step in the chain will\n        // resolve it to a concrete value, but we'll lose track of\n        // fetchResponse.headers.\n        return fetchResponse.arrayBuffer().then(bytes => {\n          if (bytes.byteLength == 0) {\n            // The server returned no content. Instead of displaying a blank\n            // rectangle, we collapse the slot instead.\n            this.forceCollapse();\n            return Promise.reject(NO_CONTENT_RESPONSE);\n          }\n          return {\n            bytes,\n            headers: fetchResponse.headers,\n          };\n        });\n      })\n      /** @return {!Promise<?ArrayBuffer>} */\n      .then(responseParts => {\n        checkStillCurrent();\n        // Keep a handle to the creative body so that we can render into\n        // SafeFrame or NameFrame later, if necessary.  TODO(tdrl): Temporary,\n        // while we\n        // assess whether this is the right solution to the Safari+iOS iframe\n        // src cache issue.  If we decide to keep a SafeFrame-like solution,\n        // we should restructure the promise chain to pass this info along\n        // more cleanly, without use of an object variable outside the chain.\n        if (!responseParts) {\n          return Promise.resolve();\n        }\n        const {bytes, headers} = responseParts;\n        const size = this.extractSize(responseParts.headers);\n        this.creativeSize_ = size || this.creativeSize_;\n        if (\n          this.experimentalNonAmpCreativeRenderMethod_ !=\n            XORIGIN_MODE.CLIENT_CACHE &&\n          bytes\n        ) {\n          this.creativeBody_ = bytes;\n        }\n        return this.maybeValidateAmpCreative(bytes, headers);\n      })\n      .then(creative => {\n        checkStillCurrent();\n        // Need to know if creative was verified as part of render outside\n        // viewport but cannot wait on promise.  Sadly, need a state a\n        // variable.\n        this.isVerifiedAmpCreative_ = !!creative;\n        return creative && utf8Decode(creative);\n      })\n      // This block returns CreativeMetaDataDef iff the creative was verified\n      // as AMP and could be properly parsed for friendly iframe render.\n      /** @return {?CreativeMetaDataDef} */\n      .then(creativeDecoded => {\n        checkStillCurrent();\n        // Note: It's critical that #getAmpAdMetadata be called\n        // on precisely the same creative that was validated\n        // via #validateAdResponse_.  See GitHub issue\n        // https://github.com/ampproject/amphtml/issues/4187\n        let creativeMetaDataDef;\n        if (\n          !creativeDecoded ||\n          !(creativeMetaDataDef = this.getAmpAdMetadata(creativeDecoded))\n        ) {\n          if (this.inNonAmpPreferenceExp()) {\n            // Experiment to give non-AMP creatives same benefits as AMP so\n            // update priority.\n            this.updateLayoutPriority(LayoutPriority.CONTENT);\n          }\n          return null;\n        }\n\n        // Update priority.\n        this.updateLayoutPriority(LayoutPriority.CONTENT);\n        // Load any extensions; do not wait on their promises as this\n        // is just to prefetch.\n        const extensions = Services.extensionsFor(this.win);\n        creativeMetaDataDef.customElementExtensions.forEach(extensionId =>\n          extensions.preloadExtension(extensionId)\n        );\n        // Preload any fonts.\n        (creativeMetaDataDef.customStylesheets || []).forEach(font =>\n          this.preconnect.preload(font.href)\n        );\n\n        const urls = Services.urlForDoc(this.element);\n        // Preload any AMP images.\n        (creativeMetaDataDef.images || []).forEach(\n          image => urls.isSecure(image) && this.preconnect.preload(image)\n        );\n        return creativeMetaDataDef;\n      })\n      .catch(error => {\n        switch (error.message || error) {\n          case IFRAME_GET:\n          case NETWORK_FAILURE:\n            return null;\n          case INVALID_SPSA_RESPONSE:\n          case NO_CONTENT_RESPONSE:\n            return {\n              minifiedCreative: '',\n              customElementExtensions: [],\n              customStylesheets: [],\n            };\n        }\n        // If error in chain occurs, report it and return null so that\n        // layoutCallback can render via cross domain iframe assuming ad\n        // url or creative exist.\n        this.promiseErrorHandler_(error);\n        return null;\n      });\n  }\n\n  /**\n   * This block returns the ad creative if it exists and validates as AMP;\n   * null otherwise.\n   * @param {!ArrayBuffer} bytes\n   * @param {!Headers} headers\n   * @return {!Promise<?ArrayBuffer>}\n   */\n  maybeValidateAmpCreative(bytes, headers) {\n    const checkStillCurrent = this.verifyStillCurrent();\n    return this.keysetPromise_\n      .then(() => {\n        if (\n          this.element.getAttribute('type') == 'fake' &&\n          !this.element.getAttribute('checksig')\n        ) {\n          // do not verify signature for fake type ad, unless the ad\n          // specfically requires via 'checksig' attribute\n          return Promise.resolve(VerificationStatus.OK);\n        }\n        return signatureVerifierFor(this.win).verify(bytes, headers);\n      })\n      .then(status => {\n        checkStillCurrent();\n        let result = null;\n        switch (status) {\n          case VerificationStatus.OK:\n            result = bytes;\n            break;\n          case VerificationStatus.CRYPTO_UNAVAILABLE:\n            result = this.shouldPreferentialRenderWithoutCrypto()\n              ? bytes\n              : null;\n            break;\n          // TODO(@taymonbeal, #9274): differentiate between these\n          case VerificationStatus.ERROR_KEY_NOT_FOUND:\n          case VerificationStatus.ERROR_SIGNATURE_MISMATCH:\n            user().error(\n              TAG,\n              this.element.getAttribute('type'),\n              'Signature verification failed'\n            );\n          case VerificationStatus.UNVERIFIED:\n        }\n        if (this.isSinglePageStoryAd && !result) {\n          throw new Error(INVALID_SPSA_RESPONSE);\n        }\n        return result;\n      });\n  }\n\n  /**\n   * Populates object mapping of feature to value used for post ad response\n   * behavior experimentation.  Assumes comma separated, = delimited key/value\n   * pairs.  If key appears more than once, last value wins.\n   * @param {string} input\n   * @private\n   */\n  populatePostAdResponseExperimentFeatures_(input) {\n    input.split(',').forEach(line => {\n      if (!line) {\n        return;\n      }\n      const parts = line.split('=');\n      if (parts.length != 2 || !parts[0]) {\n        dev().warn(TAG, `invalid experiment feature ${line}`);\n        return;\n      }\n      this.postAdResponseExperimentFeatures[parts[0]] = parts[1];\n    });\n  }\n\n  /**\n   * Refreshes ad slot by fetching a new creative and rendering it. This leaves\n   * the current creative displayed until the next one is ready.\n   *\n   * @param {function()} refreshEndCallback When called, this function will\n   *   restart the refresh cycle.\n   * @return {Promise} A promise that resolves when all asynchronous portions of\n   *   the refresh function complete. This is particularly handy for testing.\n   */\n  refresh(refreshEndCallback) {\n    devAssert(!this.isRefreshing);\n    this.isRefreshing = true;\n    this.tearDownSlot();\n    this.initiateAdRequest();\n    if (!this.adPromise_) {\n      // For whatever reasons, the adPromise has been nullified, and we will be\n      // unable to proceed. The current creative will continue to be displayed.\n      return Promise.resolve();\n    }\n    const promiseId = this.promiseId_;\n    return devAssert(this.adPromise_).then(() => {\n      if (!this.isRefreshing || promiseId != this.promiseId_) {\n        // If this refresh cycle was canceled, such as in a no-content\n        // response case, keep showing the old creative.\n        refreshEndCallback();\n        return;\n      }\n      return this.mutateElement(() => {\n        // Fire an ad-refresh event so that 3rd parties can track when an ad\n        // has changed.\n        triggerAnalyticsEvent(this.element, AnalyticsTrigger.AD_REFRESH);\n\n        this.togglePlaceholder(true);\n        // This delay provides a 1 second buffer where the ad loader is\n        // displayed in between the creatives.\n        return Services.timerFor(this.win)\n          .promise(1000)\n          .then(() => {\n            this.isRelayoutNeededFlag = true;\n            this.getResource().layoutCanceled();\n            // Only Require relayout after page visible\n            this.getAmpDoc()\n              .whenNextVisible()\n              .then(() => {\n                Services.ownersForDoc(this.getAmpDoc())./*OK*/ requireLayout(\n                  this.element\n                );\n              });\n          });\n      });\n    });\n  }\n\n  /**\n   * Handles uncaught errors within promise flow.\n   * @param {*} error\n   * @param {boolean=} opt_ignoreStack\n   * @private\n   */\n  promiseErrorHandler_(error, opt_ignoreStack) {\n    if (isCancellation(error)) {\n      // Rethrow if cancellation.\n      throw error;\n    }\n\n    if (error && error.message) {\n      error = duplicateErrorIfNecessary(/** @type {!Error} */ (error));\n    } else {\n      error = new Error('unknown error ' + error);\n    }\n    if (opt_ignoreStack) {\n      error.ignoreStack = opt_ignoreStack;\n    }\n\n    // Add `type` to the message. Ensure to preserve the original stack.\n    const type = this.element.getAttribute('type') || 'notype';\n    if (error.message.indexOf(`${TAG}: ${type}:`) != 0) {\n      error.message = `${TAG}: ${type}: ${error.message}`;\n    }\n\n    // Additional arguments.\n    assignAdUrlToError(/** @type {!Error} */ (error), this.adUrl_);\n\n    if (getMode().development || getMode().localDev || getMode().log) {\n      user().error(TAG, error);\n    } else {\n      user().warn(TAG, error);\n      // Report with 1% sampling as an expected dev error.\n      if (Math.random() < 0.01) {\n        dev().expectedError(TAG, error);\n      }\n    }\n  }\n\n  /** @override */\n  layoutCallback() {\n    if (this.isRefreshing) {\n      this.destroyFrame(true);\n    }\n    return this.attemptToRenderCreative();\n  }\n\n  /**\n   * Attemps to render the returned creative following the resolution of the\n   * adPromise.\n   *\n   * @return {!Promise<boolean>|!Promise<undefined>} A promise that resolves\n   *   when the rendering attempt has finished.\n   * @protected\n   */\n  attemptToRenderCreative() {\n    // Promise may be null if element was determined to be invalid for A4A.\n    if (!this.adPromise_) {\n      if (this.shouldInitializePromiseChain_()) {\n        dev().error(TAG, 'Null promise in layoutCallback');\n      }\n      return Promise.resolve();\n    }\n    const checkStillCurrent = this.verifyStillCurrent();\n    // Promise chain will have determined if creative is valid AMP.\n    return this.adPromise_\n      .then(creativeMetaData => {\n        checkStillCurrent();\n        if (this.isCollapsed_) {\n          return Promise.resolve();\n        }\n        // If this.iframe already exists, and we're not currently in the middle\n        // of refreshing, bail out here. This should only happen in\n        // testing context, not in production.\n        if (this.iframe && !this.isRefreshing) {\n          return Promise.resolve();\n        }\n        if (!creativeMetaData) {\n          // Non-AMP creative case, will verify ad url existence.\n          return this.renderNonAmpCreative();\n        }\n        // Must be an AMP creative.\n        return this.renderAmpCreative_(creativeMetaData).catch(err => {\n          checkStillCurrent();\n          // Failed to render via AMP creative path so fallback to non-AMP\n          // rendering within cross domain iframe.\n          user().warn(\n            TAG,\n            this.element.getAttribute('type'),\n            'Error injecting creative in friendly frame',\n            err\n          );\n          return this.renderNonAmpCreative();\n        });\n      })\n      .catch(error => {\n        this.promiseErrorHandler_(error);\n        throw cancellation();\n      });\n  }\n\n  /**\n   * Returns whether or not the ad request may be sent using XHR.\n   * @return {boolean}\n   */\n  isXhrAllowed() {\n    return true;\n  }\n\n  /** @override */\n  attemptChangeSize(newHeight, newWidth) {\n    // Store original size of slot in order to allow re-expansion on\n    // unlayoutCallback so that it is reverted to original size in case\n    // of resumeCallback.\n    this.originalSlotSize_ = this.originalSlotSize_ || this.getLayoutBox();\n    return super.attemptChangeSize(newHeight, newWidth);\n  }\n\n  /** @override  */\n  unlayoutCallback() {\n    this.tearDownSlot();\n    return true;\n  }\n\n  /**\n   * Attempts to tear down and set all state variables to initial conditions.\n   * @protected\n   */\n  tearDownSlot() {\n    // Increment promiseId to cause any pending promise to cancel.\n    this.promiseId_++;\n    this.uiHandler.applyUnlayoutUI();\n    if (this.originalSlotSize_) {\n      super\n        .attemptChangeSize(\n          this.originalSlotSize_.height,\n          this.originalSlotSize_.width\n        )\n        .then(() => {\n          this.originalSlotSize_ = null;\n        })\n        .catch(err => {\n          // TODO(keithwrightbos): if we are unable to revert size, on next\n          // trigger of promise chain the ad request may fail due to invalid\n          // slot size.  Determine how to handle this case.\n          dev().warn(TAG, 'unable to revert to original size', err);\n        });\n    }\n\n    this.isCollapsed_ = false;\n\n    // Remove rendering frame, if it exists.\n    this.destroyFrame();\n\n    this.adPromise_ = null;\n    this.adUrl_ = null;\n    this.creativeBody_ = null;\n    this.isVerifiedAmpCreative_ = false;\n    this.fromResumeCallback = false;\n    this.experimentalNonAmpCreativeRenderMethod_ = this.getNonAmpCreativeRenderingMethod();\n    this.postAdResponseExperimentFeatures = {};\n  }\n\n  /** @override */\n  detachedCallback() {\n    super.detachedCallback();\n    this.destroyFrame(true);\n  }\n\n  /**\n   * Attempts to remove the current frame and free any associated resources.\n   * This function will no-op if this ad slot is currently in the process of\n   * being refreshed.\n   *\n   * @param {boolean=} force Forces the removal of the frame, even if\n   *   this.isRefreshing is true.\n   * @protected\n   */\n  destroyFrame(force = false) {\n    if (!force && this.isRefreshing) {\n      return;\n    }\n    // Allow embed to release its resources.\n    if (this.friendlyIframeEmbed_) {\n      this.friendlyIframeEmbed_.destroy();\n      this.friendlyIframeEmbed_ = null;\n    }\n    if (this.iframe && this.iframe.parentElement) {\n      this.iframe.parentElement.removeChild(this.iframe);\n      this.iframe = null;\n    }\n    if (this.xOriginIframeHandler_) {\n      this.xOriginIframeHandler_.freeXOriginIframe();\n      this.xOriginIframeHandler_ = null;\n    }\n  }\n\n  /** @override  */\n  viewportCallback(inViewport) {\n    if (this.friendlyIframeEmbed_) {\n      setFriendlyIframeEmbedVisible(this.friendlyIframeEmbed_, inViewport);\n    }\n    if (this.xOriginIframeHandler_) {\n      this.xOriginIframeHandler_.viewportCallback(inViewport);\n    }\n  }\n\n  /**\n   * Gets the Ad URL to send an XHR Request to.  To be implemented\n   * by network.\n   * @param {?CONSENT_POLICY_STATE} unusedConsentState\n   * @param {Promise<!Array<rtcResponseDef>>=} opt_rtcResponsesPromise\n   * @return {!Promise<string>|string}\n   */\n  getAdUrl(unusedConsentState, opt_rtcResponsesPromise) {\n    throw new Error('getAdUrl not implemented!');\n  }\n\n  /**\n   * Resets ad url state to null, used to prevent frame get fallback if error\n   * is thrown after url construction but prior to layoutCallback.\n   */\n  resetAdUrl() {\n    this.adUrl_ = null;\n  }\n\n  /**\n   * @return {function()} function that when called will verify if current\n   *    ad retrieval is current (meaning unlayoutCallback was not executed).\n   *    If not, will throw cancellation exception;\n   * @throws {Error}\n   */\n  verifyStillCurrent() {\n    const promiseId = this.promiseId_;\n    return () => {\n      if (promiseId != this.promiseId_) {\n        throw cancellation();\n      }\n    };\n  }\n\n  /**\n   * Determine the desired size of the creative based on the HTTP response\n   * headers. Must be less than or equal to the original size of the ad slot\n   * along each dimension. May be overridden by network.\n   *\n   * @param {!Headers} responseHeaders\n   * @return {?SizeInfoDef}\n   */\n  extractSize(responseHeaders) {\n    const headerValue = responseHeaders.get(CREATIVE_SIZE_HEADER);\n    if (!headerValue) {\n      return null;\n    }\n    const match = /^([0-9]+)x([0-9]+)$/.exec(headerValue);\n    if (!match) {\n      // TODO(@taymonbeal, #9274): replace this with real error reporting\n      user().error(TAG, `Invalid size header: ${headerValue}`);\n      return null;\n    }\n    return /** @type {?SizeInfoDef} */ ({\n      width: Number(match[1]),\n      height: Number(match[2]),\n    });\n  }\n\n  /**\n   * Forces the UI Handler to collapse this slot.\n   * @visibleForTesting\n   */\n  forceCollapse() {\n    if (this.isRefreshing) {\n      // If, for whatever reason, the new creative would collapse this slot,\n      // stick with the old creative until the next refresh cycle.\n      this.isRefreshing = false;\n      return;\n    }\n    devAssert(this.uiHandler);\n    // Store original size to allow for reverting on unlayoutCallback so that\n    // subsequent pageview allows for ad request.\n    this.originalSlotSize_ = this.originalSlotSize_ || this.getLayoutBox();\n    this.uiHandler.applyNoContentUI();\n    this.isCollapsed_ = true;\n  }\n\n  /**\n   * Callback executed when creative has successfully rendered within the\n   * publisher page but prior to load (or ini-load for friendly frame AMP\n   * creative render).  To be overridden by network implementations as needed.\n   *\n   * @param {?CreativeMetaDataDef} creativeMetaData metadata if AMP creative,\n   *    null otherwise.\n   * @param {!Promise=} opt_onLoadPromise Promise that resolves when the FIE's\n   *    child window fires the `onload` event.\n   */\n  onCreativeRender(creativeMetaData, opt_onLoadPromise) {\n    this.maybeTriggerAnalyticsEvent_(\n      creativeMetaData ? 'renderFriendlyEnd' : 'renderCrossDomainEnd'\n    );\n  }\n\n  /**\n   * @param {!Element} iframe that was just created.  To be overridden for\n   * testing.\n   * @visibleForTesting\n   */\n  onCrossDomainIframeCreated(iframe) {\n    dev().info(\n      TAG,\n      this.element.getAttribute('type'),\n      `onCrossDomainIframeCreated ${iframe}`\n    );\n  }\n\n  /** @return {boolean} whether html creatives should be sandboxed. */\n  sandboxHTMLCreativeFrame() {\n    return true;\n  }\n\n  /**\n   * Send ad request, extract the creative and signature from the response.\n   * @param {string} adUrl Request URL to send XHR to.\n   * @return {!Promise<?Response>}\n   * @protected\n   */\n  sendXhrRequest(adUrl) {\n    this.maybeTriggerAnalyticsEvent_('adRequestStart');\n    const xhrInit = {\n      mode: 'cors',\n      method: 'GET',\n      credentials: 'include',\n    };\n    return Services.xhrFor(this.win)\n      .fetch(adUrl, xhrInit)\n      .catch(error => {\n        if (error.response && error.response.status > 200) {\n          // Invalid server response code so we should collapse.\n          return null;\n        }\n        // If an error occurs, let the ad be rendered via iframe after delay.\n        // TODO(taymonbeal): Figure out a more sophisticated test for deciding\n        // whether to retry with an iframe after an ad request failure or just\n        // give up and render the fallback content (or collapse the ad slot).\n        const networkFailureHandlerResult = this.onNetworkFailure(\n          error,\n          /** @type {string} */ (this.adUrl_)\n        );\n        devAssert(!!networkFailureHandlerResult);\n        if (networkFailureHandlerResult.frameGetDisabled) {\n          // Reset adUrl to null which will cause layoutCallback to not\n          // fetch via frame GET.\n          dev().info(\n            TAG,\n            'frame get disabled as part of network failure handler'\n          );\n          this.resetAdUrl();\n        } else {\n          this.adUrl_ = networkFailureHandlerResult.adUrl || this.adUrl_;\n          return Promise.reject(NETWORK_FAILURE);\n        }\n        return null;\n      });\n  }\n\n  /**\n   * Called on network failure sending XHR CORS ad request allowing for\n   * modification of ad url and prevent frame GET request on layoutCallback.\n   * By default, GET frame request will be executed with same ad URL as used\n   * for XHR CORS request.\n   * @param {*} unusedError from network failure\n   * @param {string} unusedAdUrl used for network request\n   * @return {!{adUrl: (string|undefined), frameGetDisabled: (boolean|undefined)}}\n   */\n  onNetworkFailure(unusedError, unusedAdUrl) {\n    return {};\n  }\n\n  /**\n   * To be overridden by network specific implementation indicating which\n   * signing service(s) is to be used.\n   * @return {!Array<string>} A list of signing services.\n   */\n  getSigningServiceNames() {\n    return getMode().localDev ? ['google', 'google-dev'] : ['google'];\n  }\n\n  /**\n   * Render non-AMP creative within cross domain iframe.\n   * @param {boolean=} throttleApplied Whether incrementLoadingAds has already\n   *    been called\n   * @return {Promise<boolean>} Whether the creative was successfully rendered.\n   */\n  renderNonAmpCreative(throttleApplied) {\n    if (this.element.getAttribute('disable3pfallback') == 'true') {\n      user().warn(\n        TAG,\n        this.element.getAttribute('type'),\n        'fallback to 3p disabled'\n      );\n      return Promise.resolve(false);\n    }\n    // TODO(keithwrightbos): remove when no longer needed.\n    dev().warn(TAG, 'fallback to 3p');\n    // Haven't rendered yet, so try rendering via one of our\n    // cross-domain iframe solutions.\n    const method = this.experimentalNonAmpCreativeRenderMethod_;\n    let renderPromise = Promise.resolve(false);\n    if (\n      (method == XORIGIN_MODE.SAFEFRAME || method == XORIGIN_MODE.NAMEFRAME) &&\n      this.creativeBody_\n    ) {\n      renderPromise = this.renderViaNameAttrOfXOriginIframe_(\n        this.creativeBody_\n      );\n      this.creativeBody_ = null; // Free resources.\n    } else if (this.adUrl_) {\n      assertHttpsUrl(this.adUrl_, this.element);\n      renderPromise = this.renderViaIframeGet_(this.adUrl_);\n    } else {\n      // Ad URL may not exist if buildAdUrl throws error or returns empty.\n      // If error occurred, it would have already been reported but let's\n      // report to user in case of empty.\n      user().warn(\n        TAG,\n        this.element.getAttribute('type'),\n        \"No creative or URL available -- A4A can't render any ad\"\n      );\n    }\n    if (!throttleApplied && !this.inNonAmpPreferenceExp()) {\n      incrementLoadingAds(this.win, renderPromise);\n    }\n    return renderPromise.then(result => {\n      this.maybeTriggerAnalyticsEvent_('crossDomainIframeLoaded');\n      // Pass on the result to the next value in the promise change.\n      return result;\n    });\n  }\n\n  /**\n   * Render a validated AMP creative directly in the parent page.\n   * @param {!CreativeMetaDataDef} creativeMetaData Metadata required to render\n   *     AMP creative.\n   * @return {!Promise} Whether the creative was successfully rendered.\n   * @private\n   */\n  renderAmpCreative_(creativeMetaData) {\n    devAssert(creativeMetaData.minifiedCreative, 'missing minified creative');\n    devAssert(!!this.element.ownerDocument, 'missing owner document?!');\n    this.maybeTriggerAnalyticsEvent_('renderFriendlyStart');\n    // Create and setup friendly iframe.\n    this.iframe = /** @type {!HTMLIFrameElement} */ (createElementWithAttributes(\n      /** @type {!Document} */ (this.element.ownerDocument),\n      'iframe',\n      dict({\n        // NOTE: It is possible for either width or height to be 'auto',\n        // a non-numeric value.\n        'height': this.creativeSize_.height,\n        'width': this.creativeSize_.width,\n        'frameborder': '0',\n        'allowfullscreen': '',\n        'allowtransparency': '',\n        'scrolling': 'no',\n      })\n    ));\n    this.applyFillContent(this.iframe);\n    const fontsArray = [];\n    if (creativeMetaData.customStylesheets) {\n      creativeMetaData.customStylesheets.forEach(s => {\n        const href = s['href'];\n        if (href) {\n          fontsArray.push(href);\n        }\n      });\n    }\n    const checkStillCurrent = this.verifyStillCurrent();\n    return installFriendlyIframeEmbed(\n      this.iframe,\n      this.element,\n      {\n        host: this.element,\n        // Need to guarantee that this is no longer null\n        url: /** @type {string} */ (this.adUrl_),\n        html: creativeMetaData.minifiedCreative,\n        extensionIds: creativeMetaData.customElementExtensions || [],\n        fonts: fontsArray,\n      },\n      (embedWin, ampdoc) => {\n        const parentAmpdoc = this.getAmpDoc();\n        installUrlReplacementsForEmbed(\n          // TODO(#22733): Cleanup `parentAmpdoc` once ampdoc-fie is launched.\n          ampdoc || parentAmpdoc,\n          embedWin,\n          new A4AVariableSource(parentAmpdoc, embedWin)\n        );\n      }\n    ).then(friendlyIframeEmbed => {\n      checkStillCurrent();\n      this.friendlyIframeEmbed_ = friendlyIframeEmbed;\n      setFriendlyIframeEmbedVisible(friendlyIframeEmbed, this.isInViewport());\n      // Ensure visibility hidden has been removed (set by boilerplate).\n      const frameDoc =\n        friendlyIframeEmbed.iframe.contentDocument ||\n        friendlyIframeEmbed.win.document;\n      setStyle(frameDoc.body, 'visibility', 'visible');\n      protectFunctionWrapper(this.onCreativeRender, this, err => {\n        dev().error(\n          TAG,\n          this.element.getAttribute('type'),\n          'Error executing onCreativeRender',\n          err\n        );\n      })(creativeMetaData, friendlyIframeEmbed.whenWindowLoaded());\n      friendlyIframeEmbed.whenIniLoaded().then(() => {\n        checkStillCurrent();\n        this.maybeTriggerAnalyticsEvent_('friendlyIframeIniLoad');\n      });\n\n      // There's no need to wait for all resources to load.\n      // StartRender is enough\n    });\n  }\n\n  /**\n   * Shared functionality for cross-domain iframe-based rendering methods.\n   * @param {!JsonObject<string, string>} attributes The attributes of the iframe.\n   * @return {!Promise} awaiting load event for ad frame\n   * @private\n   */\n  iframeRenderHelper_(attributes) {\n    const mergedAttributes = Object.assign(\n      attributes,\n      dict({\n        'height': this.creativeSize_.height,\n        'width': this.creativeSize_.width,\n      })\n    );\n\n    if (this.sentinel) {\n      mergedAttributes['data-amp-3p-sentinel'] = this.sentinel;\n    }\n    // Block synchronous XHR in ad. These are very rare, but super bad for UX\n    // as they block the UI thread for the arbitrary amount of time until the\n    // request completes.\n    mergedAttributes['allow'] = \"sync-xhr 'none';\";\n    this.iframe = /** @type {!HTMLIFrameElement} */ (createElementWithAttributes(\n      /** @type {!Document} */ (this.element.ownerDocument),\n      'iframe',\n      /** @type {!JsonObject} */ (Object.assign(\n        mergedAttributes,\n        SHARED_IFRAME_PROPERTIES\n      ))\n    ));\n    if (this.sandboxHTMLCreativeFrame()) {\n      applySandbox(this.iframe);\n    }\n    // TODO(keithwrightbos): noContentCallback?\n    this.xOriginIframeHandler_ = new AMP.AmpAdXOriginIframeHandler(this);\n    // Iframe is appended to element as part of xorigin frame handler init.\n    // Executive onCreativeRender after init to ensure it can get reference\n    // to frame but prior to load to allow for earlier access.\n    const frameLoadPromise = this.xOriginIframeHandler_.init(\n      this.iframe,\n      /* opt_isA4A */ true,\n      this.letCreativeTriggerRenderStart()\n    );\n    protectFunctionWrapper(this.onCreativeRender, this, err => {\n      dev().error(\n        TAG,\n        this.element.getAttribute('type'),\n        'Error executing onCreativeRender',\n        err\n      );\n    })(null);\n    return frameLoadPromise;\n  }\n\n  /**\n   * Creates iframe whose src matches that of the ad URL. For standard\n   * Fast Fetch running on the AMP cdn, an XHR request will typically have\n   * already been sent to the same adUrl, and the response should\n   * have been cached causing the browser to render without callout.  However,\n   * it is possible for cache miss to occur which can be detected server-side\n   * by missing ORIGIN header.\n   *\n   * Additionally, this method is also used in certain cases to send the only\n   * request, i.e. the initial XHR is skipped.\n   *\n   * Note: As of 2016-10-18, the fill-from-cache assumption appears to fail on\n   * Safari-on-iOS, which issues a fresh network request, even though the\n   * content is already in cache.\n   *\n   * @param {string} adUrl  Ad request URL, as sent to #sendXhrRequest (i.e.,\n   *    before any modifications that XHR module does to it.)\n   * @return {!Promise} awaiting ad completed insertion.\n   * @private\n   */\n  renderViaIframeGet_(adUrl) {\n    this.maybeTriggerAnalyticsEvent_('renderCrossDomainStart');\n    return this.iframeRenderHelper_(\n      dict({\n        'src': Services.xhrFor(this.win).getCorsUrl(this.win, adUrl),\n        'name': JSON.stringify(\n          getContextMetadata(this.win, this.element, this.sentinel)\n        ),\n      })\n    );\n  }\n\n  /**\n   * Whether AMP Ad Xorigin Iframe handler should wait for the creative to\n   * call render-start, rather than triggering it itself. Example use case\n   * is that amp-sticky-ad should trigger render-start itself so that the\n   * sticky container isn't shown before an ad is ready.\n   * @return {boolean}\n   */\n  letCreativeTriggerRenderStart() {\n    return false;\n  }\n\n  /**\n   * Render the creative via some \"cross domain iframe that accepts the creative\n   * in the name attribute\".  This could be SafeFrame or the AMP-native\n   * NameFrame.\n   *\n   * @param {!ArrayBuffer} creativeBody\n   * @return {!Promise} awaiting load event for ad frame\n   * @private\n   */\n  renderViaNameAttrOfXOriginIframe_(creativeBody) {\n    /** @type {?string} */\n    const method = this.experimentalNonAmpCreativeRenderMethod_;\n    devAssert(\n      method == XORIGIN_MODE.SAFEFRAME || method == XORIGIN_MODE.NAMEFRAME,\n      'Unrecognized A4A cross-domain rendering mode: %s',\n      method\n    );\n    this.maybeTriggerAnalyticsEvent_('renderSafeFrameStart');\n    const checkStillCurrent = this.verifyStillCurrent();\n    return tryResolve(() => utf8Decode(creativeBody)).then(creative => {\n      checkStillCurrent();\n      let srcPath;\n      let name = '';\n      switch (method) {\n        case XORIGIN_MODE.SAFEFRAME:\n          srcPath = this.getSafeframePath() + '?n=0';\n          break;\n        case XORIGIN_MODE.NAMEFRAME:\n          srcPath = getDefaultBootstrapBaseUrl(this.win, 'nameframe');\n          // Name will be set for real below in nameframe case.\n          break;\n        default:\n          // Shouldn't be able to get here, but...  Because of the assert,\n          // above, we can only get here in non-dev mode, so give user feedback.\n          user().error(\n            'A4A',\n            'A4A received unrecognized cross-domain name' +\n              ' attribute iframe rendering mode request: %s.  Unable to' +\n              ' render a creative for' +\n              ' slot %s.',\n            method,\n            this.element.getAttribute('id')\n          );\n          return Promise.reject('Unrecognized rendering mode request');\n      }\n      // TODO(bradfrizzell): change name of function and var\n      let contextMetadata = getContextMetadata(\n        this.win,\n        this.element,\n        this.sentinel,\n        this.getAdditionalContextMetadata(method == XORIGIN_MODE.SAFEFRAME)\n      );\n      // TODO(bradfrizzell) Clean up name assigning.\n      if (method == XORIGIN_MODE.NAMEFRAME) {\n        contextMetadata['creative'] = creative;\n        name = JSON.stringify(contextMetadata);\n      } else if (method == XORIGIN_MODE.SAFEFRAME) {\n        contextMetadata = JSON.stringify(contextMetadata);\n        name =\n          `${this.safeframeVersion};${creative.length};${creative}` +\n          `${contextMetadata}`;\n      }\n      return this.iframeRenderHelper_(dict({'src': srcPath, 'name': name}));\n    });\n  }\n\n  /**\n   *\n   * Throws {@code SyntaxError} if the metadata block delimiters are missing\n   * or corrupted or if the metadata content doesn't parse as JSON.\n   * @param {string} creative from which CSS is extracted\n   * @return {?CreativeMetaDataDef} Object result of parsing JSON data blob inside\n   *     the metadata markers on the ad text, or null if no metadata markers are\n   *     found.\n   * TODO(keithwrightbos@): report error cases\n   */\n  getAmpAdMetadata(creative) {\n    let metadataStart = -1;\n    let metadataString;\n    for (let i = 0; i < METADATA_STRINGS.length; i++) {\n      metadataString = METADATA_STRINGS[i];\n      metadataStart = creative.lastIndexOf(metadataString);\n      if (metadataStart >= 0) {\n        break;\n      }\n    }\n    if (metadataStart < 0) {\n      // Couldn't find a metadata blob.\n      dev().warn(\n        TAG,\n        this.element.getAttribute('type'),\n        'Could not locate start index for amp meta data in: %s',\n        creative\n      );\n      return null;\n    }\n    const metadataEnd = creative.lastIndexOf('</script>');\n    if (metadataEnd < 0) {\n      // Couldn't find a metadata blob.\n      dev().warn(\n        TAG,\n        this.element.getAttribute('type'),\n        'Could not locate closing script tag for amp meta data in: %s',\n        creative\n      );\n      return null;\n    }\n    try {\n      const metaDataObj = parseJson(\n        creative.slice(metadataStart + metadataString.length, metadataEnd)\n      );\n      const ampRuntimeUtf16CharOffsets =\n        metaDataObj['ampRuntimeUtf16CharOffsets'];\n      if (\n        !isArray(ampRuntimeUtf16CharOffsets) ||\n        ampRuntimeUtf16CharOffsets.length != 2 ||\n        typeof ampRuntimeUtf16CharOffsets[0] !== 'number' ||\n        typeof ampRuntimeUtf16CharOffsets[1] !== 'number'\n      ) {\n        throw new Error('Invalid runtime offsets');\n      }\n      const metaData = {};\n      if (metaDataObj['customElementExtensions']) {\n        metaData.customElementExtensions =\n          metaDataObj['customElementExtensions'];\n        if (!isArray(metaData.customElementExtensions)) {\n          throw new Error(\n            'Invalid extensions',\n            metaData.customElementExtensions\n          );\n        }\n      } else {\n        metaData.customElementExtensions = [];\n      }\n      if (metaDataObj['customStylesheets']) {\n        // Expect array of objects with at least one key being 'href' whose\n        // value is URL.\n        metaData.customStylesheets = metaDataObj['customStylesheets'];\n        const errorMsg = 'Invalid custom stylesheets';\n        if (!isArray(metaData.customStylesheets)) {\n          throw new Error(errorMsg);\n        }\n\n        const urls = Services.urlForDoc(this.element);\n        metaData.customStylesheets.forEach(stylesheet => {\n          if (\n            !isObject(stylesheet) ||\n            !stylesheet['href'] ||\n            typeof stylesheet['href'] !== 'string' ||\n            !urls.isSecure(stylesheet['href'])\n          ) {\n            throw new Error(errorMsg);\n          }\n        });\n      }\n      if (isArray(metaDataObj['images'])) {\n        // Load maximum of 5 images.\n        metaData.images = metaDataObj['images'].splice(0, 5);\n      }\n      if (this.isSinglePageStoryAd) {\n        // CTA Type is a required meta tag. CTA Url can come from meta tag, or\n        // (temporarily) amp-ad-exit config.\n        // TODO(#24080): maybe rerequire cta url?\n        if (!metaDataObj['ctaType']) {\n          throw new Error(INVALID_SPSA_RESPONSE);\n        }\n        this.element.setAttribute('data-vars-ctatype', metaDataObj['ctaType']);\n        this.element.setAttribute('data-vars-ctaurl', metaDataObj['ctaUrl']);\n      }\n      // TODO(keithwrightbos): OK to assume ampRuntimeUtf16CharOffsets is before\n      // metadata as its in the head?\n      metaData.minifiedCreative =\n        creative.slice(0, ampRuntimeUtf16CharOffsets[0]) +\n        creative.slice(ampRuntimeUtf16CharOffsets[1], metadataStart) +\n        creative.slice(metadataEnd + '</script>'.length);\n      return metaData;\n    } catch (err) {\n      dev().warn(\n        TAG,\n        this.element.getAttribute('type'),\n        'Invalid amp metadata: %s',\n        creative.slice(metadataStart + metadataString.length, metadataEnd)\n      );\n      if (this.isSinglePageStoryAd) {\n        throw err;\n      }\n      return null;\n    }\n  }\n\n  /**\n   * @return {string} full url to safeframe implementation.\n   */\n  getSafeframePath() {\n    return (\n      'https://tpc.googlesyndication.com/safeframe/' +\n      `${this.safeframeVersion}/html/container.html`\n    );\n  }\n\n  /**\n   * Checks if the given lifecycle event has a corresponding amp-analytics event\n   * and fires the analytics trigger if so.\n   * @param {string} lifecycleStage\n   * @private\n   */\n  maybeTriggerAnalyticsEvent_(lifecycleStage) {\n    if (!this.a4aAnalyticsConfig_) {\n      // No config exists that will listen to this event.\n      return;\n    }\n    const analyticsEvent = devAssert(\n      LIFECYCLE_STAGE_TO_ANALYTICS_TRIGGER[lifecycleStage]\n    );\n    const analyticsVars = /** @type {!JsonObject} */ (Object.assign(\n      dict({'time': Math.round(this.getNow_())}),\n      this.getA4aAnalyticsVars(analyticsEvent)\n    ));\n    triggerAnalyticsEvent(this.element, analyticsEvent, analyticsVars);\n  }\n\n  /**\n   * Returns variables to be included on an analytics event. This can be\n   * overridden by specific network implementations.\n   * Note that this function is called for each time an analytics event is\n   * fired.\n   * @param {string} unusedAnalyticsEvent The name of the analytics event.\n   * @return {!JsonObject}\n   */\n  getA4aAnalyticsVars(unusedAnalyticsEvent) {\n    return dict({});\n  }\n\n  /**\n   * Returns network-specific config for amp-analytics. It should overridden\n   * with network-specific configurations.\n   * This function may return null. If so, no amp-analytics element will be\n   * added to this A4A element and no A4A triggers will be fired.\n   * @return {?JsonObject}\n   */\n  getA4aAnalyticsConfig() {\n    return null;\n  }\n\n  /**\n   * Attempts to execute Real Time Config, if the ad network has enabled it.\n   * If it is not supported by the network, but the publisher has included\n   * the rtc-config attribute on the amp-ad element, warn.\n   * @param {?CONSENT_POLICY_STATE} consentState\n   * @param {?string} consentString\n   * @return {Promise<!Array<!rtcResponseDef>>|undefined}\n   */\n  tryExecuteRealTimeConfig_(consentState, consentString) {\n    if (!!AMP.RealTimeConfigManager) {\n      try {\n        return new AMP.RealTimeConfigManager(this).maybeExecuteRealTimeConfig(\n          this.getCustomRealTimeConfigMacros_(),\n          consentState,\n          consentString\n        );\n      } catch (err) {\n        user().error(TAG, 'Could not perform Real Time Config.', err);\n      }\n    } else if (this.element.getAttribute('rtc-config')) {\n      user().error(\n        TAG,\n        'RTC not supported for ad network ' +\n          `${this.element.getAttribute('type')}`\n      );\n    }\n  }\n\n  /**\n   * To be overriden by network impl. Should return a mapping of macro keys\n   * to values for substitution in publisher-specified URLs for RTC.\n   * @return {!Object<string,\n   *   !../../../src/service/variable-source.AsyncResolverDef>}\n   */\n  getCustomRealTimeConfigMacros_() {\n    return {};\n  }\n\n  /**\n   * Whether preferential render should still be utilized if web crypto is\n   * unavailable, and crypto signature header is present.\n   * @return {boolean}\n   */\n  shouldPreferentialRenderWithoutCrypto() {\n    return false;\n  }\n\n  /**\n   * @param {string=} headerValue Method as given in header.\n   * @return {?XORIGIN_MODE}\n   */\n  getNonAmpCreativeRenderingMethod(headerValue) {\n    if (headerValue) {\n      if (!isEnumValue(XORIGIN_MODE, headerValue)) {\n        dev().error(\n          'AMP-A4A',\n          `cross-origin render mode header ${headerValue}`\n        );\n      } else {\n        return /** @type {XORIGIN_MODE} */ (headerValue);\n      }\n    }\n    return Services.platformFor(this.win).isIos()\n      ? XORIGIN_MODE.NAMEFRAME\n      : null;\n  }\n\n  /**\n   * Returns base object that will be written to cross-domain iframe name\n   * attribute.\n   * @param {boolean=} opt_isSafeframe Whether creative is rendering into\n   *   a safeframe.\n   * @return {!JsonObject|undefined}\n   */\n  getAdditionalContextMetadata(opt_isSafeframe) {}\n\n  /**\n   * Returns whether the received creative is verified AMP.\n   * @return {boolean} True if the creative is verified AMP, false otherwise.\n   */\n  isVerifiedAmpCreative() {\n    return this.isVerifiedAmpCreative_;\n  }\n\n  /**\n   * Adds single pass experiment IDs if the javascript binary has\n   * \"singlePassType\" mode.\n   */\n  maybeAddSinglePassExperiment() {\n    const type = getMode().singlePassType;\n    if (type === 'sp') {\n      addExperimentIdToElement(\n        SINGLE_PASS_EXPERIMENT_IDS.SINGLE_PASS,\n        this.element\n      );\n    } else if (type === 'mp') {\n      addExperimentIdToElement(\n        SINGLE_PASS_EXPERIMENT_IDS.MULTI_PASS,\n        this.element\n      );\n    }\n  }\n}\n\n/**\n * Attachs query string portion of ad url to error.\n * @param {!Error} error\n * @param {?string} adUrl\n */\nexport function assignAdUrlToError(error, adUrl) {\n  if (!adUrl || (error.args && error.args['au'])) {\n    return;\n  }\n  const adQueryIdx = adUrl.indexOf('?');\n  if (adQueryIdx == -1) {\n    return;\n  }\n  (error.args || (error.args = {}))['au'] = adUrl.substring(\n    adQueryIdx + 1,\n    adQueryIdx + 251\n  );\n}\n\n/**\n * Returns the signature verifier for the given window. Lazily creates it if it\n * doesn't already exist.\n *\n * This ensures that only one signature verifier exists per window, which allows\n * multiple Fast Fetch ad slots on a page (even ones from different ad networks)\n * to share the same cached public keys.\n *\n * @param {!Window} win\n * @return {!SignatureVerifier}\n * @visibleForTesting\n */\nexport function signatureVerifierFor(win) {\n  const propertyName = 'AMP_FAST_FETCH_SIGNATURE_VERIFIER_';\n  return (\n    win[propertyName] ||\n    (win[propertyName] = new SignatureVerifier(win, signingServerURLs))\n  );\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../../../src/services';\nimport {base64DecodeToBytes} from '../../../src/utils/base64';\nimport {dev, devAssert, user} from '../../../src/log';\nimport {isArray} from '../../../src/types';\n\n/** @visibleForTesting */\nexport const AMP_SIGNATURE_HEADER = 'AMP-Fast-Fetch-Signature';\n\n/**\n * The result of an attempt to verify a Fast Fetch signature. The different\n * error statuses are used for reporting errors to the ad network.\n *\n * @enum {number}\n */\nexport const VerificationStatus = {\n  /** The ad was successfully verified as AMP. */\n  OK: 0,\n\n  /**\n   * Verification failed because of a factor beyond the ad network's control,\n   * such as a network connectivity failure, unavailability of Web Cryptography\n   * in the current browsing context, or a misbehaving signing service.\n   */\n  UNVERIFIED: 1,\n\n  /**\n   * Verification failed because the keypair ID provided by the ad network did\n   * not correspond to any public key offered by the signing service.\n   */\n  ERROR_KEY_NOT_FOUND: 2,\n\n  /**\n   * Verification failed because the signature provided by the ad network was\n   * not the correct cryptographic signature for the given creative data and\n   * public key.\n   */\n  ERROR_SIGNATURE_MISMATCH: 3,\n\n  /**\n   * Verification failed because the page does not have web crypto available,\n   * i.e. is not SSL.\n   */\n  CRYPTO_UNAVAILABLE: 4,\n};\n\n/**\n * A window-level object that encapsulates the logic for obtaining public keys\n * from Fast Fetch signing services and cryptographically verifying signatures\n * of AMP creatives.\n *\n * Unlike an AMP service, a signature verifier is **stateful**. It maintains a\n * cache of all public keys that it has previously downloaded and imported, and\n * also keeps track of which keys and signing services have already had\n * unsuccessful download or import attempts and should not be attempted again.\n *\n * This entire class is currently dead code in production, but will soon be\n * introduced as an experiment.\n */\nexport class SignatureVerifier {\n  /**\n   * @param {!Window} win\n   * @param {!Object<string, string>} signingServerURLs a map from the name of\n   *    each trusted signing service to the URL of its public key endpoint\n   */\n  constructor(win, signingServerURLs) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /** @private @const {!Object<string, string>} */\n    this.signingServerURLs_ = signingServerURLs;\n\n    /**\n     * The cache where all the public keys are stored.\n     *\n     * This field has a lot of internal structure and its type's a little hairy,\n     * so here's a rundown of what each piece means:\n     *  - If Web Cryptography isn't available in the current browsing context,\n     *    then the entire field is null. Since the keys are of no use, we don't\n     *    fetch them.\n     *  - Otherwise, it's a map-like `Object` from signing service names (as\n     *    defined in the Fast Fetch config registry) to \"signer\" objects.\n     *  - The `promise` property of each signer resolves to a boolean indicating\n     *    whether the most recent attempt to fetch and import that signing\n     *    service's public keys was successful. If the promise is still pending,\n     *    then an attempt is currently in progress. This property is mutable;\n     *    its value is replaced with a new promise when a new attempt is made.\n     *    Invariant: only one attempt may be in progress at a time, so this\n     *    property may not be mutated while the current promise is pending.\n     *  - The `keys` property of each signer is a map-like `Object` from keypair\n     *    IDs to nullable key promises. (This means that a property access on\n     *    this object may evaluate to `undefined`, `null`, or a `Promise`\n     *    object.) The `keys` object is internally mutable; new keys are added\n     *    to it as they are fetched. Invariant: the `keys` object may be mutated\n     *    only while the corresponding `promise` object is pending; this ensures\n     *    that callbacks chained to `promise` may observe `keys` without being\n     *    subject to race conditions.\n     *  - If a key promise (i.e., the value of a property access on the `keys`\n     *    object) is absent (i.e., `undefined`), then no key with that keypair\n     *    ID is present (but this could be because of a stale cache). If it's\n     *    null, then no key with that keypair ID could be found even after\n     *    cachebusting. If it's a `Promise` that resolves to `null`, then key\n     *    data for that keypair ID was found but could not be imported\n     *    successfully; this most likely indicates signing service misbehavior.\n     *    The success case is a `Promise` that resolves to a `CryptoKey`.\n     *\n     * @private @const {?Object<string, {promise: !Promise<boolean>, keys: !Object<string, ?Promise<?webCrypto.CryptoKey>>}>}\n     */\n    this.signers_ = Services.cryptoFor(win).isPkcsAvailable() ? {} : null;\n\n    /**\n     * Gets a notion of current time, in ms.  The value is not necessarily\n     * absolute, so should be used only for computing deltas.  When available,\n     * the performance system will be used; otherwise Date.now() will be\n     * returned.\n     *\n     * @protected @const {function(): number}\n     */\n    this.getNow_ =\n      win.performance && win.performance.now\n        ? win.performance.now.bind(win.performance)\n        : Date.now;\n  }\n\n  /**\n   * Fetches and imports the public keyset for the named signing service,\n   * without any cachebusting. Hopefully, this will hit cache in many cases\n   * and not make an actual network round-trip. This method should be called\n   * as early as possible, once it's known which signing service is likely to\n   * be used, so that the network request and key imports can execute in\n   * parallel with other operations.\n   *\n   * @param {string} signingServiceName\n   */\n  loadKeyset(signingServiceName) {\n    if (this.signers_ && !this.signers_[signingServiceName]) {\n      const keys = {};\n      const promise = this.fetchAndAddKeys_(keys, signingServiceName, null);\n      this.signers_[signingServiceName] = {promise, keys};\n    }\n  }\n\n  /**\n   * Extracts a cryptographic signature from `headers` and attempts to verify\n   * that it's the correct cryptographic signature for `creative`.\n   *\n   * As a precondition, `loadKeyset(signingServiceName)` must have already been\n   * called.\n   *\n   * @param {!ArrayBuffer} creative\n   * @param {!Headers} headers\n   * @return {!Promise<!VerificationStatus>}\n   */\n  verify(creative, headers) {\n    const signatureFormat = /^([A-Za-z0-9._-]+):([A-Za-z0-9._-]+):([A-Za-z0-9+/]{341}[AQgw]==)$/;\n    if (!headers.has(AMP_SIGNATURE_HEADER)) {\n      return Promise.resolve(VerificationStatus.UNVERIFIED);\n    }\n    const headerValue = headers.get(AMP_SIGNATURE_HEADER);\n    const match = signatureFormat.exec(headerValue);\n    if (!match) {\n      // TODO(@taymonbeal, #9274): replace this with real error reporting\n      user().error(\n        'AMP-A4A',\n        `Invalid signature header: ${headerValue.split(':')[0]}`\n      );\n      return Promise.resolve(VerificationStatus.ERROR_SIGNATURE_MISMATCH);\n    }\n    return this.verifyCreativeAndSignature(\n      match[1],\n      match[2],\n      base64DecodeToBytes(match[3]),\n      creative\n    );\n  }\n\n  /**\n   * Verifies that `signature` is the correct cryptographic signature for\n   * `creative`, with the public key from the named signing service identified\n   * by `keypairId`.\n   *\n   * As a precondition, `loadKeyset(signingServiceName)` must have already been\n   * called.\n   *\n   * If the keyset for the named signing service was imported successfully but\n   * did not include a key for `keypairId`, this may be the result of a stale\n   * browser cache. To work around this, `keypairId` is added to the public key\n   * endpoint URL as a query parameter and the keyset is re-fetched. Other kinds\n   * of failures, including network connectivity failures, are not retried.\n   *\n   * @param {string} signingServiceName\n   * @param {string} keypairId\n   * @param {!Uint8Array} signature\n   * @param {!ArrayBuffer} creative\n   * @return {!Promise<!VerificationStatus>}\n   * @visibleForTesting\n   */\n  verifyCreativeAndSignature(\n    signingServiceName,\n    keypairId,\n    signature,\n    creative\n  ) {\n    if (!this.signers_) {\n      // Web Cryptography isn't available.\n      return Promise.resolve(VerificationStatus.CRYPTO_UNAVAILABLE);\n    }\n    const signer = this.signers_[signingServiceName];\n    devAssert(\n      signer,\n      'Keyset for service %s not loaded before verification',\n      signingServiceName\n    );\n    return signer.promise.then(success => {\n      if (!success) {\n        // The public keyset couldn't be fetched and imported. Probably a\n        // network connectivity failure.\n        return VerificationStatus.UNVERIFIED;\n      }\n      const keyPromise = signer.keys[keypairId];\n      if (keyPromise === undefined) {\n        // We don't have this key, but maybe the cache is stale; try\n        // cachebusting.\n        signer.promise = this.fetchAndAddKeys_(\n          signer.keys,\n          signingServiceName,\n          keypairId\n        ).then(success => {\n          if (signer.keys[keypairId] === undefined) {\n            // We still don't have this key; make sure we never try\n            // again.\n            signer.keys[keypairId] = null;\n          }\n          return success;\n        });\n        // This \"recursive\" call can recurse at most once.\n        return this.verifyCreativeAndSignature(\n          signingServiceName,\n          keypairId,\n          signature,\n          creative\n        );\n      } else if (keyPromise === null) {\n        // We don't have this key and we already tried cachebusting.\n        return VerificationStatus.ERROR_KEY_NOT_FOUND;\n      } else {\n        return keyPromise.then(key => {\n          if (!key) {\n            // This particular public key couldn't be imported. Probably the\n            // signing service's fault.\n            return VerificationStatus.UNVERIFIED;\n          }\n          const crypto = Services.cryptoFor(this.win_);\n          return crypto.verifyPkcs(key, signature, creative).then(\n            result =>\n              result\n                ? VerificationStatus.OK\n                : VerificationStatus.ERROR_SIGNATURE_MISMATCH,\n            err => {\n              // Web Cryptography rejected the verification attempt. This\n              // hopefully won't happen in the wild, but browsers can be weird\n              // about this, so we need to guard against the possibility.\n              // Phone home to the AMP Project so that we can understand why\n              // this occurred.\n              const message = err && err.message;\n              dev().error('AMP-A4A', `Failed to verify signature: ${message}`);\n              return VerificationStatus.UNVERIFIED;\n            }\n          );\n        });\n      }\n    });\n  }\n\n  /**\n   * Try to download the keyset for the named signing service and add a promise\n   * for each key to the `keys` object.\n   *\n   * @param {!Object<string, ?Promise<?webCrypto.CryptoKey>>} keys the object to\n   *     add each key promise to. This is mutated while the returned promise is\n   *     pending.\n   * @param {string} signingServiceName\n   * @param {?string} keypairId the keypair ID to include in the query string\n   *     for cachebusting purposes, or `null` if no cachebusting is needed\n   * @return {!Promise<boolean>} resolves after the mutation of `keys` is\n   *     complete, to `true` if the keyset was downloaded and parsed\n   *     successfully (even if some keys were malformed), or `false` if a\n   *     keyset-level failure occurred\n   * @private\n   */\n  fetchAndAddKeys_(keys, signingServiceName, keypairId) {\n    let url = this.signingServerURLs_[signingServiceName];\n    if (keypairId != null) {\n      url += '?kid=' + encodeURIComponent(keypairId);\n    }\n    // TODO(@taymonbeal, #11088): consider a timeout on this fetch\n    return Services.xhrFor(this.win_)\n      .fetchJson(url, {\n        mode: 'cors',\n        method: 'GET',\n        // This should be cached across publisher domains, so don't append\n        // __amp_source_origin to the URL.\n        ampCors: false,\n        credentials: 'omit',\n      })\n      .then(\n        response => {\n          // These are assertions on signing service behavior required by\n          // the spec. However, nothing terrible happens if they aren't met\n          // and there's no meaningful error recovery to be done if they\n          // fail, so we don't need to do them at runtime in production.\n          // They're included in dev mode as a debugging aid.\n          devAssert(\n            response.status === 200,\n            'Fast Fetch keyset spec requires status code 200'\n          );\n          devAssert(\n            response.headers.get('Content-Type') == 'application/jwk-set+json',\n            'Fast Fetch keyset spec requires Content-Type: ' +\n              'application/jwk-set+json'\n          );\n          return response.json().then(\n            jsonResponse => {\n              const jwkSet = /** @type {!JsonObject} */ (jsonResponse);\n              // This is supposed to be a JSON Web Key Set, as defined in\n              // Section 5 of RFC 7517. However, the signing service could\n              // misbehave and send an arbitrary JSON value, so we have to\n              // type-check at runtime.\n              if (!jwkSet || !isArray(jwkSet['keys'])) {\n                signingServiceError(\n                  signingServiceName,\n                  `Key set (${JSON.stringify(jwkSet)}) has no \"keys\"`\n                );\n                return false;\n              }\n              jwkSet['keys'].forEach(jwk => {\n                if (!jwk || typeof jwk['kid'] != 'string') {\n                  signingServiceError(\n                    signingServiceName,\n                    `Key (${JSON.stringify(jwk)}) has no \"kid\"`\n                  );\n                } else if (keys[jwk['kid']] === undefined) {\n                  // We haven't seen this keypair ID before.\n                  keys[jwk['kid']] = Services.cryptoFor(this.win_)\n                    .importPkcsKey(jwk)\n                    .catch(err => {\n                      // Web Cryptography rejected the key\n                      // import attempt. Either the signing\n                      // service sent a malformed key or the\n                      // browser is doing something weird.\n                      const jwkData = JSON.stringify(jwk);\n                      const message = err && err.message;\n                      signingServiceError(\n                        signingServiceName,\n                        `Failed to import key (${jwkData}): ${message}`\n                      );\n                      return null;\n                    });\n                }\n              });\n              return true;\n            },\n            err => {\n              // The signing service didn't send valid JSON.\n              signingServiceError(\n                signingServiceName,\n                `Failed to parse JSON: ${err && err.response}`\n              );\n              return false;\n            }\n          );\n        },\n        err => {\n          // Some kind of error occurred during the XHR. This could be a lot\n          // of things (and we have no type information), but if there's no\n          // `response` it's probably a network connectivity failure, so we\n          // ignore it. Unfortunately, we can't distinguish this from a CORS\n          // problem.\n          if (err && err.response) {\n            // This probably indicates a non-2xx HTTP status code.\n            signingServiceError(\n              signingServiceName,\n              `Status code ${err.response.status}`\n            );\n          }\n          return false;\n        }\n      );\n  }\n}\n\n/**\n * Report an error caused by a signing service. Since signing services currently\n * don't have their own error logging URLs, we just send everything to the AMP\n * Project.\n *\n * @param {string} signingServiceName\n * @param {string} message\n * @private\n */\nfunction signingServiceError(signingServiceName, message) {\n  dev().error(\n    'AMP-A4A',\n    `Signing service error for ${signingServiceName}: ${message}`\n  );\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Determines which tags desire A4A handling\n * @param {!Window} win\n * @param {!Element} element\n * @param {boolean} useRemoteHtml\n * @return {boolean}\n */\nexport function cloudflareIsA4AEnabled(win, element, useRemoteHtml) {\n  // We assume fast fetch for all content, but this will gracefully degrade,\n  // when non-a4a content is delivered\n  return !useRemoteHtml;\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dict} from '../../../src/utils/object';\nimport {parseJson} from '../../../src/json';\nimport {user} from '../../../src/log';\n\nexport class AmpAdMetadataTransformer {\n  /** constructor */\n  constructor() {\n    /** @public {JsonObject} */\n    this.metadata = dict({});\n    /** @private {!Array<Object>} */\n    this.styles_ = [];\n    /** @private {!Array<Object>} */\n    this.extensions_ = [];\n    /** @private {Element} */\n    this.firstRuntimeElement_ = null;\n    /** @private {Element} */\n    this.lastRuntimeElement_ = null;\n    /** @private {string} */\n    this.ctaType_ = '';\n    /** @private {string} */\n    this.ctaUrl_ = '';\n    /** @private {!Array<string>} */\n    this.jsonMetadata_ = [];\n    /** @private {!Array<Object>} */\n    this.imgMetadata_ = [];\n    /** @private {Element} */\n    this.ampAnalytics_ = null;\n  }\n\n  /**\n   * Creates a JSON metadata in which custom stylesheets, extensions\n   * and runtime offsets are recorded. This is used by AMP4ADS at runtime\n   * for embedding an ad into an enclosing document.\n   * Please note: once runtime offsets are computed the document must not\n   * change.\n   *\n   * https://cs.corp.google.com/piper///depot/google3/search/amphtml/transformers/amp_ad_metadata_transformer.cc\n   * @param {Document} doc\n   * @return {string}\n   */\n  generateMetadata(doc) {\n    const {head} = doc;\n    this.generateHeadMetadata_(head);\n    this.generateImageMetadata_(doc);\n    this.generateJsonMetadata_(doc);\n\n    // Creating json object from all of the components\n    const creative = doc.documentElement./*OK*/ outerHTML;\n    this.generateRuntimeOffsets_(creative);\n    this.generateJsonOffsets_(creative);\n    this.generateAmpAnalyticsOffsets_(doc, creative);\n    this.addExtensionsMetadata_();\n\n    if (this.styles_.length > 0) {\n      this.metadata['customStyleSheets'] = this.styles_;\n    }\n    if (this.imgMetadata_.length > 0) {\n      this.metadata['images'] = [];\n      for (let i = 0; i < this.imgMetadata_.length; i++) {\n        const img = this.imgMetadata_[i];\n        this.metadata['images'].push(img.src);\n      }\n    }\n    if (this.ctaType_) {\n      this.metadata['ctaType'] = this.ctaType_;\n    }\n    if (this.ctaUrl_) {\n      this.metadata['ctaUrl'] = this.ctaUrl_;\n    }\n    return JSON.stringify(this.metadata);\n  }\n\n  /**\n   * Generates metadata from document head, including\n   * runtime offsets, custom extensions, styles, and CTA\n   * @param {Element} head\n   */\n  generateHeadMetadata_(head) {\n    if (head == null) {\n      return;\n    }\n    for (let i = 0; i < head.children.length; i++) {\n      const child = head.children.item(i);\n      if (child.tagName == 'SCRIPT' && child.hasAttribute('src')) {\n        if (this.firstRuntimeElement_ == null) {\n          this.firstRuntimeElement_ = child;\n        }\n        this.lastRuntimeElement_ = child;\n        if (child.hasAttribute('custom-element')) {\n          this.extensions_.push({\n            'custom-element': child.getAttribute('custom-element'),\n            'src': child.getAttribute('src'),\n          });\n        }\n        if (child.hasAttribute('custom-template')) {\n          this.extensions_.push({\n            'custom-template': child.getAttribute('custom-template'),\n            'src': child.getAttribute('src'),\n          });\n        }\n      }\n      if (\n        child.tagName == 'LINK' &&\n        child.getAttribute('rel') == 'stylesheet' &&\n        child.hasAttribute('href')\n      ) {\n        this.generateStyleMetadata_(child);\n      }\n      if (\n        child.tagName == 'META' &&\n        child.hasAttribute('name') &&\n        child.hasAttribute('content')\n      ) {\n        this.generateCtaMetadata_(child);\n      }\n    }\n  }\n\n  /**\n   * Generates custom style metadata\n   * @param {Element} element\n   */\n  generateStyleMetadata_(element) {\n    const styleObject = {href: element.getAttribute('href')};\n    if (element.hasAttribute('media')) {\n      styleObject.media = element.getAttribute('media');\n    }\n    this.styles_.push(styleObject);\n  }\n\n  /**\n   * Generates CTA metadata for story ads\n   * @param {Element} element\n   */\n  generateCtaMetadata_(element) {\n    if (element.getAttribute('name') == 'amp-cta-type') {\n      this.ctaType_ = element.getAttribute('content');\n    }\n    if (element.getAttribute('name') == 'amp-cta-url') {\n      this.ctaUrl_ = element.getAttribute('content');\n    }\n  }\n\n  /**\n   * Generates image metadata\n   * @param {Document} doc\n   */\n  generateImageMetadata_(doc) {\n    const imgs = doc.querySelectorAll('amp-img[src]');\n    for (let i = 0; i < imgs.length; i++) {\n      const img = imgs[i];\n      let width;\n      let height;\n      let area = -1;\n      if (img.hasAttribute('width')) {\n        width = img.getAttribute('width');\n      }\n      if (img.hasAttribute('height')) {\n        height = img.getAttribute('height');\n      }\n      if (height && width) {\n        area = height * width;\n      }\n      this.imgMetadata_.push({\n        src: img.getAttribute('src'),\n        area,\n      });\n    }\n  }\n\n  /**\n   * Finds all <script type=application/json> tags and parses\n   * existing <amp-ad-metadata> script, if it exists\n   * @param {Document} doc\n   */\n  generateJsonMetadata_(doc) {\n    const json = doc.querySelectorAll('script[type]');\n    for (let i = 0; i < json.length; i++) {\n      const script = json[i];\n      const type = script.getAttribute('type');\n      if (type != 'application/json') {\n        user().warn('SCRIPT', 'Type is invalid, must be `application/json`');\n        continue;\n      }\n      if (script.hasAttribute('amp-ad-metadata')) {\n        const parsed = parseJson(script.textContent);\n        for (const attribute in parsed) {\n          this.metadata[attribute] = parsed[attribute];\n        }\n      }\n      if (\n        script.hasAttribute('id') &&\n        !this.jsonMetadata_.includes(script.getAttribute('id'))\n      ) {\n        this.jsonMetadata_.push(script.getAttribute('id'));\n      }\n    }\n  }\n\n  /**\n   * Generates start and end of all runtime scripts,\n   * so they can be extracted by amp-a4a.js\n   * @param {string} creative\n   */\n  generateRuntimeOffsets_(creative) {\n    let start = 0;\n    let end = 0;\n    if (this.firstRuntimeElement_ != null) {\n      const firstRuntimeElementString = this.firstRuntimeElement_\n        ./*OK*/ outerHTML;\n      const lastRuntimeElementString = this.lastRuntimeElement_\n        ./*OK*/ outerHTML;\n      start = creative.indexOf(firstRuntimeElementString);\n      end =\n        creative.indexOf(lastRuntimeElementString) +\n        lastRuntimeElementString.length;\n    }\n    this.metadata['ampRuntimeUtf16CharOffsets'] = [start, end];\n  }\n\n  /**\n   * Generates start and end of all json scripts,\n   * not including <amp-analytics> json\n   * @param {string} creative\n   */\n  generateJsonOffsets_(creative) {\n    if (this.jsonMetadata_.length > 0) {\n      this.metadata['jsonUtf16CharOffsets'] = {};\n      for (let i = 0; i < this.jsonMetadata_.length; i++) {\n        const name = this.jsonMetadata_[i];\n        const nameElementString = this.ampAnalytics_./*OK*/ innerHTML;\n        const jsonStart = creative.indexOf(nameElementString);\n        const jsonEnd = jsonStart + nameElementString.length;\n        this.metadata['jsonUtf16CharOffsets'][name] = [jsonStart, jsonEnd];\n      }\n    }\n  }\n  /**\n   * Generates start and end of all json scripts\n   * within <amp-analytics> tags\n   * @param {Document} doc\n   * @param {string} creative\n   */\n  generateAmpAnalyticsOffsets_(doc, creative) {\n    const ampAnalytics = doc.querySelectorAll('amp-analytics');\n    if (ampAnalytics.length > 0) {\n      if (!this.metadata['jsonUtf16CharOffsets']) {\n        this.metadata['jsonUtf16CharOffsets'] = {};\n      }\n      this.metadata['jsonUtf16CharOffsets']['amp-analytics'] = [];\n      for (let i = 0; i < ampAnalytics.length; i++) {\n        const element = ampAnalytics[i];\n        const nameElementString = element./*OK*/ innerHTML;\n        const jsonStart = creative.indexOf(nameElementString);\n        const jsonEnd = jsonStart + nameElementString.length;\n        this.metadata['jsonUtf16CharOffsets']['amp-analytics'].push(jsonStart);\n        this.metadata['jsonUtf16CharOffsets']['amp-analytics'].push(jsonEnd);\n      }\n    }\n  }\n  /**\n   * Adds \"customElementExtensions\" and \"extensions\" objects to metadata\n   */\n  addExtensionsMetadata_() {\n    if (this.extensions_.length > 0) {\n      this.metadata['customElementExtensions'] = [];\n      this.metadata['extensions'] = [];\n      for (let i = 0; i < this.extensions_.length; i++) {\n        const extension = this.extensions_[i];\n        let custom;\n        if (extension['custom-element'] != null) {\n          custom = extension['custom-element'];\n        } else {\n          custom = extension['custom-template'];\n        }\n        if (this.metadata['customElementExtensions'].indexOf(custom) == -1) {\n          this.metadata['customElementExtensions'].push(custom);\n          this.metadata['extensions'].push({\n            'custom-element': custom,\n            'src': extension['src'],\n          });\n        }\n      }\n    }\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AmpA4A} from '../../amp-a4a/0.1/amp-a4a';\nimport {AmpAdMetadataTransformer} from './amp-ad-metadata-transformer';\nimport {ExternalReorderHeadTransformer} from './external-reorder-head-transformer';\nimport {startsWith} from '../../../src/string';\nimport {user, userAssert} from '../../../src/log';\n\nconst TAG = 'AMP-AD-NETWORK-FAKE-IMPL';\n\nexport class AmpAdNetworkFakeImpl extends AmpA4A {\n  /**\n   * @param {!Element} element\n   */\n  constructor(element) {\n    super(element);\n\n    /** @private {!./external-reorder-head-transformer.ExternalReorderHeadTransformer} */\n    this.reorderHeadTransformer_ = new ExternalReorderHeadTransformer();\n    /** @private {!./amp-ad-metadata-transformer.AmpAdMetadataTransformer} */\n    this.metadataTransformer_ = new AmpAdMetadataTransformer();\n  }\n\n  /** @override */\n  buildCallback() {\n    userAssert(\n      this.element.hasAttribute('src'),\n      'Attribute src required for <amp-ad type=\"fake\">: %s',\n      this.element\n    );\n    super.buildCallback();\n  }\n\n  /** @override */\n  isValidElement() {\n    // To send out ad request, ad type='fake' requires the id set to an invalid\n    // value start with `i-amphtml-demo-`. So that fake ad can only be used in\n    // invalid AMP pages.\n    const id = this.element.getAttribute('id');\n    if (!id || !startsWith(id, 'i-amphtml-demo-')) {\n      user().warn(TAG, 'Only works with id starts with i-amphtml-demo-');\n      return false;\n    }\n    return true;\n  }\n\n  /** @override */\n  getAdUrl() {\n    return this.element.getAttribute('src');\n  }\n\n  /** @override */\n  sendXhrRequest(adUrl) {\n    return super.sendXhrRequest(adUrl).then(response => {\n      if (!response) {\n        return null;\n      }\n      const {\n        status,\n        headers,\n      } = /** @type {{status: number, headers: !Headers}} */ (response);\n\n      // In the convert creative mode the content is the plain AMP HTML.\n      // This mode is primarily used for A4A Envelop for testing.\n      // See DEVELOPING.md for more info.\n      if (this.element.getAttribute('a4a-conversion') == 'true') {\n        return response.text().then(\n          responseText =>\n            new Response(this.transformCreative_(responseText), {\n              status,\n              headers,\n            })\n        );\n      }\n\n      // Normal mode: Expect the creative is written in AMP4ADS doc.\n      return response;\n    });\n  }\n\n  /**\n   * Converts a general AMP doc to a AMP4ADS doc.\n   * @param {string} source\n   * @return {string}\n   */\n  transformCreative_(source) {\n    const doc = new DOMParser().parseFromString(source, 'text/html');\n    const root = doc.documentElement;\n\n    // <html > -> <html 4ads>\n    if (root.hasAttribute('')) {\n      root.removeAttribute('');\n    } else if (root.hasAttribute('amp')) {\n      root.removeAttribute('amp');\n    } else if (root.hasAttribute('AMP')) {\n      root.removeAttribute('AMP');\n    }\n    if (!root.hasAttribute('4ads') && !root.hasAttribute('4ADS')) {\n      root.setAttribute('amp4ads', '');\n    }\n\n    this.reorderHeadTransformer_.reorderHead(doc.head);\n    const metadata = this.metadataTransformer_.generateMetadata(doc);\n\n    //Removes <amp-ad-metadata> tag if it exists\n    const oldMetadata = doc.querySelector('script[amp-ad-metadata]');\n    if (oldMetadata) {\n      oldMetadata.parentNode.removeChild(oldMetadata);\n    }\n\n    const creative = root./*OK*/ outerHTML;\n    const creativeSplit = creative.split('</body>');\n    const docWithMetadata =\n      creativeSplit[0] +\n      `<script type=\"application/json\" amp-ad-metadata>` +\n      metadata +\n      '</script></body>' +\n      creativeSplit[1];\n    return docWithMetadata;\n  }\n}\n\nAMP.extension('amp-ad-network-fake-impl', '0.1', AMP => {\n  AMP.registerElement('amp-ad-network-fake-impl', AmpAdNetworkFakeImpl);\n});\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {endsWith, startsWith} from '../../../src/string';\nimport {urls} from '../../../src/config';\n\nexport class ExternalReorderHeadTransformer {\n  /** constructor */\n  constructor() {\n    /** @private {!Object} */\n    this.headComponents_ = {\n      metaOther: [],\n      scriptNonRenderDelayingExtensions: [],\n      scriptRenderDelayingExtensions: [],\n      linkIcons: [],\n      linkResourceHints: [],\n      linkStylesheetBeforeAmpCustom: [],\n      other: [],\n      otherScripts: [],\n      styleAmpRuntime: null,\n      metaCharset: null,\n      scriptAmpEngine: null,\n      scriptAmpViewer: null,\n      scriptGmailAmpViewer: null,\n      styleAmpCustom: null,\n      linkStylesheetRuntimeCss: null,\n      styleAmpBoilerplate: null,\n      noscript: null,\n    };\n  }\n\n  /**\n   * Appends child to parent, if child is not null\n   * @param {Element} parent\n   * @param {Element} element\n   */\n  appendIfNotNull_(parent, element) {\n    if (element != null) {\n      parent.appendChild(element);\n    }\n  }\n\n  /**\n   * Appends all children to parent\n   * @param {Element} parent\n   * @param {Array<Element>} element\n   */\n  appendAll_(parent, element) {\n    for (let i = 0; i < element.length; i++) {\n      const child = element[i];\n      parent.appendChild(child);\n    }\n  }\n\n  /**\n   * Reorders head like so:\n   * (0) <meta charset> tag\n   * (1) <style amp-runtime>\n   * (2) remaining <meta> tags (those other than <meta charset>)\n   * (3) AMP runtime .js <script> tag\n   * (4) AMP viewer runtime .js <script> tag\n   * (5) Gmail AMP viewer runtime .js <script> tag\n   * (6) <script> tags for render delaying extensions\n   * (7) <script> tags for remaining extensions\n   * (8) <link> tag for favicon\n   * (9) <link> tag for resource hints\n   * (10) <link rel=stylesheet> tags before <style amp-custom>\n   * (11) <style amp-custom>\n   * (12) any other tags allowed in <head>\n   * (13) amp boilerplate (first style amp-boilerplate, then noscript)\n   *\n   * http://g3doc/search/amphtml/transformers/g3doc/t/ExternalReorderHead.md\n   * @param {Element} head\n   * @return {Element}\n   */\n  reorderHead(head) {\n    if (head != null) {\n      for (let i = 0; i < head.children.length; i++) {\n        const child = head.children.item(i);\n        switch (child.tagName) {\n          case 'META':\n            this.registerMeta_(child);\n            break;\n          case 'SCRIPT':\n            this.registerScript_(child);\n            break;\n          case 'STYLE':\n            this.registerStyle_(child);\n            break;\n          case 'LINK':\n            this.registerLink_(child);\n            break;\n          case 'NOSCRIPT':\n            this.headComponents_.noscript = child;\n            break;\n          default:\n            if (this.headComponents_.other.indexOf(child) == -1) {\n              this.headComponents_.other.push(child);\n            }\n        }\n      }\n      for (let i = 0; i < head.childNodes.length; i++) {\n        head.removeChild(head.childNodes.item(i));\n      }\n      this.repopulate_(head);\n    }\n\n    return head;\n  }\n\n  /**\n   * Classifies all elements with meta tags\n   * @param {Element} element\n   *\n   */\n  registerMeta_(element) {\n    if (element.hasAttribute('charset')) {\n      this.headComponents_.metaCharset = element;\n      return;\n    }\n    if (this.headComponents_.metaOther.indexOf(element) == -1) {\n      this.headComponents_.metaOther.push(element);\n      return;\n    }\n  }\n\n  /**\n   * Classifies all elements with script tags\n   * @param {Element} element\n   *\n   */\n  registerScript_(element) {\n    const src = element.getAttribute('src');\n    const isAsync = element.hasAttribute('async');\n    const isExtension =\n      element.hasAttribute('custom-element') ||\n      element.hasAttribute('custom-template') ||\n      element.hasAttribute('host-service');\n    if (isExtension) {\n      const custom = element.getAttribute('custom-element');\n      if (\n        custom == 'amp-story' ||\n        custom == 'amp-experiment' ||\n        custom == 'amp-dynamic-css-classes'\n      ) {\n        this.headComponents_.scriptRenderDelayingExtensions.push(element);\n        return;\n      }\n      this.headComponents_.scriptNonRenderDelayingExtensions.push(element);\n      return;\n    }\n    if (\n      isAsync &&\n      ((startsWith(src, urls.cdn) &&\n        (endsWith(src, '/v0.js') ||\n          endsWith(src, '/v0.js.br') ||\n          endsWith(src, '/amp4ads-v0.js') ||\n          endsWith(src, '/amp4ads-v0.js.br'))) ||\n        endsWith(src, '/dist/amp.js') ||\n        endsWith(src, '/dist/amp-inabox.js') ||\n        endsWith(src, '/dist/v0.js') ||\n        endsWith(src, '/dist/amp4ads-v0.js'))\n    ) {\n      this.headComponents_.scriptAmpEngine = element;\n      return;\n    }\n    if (\n      isAsync &&\n      startsWith(src, urls.cdn + '/v0/amp-viewer-integration-gmail-') &&\n      endsWith(src, '.js')\n    ) {\n      this.headComponents_.scriptGmailAmpViewer = element;\n      return;\n    }\n    if (\n      isAsync &&\n      (startsWith(src, urls.cdn + '/v0/amp-viewer-integration-') ||\n        (startsWith(src, urls.cdn + '/viewer/google/v') &&\n          endsWith(src, '.js')))\n    ) {\n      this.headComponents_.scriptAmpViewer = element;\n      return;\n    }\n    if (this.headComponents_.other.indexOf(element) == -1) {\n      this.headComponents_.other.push(element);\n    }\n  }\n\n  /**\n   * Classifies all elements with style tags\n   * @param {Element} element\n   *\n   */\n  registerStyle_(element) {\n    if (element.hasAttribute('amp-runtime')) {\n      this.headComponents_.styleAmpRuntime = element;\n      return;\n    }\n    if (element.hasAttribute('amp-custom')) {\n      this.headComponents_.styleAmpCustom = element;\n      return;\n    }\n    if (\n      element.hasAttribute('amp-boilerplate') ||\n      element.hasAttribute('amp4ads-boilerplate')\n    ) {\n      this.headComponents_.styleAmpBoilerplate = element;\n      return;\n    }\n    if (this.headComponents_.other.indexOf(element) == -1) {\n      this.headComponents_.other.push(element);\n    }\n  }\n\n  /**\n   * Classifies all links\n   * @param {Element} element\n   *\n   */\n  registerLink_(element) {\n    const rel = element.getAttribute('rel');\n    if (rel == 'stylesheet') {\n      if (\n        startsWith(element.getAttribute('href'), urls.cdn) &&\n        endsWith(element.getAttribute('href'), '/v0.css')\n      ) {\n        this.headComponents_.linkStylesheetRuntimeCss = element;\n        return;\n      }\n      if (this.headComponents_.styleAmpCustom == null) {\n        this.headComponents_.linkStylesheetBeforeAmpCustom.push(element);\n        return;\n      }\n      return;\n    }\n    if (rel == 'icon' || rel == 'icon shortcut' || rel == 'shortcut icon') {\n      this.headComponents_.linkIcons.push(element);\n      return;\n    }\n    if (rel == 'dns-prefetch preconnect') {\n      this.headComponents_.linkResourceHints.push(element);\n      return;\n    }\n    if (this.headComponents_.other.indexOf(element) == -1) {\n      this.headComponents_.other.push(element);\n    }\n  }\n\n  /**\n   * Add components back to head in specified order\n   * @param {Element} head\n   * @return {Element}\n   */\n  repopulate_(head) {\n    this.appendIfNotNull_(head, this.headComponents_.metaCharset);\n    this.appendIfNotNull_(head, this.headComponents_.linkStylesheetRuntimeCss);\n    this.appendIfNotNull_(head, this.headComponents_.styleAmpRuntime);\n    this.appendAll_(head, this.headComponents_.metaOther);\n    this.appendIfNotNull_(head, this.headComponents_.scriptAmpEngine);\n    this.appendIfNotNull_(head, this.headComponents_.scriptAmpViewer);\n    this.appendIfNotNull_(head, this.headComponents_.scriptGmailAmpViewer);\n    this.appendAll_(head, this.headComponents_.scriptRenderDelayingExtensions);\n    this.appendAll_(\n      head,\n      this.headComponents_.scriptNonRenderDelayingExtensions\n    );\n    this.appendAll_(head, this.headComponents_.otherScripts);\n    this.appendAll_(head, this.headComponents_.linkIcons);\n    this.appendAll_(head, this.headComponents_.linkResourceHints);\n    this.appendAll_(head, this.headComponents_.linkStylesheetBeforeAmpCustom);\n    this.appendIfNotNull_(head, this.headComponents_.styleAmpCustom);\n    this.appendAll_(head, this.headComponents_.other);\n    this.appendIfNotNull_(head, this.headComponents_.styleAmpBoilerplate);\n    this.appendIfNotNull_(head, this.headComponents_.noscript);\n    return head;\n  }\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {startsWith} from '../../../src/string';\n\n/** @const @private {string} */\nconst GMOSSP_SRC_PREFIX_ = 'https://sp.gmossp-sp.jp/';\n\n/** @const @private {string} */\nconst GMOSSP_SRC_A4A_PREFIX_ = 'https://amp.sp.gmossp-sp.jp/_a4a/';\n\n/**\n * @param {!Window} win\n * @param {!Element} element\n * @param {boolean} useRemoteHtml\n * @return {boolean}\n */\nexport function gmosspIsA4AEnabled(win, element, useRemoteHtml) {\n  let src;\n  return (\n    !useRemoteHtml &&\n    !!(src = element.getAttribute('src')) &&\n    !!element.getAttribute('data-use-a4a') &&\n    (startsWith(src, GMOSSP_SRC_PREFIX_) ||\n      startsWith(src, GMOSSP_SRC_A4A_PREFIX_))\n  );\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/** @const @private {string} */\nconst SRC_PREFIX_ = 'https://ib.3lift.com/';\n/**\n * @param {!Window} win\n * @param {!Element} element\n * @param {boolean} useRemoteHtml\n * @return {boolean}\n */\nexport function tripleliftIsA4AEnabled(win, element, useRemoteHtml) {\n  let src;\n  return (\n    !useRemoteHtml &&\n    !!element.getAttribute('data-use-a4a') &&\n    !!(src = element.getAttribute('src')) &&\n    src.indexOf(SRC_PREFIX_) == 0\n  );\n}\n","/* Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../../../src/utils/promise';\nimport {Services} from '../../../src/services';\nimport {user, userAssert} from '../../../src/log';\n\n/**\n * Store loading ads info within window to ensure it can be properly stored\n * across separately compiled binaries that share load throttling.\n * @const ID of window variable used to track 3p ads waiting to load.\n */\nconst LOADING_ADS_WIN_ID_ = '3pla';\n\n/** @private {?Promise} resolves when no 3p throttle */\nlet throttlePromise_ = null;\n/** @private {?Function} resolver for throttle promise */\nlet throttlePromiseResolver_ = null;\n\n/**\n * @param {!Window} win\n * @return {boolean} Whether 3p is currently throttled.\n */\nexport function is3pThrottled(win) {\n  return !!win[LOADING_ADS_WIN_ID_];\n}\n\n/** @return {!Promise} resolves when no 3p throttle */\nexport function waitFor3pThrottle() {\n  return throttlePromise_ || Promise.resolve();\n}\n\n/**\n * @param {!Element} element\n * @return {?number} number if explicit value should be used otherwise super\n *    default should be used.\n */\nexport function getAmpAdRenderOutsideViewport(element) {\n  const rawValue = element.getAttribute('data-loading-strategy');\n  if (rawValue == null) {\n    return null;\n  }\n  // Ad opts into lazier loading strategy where we only load ads that are\n  // at closer given number of viewports away.\n  if (rawValue == 'prefer-viewability-over-views' || rawValue == '') {\n    return 1.25;\n  }\n  const errorMessage =\n    'Value of data-loading-strategy should be a float number in range ' +\n    'of [0, 3], but got ' +\n    rawValue;\n  const viewportNumber = user().assertNumber(\n    parseFloat(rawValue),\n    errorMessage\n  );\n  userAssert(viewportNumber >= 0 && viewportNumber <= 3, errorMessage);\n  return viewportNumber;\n}\n\n/**\n * Increments loading ads count for throttling.\n * @param {!Window} win\n * @param {!Promise=} opt_loadingPromise\n */\nexport function incrementLoadingAds(win, opt_loadingPromise) {\n  if (win[LOADING_ADS_WIN_ID_] === undefined) {\n    win[LOADING_ADS_WIN_ID_] = 0;\n  }\n  win[LOADING_ADS_WIN_ID_]++;\n\n  if (!throttlePromise_) {\n    const deferred = new Deferred();\n    throttlePromise_ = deferred.promise;\n    throttlePromiseResolver_ = deferred.resolve;\n  }\n\n  Services.timerFor(win)\n    .timeoutPromise(1000, opt_loadingPromise)\n    .catch(() => {})\n    .then(() => {\n      if (!--win[LOADING_ADS_WIN_ID_]) {\n        throttlePromiseResolver_();\n        throttlePromise_ = null;\n        throttlePromiseResolver_ = null;\n      }\n    });\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dev, devAssert} from './log';\nimport {dict} from './utils/object';\nimport {internalListenImplementation} from './event-helper-listen';\nimport {parseJson} from './json';\n\n/** @const */\nconst AMP_MESSAGE_PREFIX = 'amp-';\nexport const CONSTANTS = {\n  responseTypeSuffix: '-result',\n  messageIdFieldName: 'messageId',\n  payloadFieldName: 'payload',\n  contentFieldName: 'content',\n};\n\n/** @enum {string} */\nexport const MessageType = {\n  // For amp-ad\n  SEND_EMBED_STATE: 'send-embed-state',\n  EMBED_STATE: 'embed-state',\n  SEND_EMBED_CONTEXT: 'send-embed-context',\n  EMBED_CONTEXT: 'embed-context',\n  SEND_INTERSECTIONS: 'send-intersections',\n  INTERSECTION: 'intersection',\n  EMBED_SIZE: 'embed-size',\n  EMBED_SIZE_CHANGED: 'embed-size-changed',\n  EMBED_SIZE_DENIED: 'embed-size-denied',\n  NO_CONTENT: 'no-content',\n  GET_HTML: 'get-html',\n  GET_CONSENT_STATE: 'get-consent-state',\n\n  // For the frame to be placed in full overlay mode for lightboxes\n  FULL_OVERLAY_FRAME: 'full-overlay-frame',\n  FULL_OVERLAY_FRAME_RESPONSE: 'full-overlay-frame-response',\n  CANCEL_FULL_OVERLAY_FRAME: 'cancel-full-overlay-frame',\n  CANCEL_FULL_OVERLAY_FRAME_RESPONSE: 'cancel-full-overlay-frame-response',\n\n  // For amp-inabox\n  SEND_POSITIONS: 'send-positions',\n  POSITION: 'position',\n\n  // For amp-analytics' iframe-transport\n  SEND_IFRAME_TRANSPORT_EVENTS: 'send-iframe-transport-events',\n  IFRAME_TRANSPORT_EVENTS: 'iframe-transport-events',\n  IFRAME_TRANSPORT_RESPONSE: 'iframe-transport-response',\n\n  // For user-error-in-iframe\n  USER_ERROR_IN_IFRAME: 'user-error-in-iframe',\n};\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Serialize an AMP post message. Output looks like:\n * 'amp-011481323099490{\"type\":\"position\",\"sentinel\":\"12345\",\"foo\":\"bar\"}'\n * @param {string} type\n * @param {string} sentinel\n * @param {JsonObject=} data\n * @param {?string=} rtvVersion\n * @return {string}\n */\nexport function serializeMessage(\n  type,\n  sentinel,\n  data = dict(),\n  rtvVersion = null\n) {\n  // TODO: consider wrap the data in a \"data\" field. { type, sentinal, data }\n  const message = data;\n  message['type'] = type;\n  message['sentinel'] = sentinel;\n  return AMP_MESSAGE_PREFIX + (rtvVersion || '') + JSON.stringify(message);\n}\n\n/**\n * Deserialize an AMP post message.\n * Returns null if it's not valid AMP message format.\n *\n * @param {*} message\n * @return {?JsonObject|undefined}\n */\nexport function deserializeMessage(message) {\n  if (!isAmpMessage(message)) {\n    return null;\n  }\n  const startPos = message.indexOf('{');\n  devAssert(startPos != -1, 'JSON missing in %s', message);\n  try {\n    return parseJson(message.substr(startPos));\n  } catch (e) {\n    dev().error('MESSAGING', 'Failed to parse message: ' + message, e);\n    return null;\n  }\n}\n\n/**\n *  Returns true if message looks like it is an AMP postMessage\n *  @param {*} message\n *  @return {boolean}\n */\nexport function isAmpMessage(message) {\n  return (\n    typeof message == 'string' &&\n    message.indexOf(AMP_MESSAGE_PREFIX) == 0 &&\n    message.indexOf('{') != -1\n  );\n}\n\n/** @typedef {{creativeId: string, message: string}} */\nexport let IframeTransportEvent;\n// An event, and the transport ID of the amp-analytics tags that\n// generated it. For instance if the creative with transport\n// ID 2 sends \"hi\", then an IframeTransportEvent would look like:\n// { creativeId: \"2\", message: \"hi\" }\n// If the creative with transport ID 2 sent that, and also sent \"hello\",\n// and the creative with transport ID 3 sends \"goodbye\" then an *array* of 3\n// AmpAnalyticsIframeTransportEvent would be sent to the 3p frame like so:\n// [\n//   { creativeId: \"2\", message: \"hi\" }, // An AmpAnalyticsIframeTransportEvent\n//   { creativeId: \"2\", message: \"hello\" }, // Another\n//   { creativeId: \"3\", message: \"goodbye\" } // And another\n// ]\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assertHttpsUrl, parseUrlDeprecated} from './url';\nimport {dev, devAssert, user, userAssert} from './log';\nimport {dict} from './utils/object';\nimport {getContextMetadata} from '../src/iframe-attributes';\nimport {getMode} from './mode';\nimport {internalRuntimeVersion} from './internal-version';\nimport {setStyle} from './style';\nimport {startsWith} from './string';\nimport {tryParseJson} from './json';\nimport {urls} from './config';\n\n/** @type {!Object<string,number>} Number of 3p frames on the for that type. */\nlet count = {};\n\n/** @type {string} */\nlet overrideBootstrapBaseUrl;\n\n/** @const {string} */\nconst TAG = '3p-frame';\n\n/**\n * Produces the attributes for the ad template.\n * @param {!Window} parentWindow\n * @param {!AmpElement} element\n * @param {string=} opt_type\n * @param {Object=} opt_context\n * @return {!JsonObject} Contains\n *     - type, width, height, src attributes of <amp-ad> tag. These have\n *       precedence over the data- attributes.\n *     - data-* attributes of the <amp-ad> tag with the \"data-\" removed.\n *     - A _context object for internal use.\n */\nfunction getFrameAttributes(parentWindow, element, opt_type, opt_context) {\n  const type = opt_type || element.getAttribute('type');\n  userAssert(type, 'Attribute type required for <amp-ad>: %s', element);\n  const sentinel = generateSentinel(parentWindow);\n  let attributes = dict();\n  // Do these first, as the other attributes have precedence.\n  addDataAndJsonAttributes_(element, attributes);\n  attributes = getContextMetadata(parentWindow, element, sentinel, attributes);\n  attributes['type'] = type;\n  Object.assign(attributes['_context'], opt_context);\n  return attributes;\n}\n\n/**\n * Creates the iframe for the embed. Applies correct size and passes the embed\n * attributes to the frame via JSON inside the fragment.\n * @param {!Window} parentWindow\n * @param {!AmpElement} parentElement\n * @param {string=} opt_type\n * @param {Object=} opt_context\n * @param {!{\n *   disallowCustom,\n *   allowFullscreen,\n * }=} opt_options Options for the created iframe.\n * @return {!HTMLIFrameElement} The iframe.\n */\nexport function getIframe(\n  parentWindow,\n  parentElement,\n  opt_type,\n  opt_context,\n  {disallowCustom, allowFullscreen} = {}\n) {\n  // Check that the parentElement is already in DOM. This code uses a new and\n  // fast `isConnected` API and thus only used when it's available.\n  devAssert(\n    parentElement['isConnected'] === undefined ||\n      parentElement['isConnected'] === true,\n    'Parent element must be in DOM'\n  );\n  const attributes = getFrameAttributes(\n    parentWindow,\n    parentElement,\n    opt_type,\n    opt_context\n  );\n  const iframe = /** @type {!HTMLIFrameElement} */ (parentWindow.document.createElement(\n    'iframe'\n  ));\n\n  if (!count[attributes['type']]) {\n    count[attributes['type']] = 0;\n  }\n  count[attributes['type']] += 1;\n\n  const baseUrl = getBootstrapBaseUrl(parentWindow, undefined, disallowCustom);\n  const host = parseUrlDeprecated(baseUrl).hostname;\n  // This name attribute may be overwritten if this frame is chosen to\n  // be the master frame. That is ok, as we will read the name off\n  // for our uses before that would occur.\n  // @see https://github.com/ampproject/amphtml/blob/master/3p/integration.js\n  const name = JSON.stringify(\n    dict({\n      'host': host,\n      'type': attributes['type'],\n      // https://github.com/ampproject/amphtml/pull/2955\n      'count': count[attributes['type']],\n      'attributes': attributes,\n    })\n  );\n\n  iframe.src = baseUrl;\n  iframe.ampLocation = parseUrlDeprecated(baseUrl);\n  iframe.name = name;\n  // Add the check before assigning to prevent IE throw Invalid argument error\n  if (attributes['width']) {\n    iframe.width = attributes['width'];\n  }\n  if (attributes['height']) {\n    iframe.height = attributes['height'];\n  }\n  if (attributes['title']) {\n    iframe.title = attributes['title'];\n  }\n  if (allowFullscreen) {\n    iframe.setAttribute('allowfullscreen', 'true');\n  }\n  iframe.setAttribute('scrolling', 'no');\n  setStyle(iframe, 'border', 'none');\n  /** @this {!Element} */\n  iframe.onload = function() {\n    // Chrome does not reflect the iframe readystate.\n    this.readyState = 'complete';\n  };\n  // Block synchronous XHR in ad. These are very rare, but super bad for UX\n  // as they block the UI thread for the arbitrary amount of time until the\n  // request completes.\n  iframe.setAttribute('allow', \"sync-xhr 'none';\");\n  const excludeFromSandbox = ['facebook'];\n  if (!excludeFromSandbox.includes(opt_type)) {\n    applySandbox(iframe);\n  }\n  iframe.setAttribute(\n    'data-amp-3p-sentinel',\n    attributes['_context']['sentinel']\n  );\n  return iframe;\n}\n\n/**\n * Copies data- attributes from the element into the attributes object.\n * Removes the data- from the name and capitalizes after -. If there\n * is an attribute called json, parses the JSON and adds it to the\n * attributes.\n * @param {!Element} element\n * @param {!JsonObject} attributes The destination.\n * visibleForTesting\n */\nexport function addDataAndJsonAttributes_(element, attributes) {\n  const {dataset} = element;\n  for (const name in dataset) {\n    // data-vars- is reserved for amp-analytics\n    // see https://github.com/ampproject/amphtml/blob/master/extensions/amp-analytics/analytics-vars.md#variables-as-data-attribute\n    if (!startsWith(name, 'vars')) {\n      attributes[name] = dataset[name];\n    }\n  }\n  const json = element.getAttribute('json');\n  if (json) {\n    const obj = tryParseJson(json);\n    if (obj === undefined) {\n      throw user().createError(\n        'Error parsing JSON in json attribute in element %s',\n        element\n      );\n    }\n    for (const key in obj) {\n      attributes[key] = obj[key];\n    }\n  }\n}\n\n/**\n * Preloads URLs related to the bootstrap iframe.\n * @param {!Window} win\n * @param {!./preconnect.Preconnect} preconnect\n * @param {boolean=} opt_disallowCustom whether 3p url should not use meta tag.\n */\nexport function preloadBootstrap(win, preconnect, opt_disallowCustom) {\n  const url = getBootstrapBaseUrl(win, undefined, opt_disallowCustom);\n  preconnect.preload(url, 'document');\n\n  // While the URL may point to a custom domain, this URL will always be\n  // fetched by it.\n  const scriptUrl = getMode().localDev\n    ? getAdsLocalhost(win) + '/dist.3p/current/integration.js'\n    : `${urls.thirdParty}/${internalRuntimeVersion()}/f.js`;\n  preconnect.preload(scriptUrl, 'script');\n}\n\n/**\n * Returns the base URL for 3p bootstrap iframes.\n * @param {!Window} parentWindow\n * @param {boolean=} opt_strictForUnitTest\n * @param {boolean=} opt_disallowCustom whether 3p url should not use meta tag.\n * @return {string}\n * @visibleForTesting\n */\nexport function getBootstrapBaseUrl(\n  parentWindow,\n  opt_strictForUnitTest,\n  opt_disallowCustom\n) {\n  const customBootstrapBaseUrl = opt_disallowCustom\n    ? null\n    : getCustomBootstrapBaseUrl(parentWindow, opt_strictForUnitTest);\n  return customBootstrapBaseUrl || getDefaultBootstrapBaseUrl(parentWindow);\n}\n\n/**\n * @param {string} url\n */\nexport function setDefaultBootstrapBaseUrlForTesting(url) {\n  overrideBootstrapBaseUrl = url;\n}\n\n/**\n * @param {*} win\n */\nexport function resetBootstrapBaseUrlForTesting(win) {\n  win.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN = undefined;\n}\n\n/**\n * Returns the default base URL for 3p bootstrap iframes.\n * @param {!Window} parentWindow\n * @param {string=} opt_srcFileBasename\n * @return {string}\n */\nexport function getDefaultBootstrapBaseUrl(parentWindow, opt_srcFileBasename) {\n  const srcFileBasename = opt_srcFileBasename || 'frame';\n  if (getMode().localDev || getMode().test) {\n    return getDevelopmentBootstrapBaseUrl(parentWindow, srcFileBasename);\n  }\n  // Ensure same sub-domain is used despite potentially different file.\n  parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN =\n    parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN ||\n    getSubDomain(parentWindow);\n  return (\n    'https://' +\n    parentWindow.__AMP_DEFAULT_BOOTSTRAP_SUBDOMAIN +\n    `.${urls.thirdPartyFrameHost}/${internalRuntimeVersion()}/` +\n    `${srcFileBasename}.html`\n  );\n}\n\n/**\n * Function to return the development boostrap base URL\n * @param {!Window} parentWindow\n * @param {string} srcFileBasename\n * @return {string}\n */\nexport function getDevelopmentBootstrapBaseUrl(parentWindow, srcFileBasename) {\n  return (\n    overrideBootstrapBaseUrl ||\n    getAdsLocalhost(parentWindow) +\n      '/dist.3p/' +\n      (getMode().minified\n        ? `${internalRuntimeVersion()}/${srcFileBasename}`\n        : `current/${srcFileBasename}.max`) +\n      '.html'\n  );\n}\n\n/**\n * @param {!Window} win\n * @return {string}\n */\nfunction getAdsLocalhost(win) {\n  let adsUrl = urls.thirdParty; // local dev with a non-localhost server\n  if (adsUrl == 'https://3p.ampproject.net') {\n    adsUrl = 'http://ads.localhost'; // local dev with a localhost server\n  }\n  return adsUrl + ':' + (win.location.port || win.parent.location.port);\n}\n\n/**\n * Sub domain on which the 3p iframe will be hosted.\n * Because we only calculate the URL once per page, this function is only\n * called once and hence all frames on a page use the same URL.\n * @param {!Window} win\n * @return {string}\n * @visibleForTesting\n */\nexport function getSubDomain(win) {\n  return 'd-' + getRandom(win);\n}\n\n/**\n * Generates a random non-negative integer.\n * @param {!Window} win\n * @return {string}\n */\nexport function getRandom(win) {\n  let rand;\n  if (win.crypto && win.crypto.getRandomValues) {\n    // By default use 2 32 bit integers.\n    const uint32array = new Uint32Array(2);\n    win.crypto.getRandomValues(uint32array);\n    rand = String(uint32array[0]) + uint32array[1];\n  } else {\n    // Fall back to Math.random.\n    rand = String(win.Math.random()).substr(2) + '0';\n  }\n  return rand;\n}\n\n/**\n * Returns the custom base URL for 3p bootstrap iframes if it exists.\n * Otherwise null.\n * @param {!Window} parentWindow\n * @param {boolean=} opt_strictForUnitTest\n * @return {?string}\n */\nfunction getCustomBootstrapBaseUrl(parentWindow, opt_strictForUnitTest) {\n  const meta = parentWindow.document.querySelector(\n    'meta[name=\"amp-3p-iframe-src\"]'\n  );\n  if (!meta) {\n    return null;\n  }\n  const url = assertHttpsUrl(meta.getAttribute('content'), meta);\n  userAssert(\n    url.indexOf('?') == -1,\n    '3p iframe url must not include query string %s in element %s.',\n    url,\n    meta\n  );\n  // This is not a security primitive, we just don't want this to happen in\n  // practice. People could still redirect to the same origin, but they cannot\n  // redirect to the proxy origin which is the important one.\n  const parsed = parseUrlDeprecated(url);\n  userAssert(\n    (parsed.hostname == 'localhost' && !opt_strictForUnitTest) ||\n      parsed.origin != parseUrlDeprecated(parentWindow.location.href).origin,\n    '3p iframe url must not be on the same origin as the current document ' +\n      '%s (%s) in element %s. See https://github.com/ampproject/amphtml' +\n      '/blob/master/spec/amp-iframe-origin-policy.md for details.',\n    url,\n    parsed.origin,\n    meta\n  );\n  return `${url}?${internalRuntimeVersion()}`;\n}\n\n/**\n * Applies a sandbox to the iframe, if the required flags can be allowed.\n * @param {!Element} iframe\n * @visibleForTesting\n */\nexport function applySandbox(iframe) {\n  if (!iframe.sandbox || !iframe.sandbox.supports) {\n    return; // Can't feature detect support\n  }\n  // If these flags are not supported by the UA we don't apply any\n  // sandbox.\n  const requiredFlags = [\n    // This only allows navigation when user interacts and thus prevents\n    // ads from auto navigating the user.\n    'allow-top-navigation-by-user-activation',\n    // Crucial because otherwise even target=_blank opened links are\n    // still sandboxed which they may not expect.\n    'allow-popups-to-escape-sandbox',\n  ];\n  // These flags are not feature detected. Put stuff here where either\n  // they have always been supported or support is not crucial.\n  const otherFlags = [\n    'allow-forms',\n    // We should consider turning this off! But since the top navigation\n    // issue is the big one, we'll leave this allowed for now.\n    'allow-modals',\n    // Give access to raw mouse movements.\n    'allow-pointer-lock',\n    // This remains subject to popup blocking, it just makes it supported\n    // at all.\n    'allow-popups',\n    // This applies inside the iframe and is crucial to not break the web.\n    'allow-same-origin',\n    'allow-scripts',\n  ];\n  // Not allowed\n  // - allow-top-navigation\n  // - allow-orientation-lock\n  // - allow-pointer-lock\n  // - allow-presentation\n  for (let i = 0; i < requiredFlags.length; i++) {\n    const flag = requiredFlags[i];\n    if (!iframe.sandbox.supports(flag)) {\n      dev().info(TAG, \"Iframe doesn't support %s\", flag);\n      return;\n    }\n  }\n  iframe.sandbox = requiredFlags.join(' ') + ' ' + otherFlags.join(' ');\n}\n\n/**\n * Returns a randomized sentinel value for 3p iframes.\n * The format is \"%d-%d\" with the first value being the depth of current\n * window in the window hierarchy and the second a random integer.\n * @param {!Window} parentWindow\n * @return {string}\n * @visibleForTesting\n */\nexport function generateSentinel(parentWindow) {\n  let windowDepth = 0;\n  for (let win = parentWindow; win && win != win.parent; win = win.parent) {\n    windowDepth++;\n  }\n  return String(windowDepth) + '-' + getRandom(parentWindow);\n}\n\n/**\n * Resets the count of each 3p frame type\n * @visibleForTesting\n */\nexport function resetCountForTesting() {\n  count = {};\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Key string in an action arguments map for an unparsed object literal string.\n *\n * E.g. for the action in <p on=\"tap:AMP.setState({foo: 'bar'})\",\n * then `args[RAW_OBJECT_ARGS_KEY]` is the string \"{foo: 'bar'}\".\n *\n * The action service delegates parsing of object literals to the corresponding\n * extension (in the example above, amp-bind).\n *\n * @see ./service/action-impl.ActionInfoDef\n * @const {string}\n */\nexport const RAW_OBJECT_ARGS_KEY = '__AMP_OBJECT_STRING__';\n\n/** @const {string} Identifier for an element's default action. */\nexport const DEFAULT_ACTION = 'activate';\n\n/**\n * Trust level of an action.\n *\n * Corresponds to degree of user intent, i.e. events triggered with strong\n * user intent have high trust.\n *\n * @enum {number}\n */\nexport const ActionTrust = {\n  LOW: 1,\n  HIGH: 100,\n};\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {adConfig} from '../ads/_config';\nimport {dev} from '../src/log';\n\n/**\n * @param {AMP.BaseElement} adElement\n * @return {!Promise<string|undefined>} A promise for a CID or undefined if\n *     - the ad network does not request one or\n *     - `amp-analytics` which provides the CID service was not installed.\n */\nexport function getAdCid(adElement) {\n  const config = adConfig[adElement.element.getAttribute('type')];\n  if (!config || !config['clientIdScope']) {\n    return Promise.resolve();\n  }\n  return getOrCreateAdCid(\n    adElement.getAmpDoc(),\n    config['clientIdScope'],\n    config['clientIdCookieName']\n  );\n}\n\n/**\n * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n * @param {string} clientIdScope\n * @param {string=} opt_clientIdCookieName\n * @param {number=} opt_timeout\n * @return {!Promise<string|undefined>} A promise for a CID or undefined.\n */\nexport function getOrCreateAdCid(\n  ampDoc,\n  clientIdScope,\n  opt_clientIdCookieName,\n  opt_timeout\n) {\n  const timeout =\n    isNaN(opt_timeout) || opt_timeout == null ? 1000 : opt_timeout;\n  const cidPromise = Services.cidForDoc(ampDoc).then(cidService => {\n    if (!cidService) {\n      return;\n    }\n    return cidService\n      .get(\n        {\n          scope: dev().assertString(clientIdScope),\n          createCookieIfNotPresent: true,\n          cookieName: opt_clientIdCookieName,\n        },\n        Promise.resolve(undefined)\n      )\n      .catch(error => {\n        // Not getting a CID is not fatal.\n        dev().error('AD-CID', error);\n        return undefined;\n      });\n  });\n  // The CID should never be crucial for an ad. If it does not come within\n  // 1 second, assume it will never arrive.\n  return Services.timerFor(ampDoc.win)\n    .timeoutPromise(timeout, cidPromise, 'cid timeout')\n    .catch(error => {\n      // Timeout is not fatal.\n      dev().warn('AD-CID', error);\n      return undefined;\n    });\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {computedStyle} from './style';\nimport {dev} from './log';\nimport {getParentWindowFrameElement} from './service';\n\nconst AD_CONTAINER_PROP = '__AMP__AD_CONTAINER';\n\n/**\n * Tags that are allowed to have fixed positioning\n * @const {!Object<string, boolean>}\n */\nconst CONTAINERS = {\n  'AMP-FX-FLYING-CARPET': true,\n  'AMP-LIGHTBOX': true,\n  'AMP-STICKY-AD': true,\n  'AMP-LIGHTBOX-GALLERY': true,\n};\n\n/**\n * Determines if an element is fixed-positioned.\n * OK to use, because it's only called from onLayoutMeasure\n * @param {!Element} el\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isPositionFixed(el, win) {\n  const {position} = computedStyle(win, el);\n  // We consider sticky positions as fixed, since they can be fixed.\n  return position == 'fixed' || position == 'sticky';\n}\n\n/**\n * @param {!Element} element\n * @param {!Window} win\n * @return {boolean} whether the element position is allowed. If the element\n * belongs to CONTAINERS, it is allowed to be position fixed.\n * If the element has a position fixed ancestor, it is not allowed.\n * This should only be called when a layout on the page was just forced\n * anyway.\n */\nexport function isAdPositionAllowed(element, win) {\n  let hasFixedAncestor = false;\n  let containers = 0;\n  let el = element;\n  do {\n    if (CONTAINERS[el.tagName]) {\n      // The containers must not themselves be contained in a fixed-position\n      // element. Continue the search.\n      containers++;\n      hasFixedAncestor = false;\n    } else if (isPositionFixed(dev().assertElement(el), win)) {\n      // Because certain blessed elements may contain a position fixed\n      // container (which contain an ad), we continue to search the\n      // ancestry tree.\n      hasFixedAncestor = true;\n    }\n    el = el.parentElement;\n  } while (el && el.tagName != 'BODY');\n  return !hasFixedAncestor && containers <= 1;\n}\n\n/**\n * Returns the blessed container element tagName if the ad is contained by one.\n * This is called during layout measure.\n * @param {!Element} element\n * @return {?string}\n */\nexport function getAdContainer(element) {\n  if (element[AD_CONTAINER_PROP] === undefined) {\n    let el = element.parentElement;\n    while (el && el.tagName != 'BODY') {\n      if (CONTAINERS[el.tagName]) {\n        return (element[AD_CONTAINER_PROP] = el.tagName);\n      }\n      el = el.parentElement;\n    }\n    element[AD_CONTAINER_PROP] = null;\n  }\n  return element[AD_CONTAINER_PROP];\n}\n\n/**\n * Gets the resource ID of the amp-ad element containing the passed node.\n * If there is no containing amp-ad tag, then null will be returned.\n * TODO(jonkeller): Investigate whether non-A4A use case is needed. Issue 11436\n * @param {!Element} node\n * @param {!Window} topWin\n * @return {?string}\n */\nexport function getAmpAdResourceId(node, topWin) {\n  try {\n    const frameParent = getParentWindowFrameElement(node, topWin).parentElement;\n    if (frameParent.nodeName == 'AMP-AD') {\n      return String(frameParent.getResourceId());\n    }\n  } catch (e) {}\n  // Whether we entered the catch above (e.g. due to attempt to access\n  // across xdomain boundary), or failed to enter the if further above, the\n  // node is not within a friendly amp-ad tag. So, there is no amp-ad\n  // resource ID. How to handle that is up to the caller, but see TODO above.\n  return null;\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Common AMP events.\n * @enum {string}\n */\nexport const AmpEvents = {\n  DOM_UPDATE: 'amp:dom-update',\n  FORM_DIRTINESS_CHANGE: 'amp:form-dirtiness-change',\n  FORM_VALUE_CHANGE: 'amp:form-value-change',\n  VISIBILITY_CHANGE: 'amp:visibilitychange', // https://github.com/ampproject/amphtml/blob/master/ads/README.md#page-visibility\n  // The following codes are only used for testing.\n  // TODO(choumx): Move these to a separate enum so they can be DCE'd.\n  ATTACHED: 'amp:attached',\n  STUBBED: 'amp:stubbed',\n  LOAD_START: 'amp:load:start',\n  LOAD_END: 'amp:load:end',\n  ERROR: 'amp:error',\n  SIZE_CHANGED: 'amp:size-changed',\n};\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\n\n/**\n * Helper method to trigger analytics event if amp-analytics is available.\n * TODO: Do not expose this function\n * @param {!Element} target\n * @param {string} eventType\n * @param {!JsonObject=} opt_vars A map of vars and their values.\n */\nexport function triggerAnalyticsEvent(target, eventType, opt_vars) {\n  Services.analyticsForDocOrNull(target).then(analytics => {\n    if (!analytics) {\n      return;\n    }\n    analytics.triggerEventForTarget(target, eventType, opt_vars);\n  });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './utils/promise';\nimport {Services} from './services';\nimport {dev} from './log';\nimport {getCurve} from './curve';\n\nconst TAG_ = 'Animation';\n\nconst NOOP_CALLBACK = function() {};\n\n/**\n * The animation class allows construction of arbitrary animation processes.\n * The main method is \"add\" that adds a segment of animation at particular\n * time offset (delay) and duration. All animation segments are simply functions\n * of type Transition which are iterated from 0 to 1 in animation frames to\n * achieve the desired effect.\n */\nexport class Animation {\n  /**\n   * Creates and starts animation with a single segment. Returns AnimationPlayer\n   * object that can be used to monitor or control animation.\n   *\n   * @param {!Node} contextNode The context node.\n   * @param {!TransitionDef<?>} transition Transition to animate.\n   * @param {./time.timeDef} duration Duration in milliseconds.\n   * @param {(!./curve.CurveDef|string)=} opt_curve Optional curve to use for\n   *   animation. Default is the linear animation.\n   * @return {!AnimationPlayer}\n   */\n  static animate(contextNode, transition, duration, opt_curve) {\n    return new Animation(contextNode)\n      .setCurve(opt_curve)\n      .add(0, transition, 1)\n      .start(duration);\n  }\n\n  /**\n   * @param {!Node} contextNode\n   * @param {!./service/vsync-impl.Vsync=} opt_vsync\n   */\n  constructor(contextNode, opt_vsync) {\n    /** @private @const {!Node} */\n    this.contextNode_ = contextNode;\n\n    /** @private @const {!./service/vsync-impl.Vsync} */\n    this.vsync_ = opt_vsync || Services.vsyncFor(self);\n\n    /** @private {?./curve.CurveDef} */\n    this.curve_ = null;\n\n    /**\n     * @private @const {!Array<!SegmentDef>}\n     */\n    this.segments_ = [];\n  }\n\n  /**\n   * Sets the default curve for the animation. Each segment is allowed to have\n   * its own curve, but this curve will be used if a segment doesn't specify\n   * its own.\n   * @param {!./curve.CurveDef|string|undefined} curve\n   * @return {!Animation}\n   */\n  setCurve(curve) {\n    if (curve) {\n      this.curve_ = getCurve(curve);\n    }\n    return this;\n  }\n\n  /**\n   * Adds a segment to the animation. Each segment starts at offset (delay) and\n   * runs for a portion of the overall animation (duration). Note that both\n   * delay and duration and normtimeDef types which accept values from 0 to 1.\n   * Optionally, the time is pushed through a curve. If curve is not specified,\n   * the default animation curve will be used. The specified transition is\n   * animated over the specified duration from 0 to 1.\n   *\n   * @param {./time.normtimeDef} delay\n   * @param {!TransitionDef<?>} transition\n   * @param {./time.normtimeDef} duration\n   * @param {(!./curve.CurveDef|string)=} opt_curve\n   * @return {!Animation}\n   */\n  add(delay, transition, duration, opt_curve) {\n    this.segments_.push({\n      delay,\n      func: transition,\n      duration,\n      curve: getCurve(opt_curve),\n    });\n    return this;\n  }\n\n  /**\n   * Starts the animation and returns the AnimationPlayer object that can be\n   * used to monitor and control the animation.\n   *\n   * @param {./time.timeDef} duration Absolute time in milliseconds.\n   * @return {!AnimationPlayer}\n   */\n  start(duration) {\n    const player = new AnimationPlayer(\n      this.vsync_,\n      this.contextNode_,\n      this.segments_,\n      this.curve_,\n      duration\n    );\n    return player;\n  }\n}\n\n/**\n * AnimationPlayer allows tracking and monitoring of the running animation.\n * Most importantly it exposes methods \"then\" and \"thenAlways\" that have the\n * semantics of a Promise and signal when the animation completed or failed.\n * Additionally, it exposes the method \"halt\" which allows to stop/reset the\n * animation.\n * // TODO(@cramforce) Actually fully implement.\n * implements {IThenable}\n */\nclass AnimationPlayer {\n  /**\n   * @param {!./service/vsync-impl.Vsync} vsync\n   * @param {!Node} contextNode\n   * @param {!Array<!SegmentDef>} segments\n   * @param {?./curve.CurveDef} defaultCurve\n   * @param {./time.timeDef} duration\n   */\n  constructor(vsync, contextNode, segments, defaultCurve, duration) {\n    /** @private @const {!./service/vsync-impl.Vsync} */\n    this.vsync_ = vsync;\n\n    /** @private @const {!Node} */\n    this.contextNode_ = contextNode;\n\n    /** @private @const {!Array<!SegmentRuntimeDef>} */\n    this.segments_ = [];\n    for (let i = 0; i < segments.length; i++) {\n      const segment = segments[i];\n      this.segments_.push({\n        delay: segment.delay,\n        func: segment.func,\n        duration: segment.duration,\n        curve: segment.curve || defaultCurve,\n        started: false,\n        completed: false,\n      });\n    }\n\n    /** @private @const */\n    this.duration_ = duration;\n\n    /** @private {./time.timeDef} */\n    this.startTime_ = Date.now();\n\n    /** @private {./time.normtimeDef} */\n    // this.normLinearTime_ = 0;\n\n    /** @private {./time.normtimeDef} */\n    // this.normTime_ = 0;\n\n    /** @private {boolean} */\n    this.running_ = true;\n\n    /** @private {!Object<string, *>} */\n    this.state_ = {};\n\n    const deferred = new Deferred();\n\n    /** @const @private */\n    this.promise_ = deferred.promise;\n\n    /** @const @private */\n    this.resolve_ = deferred.resolve;\n\n    /** @const @private */\n    this.reject_ = deferred.reject;\n\n    /** @const */\n    this.task_ = this.vsync_.createAnimTask(this.contextNode_, {\n      mutate: this.stepMutate_.bind(this),\n    });\n\n    if (this.vsync_.canAnimate(this.contextNode_)) {\n      this.task_(this.state_);\n    } else {\n      dev().warn(TAG_, 'cannot animate');\n      this.complete_(/* success */ false, /* dir */ 0);\n    }\n  }\n\n  /**\n   * Chains to the animation's promise that will resolve when the animation has\n   * completed or will reject if animation has failed or was interrupted.\n   * @param {!Function=} opt_resolve\n   * @param {!Function=} opt_reject\n   * @return {!Promise}\n   */\n  then(opt_resolve, opt_reject) {\n    if (!opt_resolve && !opt_reject) {\n      return this.promise_;\n    }\n    return this.promise_.then(opt_resolve, opt_reject);\n  }\n\n  /**\n   * Callback for regardless whether the animation succeeds or fails.\n   * @param {!Function=} opt_callback\n   * @return {!Promise}\n   */\n  thenAlways(opt_callback) {\n    const callback = opt_callback || NOOP_CALLBACK;\n    return this.then(callback, callback);\n  }\n\n  /**\n   * Halts the animation. Depending on the opt_dir value, the following actions\n   * can be performed:\n   * 0: No action. The state will be as at the moment of halting (default)\n   * 1: Final state. Transitionable will be set to state = 1.\n   * -1: Reset state. Transitionable will be reset to state = 0.\n   * The animation's promise will be rejected since the transition has been\n   * interrupted.\n   * @param {number=} opt_dir\n   */\n  halt(opt_dir) {\n    this.complete_(/* success */ false, /* dir */ opt_dir || 0);\n  }\n\n  /**\n   * @param {boolean} success\n   * @param {number} dir\n   * @private\n   */\n  complete_(success, dir) {\n    if (!this.running_) {\n      return;\n    }\n    this.running_ = false;\n    if (dir != 0) {\n      // Sort in the completion order.\n      if (this.segments_.length > 1) {\n        this.segments_.sort((s1, s2) => {\n          return s1.delay + s1.duration - (s2.delay + s2.duration);\n        });\n      }\n      try {\n        if (dir > 0) {\n          // Natural order - all set to 1.\n          for (let i = 0; i < this.segments_.length; i++) {\n            this.segments_[i].func(1, true);\n          }\n        } else {\n          // Reverse order - all set to 0.\n          for (let i = this.segments_.length - 1; i >= 0; i--) {\n            this.segments_[i].func(0, false);\n          }\n        }\n      } catch (e) {\n        dev().error(TAG_, 'completion failed: ' + e, e);\n        success = false;\n      }\n    }\n    if (success) {\n      this.resolve_();\n    } else {\n      this.reject_();\n    }\n  }\n\n  /**\n   * @param {!Object<string, *>} unusedState\n   * @private\n   */\n  stepMutate_(unusedState) {\n    if (!this.running_) {\n      return;\n    }\n    const currentTime = Date.now();\n    const normLinearTime = Math.min(\n      (currentTime - this.startTime_) / this.duration_,\n      1\n    );\n\n    // Start segments due to be started\n    for (let i = 0; i < this.segments_.length; i++) {\n      const segment = this.segments_[i];\n      if (!segment.started && normLinearTime >= segment.delay) {\n        segment.started = true;\n      }\n    }\n\n    // Execute all pending segments.\n    for (let i = 0; i < this.segments_.length; i++) {\n      const segment = this.segments_[i];\n      if (!segment.started || segment.completed) {\n        continue;\n      }\n      this.mutateSegment_(segment, normLinearTime);\n    }\n\n    // Complete or start next cycle.\n    if (normLinearTime == 1) {\n      this.complete_(/* success */ true, /* dir */ 0);\n    } else {\n      if (this.vsync_.canAnimate(this.contextNode_)) {\n        this.task_(this.state_);\n      } else {\n        dev().warn(TAG_, 'cancel animation');\n        this.complete_(/* success */ false, /* dir */ 0);\n      }\n    }\n  }\n\n  /**\n   * @param {!SegmentRuntimeDef} segment\n   * @param {number} totalLinearTime\n   */\n  mutateSegment_(segment, totalLinearTime) {\n    let normLinearTime;\n    let normTime;\n    if (segment.duration > 0) {\n      normLinearTime = Math.min(\n        (totalLinearTime - segment.delay) / segment.duration,\n        1\n      );\n      normTime = normLinearTime;\n      if (segment.curve && normTime != 1) {\n        try {\n          normTime = segment.curve(normLinearTime);\n        } catch (e) {\n          dev().error(TAG_, 'step curve failed: ' + e, e);\n          this.complete_(/* success */ false, /* dir */ 0);\n          return;\n        }\n      }\n    } else {\n      normLinearTime = 1;\n      normTime = 1;\n    }\n    if (normLinearTime == 1) {\n      segment.completed = true;\n    }\n    try {\n      segment.func(normTime, segment.completed);\n    } catch (e) {\n      dev().error(TAG_, 'step mutate failed: ' + e, e);\n      this.complete_(/* success */ false, /* dir */ 0);\n      return;\n    }\n  }\n}\n\n/**\n * @typedef {{\n *   delay: ./time.normtimeDef,\n *   func: !TransitionDef,\n *   duration: ./time.normtimeDef,\n *   curve: ?./curve.CurveDef\n * }}\n */\nlet SegmentDef;\n\n/**\n * @typedef {{\n *   delay: ./time.normtimeDef,\n *   func: !TransitionDef,\n *   duration: ./time.normtimeDef,\n *   curve: ?./curve.CurveDef,\n *   started: boolean,\n *   completed: boolean\n * }}\n */\nlet SegmentRuntimeDef;\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ActionTrust, DEFAULT_ACTION} from './action-constants';\nimport {Layout, LayoutPriority} from './layout';\nimport {Services} from './services';\nimport {devAssert, user, userAssert} from './log';\nimport {getData, listen, loadPromise} from './event-helper';\nimport {getMode} from './mode';\nimport {isArray, toWin} from './types';\nimport {preconnectForElement} from './preconnect';\n\n/**\n * Base class for all custom element implementations. Instead of inheriting\n * from Element this class has an Element. Among other things this allows\n * switching the element implementation when going from a stub to the full\n * implementation.\n *\n * The base class implements a set of lifecycle methods that are called by\n * the runtime as appropriate. These are mostly based on the custom element\n * lifecycle (See\n * https://developers.google.com/web/fundamentals/getting-started/primers/customelements)\n * and adding AMP style late loading to the mix.\n *\n * The complete lifecycle of a custom DOM element is:\n *\n *           ||\n *           || createdCallback\n *           ||\n *           \\/\n *    State: <NOT BUILT> <NOT UPGRADED> <NOT ATTACHED>\n *           ||\n *           || upgrade\n *           ||\n *           \\/\n *    State: <NOT BUILT> <NOT ATTACHED>\n *           ||\n *           || firstAttachedCallback\n *           ||\n *           \\/\n *    State: <NOT BUILT>\n *           ||\n *           || buildCallback\n *           || !getPlaceholder() => createPlaceholderCallback\n *           || preconnectCallback may be called N times after this, but only\n *           || after the doc becomes visible.\n *           || pauseCallback may be called N times after this.\n *           || resumeCallback may be called N times after this.\n *           ||\n *           \\/\n *    State: <BUILT>\n *           ||\n *           || layoutCallback        <==\n *           || (firstLayoutCompleted)  ||\n *           ||                         ||\n *           \\/                         || isRelayoutNeeded?\n *    State: <LAID OUT>                 ||\n *           ||                         ||\n *           ||                 =========\n *           ||\n *           || viewportCallback\n *           || unlayoutCallback may be called N times after this.\n *           ||\n *           \\/\n *    State: <IN VIEWPORT>\n *\n * The preconnectCallback is called when the systems thinks it is good\n * to preconnect to hosts needed by an element. It will never be called\n * before buildCallback and it might be called multiple times including\n * after layoutCallback.\n *\n * The pauseCallback is called when when the document becomes inactive, e.g.\n * when the user swipes away from the document, or when the element is no\n * longer being displayed, e.g. when the carousel slide slides out of view.\n * In these situations, any actively playing media should pause.\n *\n * The resumeCallback is called when when the document becomes active again\n * after becoming inactive, e.g. when the user swipes away from the document\n * and swipes back. In these situations, any paused media may begin playing\n * again, if user interaction is not required.\n * TODO(jridgewell) slide slides into view\n *\n * The createPlaceholderCallback is called if AMP didn't detect a provided\n * placeholder for the element, subclasses can override this to build and\n * return a dynamically created placeholder that AMP would append to the\n * element.\n *\n * The unlayoutCallback is called when the document becomes inactive, e.g.\n * when the user swipes away from the document, or another tab is focused.\n * In these situations, expensive memory and CPU resources should be freed.\n *\n * Additionally whenever the dimensions of an element might have changed\n * AMP remeasures its dimensions and calls `onLayoutMeasure` on the\n * element instance. This can be used to do additional style calculations\n * without triggering style recalculations.\n *\n * When the dimensions of an element has changed, the 'onMeasureChanged'\n * callback is called.\n *\n * For more details, see {@link custom-element.js}.\n *\n * Each method is called exactly once and overriding them in subclasses\n * is optional.\n */\nexport class BaseElement {\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    /** @public @const {!Element} */\n    this.element = element;\n    /*\n    \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  /  ____|\n     \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n      \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n       \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n        \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n\n    Any private property for BaseElement should be declared in\n    build-system/externs/amp.multipass.extern.js. This is so closure compiler\n    doesn't reuse the same symbol it would use in the core compilation unit for\n    the private property in the extensions compilation unit's private\n    properties.\n    */\n\n    /** @package {!Layout} */\n    this.layout_ = Layout.NODISPLAY;\n\n    /** @package {number} */\n    this.layoutWidth_ = -1;\n\n    /** @package {boolean} */\n    this.inViewport_ = false;\n\n    /** @public @const {!Window} */\n    this.win = toWin(element.ownerDocument.defaultView);\n\n    /**\n     * Maps action name to struct containing the action handler and minimum\n     * trust required to invoke the handler.\n     * @private {?Object<string, {\n     *   handler: function(!./service/action-impl.ActionInvocation),\n     *   minTrust: ActionTrust,\n     * }>} */\n    this.actionMap_ = null;\n\n    /** @private {?string} */\n    this.defaultActionAlias_ = null;\n\n    /** @public {!./preconnect.Preconnect} */\n    this.preconnect = preconnectForElement(this.element);\n  }\n\n  /**\n   * The element's signal tracker.\n   * @return {!./utils/signals.Signals}\n   */\n  signals() {\n    return this.element.signals();\n  }\n\n  /**\n   * The element's default action alias.\n   * @return {?string}\n   */\n  getDefaultActionAlias() {\n    return this.defaultActionAlias_;\n  }\n\n  /**\n   * This is the priority of loading elements (layoutCallback). Used only to\n   * determine layout timing and preloading priority. Does not affect build time,\n   * etc.\n   *\n   * The lower the number, the higher the priority.\n   *\n   * The default priority for base elements is LayoutPriority.CONTENT.\n   * @return {number}\n   */\n  getLayoutPriority() {\n    return LayoutPriority.CONTENT;\n  }\n\n  /**\n   * Updates the priority of the resource. If there are tasks currently\n   * scheduled, their priority is updated as well.\n   *\n   * This method can be called any time when the new priority value is\n   * available. It's a restricted API and special review is required to\n   * allow individual extensions to request priority upgrade.\n   *\n   * @param {number} newLayoutPriority\n   * @restricted\n   */\n  updateLayoutPriority(newLayoutPriority) {\n    this.element\n      .getResources()\n      .updateLayoutPriority(this.element, newLayoutPriority);\n  }\n\n  /** @return {!Layout} */\n  getLayout() {\n    return this.layout_;\n  }\n\n  /**\n   * Returns a previously measured layout box adjusted to the viewport. This\n   * mainly affects fixed-position elements that are adjusted to be always\n   * relative to the document position in the viewport.\n   * @return {!./layout-rect.LayoutRectDef}\n   */\n  getLayoutBox() {\n    return this.element.getLayoutBox();\n  }\n\n  /**\n   * Returns a previously measured layout box relative to the page. The\n   * fixed-position elements are relative to the top of the document.\n   * @return {!./layout-rect.LayoutRectDef}\n   */\n  getPageLayoutBox() {\n    return this.element.getPageLayoutBox();\n  }\n\n  /**\n   * DO NOT CALL. Retained for backward compat during rollout.\n   * @public\n   * @return {!Window}\n   */\n  getWin() {\n    return this.win;\n  }\n\n  /**\n   * Returns the associated ampdoc. Only available when `buildCallback` and\n   * going forward. It throws an exception before `buildCallback`.\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  getAmpDoc() {\n    return this.element.getAmpDoc();\n  }\n\n  /**\n   * @public\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  getVsync() {\n    return Services.vsyncFor(this.win);\n  }\n\n  /**\n   * Returns the layout width for this element. A `-1` value indicates that the\n   * layout is not yet known. A `0` value indicates that the element is not\n   * visible.\n   * @return {number}\n   * @public\n   */\n  getLayoutWidth() {\n    return this.layoutWidth_;\n  }\n\n  /**\n   * Returns the consent policy id that this element should wait for before\n   * buildCallback.\n   * A `null` value indicates to not be blocked by consent.\n   * Subclasses may override.\n   * @return {?string}\n   */\n  getConsentPolicy() {\n    let policyId = null;\n    if (this.element.hasAttribute('data-block-on-consent')) {\n      policyId =\n        this.element.getAttribute('data-block-on-consent') || 'default';\n    }\n    return policyId;\n  }\n\n  /**\n   * Intended to be implemented by subclasses. Tests whether the element\n   * supports the specified layout. By default only Layout.NODISPLAY is\n   * supported.\n   * @param {!Layout} layout\n   * @return {boolean}\n   * @public\n   */\n  isLayoutSupported(layout) {\n    return layout == Layout.NODISPLAY;\n  }\n\n  /**\n   * Intended to be implemented by subclasses. Tests whether the element\n   * requires fixed positioning.\n   * @return {boolean}\n   * @public\n   */\n  isAlwaysFixed() {\n    return false;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isInViewport() {\n    return this.inViewport_;\n  }\n\n  /**\n   * This method is called when the element is added to DOM for the first time\n   * and before `buildCallback` to give the element a chance to redirect its\n   * implementation to another `BaseElement` implementation. The returned\n   * value can be either `null` or `undefined` to indicate that no redirection\n   * will take place; `BaseElement` instance to upgrade immediately; or a\n   * promise to upgrade with the resolved `BaseElement` instance.\n   *\n   * Notice that calls to `upgradeCallback` are not recursive. I.e. this\n   * callback will not be called on the returned instance again.\n   *\n   * @return {!BaseElement|!Promise<!BaseElement>|null}\n   */\n  upgradeCallback() {\n    // Subclasses may override.\n    return null;\n  }\n\n  /**\n   * Called when the element is first created. Note that for element created\n   * using createElement this may be before any children are added.\n   */\n  createdCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Override in subclass to adjust the element when it is being added to the\n   * DOM. Could e.g. be used to insert a fallback. Should not typically start\n   * loading a resource.\n   */\n  firstAttachedCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Override in subclass if the element needs to rebuilt its DOM content.\n   * Until the element has been rebuilt its content are not shown with an only\n   * exception of [placeholder] elements. From the moment the element is created\n   * and until the building phase is complete it will have \"amp-notbuilt\" CSS\n   * class set on it.\n   *\n   * This callback is executed early after the element has been attached to DOM.\n   *\n   * This callback can either immediately return or return a promise if the\n   * build steps are asynchronous.\n   *\n   * @return {!Promise|undefined}\n   */\n  buildCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Called by the framework to give the element a chance to preconnect to\n   * hosts and prefetch resources it is likely to need. May be called\n   * multiple times because connections can time out.\n   * @param {boolean=} opt_onLayout\n   */\n  preconnectCallback(opt_onLayout) {\n    // Subclasses may override.\n  }\n\n  /**\n   * Override in subclass to adjust the element when it is being removed from\n   * the DOM. Could e.g. be used to remove a listener.\n   */\n  detachedCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Subclasses can override this method to opt-in into being called to\n   * prerender when document itself is not yet visible (pre-render mode).\n   *\n   * The return value of this function is used to determine whether or not the\n   * element will be built _and_ laid out during prerender mode. Therefore, any\n   * changes to the return value _after_ buildCallback() will have no affect.\n   * @return {boolean}\n   */\n  prerenderAllowed() {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to indicate that it is has\n   * render-blocking service.\n   *\n   * The return value of this function is used to determine if the element\n   * built _and_ laid out will be prioritized.\n   * @return {boolean}\n   */\n  isBuildRenderBlocking() {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to create a dynamic placeholder\n   * element and return it to be appended to the element. This will only\n   * be called if the element doesn't already have a placeholder.\n   * @return {?Element}\n   */\n  createPlaceholderCallback() {\n    return null;\n  }\n\n  /**\n   * Subclasses can override this method to provide a svg logo that will be\n   * displayed as the loader.\n   * @return {{\n   *  content: (!Element|undefined),\n   *  color: (string|undefined),\n   * }}\n   */\n  createLoaderLogoCallback() {\n    return {};\n  }\n\n  /**\n   * Subclasses can override this method to opt-out of rendering the element\n   * when it is not currently visible.\n   * Returning a boolean allows or prevents rendering outside the viewport at\n   * any distance, while returning a positive number allows rendering only when\n   * the element is within X viewports of the current viewport. Returning a\n   * zero causes the element to only render inside the viewport.\n   * @return {boolean|number}\n   */\n  renderOutsideViewport() {\n    // Inabox allow layout independent of viewport location.\n    return getMode(this.win).runtime == 'inabox' || 3;\n  }\n\n  /**\n   * Allows for rendering outside of the constraint set by renderOutsideViewport\n   * so long task scheduler is idle.  Integer values less than those returned\n   * by renderOutsideViewport have no effect.  Subclasses can override (default\n   * is disabled).\n   * @return {boolean|number}\n   */\n  idleRenderOutsideViewport() {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to opt-in into receiving additional\n   * {@link layoutCallback} calls. Note that this method is not consulted for\n   * the first layout given that each element must be laid out at least once.\n   * @return {boolean}\n   */\n  isRelayoutNeeded() {\n    return false;\n  }\n\n  /**\n   * Called when the element should perform layout. At this point the element\n   * should load/reload resources associated with it. This method is called\n   * by the runtime and cannot be called manually. Returns promise that will\n   * complete when loading is considered to be complete.\n   *\n   * The first layout call is always called. If the subclass is interested in\n   * receiving additional callbacks, it has to opt in to do so using\n   * {@link isRelayoutNeeded} method.\n   *\n   * @return {!Promise}\n   */\n  layoutCallback() {\n    return Promise.resolve();\n  }\n\n  /**\n   * Called to notify the element that the first layout has been successfully\n   * completed.\n   *\n   * The default behavior of this method is to hide the placeholder. However,\n   * a subclass may choose to hide placeholder earlier or not hide it at all.\n   *\n   * @public\n   */\n  firstLayoutCompleted() {\n    this.togglePlaceholder(false);\n  }\n\n  /**\n   * Instructs the resource that it has either entered or exited the visible\n   * viewport. Intended to be implemented by actual components.\n   * @param {boolean} unusedInViewport\n   */\n  viewportCallback(unusedInViewport) {}\n\n  /**\n   * Requests the element to stop its activity when the document goes into\n   * inactive state. The scope is up to the actual component. Among other\n   * things the active playback of video or audio content must be stopped.\n   */\n  pauseCallback() {}\n\n  /**\n   * Requests the element to resume its activity when the document returns from\n   * an inactive state. The scope is up to the actual component. Among other\n   * things the active playback of video or audio content may be resumed.\n   */\n  resumeCallback() {}\n\n  /**\n   * Requests the element to unload any expensive resources when the element\n   * goes into non-visible state. The scope is up to the actual component.\n   * The component must return `true` if it'd like to later receive\n   * {@link layoutCallback} in case document becomes active again.\n   *\n   * @return {boolean}\n   */\n  unlayoutCallback() {\n    return false;\n  }\n\n  /**\n   * Subclasses can override this method to opt-in into calling\n   * {@link unlayoutCallback} when paused.\n   * @return {boolean}\n   */\n  unlayoutOnPause() {\n    return false;\n  }\n\n  /**\n   * Whether the element needs to be reconstructed after it has been\n   * re-parented. Many elements cannot survive fully the reparenting and\n   * are better to be reconstructed from scratch.\n   *\n   * An example of an element that should be reconstructed in a iframe-based\n   * element. Reparenting such an element will cause the iframe to reload and\n   * will lost the previously established connection. It's safer to reconstruct\n   * such an element. An image or the other hand does not need to be\n   * reconstructed since image itself is not reloaded by the browser and thus\n   * there's no need to use additional resources for reconstruction.\n   *\n   * @return {boolean}\n   */\n  reconstructWhenReparented() {\n    return true;\n  }\n\n  /**\n   * Returns a promise that will resolve or fail based on the element's 'load'\n   * and 'error' events.\n   * @param {T} element\n   * @return {!Promise<T>}\n   * @template T\n   * @final\n   */\n  loadPromise(element) {\n    return loadPromise(element);\n  }\n\n  /** @private */\n  initActionMap_() {\n    if (!this.actionMap_) {\n      this.actionMap_ = this.win.Object.create(null);\n    }\n  }\n\n  /**\n   * Registers the action handler for the method with the specified name.\n   *\n   * The handler is only invoked by events with trust equal to or greater than\n   * `minTrust`. Otherwise, a user error is logged.\n   *\n   * @param {string} alias\n   * @param {function(!./service/action-impl.ActionInvocation)} handler\n   * @param {ActionTrust} minTrust\n   * @public\n   */\n  registerAction(alias, handler, minTrust = ActionTrust.HIGH) {\n    this.initActionMap_();\n    this.actionMap_[alias] = {handler, minTrust};\n  }\n\n  /**\n   * Registers the default action for this component.\n   * @param {function(!./service/action-impl.ActionInvocation)} handler\n   * @param {string=} alias\n   * @param {ActionTrust=} minTrust\n   * @public\n   */\n  registerDefaultAction(\n    handler,\n    alias = DEFAULT_ACTION,\n    minTrust = ActionTrust.HIGH\n  ) {\n    devAssert(\n      !this.defaultActionAlias_,\n      'Default action \"%s\" already registered.',\n      this.defaultActionAlias_\n    );\n    this.registerAction(alias, handler, minTrust);\n    this.defaultActionAlias_ = alias;\n  }\n\n  /**\n   * Requests the element to execute the specified method. If method must have\n   * been previously registered using {@link registerAction}, otherwise an\n   * error is thrown.\n   * @param {!./service/action-impl.ActionInvocation} invocation The invocation data.\n   * @param {boolean=} unusedDeferred Whether the invocation has had to wait any time\n   *   for the element to be resolved, upgraded and built.\n   * @final\n   * @package\n   * @return {*} TODO(#23582): Specify return type\n   */\n  executeAction(invocation, unusedDeferred) {\n    let {method} = invocation;\n    // If the default action has an alias, the handler will be stored under it.\n    if (method === DEFAULT_ACTION) {\n      method = this.defaultActionAlias_ || method;\n    }\n    this.initActionMap_();\n    const holder = this.actionMap_[method];\n    const {tagName} = this.element;\n    userAssert(holder, `Method not found: ${method} in ${tagName}`);\n    const {handler, minTrust} = holder;\n    if (invocation.satisfiesTrust(minTrust)) {\n      return handler(invocation);\n    }\n  }\n\n  /**\n   * Utility method that propagates attributes from this element\n   * to the given element.\n   * If `opt_removeMissingAttrs` is true, then also removes any specified\n   * attributes that are missing on this element from the target element.\n   * @param {string|!Array<string>} attributes\n   * @param {!Element} element\n   * @param {boolean=} opt_removeMissingAttrs\n   * @public @final\n   */\n  propagateAttributes(attributes, element, opt_removeMissingAttrs) {\n    attributes = isArray(attributes) ? attributes : [attributes];\n    for (let i = 0; i < attributes.length; i++) {\n      const attr = attributes[i];\n      const val = this.element.getAttribute(attr);\n      if (null !== val) {\n        element.setAttribute(attr, val);\n      } else if (opt_removeMissingAttrs) {\n        element.removeAttribute(attr);\n      }\n    }\n  }\n\n  /**\n   * Utility method that forwards the given list of non-bubbling events\n   * from the given element to this element as custom events with the same name.\n   * @param  {string|!Array<string>} events\n   * @param  {!Element} element\n   * @public @final\n   * @return {!UnlistenDef}\n   */\n  forwardEvents(events, element) {\n    const unlisteners = (isArray(events) ? events : [events]).map(eventType =>\n      listen(element, eventType, event => {\n        this.element.dispatchCustomEvent(eventType, getData(event) || {});\n      })\n    );\n\n    return () => unlisteners.forEach(unlisten => unlisten());\n  }\n\n  /**\n   * Returns an optional placeholder element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  getPlaceholder() {\n    return this.element.getPlaceholder();\n  }\n\n  /**\n   * Hides or shows the placeholder, if available.\n   * @param {boolean} state\n   * @public @final\n   */\n  togglePlaceholder(state) {\n    this.element.togglePlaceholder(state);\n  }\n\n  /**\n   * Returns an optional fallback element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  getFallback() {\n    return this.element.getFallback();\n  }\n\n  /**\n   * Hides or shows the fallback, if available. This function must only\n   * be called inside a mutate context.\n   * @param {boolean} state\n   * @public @final\n   */\n  toggleFallback(state) {\n    this.element.toggleFallback(state);\n  }\n\n  /**\n   * Hides or shows the loading indicator. This function must only\n   * be called inside a mutate context.\n   * @param {boolean} state\n   * @param {boolean=} opt_force\n   * @public @final\n   */\n  toggleLoading(state, opt_force) {\n    this.element.toggleLoading(state, {force: !!opt_force});\n  }\n\n  /**\n   * Returns whether the loading indicator is reused again after the first\n   * render.\n   * @return {boolean}\n   * @public\n   */\n  isLoadingReused() {\n    return false;\n  }\n\n  /**\n   * Returns an optional overflow element for this custom element.\n   * @return {?Element}\n   * @public @final\n   */\n  getOverflowElement() {\n    return this.element.getOverflowElement();\n  }\n\n  /**\n   * An implementation can call this method to signal to the element that\n   * it has started rendering.\n   */\n  renderStarted() {\n    this.element.renderStarted();\n  }\n\n  /**\n   * Returns the original nodes of the custom element without any service nodes\n   * that could have been added for markup. These nodes can include Text,\n   * Comment and other child nodes.\n   * @return {!Array<!Node>}\n   * @public @final\n   */\n  getRealChildNodes() {\n    return this.element.getRealChildNodes();\n  }\n\n  /**\n   * Returns the original children of the custom element without any service\n   * nodes that could have been added for markup.\n   * @return {!Array<!Element>}\n   * @public @final\n   */\n  getRealChildren() {\n    return this.element.getRealChildren();\n  }\n\n  /**\n   * Configures the supplied element to have a \"fill content\" layout. The\n   * exact interpretation of \"fill content\" depends on the element's layout.\n   *\n   * If `opt_replacedContent` is specified, it indicates whether the \"replaced\n   * content\" styling should be applied. Replaced content is not allowed to\n   * have its own paddings or border.\n   *\n   * @param {!Element} element\n   * @param {boolean=} opt_replacedContent\n   * @public @final\n   */\n  applyFillContent(element, opt_replacedContent) {\n    element.classList.add('i-amphtml-fill-content');\n    if (opt_replacedContent) {\n      element.classList.add('i-amphtml-replaced-content');\n    }\n  }\n\n  /**\n   * Returns the viewport within which the element operates.\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  getViewport() {\n    return Services.viewportForDoc(this.getAmpDoc());\n  }\n\n  /**\n   * Returns the layout rectangle used for when calculating this element's\n   * intersection with the viewport.\n   * @return {!./layout-rect.LayoutRectDef}\n   */\n  getIntersectionElementLayoutBox() {\n    return this.getLayoutBox();\n  }\n\n  /**\n   * Requests the runtime to update the height of this element to the specified\n   * value. The runtime will schedule this request and attempt to process it\n   * as soon as possible.\n   * @param {number} newHeight\n   * @public\n   */\n  changeHeight(newHeight) {\n    this.element\n      .getResources()\n      ./*OK*/ changeSize(this.element, newHeight, /* newWidth */ undefined);\n  }\n\n  /**\n   * Collapses the element, setting it to `display: none`, and notifies its\n   * owner (if there is one) through {@link collapsedCallback} that the element\n   * is no longer visible.\n   */\n  collapse() {\n    this.element.getResources().collapseElement(this.element);\n  }\n\n  /**\n   * Return a promise that request the runtime to collapse one element\n   * @return {!Promise}\n   */\n  attemptCollapse() {\n    return this.element.getResources().attemptCollapse(this.element);\n  }\n\n  /**\n   * Return a promise that requests the runtime to update\n   * the height of this element to the specified value.\n   * The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeHeight}, the runtime\n   * may refuse to make a change in which case it will show the element's\n   * overflow element if provided, which is supposed to provide the reader with\n   * the necessary user action. (The overflow element is shown only if the\n   * requested height is greater than 0.)\n   * The promise is resolved if the height is successfully updated.\n   * @param {number} newHeight\n   * @return {!Promise}\n   * @public\n   */\n  attemptChangeHeight(newHeight) {\n    return this.element\n      .getResources()\n      .attemptChangeSize(this.element, newHeight, /* newWidth */ undefined);\n  }\n\n  /**\n   * Return a promise that requests the runtime to update\n   * the size of this element to the specified value.\n   * The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeSize}, the runtime\n   * may refuse to make a change in which case it will show the element's\n   * overflow element if provided, which is supposed to provide the reader with\n   * the necessary user action. (The overflow element is shown only if the\n   * requested height is greater than 0.)\n   * The promise is resolved if the height is successfully updated.\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {?Event=} opt_event\n   * @return {!Promise}\n   * @public\n   */\n  attemptChangeSize(newHeight, newWidth, opt_event) {\n    return this.element\n      .getResources()\n      .attemptChangeSize(\n        this.element,\n        newHeight,\n        newWidth,\n        /* newMargin */ undefined,\n        opt_event\n      );\n  }\n\n  /**\n   * Runs the specified measure, which is called in the \"measure\" vsync phase.\n   * This is simply a proxy to the privileged vsync service.\n   *\n   * @param {function()} measurer\n   * @return {!Promise}\n   */\n  measureElement(measurer) {\n    return this.element.getResources().measureElement(measurer);\n  }\n\n  /**\n   * Runs the specified mutation on the element and ensures that remeasures and\n   * layouts are performed for the affected elements.\n   *\n   * This method should be called whenever a significant mutations are done\n   * on the DOM that could affect layout of elements inside this subtree or\n   * its siblings. The top-most affected element should be specified as the\n   * first argument to this method and all the mutation work should be done\n   * in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {function()} mutator\n   * @param {Element=} opt_element\n   * @return {!Promise}\n   */\n  mutateElement(mutator, opt_element) {\n    return this.measureMutateElement(null, mutator, opt_element);\n  }\n\n  /**\n   * Runs the specified measure, then runs the mutation on the element and\n   * ensures that remeasures and layouts are performed for the affected\n   * elements.\n   *\n   * This method should be called whenever a measure and significant mutations\n   * are done on the DOM that could affect layout of elements inside this\n   * subtree or its siblings. The top-most affected element should be specified\n   * as the first argument to this method and all the mutation work should be\n   * done in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {?function()} measurer\n   * @param {function()} mutator\n   * @param {Element=} opt_element\n   * @return {!Promise}\n   */\n  measureMutateElement(measurer, mutator, opt_element) {\n    return this.element\n      .getResources()\n      .measureMutateElement(opt_element || this.element, measurer, mutator);\n  }\n\n  /**\n   * Called every time an owned AmpElement collapses itself.\n   * See {@link collapse}.\n   * @param {!AmpElement} unusedElement Child element that was collapsed.\n   */\n  collapsedCallback(unusedElement) {\n    // Subclasses may override.\n  }\n\n  /**\n   * Expands the element, resetting its default display value, and notifies its\n   * owner (if there is one) through {@link expandedCallback} that the element\n   * is no longer visible.\n   */\n  expand() {\n    this.element.getResources().expandElement(this.element);\n  }\n\n  /**\n   * Called every time an owned AmpElement expands itself.\n   * See {@link expand}.\n   * @param {!AmpElement} unusedElement Child element that was expanded.\n   */\n  expandedCallback(unusedElement) {\n    // Subclasses may override.\n  }\n\n  /**\n   * Called when one or more attributes are mutated.\n   * Note:\n   * - Must be called inside a mutate context.\n   * - Boolean attributes have a value of `true` and `false` when\n   *       present and missing, respectively.\n   * @param {\n   *   !JsonObject<string, (null|boolean|string|number|Array|Object)>\n   * } unusedMutations\n   */\n  mutatedAttributesCallback(unusedMutations) {\n    // Subclasses may override.\n  }\n\n  /**\n   * Called when we just measured the layout rect of this element. Doing\n   * more expensive style reads should now be cheap.\n   * This may currently not work with extended elements. Please file\n   * an issue if that is required.\n   * @public\n   */\n  onLayoutMeasure() {}\n\n  /**\n   * Called only when the measurements of an amp-element changes. This\n   * would not trigger for every measurement invalidation caused by a mutation.\n   * @public\n   */\n  onMeasureChanged() {}\n\n  /**\n   * @return {./log.Log}\n   */\n  user() {\n    return user(this.element);\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {dev} from './log';\nimport {getData} from './event-helper';\nimport {getServiceForDoc, registerServiceBuilderForDoc} from './service';\nimport {isExperimentOn} from './experiments';\nimport {makeBodyVisibleRecovery} from './style-installer';\nimport PriorityQueue from './utils/priority-queue';\n\n/**\n * @const {string}\n */\nconst TAG = 'CHUNK';\n\n/**\n * @type {boolean}\n */\nlet deactivated = /nochunking=1/.test(self.location.hash);\n\n/**\n * @const {!Promise}\n */\nconst resolved = Promise.resolve();\n\n/**\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @return {!Chunks}\n * @private\n */\nfunction chunkServiceForDoc(elementOrAmpDoc) {\n  registerServiceBuilderForDoc(elementOrAmpDoc, 'chunk', Chunks);\n  return getServiceForDoc(elementOrAmpDoc, 'chunk');\n}\n\n/**\n * Run the given function. For visible documents the function will be\n * called in a micro task (Essentially ASAP). If the document is\n * not visible, tasks will yield to the event loop (to give the browser\n * time to do other things) and may even be further delayed until\n * there is time.\n *\n * @param {!Document|!./service/ampdoc-impl.AmpDoc} doc\n * @param {function(?IdleDeadline)} fn\n * @param {boolean=} opt_makesBodyVisible Pass true if this service makes\n *     the body visible. This is relevant because it may influence the\n *     task scheduling strategy.\n */\nexport function startupChunk(doc, fn, opt_makesBodyVisible) {\n  if (deactivated) {\n    resolved.then(fn);\n    return;\n  }\n  const service = chunkServiceForDoc(doc.documentElement || doc);\n  service.runForStartup(fn);\n  if (opt_makesBodyVisible) {\n    service.runForStartup(() => {\n      service.bodyIsVisible_ = true;\n    });\n  }\n}\n\n/**\n * Run the given function sometime in the future without blocking UI.\n *\n * Higher priority tasks are executed before lower priority tasks.\n * Tasks with the same priority are executed in FIFO order.\n *\n * Uses `requestIdleCallback` if available and passes the `IdleDeadline`\n * object to the function, which can be used to perform a variable amount\n * of work depending on the remaining amount of idle time.\n *\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {function(?IdleDeadline)} fn\n * @param {ChunkPriority} priority\n */\nexport function chunk(elementOrAmpDoc, fn, priority) {\n  if (deactivated) {\n    resolved.then(fn);\n    return;\n  }\n  const service = chunkServiceForDoc(elementOrAmpDoc);\n  service.run(fn, priority);\n}\n\n/**\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @return {!Chunks}\n */\nexport function chunkInstanceForTesting(elementOrAmpDoc) {\n  return chunkServiceForDoc(elementOrAmpDoc);\n}\n\n/**\n * Use a standard micro task for every invocation. This should only\n * be called from the AMP bootstrap script if it is known that\n * chunking makes no sense. In particular this is the case when\n * AMP runs in the `amp-shadow` multi document mode.\n */\nexport function deactivateChunking() {\n  deactivated = true;\n}\n\n/**\n * @visibleForTesting\n */\nexport function activateChunkingForTesting() {\n  deactivated = false;\n}\n\n/**\n * Runs all currently scheduled chunks.\n * Independent of errors it will unwind the queue. Will afterwards\n * throw the first encountered error.\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n */\nexport function runChunksForTesting(elementOrAmpDoc) {\n  const service = chunkInstanceForTesting(elementOrAmpDoc);\n  const errors = [];\n  while (true) {\n    try {\n      if (!service.execute_(/* idleDeadline */ null)) {\n        break;\n      }\n    } catch (e) {\n      errors.push(e);\n    }\n  }\n  if (errors.length) {\n    throw errors[0];\n  }\n}\n\n/**\n * The priority of a chunk task. Higher priority tasks have higher values.\n * @enum {number}\n */\nexport const ChunkPriority = {\n  HIGH: 20,\n  LOW: 10,\n  BACKGROUND: 0,\n};\n\n/** @enum {string} */\nconst TaskState = {\n  NOT_RUN: 'not_run',\n  RUN: 'run',\n};\n\n/**\n * A default chunkable task.\n * @private\n */\nclass Task {\n  /**\n   * @param {function(?IdleDeadline)} fn\n   */\n  constructor(fn) {\n    /** @public {TaskState} */\n    this.state = TaskState.NOT_RUN;\n\n    /** @private @const {!function(?IdleDeadline)} */\n    this.fn_ = fn;\n  }\n\n  /**\n   * Executes the wrapped function.\n   * @param {?IdleDeadline} idleDeadline\n   * @throws {Error}\n   * @protected\n   */\n  runTask_(idleDeadline) {\n    if (this.state == TaskState.RUN) {\n      return;\n    }\n    this.state = TaskState.RUN;\n    try {\n      this.fn_(idleDeadline);\n    } catch (e) {\n      this.onTaskError_(e);\n      throw e;\n    }\n  }\n\n  /**\n   * @return {string}\n   * @protected\n   */\n  getName_() {\n    return this.fn_.displayName || this.fn_.name;\n  }\n\n  /**\n   * Optional handling when a task run throws an error.\n   * @param {Error} unusedError\n   * @private\n   */\n  onTaskError_(unusedError) {\n    // By default, no-op.\n  }\n\n  /**\n   * Returns true if this task should be run without delay.\n   * @return {boolean}\n   * @protected\n   */\n  immediateTriggerCondition_() {\n    // By default, there are no immediate trigger conditions.\n    return false;\n  }\n\n  /**\n   * Returns true if this task should be scheduled using `requestIdleCallback`.\n   * Otherwise, task is scheduled as macro-task on next event loop.\n   * @return {boolean}\n   * @protected\n   */\n  useRequestIdleCallback_() {\n    // By default, never use requestIdleCallback.\n    return false;\n  }\n}\n\n/**\n * A task that's run as part of AMP's startup sequence.\n * @private\n */\nclass StartupTask extends Task {\n  /**\n   * @param {function(?IdleDeadline)} fn\n   * @param {!Window} win\n   * @param {!Chunks} chunks\n   */\n  constructor(fn, win, chunks) {\n    super(fn);\n\n    /** @private @const */\n    this.chunks_ = chunks;\n  }\n\n  /** @override */\n  onTaskError_(unusedError) {\n    // Startup tasks run early in init. All errors should show the doc.\n    makeBodyVisibleRecovery(self.document);\n  }\n\n  /** @override */\n  immediateTriggerCondition_() {\n    // Run in a micro task when the doc is visible. Otherwise, run after\n    // having yielded to the event queue once.\n    return this.isVisible_();\n  }\n\n  /** @override */\n  useRequestIdleCallback_() {\n    // We only start using requestIdleCallback when the core runtime has\n    // been initialized. Otherwise we risk starving ourselves\n    // before the render-critical work is done.\n    return this.chunks_.coreReady_;\n  }\n\n  /**\n   * @return {boolean}\n   * @private\n   */\n  isVisible_() {\n    return this.chunks_.ampdoc.isVisible();\n  }\n}\n\n/**\n * Handles queueing, scheduling and executing tasks.\n */\nclass Chunks {\n  /**\n   * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n   */\n  constructor(ampDoc) {\n    /** @protected @const {!./service/ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampDoc;\n    /** @private @const {!Window} */\n    this.win_ = ampDoc.win;\n    /** @private @const {!PriorityQueue<Task>} */\n    this.tasks_ = new PriorityQueue();\n    /** @private @const {function(?IdleDeadline)} */\n    this.boundExecute_ = this.execute_.bind(this);\n    /** @private {number} */\n    this.durationOfLastExecution_ = 0;\n    /** @private {boolean} */\n    this.macroAfterLongTask_ = isExperimentOn(\n      this.win_,\n      'macro-after-long-task'\n    );\n    /**\n     * Set to true if we scheduled a macro or micro task to execute the next\n     * task. If true, we don't schedule another one.\n     * Not set to true if we use rIC, because we always want to transition\n     * to immeditate invocation from that state.\n     * @private {boolean}\n     */\n    this.scheduledImmediateInvocation_ = false;\n    /** @private {boolean} Whether the document can actually be painted. */\n    this.bodyIsVisible_ = this.win_.document.documentElement.hasAttribute(\n      'i-amphtml-no-boilerplate'\n    );\n\n    this.win_.addEventListener('message', e => {\n      if (getData(e) == 'amp-macro-task') {\n        this.execute_(/* idleDeadline */ null);\n      }\n    });\n\n    /** @protected {boolean} */\n    this.coreReady_ = false;\n    Services.viewerPromiseForDoc(ampDoc).then(() => {\n      // Once the viewer has been resolved, most of core runtime has been\n      // initialized as well.\n      this.coreReady_ = true;\n    });\n\n    ampDoc.onVisibilityChanged(() => {\n      if (ampDoc.isVisible()) {\n        this.schedule_();\n      }\n    });\n  }\n\n  /**\n   * Run fn as a \"chunk\".\n   * @param {function(?IdleDeadline)} fn\n   * @param {number} priority\n   */\n  run(fn, priority) {\n    const t = new Task(fn);\n    this.enqueueTask_(t, priority);\n  }\n\n  /**\n   * Run a fn that's part of AMP's startup sequence as a \"chunk\".\n   * @param {function(?IdleDeadline)} fn\n   */\n  runForStartup(fn) {\n    const t = new StartupTask(fn, this.win_, this);\n    this.enqueueTask_(t, Number.POSITIVE_INFINITY);\n  }\n\n  /**\n   * Queues a task to be executed later with given priority.\n   * @param {!Task} task\n   * @param {number} priority\n   * @private\n   */\n  enqueueTask_(task, priority) {\n    this.tasks_.enqueue(task, priority);\n    this.schedule_();\n  }\n\n  /**\n   * Returns the next task that hasn't been run yet.\n   * If `opt_dequeue` is true, remove the returned task from the queue.\n   * @param {boolean=} opt_dequeue\n   * @return {?Task}\n   * @private\n   */\n  nextTask_(opt_dequeue) {\n    let t = this.tasks_.peek();\n    // Dequeue tasks until we find one that hasn't been run yet.\n    while (t && t.state !== TaskState.NOT_RUN) {\n      this.tasks_.dequeue();\n      t = this.tasks_.peek();\n    }\n    // If `opt_dequeue` is true, remove this task from the queue.\n    if (t && opt_dequeue) {\n      this.tasks_.dequeue();\n    }\n    return t;\n  }\n\n  /**\n   * Run a task.\n   * Schedule the next round if there are more tasks.\n   * @param {?IdleDeadline} idleDeadline\n   * @return {boolean} Whether anything was executed.\n   * @private\n   */\n  execute_(idleDeadline) {\n    const t = this.nextTask_(/* opt_dequeue */ true);\n    if (!t) {\n      this.scheduledImmediateInvocation_ = false;\n      this.durationOfLastExecution_ = 0;\n      return false;\n    }\n    let before;\n    try {\n      before = Date.now();\n      t.runTask_(idleDeadline);\n    } finally {\n      // We want to capture the time of the entire task duration including\n      // scheduled immediate (from resolved promises) micro tasks.\n      // Lacking a better way to do this we just scheduled 10 nested\n      // micro tasks.\n      resolved\n        .then()\n        .then()\n        .then()\n        .then()\n        .then()\n        .then()\n        .then()\n        .then()\n        .then(() => {\n          this.scheduledImmediateInvocation_ = false;\n          this.durationOfLastExecution_ += Date.now() - before;\n          dev().fine(\n            TAG,\n            t.getName_(),\n            'Chunk duration',\n            Date.now() - before,\n            this.durationOfLastExecution_\n          );\n\n          this.schedule_();\n        });\n    }\n    return true;\n  }\n\n  /**\n   * Calls `execute_()` asynchronously.\n   * @param {?IdleDeadline} idleDeadline\n   * @private\n   */\n  executeAsap_(idleDeadline) {\n    // If we've spent over 5 millseconds executing the\n    // last instruction yeild back to the main thread.\n    // 5 milliseconds is a magic number.\n    if (\n      this.macroAfterLongTask_ &&\n      this.bodyIsVisible_ &&\n      this.durationOfLastExecution_ > 5\n    ) {\n      this.durationOfLastExecution_ = 0;\n      this.requestMacroTask_();\n      return;\n    }\n    resolved.then(() => {\n      this.boundExecute_(idleDeadline);\n    });\n  }\n\n  /**\n   * Schedule running the next queued task.\n   * @private\n   */\n  schedule_() {\n    if (this.scheduledImmediateInvocation_) {\n      return;\n    }\n    const nextTask = this.nextTask_();\n    if (!nextTask) {\n      return;\n    }\n    if (nextTask.immediateTriggerCondition_()) {\n      this.scheduledImmediateInvocation_ = true;\n      this.executeAsap_(/* idleDeadline */ null);\n      return;\n    }\n    // If requestIdleCallback exists, schedule a task with it, but\n    // do not wait longer than two seconds.\n    if (nextTask.useRequestIdleCallback_() && this.win_.requestIdleCallback) {\n      onIdle(\n        this.win_,\n        // Wait until we have a budget of at least 15ms.\n        // 15ms is a magic number. Budgets are higher when the user\n        // is completely idle (around 40), but that occurs too\n        // rarely to be usable. 15ms budgets can happen during scrolling\n        // but only if the device is doing super, super well, and no\n        // real processing is done between frames.\n        15 /* minimumTimeRemaining */,\n        2000 /* timeout */,\n        this.boundExecute_\n      );\n      return;\n    }\n    this.requestMacroTask_();\n  }\n\n  /**\n   * Requests executing of a macro task. Yields to the event queue\n   * before executing the task.\n   * Places task on browser message queue which then respectively\n   * triggers dequeuing and execution of a chunk.\n   */\n  requestMacroTask_() {\n    // The message doesn't actually matter.\n    this.win_./*OK*/ postMessage('amp-macro-task', '*');\n  }\n}\n\n/**\n * Delays calling the given function until the browser is notifying us\n * about a certain minimum budget or the timeout is reached.\n * @param {!Window} win\n * @param {number} minimumTimeRemaining Minimum number of millis idle\n *     budget for callback to fire.\n * @param {number} timeout in millis for callback to fire.\n * @param {function(?IdleDeadline)} fn Callback.\n * @visibleForTesting\n */\nexport function onIdle(win, minimumTimeRemaining, timeout, fn) {\n  const startTime = Date.now();\n  /**\n   * @param {!IdleDeadline} info\n   */\n  function rIC(info) {\n    if (info.timeRemaining() < minimumTimeRemaining) {\n      const remainingTimeout = timeout - (Date.now() - startTime);\n      if (remainingTimeout <= 0 || info.didTimeout) {\n        dev().fine(TAG, 'Timed out', timeout, info.didTimeout);\n        fn(info);\n      } else {\n        dev().fine(\n          TAG,\n          'Rescheduling with',\n          remainingTimeout,\n          info.timeRemaining()\n        );\n        win.requestIdleCallback(rIC, {timeout: remainingTimeout});\n      }\n    } else {\n      dev().fine(TAG, 'Running idle callback with ', minimumTimeRemaining);\n      fn(info);\n    }\n  }\n  win.requestIdleCallback(rIC, {timeout});\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Commonly used signals across different elements and documents.\n * @enum {string}\n */\nexport const CommonSignals = {\n  /**\n   * The element has been upgraded from ElementStub to its real implementation.\n   */\n  UPGRADED: 'upgraded',\n\n  /**\n   * The element has been built.\n   */\n  BUILT: 'built',\n\n  /**\n   * The element has started loading.\n   * LOAD_START triggers at the start of the layoutCallback.\n   */\n  LOAD_START: 'load-start',\n\n  /**\n   * Rendering has been confirmed to have been started.\n   * It is a signal to indicate meaningful display (e.g. text could be displayed\n   * CSS is correctly installed/applied).\n   *\n   * Elements can optionally implement RENDER_START signal. (e.g. ad, shadowdoc)\n   * if it want to define its own meaningful display time and toggle visibility.\n   *\n   * Simpler elements's RENDER_START can be equal to the start of the\n   * buildCallback\n   */\n  RENDER_START: 'render-start',\n\n  /**\n   * The element has been loaded.\n   * LOAD_END triggers at the end of the layoutCallback.\n   *\n   */\n  LOAD_END: 'load-end',\n\n  /**\n   * The initial contents of an element/document/embed have been loaded.\n   * INI_LOAD is an optional signal, implemented by ads, story, and elements\n   * that consist of other resources.\n   * It instructs that all critical resources has been loaded, and can be used\n   * for more accurate visibility measurement.\n   * When an element doesn't consist multiple child resources, LOAD_END signal\n   * can be used to indicate resource load completion.\n   * Note: Based on the implementation, INI_LOAD can trigger before or after\n   * LOAD_END.\n   */\n  INI_LOAD: 'ini-load',\n\n  /**\n   * The element has been unlaid out.\n   */\n  UNLOAD: 'unload',\n};\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Allows for runtime configuration. Internally, the runtime should\n * use the src/config.js module for various constants. We can use the\n * AMP_CONFIG global to translate user-defined configurations to this\n * module.\n * @type {!Object<string, string>}\n */\nconst env = self.AMP_CONFIG || {};\n\nconst thirdPartyFrameRegex =\n  typeof env['thirdPartyFrameRegex'] == 'string'\n    ? new RegExp(env['thirdPartyFrameRegex'])\n    : env['thirdPartyFrameRegex'];\n\nconst cdnProxyRegex =\n  typeof env['cdnProxyRegex'] == 'string'\n    ? new RegExp(env['cdnProxyRegex'])\n    : env['cdnProxyRegex'];\n\n/** @type {!Object<string, string|boolean|RegExp|Array<RegExp>>} */\nexport const urls = {\n  thirdParty: env['thirdPartyUrl'] || 'https://3p.ampproject.net',\n  thirdPartyFrameHost: env['thirdPartyFrameHost'] || 'ampproject.net',\n  thirdPartyFrameRegex: thirdPartyFrameRegex || /^d-\\d+\\.ampproject\\.net$/,\n  cdn: env['cdnUrl'] || 'https://cdn.ampproject.org',\n  /* Note that cdnProxyRegex is only ever checked against origins\n   * (proto://host[:port]) so does not need to consider path\n   */\n  cdnProxyRegex:\n    cdnProxyRegex || /^https:\\/\\/([a-zA-Z0-9_-]+\\.)?cdn\\.ampproject\\.org$/,\n  localhostRegex: /^https?:\\/\\/localhost(:\\d+)?$/,\n  errorReporting:\n    env['errorReportingUrl'] || 'https://amp-error-reporting.appspot.com/r',\n  localDev: env['localDev'] || false,\n  /**\n   * These domains are trusted with more sensitive viewer operations such as\n   * propagating the referrer. If you believe your domain should be here,\n   * file the issue on GitHub to discuss. The process will be similar\n   * (but somewhat more stringent) to the one described in the [3p/README.md](\n   * https://github.com/ampproject/amphtml/blob/master/3p/README.md)\n   *\n   * {!Array<!RegExp>}\n   */\n  trustedViewerHosts: [\n    /(^|\\.)google\\.(com?|[a-z]{2}|com?\\.[a-z]{2}|cat)$/,\n    /(^|\\.)gmail\\.(com|dev)$/,\n  ],\n};\n\nexport const config = {\n  urls,\n};\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// This file will be imported by 3P scripts.\n\n/**\n * Possible consent policy state to proceed with.\n * @enum {number}\n */\nexport const CONSENT_POLICY_STATE = {\n  // Enum value has external dependency. Please do not change existing value.\n  // If new values are added, please notify the AMP for Ads team to assure\n  // correct Real Time Config behavior is maintained for Fast Fetch.\n  SUFFICIENT: 1,\n  INSUFFICIENT: 2,\n  UNKNOWN_NOT_REQUIRED: 3,\n  UNKNOWN: 4,\n};\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  CONSENT_POLICY_STATE, // eslint-disable-line no-unused-vars\n} from './consent-state';\nimport {Services} from './services';\nimport {user} from './log';\n\n/**\n * Returns a promise that resolve when all consent state the policy wait\n * for resolve. Or if consent service is not available.\n * @param {!Element|!ShadowRoot} element\n * @param {string=} policyId\n * @return {!Promise<?CONSENT_POLICY_STATE>}\n */\nexport function getConsentPolicyState(element, policyId = 'default') {\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    consentPolicy => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.whenPolicyResolved(/** @type {string} */ (policyId));\n    }\n  );\n}\n\n/**\n * Returns a promise that resolves to a sharedData retrieved from consent\n * remote endpoint.\n * @param {!Element|!ShadowRoot} element\n * @param {string} policyId\n * @return {!Promise<?Object>}\n */\nexport function getConsentPolicySharedData(element, policyId) {\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    consentPolicy => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.getMergedSharedData(\n        /** @type {string} */ (policyId)\n      );\n    }\n  );\n}\n\n/**\n * TODO(zhouyx): Combine with getConsentPolicyState and return a consentInfo\n * object.\n * @param {!Element|!ShadowRoot} element\n * @param {string} policyId\n * @return {!Promise<string>}\n */\nexport function getConsentPolicyInfo(element, policyId) {\n  // Return the stored consent string.\n  return Services.consentPolicyServiceForDocOrNull(element).then(\n    consentPolicy => {\n      if (!consentPolicy) {\n        return null;\n      }\n      return consentPolicy.getConsentStringInfo(\n        /** @type {string} */ (policyId)\n      );\n    }\n  );\n}\n\n/**\n * Determine if an element needs to be blocked by consent based on metaTags.\n * @param {*} element\n * @return {boolean}\n */\nexport function shouldBlockOnConsentByMeta(element) {\n  const ampdoc = element.getAmpDoc();\n  let content = Services.documentInfoForDoc(ampdoc).metaTags[\n    'amp-consent-blocking'\n  ];\n\n  if (!content) {\n    return false;\n  }\n\n  // validator enforce uniqueness of <meta name='amp-consent-blocking'>\n  // content will not be an array.\n  if (typeof content !== 'string') {\n    user().error(\n      'CONSENT',\n      'Invalid amp-consent-blocking value, ignore meta tag'\n    );\n    return false;\n  }\n\n  // Handles whitespace\n  content = content\n    .toUpperCase()\n    .replace(/\\s/g, '')\n    .split(',');\n\n  if (content.includes(element.tagName)) {\n    return true;\n  }\n  return false;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {endsWith} from './string';\nimport {\n  getSourceOrigin,\n  isProxyOrigin,\n  parseUrlDeprecated,\n  tryDecodeUriComponent,\n} from './url';\nimport {urls} from './config';\nimport {userAssert} from './log';\n\nconst TEST_COOKIE_NAME = '-test-amp-cookie-tmp';\n\n/** @enum {string} */\nexport const SameSite = {\n  LAX: 'Lax',\n  STRICT: 'Strict',\n  NONE: 'None',\n};\n\n/**\n * Returns the value of the cookie. The cookie access is restricted and must\n * go through the privacy review. Before using this method please file a\n * GitHub issue with \"Privacy Review\" label.\n *\n * Returns the cookie's value or `null`.\n *\n * @param {!Window} win\n * @param {string} name\n * @return {?string}\n */\nexport function getCookie(win, name) {\n  const cookieString = tryGetDocumentCookie_(win);\n  if (!cookieString) {\n    return null;\n  }\n  const cookies = cookieString.split(';');\n  for (let i = 0; i < cookies.length; i++) {\n    const cookie = cookies[i].trim();\n    const eq = cookie.indexOf('=');\n    if (eq == -1) {\n      continue;\n    }\n    if (tryDecodeUriComponent(cookie.substring(0, eq).trim()) == name) {\n      const value = cookie.substring(eq + 1).trim();\n      return tryDecodeUriComponent(value, value);\n    }\n  }\n  return null;\n}\n\n/**\n * This method should not be inlined to prevent TryCatch deoptimization.\n * @param {!Window} win\n * @return {string}\n * @noinline\n */\nfunction tryGetDocumentCookie_(win) {\n  try {\n    return win.document.cookie;\n  } catch (e) {\n    // Act as if no cookie is available. Exceptions can be thrown when\n    // AMP docs are opened on origins that do not allow setting\n    // cookies such as null origins.\n    return '';\n  }\n}\n\n/**\n * Sets the value of the cookie. The cookie access is restricted and must\n * go through the privacy review. Before using this method please file a\n * GitHub issue with \"Privacy Review\" label.\n *\n * @param {!Window} win\n * @param {string} name\n * @param {string} value\n * @param {time} expirationTime\n * @param {{\n *   highestAvailableDomain:(boolean|undefined),\n *   domain:(string|undefined),\n *   sameSite: (!SameSite|undefined),\n * }=} options\n *     - highestAvailableDomain: If true, set the cookie at the widest domain\n *       scope allowed by the browser. E.g. on example.com if we are currently\n *       on www.example.com.\n *     - domain: Explicit domain to set. domain overrides HigestAvailableDomain\n *     - allowOnProxyOrigin: Allow setting a cookie on the AMP Cache.\n *     - sameSite: The SameSite value to use when setting the cookie.\n */\nexport function setCookie(win, name, value, expirationTime, options = {}) {\n  checkOriginForSettingCookie(win, options, name);\n  let domain = undefined;\n  // Respect explicitly set domain over higestAvailabeDomain\n  if (options.domain) {\n    domain = options.domain;\n  } else if (options.highestAvailableDomain) {\n    domain = /** @type {string} */ (getHighestAvailableDomain(win));\n  }\n  trySetCookie(win, name, value, expirationTime, domain, options.sameSite);\n}\n\n/**\n * Attemp to find the HighestAvailableDomain on\n * @param {!Window} win\n * @return {?string}\n */\nexport function getHighestAvailableDomain(win) {\n  // <meta name='amp-cookie-scope'>. Need to respect the meta first.\n\n  // Note: The same logic applies to shadow docs. Where all shadow docs are\n  // considered to be in the same origin. And only the <meta> from\n  // shell will be respected. (Header from shadow doc will be removed)\n  const metaTag =\n    win.document.head &&\n    win.document.head.querySelector(\"meta[name='amp-cookie-scope']\");\n\n  if (metaTag) {\n    // The content value could be an empty string. Return null instead\n    const cookieScope = metaTag.getAttribute('content') || '';\n    // Verify the validness of the amp-cookie-scope meta value\n    const sourceOrigin = getSourceOrigin(win.location.href);\n    // Verify the meta tag content value is valid\n    if (endsWith(sourceOrigin, '.' + cookieScope)) {\n      return cookieScope;\n    } else {\n      // When the amp-cookie-scope value is invalid, fallback to the exact origin\n      // the document is contained in.\n      // sourceOrigin in the format of 'https://xxx or http://xxx'\n      return sourceOrigin.split('://')[1];\n    }\n  }\n\n  if (!isProxyOrigin(win.location.href)) {\n    const parts = win.location.hostname.split('.');\n    let domain = parts[parts.length - 1];\n    const testCookieName = getTempCookieName(win);\n    for (let i = parts.length - 2; i >= 0; i--) {\n      domain = parts[i] + '.' + domain;\n      // Try set a cookie for testing only, expire after 1 sec\n      trySetCookie(win, testCookieName, 'delete', Date.now() + 1000, domain);\n      if (getCookie(win, testCookieName) == 'delete') {\n        // Remove the cookie for testing\n        trySetCookie(win, testCookieName, 'delete', Date.now() - 1000, domain);\n        return domain;\n      }\n    }\n  }\n\n  // Proxy origin w/o <meta name='amp-cookie-scope>\n  // We cannot calculate the etld+1 without the public suffix list.\n  // Return null instead.\n  // Note: This should not affect cookie writing because we don't allow writing\n  // cookie to highestAvailableDomain on proxy origin\n  // In the case of link decoration on proxy origin,\n  // we expect the correct meta tag to be\n  // set by publisher or cache order for AMP runtime to find all subdomains.\n  return null;\n}\n\n/**\n * Attempt to set a cookie with the given params.\n *\n * @param {!Window} win\n * @param {string} name\n * @param {string} value\n * @param {time} expirationTime\n * @param {string|undefined} domain\n * @param {!SameSite=} sameSite\n */\nfunction trySetCookie(win, name, value, expirationTime, domain, sameSite) {\n  // We do not allow setting cookies on the domain that contains both\n  // the cdn. and www. hosts.\n  // Note: we need to allow cdn.ampproject.org in order to optin to experiments\n  if (domain == 'ampproject.org') {\n    // Actively delete them.\n    value = 'delete';\n    expirationTime = 0;\n  }\n  const cookie =\n    encodeURIComponent(name) +\n    '=' +\n    encodeURIComponent(value) +\n    '; path=/' +\n    (domain ? '; domain=' + domain : '') +\n    '; expires=' +\n    new Date(expirationTime).toUTCString() +\n    getSameSiteString(win, sameSite);\n  try {\n    win.document.cookie = cookie;\n  } catch (ignore) {\n    // Do not throw if setting the cookie failed Exceptions can be thrown\n    // when AMP docs are opened on origins that do not allow setting\n    // cookies such as null origins.\n  }\n}\n\n/**\n * Gets the cookie string to use for SameSite. This only sets the SameSite\n * value if specified, falling back to the browser default. The default value\n * is equivalent to SameSite.NONE, but is planned to be set to SameSite.LAX in\n * Chrome 80.\n *\n * Note: In Safari 12, if the value is set to SameSite.NONE, it is treated by\n * the browser as SameSite.STRICT.\n * @param {Window} win\n * @param {!SameSite|undefined} sameSite\n * @return {string} The string to use when setting the cookie.\n */\nfunction getSameSiteString(win, sameSite) {\n  if (!sameSite) {\n    return '';\n  }\n\n  return `; SameSite=${sameSite}`;\n}\n\n/**\n * Throws if a given cookie should not be set on the given origin.\n * This is a defense-in-depth. Callers should never run into this.\n *\n * @param {!Window} win\n * @param {!Object} options\n * @param {string} name For the error message.\n */\nfunction checkOriginForSettingCookie(win, options, name) {\n  if (options.allowOnProxyOrigin) {\n    userAssert(\n      !options.highestAvailableDomain,\n      'Could not support higestAvailable Domain on proxy origin, ' +\n        'specify domain explicitly'\n    );\n    return;\n  }\n  userAssert(\n    !isProxyOrigin(win.location.href),\n    `Should never attempt to set cookie on proxy origin: ${name}`\n  );\n  const current = parseUrlDeprecated(win.location.href).hostname.toLowerCase();\n  const proxy = parseUrlDeprecated(urls.cdn).hostname.toLowerCase();\n  userAssert(\n    !(current == proxy || endsWith(current, '.' + proxy)),\n    'Should never attempt to set cookie on proxy origin. (in depth check): ' +\n      name\n  );\n}\n\n/**\n * Return a temporary cookie name for testing only\n * @param {!Window} win\n * @return {string}\n */\nfunction getTempCookieName(win) {\n  let testCookieName = TEST_COOKIE_NAME;\n  const counter = 0;\n  while (getCookie(win, testCookieName)) {\n    // test cookie name conflict, append counter to test cookie name\n    testCookieName = TEST_COOKIE_NAME + counter;\n  }\n  return testCookieName;\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {cssEscape} from '../third_party/css-escape/css-escape';\nimport {devAssert} from './log';\n\n/**\n * Asserts that name is just an alphanumeric word, and does not contain\n * advanced CSS selector features like attributes, psuedo-classes, class names,\n * nor ids.\n * @param {string} name\n */\nexport function assertIsName(name) {\n  devAssert(/^[\\w-]+$/.test(name));\n}\n\n/**\n * @type {boolean|undefined}\n */\nlet scopeSelectorSupported;\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setScopeSelectorSupportedForTesting(val) {\n  scopeSelectorSupported = val;\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element} el\n * @return {boolean}\n */\nexport function isScopeSelectorSupported(el) {\n  if (scopeSelectorSupported !== undefined) {\n    return scopeSelectorSupported;\n  }\n\n  return (scopeSelectorSupported = testScopeSelector(el));\n}\n\n/**\n * Test that the :scope selector is supported and behaves correctly.\n * @param {!Element} el\n * @return {boolean}\n */\nfunction testScopeSelector(el) {\n  try {\n    const doc = el.ownerDocument;\n    const testElement = doc.createElement('div');\n    const testChild = doc.createElement('div');\n    testElement.appendChild(testChild);\n    // NOTE(cvializ, #12383): Firefox's implementation is incomplete,\n    // therefore we test actual functionality of`:scope` as well.\n    return testElement./*OK*/ querySelector(':scope div') === testChild;\n  } catch (e) {\n    return false;\n  }\n}\n\n/**\n * Prefixes a selector for ancestor selection. Splits in subselectors and\n * applies prefix to each.\n *\n * e.g.\n * ```\n *   prependSelectorsWith('div', '.i-amphtml-scoped');\n *   // => '.i-amphtml-scoped div'\n *   prependSelectorsWith('div, ul', ':scope');\n *   // => ':scope div, :scope ul'\n *   prependSelectorsWith('div, ul', 'article >');\n *   // => 'article > div, article > ul'\n * ```\n *\n * @param {string} selector\n * @param {string} distribute\n * @return {string}\n */\nexport function prependSelectorsWith(selector, distribute) {\n  return selector.replace(/^|,/g, `$&${distribute} `);\n}\n\n/**\n * Escapes an ident (ID or a class name) to be used as a CSS selector.\n *\n * See https://drafts.csswg.org/cssom/#serialize-an-identifier.\n *\n * @param {string} ident\n * @return {string}\n */\nexport function escapeCssSelectorIdent(ident) {\n  return cssEscape(ident);\n}\n\n/**\n * Escapes an ident in a way that can be used by :nth-child() psuedo-class.\n *\n * See https://github.com/w3c/csswg-drafts/issues/2306.\n *\n * @param {string|number} ident\n * @return {string}\n */\nexport function escapeCssSelectorNth(ident) {\n  const escaped = String(ident);\n  // Ensure it doesn't close the nth-child psuedo class.\n  devAssert(escaped.indexOf(')') === -1);\n  return escaped;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Imported just for the side effect of getting the `types` it exports into\n// the type system during compile time.\nimport './time';\n\n/**\n * A CurveDef is a function that returns a normtime value (0 to 1) for another\n * normtime value.\n * @typedef {function(./time.normtimeDef): ./time.normtimeDef}\n */\nexport let CurveDef;\n\n/**\n * Returns a cubic bezier curve.\n * @param {number} x1 X coordinate of the first control point.\n * @param {number} y1 Y coordinate of the first control point.\n * @param {number} x2 X coordinate of the second control point.\n * @param {number} y2 Y coordinate of the second control point.\n * @return {!CurveDef}\n */\nexport function bezierCurve(x1, y1, x2, y2) {\n  const bezier = new Bezier(0, 0, x1, y1, x2, y2, 1, 1);\n  return bezier.solveYValueFromXValue.bind(bezier);\n}\n\n/**\n * Thanks to\n * https://closure-library.googlecode.com/git-history/docs/local_closure_goog_math_bezier.js.source.html\n */\nclass Bezier {\n  /**\n   * @param {number} x0 X coordinate of the start point.\n   * @param {number} y0 Y coordinate of the start point.\n   * @param {number} x1 X coordinate of the first control point.\n   * @param {number} y1 Y coordinate of the first control point.\n   * @param {number} x2 X coordinate of the second control point.\n   * @param {number} y2 Y coordinate of the second control point.\n   * @param {number} x3 X coordinate of the end point.\n   * @param {number} y3 Y coordinate of the end point.\n   */\n  constructor(x0, y0, x1, y1, x2, y2, x3, y3) {\n    /**\n     * X coordinate of the first point.\n     * @type {number}\n     */\n    this.x0 = x0;\n\n    /**\n     * Y coordinate of the first point.\n     * @type {number}\n     */\n    this.y0 = y0;\n\n    /**\n     * X coordinate of the first control point.\n     * @type {number}\n     */\n    this.x1 = x1;\n\n    /**\n     * Y coordinate of the first control point.\n     * @type {number}\n     */\n    this.y1 = y1;\n\n    /**\n     * X coordinate of the second control point.\n     * @type {number}\n     */\n    this.x2 = x2;\n\n    /**\n     * Y coordinate of the second control point.\n     * @type {number}\n     */\n    this.y2 = y2;\n\n    /**\n     * X coordinate of the end point.\n     * @type {number}\n     */\n    this.x3 = x3;\n\n    /**\n     * Y coordinate of the end point.\n     * @type {number}\n     */\n    this.y3 = y3;\n  }\n\n  /**\n   * Computes the y coordinate of a point on the curve given its x coordinate.\n   * @param {number} xVal The x coordinate of the point on the curve.\n   * @return {number} The y coordinate of the point on the curve.\n   */\n  solveYValueFromXValue(xVal) {\n    return this.getPointY(this.solvePositionFromXValue(xVal));\n  }\n\n  /**\n   * Computes the position t of a point on the curve given its x coordinate.\n   * That is, for an input xVal, finds t s.t. getPointX(t) = xVal.\n   * As such, the following should always be true up to some small epsilon:\n   * t ~ solvePositionFromXValue(getPointX(t)) for t in [0, 1].\n   * @param {number} xVal The x coordinate of the point to find on the curve.\n   * @return {number} The position t.\n   */\n  solvePositionFromXValue(xVal) {\n    // Desired precision on the computation.\n    const epsilon = 1e-6;\n\n    // Initial estimate of t using linear interpolation.\n    let t = (xVal - this.x0) / (this.x3 - this.x0);\n    if (t <= 0) {\n      return 0;\n    } else if (t >= 1) {\n      return 1;\n    }\n\n    // Try gradient descent to solve for t. If it works, it is very fast.\n    let tMin = 0;\n    let tMax = 1;\n    let value = 0;\n    for (let i = 0; i < 8; i++) {\n      value = this.getPointX(t);\n      const derivative = (this.getPointX(t + epsilon) - value) / epsilon;\n      if (Math.abs(value - xVal) < epsilon) {\n        return t;\n      } else if (Math.abs(derivative) < epsilon) {\n        break;\n      } else {\n        if (value < xVal) {\n          tMin = t;\n        } else {\n          tMax = t;\n        }\n        t -= (value - xVal) / derivative;\n      }\n    }\n\n    // If the gradient descent got stuck in a local minimum, e.g. because\n    // the derivative was close to 0, use a Dichotomy refinement instead.\n    // We limit the number of iterations to 8.\n    for (let i = 0; Math.abs(value - xVal) > epsilon && i < 8; i++) {\n      if (value < xVal) {\n        tMin = t;\n        t = (t + tMax) / 2;\n      } else {\n        tMax = t;\n        t = (t + tMin) / 2;\n      }\n      value = this.getPointX(t);\n    }\n    return t;\n  }\n\n  /**\n   * Computes the curve's X coordinate at a point between 0 and 1.\n   * @param {number} t The point on the curve to find.\n   * @return {number} The computed coordinate.\n   */\n  getPointX(t) {\n    // Special case start and end.\n    if (t == 0) {\n      return this.x0;\n    } else if (t == 1) {\n      return this.x3;\n    }\n\n    // Step one - from 4 points to 3\n    let ix0 = this.lerp(this.x0, this.x1, t);\n    let ix1 = this.lerp(this.x1, this.x2, t);\n    const ix2 = this.lerp(this.x2, this.x3, t);\n\n    // Step two - from 3 points to 2\n    ix0 = this.lerp(ix0, ix1, t);\n    ix1 = this.lerp(ix1, ix2, t);\n\n    // Final step - last point\n    return this.lerp(ix0, ix1, t);\n  }\n\n  /**\n   * Computes the curve's Y coordinate at a point between 0 and 1.\n   * @param {number} t The point on the curve to find.\n   * @return {number} The computed coordinate.\n   */\n  getPointY(t) {\n    // Special case start and end.\n    if (t == 0) {\n      return this.y0;\n    } else if (t == 1) {\n      return this.y3;\n    }\n\n    // Step one - from 4 points to 3\n    let iy0 = this.lerp(this.y0, this.y1, t);\n    let iy1 = this.lerp(this.y1, this.y2, t);\n    const iy2 = this.lerp(this.y2, this.y3, t);\n\n    // Step two - from 3 points to 2\n    iy0 = this.lerp(iy0, iy1, t);\n    iy1 = this.lerp(iy1, iy2, t);\n\n    // Final step - last point\n    return this.lerp(iy0, iy1, t);\n  }\n\n  /**\n   * Performs linear interpolation between values a and b. Returns the value\n   * between a and b proportional to x (when x is between 0 and 1. When x is\n   * outside this range, the return value is a linear extrapolation).\n   * @param {number} a A number.\n   * @param {number} b A number.\n   * @param {number} x The proportion between a and b.\n   * @return {number} The interpolated value between a and b.\n   */\n  lerp(a, b, x) {\n    return a + x * (b - a);\n  }\n}\n\n/**\n * A collection of common curves.\n * See https://developer.mozilla.org/en-US/docs/Web/CSS/timing-function\n * @enum {!CurveDef}\n */\nexport const Curves = {\n  /**\n   * linear\n   * @param {number} n\n   * @return {number}\n   */\n  LINEAR(n) {\n    return n;\n  },\n\n  /**\n   * ease\n   */\n  EASE: bezierCurve(0.25, 0.1, 0.25, 1.0),\n\n  /**\n   * ease-in: slow out, fast in\n   */\n  EASE_IN: bezierCurve(0.42, 0.0, 1.0, 1.0),\n\n  /**\n   * ease-out: fast out, slow in\n   */\n  EASE_OUT: bezierCurve(0.0, 0.0, 0.58, 1.0),\n\n  /**\n   * ease-in-out\n   */\n  EASE_IN_OUT: bezierCurve(0.42, 0.0, 0.58, 1.0),\n};\n\n/**\n * @const {!Object<string, !CurveDef>}\n */\nconst NAME_MAP = {\n  'linear': Curves.LINEAR,\n  'ease': Curves.EASE,\n  'ease-in': Curves.EASE_IN,\n  'ease-out': Curves.EASE_OUT,\n  'ease-in-out': Curves.EASE_IN_OUT,\n};\n\n/**\n * If the argument is a string, this methods matches an existing curve by name.\n * @param {?CurveDef|string|undefined} curve\n * @return {?CurveDef}\n */\nexport function getCurve(curve) {\n  if (!curve) {\n    return null;\n  }\n  if (typeof curve == 'string') {\n    // If the curve is a custom cubic-bezier curve\n    if (curve.indexOf('cubic-bezier') != -1) {\n      const match = curve.match(/cubic-bezier\\((.+)\\)/);\n      if (match) {\n        const values = match[1].split(',').map(parseFloat);\n        if (values.length == 4) {\n          for (let i = 0; i < 4; i++) {\n            if (isNaN(values[i])) {\n              return null;\n            }\n          }\n          return bezierCurve(values[0], values[1], values[2], values[3]);\n        }\n      }\n      return null;\n    }\n    return NAME_MAP[curve];\n  }\n  return curve;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from './dom';\nimport {AmpEvents} from './amp-events';\nimport {CommonSignals} from './common-signals';\nimport {ElementStub} from './element-stub';\nimport {\n  Layout,\n  applyStaticLayout,\n  isInternalElement,\n  isLayoutSizeDefined,\n  isLoadingAllowed,\n} from './layout';\nimport {LayoutDelayMeter} from './layout-delay-meter';\nimport {ResourceState} from './service/resource';\nimport {Services} from './services';\nimport {Signals} from './utils/signals';\nimport {blockedByConsentError, isBlockedByConsent, reportError} from './error';\nimport {createLoaderElement} from '../src/loader.js';\nimport {dev, devAssert, rethrowAsync, user, userAssert} from './log';\nimport {getIntersectionChangeEntry} from '../src/intersection-observer-polyfill';\nimport {getMode} from './mode';\nimport {htmlFor} from './static-template';\nimport {parseSizeList} from './size-list';\nimport {setStyle} from './style';\nimport {shouldBlockOnConsentByMeta} from '../src/consent';\nimport {startupChunk} from './chunk';\nimport {toWin} from './types';\nimport {tryResolve} from '../src/utils/promise';\n\nconst TAG = 'CustomElement';\n\n/**\n * The elements positioned ahead of this threshold may have their loading\n * indicator initialized faster. This is benefitial to avoid relayout during\n * render phase or scrolling.\n * @private @const {number}\n */\nconst PREPARE_LOADING_THRESHOLD = 1000;\n\n/**\n * @enum {number}\n */\nconst UpgradeState = {\n  NOT_UPGRADED: 1,\n  UPGRADED: 2,\n  UPGRADE_FAILED: 3,\n  UPGRADE_IN_PROGRESS: 4,\n};\n\n/**\n * Caches whether the template tag is supported to avoid memory allocations.\n * @type {boolean|undefined}\n */\nlet templateTagSupported;\n\n/**\n * Whether this platform supports template tags.\n * @return {boolean}\n */\nfunction isTemplateTagSupported() {\n  if (templateTagSupported === undefined) {\n    const template = self.document.createElement('template');\n    templateTagSupported = 'content' in template;\n  }\n  return templateTagSupported;\n}\n\n/**\n * Creates a named custom element class.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @param {string} name The name of the custom element.\n * @return {function(new:AmpElement)} The custom element class.\n */\nexport function createCustomElementClass(win, name) {\n  const baseCustomElement = /** @type {function(new:HTMLElement)} */ (createBaseCustomElementClass(\n    win\n  ));\n  class CustomAmpElement extends baseCustomElement {\n    /**\n     * @see https://github.com/WebReflection/document-register-element#v1-caveat\n     * @suppress {checkTypes}\n     * @param {HTMLElement} self\n     */\n    constructor(self) {\n      return super(self);\n    }\n    /**\n     * The name of the custom element.\n     * @return {string}\n     */\n    elementName() {\n      return name;\n    }\n  }\n  return /** @type {function(new:AmpElement)} */ (CustomAmpElement);\n}\n\n/**\n * Creates a base custom element class.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @return {function(new:HTMLElement)}\n */\nfunction createBaseCustomElementClass(win) {\n  if (win.__AMP_BASE_CE_CLASS) {\n    return win.__AMP_BASE_CE_CLASS;\n  }\n  const htmlElement =\n    /** @type {function(new:HTMLElement)} */ (win.HTMLElement);\n\n  /**\n   * @abstract @extends {HTMLElement}\n   */\n  class BaseCustomElement extends htmlElement {\n    /**\n     * @see https://github.com/WebReflection/document-register-element#v1-caveat\n     * @suppress {checkTypes}\n     * @param {HTMLElement} self\n     */\n    constructor(self) {\n      self = super(self);\n      self.createdCallback();\n      return self;\n    }\n\n    /**\n     * Called when elements is created. Sets instance vars since there is no\n     * constructor.\n     * @final\n     */\n    createdCallback() {\n      // Flag \"notbuilt\" is removed by Resource manager when the resource is\n      // considered to be built. See \"setBuilt\" method.\n      /** @private {boolean} */\n      this.built_ = false;\n\n      /**\n       * Several APIs require the element to be connected to the DOM tree, but\n       * the CustomElement lifecycle APIs are async. This lead to subtle bugs\n       * that require state tracking. See #12849, https://crbug.com/821195, and\n       * https://bugs.webkit.org/show_bug.cgi?id=180940.\n       * @private {boolean}\n       */\n      this.isConnected_ = false;\n\n      /** @private {?Promise} */\n      this.buildingPromise_ = null;\n\n      /** @type {string} */\n      this.readyState = 'loading';\n\n      /** @type {boolean} */\n      this.everAttached = false;\n\n      /**\n       * Ampdoc can only be looked up when an element is attached.\n       * @private {?./service/ampdoc-impl.AmpDoc}\n       */\n      this.ampdoc_ = null;\n\n      /**\n       * Resources can only be looked up when an element is attached.\n       * @private {?./service/resources-interface.ResourcesInterface}\n       */\n      this.resources_ = null;\n\n      /** @private {!Layout} */\n      this.layout_ = Layout.NODISPLAY;\n\n      /** @private {number} */\n      this.layoutWidth_ = -1;\n\n      /** @private {number} */\n      this.layoutHeight_ = -1;\n\n      /** @private {number} */\n      this.layoutCount_ = 0;\n\n      /** @private {boolean} */\n      this.isFirstLayoutCompleted_ = false;\n\n      /** @private {boolean} */\n      this.isInViewport_ = false;\n\n      /** @private {boolean} */\n      this.paused_ = false;\n\n      /** @private {string|null|undefined} */\n      this.mediaQuery_ = undefined;\n\n      /** @private {!./size-list.SizeList|null|undefined} */\n      this.sizeList_ = undefined;\n\n      /** @private {!./size-list.SizeList|null|undefined} */\n      this.heightsList_ = undefined;\n\n      /** @public {boolean} */\n      this.warnOnMissingOverflow = true;\n\n      /**\n       * This element can be assigned by the {@link applyStaticLayout} to a\n       * child element that will be used to size this element.\n       * @package {?Element|undefined}\n       */\n      this.sizerElement = undefined;\n\n      /** @private {boolean|undefined} */\n      this.loadingDisabled_ = undefined;\n\n      /** @private {boolean|undefined} */\n      this.loadingState_ = undefined;\n\n      /** @private {?Element} */\n      this.loadingContainer_ = null;\n\n      /** @private {?Element} */\n      this.loadingElement_ = null;\n\n      /** @private {?Element|undefined} */\n      this.overflowElement_ = undefined;\n\n      /**\n       * The time at which this element was scheduled for layout relative to\n       * the epoch. This value will be set to 0 until the this element has been\n       * scheduled.\n       * Note that this value may change over time if the element is enqueued,\n       * then dequeued and re-enqueued by the scheduler.\n       * @type {number|undefined}\n       */\n      this.layoutScheduleTime = undefined;\n\n      // Closure compiler appears to mark HTMLElement as @struct which\n      // disables bracket access. Force this with a type coercion.\n      const nonStructThis = /** @type {!Object} */ (this);\n\n      // `opt_implementationClass` is only used for tests.\n      let Ctor =\n        win.__AMP_EXTENDED_ELEMENTS &&\n        win.__AMP_EXTENDED_ELEMENTS[this.elementName()];\n      if (getMode().test && nonStructThis['implementationClassForTesting']) {\n        Ctor = nonStructThis['implementationClassForTesting'];\n      }\n      devAssert(Ctor);\n      /** @private {!./base-element.BaseElement} */\n      this.implementation_ = new Ctor(this);\n\n      /**\n       * An element always starts in a unupgraded state until it's added to DOM\n       * for the first time in which case it can be upgraded immediately or wait\n       * for script download or `upgradeCallback`.\n       * @private {!UpgradeState}\n       */\n      this.upgradeState_ = UpgradeState.NOT_UPGRADED;\n\n      /**\n       * Time delay imposed by baseElement upgradeCallback.  If no\n       * upgradeCallback specified or not yet executed, delay is 0.\n       * @private {number}\n       */\n      this.upgradeDelayMs_ = 0;\n\n      /**\n       * Action queue is initially created and kept around until the element\n       * is ready to send actions directly to the implementation.\n       * - undefined initially\n       * - array if used\n       * - null after unspun\n       * @private {?Array<!./service/action-impl.ActionInvocation>|undefined}\n       */\n      this.actionQueue_ = undefined;\n\n      /**\n       * Whether the element is in the template.\n       * @private {boolean|undefined}\n       */\n      this.isInTemplate_ = undefined;\n\n      /** @private @const */\n      this.signals_ = new Signals();\n\n      const perf = Services.performanceForOrNull(win);\n      /** @private {boolean} */\n      this.perfOn_ = perf && perf.isPerformanceTrackingOn();\n\n      /** @private {?./layout-delay-meter.LayoutDelayMeter} */\n      this.layoutDelayMeter_ = null;\n\n      if (nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER]) {\n        nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER](nonStructThis);\n        delete nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_RESOLVER];\n        delete nonStructThis[dom.UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n      }\n    }\n\n    /**\n     * The name of the custom element.\n     * @abstract\n     * @return {string}\n     */\n    elementName() {}\n\n    /** @return {!Signals} */\n    signals() {\n      return this.signals_;\n    }\n\n    /**\n     * Returns the associated ampdoc. Only available after attachment. It throws\n     * exception before the element is attached.\n     * @return {!./service/ampdoc-impl.AmpDoc}\n     * @final\n     * @package\n     */\n    getAmpDoc() {\n      devAssert(this.ampdoc_, 'no ampdoc yet, since element is not attached');\n      return /** @typedef {!./service/ampdoc-impl.AmpDoc} */ this.ampdoc_;\n    }\n\n    /**\n     * Returns Resources manager. Only available after attachment. It throws\n     * exception before the element is attached.\n     * @return {!./service/resources-interface.ResourcesInterface}\n     * @final\n     * @package\n     */\n    getResources() {\n      devAssert(\n        this.resources_,\n        'no resources yet, since element is not attached'\n      );\n      return /** @typedef {!./service/resources-interface.ResourcesInterface} */ this\n        .resources_;\n    }\n\n    /**\n     * Whether the element has been upgraded yet. Always returns false when\n     * the element has not yet been added to DOM. After the element has been\n     * added to DOM, the value depends on the `BaseElement` implementation and\n     * its `upgradeElement` callback.\n     * @return {boolean}\n     * @final\n     */\n    isUpgraded() {\n      return this.upgradeState_ == UpgradeState.UPGRADED;\n    }\n\n    /** @return {!Promise} */\n    whenUpgraded() {\n      return this.signals_.whenSignal(CommonSignals.UPGRADED);\n    }\n\n    /**\n     * Upgrades the element to the provided new implementation. If element\n     * has already been attached, it's layout validation and attachment flows\n     * are repeated for the new implementation.\n     * @param {function(new:./base-element.BaseElement, !Element)} newImplClass\n     * @final @package\n     */\n    upgrade(newImplClass) {\n      if (this.isInTemplate_) {\n        return;\n      }\n      if (this.upgradeState_ != UpgradeState.NOT_UPGRADED) {\n        // Already upgraded or in progress or failed.\n        return;\n      }\n      this.implementation_ = new newImplClass(this);\n      if (this.everAttached) {\n        // Usually, we do an implementation upgrade when the element is\n        // attached to the DOM. But, if it hadn't yet upgraded from\n        // ElementStub, we couldn't. Now that it's upgraded from a stub, go\n        // ahead and do the full upgrade.\n        this.tryUpgrade_();\n      }\n    }\n\n    /**\n     * Time delay imposed by baseElement upgradeCallback.  If no\n     * upgradeCallback specified or not yet executed, delay is 0.\n     * @return {number}\n     */\n    getUpgradeDelayMs() {\n      return this.upgradeDelayMs_;\n    }\n\n    /**\n     * Completes the upgrade of the element with the provided implementation.\n     * @param {!./base-element.BaseElement} newImpl\n     * @param {number} upgradeStartTime\n     * @final @private\n     */\n    completeUpgrade_(newImpl, upgradeStartTime) {\n      this.upgradeDelayMs_ = win.Date.now() - upgradeStartTime;\n      this.upgradeState_ = UpgradeState.UPGRADED;\n      this.implementation_ = newImpl;\n      this.classList.remove('amp-unresolved');\n      this.classList.remove('i-amphtml-unresolved');\n      this.implementation_.createdCallback();\n      this.assertLayout_();\n      this.implementation_.layout_ = this.layout_;\n      this.implementation_.layoutWidth_ = this.layoutWidth_;\n      this.implementation_.firstAttachedCallback();\n      this.dispatchCustomEventForTesting(AmpEvents.ATTACHED);\n      this.getResources().upgraded(this);\n      this.signals_.signal(CommonSignals.UPGRADED);\n    }\n\n    /** @private */\n    assertLayout_() {\n      if (\n        this.layout_ != Layout.NODISPLAY &&\n        !this.implementation_.isLayoutSupported(this.layout_)\n      ) {\n        userAssert(\n          this.getAttribute('layout'),\n          'The element did not specify a layout attribute. ' +\n            'Check https://amp.dev/documentation/guides-and-tutorials/' +\n            'develop/style_and_layout/control_layout and the respective ' +\n            'element documentation for details.'\n        );\n        userAssert(false, `Layout not supported: ${this.layout_}`);\n      }\n    }\n\n    /**\n     * Whether the element has been built. A built element had its\n     * {@link buildCallback} method successfully invoked.\n     * @return {boolean}\n     * @final\n     */\n    isBuilt() {\n      return this.built_;\n    }\n\n    /**\n     * Returns the promise that's resolved when the element has been built. If\n     * the build fails, the resulting promise is rejected.\n     * @return {!Promise}\n     */\n    whenBuilt() {\n      return this.signals_.whenSignal(CommonSignals.BUILT);\n    }\n\n    /**\n     * Get the priority to load the element.\n     * @return {number}\n     */\n    getLayoutPriority() {\n      devAssert(this.isUpgraded(), 'Cannot get priority of unupgraded element');\n      return this.implementation_.getLayoutPriority();\n    }\n\n    /**\n     * Get the default action alias.\n     * @return {?string}\n     */\n    getDefaultActionAlias() {\n      devAssert(\n        this.isUpgraded(),\n        'Cannot get default action alias of unupgraded element'\n      );\n      return this.implementation_.getDefaultActionAlias();\n    }\n\n    /**\n     * Requests or requires the element to be built. The build is done by\n     * invoking {@link BaseElement.buildCallback} method.\n     *\n     * Can only be called on a upgraded element. May only be called from\n     * resource.js to ensure an element and its resource are in sync.\n     *\n     * @return {?Promise}\n     * @final\n     */\n    build() {\n      assertNotTemplate(this);\n      devAssert(this.isUpgraded(), 'Cannot build unupgraded element');\n      if (this.buildingPromise_) {\n        return this.buildingPromise_;\n      }\n      return (this.buildingPromise_ = new Promise((resolve, reject) => {\n        const policyId = this.getConsentPolicy_();\n        if (!policyId) {\n          resolve(this.implementation_.buildCallback());\n        } else {\n          Services.consentPolicyServiceForDocOrNull(this)\n            .then(policy => {\n              if (!policy) {\n                return true;\n              }\n              return policy.whenPolicyUnblock(/** @type {string} */ (policyId));\n            })\n            .then(shouldUnblock => {\n              if (shouldUnblock) {\n                resolve(this.implementation_.buildCallback());\n              } else {\n                reject(blockedByConsentError());\n              }\n            });\n        }\n      }).then(\n        () => {\n          this.preconnect(/* onLayout */ false);\n          this.built_ = true;\n          this.classList.remove('i-amphtml-notbuilt');\n          this.classList.remove('amp-notbuilt');\n          this.signals_.signal(CommonSignals.BUILT);\n          if (this.isInViewport_) {\n            this.updateInViewport_(true);\n          }\n          if (this.actionQueue_) {\n            // Only schedule when the queue is not empty, which should be\n            // the case 99% of the time.\n            Services.timerFor(toWin(this.ownerDocument.defaultView)).delay(\n              this.dequeueActions_.bind(this),\n              1\n            );\n          }\n          if (!this.getPlaceholder()) {\n            const placeholder = this.createPlaceholder();\n            if (placeholder) {\n              this.appendChild(placeholder);\n            }\n          }\n        },\n        reason => {\n          this.signals_.rejectSignal(\n            CommonSignals.BUILT,\n            /** @type {!Error} */ (reason)\n          );\n          if (!isBlockedByConsent(reason)) {\n            reportError(reason, this);\n          }\n          throw reason;\n        }\n      ));\n    }\n\n    /**\n     * Called to instruct the element to preconnect to hosts it uses during\n     * layout.\n     * @param {boolean} onLayout Whether this was called after a layout.\n     */\n    preconnect(onLayout) {\n      if (onLayout) {\n        this.implementation_.preconnectCallback(onLayout);\n      } else {\n        // If we do early preconnects we delay them a bit. This is kind of\n        // an unfortunate trade off, but it seems faster, because the DOM\n        // operations themselves are not free and might delay\n        startupChunk(self.document, () => {\n          const TAG = this.tagName;\n          if (!this.ownerDocument) {\n            dev().error(TAG, 'preconnect without ownerDocument');\n            return;\n          } else if (!this.ownerDocument.defaultView) {\n            dev().error(TAG, 'preconnect without defaultView');\n            return;\n          }\n          this.implementation_.preconnectCallback(onLayout);\n        });\n      }\n    }\n\n    /**\n     * Whether the custom element declares that it has to be fixed.\n     * @return {boolean}\n     */\n    isAlwaysFixed() {\n      return this.implementation_.isAlwaysFixed();\n    }\n\n    /**\n     * Updates the layout box of the element.\n     * See {@link BaseElement.getLayoutWidth} for details.\n     * @param {!./layout-rect.LayoutRectDef} layoutBox\n     * @param {boolean=} opt_measurementsChanged\n     */\n    updateLayoutBox(layoutBox, opt_measurementsChanged) {\n      this.layoutWidth_ = layoutBox.width;\n      this.layoutHeight_ = layoutBox.height;\n      if (this.isUpgraded()) {\n        this.implementation_.layoutWidth_ = this.layoutWidth_;\n      }\n      if (this.isBuilt()) {\n        try {\n          this.implementation_.onLayoutMeasure();\n          if (opt_measurementsChanged) {\n            this.implementation_.onMeasureChanged();\n          }\n        } catch (e) {\n          reportError(e, this);\n        }\n      }\n\n      if (this.isLoadingEnabled_()) {\n        if (this.isInViewport_) {\n          // Already in viewport - start showing loading.\n          this.toggleLoading(true);\n        } else if (\n          layoutBox.top < PREPARE_LOADING_THRESHOLD &&\n          layoutBox.top >= 0\n        ) {\n          // Few top elements will also be pre-initialized with a loading\n          // element.\n          this.mutateOrInvoke_(() => this.prepareLoading_());\n        }\n      }\n    }\n\n    /**\n     * @return {?Element}\n     * @private\n     */\n    getSizer_() {\n      if (\n        this.sizerElement === undefined &&\n        (this.layout_ === Layout.RESPONSIVE ||\n          this.layout_ === Layout.INTRINSIC)\n      ) {\n        // Expect sizer to exist, just not yet discovered.\n        this.sizerElement = this.querySelector('i-amphtml-sizer');\n      }\n      return this.sizerElement || null;\n    }\n\n    /**\n     * @param {Element} sizer\n     * @private\n     */\n    resetSizer_(sizer) {\n      if (this.layout_ === Layout.RESPONSIVE) {\n        setStyle(sizer, 'paddingTop', '0');\n        return;\n      }\n      if (this.layout_ === Layout.INTRINSIC) {\n        const intrinsicSizerImg = sizer.querySelector(\n          '.i-amphtml-intrinsic-sizer'\n        );\n        if (!intrinsicSizerImg) {\n          return;\n        }\n        intrinsicSizerImg.setAttribute('src', '');\n        return;\n      }\n    }\n\n    /**\n     * If the element has a media attribute, evaluates the value as a media\n     * query and based on the result adds or removes the class\n     * `i-amphtml-hidden-by-media-query`. The class adds display:none to the\n     * element which in turn prevents any of the resource loading to happen for\n     * the element.\n     *\n     * This method is called by Resources and shouldn't be called by anyone\n     * else.\n     *\n     * @final\n     * @package\n     */\n    applySizesAndMediaQuery() {\n      assertNotTemplate(this);\n\n      // Media query.\n      if (this.mediaQuery_ === undefined) {\n        this.mediaQuery_ = this.getAttribute('media') || null;\n      }\n      if (this.mediaQuery_) {\n        const {defaultView} = this.ownerDocument;\n        this.classList.toggle(\n          'i-amphtml-hidden-by-media-query',\n          !defaultView.matchMedia(this.mediaQuery_).matches\n        );\n      }\n\n      // Sizes.\n      if (this.sizeList_ === undefined) {\n        const sizesAttr = this.getAttribute('sizes');\n        this.sizeList_ = sizesAttr ? parseSizeList(sizesAttr) : null;\n      }\n      if (this.sizeList_) {\n        setStyle(\n          this,\n          'width',\n          this.sizeList_.select(toWin(this.ownerDocument.defaultView))\n        );\n      }\n      // Heights.\n      if (\n        this.heightsList_ === undefined &&\n        this.layout_ === Layout.RESPONSIVE\n      ) {\n        const heightsAttr = this.getAttribute('heights');\n        this.heightsList_ = heightsAttr\n          ? parseSizeList(heightsAttr, /* allowPercent */ true)\n          : null;\n      }\n      if (this.heightsList_) {\n        const sizer = this.getSizer_();\n        if (sizer) {\n          setStyle(\n            sizer,\n            'paddingTop',\n            this.heightsList_.select(toWin(this.ownerDocument.defaultView))\n          );\n        }\n      }\n    }\n\n    /**\n     * Changes the size of the element.\n     *\n     * This method is called by Resources and shouldn't be called by anyone\n     * else. This method must always be called in the mutation context.\n     *\n     * @param {number|undefined} newHeight\n     * @param {number|undefined} newWidth\n     * @param {!./layout-rect.LayoutMarginsDef=} opt_newMargins\n     * @final\n     * @package\n     */\n    changeSize(newHeight, newWidth, opt_newMargins) {\n      const sizer = this.getSizer_();\n      if (sizer) {\n        // From the moment height is changed the element becomes fully\n        // responsible for managing its height. Aspect ratio is no longer\n        // preserved.\n        this.sizerElement = null;\n        this.resetSizer_(sizer);\n        this.mutateOrInvoke_(() => {\n          if (sizer) {\n            dom.removeElement(sizer);\n          }\n        });\n      }\n      if (newHeight !== undefined) {\n        setStyle(this, 'height', newHeight, 'px');\n      }\n      if (newWidth !== undefined) {\n        setStyle(this, 'width', newWidth, 'px');\n      }\n      if (opt_newMargins) {\n        if (opt_newMargins.top != null) {\n          setStyle(this, 'marginTop', opt_newMargins.top, 'px');\n        }\n        if (opt_newMargins.right != null) {\n          setStyle(this, 'marginRight', opt_newMargins.right, 'px');\n        }\n        if (opt_newMargins.bottom != null) {\n          setStyle(this, 'marginBottom', opt_newMargins.bottom, 'px');\n        }\n        if (opt_newMargins.left != null) {\n          setStyle(this, 'marginLeft', opt_newMargins.left, 'px');\n        }\n      }\n      if (this.isAwaitingSize_()) {\n        this.sizeProvided_();\n      }\n      this.dispatchCustomEvent(AmpEvents.SIZE_CHANGED);\n    }\n\n    /**\n     * Called when the element is first connected to the DOM. Calls\n     * {@link firstAttachedCallback} if this is the first attachment.\n     *\n     * This callback is guarded by checks to see if the element is still\n     * connected.  Chrome and Safari can trigger connectedCallback even when\n     * the node is disconnected. See #12849, https://crbug.com/821195, and\n     * https://bugs.webkit.org/show_bug.cgi?id=180940. Thankfully,\n     * connectedCallback will later be called when the disconnected root is\n     * connected to the document tree.\n     *\n     * @final\n     */\n    connectedCallback() {\n      if (!isTemplateTagSupported() && this.isInTemplate_ === undefined) {\n        this.isInTemplate_ = !!dom.closestAncestorElementBySelector(\n          this,\n          'template'\n        );\n      }\n      if (this.isInTemplate_) {\n        return;\n      }\n\n      if (this.isConnected_ || !dom.isConnectedNode(this)) {\n        return;\n      }\n      this.isConnected_ = true;\n\n      if (!this.everAttached) {\n        this.classList.add('i-amphtml-element');\n        this.classList.add('i-amphtml-notbuilt');\n        this.classList.add('amp-notbuilt');\n      }\n\n      if (!this.ampdoc_) {\n        // Ampdoc can now be initialized.\n        const win = toWin(this.ownerDocument.defaultView);\n        const ampdocService = Services.ampdocServiceFor(win);\n        const ampdoc = ampdocService.getAmpDoc(this);\n        this.ampdoc_ = ampdoc;\n        // Load the pre-stubbed extension if needed.\n        const extensionId = this.tagName.toLowerCase();\n        if (\n          isStub(this.implementation_) &&\n          !ampdoc.declaresExtension(extensionId)\n        ) {\n          Services.extensionsFor(win).installExtensionForDoc(\n            ampdoc,\n            extensionId\n          );\n        }\n      }\n      if (!this.resources_) {\n        // Resources can now be initialized since the ampdoc is now available.\n        this.resources_ = Services.resourcesForDoc(this.ampdoc_);\n      }\n      this.getResources().add(this);\n\n      if (this.everAttached) {\n        const reconstruct = this.reconstructWhenReparented();\n        if (reconstruct) {\n          this.reset_();\n        }\n        if (this.isUpgraded()) {\n          if (reconstruct) {\n            this.getResources().upgraded(this);\n          }\n          this.dispatchCustomEventForTesting(AmpEvents.ATTACHED);\n        }\n      } else {\n        this.everAttached = true;\n\n        try {\n          this.layout_ = applyStaticLayout(this);\n        } catch (e) {\n          reportError(e, this);\n        }\n        if (!isStub(this.implementation_)) {\n          this.tryUpgrade_();\n        }\n        if (!this.isUpgraded()) {\n          this.classList.add('amp-unresolved');\n          this.classList.add('i-amphtml-unresolved');\n          // amp:attached is dispatched from the ElementStub class when it\n          // replayed the firstAttachedCallback call.\n          this.dispatchCustomEventForTesting(AmpEvents.STUBBED);\n        }\n      }\n    }\n\n    /**\n     * @return {boolean}\n     * @private\n     */\n    isAwaitingSize_() {\n      return this.classList.contains('i-amphtml-layout-awaiting-size');\n    }\n\n    /**\n     * @private\n     */\n    sizeProvided_() {\n      this.classList.remove('i-amphtml-layout-awaiting-size');\n    }\n\n    /** The Custom Elements V0 sibling to `connectedCallback`. */\n    attachedCallback() {\n      this.connectedCallback();\n    }\n\n    /**\n     * Try to upgrade the element with the provided implementation.\n     * @private @final\n     */\n    tryUpgrade_() {\n      const impl = this.implementation_;\n      devAssert(!isStub(impl), 'Implementation must not be a stub');\n      if (this.upgradeState_ != UpgradeState.NOT_UPGRADED) {\n        // Already upgraded or in progress or failed.\n        return;\n      }\n\n      // The `upgradeCallback` only allows redirect once for the top-level\n      // non-stub class. We may allow nested upgrades later, but they will\n      // certainly be bad for performance.\n      this.upgradeState_ = UpgradeState.UPGRADE_IN_PROGRESS;\n      const startTime = win.Date.now();\n      const res = impl.upgradeCallback();\n      if (!res) {\n        // Nothing returned: the current object is the upgraded version.\n        this.completeUpgrade_(impl, startTime);\n      } else if (typeof res.then == 'function') {\n        // It's a promise: wait until it's done.\n        res\n          .then(upgrade => {\n            this.completeUpgrade_(upgrade || impl, startTime);\n          })\n          .catch(reason => {\n            this.upgradeState_ = UpgradeState.UPGRADE_FAILED;\n            rethrowAsync(reason);\n          });\n      } else {\n        // It's an actual instance: upgrade immediately.\n        this.completeUpgrade_(\n          /** @type {!./base-element.BaseElement} */ (res),\n          startTime\n        );\n      }\n    }\n\n    /**\n     * Called when the element is disconnected from the DOM.\n     *\n     * @final\n     */\n    disconnectedCallback() {\n      this.disconnect(/* pretendDisconnected */ false);\n    }\n\n    /** The Custom Elements V0 sibling to `disconnectedCallback`. */\n    detachedCallback() {\n      this.disconnectedCallback();\n    }\n\n    /**\n     * Called when an element is disconnected from DOM, or when an ampDoc is\n     * being disconnected (the element itself may still be connected to ampDoc).\n     *\n     * This callback is guarded by checks to see if the element is still\n     * connected. See #12849, https://crbug.com/821195, and\n     * https://bugs.webkit.org/show_bug.cgi?id=180940.\n     * If the element is still connected to the document, you'll need to pass\n     * opt_pretendDisconnected.\n     *\n     * @param {boolean} pretendDisconnected Forces disconnection regardless\n     *     of DOM isConnected.\n     */\n    disconnect(pretendDisconnected) {\n      if (this.isInTemplate_ || !this.isConnected_) {\n        return;\n      }\n      if (!pretendDisconnected && dom.isConnectedNode(this)) {\n        return;\n      }\n\n      // This path only comes from Resource#disconnect, which deletes the\n      // Resource instance tied to this element. Therefore, it is no longer\n      // an AMP Element. But, DOM queries for i-amphtml-element assume that\n      // the element is tied to a Resource.\n      if (pretendDisconnected) {\n        this.classList.remove('i-amphtml-element');\n      }\n\n      this.isConnected_ = false;\n      this.getResources().remove(this);\n      this.implementation_.detachedCallback();\n    }\n\n    /**\n     * Dispatches a custom event.\n     *\n     * @param {string} name\n     * @param {!Object=} opt_data Event data.\n     * @final\n     */\n    dispatchCustomEvent(name, opt_data) {\n      const data = opt_data || {};\n      // Constructors of events need to come from the correct window. Sigh.\n      const event = this.ownerDocument.createEvent('Event');\n      event.data = data;\n      event.initEvent(name, /* bubbles */ true, /* cancelable */ true);\n      this.dispatchEvent(event);\n    }\n\n    /**\n     * Dispatches a custom event only in testing environment.\n     *\n     * @param {string} name\n     * @param {!Object=} opt_data Event data.\n     * @final\n     */\n    dispatchCustomEventForTesting(name, opt_data) {\n      if (!getMode().test) {\n        return;\n      }\n      this.dispatchCustomEvent(name, opt_data);\n    }\n\n    /**\n     * Whether the element can pre-render.\n     * @return {boolean}\n     * @final\n     */\n    prerenderAllowed() {\n      return this.implementation_.prerenderAllowed();\n    }\n\n    /**\n     * Whether the element has render-blocking service.\n     * @return {boolean}\n     * @final\n     */\n    isBuildRenderBlocking() {\n      return this.implementation_.isBuildRenderBlocking();\n    }\n\n    /**\n     * Creates a placeholder for the element.\n     * @return {?Element}\n     * @final\n     */\n    createPlaceholder() {\n      return this.implementation_.createPlaceholderCallback();\n    }\n\n    /**\n     * Creates a loader logo.\n     * @return {{\n     *  content: (!Element|undefined),\n     *  color: (string|undefined),\n     * }}\n     * @final\n     */\n    createLoaderLogo() {\n      return this.implementation_.createLoaderLogoCallback();\n    }\n\n    /**\n     * Whether the element should ever render when it is not in viewport.\n     * @return {boolean|number}\n     * @final\n     */\n    renderOutsideViewport() {\n      return this.implementation_.renderOutsideViewport();\n    }\n\n    /**\n     * Whether the element should render outside of renderOutsideViewport when\n     * the scheduler is idle.\n     * @return {boolean|number}\n     * @final\n     */\n    idleRenderOutsideViewport() {\n      return this.implementation_.idleRenderOutsideViewport();\n    }\n\n    /**\n     * Returns a previously measured layout box adjusted to the viewport. This\n     * mainly affects fixed-position elements that are adjusted to be always\n     * relative to the document position in the viewport.\n     * @return {!./layout-rect.LayoutRectDef}\n     * @final\n     */\n    getLayoutBox() {\n      return this.getResource_().getLayoutBox();\n    }\n\n    /**\n     * Returns a previously measured layout box relative to the page. The\n     * fixed-position elements are relative to the top of the document.\n     * @return {!./layout-rect.LayoutRectDef}\n     * @final\n     */\n    getPageLayoutBox() {\n      return this.getResource_().getPageLayoutBox();\n    }\n\n    /**\n     * @return {?Element}\n     * @final\n     */\n    getOwner() {\n      return this.getResource_().getOwner();\n    }\n\n    /**\n     * Returns a change entry for that should be compatible with\n     * IntersectionObserverEntry.\n     * @return {!IntersectionObserverEntry} A change entry.\n     * @final\n     */\n    getIntersectionChangeEntry() {\n      const box = this.implementation_.getIntersectionElementLayoutBox();\n      const owner = this.getOwner();\n      const viewportBox = this.implementation_.getViewport().getRect();\n      // TODO(jridgewell, #4826): We may need to make this recursive.\n      const ownerBox = owner && owner.getLayoutBox();\n      return getIntersectionChangeEntry(box, ownerBox, viewportBox);\n    }\n\n    /**\n     * Returns the resource of the element.\n     * @return {!./service/resource.Resource}\n     * @private\n     */\n    getResource_() {\n      return this.getResources().getResourceForElement(this);\n    }\n\n    /**\n     * Returns the resource ID of the element.\n     * @return {number}\n     */\n    getResourceId() {\n      return this.getResource_().getId();\n    }\n\n    /**\n     * The runtime calls this method to determine if {@link layoutCallback}\n     * should be called again when layout changes.\n     * @return {boolean}\n     * @package @final\n     */\n    isRelayoutNeeded() {\n      return this.implementation_.isRelayoutNeeded();\n    }\n\n    /**\n     * Returns reference to upgraded implementation.\n     * @param {boolean} waitForBuild If true, waits for element to be built before\n     *   resolving the returned Promise. Default is true.\n     * @return {!Promise<!./base-element.BaseElement>}\n     */\n    getImpl(waitForBuild = true) {\n      const waitFor = waitForBuild ? this.whenBuilt() : this.whenUpgraded();\n      return waitFor.then(() => this.implementation_);\n    }\n\n    /**\n     * Returns the layout of the element.\n     * @return {!Layout}\n     */\n    getLayout() {\n      return this.layout_;\n    }\n\n    /**\n     * Instructs the element to layout its content and load its resources if\n     * necessary by calling the {@link BaseElement.layoutCallback} method that\n     * should be implemented by BaseElement subclasses. Must return a promise\n     * that will yield when the layout and associated loadings are complete.\n     *\n     * This method is always called for the first layout, but for subsequent\n     * layouts the runtime consults {@link isRelayoutNeeded} method.\n     *\n     * Can only be called on a upgraded and built element.\n     *\n     * @return {!Promise}\n     * @package @final\n     */\n    layoutCallback() {\n      assertNotTemplate(this);\n      devAssert(this.isBuilt(), 'Must be built to receive viewport events');\n      this.dispatchCustomEventForTesting(AmpEvents.LOAD_START);\n      const isLoadEvent = this.layoutCount_ == 0; // First layout is \"load\".\n      this.signals_.reset(CommonSignals.UNLOAD);\n      if (isLoadEvent) {\n        this.signals_.signal(CommonSignals.LOAD_START);\n      }\n      if (this.perfOn_) {\n        this.getLayoutDelayMeter_().startLayout();\n      }\n\n      const promise = tryResolve(() => this.implementation_.layoutCallback());\n      this.preconnect(/* onLayout */ true);\n      this.classList.add('i-amphtml-layout');\n\n      return promise.then(\n        () => {\n          if (isLoadEvent) {\n            this.signals_.signal(CommonSignals.LOAD_END);\n          }\n          this.readyState = 'complete';\n          this.layoutCount_++;\n          this.toggleLoading(false, {cleanup: true});\n          // Check if this is the first success layout that needs\n          // to call firstLayoutCompleted.\n          if (!this.isFirstLayoutCompleted_) {\n            this.implementation_.firstLayoutCompleted();\n            this.isFirstLayoutCompleted_ = true;\n            this.dispatchCustomEventForTesting(AmpEvents.LOAD_END);\n          }\n        },\n        reason => {\n          // add layoutCount_ by 1 despite load fails or not\n          if (isLoadEvent) {\n            this.signals_.rejectSignal(\n              CommonSignals.LOAD_END,\n              /** @type {!Error} */ (reason)\n            );\n          }\n          this.layoutCount_++;\n          this.toggleLoading(false, {cleanup: true});\n          throw reason;\n        }\n      );\n    }\n\n    /**\n     * Whether the resource is currently visible in the viewport.\n     * @return {boolean}\n     * @final @package\n     */\n    isInViewport() {\n      return this.isInViewport_;\n    }\n\n    /**\n     * Instructs the resource that it entered or exited the visible viewport.\n     *\n     * Can only be called on a upgraded and built element.\n     *\n     * @param {boolean} inViewport Whether the element has entered or exited\n     *   the visible viewport.\n     * @final @package\n     */\n    viewportCallback(inViewport) {\n      assertNotTemplate(this);\n      if (inViewport == this.isInViewport_) {\n        return;\n      }\n      // TODO(dvoytenko, #9177): investigate/cleanup viewport signals for\n      // elements in dead iframes.\n      if (!this.ownerDocument || !this.ownerDocument.defaultView) {\n        return;\n      }\n      this.isInViewport_ = inViewport;\n      if (this.layoutCount_ == 0) {\n        if (!inViewport) {\n          this.toggleLoading(false);\n        } else {\n          // Set a minimum delay in case the element loads very fast or if it\n          // leaves the viewport.\n          Services.timerFor(toWin(this.ownerDocument.defaultView)).delay(() => {\n            // TODO(dvoytenko, #9177): cleanup `this.ownerDocument.defaultView`\n            // once investigation is complete. It appears that we get a lot of\n            // errors here once the iframe is destroyed due to timer.\n            if (\n              this.isInViewport_ &&\n              this.ownerDocument &&\n              this.ownerDocument.defaultView\n            ) {\n              this.toggleLoading(true);\n            }\n          }, 100);\n        }\n      }\n      if (this.isBuilt()) {\n        this.updateInViewport_(inViewport);\n      }\n    }\n\n    /**\n     * @param {boolean} inViewport\n     * @private\n     */\n    updateInViewport_(inViewport) {\n      this.implementation_.inViewport_ = inViewport;\n      this.implementation_.viewportCallback(inViewport);\n      if (inViewport && this.perfOn_) {\n        this.getLayoutDelayMeter_().enterViewport();\n      }\n    }\n\n    /**\n     * Whether the resource is currently paused.\n     * @return {boolean}\n     * @final @package\n     */\n    isPaused() {\n      return this.paused_;\n    }\n\n    /**\n     * Requests the resource to stop its activity when the document goes into\n     * inactive state. The scope is up to the actual component. Among other\n     * things the active playback of video or audio content must be stopped.\n     *\n     * @package @final\n     */\n    pauseCallback() {\n      assertNotTemplate(this);\n      if (this.paused_) {\n        return;\n      }\n      this.paused_ = true;\n      this.viewportCallback(false);\n      if (this.isBuilt()) {\n        this.implementation_.pauseCallback();\n      }\n    }\n\n    /**\n     * Requests the resource to resume its activity when the document returns\n     * from an inactive state. The scope is up to the actual component. Among\n     * other things the active playback of video or audio content may be\n     * resumed.\n     *\n     * @package @final\n     */\n    resumeCallback() {\n      assertNotTemplate(this);\n      if (!this.paused_) {\n        return;\n      }\n      this.paused_ = false;\n      if (this.isBuilt()) {\n        this.implementation_.resumeCallback();\n      }\n    }\n\n    /**\n     * Requests the element to unload any expensive resources when the element\n     * goes into non-visible state. The scope is up to the actual component.\n     *\n     * Calling this method on unbuilt or unupgraded element has no effect.\n     *\n     * @return {boolean}\n     * @package @final\n     */\n    unlayoutCallback() {\n      assertNotTemplate(this);\n      if (!this.isBuilt()) {\n        return false;\n      }\n      this.signals_.signal(CommonSignals.UNLOAD);\n      const isReLayoutNeeded = this.implementation_.unlayoutCallback();\n      if (isReLayoutNeeded) {\n        this.reset_();\n      }\n      return isReLayoutNeeded;\n    }\n\n    /** @private */\n    reset_() {\n      this.layoutCount_ = 0;\n      this.isFirstLayoutCompleted_ = false;\n      this.signals_.reset(CommonSignals.RENDER_START);\n      this.signals_.reset(CommonSignals.LOAD_START);\n      this.signals_.reset(CommonSignals.LOAD_END);\n      this.signals_.reset(CommonSignals.INI_LOAD);\n    }\n\n    /**\n     * Whether to call {@link unlayoutCallback} when pausing the element.\n     * Certain elements cannot properly pause (like amp-iframes with unknown\n     * video content), and so we must unlayout to stop playback.\n     *\n     * @return {boolean}\n     * @package @final\n     */\n    unlayoutOnPause() {\n      return this.implementation_.unlayoutOnPause();\n    }\n\n    /**\n     * Whether the element needs to be reconstructed after it has been\n     * re-parented. Many elements cannot survive fully the reparenting and\n     * are better to be reconstructed from scratch.\n     *\n     * @return {boolean}\n     * @package @final\n     */\n    reconstructWhenReparented() {\n      return this.implementation_.reconstructWhenReparented();\n    }\n\n    /**\n     * Collapses the element, and notifies its owner (if there is one) that the\n     * element is no longer present.\n     */\n    collapse() {\n      this.implementation_./*OK*/ collapse();\n    }\n\n    /**\n     * Called every time an owned AmpElement collapses itself.\n     * @param {!AmpElement} element\n     */\n    collapsedCallback(element) {\n      this.implementation_.collapsedCallback(element);\n    }\n\n    /**\n     * Expands the element, and notifies its owner (if there is one) that the\n     * element is now present.\n     */\n    expand() {\n      this.implementation_./*OK*/ expand();\n    }\n\n    /**\n     * Called every time an owned AmpElement expands itself.\n     * @param {!AmpElement} element\n     */\n    expandedCallback(element) {\n      this.implementation_.expandedCallback(element);\n    }\n\n    /**\n     * Called when one or more attributes are mutated.\n     * Note: Must be called inside a mutate context.\n     * Note: Boolean attributes have a value of `true` and `false` when\n     *     present and missing, respectively.\n     * @param {!JsonObject<string, (null|boolean|string|number|Array|Object)>} mutations\n     */\n    mutatedAttributesCallback(mutations) {\n      this.implementation_.mutatedAttributesCallback(mutations);\n    }\n\n    /**\n     * Enqueues the action with the element. If element has been upgraded and\n     * built, the action is dispatched to the implementation right away.\n     * Otherwise the invocation is enqueued until the implementation is ready\n     * to receive actions.\n     * @param {!./service/action-impl.ActionInvocation} invocation\n     * @final\n     */\n    enqueAction(invocation) {\n      assertNotTemplate(this);\n      if (!this.isBuilt()) {\n        if (this.actionQueue_ === undefined) {\n          this.actionQueue_ = [];\n        }\n        devAssert(this.actionQueue_).push(invocation);\n      } else {\n        this.executionAction_(invocation, false);\n      }\n    }\n\n    /**\n     * Dequeues events from the queue and dispatches them to the implementation\n     * with \"deferred\" flag.\n     * @private\n     */\n    dequeueActions_() {\n      if (!this.actionQueue_) {\n        return;\n      }\n\n      const actionQueue = devAssert(this.actionQueue_);\n      this.actionQueue_ = null;\n\n      // Notice, the actions are currently not de-duped.\n      actionQueue.forEach(invocation => {\n        this.executionAction_(invocation, true);\n      });\n    }\n\n    /**\n     * Executes the action immediately. All errors are consumed and reported.\n     * @param {!./service/action-impl.ActionInvocation} invocation\n     * @param {boolean} deferred\n     * @final\n     * @private\n     */\n    executionAction_(invocation, deferred) {\n      try {\n        this.implementation_.executeAction(invocation, deferred);\n      } catch (e) {\n        rethrowAsync(\n          'Action execution failed:',\n          e,\n          invocation.node.tagName,\n          invocation.method\n        );\n      }\n    }\n\n    /**\n     * Get the consent policy to follow.\n     * @return {?string}\n     */\n    getConsentPolicy_() {\n      let policyId = this.getAttribute('data-block-on-consent');\n      if (policyId === null) {\n        if (shouldBlockOnConsentByMeta(this)) {\n          policyId = 'default';\n          this.setAttribute('data-block-on-consent', policyId);\n        } else {\n          // data-block-on-consent attribute not set\n          return null;\n        }\n      }\n      if (policyId == '' || policyId == 'default') {\n        // data-block-on-consent value not set, up to individual element\n        // Note: data-block-on-consent and data-block-on-consent='default' is\n        // treated exactly the same\n        return this.implementation_.getConsentPolicy();\n      }\n      return policyId;\n    }\n\n    /**\n     * Returns the original nodes of the custom element without any service\n     * nodes that could have been added for markup. These nodes can include\n     * Text, Comment and other child nodes.\n     * @return {!Array<!Node>}\n     * @package @final\n     */\n    getRealChildNodes() {\n      return dom.childNodes(this, node => !isInternalOrServiceNode(node));\n    }\n\n    /**\n     * Returns the original children of the custom element without any service\n     * nodes that could have been added for markup.\n     * @return {!Array<!Element>}\n     * @package @final\n     */\n    getRealChildren() {\n      return dom.childElements(\n        this,\n        element => !isInternalOrServiceNode(element)\n      );\n    }\n\n    /**\n     * Returns an optional placeholder element for this custom element.\n     * @return {?Element}\n     * @package @final\n     */\n    getPlaceholder() {\n      return dom.lastChildElement(this, el => {\n        return (\n          el.hasAttribute('placeholder') &&\n          // Blacklist elements that has a native placeholder property\n          // like input and textarea. These are not allowed to be AMP\n          // placeholders.\n          !isInputPlaceholder(el)\n        );\n      });\n    }\n\n    /**\n     * Hides or shows the placeholder, if available.\n     * @param {boolean} show\n     * @package @final\n     */\n    togglePlaceholder(show) {\n      assertNotTemplate(this);\n      if (show) {\n        const placeholder = this.getPlaceholder();\n        if (placeholder) {\n          dev()\n            .assertElement(placeholder)\n            .classList.remove('amp-hidden');\n        }\n      } else {\n        const placeholders = dom.childElementsByAttr(this, 'placeholder');\n        for (let i = 0; i < placeholders.length; i++) {\n          // Don't toggle elements with a native placeholder property\n          // e.g. input, textarea\n          if (isInputPlaceholder(placeholders[i])) {\n            continue;\n          }\n          placeholders[i].classList.add('amp-hidden');\n        }\n      }\n    }\n\n    /**\n     * Returns an optional fallback element for this custom element.\n     * @return {?Element}\n     * @package @final\n     */\n    getFallback() {\n      return dom.childElementByAttr(this, 'fallback');\n    }\n\n    /**\n     * Hides or shows the fallback, if available. This function must only\n     * be called inside a mutate context.\n     * @param {boolean} show\n     * @package @final\n     */\n    toggleFallback(show) {\n      assertNotTemplate(this);\n      const resourceState = this.getResource_().getState();\n      // Do not show fallback before layout\n      if (\n        show &&\n        (resourceState == ResourceState.NOT_BUILT ||\n          resourceState == ResourceState.NOT_LAID_OUT ||\n          resourceState == ResourceState.READY_FOR_LAYOUT)\n      ) {\n        return;\n      }\n      // This implementation is notably less efficient then placeholder\n      // toggling. The reasons for this are: (a) \"not supported\" is the state of\n      // the whole element, (b) some relayout is expected and (c) fallback\n      // condition would be rare.\n      this.classList.toggle('amp-notsupported', show);\n      if (show == true) {\n        const fallbackElement = this.getFallback();\n        if (fallbackElement) {\n          Services.ownersForDoc(this.getAmpDoc()).scheduleLayout(\n            this,\n            fallbackElement\n          );\n        }\n      }\n    }\n\n    /**\n     * An implementation can call this method to signal to the element that\n     * it has started rendering.\n     * @package @final\n     */\n    renderStarted() {\n      this.signals_.signal(CommonSignals.RENDER_START);\n      this.togglePlaceholder(false);\n      this.toggleLoading(false);\n    }\n\n    /**\n     * Whether the loading can be shown for this element.\n     * @return {boolean}\n     * @private\n     */\n    isLoadingEnabled_() {\n      // No loading indicator will be shown if either one of these conditions\n      // true:\n      // 1. `noloading` attribute is specified;\n      // 2. The element has not been whitelisted;\n      // 3. The element is too small or has not yet been measured;\n      // 4. The element has already been laid out (include having loading\n      //    error);\n      // 5. The element is a `placeholder` or a `fallback`;\n      // 6. The element's layout is not a size-defining layout.\n      // 7. The document is A4A.\n      if (this.isInA4A()) {\n        return false;\n      }\n      if (this.loadingDisabled_ === undefined) {\n        this.loadingDisabled_ = this.hasAttribute('noloading');\n      }\n\n      if (\n        this.layoutCount_ > 0 ||\n        this.layoutWidth_ <= 0 || // Layout is not ready or invisible\n        this.loadingDisabled_ ||\n        !isLoadingAllowed(this) ||\n        isInternalOrServiceNode(this) ||\n        !isLayoutSizeDefined(this.layout_)\n      ) {\n        return false;\n      }\n\n      return true;\n    }\n\n    /**\n     * @return {boolean}\n     */\n    isInA4A() {\n      return (\n        // in FIE\n        (this.ampdoc_ && this.ampdoc_.win != this.ownerDocument.defaultView) ||\n        // in inabox\n        getMode().runtime == 'inabox'\n      );\n    }\n\n    /**\n     * Creates a loading object. The caller must ensure that loading can\n     * actually be shown. This method must also be called in the mutate\n     * context.\n     * @private\n     */\n    prepareLoading_() {\n      if (!this.isLoadingEnabled_()) {\n        return;\n      }\n      if (!this.loadingContainer_) {\n        const doc = this.ownerDocument;\n        devAssert(doc);\n\n        const container = htmlFor(/** @type {!Document} */ (doc))`\n            <div class=\"i-amphtml-loading-container i-amphtml-fill-content\n              amp-hidden\"></div>`;\n        const loadingElement = createLoaderElement(\n          this.getAmpDoc(),\n          this,\n          this.layoutWidth_,\n          this.layoutHeight_\n        );\n\n        container.appendChild(loadingElement);\n\n        this.appendChild(container);\n        this.loadingContainer_ = container;\n        this.loadingElement_ = loadingElement;\n      }\n    }\n\n    /**\n     * Turns the loading indicator on or off.\n     * @param {boolean} state\n     * @param {{cleanup:(boolean|undefined), force:(boolean|undefined)}=} opt_options\n     * @public @final\n     */\n    toggleLoading(state, opt_options) {\n      const cleanup = opt_options && opt_options.cleanup;\n      const force = opt_options && opt_options.force;\n      assertNotTemplate(this);\n      if (\n        state &&\n        !this.implementation_.isLoadingReused() &&\n        (this.layoutCount_ > 0 || this.signals_.get(CommonSignals.RENDER_START))\n      ) {\n        // Loading has already been canceled. Ignore.\n        return;\n      }\n      if (state === this.loadingState_ && !opt_options) {\n        // Loading state is the same.\n        return;\n      }\n      this.loadingState_ = state;\n      if (!state && !this.loadingContainer_) {\n        return;\n      }\n\n      // Check if loading should be shown.\n      if (state && !force && !this.isLoadingEnabled_()) {\n        this.loadingState_ = false;\n        return;\n      }\n\n      this.mutateOrInvoke_(() => {\n        let state = this.loadingState_;\n        // Repeat \"loading enabled\" check because it could have changed while\n        // waiting for vsync.\n        if (state && !force && !this.isLoadingEnabled_()) {\n          state = false;\n        }\n        if (state) {\n          this.prepareLoading_();\n        }\n        if (!this.loadingContainer_) {\n          return;\n        }\n\n        this.loadingContainer_.classList.toggle('amp-hidden', !state);\n        this.loadingElement_.classList.toggle('amp-active', state);\n\n        if (!state && cleanup && !this.implementation_.isLoadingReused()) {\n          const loadingContainer = this.loadingContainer_;\n          this.loadingContainer_ = null;\n          this.loadingElement_ = null;\n          this.mutateOrInvoke_(() => {\n            dom.removeElement(loadingContainer);\n          });\n        }\n      });\n    }\n\n    /**\n     * Returns an optional overflow element for this custom element.\n     * @return {!./layout-delay-meter.LayoutDelayMeter}\n     */\n    getLayoutDelayMeter_() {\n      if (!this.layoutDelayMeter_) {\n        this.layoutDelayMeter_ = new LayoutDelayMeter(\n          toWin(this.ownerDocument.defaultView),\n          this.getLayoutPriority()\n        );\n      }\n      return this.layoutDelayMeter_;\n    }\n\n    /**\n     * Returns an optional overflow element for this custom element.\n     * @return {?Element}\n     */\n    getOverflowElement() {\n      if (this.overflowElement_ === undefined) {\n        this.overflowElement_ = dom.childElementByAttr(this, 'overflow');\n        if (this.overflowElement_) {\n          if (!this.overflowElement_.hasAttribute('tabindex')) {\n            this.overflowElement_.setAttribute('tabindex', '0');\n          }\n          if (!this.overflowElement_.hasAttribute('role')) {\n            this.overflowElement_.setAttribute('role', 'button');\n          }\n        }\n      }\n      return this.overflowElement_;\n    }\n\n    /**\n     * Hides or shows the overflow, if available. This function must only\n     * be called inside a mutate context.\n     * @param {boolean} overflown\n     * @param {number|undefined} requestedHeight\n     * @param {number|undefined} requestedWidth\n     * @package @final\n     */\n    overflowCallback(overflown, requestedHeight, requestedWidth) {\n      this.getOverflowElement();\n      if (!this.overflowElement_) {\n        if (overflown && this.warnOnMissingOverflow) {\n          user().warn(\n            TAG,\n            'Cannot resize element and overflow is not available',\n            this\n          );\n        }\n      } else {\n        this.overflowElement_.classList.toggle('amp-visible', overflown);\n\n        if (overflown) {\n          this.overflowElement_.onclick = () => {\n            const resources = this.getResources();\n            resources./*OK*/ changeSize(this, requestedHeight, requestedWidth);\n            resources.mutateElement(this, () => {\n              this.overflowCallback(\n                /* overflown */ false,\n                requestedHeight,\n                requestedWidth\n              );\n            });\n          };\n        } else {\n          this.overflowElement_.onclick = null;\n        }\n      }\n    }\n\n    /**\n     * Mutates the element using resources if available.\n     *\n     * @param {function()} mutator\n     * @param {?Element=} opt_element\n     */\n    mutateOrInvoke_(mutator, opt_element) {\n      if (this.resources_) {\n        this.getResources().mutateElement(opt_element || this, mutator);\n      } else {\n        mutator();\n      }\n    }\n  }\n  win.__AMP_BASE_CE_CLASS = BaseCustomElement;\n  return /** @type {function(new:HTMLElement)} */ (win.__AMP_BASE_CE_CLASS);\n}\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nfunction isInputPlaceholder(element) {\n  return 'placeholder' in element;\n}\n\n/** @param {!Element} element */\nfunction assertNotTemplate(element) {\n  devAssert(!element.isInTemplate_, 'Must never be called in template');\n}\n\n/**\n * Whether the implementation is a stub.\n * @param {?./base-element.BaseElement} impl\n * @return {boolean}\n */\nfunction isStub(impl) {\n  return impl instanceof ElementStub;\n}\n\n/**\n * Returns \"true\" for internal AMP nodes or for placeholder elements.\n * @param {!Node} node\n * @return {boolean}\n */\nfunction isInternalOrServiceNode(node) {\n  if (isInternalElement(node)) {\n    return true;\n  }\n  if (\n    node.tagName &&\n    (node.hasAttribute('placeholder') ||\n      node.hasAttribute('fallback') ||\n      node.hasAttribute('overflow'))\n  ) {\n    return true;\n  }\n  return false;\n}\n\n/**\n * Creates a new custom element class prototype.\n *\n * @param {!Window} win The window in which to register the custom element.\n * @param {string} name The name of the custom element.\n * @param {function(new:./base-element.BaseElement, !Element)=} opt_implementationClass For testing only.\n * @return {!Object} Prototype of element.\n */\nexport function createAmpElementForTesting(win, name, opt_implementationClass) {\n  const Element = createCustomElementClass(win, name);\n  if (getMode().test && opt_implementationClass) {\n    Element.prototype.implementationClassForTesting = opt_implementationClass;\n  }\n  return Element;\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether the document is ready.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isDocumentReady(doc) {\n  return doc.readyState != 'loading' && doc.readyState != 'uninitialized';\n}\n\n/**\n * Whether the document has loaded all the css and sub-resources.\n * @param {!Document} doc\n * @return {boolean}\n */\nfunction isDocumentComplete(doc) {\n  return doc.readyState == 'complete';\n}\n\n/**\n * Calls the callback when document is ready.\n * @param {!Document} doc\n * @param {function(!Document)} callback\n */\nexport function onDocumentReady(doc, callback) {\n  onDocumentState(doc, isDocumentReady, callback);\n}\n\n/**\n * Calls the callback when document's state satisfies the stateFn.\n * @param {!Document} doc\n * @param {function(!Document):boolean} stateFn\n * @param {function(!Document)} callback\n */\nfunction onDocumentState(doc, stateFn, callback) {\n  let ready = stateFn(doc);\n  if (ready) {\n    callback(doc);\n  } else {\n    const readyListener = () => {\n      if (stateFn(doc)) {\n        if (!ready) {\n          ready = true;\n          callback(doc);\n        }\n        doc.removeEventListener('readystatechange', readyListener);\n      }\n    };\n    doc.addEventListener('readystatechange', readyListener);\n  }\n}\n\n/**\n * Returns a promise that is resolved when document is ready.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nexport function whenDocumentReady(doc) {\n  return new Promise(resolve => {\n    onDocumentReady(doc, resolve);\n  });\n}\n\n/**\n * Returns a promise that is resolved when document is complete.\n * @param {!Document} doc\n * @return {!Promise<!Document>}\n */\nexport function whenDocumentComplete(doc) {\n  return new Promise(resolve => {\n    onDocumentState(doc, isDocumentComplete, resolve);\n  });\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ActionTrust} from './action-constants';\nimport {\n  SOURCE_ORIGIN_PARAM,\n  assertHttpsUrl,\n  checkCorsUrl,\n  isProxyOrigin,\n} from './url';\nimport {Services} from './services';\nimport {dev, user, userAssert} from './log';\nimport {isExtensionScriptInNode} from './element-service';\n\n/**\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise}\n */\nexport function installGlobalSubmitListenerForDoc(ampdoc) {\n  // Register global submit event listener only if the amp-form\n  // extension is used. Allowing the usage of native forms, otherwise.\n  return isExtensionScriptInNode(ampdoc, 'amp-form').then(ampFormInstalled => {\n    if (ampFormInstalled) {\n      ampdoc\n        .getRootNode()\n        .addEventListener('submit', onDocumentFormSubmit_, true);\n    }\n  });\n}\n\n/**\n * Intercept any submit on the current document and prevent invalid submits from\n * going through.\n *\n * @param {!Event} e\n */\nexport function onDocumentFormSubmit_(e) {\n  if (e.defaultPrevented) {\n    return;\n  }\n\n  const form = dev().assertElement(e.target);\n  if (!form || form.tagName != 'FORM') {\n    return;\n  }\n\n  // amp-form extension will add novalidate to all forms to manually trigger\n  // validation. In that case `novalidate` doesn't have the same meaning.\n  const isAmpFormMarked = form.classList.contains('i-amphtml-form');\n  let shouldValidate;\n  if (isAmpFormMarked) {\n    shouldValidate = !form.hasAttribute('amp-novalidate');\n  } else {\n    shouldValidate = !form.hasAttribute('novalidate');\n  }\n\n  // Safari does not trigger validation check on submission, hence we\n  // trigger it manually. In other browsers this would never execute since\n  // the submit event wouldn't be fired if the form is invalid.\n  if (shouldValidate && form.checkValidity && !form.checkValidity()) {\n    e.preventDefault();\n  }\n\n  const inputs = form.elements;\n  for (let i = 0; i < inputs.length; i++) {\n    userAssert(\n      !inputs[i].name || inputs[i].name != SOURCE_ORIGIN_PARAM,\n      'Illegal input name, %s found: %s',\n      SOURCE_ORIGIN_PARAM,\n      inputs[i]\n    );\n  }\n\n  const action = form.getAttribute('action');\n  const actionXhr = form.getAttribute('action-xhr');\n  const method = (form.getAttribute('method') || 'GET').toUpperCase();\n\n  if (actionXhr) {\n    assertHttpsUrl(actionXhr, form, 'action-xhr');\n    userAssert(\n      !isProxyOrigin(actionXhr),\n      'form action-xhr should not be on AMP CDN: %s',\n      form\n    );\n    checkCorsUrl(actionXhr);\n  }\n  if (action) {\n    assertHttpsUrl(action, form, 'action');\n    userAssert(\n      !isProxyOrigin(action),\n      'form action should not be on AMP CDN: %s',\n      form\n    );\n    checkCorsUrl(action);\n  }\n\n  if (method == 'GET') {\n    userAssert(\n      actionXhr || action,\n      'form action-xhr or action attribute is required for method=GET: %s',\n      form\n    );\n  } else if (method == 'POST') {\n    if (action) {\n      const TAG = 'form';\n      user().error(\n        TAG,\n        'action attribute is invalid for method=POST: %s',\n        form\n      );\n    }\n\n    if (!actionXhr) {\n      e.preventDefault();\n      userAssert(\n        false,\n        'Only XHR based (via action-xhr attribute) submissions are support ' +\n          'for POST requests. %s',\n        form\n      );\n    }\n  }\n\n  const target = form.getAttribute('target');\n  if (target) {\n    userAssert(\n      target == '_blank' || target == '_top',\n      'form target=%s is invalid can only be _blank or _top: %s',\n      target,\n      form\n    );\n  } else {\n    form.setAttribute('target', '_top');\n  }\n\n  // For xhr submissions relay the submission event through action service to\n  // allow us to wait for amp-form (and possibly its dependencies) to execute\n  // the actual submission. For non-XHR GET we let the submission go through\n  // to allow _blank target to work.\n  if (actionXhr) {\n    e.preventDefault();\n\n    // It's important to stop propagation of the submission to avoid double\n    // handling of the event in cases were we are delegating to action service\n    // to deliver the submission event.\n    e.stopImmediatePropagation();\n\n    const actions = Services.actionServiceForDoc(form);\n    actions.execute(\n      form,\n      'submit',\n      /*args*/ null,\n      /*source*/ form,\n      /*caller*/ form,\n      e,\n      ActionTrust.HIGH\n    );\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './utils/promise';\nimport {\n  assertIsName,\n  isScopeSelectorSupported,\n  prependSelectorsWith,\n} from './css';\nimport {dev, devAssert} from './log';\nimport {dict} from './utils/object';\nimport {includes, startsWith} from './string';\nimport {toWin} from './types';\n\nconst HTML_ESCAPE_CHARS = {\n  '&': '&amp;',\n  '<': '&lt;',\n  '>': '&gt;',\n  '\"': '&quot;',\n  \"'\": '&#x27;',\n  '`': '&#x60;',\n};\nconst HTML_ESCAPE_REGEX = /(&|<|>|\"|'|`)/g;\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_PROMISE = '__AMP_UPG_PRM';\n\n/** @const {string} */\nexport const UPGRADE_TO_CUSTOMELEMENT_RESOLVER = '__AMP_UPG_RES';\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * callback is executed.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @param {function()} callback\n */\nexport function waitForChild(parent, checkFunc, callback) {\n  if (checkFunc(parent)) {\n    callback();\n    return;\n  }\n  /** @const {!Window} */\n  const win = toWin(parent.ownerDocument.defaultView);\n  if (win.MutationObserver) {\n    /** @const {MutationObserver} */\n    const observer = new win.MutationObserver(() => {\n      if (checkFunc(parent)) {\n        observer.disconnect();\n        callback();\n      }\n    });\n    observer.observe(parent, {childList: true});\n  } else {\n    /** @const {number} */\n    const interval = win.setInterval(() => {\n      if (checkFunc(parent)) {\n        win.clearInterval(interval);\n        callback();\n      }\n    }, /* milliseconds */ 5);\n  }\n}\n\n/**\n * Waits until the child element is constructed. Once the child is found, the\n * promise is resolved.\n * @param {!Element} parent\n * @param {function(!Element):boolean} checkFunc\n * @return {!Promise}\n */\nexport function waitForChildPromise(parent, checkFunc) {\n  return new Promise(resolve => {\n    waitForChild(parent, checkFunc, resolve);\n  });\n}\n\n/**\n * Waits for document's body to be available and ready.\n * @param {!Document} doc\n * @param {function()} callback\n */\nexport function waitForBodyOpen(doc, callback) {\n  waitForChild(doc.documentElement, () => !!doc.body, callback);\n}\n\n/**\n * Waits for document's body to be available.\n * @param {!Document} doc\n * @return {!Promise}\n */\nexport function waitForBodyOpenPromise(doc) {\n  return new Promise(resolve => waitForBodyOpen(doc, resolve));\n}\n\n/**\n * Removes the element.\n * @param {!Element} element\n */\nexport function removeElement(element) {\n  if (element.parentElement) {\n    element.parentElement.removeChild(element);\n  }\n}\n\n/**\n * Removes all child nodes of the specified element.\n * @param {!Element} parent\n */\nexport function removeChildren(parent) {\n  while (parent.firstChild) {\n    parent.removeChild(parent.firstChild);\n  }\n}\n\n/**\n * Copies all children nodes of element \"from\" to element \"to\". Child nodes\n * are deeply cloned. Notice, that this method should be used with care and\n * preferably on smaller subtrees.\n * @param {!Element} from\n * @param {!Element|!DocumentFragment} to\n */\nexport function copyChildren(from, to) {\n  const frag = to.ownerDocument.createDocumentFragment();\n  for (let n = from.firstChild; n; n = n.nextSibling) {\n    frag.appendChild(n.cloneNode(true));\n  }\n  to.appendChild(frag);\n}\n\n/**\n * Insert the element in the root after the element named after or\n * if that is null at the beginning.\n * @param {!Element|!ShadowRoot} root\n * @param {!Element} element\n * @param {?Node} after\n */\nexport function insertAfterOrAtStart(root, element, after) {\n  const before = after ? after.nextSibling : root.firstChild;\n  root.insertBefore(element, before);\n}\n\n/**\n * Add attributes to an element.\n * @param {!Element} element\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function addAttributesToElement(element, attributes) {\n  for (const attr in attributes) {\n    element.setAttribute(attr, attributes[attr]);\n  }\n  return element;\n}\n\n/**\n * Create a new element on document with specified tagName and attributes.\n * @param {!Document} doc\n * @param {string} tagName\n * @param {!JsonObject<string, string>} attributes\n * @return {!Element} created element\n */\nexport function createElementWithAttributes(doc, tagName, attributes) {\n  const element = doc.createElement(tagName);\n  return addAttributesToElement(element, attributes);\n}\n\n/**\n * Returns true if node is connected (attached).\n * @param {!Node} node\n * @return {boolean}\n * @see https://dom.spec.whatwg.org/#connected\n */\nexport function isConnectedNode(node) {\n  const connected = node.isConnected;\n  if (connected !== undefined) {\n    return connected;\n  }\n\n  // \"An element is connected if its shadow-including root is a document.\"\n  let n = node;\n  do {\n    n = rootNodeFor(n);\n    if (n.host) {\n      n = n.host;\n    } else {\n      break;\n    }\n  } while (true);\n  return n.nodeType === Node.DOCUMENT_NODE;\n}\n\n/**\n * Returns the root for a given node. Does not cross shadow DOM boundary.\n * @param {!Node} node\n * @return {!Node}\n */\nexport function rootNodeFor(node) {\n  if (Node.prototype.getRootNode) {\n    // Type checker says `getRootNode` may return null.\n    return node.getRootNode() || node;\n  }\n  let n;\n  // Check isShadowRoot() is only needed for the polyfill case.\n  for (n = node; !!n.parentNode && !isShadowRoot(n); n = n.parentNode) {}\n  return n;\n}\n\n/**\n * Determines if value is actually a `ShadowRoot` node.\n * @param {*} value\n * @return {boolean}\n */\nexport function isShadowRoot(value) {\n  // TODO(#22733): remove in preference to dom's `rootNodeFor`.\n  if (!value) {\n    return false;\n  }\n  // Node.nodeType == DOCUMENT_FRAGMENT to speed up the tests. Unfortunately,\n  // nodeType of DOCUMENT_FRAGMENT is used currently for ShadowRoot nodes.\n  if (value.tagName == 'I-AMPHTML-SHADOW-ROOT') {\n    return true;\n  }\n  return (\n    value.nodeType == /* DOCUMENT_FRAGMENT */ 11 &&\n    Object.prototype.toString.call(value) === '[object ShadowRoot]'\n  );\n}\n\n/**\n * Finds the closest element that satisfies the callback from this element\n * up the DOM subtree.\n * @param {!Element} element\n * @param {function(!Element):boolean} callback\n * @param {Element=} opt_stopAt optional elemnt to stop the search at.\n * @return {?Element}\n */\nexport function closest(element, callback, opt_stopAt) {\n  for (let el = element; el && el !== opt_stopAt; el = el.parentElement) {\n    if (callback(el)) {\n      return el;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest node that satisfies the callback from this node\n * up the DOM subtree.\n * @param {!Node} node\n * @param {function(!Node):boolean} callback\n * @return {?Node}\n */\nexport function closestNode(node, callback) {\n  for (let n = node; n; n = n.parentNode) {\n    if (callback(n)) {\n      return n;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds the closest ancestor element with the specified selector from this\n * element.\n * @param {!Element} element\n * @param {string} selector\n * @return {?Element} closest ancestor if found.\n */\nexport function closestAncestorElementBySelector(element, selector) {\n  if (element.closest) {\n    return element.closest(selector);\n  }\n\n  return closest(element, el => {\n    return matches(el, selector);\n  });\n}\n\n/**\n * Finds all ancestor elements that satisfy predicate.\n * @param {!Element} child\n * @param {function(!Element):boolean} predicate\n * @return {!Array<!Element>}\n */\nexport function ancestorElements(child, predicate) {\n  const ancestors = [];\n  for (\n    let ancestor = child.parentElement;\n    ancestor;\n    ancestor = ancestor.parentElement\n  ) {\n    if (predicate(ancestor)) {\n      ancestors.push(ancestor);\n    }\n  }\n  return ancestors;\n}\n\n/**\n * Finds all ancestor elements that has the specified tag name.\n * @param {!Element} child\n * @param {string} tagName\n * @return {!Array<!Element>}\n */\nexport function ancestorElementsByTag(child, tagName) {\n  assertIsName(tagName);\n  tagName = tagName.toUpperCase();\n  return ancestorElements(child, el => {\n    return el.tagName == tagName;\n  });\n}\n\n/**\n * Finds the first child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function childElement(parent, callback) {\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds all child elements that satisfy the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {!Array<!Element>}\n */\nexport function childElements(parent, callback) {\n  const children = [];\n  for (\n    let child = parent.firstElementChild;\n    child;\n    child = child.nextElementSibling\n  ) {\n    if (callback(child)) {\n      children.push(child);\n    }\n  }\n  return children;\n}\n\n/**\n * Finds the last child element that satisfies the callback.\n * @param {!Element} parent\n * @param {function(!Element):boolean} callback\n * @return {?Element}\n */\nexport function lastChildElement(parent, callback) {\n  for (\n    let child = parent.lastElementChild;\n    child;\n    child = child.previousElementSibling\n  ) {\n    if (callback(child)) {\n      return child;\n    }\n  }\n  return null;\n}\n\n/**\n * Finds all child nodes that satisfy the callback.\n * These nodes can include Text, Comment and other child nodes.\n * @param {!Node} parent\n * @param {function(!Node):boolean} callback\n * @return {!Array<!Node>}\n */\nexport function childNodes(parent, callback) {\n  const nodes = [];\n  for (let child = parent.firstChild; child; child = child.nextSibling) {\n    if (callback(child)) {\n      nodes.push(child);\n    }\n  }\n  return nodes;\n}\n\n/**\n * Finds the first child element that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function childElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelector(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the last child element that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {?Element}\n */\nexport function lastChildElementByAttr(parent, attr) {\n  assertIsName(attr);\n  return lastChildElement(parent, el => {\n    return el.hasAttribute(attr);\n  });\n}\n\n/**\n * Finds all child elements that has the specified attribute.\n * @param {!Element} parent\n * @param {string} attr\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByAttr(parent, attr) {\n  assertIsName(attr);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> [${attr}]`);\n}\n\n/**\n * Finds the first child element that has the specified tag name.\n * @param {!Element} parent\n * @param {string} tagName\n * @return {?Element}\n */\nexport function childElementByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelector(parent, `> ${tagName}`);\n}\n\n/**\n * Finds all child elements with the specified tag name.\n * @param {!Element} parent\n * @param {string} tagName\n * @return {!NodeList<!Element>}\n */\nexport function childElementsByTag(parent, tagName) {\n  assertIsName(tagName);\n  return /*OK*/ scopedQuerySelectorAll(parent, `> ${tagName}`);\n}\n\n/**\n * Checks if the given element matches the selector\n * @param  {!Element} el The element to verify\n * @param  {string} selector The selector to check against\n * @return {boolean} True if the element matched the selector. False otherwise.\n */\nexport function matches(el, selector) {\n  const matcher =\n    el.matches ||\n    el.webkitMatchesSelector ||\n    el.mozMatchesSelector ||\n    el.msMatchesSelector ||\n    el.oMatchesSelector;\n  if (matcher) {\n    return matcher.call(el, selector);\n  }\n  return false; // IE8 always returns false.\n}\n\n/**\n * Finds the first descendant element with the specified name.\n * @param {!Element|!Document|!ShadowRoot} element\n * @param {string} tagName\n * @return {?Element}\n */\nexport function elementByTag(element, tagName) {\n  assertIsName(tagName);\n  return element./*OK*/ querySelector(tagName);\n}\n\n/**\n * Finds all elements that matche `selector`, scoped inside `root`\n * for user-agents that do not support native scoping.\n *\n * This method isn't required for modern builds, can be removed.\n *\n * @param {!Element} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n */\nfunction scopedQuerySelectionFallback(root, selector) {\n  const unique = 'i-amphtml-scoped';\n  root.classList.add(unique);\n  const scopedSelector = prependSelectorsWith(selector, `.${unique}`);\n  const elements = root./*OK*/ querySelectorAll(scopedSelector);\n  root.classList.remove(unique);\n  return elements;\n}\n\n/**\n * Finds the first element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element} root\n * @param {string} selector\n * @return {?Element}\n */\nexport function scopedQuerySelector(root, selector) {\n  if (isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelector(prependSelectorsWith(selector, ':scope'));\n  }\n\n  // Only IE.\n  const fallbackResult = scopedQuerySelectionFallback(root, selector);\n  return fallbackResult[0] === undefined ? null : fallbackResult[0];\n}\n\n/**\n * Finds every element that matches `selector`, scoped inside `root`.\n * Note: in IE, this causes a quick mutation of the element's class list.\n * @param {!Element} root\n * @param {string} selector\n * @return {!NodeList<!Element>}\n */\nexport function scopedQuerySelectorAll(root, selector) {\n  if (isScopeSelectorSupported(root)) {\n    return root./*OK*/ querySelectorAll(\n      prependSelectorsWith(selector, ':scope')\n    );\n  }\n\n  // Only IE.\n  return scopedQuerySelectionFallback(root, selector);\n}\n\n/**\n * Returns element data-param- attributes as url parameters key-value pairs.\n * e.g. data-param-some-attr=value -> {someAttr: value}.\n * @param {!Element} element\n * @param {function(string):string=} opt_computeParamNameFunc to compute the\n *    parameter name, get passed the camel-case parameter name.\n * @param {!RegExp=} opt_paramPattern Regex pattern to match data attributes.\n * @return {!JsonObject}\n */\nexport function getDataParamsFromAttributes(\n  element,\n  opt_computeParamNameFunc,\n  opt_paramPattern\n) {\n  const computeParamNameFunc = opt_computeParamNameFunc || (key => key);\n  const {dataset} = element;\n  const params = dict();\n  const paramPattern = opt_paramPattern ? opt_paramPattern : /^param(.+)/;\n  for (const key in dataset) {\n    const matches = key.match(paramPattern);\n    if (matches) {\n      const param = matches[1][0].toLowerCase() + matches[1].substr(1);\n      params[computeParamNameFunc(param)] = dataset[key];\n    }\n  }\n  return params;\n}\n\n/**\n * Whether the element have a next node in the document order.\n * This means either:\n *  a. The element itself has a nextSibling.\n *  b. Any of the element ancestors has a nextSibling.\n * @param {!Element} element\n * @param {?Node} opt_stopNode\n * @return {boolean}\n */\nexport function hasNextNodeInDocumentOrder(element, opt_stopNode) {\n  let currentElement = element;\n  do {\n    if (currentElement.nextSibling) {\n      return true;\n    }\n  } while (\n    (currentElement = currentElement.parentNode) &&\n    currentElement != opt_stopNode\n  );\n  return false;\n}\n\n/**\n * Returns a clone of the content of a template element.\n *\n * Polyfill to replace .content access for browsers that do not support\n * HTMLTemplateElements natively.\n *\n * @param {!HTMLTemplateElement|!Element} template\n * @return {!DocumentFragment}\n */\nexport function templateContentClone(template) {\n  if ('content' in template) {\n    return template.content.cloneNode(true);\n  } else {\n    const content = template.ownerDocument.createDocumentFragment();\n    copyChildren(template, content);\n    return content;\n  }\n}\n\n/**\n * Iterate over an array-like.\n * Test cases: https://jsbench.github.io/#f638cacc866a1b2d6e517e6cfa900d6b\n * @param {!IArrayLike<T>} iterable\n * @param {function(T, number)} cb\n * @template T\n */\nexport function iterateCursor(iterable, cb) {\n  const {length} = iterable;\n  for (let i = 0; i < length; i++) {\n    cb(iterable[i], i);\n  }\n}\n\n/**\n * This method wraps around window's open method. It first tries to execute\n * `open` call with the provided target and if it fails, it retries the call\n * with the `_top` target. This is necessary given that in some embedding\n * scenarios, such as iOS' WKWebView, navigation to `_blank` and other targets\n * is blocked by default.\n *\n * @param {!Window} win\n * @param {string} url\n * @param {string} target\n * @param {string=} opt_features\n * @return {?Window}\n */\nexport function openWindowDialog(win, url, target, opt_features) {\n  // Try first with the specified target. If we're inside the WKWebView or\n  // a similar environments, this method is expected to fail by default for\n  // all targets except `_top`.\n  let res;\n  try {\n    res = win.open(url, target, opt_features);\n  } catch (e) {\n    dev().error('DOM', 'Failed to open url on target: ', target, e);\n  }\n\n  // Then try with `_top` target.\n  if (!res && target != '_top' && !includes(opt_features || '', 'noopener')) {\n    res = win.open(url, '_top');\n  }\n  return res;\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.hasAttribute('type') &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/JSON'\n  );\n}\n\n/**\n * Whether the element is a script tag with application/json type.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isJsonLdScriptTag(element) {\n  return (\n    element.tagName == 'SCRIPT' &&\n    element.getAttribute('type').toUpperCase() == 'APPLICATION/LD+JSON'\n  );\n}\n\n/**\n * Whether the page's direction is right to left or not.\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isRTL(doc) {\n  const dir =\n    doc.body.getAttribute('dir') ||\n    doc.documentElement.getAttribute('dir') ||\n    'ltr';\n  return dir == 'rtl';\n}\n\n/**\n * Escapes `<`, `>` and other HTML charcaters with their escaped forms.\n * @param {string} text\n * @return {string}\n */\nexport function escapeHtml(text) {\n  if (!text) {\n    return text;\n  }\n  return text.replace(HTML_ESCAPE_REGEX, escapeHtmlChar);\n}\n\n/**\n * @param {string} c\n * @return {string}\n */\nfunction escapeHtmlChar(c) {\n  return HTML_ESCAPE_CHARS[c];\n}\n\n/**\n * Tries to focus on the given element; fails silently if browser throws an\n * exception.\n * @param {!Element} element\n */\nexport function tryFocus(element) {\n  try {\n    element./*OK*/ focus();\n  } catch (e) {\n    // IE <= 7 may throw exceptions when focusing on hidden items.\n  }\n}\n\n/**\n * Whether the given window is in an iframe or not.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isIframed(win) {\n  return win.parent && win.parent != win;\n}\n\n/**\n * Determines if this element is an AMP element\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isAmpElement(element) {\n  const tag = element.tagName;\n  // Use prefix to recognize AMP element. This is necessary because stub\n  // may not be attached yet.\n  return (\n    startsWith(tag, 'AMP-') &&\n    // Some \"amp-*\" elements are not really AMP elements. :smh:\n    !(tag == 'AMP-STICKY-AD-TOP-PADDING' || tag == 'AMP-BODY')\n  );\n}\n\n/**\n * Return a promise that resolve when an AMP element upgrade from HTMLElement\n * to CustomElement\n * @param {!Element} element\n * @return {!Promise<!Element>}\n */\nexport function whenUpgradedToCustomElement(element) {\n  devAssert(isAmpElement(element), 'element is not AmpElement');\n  if (element.createdCallback) {\n    // Element already is CustomElement;\n    return Promise.resolve(element);\n  }\n  // If Element is still HTMLElement, wait for it to upgrade to customElement\n  // Note: use pure string to avoid obfuscation between versions.\n  if (!element[UPGRADE_TO_CUSTOMELEMENT_PROMISE]) {\n    const deferred = new Deferred();\n    element[UPGRADE_TO_CUSTOMELEMENT_PROMISE] = deferred.promise;\n    element[UPGRADE_TO_CUSTOMELEMENT_RESOLVER] = deferred.resolve;\n  }\n\n  return element[UPGRADE_TO_CUSTOMELEMENT_PROMISE];\n}\n\n/**\n * Replacement for `Element.requestFullscreen()` method.\n * https://developer.mozilla.org/en-US/docs/Web/API/Element/requestFullscreen\n * @param {!Element} element\n */\nexport function fullscreenEnter(element) {\n  const requestFs =\n    element.requestFullscreen ||\n    element.requestFullScreen ||\n    element.webkitRequestFullscreen ||\n    element.webkitEnterFullscreen ||\n    element.msRequestFullscreen ||\n    element.mozRequestFullScreen;\n  if (requestFs) {\n    requestFs.call(element);\n  }\n}\n\n/**\n * Replacement for `Document.exitFullscreen()` method.\n * https://developer.mozilla.org/en-US/docs/Web/API/Document/exitFullscreen\n * @param {!Element} element\n */\nexport function fullscreenExit(element) {\n  const elementBoundExit =\n    element.cancelFullScreen ||\n    element.exitFullscreen ||\n    element.webkitExitFullscreen ||\n    element.webkitCancelFullScreen ||\n    element.mozCancelFullScreen ||\n    element.msExitFullscreen;\n  if (elementBoundExit) {\n    elementBoundExit.call(element);\n    return;\n  }\n  const {ownerDocument} = element;\n  if (!ownerDocument) {\n    return;\n  }\n  const docBoundExit =\n    ownerDocument.cancelFullScreen ||\n    ownerDocument.exitFullscreencancelFullScreen ||\n    ownerDocument.webkitExitFullscreencancelFullScreen ||\n    ownerDocument.webkitCancelFullScreencancelFullScreen ||\n    ownerDocument.mozCancelFullScreencancelFullScreen ||\n    ownerDocument.msExitFullscreen;\n  if (docBoundExit) {\n    docBoundExit.call(ownerDocument);\n  }\n}\n\n/**\n * Replacement for `Document.fullscreenElement`.\n * https://developer.mozilla.org/en-US/docs/Web/API/Document/fullscreenElement\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isFullscreenElement(element) {\n  const {webkitDisplayingFullscreen} = element;\n  if (webkitDisplayingFullscreen !== undefined) {\n    return webkitDisplayingFullscreen;\n  }\n  const {ownerDocument} = element;\n  if (!ownerDocument) {\n    return false;\n  }\n  const fullscreenElement =\n    ownerDocument.fullscreenElement ||\n    ownerDocument.webkitFullscreenElement ||\n    ownerDocument.mozFullScreenElement ||\n    ownerDocument.webkitCurrentFullScreenElement;\n  return fullscreenElement == element;\n}\n\n/**\n * Returns true if node is not disabled.\n *\n * IE8 can return false positives, see {@link matches}.\n * @param {!Element} element\n * @return {boolean}\n * @see https://www.w3.org/TR/html5/forms.html#concept-fe-disabled\n */\nexport function isEnabled(element) {\n  return !(element.disabled || matches(element, ':disabled'));\n}\n\n/**\n * A sorting comparator that sorts elements in DOM tree order.\n * A first sibling is sorted to be before its nextSibling.\n * A parent node is sorted to be before a child.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/compareDocumentPosition\n *\n * @param {!Element} element1\n * @param {!Element} element2\n * @return {number}\n */\nexport function domOrderComparator(element1, element2) {\n  if (element1 === element2) {\n    return 0;\n  }\n\n  const pos = element1.compareDocumentPosition(element2);\n  const precedingOrContains =\n    Node.DOCUMENT_POSITION_PRECEDING | Node.DOCUMENT_POSITION_CONTAINS;\n\n  // if fe2 is preceding or contains fe1 then, fe1 is after fe2\n  if (pos & precedingOrContains) {\n    return 1;\n  }\n\n  // if fe2 is following or contained by fe1, then fe1 is before fe2\n  return -1;\n}\n\n/**\n * Like `Element.prototype.toggleAttribute`. This either toggles an attribute\n * on by adding an attribute with an empty value, or toggles it off by removing\n * the attribute. This does not mutate the element if the new state matches\n * the existing state.\n * @param {!Element} element An element to toggle the attribute for.\n * @param {string} name The name of the attribute.\n * @param {boolean=} forced Whether the attribute should be forced on/off. If\n *    not specified, it will be toggled from the current state.\n * @return {boolean} Whether or not the element now has the attribute.\n */\nexport function toggleAttribute(element, name, forced) {\n  const hasAttribute = element.hasAttribute(name);\n  const enabled = forced !== undefined ? forced : !hasAttribute;\n\n  if (enabled !== hasAttribute) {\n    if (enabled) {\n      element.setAttribute(name, '');\n    } else {\n      element.removeAttribute(name);\n    }\n  }\n\n  return enabled;\n}\n\n/**\n * @param {!Window} win\n * @return {number} The width of the vertical scrollbar, in pixels.\n */\nexport function getVerticalScrollbarWidth(win) {\n  const {documentElement} = win.document;\n  const windowWidth = win./*OK*/ innerWidth;\n  const documentWidth = documentElement./*OK*/ clientWidth;\n  return windowWidth - documentWidth;\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from './dom';\nimport {\n  getAmpdoc,\n  getExistingServiceForDocInEmbedScope,\n  getService,\n  getServicePromise,\n  getServicePromiseForDoc,\n  getServicePromiseOrNull,\n  getServicePromiseOrNullForDoc,\n  getTopWindow,\n} from './service';\nimport {toWin} from './types';\nimport {userAssert} from './log';\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\nexport function getElementService(win, id, extension, opt_element) {\n  return getElementServiceIfAvailable(win, id, extension, opt_element).then(\n    service => assertService(service, id, extension)\n  );\n}\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailable(win, id, extension, opt_element) {\n  const s = getServicePromiseOrNull(win, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  return getElementServicePromiseOrNull(win, id, extension, opt_element);\n}\n\n/**\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @return {boolean} Whether this element is scheduled to be loaded.\n */\nfunction isElementScheduled(win, elementName) {\n  // Set in custom-element.js\n  if (!win.__AMP_EXTENDED_ELEMENTS) {\n    return false;\n  }\n  return !!win.__AMP_EXTENDED_ELEMENTS[elementName];\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. Services.viewportForDoc(...)) for type safety and because the\n * factory should not be passed around.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an element,\n *     not the extension.\n * @return {!Promise<*>}\n */\nexport function getElementServiceForDoc(element, id, extension, opt_element) {\n  return getElementServiceIfAvailableForDoc(\n    element,\n    id,\n    extension,\n    opt_element\n  ).then(service => assertService(service, id, extension));\n}\n\n/**\n * Same as getElementService but produces null if the given element is not\n * actually available on the current page.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom extension that provides the\n *     implementation of this service.\n * @param {boolean=} opt_element Whether this service is provided by an\n *     element, not the extension.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDoc(\n  element,\n  id,\n  extension,\n  opt_element\n) {\n  const s = getServicePromiseOrNullForDoc(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (s);\n  }\n  const ampdoc = getAmpdoc(element);\n  return ampdoc\n    .waitForBodyOpen()\n    .then(() =>\n      waitForExtensionIfPresent(ampdoc.win, extension, ampdoc.win.document.head)\n    )\n    .then(() => {\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNullForDoc(element, id);\n      } else if (isElementScheduled(ampdoc.win, extension)) {\n        return getServicePromiseForDoc(element, id);\n      }\n      return null;\n    });\n}\n\n/**\n * Returns a promise for service for the given id in the embed scope of\n * a given element, if it exists. Falls back to ampdoc scope if the element\n * is not embedded.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id of the service.\n * @param {string} extension Name of the custom element that provides\n *     the implementation of this service.\n * @return {!Promise<?Object>}\n */\nexport function getElementServiceIfAvailableForDocInEmbedScope(\n  element,\n  id,\n  extension\n) {\n  const s = getExistingServiceForDocInEmbedScope(element, id);\n  if (s) {\n    return /** @type {!Promise<?Object>} */ (Promise.resolve(s));\n  }\n  const win = toWin(element.ownerDocument.defaultView);\n  const topWin = getTopWindow(win);\n  // In embeds, doc services are stored on the embed window.\n  if (win !== topWin) {\n    return getElementServicePromiseOrNull(win, id, extension);\n  } else {\n    // Only fallback to element's ampdoc (top-level) if not embedded.\n    return getElementServiceIfAvailableForDoc(element, id, extension);\n  }\n}\n\n/**\n * Throws user error if `service` is null.\n * @param {Object} service\n * @param {string} id\n * @param {string} extension\n * @return {!Object}\n * @private\n * @closurePrimitive {asserts.matchesReturn}\n */\nfunction assertService(service, id, extension) {\n  return /** @type {!Object} */ (userAssert(\n    service,\n    'Service %s was requested to be provided through %s, ' +\n      'but %s is not loaded in the current page. To fix this ' +\n      'problem load the JavaScript file for %s in this page.',\n    id,\n    extension,\n    extension,\n    extension\n  ));\n}\n\n/**\n * Get list of all the extension JS files.\n * @param {HTMLHeadElement|Element|ShadowRoot} head\n * @return {!Array<string>}\n */\nexport function extensionScriptsInNode(head) {\n  // ampdoc.getHeadNode() can return null.\n  if (!head) {\n    return [];\n  }\n  const scripts = {};\n  // Note: Some extensions don't have [custom-element] or [custom-template]\n  // e.g. amp-viewer-integration.\n  const list = head.querySelectorAll(\n    'script[custom-element],script[custom-template]'\n  );\n  for (let i = 0; i < list.length; i++) {\n    const script = list[i];\n    const name =\n      script.getAttribute('custom-element') ||\n      script.getAttribute('custom-template');\n    scripts[name] = true;\n  }\n  return Object.keys(scripts);\n}\n\n/**\n * Waits for body to be present then verifies that an extension script is\n * present in head for installation.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} extensionId\n * @return {!Promise<boolean>}\n */\nexport function isExtensionScriptInNode(ampdoc, extensionId) {\n  return ampdoc.waitForBodyOpen().then(() => {\n    return extensionScriptInNode(ampdoc.getHeadNode(), extensionId);\n  });\n}\n\n/**\n * Verifies that an extension script is present in head for\n * installation.\n * @param {HTMLHeadElement|Element|ShadowRoot} head\n * @param {string} extensionId\n * @return {boolean}\n * @private\n */\nfunction extensionScriptInNode(head, extensionId) {\n  return extensionScriptsInNode(head).includes(extensionId);\n}\n\n/**\n * Waits for an extension if its script is present\n * @param {!Window} win\n * @param {string} extension\n * @param {HTMLHeadElement|Element|ShadowRoot} head\n * @return {!Promise}\n * @private\n */\nfunction waitForExtensionIfPresent(win, extension, head) {\n  /**\n   * If there is an extension script wait for it to load before trying\n   * to get the service. Prevents a race condition when everything but\n   * the extensions is in cache. If there is no script then it's either\n   * not present, or the service was defined by a test. In those cases\n   * we don't wait around for an extension that does not exist.\n   */\n\n  // TODO(jpettitt) investigate registerExtension to short circuit\n  // the dom call in extensionScriptsInNode()\n  if (!extensionScriptInNode(head, extension)) {\n    return Promise.resolve();\n  }\n\n  const extensions = getService(win, 'extensions');\n  return /** @type {!Promise<?Object>} */ (extensions.waitForExtension(\n    win,\n    extension\n  ));\n}\n\n/**\n * Returns the promise for service with `id` on the given window if available.\n * Otherwise, resolves with null (service was not registered).\n * @param {!Window} win\n * @param {string} id\n * @param {string} extension\n * @param {boolean=} opt_element\n * @return {!Promise<Object>}\n * @private\n */\nfunction getElementServicePromiseOrNull(win, id, extension, opt_element) {\n  return dom\n    .waitForBodyOpenPromise(win.document)\n    .then(() => waitForExtensionIfPresent(win, extension, win.document.head))\n    .then(() => {\n      // If this service is provided by an element, then we can't depend on\n      // the service (they may not use the element).\n      if (opt_element) {\n        return getServicePromiseOrNull(win, id);\n      } else if (isElementScheduled(win, extension)) {\n        return getServicePromise(win, id);\n      }\n      return null;\n    });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {BaseElement} from './base-element';\nimport {devAssert} from './log';\n\n/** @type {!Array} */\nexport const stubbedElements = [];\n\nexport class ElementStub extends BaseElement {\n  /** @param {!AmpElement} element */\n  constructor(element) {\n    super(element);\n    stubbedElements.push(this);\n  }\n\n  /** @override */\n  getLayoutPriority() {\n    return devAssert(0, 'Cannot get priority of stubbed element');\n  }\n\n  /** @override */\n  isLayoutSupported(unusedLayout) {\n    // Always returns true and will eventually call this method on the actual\n    // element.\n    return true;\n  }\n\n  /** @override */\n  reconstructWhenReparented() {\n    // No real state so no reason to reconstruct.\n    return false;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {AmpEvents} from './amp-events';\nimport {Services} from './services';\nimport {\n  USER_ERROR_SENTINEL,\n  dev,\n  duplicateErrorIfNecessary,\n  isUserErrorEmbed,\n  isUserErrorMessage,\n} from './log';\nimport {dict} from './utils/object';\nimport {experimentTogglesOrNull, getBinaryType, isCanary} from './experiments';\nimport {exponentialBackoff} from './exponential-backoff';\nimport {getMode} from './mode';\nimport {isLoadErrorMessage} from './event-helper';\nimport {isProxyOrigin} from './url';\nimport {makeBodyVisibleRecovery} from './style-installer';\nimport {startsWith} from './string';\nimport {triggerAnalyticsEvent} from './analytics';\nimport {urls} from './config';\n\n/**\n * @const {string}\n */\nconst CANCELLED = 'CANCELLED';\n\n/**\n * @const {string}\n */\nconst BLOCK_BY_CONSENT = 'BLOCK_BY_CONSENT';\n\n/**\n * @const {string}\n */\nconst ABORTED = 'AbortError';\n\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\nconst NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD = 0.001;\n\n/**\n * The threshold for errors throttled because nothing can be done about\n * them, but we'd still like to report the rough number.\n * @const {number}\n */\nconst USER_ERROR_THROTTLE_THRESHOLD = 0.1;\n\n/**\n * Collects error messages, so they can be included in subsequent reports.\n * That allows identifying errors that might be caused by previous errors.\n */\nlet accumulatedErrorMessages = self.__AMP_ERRORS || [];\n// Use a true global, to avoid multi-module inclusion issues.\nself.__AMP_ERRORS = accumulatedErrorMessages;\n\n/**\n * Pushes element into array, keeping at most the most recent limit elements\n *\n * @param {!Array<T>} array\n * @param {T} element\n * @param {number} limit\n * @template T\n */\nfunction pushLimit(array, element, limit) {\n  if (array.length >= limit) {\n    array.splice(0, array.length - limit + 1);\n  }\n  array.push(element);\n}\n\n/**\n * A wrapper around our exponentialBackoff, to lazy initialize it to avoid an\n * un-DCE'able side-effect.\n * @param {function()} work the function to execute after backoff\n * @return {number} the setTimeout id\n */\nlet reportingBackoff = function(work) {\n  // Set reportingBackoff as the lazy-created function. JS Vooodoooo.\n  reportingBackoff = exponentialBackoff(1.5);\n  return reportingBackoff(work);\n};\n\n/**\n * Attempts to stringify a value, falling back to String.\n * @param {*} value\n * @return {string}\n */\nfunction tryJsonStringify(value) {\n  try {\n    // Cast is fine, because we really don't care here. Just trying.\n    return JSON.stringify(/** @type {!JsonObject} */ (value));\n  } catch (e) {\n    return String(value);\n  }\n}\n\n/**\n * The true JS engine, as detected by inspecting an Error stack. This should be\n * used with the userAgent to tell definitely. I.e., Chrome on iOS is really a\n * Safari JS engine.\n */\nlet detectedJsEngine;\n\n/**\n * @param {!Window} win\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n */\nexport function reportErrorForWin(win, error, opt_associatedElement) {\n  reportError(error, opt_associatedElement);\n  if (\n    error &&\n    !!win &&\n    isUserErrorMessage(error.message) &&\n    !isUserErrorEmbed(error.message)\n  ) {\n    reportErrorToAnalytics(/** @type {!Error} */ (error), win);\n  }\n}\n\n/**\n * Reports an error. If the error has an \"associatedElement\" property\n * the element is marked with the `i-amphtml-element-error` and displays\n * the message itself. The message is always send to the console.\n * If the error has a \"messageArray\" property, that array is logged.\n * This way one gets the native fidelity of the console for things like\n * elements instead of stringification.\n * @param {*} error\n * @param {!Element=} opt_associatedElement\n * @return {!Error}\n */\nexport function reportError(error, opt_associatedElement) {\n  try {\n    // Convert error to the expected type.\n    let isValidError;\n    if (error) {\n      if (error.message !== undefined) {\n        error = duplicateErrorIfNecessary(/** @type {!Error} */ (error));\n        isValidError = true;\n      } else {\n        const origError = error;\n        error = new Error(tryJsonStringify(origError));\n        error.origError = origError;\n      }\n    } else {\n      error = new Error('Unknown error');\n    }\n    // Report if error is not an expected type.\n    if (!isValidError && getMode().localDev && !getMode().test) {\n      setTimeout(function() {\n        const rethrow = new Error(\n          '_reported_ Error reported incorrectly: ' + error\n        );\n        throw rethrow;\n      });\n    }\n\n    if (error.reported) {\n      return /** @type {!Error} */ (error);\n    }\n    error.reported = true;\n\n    // Update element.\n    const element = opt_associatedElement || error.associatedElement;\n    if (element && element.classList) {\n      element.classList.add('i-amphtml-error');\n      if (getMode().development) {\n        element.classList.add('i-amphtml-element-error');\n        element.setAttribute('error-message', error.message);\n      }\n    }\n\n    // Report to console.\n    if (self.console) {\n      const output = console.error || console.log;\n      if (error.messageArray) {\n        output.apply(console, error.messageArray);\n      } else {\n        if (element) {\n          output.call(console, error.message, element);\n        } else if (!getMode().minified) {\n          output.call(console, error.stack);\n        } else {\n          output.call(console, error.message);\n        }\n      }\n    }\n    if (element && element.dispatchCustomEventForTesting) {\n      element.dispatchCustomEventForTesting(AmpEvents.ERROR, error.message);\n    }\n\n    // 'call' to make linter happy. And .call to make compiler happy\n    // that expects some @this.\n    onError['call'](\n      undefined,\n      undefined,\n      undefined,\n      undefined,\n      undefined,\n      error\n    );\n  } catch (errorReportingError) {\n    setTimeout(function() {\n      throw errorReportingError;\n    });\n  }\n  return /** @type {!Error} */ (error);\n}\n\n/**\n * Returns an error for a cancellation of a promise.\n * @return {!Error}\n */\nexport function cancellation() {\n  return new Error(CANCELLED);\n}\n\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\nexport function isCancellation(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n  if (typeof errorOrMessage == 'string') {\n    return startsWith(errorOrMessage, CANCELLED);\n  }\n  if (typeof errorOrMessage.message == 'string') {\n    return startsWith(errorOrMessage.message, CANCELLED);\n  }\n  return false;\n}\n\n/**\n * Returns an error for component blocked by consent\n * @return {!Error}\n */\nexport function blockedByConsentError() {\n  return new Error(BLOCK_BY_CONSENT);\n}\n\n/**\n * @param {*} errorOrMessage\n * @return {boolean}\n */\nexport function isBlockedByConsent(errorOrMessage) {\n  if (!errorOrMessage) {\n    return false;\n  }\n  if (typeof errorOrMessage == 'string') {\n    return startsWith(errorOrMessage, BLOCK_BY_CONSENT);\n  }\n  if (typeof errorOrMessage.message == 'string') {\n    return startsWith(errorOrMessage.message, BLOCK_BY_CONSENT);\n  }\n  return false;\n}\n\n/**\n * Install handling of global unhandled exceptions.\n * @param {!Window} win\n */\nexport function installErrorReporting(win) {\n  win.onerror = /** @type {!Function} */ (onError);\n  win.addEventListener('unhandledrejection', event => {\n    if (\n      event.reason &&\n      (event.reason.message === CANCELLED ||\n        event.reason.message === BLOCK_BY_CONSENT ||\n        event.reason.message === ABORTED)\n    ) {\n      event.preventDefault();\n      return;\n    }\n    reportError(event.reason || new Error('rejected promise ' + event));\n  });\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @this {!Window|undefined}\n */\nfunction onError(message, filename, line, col, error) {\n  // Make an attempt to unhide the body.\n  if (this && this.document) {\n    makeBodyVisibleRecovery(this.document);\n  }\n  if (getMode().localDev || getMode().development || getMode().test) {\n    return;\n  }\n  let hasNonAmpJs = false;\n  try {\n    hasNonAmpJs = detectNonAmpJs(self);\n  } catch (ignore) {\n    // Ignore errors during error report generation.\n  }\n  if (hasNonAmpJs && Math.random() > 0.01) {\n    // Only report 1% of errors on pages with non-AMP JS.\n    // These errors can almost never be acted upon, but spikes such as\n    // due to buggy browser extensions may be helpful to notify authors.\n    return;\n  }\n  const data = getErrorReportData(\n    message,\n    filename,\n    line,\n    col,\n    error,\n    hasNonAmpJs\n  );\n  if (data) {\n    reportingBackoff(() => {\n      try {\n        return reportErrorToServerOrViewer(\n          this,\n          /** @type {!JsonObject} */ (data)\n        ).catch(() => {\n          // catch async errors to avoid recursive errors.\n        });\n      } catch (e) {\n        // catch async errors to avoid recursive errors.\n      }\n    });\n  }\n}\n\n/**\n * Passes the given error data to either server or viewer.\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {Promise<undefined>}\n */\nexport function reportErrorToServerOrViewer(win, data) {\n  // Report the error to viewer if it has the capability. The data passed\n  // to the viewer is exactly the same as the data passed to the server\n  // below.\n  return maybeReportErrorToViewer(win, data).then(reportedErrorToViewer => {\n    if (!reportedErrorToViewer) {\n      const xhr = new XMLHttpRequest();\n      xhr.open('POST', urls.errorReporting, true);\n      xhr.send(JSON.stringify(data));\n    }\n  });\n}\n\n/**\n * Passes the given error data to the viewer if the following criteria is met:\n * - The viewer is a trusted viewer\n * - The viewer has the `errorReporter` capability\n * - The AMP doc is in single doc mode\n * - The AMP doc is opted-in for error interception (`<html>` tag has the\n *   `report-errors-to-viewer` attribute)\n *\n * @param {!Window} win\n * @param {!JsonObject} data Data from `getErrorReportData`.\n * @return {!Promise<boolean>} `Promise<True>` if the error was sent to the\n *     viewer, `Promise<False>` otherwise.\n * @visibleForTesting\n */\nexport function maybeReportErrorToViewer(win, data) {\n  const ampdocService = Services.ampdocServiceFor(win);\n  if (!ampdocService.isSingleDoc()) {\n    return Promise.resolve(false);\n  }\n  const ampdocSingle = ampdocService.getSingleDoc();\n  const htmlElement = ampdocSingle.getRootNode().documentElement;\n  const docOptedIn = htmlElement.hasAttribute('report-errors-to-viewer');\n  if (!docOptedIn) {\n    return Promise.resolve(false);\n  }\n  const viewer = Services.viewerForDoc(ampdocSingle);\n  if (!viewer.hasCapability('errorReporter')) {\n    return Promise.resolve(false);\n  }\n  return viewer.isTrustedViewer().then(viewerTrusted => {\n    if (!viewerTrusted) {\n      return false;\n    }\n    viewer.sendMessage('error', errorReportingDataForViewer(data));\n    return true;\n  });\n}\n\n/**\n * Strips down the error reporting data to a minimal set\n * to be sent to the viewer.\n * @param {!JsonObject} errorReportData\n * @return {!JsonObject}\n * @visibleForTesting\n */\nexport function errorReportingDataForViewer(errorReportData) {\n  return dict({\n    'm': errorReportData['m'], // message\n    'a': errorReportData['a'], // isUserError\n    's': errorReportData['s'], // error stack\n    'el': errorReportData['el'], // tagName\n    'ex': errorReportData['ex'], // expected error?\n    'v': errorReportData['v'], // runtime\n    'jse': errorReportData['jse'], // detectedJsEngine\n  });\n}\n\n/**\n * @param {string|undefined}  message\n * @param {*|undefined} error\n * @return {string}\n */\nfunction buildErrorMessage_(message, error) {\n  if (error) {\n    if (error.message) {\n      message = error.message;\n    } else {\n      // This should never be a string, but sometimes it is.\n      message = String(error);\n    }\n  }\n  if (!message) {\n    message = 'Unknown error';\n  }\n\n  return message;\n}\n\n/**\n * Signature designed, so it can work with window.onerror\n * @param {string|undefined} message\n * @param {string|undefined} filename\n * @param {string|undefined} line\n * @param {string|undefined} col\n * @param {*|undefined} error\n * @param {boolean} hasNonAmpJs\n * @return {!JsonObject|undefined} The data to post\n * visibleForTesting\n */\nexport function getErrorReportData(\n  message,\n  filename,\n  line,\n  col,\n  error,\n  hasNonAmpJs\n) {\n  message = buildErrorMessage_(message, error);\n  // An \"expected\" error is still an error, i.e. some features are disabled\n  // or not functioning fully because of it. However, it's an expected\n  // error. E.g. as is the case with some browser API missing (storage).\n  // Thus, the error can be classified differently by log aggregators.\n  // The main goal is to monitor that an \"expected\" error doesn't deteriorate\n  // over time. It's impossible to completely eliminate it.\n  let expected = !!(error && error.expected);\n  if (/_reported_/.test(message)) {\n    return;\n  }\n  if (message == CANCELLED) {\n    return;\n  }\n\n  const detachedWindow = !(self && self.window);\n  const throttleBase = Math.random();\n\n  // We throttle load errors and generic \"Script error.\" errors\n  // that have no information and thus cannot be acted upon.\n  if (\n    isLoadErrorMessage(message) ||\n    // See https://github.com/ampproject/amphtml/issues/7353\n    // for context.\n    message == 'Script error.' ||\n    // Window has become detached, really anything can happen\n    // at this point.\n    detachedWindow\n  ) {\n    expected = true;\n\n    if (throttleBase > NON_ACTIONABLE_ERROR_THROTTLE_THRESHOLD) {\n      return;\n    }\n  }\n\n  const isUserError = isUserErrorMessage(message);\n\n  // Only report a subset of user errors.\n  if (isUserError && throttleBase > USER_ERROR_THROTTLE_THRESHOLD) {\n    return;\n  }\n\n  // This is the App Engine app in\n  // https://github.com/ampproject/error-tracker\n  // It stores error reports via https://cloud.google.com/error-reporting/\n  // for analyzing production issues.\n  const data = /** @type {!JsonObject} */ (Object.create(null));\n  data['v'] = getMode().rtvVersion;\n  data['noAmp'] = hasNonAmpJs ? '1' : '0';\n  data['m'] = message.replace(USER_ERROR_SENTINEL, '');\n  data['a'] = isUserError ? '1' : '0';\n\n  // Errors are tagged with \"ex\" (\"expected\") label to allow loggers to\n  // classify these errors as benchmarks and not exceptions.\n  data['ex'] = expected ? '1' : '0';\n  data['dw'] = detachedWindow ? '1' : '0';\n\n  let runtime = '1p';\n  if (self.context && self.context.location) {\n    data['3p'] = '1';\n    runtime = '3p';\n  } else if (getMode().runtime) {\n    runtime = getMode().runtime;\n  }\n\n  if (getMode().singlePassType) {\n    data['spt'] = getMode().singlePassType;\n  }\n\n  data['rt'] = runtime;\n\n  // Add our a4a id if we are inabox\n  if (runtime === 'inabox') {\n    data['adid'] = getMode().a4aId;\n  }\n\n  // TODO(erwinm): Remove ca when all systems read `bt` instead of `ca` to\n  // identify js binary type.\n  data['ca'] = isCanary(self) ? '1' : '0';\n\n  // Pass binary type.\n  data['bt'] = getBinaryType(self);\n\n  if (self.location.ancestorOrigins && self.location.ancestorOrigins[0]) {\n    data['or'] = self.location.ancestorOrigins[0];\n  }\n  if (self.viewerState) {\n    data['vs'] = self.viewerState;\n  }\n  // Is embedded?\n  if (self.parent && self.parent != self) {\n    data['iem'] = '1';\n  }\n\n  if (self.AMP && self.AMP.viewer) {\n    const resolvedViewerUrl = self.AMP.viewer.getResolvedViewerUrl();\n    const messagingOrigin = self.AMP.viewer.maybeGetMessagingOrigin();\n    if (resolvedViewerUrl) {\n      data['rvu'] = resolvedViewerUrl;\n    }\n    if (messagingOrigin) {\n      data['mso'] = messagingOrigin;\n    }\n  }\n\n  if (!detectedJsEngine) {\n    detectedJsEngine = detectJsEngineFromStack();\n  }\n  data['jse'] = detectedJsEngine;\n\n  const exps = [];\n  const experiments = experimentTogglesOrNull(self);\n  for (const exp in experiments) {\n    const on = experiments[exp];\n    exps.push(`${exp}=${on ? '1' : '0'}`);\n  }\n  data['exps'] = exps.join(',');\n\n  if (error) {\n    const tagName = error.associatedElement\n      ? error.associatedElement.tagName\n      : 'u'; // Unknown\n    data['el'] = tagName;\n\n    if (error.args) {\n      data['args'] = JSON.stringify(error.args);\n    }\n\n    if (!isUserError && !error.ignoreStack && error.stack) {\n      data['s'] = error.stack;\n    }\n\n    // TODO(jridgewell, #18574); Make sure error is always an object.\n    if (error.message) {\n      error.message += ' _reported_';\n    }\n  } else {\n    data['f'] = filename || '';\n    data['l'] = line || '';\n    data['c'] = col || '';\n  }\n  data['r'] = self.document ? self.document.referrer : '';\n  data['ae'] = accumulatedErrorMessages.join(',');\n  data['fr'] = self.location.originalHash || self.location.hash;\n\n  pushLimit(accumulatedErrorMessages, message, 25);\n\n  return data;\n}\n\n/**\n * Returns true if it appears like there is non-AMP JS on the\n * current page.\n * @param {!Window} win\n * @return {boolean}\n * @visibleForTesting\n */\nexport function detectNonAmpJs(win) {\n  if (!win.document) {\n    return false;\n  }\n  const scripts = win.document.querySelectorAll('script[src]');\n  for (let i = 0; i < scripts.length; i++) {\n    if (!isProxyOrigin(scripts[i].src.toLowerCase())) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Resets accumulated error messages for testing\n */\nexport function resetAccumulatedErrorMessagesForTesting() {\n  accumulatedErrorMessages = [];\n}\n\n/**\n * Does a series of checks on the stack of an thrown error to determine the\n * JS engine that is currently running. This gives a bit more information than\n * just the UserAgent, since browsers often allow overriding it to \"emulate\"\n * mobile.\n * @return {string}\n * @visibleForTesting\n */\nexport function detectJsEngineFromStack() {\n  /** @constructor */\n  function Fn() {}\n  Fn.prototype.t = function() {\n    throw new Error('message');\n  };\n  const object = new Fn();\n  try {\n    object.t();\n  } catch (e) {\n    const {stack} = e;\n\n    // Safari only mentions the method name.\n    if (startsWith(stack, 't@')) {\n      return 'Safari';\n    }\n\n    // Firefox mentions \"prototype\".\n    if (stack.indexOf('.prototype.t@') > -1) {\n      return 'Firefox';\n    }\n\n    // IE looks like Chrome, but includes a context for the base stack line.\n    // Explicitly, we're looking for something like:\n    // \"    at Global code (https://example.com/app.js:1:200)\" or\n    // \"    at Anonymous function (https://example.com/app.js:1:200)\"\n    // vs Chrome which has:\n    // \"    at https://example.com/app.js:1:200\"\n    const last = stack.split('\\n').pop();\n    if (/\\bat .* \\(/i.test(last)) {\n      return 'IE';\n    }\n\n    // Finally, chrome includes the error message in the stack.\n    if (startsWith(stack, 'Error: message')) {\n      return 'Chrome';\n    }\n  }\n\n  return 'unknown';\n}\n\n/**\n * @param {!Error} error\n * @param {!Window} win\n */\nexport function reportErrorToAnalytics(error, win) {\n  // Currently this can only be executed in a single-doc mode. Otherwise,\n  // it's not clear which ampdoc the event would belong too.\n  if (Services.ampdocServiceFor(win).isSingleDoc()) {\n    const vars = dict({\n      'errorName': error.name,\n      'errorMessage': error.message,\n    });\n    triggerAnalyticsEvent(getRootElement_(win), 'user-error', vars);\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {!Element}\n * @private\n */\nfunction getRootElement_(win) {\n  const root = Services.ampdocServiceFor(win)\n    .getSingleDoc()\n    .getRootNode();\n  return dev().assertElement(root.documentElement || root.body || root);\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Whether addEventListener supports options or only takes capture as a boolean\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet optsSupported;\n\n/**\n * Listens for the specified event on the element.\n *\n * Do not use this directly. This method is implemented as a shared\n * dependency. Use `listen()` in either `event-helper` or `3p-frame-messaging`,\n * depending on your use case.\n *\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function internalListenImplementation(\n  element,\n  eventType,\n  listener,\n  opt_evtListenerOpts\n) {\n  let localElement = element;\n  let localListener = listener;\n  /**\n   * @type {?Function}\n   */\n  let wrapped;\n\n  wrapped = event => {\n    try {\n      return localListener(event);\n    } catch (e) {\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(e);\n      throw e;\n    }\n  };\n  const optsSupported = detectEvtListenerOptsSupport();\n  let capture = false;\n  if (opt_evtListenerOpts) {\n    capture = opt_evtListenerOpts.capture;\n  }\n  localElement.addEventListener(\n    eventType,\n    wrapped,\n    optsSupported ? opt_evtListenerOpts : capture\n  );\n  return () => {\n    if (localElement) {\n      localElement.removeEventListener(\n        eventType,\n        wrapped,\n        optsSupported ? opt_evtListenerOpts : capture\n      );\n    }\n    // Ensure these are GC'd\n    localListener = null;\n    localElement = null;\n    wrapped = null;\n  };\n}\n\n/**\n * Tests whether the browser supports options as an argument of addEventListener\n * or not.\n *\n * @return {boolean}\n */\nexport function detectEvtListenerOptsSupport() {\n  // Only run the test once\n  if (optsSupported !== undefined) {\n    return optsSupported;\n  }\n\n  optsSupported = false;\n  try {\n    // Test whether browser supports EventListenerOptions or not\n    const options = {\n      get capture() {\n        optsSupported = true;\n      },\n    };\n    self.addEventListener('test-options', null, options);\n    self.removeEventListener('test-options', null, options);\n  } catch (err) {\n    // EventListenerOptions are not supported\n  }\n  return optsSupported;\n}\n\n/**\n * Resets the test for whether addEventListener supports options or not.\n */\nexport function resetEvtListenerOptsSupportForTesting() {\n  optsSupported = undefined;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalListenImplementation} from './event-helper-listen';\nimport {lastChildElement} from './dom';\nimport {user} from './log';\n\n/** @const {string}  */\nconst LOAD_FAILURE_PREFIX = 'Failed to load:';\n\n/** @const {string} */\nexport const MEDIA_LOAD_FAILURE_SRC_PROPERTY = '__AMP_MEDIA_LOAD_FAILURE_SRC';\n\n/**\n * Returns a CustomEvent with a given type and detail; supports fallback for IE.\n * @param {!Window} win\n * @param {string} type\n * @param {!JsonObject|string|undefined|null} detail\n * @param {EventInit=} opt_eventInit\n * @return {!Event}\n */\nexport function createCustomEvent(win, type, detail, opt_eventInit) {\n  const eventInit = /** @type {!CustomEventInit} */ ({detail});\n  Object.assign(eventInit, opt_eventInit);\n  // win.CustomEvent is a function on Edge, Chrome, FF, Safari but\n  // is an object on IE 11.\n  if (typeof win.CustomEvent == 'function') {\n    return new win.CustomEvent(type, eventInit);\n  } else {\n    // Deprecated fallback for IE.\n    const e = win.document.createEvent('CustomEvent');\n    e.initCustomEvent(\n      type,\n      !!eventInit.bubbles,\n      !!eventInit.cancelable,\n      detail\n    );\n    return e;\n  }\n}\n\n/**\n * Listens for the specified event on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listen(element, eventType, listener, opt_evtListenerOpts) {\n  return internalListenImplementation(\n    element,\n    eventType,\n    listener,\n    opt_evtListenerOpts\n  );\n}\n\n/**\n * Returns the data property of an event with the correct type.\n * @param {!Event|{data: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getData(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.data);\n}\n\n/**\n * Returns the detail property of an event with the correct type.\n * @param {!Event|{detail: !JsonObject}} event\n * @return {?JsonObject|string|undefined}\n */\nexport function getDetail(event) {\n  return /** @type {?JsonObject|string|undefined} */ (event.detail);\n}\n\n/**\n * Listens for the specified event on the element and removes the listener\n * as soon as event has been received.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {function(!Event)} listener\n * @param {Object=} opt_evtListenerOpts\n * @return {!UnlistenDef}\n */\nexport function listenOnce(element, eventType, listener, opt_evtListenerOpts) {\n  let localListener = listener;\n  const unlisten = internalListenImplementation(\n    element,\n    eventType,\n    event => {\n      try {\n        localListener(event);\n      } finally {\n        // Ensure listener is GC'd\n        localListener = null;\n        unlisten();\n      }\n    },\n    opt_evtListenerOpts\n  );\n  return unlisten;\n}\n\n/**\n * Returns  a promise that will resolve as soon as the specified event has\n * fired on the element.\n * @param {!EventTarget} element\n * @param {string} eventType\n * @param {Object=} opt_evtListenerOpts\n * @param {function(!UnlistenDef)=} opt_cancel An optional function that, when\n *     provided, will be called with the unlistener. This gives the caller\n *     access to the unlistener, so it may be called manually when necessary.\n * @return {!Promise<!Event>}\n */\nexport function listenOncePromise(\n  element,\n  eventType,\n  opt_evtListenerOpts,\n  opt_cancel\n) {\n  let unlisten;\n  const eventPromise = new Promise(resolve => {\n    unlisten = listenOnce(element, eventType, resolve, opt_evtListenerOpts);\n  });\n  eventPromise.then(unlisten, unlisten);\n  if (opt_cancel) {\n    opt_cancel(unlisten);\n  }\n  return eventPromise;\n}\n\n/**\n * Whether the specified element/window has been loaded already.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nexport function isLoaded(eleOrWindow) {\n  return !!(\n    eleOrWindow.complete ||\n    eleOrWindow.readyState == 'complete' ||\n    (isHTMLMediaElement(eleOrWindow) && eleOrWindow.readyState > 0) ||\n    // If the passed in thing is a Window, infer loaded state from\n    //\n    (eleOrWindow.document && eleOrWindow.document.readyState == 'complete')\n  );\n}\n\n/**\n * Returns a promise that will resolve or fail based on the eleOrWindow's 'load'\n * and 'error' events. Optionally this method takes a timeout, which will reject\n * the promise if the resource has not loaded by then.\n * @param {T} eleOrWindow Supports both Elements and as a special case Windows.\n * @return {!Promise<T>}\n * @template T\n */\nexport function loadPromise(eleOrWindow) {\n  let unlistenLoad;\n  let unlistenError;\n  if (isLoaded(eleOrWindow)) {\n    return Promise.resolve(eleOrWindow);\n  }\n  const isMediaElement = isHTMLMediaElement(eleOrWindow);\n  if (\n    isMediaElement &&\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] === eleOrWindow.currentSrc\n  ) {\n    return Promise.reject(eleOrWindow);\n  }\n  const loadingPromise = new Promise((resolve, reject) => {\n    // Listen once since IE 5/6/7 fire the onload event continuously for\n    // animated GIFs.\n    if (isMediaElement) {\n      // The following event can be triggered by the media or one of its\n      // sources. Using capture is required as the media events do not bubble.\n      unlistenLoad = listenOnce(eleOrWindow, 'loadedmetadata', resolve, {\n        capture: true,\n      });\n    } else {\n      unlistenLoad = listenOnce(eleOrWindow, 'load', resolve);\n    }\n    // Don't unlisten on error for Windows.\n    if (!eleOrWindow.tagName) {\n      return;\n    }\n    let errorTarget = eleOrWindow;\n    // If the media element has no `src`, it will try to load the sources in\n    // document order. If the last source errors, then the media element\n    // loading errored.\n    if (isMediaElement && !eleOrWindow.hasAttribute('src')) {\n      errorTarget = lastChildElement(\n        eleOrWindow,\n        child => child.tagName === 'SOURCE'\n      );\n      if (!errorTarget) {\n        return reject(new Error('Media has no source.'));\n      }\n    }\n    unlistenError = listenOnce(errorTarget, 'error', reject);\n  });\n\n  return loadingPromise.then(\n    () => {\n      if (unlistenError) {\n        unlistenError();\n      }\n      return eleOrWindow;\n    },\n    () => {\n      if (unlistenLoad) {\n        unlistenLoad();\n      }\n      failedToLoad(eleOrWindow);\n    }\n  );\n}\n\n/**\n * Emit error on load failure.\n * @param {!Element|!Window} eleOrWindow Supports both Elements and as a special\n *     case Windows.\n */\nfunction failedToLoad(eleOrWindow) {\n  // Mark the element as errored since some elements - like HTMLMediaElement\n  // using HTMLSourceElement - do not provide any synchronous way to verify if\n  // they already errored, even though the error event was already dispatched.\n  if (isHTMLMediaElement(eleOrWindow)) {\n    eleOrWindow[MEDIA_LOAD_FAILURE_SRC_PROPERTY] =\n      eleOrWindow.currentSrc || true;\n  }\n\n  // Report failed loads as user errors so that they automatically go\n  // into the \"document error\" bucket.\n  let target = eleOrWindow;\n  if (target && target.src) {\n    target = target.src;\n  }\n  throw user().createError(LOAD_FAILURE_PREFIX, target);\n}\n\n/**\n * Returns true if the parameter is a HTMLMediaElement.\n * @param {!Element|!Window} eleOrWindow\n * @return {boolean}\n */\nfunction isHTMLMediaElement(eleOrWindow) {\n  return eleOrWindow.tagName === 'AUDIO' || eleOrWindow.tagName === 'VIDEO';\n}\n\n/**\n * Returns true if this error message is was created for a load error.\n * @param {string} message An error message\n * @return {boolean}\n */\nexport function isLoadErrorMessage(message) {\n  return message.indexOf(LOAD_FAILURE_PREFIX) != -1;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Experiments system allows a developer to opt-in to test\n * features that are not yet fully tested.\n *\n * Experiments page: https://cdn.ampproject.org/experiments.html *\n */\n\nimport {dev, user} from './log';\nimport {getMode} from './mode';\nimport {hasOwn} from './utils/object';\nimport {parseQueryString} from './url';\n\n/** @const {string} */\nconst TAG = 'EXPERIMENTS';\n\n/** @const {string} */\nconst LOCAL_STORAGE_KEY = 'amp-experiment-toggles';\n\n/** @const {string} */\nconst TOGGLES_WINDOW_PROPERTY = '__AMP__EXPERIMENT_TOGGLES';\n\n/**\n * @typedef {{\n *   isTrafficEligible: function(!Window):boolean,\n *   branches: !Array<string>\n * }}\n */\nexport let ExperimentInfo;\n\n/**\n * Whether we are in canary.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isCanary(win) {\n  return !!(win.AMP_CONFIG && win.AMP_CONFIG.canary);\n}\n\n/**\n * Returns binary type, e.g., canary, production, control, or rc.\n * @param {!Window} win\n * @return {string}\n */\nexport function getBinaryType(win) {\n  return win.AMP_CONFIG && win.AMP_CONFIG.type\n    ? win.AMP_CONFIG.type\n    : 'unknown';\n}\n\n/**\n * Whether the specified experiment is on or off.\n * @param {!Window} win\n * @param {string} experimentId\n * @return {boolean}\n */\nexport function isExperimentOn(win, experimentId) {\n  const toggles = experimentToggles(win);\n  return !!toggles[experimentId];\n}\n\n/**\n * Toggles the experiment on or off. Returns the actual value of the experiment\n * after toggling is done.\n * @param {!Window} win\n * @param {string} experimentId\n * @param {boolean=} opt_on\n * @param {boolean=} opt_transientExperiment  Whether to toggle the\n *     experiment state \"transiently\" (i.e., for this page load only) or\n *     durably (by saving the experiment IDs after toggling).\n *     Default: false (save durably).\n * @return {boolean} New state for experimentId.\n */\nexport function toggleExperiment(\n  win,\n  experimentId,\n  opt_on,\n  opt_transientExperiment\n) {\n  const currentlyOn = isExperimentOn(win, /*OK*/ experimentId);\n  const on = !!(opt_on !== undefined ? opt_on : !currentlyOn);\n  if (on != currentlyOn) {\n    const toggles = experimentToggles(win);\n    toggles[experimentId] = on;\n\n    if (!opt_transientExperiment) {\n      const storedToggles = getExperimentToggles(win);\n      storedToggles[experimentId] = on;\n      saveExperimentToggles(win, storedToggles);\n      // Avoid affecting tests that spy/stub warn().\n      if (!getMode().test) {\n        user().warn(\n          TAG,\n          '\"%s\" experiment %s for the domain \"%s\". See: https://amp.dev/documentation/guides-and-tutorials/learn/experimental',\n          experimentId,\n          on ? 'enabled' : 'disabled',\n          win.location.hostname\n        );\n      }\n    }\n  }\n  return on;\n}\n\n/**\n * Calculate whether the experiment is on or off based off of its default value,\n * stored overriden value, or the global config frequency given.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nexport function experimentToggles(win) {\n  if (win[TOGGLES_WINDOW_PROPERTY]) {\n    return win[TOGGLES_WINDOW_PROPERTY];\n  }\n  win[TOGGLES_WINDOW_PROPERTY] = Object.create(null);\n  const toggles = win[TOGGLES_WINDOW_PROPERTY];\n\n  // Read the default config of this build.\n  if (win.AMP_CONFIG) {\n    for (const experimentId in win.AMP_CONFIG) {\n      const frequency = win.AMP_CONFIG[experimentId];\n      if (typeof frequency === 'number' && frequency >= 0 && frequency <= 1) {\n        toggles[experimentId] = Math.random() < frequency;\n      }\n    }\n  }\n  // Read document level override from meta tag.\n  if (\n    win.AMP_CONFIG &&\n    Array.isArray(win.AMP_CONFIG['allow-doc-opt-in']) &&\n    win.AMP_CONFIG['allow-doc-opt-in'].length > 0\n  ) {\n    const allowed = win.AMP_CONFIG['allow-doc-opt-in'];\n    const meta = win.document.head.querySelector(\n      'meta[name=\"amp-experiments-opt-in\"]'\n    );\n    if (meta) {\n      const optedInExperiments = meta.getAttribute('content').split(',');\n      for (let i = 0; i < optedInExperiments.length; i++) {\n        if (allowed.indexOf(optedInExperiments[i]) != -1) {\n          toggles[optedInExperiments[i]] = true;\n        }\n      }\n    }\n  }\n\n  Object.assign(toggles, getExperimentToggles(win));\n\n  if (\n    win.AMP_CONFIG &&\n    Array.isArray(win.AMP_CONFIG['allow-url-opt-in']) &&\n    win.AMP_CONFIG['allow-url-opt-in'].length > 0\n  ) {\n    const allowed = win.AMP_CONFIG['allow-url-opt-in'];\n    const hash = win.location.originalHash || win.location.hash;\n    const params = parseQueryString(hash);\n    for (let i = 0; i < allowed.length; i++) {\n      const param = params[`e-${allowed[i]}`];\n      if (param == '1') {\n        toggles[allowed[i]] = true;\n      }\n      if (param == '0') {\n        toggles[allowed[i]] = false;\n      }\n    }\n  }\n  return toggles;\n}\n\n/**\n * Returns the cached experiments toggles, or null if they have not been\n * computed yet.\n * @param {!Window} win\n * @return {Object<string, boolean>}\n */\nexport function experimentTogglesOrNull(win) {\n  return win[TOGGLES_WINDOW_PROPERTY] || null;\n}\n\n/**\n * Returns a set of experiment IDs currently on.\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n */\nfunction getExperimentToggles(win) {\n  let experimentsString = '';\n  try {\n    if ('localStorage' in win) {\n      experimentsString = win.localStorage.getItem(LOCAL_STORAGE_KEY);\n    }\n  } catch (e) {\n    dev().warn(TAG, 'Failed to retrieve experiments from localStorage.');\n  }\n  const tokens = experimentsString ? experimentsString.split(/\\s*,\\s*/g) : [];\n\n  const toggles = Object.create(null);\n  for (let i = 0; i < tokens.length; i++) {\n    if (tokens[i].length == 0) {\n      continue;\n    }\n    if (tokens[i][0] == '-') {\n      toggles[tokens[i].substr(1)] = false;\n    } else {\n      toggles[tokens[i]] = true;\n    }\n  }\n  return toggles;\n}\n\n/**\n * Saves a set of experiment IDs currently on.\n * @param {!Window} win\n * @param {!Object<string, boolean>} toggles\n */\nfunction saveExperimentToggles(win, toggles) {\n  const experimentIds = [];\n  for (const experiment in toggles) {\n    experimentIds.push((toggles[experiment] === false ? '-' : '') + experiment);\n  }\n  try {\n    if ('localStorage' in win) {\n      win.localStorage.setItem(LOCAL_STORAGE_KEY, experimentIds.join(','));\n    }\n  } catch (e) {\n    user().error(TAG, 'Failed to save experiments to localStorage.');\n  }\n}\n\n/**\n * See getExperimentToggles().\n * @param {!Window} win\n * @return {!Object<string, boolean>}\n * @visibleForTesting\n */\nexport function getExperimentTogglesForTesting(win) {\n  return getExperimentToggles(win);\n}\n\n/**\n * Resets the experimentsToggle cache for testing purposes.\n * @param {!Window} win\n * @visibleForTesting\n */\nexport function resetExperimentTogglesForTesting(win) {\n  saveExperimentToggles(win, {});\n  win[TOGGLES_WINDOW_PROPERTY] = null;\n}\n\n/**\n * In some browser implementations of Math.random(), sequential calls of\n * Math.random() are correlated and can cause a bias.  In particular,\n * if the previous random() call was < 0.001 (as it will be if we select\n * into an experiment), the next value could be less than 0.5 more than\n * 50.7% of the time.  This provides an implementation that roots down into\n * the crypto API, when available, to produce less biased samples.\n *\n * @return {number} Pseudo-random floating-point value on the range [0, 1).\n */\nfunction slowButAccuratePrng() {\n  // TODO(tdrl): Implement.\n  return Math.random();\n}\n\n/**\n * Container for alternate random number generator implementations.  This\n * allows us to set an \"accurate\" PRNG for branch selection, but to mock it\n * out easily in tests.\n *\n * @visibleForTesting\n * @const {!{accuratePrng: function():number}}\n */\nexport const RANDOM_NUMBER_GENERATORS = {\n  accuratePrng: slowButAccuratePrng,\n};\n\n/**\n * Selects, uniformly at random, a single item from the array.\n * @param {!Array<string>} arr Object to select from.\n * @return {?string} Single item from arr or null if arr was empty.\n */\nfunction selectRandomItem(arr) {\n  const rn = RANDOM_NUMBER_GENERATORS.accuratePrng();\n  return arr[Math.floor(rn * arr.length)] || null;\n}\n\n/**\n * Selects which page-level experiment branches are enabled. If a given\n * experiment name is already set (including to the null / no branches selected\n * state), this won't alter its state.\n *\n * Check whether a given experiment is set using isExperimentOn(win,\n * experimentName) and, if it is on, look for which branch is selected in\n * win.__AMP_EXPERIMENT_BRANCHES[experimentName].\n *\n * @param {!Window} win Window context on which to save experiment\n *     selection state.\n * @param {!Object<string, !ExperimentInfo>} experiments  Set of experiments to\n *     configure for this page load.\n * @return {!Object<string, string>} Map of experiment names to selected\n *     branches.\n */\nexport function randomlySelectUnsetExperiments(win, experiments) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  const selectedExperiments = {};\n  for (const experimentName in experiments) {\n    // Skip experimentName if it is not a key of experiments object or if it\n    // has already been populated by some other property.\n    if (!hasOwn(experiments, experimentName)) {\n      continue;\n    }\n    if (hasOwn(win.__AMP_EXPERIMENT_BRANCHES, experimentName)) {\n      selectedExperiments[experimentName] =\n        win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n      continue;\n    }\n\n    if (\n      !experiments[experimentName].isTrafficEligible ||\n      !experiments[experimentName].isTrafficEligible(win)\n    ) {\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = null;\n      continue;\n    }\n\n    // If we're in the experiment, but we haven't already forced a specific\n    // experiment branch (e.g., via a test setup), then randomize the branch\n    // choice.\n    if (\n      !win.__AMP_EXPERIMENT_BRANCHES[experimentName] &&\n      isExperimentOn(win, /*OK*/ experimentName)\n    ) {\n      const {branches} = experiments[experimentName];\n      win.__AMP_EXPERIMENT_BRANCHES[experimentName] = selectRandomItem(\n        branches\n      );\n      selectedExperiments[experimentName] =\n        win.__AMP_EXPERIMENT_BRANCHES[experimentName];\n    }\n  }\n  return selectedExperiments;\n}\n\n/**\n * Returns the experiment branch enabled for the given experiment ID.\n * For example, 'control' or 'experiment'.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @return {?string} Active experiment branch ID for experimentName (possibly\n *     null if experimentName has been tested but no branch was enabled).\n */\nexport function getExperimentBranch(win, experimentName) {\n  return win.__AMP_EXPERIMENT_BRANCHES\n    ? win.__AMP_EXPERIMENT_BRANCHES[experimentName]\n    : null;\n}\n\n/**\n * Force enable (or disable) a specific branch of a given experiment name.\n * Disables the experiment name altogether if branchId is falseish.\n *\n * @param {!Window} win Window context to check for experiment state.\n * @param {string} experimentName Name of the experiment to check.\n * @param {?string} branchId ID of branch to force or null to disable\n *     altogether.\n * @visibleForTesting\n */\nexport function forceExperimentBranch(win, experimentName, branchId) {\n  win.__AMP_EXPERIMENT_BRANCHES = win.__AMP_EXPERIMENT_BRANCHES || {};\n  toggleExperiment(win, experimentName, !!branchId, true);\n  win.__AMP_EXPERIMENT_BRANCHES[experimentName] = branchId;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {number=} opt_base Exponential base. Defaults to 2.\n * @return {function(function()): number} Function that when invoked will\n *     call the passed in function. On every invocation the next\n *     invocation of the passed in function will be exponentially\n *     later. Returned function returns timeout id.\n */\nexport function exponentialBackoff(opt_base) {\n  const getTimeout = exponentialBackoffClock(opt_base);\n  return work => {\n    return setTimeout(work, getTimeout());\n  };\n}\n\n/**\n * @param {number=} opt_base Exponential base. Defaults to 2.\n * @return {function(): number} Function that when invoked will return\n *    a number that exponentially grows per invocation.\n */\nexport function exponentialBackoffClock(opt_base) {\n  const base = opt_base || 2;\n  let count = 0;\n  return () => {\n    let wait = Math.pow(base, count++);\n    wait += getJitter(wait);\n    return wait * 1000;\n  };\n}\n\n/**\n * Add jitter to avoid the thundering herd. This can e.g. happen when\n * we poll a backend and it fails for everyone at the same time.\n * We add up to 30% (default) longer or shorter than the given time.\n *\n * @param {number} wait the amount if base milliseconds\n * @param {number=} opt_perc the min/max percentage to add or sutract\n * @return {number}\n */\nexport function getJitter(wait, opt_perc) {\n  opt_perc = opt_perc || 0.3;\n  let jitter = wait * opt_perc * Math.random();\n  if (Math.random() > 0.5) {\n    jitter *= -1;\n  }\n  return jitter;\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommonSignals} from './common-signals';\nimport {Services} from './services';\nimport {createElementWithAttributes, removeElement} from './dom';\nimport {devAssert} from './log';\nimport {dict} from './utils/object';\nimport {isArray, toWin} from './types';\nimport {triggerAnalyticsEvent} from './analytics';\n\n/**\n * Method to create scoped analytics element for any element.\n * TODO: Make this function private\n * @param {!Element} parentElement\n * @param {!JsonObject} config\n * @param {boolean=} loadAnalytics\n * @param {boolean=} disableImmediate\n * @return {!Element} created analytics element\n */\nexport function insertAnalyticsElement(\n  parentElement,\n  config,\n  loadAnalytics = false,\n  disableImmediate = false\n) {\n  const doc = /** @type {!Document} */ (parentElement.ownerDocument);\n  const analyticsElem = createElementWithAttributes(\n    doc,\n    'amp-analytics',\n    dict({\n      'sandbox': 'true',\n      'trigger': disableImmediate ? '' : 'immediate',\n    })\n  );\n  const scriptElem = createElementWithAttributes(\n    doc,\n    'script',\n    dict({\n      'type': 'application/json',\n    })\n  );\n  scriptElem.textContent = JSON.stringify(config);\n  analyticsElem.appendChild(scriptElem);\n  analyticsElem.CONFIG = config;\n\n  // Force load analytics extension if script not included in page.\n  if (loadAnalytics) {\n    // Get Extensions service and force load analytics extension.\n    const extensions = Services.extensionsFor(\n      toWin(parentElement.ownerDocument.defaultView)\n    );\n    const ampdoc = Services.ampdoc(parentElement);\n    extensions./*OK*/ installExtensionForDoc(ampdoc, 'amp-analytics');\n  } else {\n    Services.analyticsForDocOrNull(parentElement).then(analytics => {\n      devAssert(analytics);\n    });\n  }\n  parentElement.appendChild(analyticsElem);\n  return analyticsElem;\n}\n\n/**\n * A class that handles customEvent reporting of extension element through\n * amp-analytics. This class is not exposed to extension element directly to\n * restrict the genration of the config Please use CustomEventReporterBuilder to\n * build a CustomEventReporter instance.\n */\nclass CustomEventReporter {\n  /**\n   * @param {!Element} parent\n   * @param {!JsonObject} config\n   */\n  constructor(parent, config) {\n    devAssert(config['triggers'], 'Config must have triggers defined');\n    /** @private {string} */\n    this.id_ = parent.getResourceId();\n\n    /** @private {!AmpElement} */\n    this.parent_ = parent;\n\n    /** @private {JsonObject} */\n    this.config_ = config;\n\n    for (const event in config['triggers']) {\n      const eventType = config['triggers'][event]['on'];\n      devAssert(\n        eventType,\n        'CustomEventReporter config must specify trigger eventType'\n      );\n      const newEventType = this.getEventTypeInSandbox_(eventType);\n      config['triggers'][event]['on'] = newEventType;\n    }\n\n    this.parent_\n      .signals()\n      .whenSignal(CommonSignals.LOAD_START)\n      .then(() => {\n        insertAnalyticsElement(this.parent_, config, true);\n      });\n  }\n\n  /**\n   * @param {string} eventType\n   * @param {!JsonObject=} opt_vars A map of vars and their values.\n   */\n  trigger(eventType, opt_vars) {\n    devAssert(\n      this.config_['triggers'][eventType],\n      'Cannot trigger non initiated eventType'\n    );\n    triggerAnalyticsEvent(\n      this.parent_,\n      this.getEventTypeInSandbox_(eventType),\n      opt_vars\n    );\n  }\n  /**\n   * @param {string} eventType\n   * @return {string}\n   */\n  getEventTypeInSandbox_(eventType) {\n    return `sandbox-${this.id_}-${eventType}`;\n  }\n}\n\n/**\n * A builder class that enable extension elements to easily build and get a\n * CustomEventReporter instance. Its constructor requires the parent AMP\n * element. It provides two methods #track() and #build() to build the\n * CustomEventReporter instance.\n */\nexport class CustomEventReporterBuilder {\n  /** @param {!AmpElement} parent */\n  constructor(parent) {\n    /** @private {!AmpElement} */\n    this.parent_ = parent;\n\n    /** @private {?JsonObject} */\n    this.config_ = /** @type {JsonObject} */ ({\n      'requests': {},\n      'triggers': {},\n    });\n  }\n\n  /**\n   * @param {!JsonObject} transportConfig\n   */\n  setTransportConfig(transportConfig) {\n    this.config_['transport'] = transportConfig;\n  }\n\n  /**\n   * @param {!JsonObject} extraUrlParamsConfig\n   */\n  setExtraUrlParams(extraUrlParamsConfig) {\n    this.config_['extraUrlParams'] = extraUrlParamsConfig;\n  }\n\n  /**\n   * The #track() method takes in a unique custom-event name, and the\n   * corresponding request url (or an array of request urls). One can call\n   * #track() multiple times with different eventType name (order doesn't\n   * matter) before #build() is called.\n   * @param {string} eventType\n   * @param {string|!Array<string>} request\n   * @return {!CustomEventReporterBuilder}\n   */\n  track(eventType, request) {\n    request = isArray(request) ? request : [request];\n    devAssert(\n      !this.config_['triggers'][eventType],\n      'customEventReporterBuilder should not track same eventType twice'\n    );\n    const requestList = [];\n    for (let i = 0; i < request.length; i++) {\n      const requestName = `${eventType}-request-${i}`;\n      this.config_['requests'][requestName] = request[i];\n      requestList.push(requestName);\n    }\n    this.config_['triggers'][eventType] = {\n      'on': eventType,\n      'request': requestList,\n    };\n    return this;\n  }\n\n  /**\n   * Call the #build() method to build and get the CustomEventReporter instance.\n   * One CustomEventReporterBuilder instance can only build one reporter, which\n   * means #build() should only be called once after all eventType are added.\n   * @return {!CustomEventReporter}\n   */\n  build() {\n    devAssert(this.config_, 'CustomEventReporter already built');\n    const report = new CustomEventReporter(\n      this.parent_,\n      /** @type {!JsonObject} */ (this.config_)\n    );\n    this.config_ = null;\n    return report;\n  }\n}\n\n/**\n * A helper method that should be used by all extension elements to add their\n * sandbox analytics tracking. This method takes care of insert and remove the\n * analytics tracker at the right time of the element lifecycle.\n * @param {!AmpElement} element\n * @param {!Promise<!JsonObject>} promise\n */\nexport function useAnalyticsInSandbox(element, promise) {\n  let analyticsElement = null;\n  let configPromise = promise;\n  // Listener to LOAD_START signal. Insert analytics element on LOAD_START\n  element\n    .signals()\n    .whenSignal(CommonSignals.LOAD_START)\n    .then(() => {\n      if (analyticsElement || !configPromise) {\n        return;\n      }\n      configPromise.then(config => {\n        if (!configPromise) {\n          // If config promise resolve after unload, do nothing.\n          return;\n        }\n        configPromise = null;\n        analyticsElement = insertAnalyticsElement(element, config, false);\n      });\n    });\n\n  // Listener to UNLOAD signal. Destroy remove element on UNLOAD\n  element\n    .signals()\n    .whenSignal(CommonSignals.UNLOAD)\n    .then(() => {\n      configPromise = null;\n      if (analyticsElement) {\n        removeElement(analyticsElement);\n        analyticsElement = null;\n      }\n    });\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from './log';\n\n/**\n * @template STATE\n */\nexport class FiniteStateMachine {\n  /**\n   * Constructs a FSM using the bits defined in initialState as changeable\n   * states.\n   * @param {STATE} initialState\n   */\n  constructor(initialState) {\n    /**\n     * The current state of the FSM\n     * @private {STATE}\n     */\n    this.state_ = initialState;\n\n    /**\n     * Callbacks that are invoked when transitioning from an old state\n     * to the new.\n     * @private {Object<string, function()>}\n     */\n    this.transitions_ = Object.create(null);\n  }\n\n  /**\n   * Adds a transition callback that will be called when the oldState\n   * transitions to the newState.\n   * @param {STATE} oldState\n   * @param {STATE} newState\n   * @param {function()} callback\n   */\n  addTransition(oldState, newState, callback) {\n    const transition = this.statesToTransition_(oldState, newState);\n    devAssert(\n      !this.transitions_[transition],\n      'cannot define a duplicate transition callback'\n    );\n    this.transitions_[transition] = callback;\n  }\n\n  /**\n   * Transitions to the newState and invokes the registered transition\n   * callback, if one is defined.\n   * @param {STATE} newState\n   */\n  setState(newState) {\n    const oldState = this.state_;\n    this.state_ = newState;\n\n    const transition = this.statesToTransition_(oldState, newState);\n    const callback = this.transitions_[transition];\n\n    if (callback) {\n      callback();\n    }\n  }\n\n  /**\n   * Transforms the state transition into a key which identifies a callback.\n   * @private\n   * @param {STATE} oldState\n   * @param {STATE} newState\n   * @return {string}\n   */\n  statesToTransition_(oldState, newState) {\n    return `${oldState}|${newState}`;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from './observable';\nimport {Services} from './services';\nimport {dev} from './log';\n\n/**\n * FocusHistory keeps track of recent focused elements. This history can be\n * purged using `purgeBefore` method.\n */\nexport class FocusHistory {\n  /**\n   * @param {!Window} win\n   * @param {number} purgeTimeout\n   */\n  constructor(win, purgeTimeout) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {number} */\n    this.purgeTimeout_ = purgeTimeout;\n\n    /** @private @const {!Array<!{el: !Element, time: time}>} */\n    this.history_ = [];\n\n    /** @private @const {!Observable<!Element>} */\n    this.observeFocus_ = new Observable();\n\n    /**\n     * @private\n     * @param {!Event} e\n     */\n    this.captureFocus_ = e => {\n      // Hack (#15079) due to Firefox firing focus events on the entire page\n      if (e.target && e.target.nodeType == 1) {\n        this.pushFocus_(dev().assertElement(e.target));\n      }\n    };\n\n    /**\n     * @private\n     * @param {*} unusedE\n     */\n    this.captureBlur_ = unusedE => {\n      // IFrame elements do not receive `focus` event. An alternative way is\n      // implemented here. We wait for a blur to arrive on the main window\n      // and after a short time check which element is active.\n      Services.timerFor(win).delay(() => {\n        this.pushFocus_(dev().assertElement(this.win.document.activeElement));\n      }, 500);\n    };\n    this.win.document.addEventListener('focus', this.captureFocus_, true);\n    this.win.addEventListener('blur', this.captureBlur_);\n  }\n\n  /** @visibleForTesting */\n  cleanup_() {\n    this.win.document.removeEventListener('focus', this.captureFocus_, true);\n    this.win.removeEventListener('blur', this.captureBlur_);\n  }\n\n  /**\n   * Add a listener for focus events.\n   * @param {function(!Element)} handler\n   * @return {!UnlistenDef}\n   */\n  onFocus(handler) {\n    return this.observeFocus_.add(handler);\n  }\n\n  /**\n   * @param {!Element} element\n   * @private\n   */\n  pushFocus_(element) {\n    const now = Date.now();\n    if (\n      this.history_.length == 0 ||\n      this.history_[this.history_.length - 1].el != element\n    ) {\n      this.history_.push({el: element, time: now});\n    } else {\n      this.history_[this.history_.length - 1].time = now;\n    }\n    this.purgeBefore(now - this.purgeTimeout_);\n    this.observeFocus_.fire(element);\n  }\n\n  /**\n   * Returns the element that was focused last.\n   * @return {?Element}\n   */\n  getLast() {\n    if (this.history_.length == 0) {\n      return null;\n    }\n    return this.history_[this.history_.length - 1].el;\n  }\n\n  /**\n   * Removes elements from the history older than the specified time.\n   * @param {time} time\n   */\n  purgeBefore(time) {\n    let index = this.history_.length - 1;\n    for (let i = 0; i < this.history_.length; i++) {\n      if (this.history_[i].time >= time) {\n        index = i - 1;\n        break;\n      }\n    }\n    if (index != -1) {\n      this.history_.splice(0, index + 1);\n    }\n  }\n\n  /**\n   * Returns `true` if the specified element contains any of the elements in\n   * the history.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  hasDescendantsOf(element) {\n    if (this.win.document.activeElement) {\n      this.pushFocus_(this.win.document.activeElement);\n    }\n    for (let i = 0; i < this.history_.length; i++) {\n      if (element.contains(this.history_[i].el)) {\n        return true;\n      }\n    }\n    return false;\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {getFormAsObject, getSubmitButtonUsed} from './form';\nimport {iterateCursor} from './dom';\nimport {map} from './utils/object';\n\n/**\n * Create a form data wrapper. The wrapper is necessary to provide a common\n * API for FormData objects on all browsers. For example, not all browsers\n * support the FormData#entries or FormData#delete functions.\n *\n * @param {!Window} win\n * @param {!HTMLFormElement=} opt_form\n * @return {!FormDataWrapperInterface}\n */\nexport function createFormDataWrapper(win, opt_form) {\n  const platform = Services.platformFor(win);\n\n  if (platform.isIos() && platform.getMajorVersion() == 11) {\n    return new Ios11NativeFormDataWrapper(opt_form);\n  } else if (FormData.prototype.entries && FormData.prototype.delete) {\n    return new NativeFormDataWrapper(opt_form);\n  } else {\n    return new PolyfillFormDataWrapper(opt_form);\n  }\n}\n\n/**\n * Check if the given object is a FormDataWrapper instance\n * @param {*} o\n * @return {boolean} True if the object is a FormDataWrapper instance.\n */\nexport function isFormDataWrapper(o) {\n  // instanceof doesn't work as expected, so we detect with duck-typing.\n  return !!o && typeof o.getFormData == 'function';\n}\n\n/**\n * A polyfill wrapper for a `FormData` object.\n *\n * If there's no native `FormData#entries`, chances are there are no native\n * methods to read the content of the `FormData` after construction, so the\n * only way to implement `entries` in this class is to capture the fields in\n * the form passed to the constructor (and the arguments passed to the\n * `append` method).\n *\n * For more details on this, see http://mdn.io/FormData.\n *\n * @implements {FormDataWrapperInterface}\n * @visibleForTesting\n */\nexport class PolyfillFormDataWrapper {\n  /** @override */\n  constructor(opt_form = undefined) {\n    /** @private @const {!Object<string, !Array<string>>} */\n    this.fieldValues_ = opt_form ? getFormAsObject(opt_form) : map();\n  }\n\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n  append(name, value, opt_filename) {\n    // Coercion to string is required to match\n    // the native FormData.append behavior\n    const nameString = String(name);\n    this.fieldValues_[nameString] = this.fieldValues_[nameString] || [];\n    this.fieldValues_[nameString].push(String(value));\n  }\n\n  /** @override */\n  delete(name) {\n    delete this.fieldValues_[name];\n  }\n\n  /** @override */\n  entries() {\n    const fieldEntries = [];\n    Object.keys(this.fieldValues_).forEach(name => {\n      const values = this.fieldValues_[name];\n      values.forEach(value => fieldEntries.push([name, value]));\n    });\n\n    // Generator functions are not supported by the current Babel configuration,\n    // so we must manually implement the iterator interface.\n    let nextIndex = 0;\n    return /** @type {!Iterator<!Array<string>>} */ ({\n      next() {\n        return nextIndex < fieldEntries.length\n          ? {value: fieldEntries[nextIndex++], done: false}\n          : {value: undefined, done: true};\n      },\n    });\n  }\n\n  /** @override */\n  getFormData() {\n    const formData = new FormData();\n\n    Object.keys(this.fieldValues_).forEach(name => {\n      const values = this.fieldValues_[name];\n      values.forEach(value => formData.append(name, value));\n    });\n\n    return formData;\n  }\n}\n\n/**\n * Wrap the native `FormData` implementation.\n *\n * NOTE: This differs from the standard `FormData` constructor. This constructor\n * includes a submit button if it was used to submit the `opt_form`, where\n * the native `FormData` constructor does not include the submit button used to\n * submit the form.\n * {@link https://xhr.spec.whatwg.org/#dom-formdata}\n * @implements {FormDataWrapperInterface}\n */\nclass NativeFormDataWrapper {\n  /** @override */\n  constructor(opt_form) {\n    /** @private @const {!FormData} */\n    this.formData_ = new FormData(opt_form);\n\n    this.maybeIncludeSubmitButton_(opt_form);\n  }\n\n  /**\n   * If a submit button is focused (because it was used to submit the form),\n   * or was the first submit button present, add its name and value to the\n   * `FormData`, since publishers expect the submit button to be present.\n   * @param {!HTMLFormElement=} opt_form\n   * @private\n   */\n  maybeIncludeSubmitButton_(opt_form) {\n    // If a form is not passed to the constructor,\n    // we are not in a submitting code path.\n    if (!opt_form) {\n      return;\n    }\n\n    const button = getSubmitButtonUsed(opt_form);\n    if (button && button.name) {\n      this.append(button.name, button.value);\n    }\n  }\n\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n  append(name, value, opt_filename) {\n    this.formData_.append(name, value);\n  }\n\n  /** @override */\n  delete(name) {\n    this.formData_.delete(name);\n  }\n\n  /** @override */\n  entries() {\n    return this.formData_.entries();\n  }\n\n  /** @override */\n  getFormData() {\n    return this.formData_;\n  }\n}\n\n/**\n * iOS 11 has a bug when submitting empty file inputs.\n * This works around the bug by replacing the empty files with Blob objects.\n */\nclass Ios11NativeFormDataWrapper extends NativeFormDataWrapper {\n  /** @override */\n  constructor(opt_form) {\n    super(opt_form);\n\n    if (opt_form) {\n      iterateCursor(opt_form.elements, input => {\n        if (input.type == 'file' && input.files.length == 0) {\n          this.formData_.delete(input.name);\n          this.formData_.append(input.name, new Blob([]), '');\n        }\n      });\n    }\n  }\n\n  /**\n   * @param {string} name\n   * @param {string|!File} value\n   * @param {string=} opt_filename\n   * @override\n   */\n  append(name, value, opt_filename) {\n    // Safari 11 breaks on submitting empty File values.\n    if (value && typeof value == 'object' && isEmptyFile(value)) {\n      this.formData_.append(name, new Blob([]), opt_filename || '');\n    } else {\n      this.formData_.append(name, value);\n    }\n  }\n}\n\n/**\n * A wrapper for a native `FormData` object that allows the retrieval of entries\n * in the form data after construction even on browsers that don't natively\n * support `FormData.prototype.entries`.\n *\n * @interface\n * Subclassing `FormData` doesn't work in this case as the transpiler\n *     generates code that calls the super constructor directly using\n *     `Function.prototype.call`. WebKit (Safari) doesn't allow this and\n *     enforces that constructors be called with the `new` operator.\n */\nclass FormDataWrapperInterface {\n  /**\n   * Creates a new wrapper for a `FormData` object.\n   *\n   * If there's no native `FormData#entries`, chances are there are no native\n   * methods to read the content of the `FormData` after construction, so the\n   * only way to implement `entries` in this class is to capture the fields in\n   * the form passed to the constructor (and the arguments passed to the\n   * `append` method).\n   *\n   * This constructor should also add the submitter element as defined in the\n   * HTML spec for Form Submission Algorithm, but is not defined by the standard\n   * when using the `FormData` constructor directly.\n   *\n   * For more details on this, see http://mdn.io/FormData.\n   *\n   * @param {!HTMLFormElement=} opt_form An HTML `<form>` element  when\n   *     specified, the `FormData` object will be populated with the form's\n   *     current keys/values using the name property of each element for the\n   *     keys and their submitted value for the values. It will also encode file\n   *     input content.\n   */\n  constructor(opt_form) {}\n\n  /**\n   * Appends a new value onto an existing key inside a `FormData` object, or\n   * adds the key if it does not already exist.\n   *\n   * Appending a `File` object is not yet supported and the `filename`\n   * parameter is ignored for this wrapper.\n   *\n   * For more details on this, see http://mdn.io/FormData/append.\n   *\n   * TODO(cvializ): Update file support\n   *\n   * @param {string} unusedName The name of the field whose data is contained in\n   *     `value`.\n   * @param {string|!File} unusedValue The field's value.\n   * @param {string=} opt_filename The filename to use if the value is a file.\n   */\n  append(unusedName, unusedValue, opt_filename) {}\n\n  /**\n   * Remove the given value from the FormData.\n   *\n   * For more details on this, see http://mdn.io/FormData/delete.\n   *\n   * @param {string} unusedName The name of the field to remove from the FormData.\n   */\n  delete(unusedName) {}\n\n  /**\n   * Returns an iterator of all key/value pairs contained in this object.\n   *\n   * For more details on this, see http://mdn.io/FormData/entries.\n   *\n   * @return {!Iterator<!Array<string|!File>>}\n   */\n  entries() {}\n\n  /**\n   * Returns the wrapped native `FormData` object.\n   *\n   * @return {!FormData}\n   */\n  getFormData() {}\n}\n\n/**\n * Check if the given file is an empty file, which is the result of submitting\n * an empty `<input type=\"file\">`. These cause errors when submitting forms\n * in Safari 11.\n *\n * @param {!File} file\n * @return {boolean}\n */\nfunction isEmptyFile(file) {\n  return file.name == '' && file.size == 0;\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ancestorElementsByTag, iterateCursor} from './dom';\n\n/** @const {string} */\nconst FORM_PROP_ = '__AMP_FORM';\n\n/**\n * @param {!Element} element\n * @return {../extensions/amp-form/0.1/amp-form.AmpForm}\n */\nexport function formOrNullForElement(element) {\n  return element[FORM_PROP_] || null;\n}\n\n/**\n * @param {!Element} element\n * @param {!../extensions/amp-form/0.1/amp-form.AmpForm} form\n */\nexport function setFormForElement(element, form) {\n  element[FORM_PROP_] = form;\n}\n\n/**\n * Returns form data in the passed-in form as an object.\n * Includes focused submit buttons.\n * @param {!HTMLFormElement} form\n * @return {!JsonObject}\n */\nexport function getFormAsObject(form) {\n  const {elements} = form;\n  const data = /** @type {!JsonObject} */ ({});\n  // <button> is handled separately\n  const submittableTagsRegex = /^(?:input|select|textarea)$/i;\n  // type=submit is handled separately\n  const unsubmittableTypesRegex = /^(?:submit|button|image|file|reset)$/i;\n  const checkableType = /^(?:checkbox|radio)$/i;\n\n  for (let i = 0; i < elements.length; i++) {\n    const input = elements[i];\n    const {checked, name, multiple, options, tagName, type, value} = input;\n    if (\n      !name ||\n      isDisabled(input) ||\n      !submittableTagsRegex.test(tagName) ||\n      unsubmittableTypesRegex.test(type) ||\n      (checkableType.test(type) && !checked)\n    ) {\n      continue;\n    }\n\n    if (data[name] === undefined) {\n      data[name] = [];\n    }\n\n    if (multiple) {\n      iterateCursor(options, option => {\n        if (option.selected) {\n          data[name].push(option.value);\n        }\n      });\n      continue;\n    }\n    data[name].push(value);\n  }\n\n  const submitButton = getSubmitButtonUsed(form);\n  if (submitButton && submitButton.name) {\n    const {name} = submitButton;\n    if (data[name] === undefined) {\n      data[name] = [];\n    }\n    data[submitButton.name].push(submitButton.value);\n  }\n\n  // Wait until the end to remove the empty values, since\n  // we don't know when evaluating any one input whether\n  // there will be or have already been inputs with the same names.\n  // e.g. We want to remove empty <select multiple name=x> but\n  // there could also be an <input name=x>. At the end we know if an empty name\n  // can be deleted.\n  Object.keys(data).forEach(key => {\n    if (data[key].length == 0) {\n      delete data[key];\n    }\n  });\n\n  return data;\n}\n\n/**\n * Gets the submit button used to submit the form.\n * This searches through the form elements to find:\n * 1. The first submit button element OR\n * 2. a focused submit button, indicating it was specifically used to submit.\n * 3. null, if neither of the above is found.\n * @param {!HTMLFormElement} form\n * @return {?Element}\n */\nexport function getSubmitButtonUsed(form) {\n  const {elements} = form;\n  const {length} = elements;\n  const {activeElement} = form.ownerDocument;\n  let firstSubmitButton = null;\n\n  for (let i = 0; i < length; i++) {\n    const element = elements[i];\n\n    if (!isSubmitButton(element)) {\n      continue;\n    }\n\n    if (!firstSubmitButton) {\n      firstSubmitButton = element;\n    }\n\n    if (activeElement == element) {\n      return activeElement;\n    }\n  }\n  return firstSubmitButton;\n}\n\n/**\n * True if the given button can submit a form.\n * @param {!Element} element\n * @return {boolean}\n */\nfunction isSubmitButton(element) {\n  const {tagName, type} = element;\n  return tagName == 'BUTTON' || type == 'submit';\n}\n\n/**\n * Checks if a field is disabled.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isDisabled(element) {\n  if (element.disabled) {\n    return true;\n  }\n\n  const ancestors = ancestorElementsByTag(element, 'fieldset');\n  for (let i = 0; i < ancestors.length; i++) {\n    if (ancestors[i].disabled) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Checks if a form field is in its default state.\n * @param {!Element} field\n * @return {boolean}\n */\nexport function isFieldDefault(field) {\n  switch (field.type) {\n    case 'select-multiple':\n    case 'select-one':\n      const {options} = field;\n      for (let j = 0; j < options.length; j++) {\n        if (options[j].selected !== options[j].defaultSelected) {\n          return false;\n        }\n      }\n      break;\n    case 'checkbox':\n    case 'radio':\n      return field.checked === field.defaultChecked;\n    default:\n      return field.value === field.defaultValue;\n  }\n  return true;\n}\n\n/**\n * Checks if a form field is empty. It expects a form field element,\n * i.e. `<input>`, `<textarea>`, or `<select>`.\n * @param {!Element} field\n * @throws {Error}\n * @return {boolean}\n */\nexport function isFieldEmpty(field) {\n  switch (field.tagName) {\n    case 'INPUT':\n      if (field.type == 'checkbox' || field.type == 'radio') {\n        return !field.checked;\n      } else {\n        return !field.value;\n      }\n    case 'TEXTAREA':\n      return !field.value;\n    case 'SELECT':\n      // dropdown menu has at least one option always selected\n      return false;\n    default:\n      throw new Error(\n        `isFieldEmpty: ${field.tagName} is not a supported field element.`\n      );\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommonSignals} from './common-signals';\nimport {FIE_EMBED_PROP} from './iframe-helper';\nimport {LEGACY_ELEMENTS, stubLegacyElements} from './service/extensions-impl';\nimport {Observable} from './observable';\nimport {Services} from './services';\nimport {Signals} from './utils/signals';\nimport {cssText as ampDocCss} from '../build/ampdoc.css';\nimport {cssText as ampSharedCss} from '../build/ampshared.css';\nimport {\n  copyElementToChildWindow,\n  stubElementIfNotKnown,\n  upgradeOrRegisterElement,\n} from './service/custom-element-registry';\nimport {dev, rethrowAsync, userAssert} from './log';\nimport {\n  disposeServicesForEmbed,\n  getAmpdoc,\n  getTopWindow,\n  installServiceInEmbedIfEmbeddable,\n  setParentWindow,\n} from './service';\nimport {escapeHtml} from './dom';\nimport {getExperimentBranch, isExperimentOn} from './experiments';\nimport {installAmpdocServices} from './service/core-services';\nimport {install as installCustomElements} from './polyfills/custom-elements';\nimport {install as installDOMTokenList} from './polyfills/domtokenlist';\nimport {install as installDocContains} from './polyfills/document-contains';\nimport {installStylesForDoc, installStylesLegacy} from './style-installer';\nimport {installTimerInEmbedWindow} from './service/timer-impl';\nimport {isDocumentReady} from './document-ready';\nimport {layoutRectLtwh, moveLayoutRect} from './layout-rect';\nimport {loadPromise} from './event-helper';\nimport {\n  px,\n  resetStyles,\n  setImportantStyles,\n  setStyle,\n  setStyles,\n} from './style';\nimport {toWin} from './types';\nimport {whenContentIniLoad} from './ini-load';\n\n/**\n * @const {{experiment: string, control: string, branch: string}}\n */\nexport const FIE_CSS_CLEANUP_EXP = {\n  branch: 'fie-css-cleanup',\n  control: '21064213',\n  experiment: '21064214',\n};\n\n/**\n * Parameters used to create the new \"friendly iframe\" embed.\n * - html: The complete content of an AMP embed, which is itself an AMP\n *   document. Can include whatever is normally allowed in an AMP document,\n *   except for AMP `<script>` declarations. Those should be passed as an\n *   array of `extensionIds`.\n * - extensionsIds: An optional array of AMP extension IDs used in this embed.\n * - fonts: An optional array of fonts used in this embed.\n *\n * @typedef {{\n *   host: (?AmpElement|undefined),\n *   url: string,\n *   html: string,\n *   extensionIds: (?Array<string>|undefined),\n *   fonts: (?Array<string>|undefined),\n * }}\n */\nexport let FriendlyIframeSpec;\n\n/**\n * @type {boolean|undefined}\n * @visibleForTesting\n */\nlet srcdocSupported;\n\n/**\n * @param {boolean|undefined} val\n * @visibleForTesting\n */\nexport function setSrcdocSupportedForTesting(val) {\n  srcdocSupported = val;\n}\n\n/**\n * Returns `true` if the Friendly Iframes are supported.\n * @return {boolean}\n */\nfunction isSrcdocSupported() {\n  if (srcdocSupported === undefined) {\n    srcdocSupported = 'srcdoc' in HTMLIFrameElement.prototype;\n  }\n  return srcdocSupported;\n}\n\n/**\n * Sets whether the embed is currently visible. The interpretation of visibility\n * is up to the embed parent. However, most of typical cases would rely on\n * whether the embed is currently in the viewport.\n * @param {!FriendlyIframeEmbed} embed\n * @param {boolean} visible\n * TODO(dvoytenko): Re-evaluate and probably drop once layers are ready.\n */\nexport function setFriendlyIframeEmbedVisible(embed, visible) {\n  embed.setVisible_(visible);\n}\n\n/**\n * Creates the requested \"friendly iframe\" embed. Returns the promise that\n * will be resolved as soon as the embed is available. The actual\n * initialization of the embed will start as soon as the `iframe` is added\n * to the DOM.\n * @param {!HTMLIFrameElement} iframe\n * @param {!Element} container\n * @param {!FriendlyIframeSpec} spec\n * @param {function(!Window, ?./service/ampdoc-impl.AmpDoc=)=} opt_preinstallCallback\n * @return {!Promise<!FriendlyIframeEmbed>}\n */\nexport function installFriendlyIframeEmbed(\n  iframe,\n  container,\n  spec,\n  opt_preinstallCallback // TODO(#22733): remove \"window\" argument.\n) {\n  /** @const {!Window} */\n  const win = getTopWindow(toWin(iframe.ownerDocument.defaultView));\n  /** @const {!./service/extensions-impl.Extensions} */\n  const extensions = Services.extensionsFor(win);\n  const ampdocFieExperimentOn = isExperimentOn(win, 'ampdoc-fie');\n  /** @const {?./service/ampdoc-impl.AmpDocService} */\n  const ampdocService = ampdocFieExperimentOn\n    ? Services.ampdocServiceFor(win)\n    : null;\n\n  setStyle(iframe, 'visibility', 'hidden');\n  iframe.setAttribute('referrerpolicy', 'unsafe-url');\n  iframe.setAttribute('marginheight', '0');\n  iframe.setAttribute('marginwidth', '0');\n\n  // Pre-load extensions.\n  if (spec.extensionIds) {\n    spec.extensionIds.forEach(extensionId =>\n      extensions.preloadExtension(extensionId)\n    );\n  }\n\n  const html = mergeHtml(spec);\n\n  // Receive the signal when iframe is ready: it's document is formed.\n  iframe.onload = () => {\n    // Chrome does not reflect the iframe readystate.\n    iframe.readyState = 'complete';\n  };\n  const registerViolationListener = () => {\n    iframe.contentWindow.addEventListener(\n      'securitypolicyviolation',\n      violationEvent => {\n        dev().warn('FIE', 'security policy violation', violationEvent);\n      }\n    );\n  };\n  let loadedPromise;\n  if (isSrcdocSupported()) {\n    iframe.srcdoc = html;\n    loadedPromise = loadPromise(iframe);\n    container.appendChild(iframe);\n    registerViolationListener();\n  } else {\n    iframe.src = 'about:blank';\n    container.appendChild(iframe);\n    const childDoc = iframe.contentWindow.document;\n    childDoc.open();\n    registerViolationListener();\n    childDoc.write(html);\n    // With document.write, `iframe.onload` arrives almost immediately, thus\n    // we need to wait for child's `window.onload`.\n    loadedPromise = loadPromise(iframe.contentWindow);\n    childDoc.close();\n  }\n\n  // Wait for document ready signal.\n  // This is complicated due to crbug.com/649201 on Chrome and a similar issue\n  // on Safari where newly created document's `readyState` immediately equals\n  // `complete`, even though the document itself is not yet available. There's\n  // no other reliable signal for `readyState` in a child window and thus\n  // we have to fallback to polling.\n  let readyPromise;\n  if (isIframeReady(iframe)) {\n    readyPromise = Promise.resolve();\n  } else {\n    readyPromise = new Promise(resolve => {\n      /** @const {number} */\n      const interval = win.setInterval(() => {\n        if (isIframeReady(iframe)) {\n          resolve();\n          win.clearInterval(interval);\n        }\n      }, /* milliseconds */ 5);\n\n      // For safety, make sure we definitely stop polling when child doc is\n      // loaded.\n      loadedPromise\n        .catch(error => {\n          rethrowAsync(error);\n        })\n        .then(() => {\n          resolve();\n          win.clearInterval(interval);\n        });\n    });\n  }\n\n  return readyPromise.then(() => {\n    const childWin = /** @type {!Window} */ (iframe.contentWindow);\n    const signals = spec.host && spec.host.signals();\n    const ampdoc =\n      ampdocFieExperimentOn && ampdocService\n        ? ampdocService.installFieDoc(spec.url, childWin, {signals})\n        : null;\n    const embed = new FriendlyIframeEmbed(iframe, spec, loadedPromise, ampdoc);\n    iframe[FIE_EMBED_PROP] = embed;\n\n    // Add extensions.\n    if (ampdoc && ampdocFieExperimentOn) {\n      embed.installExtensionsInFie(\n        extensions,\n        ampdoc,\n        spec.extensionIds || [],\n        opt_preinstallCallback\n      );\n    } else {\n      embed.installExtensionsInChildWindow(\n        extensions,\n        childWin,\n        spec.extensionIds || [],\n        opt_preinstallCallback\n      );\n    }\n    // Ready to be shown.\n    embed.startRender_();\n    return embed;\n  });\n}\n\n/**\n * Returns `true` when iframe is ready.\n * @param {!HTMLIFrameElement} iframe\n * @return {boolean}\n */\nfunction isIframeReady(iframe) {\n  // This is complicated due to crbug.com/649201 on Chrome and a similar issue\n  // on Safari where newly created document's `readyState` immediately equals\n  // `complete`, even though the document itself is not yet available. There's\n  // no other reliable signal for `readyState` in a child window and thus\n  // the best way to check is to see the contents of the body.\n  const childDoc = iframe.contentWindow && iframe.contentWindow.document;\n  return !!(\n    childDoc &&\n    isDocumentReady(childDoc) &&\n    childDoc.body &&\n    childDoc.body.firstChild\n  );\n}\n\n/**\n * Merges base and fonts into html document.\n * @param {!FriendlyIframeSpec} spec\n * @return {string}\n */\nfunction mergeHtml(spec) {\n  const originalHtml = spec.html;\n  const originalHtmlUp = originalHtml.toUpperCase();\n\n  // Find the insertion point.\n  let ip = originalHtmlUp.indexOf('<HEAD');\n  if (ip != -1) {\n    ip = originalHtmlUp.indexOf('>', ip + 1) + 1;\n  }\n  if (ip == -1) {\n    ip = originalHtmlUp.indexOf('<BODY');\n  }\n  if (ip == -1) {\n    ip = originalHtmlUp.indexOf('<HTML');\n    if (ip != -1) {\n      ip = originalHtmlUp.indexOf('>', ip + 1) + 1;\n    }\n  }\n\n  const result = [];\n\n  // Preambule.\n  if (ip > 0) {\n    result.push(originalHtml.substring(0, ip));\n  }\n\n  // Add <BASE> tag.\n  result.push(`<base href=\"${escapeHtml(spec.url)}\">`);\n\n  // Load fonts.\n  if (spec.fonts) {\n    spec.fonts.forEach(font => {\n      result.push(\n        `<link href=\"${escapeHtml(font)}\" rel=\"stylesheet\" type=\"text/css\">`\n      );\n    });\n  }\n\n  // Load CSP\n  result.push(\n    '<meta http-equiv=Content-Security-Policy ' +\n      \"content=\\\"script-src 'none';object-src 'none';child-src 'none'\\\">\"\n  );\n\n  // Postambule.\n  if (ip > 0) {\n    result.push(originalHtml.substring(ip));\n  } else {\n    result.push(originalHtml);\n  }\n\n  return result.join('');\n}\n\n/**\n * Exposes `mergeHtml` for testing purposes.\n * @param {!FriendlyIframeSpec} spec\n * @return {string}\n * @visibleForTesting\n */\nexport function mergeHtmlForTesting(spec) {\n  return mergeHtml(spec);\n}\n\n/**\n * A \"friendly iframe\" embed. This is the iframe that's fully accessible to\n * the AMP runtime. It's similar to Shadow DOM in many respects, but it also\n * provides iframe/viewport measurements and enables the use of `vh`, `vw` and\n * `@media` CSS.\n *\n * The friendly iframe is managed by the top-level AMP Runtime. When it's\n * destroyed, the `destroy` method must be called to free up the shared\n * resources.\n *\n * @visibleForTesting\n */\nexport class FriendlyIframeEmbed {\n  /**\n   * @param {!HTMLIFrameElement} iframe\n   * @param {!FriendlyIframeSpec} spec\n   * @param {!Promise} loadedPromise\n   * @param {?./service/ampdoc-impl.AmpDocFie} ampdoc\n   */\n  constructor(iframe, spec, loadedPromise, ampdoc) {\n    /** @const {!HTMLIFrameElement} */\n    this.iframe = iframe;\n\n    /** @const {!Window} */\n    this.win = /** @type {!Window} */ (iframe.contentWindow);\n\n    /** @const {?./service/ampdoc-impl.AmpDocFie} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!FriendlyIframeSpec} */\n    this.spec = spec;\n\n    /** @const {?AmpElement} */\n    this.host = spec.host || null;\n\n    /** @const @private {time} */\n    this.startTime_ = Date.now();\n\n    /**\n     * Starts out as invisible. The interpretation of this flag is up to\n     * the emded parent.\n     * @private {boolean}\n     */\n    this.visible_ = false;\n\n    /** @private {!Observable<boolean>} */\n    this.visibilityObservable_ = new Observable();\n\n    /** @private @const */\n    this.signals_ = this.ampdoc\n      ? this.ampdoc.signals()\n      : this.host\n      ? this.host.signals()\n      : new Signals();\n\n    /** @private @const {!Promise} */\n    this.winLoadedPromise_ = Promise.all([loadedPromise, this.whenReady()]);\n    if (this.ampdoc) {\n      this.whenReady().then(() => this.ampdoc.setReady());\n    }\n  }\n\n  /**\n   * Ensures that all resources from this iframe have been released.\n   */\n  destroy() {\n    this.removeResources_();\n    disposeServicesForEmbed(this.win);\n    if (this.ampdoc) {\n      this.ampdoc.dispose();\n    }\n  }\n\n  /**\n   * @return {time}\n   */\n  getStartTime() {\n    return this.startTime_;\n  }\n\n  /**\n   * Returns the base URL for the embedded document.\n   * @return {string}\n   */\n  getUrl() {\n    return this.spec.url;\n  }\n\n  /** @return {!Signals} */\n  signals() {\n    return this.signals_;\n  }\n\n  /**\n   * Returns a promise that will resolve when the embed document is ready.\n   * Notice that this signal coincides with the embed's `render-start`.\n   * @return {!Promise}\n   */\n  whenReady() {\n    return this.signals_.whenSignal(CommonSignals.RENDER_START);\n  }\n\n  /**\n   * Returns a promise that will resolve when the child window's `onload` event\n   * has been emitted. In friendly iframes this typically only includes font\n   * loading.\n   * @return {!Promise}\n   */\n  whenWindowLoaded() {\n    return this.winLoadedPromise_;\n  }\n\n  /**\n   * Returns a promise that will resolve when the initial load  of the embed's\n   * content has been completed.\n   * @return {!Promise}\n   */\n  whenIniLoaded() {\n    return this.signals_.whenSignal(CommonSignals.INI_LOAD);\n  }\n\n  /**\n   * @private\n   * @restricted\n   */\n  startRender_() {\n    if (this.host) {\n      this.host.renderStarted();\n    } else {\n      this.signals_.signal(CommonSignals.RENDER_START);\n    }\n    // Common signal RENDER_START indicates time to toggle visibility\n    setStyle(this.iframe, 'visibility', '');\n    if (this.win.document && this.win.document.body) {\n      this.win.document.documentElement.classList.add('i-amphtml-fie');\n      setStyles(dev().assertElement(this.win.document.body), {\n        opacity: 1,\n        visibility: 'visible',\n        animation: 'none',\n      });\n    }\n\n    // Initial load signal signal.\n    let rect;\n    if (this.host) {\n      rect = this.host.getLayoutBox();\n    } else {\n      rect = layoutRectLtwh(\n        0,\n        0,\n        this.win./*OK*/ innerWidth,\n        this.win./*OK*/ innerHeight\n      );\n    }\n    Promise.all([\n      this.whenReady(),\n      whenContentIniLoad(this.iframe, this.win, rect),\n    ]).then(() => {\n      this.signals_.signal(CommonSignals.INI_LOAD);\n    });\n  }\n\n  /**\n   * Whether the embed is currently visible. The interpretation of visibility\n   * is up to the embed parent. However, most of typical cases would rely on\n   * whether the embed is currently in the viewport.\n   * @return {boolean}\n   * TODO(dvoytenko): Re-evaluate and probably drop once layers are ready.\n   */\n  isVisible() {\n    return this.visible_;\n  }\n\n  /**\n   * See `isVisible` for more info.\n   * @param {function(boolean)} handler\n   * @return {!UnlistenDef}\n   */\n  onVisibilityChanged(handler) {\n    return this.visibilityObservable_.add(handler);\n  }\n\n  /**\n   * @param {boolean} visible\n   * @private\n   * @restricted\n   */\n  setVisible_(visible) {\n    if (this.visible_ != visible) {\n      this.visible_ = visible;\n      this.visibilityObservable_.fire(this.visible_);\n    }\n  }\n\n  /**\n   * @return {!HTMLBodyElement}\n   * @visibleForTesting\n   */\n  getBodyElement() {\n    return /** @type {!HTMLBodyElement} */ ((\n      this.iframe.contentDocument || this.iframe.contentWindow.document\n    ).body);\n  }\n\n  /**\n   * @return {!./service/resources-interface.ResourcesInterface}\n   * @private\n   */\n  getResources_() {\n    return Services.resourcesForDoc(this.iframe);\n  }\n\n  /**\n   * Runs a measure/mutate cycle ensuring that the iframe change is propagated\n   * to the resource manager.\n   * @param {{measure: (function()|undefined), mutate: function()}} task\n   * @return {!Promise}\n   * @private\n   */\n  measureMutate_(task) {\n    return this.getResources_().measureMutateElement(\n      this.iframe,\n      task.measure || null,\n      task.mutate\n    );\n  }\n\n  /**\n   * Removes all resources belonging to the FIE window.\n   * @private\n   */\n  removeResources_() {\n    const resources = this.getResources_();\n    const toRemove = resources\n      .get()\n      .filter(resource => resource.hostWin == this.win);\n    toRemove.forEach(resource => {\n      resources.remove(resource.element);\n      resource.disconnect();\n    });\n  }\n\n  /**\n   * @return {!Promise}\n   */\n  enterFullOverlayMode() {\n    const ampAdParent = dev().assertElement(this.iframe.parentNode);\n\n    // Security assertion. Otherwise any 3p frame could request lighbox mode.\n    userAssert(\n      ampAdParent.tagName.toLowerCase() == 'amp-ad',\n      'Only <amp-ad> is allowed to enter lightbox mode.'\n    );\n\n    let bodyStyle;\n\n    return this.measureMutate_({\n      measure: () => {\n        const rect = this.host\n          ? this.host.getLayoutBox()\n          : this.iframe./*OK*/ getBoundingClientRect();\n\n        // Offset by scroll top as iframe will be position: fixed.\n        const dy = -Services.viewportForDoc(this.iframe).getScrollTop();\n        const {top, left, width, height} = moveLayoutRect(rect, /* dx */ 0, dy);\n\n        // Offset body by header height to prevent visual jump.\n        bodyStyle = {\n          top: px(top),\n          left: px(left),\n          width: px(width),\n          height: px(height),\n        };\n      },\n      mutate: () => {\n        // !important to prevent abuse e.g. box @ ltwh = 0, 0, 0, 0\n        setImportantStyles(this.iframe, {\n          'position': 'fixed',\n          'left': 0,\n          'right': 0,\n          'bottom': 0,\n          'width': '100vw',\n          'top': 0,\n          'height': '100vh',\n        });\n\n        // We need to override runtime-level !important rules\n        setImportantStyles(this.getBodyElement(), {\n          'background': 'transparent',\n          'position': 'absolute',\n          'bottom': 'auto',\n          'right': 'auto',\n\n          // Read during vsync measure phase.\n          'top': bodyStyle.top,\n          'left': bodyStyle.left,\n          'width': bodyStyle.width,\n          'height': bodyStyle.height,\n        });\n      },\n    });\n  }\n\n  /**\n   * @return {!Promise}\n   */\n  leaveFullOverlayMode() {\n    return this.measureMutate_({\n      mutate: () => {\n        resetStyles(this.iframe, [\n          'position',\n          'left',\n          'right',\n          'top',\n          'bottom',\n          'width',\n          'height',\n        ]);\n\n        // we're not resetting background here as we need to set it to\n        // transparent permanently.\n        resetStyles(this.getBodyElement(), [\n          'position',\n          'top',\n          'left',\n          'width',\n          'height',\n          'bottom',\n          'right',\n        ]);\n      },\n    });\n  }\n\n  /**\n   * Install extensions in the child window (friendly iframe). The pre-install\n   * callback, if specified, is executed after polyfills have been configured\n   * but before the first extension is installed.\n   * @param {!./service/extensions-impl.Extensions} extensions\n   * @param {!./service/ampdoc-impl.AmpDocFie} ampdoc\n   * @param {!Array<string>} extensionIds\n   * @param {function(!Window, ?./service/ampdoc-impl.AmpDoc=)=} opt_preinstallCallback\n   * @return {!Promise}\n   * @visibleForTesting\n   */\n  installExtensionsInFie(\n    extensions,\n    ampdoc,\n    extensionIds,\n    opt_preinstallCallback\n  ) {\n    const topWin = extensions.win;\n    const childWin = ampdoc.win;\n    const parentWin = toWin(childWin.frameElement.ownerDocument.defaultView);\n    setParentWindow(childWin, parentWin);\n\n    // Install necessary polyfills.\n    installPolyfillsInChildWindow(parentWin, childWin);\n\n    // Install runtime styles.\n    installStylesForDoc(\n      ampdoc,\n      getExperimentBranch(this.win, FIE_CSS_CLEANUP_EXP.branch) ===\n        FIE_CSS_CLEANUP_EXP.experiment\n        ? ampSharedCss\n        : ampDocCss + ampSharedCss,\n      /* callback */ null,\n      /* opt_isRuntimeCss */ true,\n      /* opt_ext */ 'amp-runtime'\n    );\n\n    // Run pre-install callback.\n    if (opt_preinstallCallback) {\n      opt_preinstallCallback(ampdoc.win, ampdoc);\n    }\n\n    // Install embeddable standard services.\n    installStandardServicesInEmbeddedDoc(ampdoc);\n\n    // Install built-ins and legacy elements.\n    copyBuiltinElementsToChildWindow(topWin, childWin);\n    stubLegacyElements(childWin);\n\n    return Promise.all(\n      extensionIds.map(extensionId => {\n        // This will extend automatic upgrade of custom elements from top\n        // window to the child window.\n        if (!LEGACY_ELEMENTS.includes(extensionId)) {\n          stubElementIfNotKnown(childWin, extensionId);\n        }\n        return extensions.installExtensionInDoc(ampdoc, extensionId);\n      })\n    );\n  }\n\n  /**\n   * Install extensions in the child window (friendly iframe). The pre-install\n   * callback, if specified, is executed after polyfills have been configured\n   * but before the first extension is installed.\n   * @param {!./service/extensions-impl.Extensions} extensions\n   * @param {!Window} childWin\n   * @param {!Array<string>} extensionIds\n   * @param {function(!Window, ?./service/ampdoc-impl.AmpDoc=)=} opt_preinstallCallback\n   * @return {!Promise}\n   * @visibleForTesting\n   */\n  installExtensionsInChildWindow(\n    extensions,\n    childWin,\n    extensionIds,\n    opt_preinstallCallback\n  ) {\n    const topWin = extensions.win;\n    const parentWin = toWin(childWin.frameElement.ownerDocument.defaultView);\n    setParentWindow(childWin, parentWin);\n\n    // Install necessary polyfills.\n    installPolyfillsInChildWindow(parentWin, childWin);\n\n    // Install runtime styles.\n    installStylesLegacy(\n      childWin.document,\n      getExperimentBranch(this.win, FIE_CSS_CLEANUP_EXP.branch) ===\n        FIE_CSS_CLEANUP_EXP.experiment\n        ? ampSharedCss\n        : ampDocCss + ampSharedCss,\n      /* callback */ null,\n      /* opt_isRuntimeCss */ true,\n      /* opt_ext */ 'amp-runtime'\n    );\n\n    // Run pre-install callback.\n    if (opt_preinstallCallback) {\n      opt_preinstallCallback(childWin);\n    }\n\n    // Install embeddable standard services.\n    installStandardServicesInEmbed(childWin);\n\n    // Install built-ins and legacy elements.\n    copyBuiltinElementsToChildWindow(topWin, childWin);\n    stubLegacyElements(childWin);\n\n    const promises = [];\n    extensionIds.forEach(extensionId => {\n      // This will extend automatic upgrade of custom elements from top\n      // window to the child window.\n      if (!LEGACY_ELEMENTS.includes(extensionId)) {\n        stubElementIfNotKnown(childWin, extensionId);\n      }\n\n      // Install CSS.\n      const promise = extensions\n        .preloadExtension(extensionId)\n        .then(extension => {\n          // Adopt embeddable extension services.\n          extension.services.forEach(service => {\n            installServiceInEmbedIfEmbeddable(childWin, service.serviceClass);\n          });\n\n          // Adopt the custom elements.\n          let elementPromises = null;\n          for (const elementName in extension.elements) {\n            const elementDef = extension.elements[elementName];\n            const elementPromise = new Promise(resolve => {\n              if (elementDef.css) {\n                installStylesLegacy(\n                  childWin.document,\n                  elementDef.css,\n                  /* completeCallback */ resolve,\n                  /* isRuntime */ false,\n                  extensionId\n                );\n              } else {\n                resolve();\n              }\n            }).then(() => {\n              upgradeOrRegisterElement(\n                childWin,\n                elementName,\n                elementDef.implementationClass\n              );\n            });\n            if (elementPromises) {\n              elementPromises.push(elementPromise);\n            } else {\n              elementPromises = [elementPromise];\n            }\n          }\n          if (elementPromises) {\n            return Promise.all(elementPromises).then(() => extension);\n          }\n          return extension;\n        });\n      promises.push(promise);\n    });\n    return Promise.all(promises);\n  }\n}\n\n/**\n * Install polyfills in the child window (friendly iframe).\n * @param {!Window} parentWin\n * @param {!Window} childWin\n */\nfunction installPolyfillsInChildWindow(parentWin, childWin) {\n  installDocContains(childWin);\n  installDOMTokenList(childWin);\n  installCustomElements(childWin);\n}\n\n/**\n * Copy builtins to a child window.\n * @param {!Window} parentWin\n * @param {!Window} childWin\n */\nfunction copyBuiltinElementsToChildWindow(parentWin, childWin) {\n  copyElementToChildWindow(parentWin, childWin, 'amp-img');\n  copyElementToChildWindow(parentWin, childWin, 'amp-pixel');\n}\n\n/**\n * Adopt predefined core services for the embedded ampdoc (friendly iframe).\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\nfunction installStandardServicesInEmbeddedDoc(ampdoc) {\n  installAmpdocServices(ampdoc);\n  installTimerInEmbedWindow(ampdoc.win);\n}\n\n/**\n * Adopt predefined core services for the child window (friendly iframe).\n * @param {!Window} childWin\n * @visibleForTesting\n */\nexport function installStandardServicesInEmbed(childWin) {\n  // TODO(#22733): remove when ampdoc-fie is launched.\n  const frameElement = dev().assertElement(\n    childWin.frameElement,\n    'frameElement not found for embed'\n  );\n  const standardServices = [\n    // The order of service adoptations is important.\n    Services.urlForDoc(frameElement),\n    Services.actionServiceForDoc(frameElement),\n    Services.standardActionsForDoc(frameElement),\n    Services.navigationForDoc(frameElement),\n  ];\n  const ampdoc = getAmpdoc(frameElement);\n  standardServices.forEach(service => {\n    // Static functions must be invoked on the class, not the instance.\n    service.constructor.installInEmbedWindow(childWin, ampdoc);\n  });\n  installTimerInEmbedWindow(childWin);\n}\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Gets state from History.\n * But IE11 throws if there is no state.\n *\n * @param {!History} history\n * @return {*}\n */\nexport function getState(history) {\n  try {\n    return history.state;\n  } catch (e) {\n    return null;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {DomFingerprint} from './utils/dom-fingerprint';\nimport {Services} from './services';\nimport {dict} from './utils/object.js';\nimport {experimentToggles, isCanary} from './experiments';\nimport {getLengthNumeral} from './layout';\nimport {getModeObject} from './mode-object';\nimport {internalRuntimeVersion} from './internal-version';\nimport {urls} from './config';\n\n/**\n * Produces the attributes for the ad template.\n * @param {!Window} parentWindow\n * @param {!AmpElement} element\n * @param {string} sentinel\n * @param {!JsonObject=} attributes\n * @return {!JsonObject}\n */\nexport function getContextMetadata(\n  parentWindow,\n  element,\n  sentinel,\n  attributes\n) {\n  const startTime = Date.now();\n  const width = element.getAttribute('width');\n  const height = element.getAttribute('height');\n  attributes = attributes ? attributes : dict();\n  attributes['width'] = getLengthNumeral(width);\n  attributes['height'] = getLengthNumeral(height);\n  if (element.getAttribute('title')) {\n    attributes['title'] = element.getAttribute('title');\n  }\n  let locationHref = parentWindow.location.href;\n  // This is really only needed for tests, but whatever. Children\n  // see us as the logical origin, so telling them we are about:srcdoc\n  // will fail ancestor checks.\n  if (locationHref == 'about:srcdoc') {\n    locationHref = parentWindow.parent.location.href;\n  }\n\n  const ampdoc = Services.ampdoc(element);\n  const docInfo = Services.documentInfoForDoc(element);\n  const viewer = Services.viewerForDoc(element);\n  const referrer = viewer.getUnconfirmedReferrerUrl();\n\n  // TODO(alanorozco): Redesign data structure so that fields not exposed by\n  // AmpContext are not part of this object.\n  const layoutRect = element.getPageLayoutBox();\n\n  // Use JsonObject to preserve field names so that ampContext can access\n  // values with name\n  // ampcontext.js and this file are compiled in different compilation unit\n\n  // Note: Field names can by perserved by using JsonObject, or by adding\n  // perserved name to extern. We are doing both right now.\n  // Please also add new introduced variable\n  // name to the extern list.\n  attributes['_context'] = dict({\n    'ampcontextVersion': internalRuntimeVersion(),\n    'ampcontextFilepath': `${\n      urls.thirdParty\n    }/${internalRuntimeVersion()}/ampcontext-v0.js`,\n    'sourceUrl': docInfo.sourceUrl,\n    'referrer': referrer,\n    'canonicalUrl': docInfo.canonicalUrl,\n    'pageViewId': docInfo.pageViewId,\n    'location': {\n      'href': locationHref,\n    },\n    'startTime': startTime,\n    'tagName': element.tagName,\n    'mode': getModeObject(),\n    'canary': isCanary(parentWindow),\n    'hidden': !ampdoc.isVisible(),\n    'initialLayoutRect': layoutRect\n      ? {\n          'left': layoutRect.left,\n          'top': layoutRect.top,\n          'width': layoutRect.width,\n          'height': layoutRect.height,\n        }\n      : null,\n    'initialIntersection': element.getIntersectionChangeEntry(),\n    'domFingerprint': DomFingerprint.generate(element),\n    'experimentToggles': experimentToggles(parentWindow),\n    'sentinel': sentinel,\n  });\n  const adSrc = element.getAttribute('src');\n  if (adSrc) {\n    attributes['src'] = adSrc;\n  }\n  return attributes;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {addAttributesToElement, closestAncestorElementBySelector} from './dom';\nimport {deserializeMessage, isAmpMessage} from './3p-frame-messaging';\nimport {dev, devAssert} from './log';\nimport {dict} from './utils/object';\nimport {getData} from './event-helper';\nimport {parseUrlDeprecated} from './url';\nimport {remove} from './utils/array';\nimport {setStyle, toggle} from './style';\nimport {tryParseJson} from './json';\n\n/**\n * Sentinel used to force unlistening after a iframe is detached.\n * @type {string}\n */\nconst UNLISTEN_SENTINEL = 'unlisten';\n\n/**\n * The iframe feature policy that forces the iframe to pause when it's not\n * display.\n * See https://github.com/dtapuska/iframe-freeze.\n */\nconst EXECUTION_WHILE_NOT_RENDERED = 'execution-while-not-rendered';\n\n/**\n * @typedef {{\n *   frame: !Element,\n *   events: !Object<string, !Array<function(!JsonObject)>>\n * }}\n */\nlet WindowEventsDef;\n\n/**\n * Returns a mapping from a URL's origin to an array of windows and their\n * listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {boolean=} opt_create create the mapping if it does not exist\n * @return {?Object<string, !Array<!WindowEventsDef>>}\n */\nfunction getListenFors(parentWin, opt_create) {\n  let {listeningFors} = parentWin;\n\n  if (!listeningFors && opt_create) {\n    listeningFors = parentWin.listeningFors = Object.create(null);\n  }\n  return listeningFors || null;\n}\n\n/**\n * Returns an array of WindowEventsDef that have had any listenFor listeners\n * registered for this sentinel.\n * @param {?Window} parentWin the window that created the iframe\n * @param {string} sentinel the sentinel of the message\n * @param {boolean=} opt_create create the array if it does not exist\n * @return {?Array<!WindowEventsDef>}\n */\nfunction getListenForSentinel(parentWin, sentinel, opt_create) {\n  const listeningFors = getListenFors(parentWin, opt_create);\n  if (!listeningFors) {\n    return listeningFors;\n  }\n\n  let listenSentinel = listeningFors[sentinel];\n  if (!listenSentinel && opt_create) {\n    listenSentinel = listeningFors[sentinel] = [];\n  }\n  return listenSentinel || null;\n}\n\n/**\n * Returns an mapping of event names to listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {!Element} iframe the iframe element who's context will trigger the\n *     event\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @return {?Object<string, !Array<function(!JsonObject, !Window, string, !MessageEvent)>>}\n */\nfunction getOrCreateListenForEvents(parentWin, iframe, opt_is3P) {\n  const sentinel = getSentinel_(iframe, opt_is3P);\n  const listenSentinel = getListenForSentinel(parentWin, sentinel, true);\n\n  let windowEvents;\n  for (let i = 0; i < listenSentinel.length; i++) {\n    const we = listenSentinel[i];\n    if (we.frame === iframe) {\n      windowEvents = we;\n      break;\n    }\n  }\n\n  if (!windowEvents) {\n    windowEvents = {\n      frame: iframe,\n      events: Object.create(null),\n    };\n    listenSentinel.push(windowEvents);\n  }\n\n  return windowEvents.events;\n}\n\n/**\n * Returns an mapping of event names to listenFor listeners.\n * @param {?Window} parentWin the window that created the iframe\n * @param {string} sentinel the sentinel of the message\n * @param {string} origin the source window's origin\n * @param {?Window} triggerWin the window that triggered the event\n * @return {?Object<string, !Array<function(!JsonObject, !Window, string, !MessageEvent)>>}\n */\nfunction getListenForEvents(parentWin, sentinel, origin, triggerWin) {\n  const listenSentinel = getListenForSentinel(parentWin, sentinel);\n\n  if (!listenSentinel) {\n    return listenSentinel;\n  }\n\n  // Find the entry for the frame.\n  // TODO(@nekodo): Add a WeakMap<Window, WindowEventsDef> cache to\n  //     speed up this process.\n  let windowEvents;\n  for (let i = 0; i < listenSentinel.length; i++) {\n    const we = listenSentinel[i];\n    const {contentWindow} = we.frame;\n    if (!contentWindow) {\n      setTimeout(dropListenSentinel, 0, listenSentinel);\n    } else if (\n      triggerWin == contentWindow ||\n      isDescendantWindow(contentWindow, triggerWin)\n    ) {\n      // 3p code path, we may accept messages from nested frames.\n      windowEvents = we;\n      break;\n    }\n  }\n\n  return windowEvents ? windowEvents.events : null;\n}\n\n/**\n * Checks whether one window is a descendant of another by climbing\n * the parent chain.\n * @param {?Window} ancestor potential ancestor window\n * @param {?Window} descendant potential descendant window\n * @return {boolean}\n */\nfunction isDescendantWindow(ancestor, descendant) {\n  for (let win = descendant; win && win != win.parent; win = win.parent) {\n    if (win == ancestor) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Removes any listenFors registed on listenSentinel that do not have\n * a contentWindow (the frame was removed from the DOM tree).\n * @param {!Array<!WindowEventsDef>} listenSentinel\n */\nfunction dropListenSentinel(listenSentinel) {\n  const noopData = dict({'sentinel': UNLISTEN_SENTINEL});\n\n  for (let i = listenSentinel.length - 1; i >= 0; i--) {\n    const windowEvents = listenSentinel[i];\n\n    if (!windowEvents.frame.contentWindow) {\n      listenSentinel.splice(i, 1);\n\n      const {events} = windowEvents;\n      for (const name in events) {\n        // Splice here, so that each unlisten does not shift the array\n        events[name].splice(0, Infinity).forEach(event => {\n          event(noopData);\n        });\n      }\n    }\n  }\n}\n\n/**\n * Registers the global listenFor event listener if it has yet to be.\n * @param {?Window} parentWin\n */\nfunction registerGlobalListenerIfNeeded(parentWin) {\n  if (parentWin.listeningFors) {\n    return;\n  }\n  const listenForListener = function(event) {\n    if (!getData(event)) {\n      return;\n    }\n    const data = parseIfNeeded(getData(event));\n\n    if (!data || !data['sentinel']) {\n      return;\n    }\n\n    const listenForEvents = getListenForEvents(\n      parentWin,\n      data['sentinel'],\n      event.origin,\n      event.source\n    );\n    if (!listenForEvents) {\n      return;\n    }\n\n    let listeners = listenForEvents[data['type']];\n    if (!listeners) {\n      return;\n    }\n\n    // We slice to avoid issues with adding another listener or unlistening\n    // during iteration. We could move to a Doubly Linked List with\n    // backtracking, but that's overly complicated.\n    listeners = listeners.slice();\n    for (let i = 0; i < listeners.length; i++) {\n      const listener = listeners[i];\n      listener(data, event.source, event.origin, event);\n    }\n  };\n\n  parentWin.addEventListener('message', listenForListener);\n}\n\n/**\n * Allows listening for message from the iframe. Returns an unlisten\n * function to remove the listener.\n *\n * @param {?Element} iframe\n * @param {string} typeOfMessage\n * @param {?function(!JsonObject, !Window, string, !MessageEvent)} callback Called when a\n *     message of this type arrives for this iframe.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @param {boolean=} opt_includingNestedWindows set to true if messages from\n *     nested frames should also be accepted.\n * @param {boolean=} opt_allowOpaqueOrigin set to true if messages from\n       opaque origins (origin == null) are allowed.\n * @return {!UnlistenDef}\n */\nexport function listenFor(\n  iframe,\n  typeOfMessage,\n  callback,\n  opt_is3P,\n  opt_includingNestedWindows,\n  opt_allowOpaqueOrigin\n) {\n  devAssert(iframe.src, 'only iframes with src supported');\n  devAssert(\n    !iframe.parentNode,\n    'cannot register events on an attached ' +\n      'iframe. It will cause hair-pulling bugs like #2942'\n  );\n  devAssert(callback);\n  const parentWin = iframe.ownerDocument.defaultView;\n\n  registerGlobalListenerIfNeeded(parentWin);\n\n  const listenForEvents = getOrCreateListenForEvents(\n    parentWin,\n    iframe,\n    opt_is3P\n  );\n\n  const iframeOrigin = parseUrlDeprecated(iframe.src).origin;\n  let events =\n    listenForEvents[typeOfMessage] || (listenForEvents[typeOfMessage] = []);\n\n  let unlisten;\n  let listener = function(data, source, origin, event) {\n    const sentinel = data['sentinel'];\n\n    // Exclude messages that don't satisfy amp sentinel rules.\n    if (sentinel == 'amp') {\n      // For `amp` sentinel, nested windows are not allowed\n      if (source != iframe.contentWindow) {\n        return;\n      }\n\n      // For `amp` sentinel origin must match unless opaque origin is allowed\n      const isOpaqueAndAllowed = origin == 'null' && opt_allowOpaqueOrigin;\n      if (iframeOrigin != origin && !isOpaqueAndAllowed) {\n        return;\n      }\n    }\n\n    // Exclude nested frames if necessary.\n    // Note that the source was already verified to be either the contentWindow\n    // of the iframe itself or a descendant window within it.\n    if (!opt_includingNestedWindows && source != iframe.contentWindow) {\n      return;\n    }\n\n    if (data.sentinel == UNLISTEN_SENTINEL) {\n      unlisten();\n      return;\n    }\n    callback(data, source, origin, event);\n  };\n\n  events.push(listener);\n\n  return (unlisten = function() {\n    if (listener) {\n      const index = events.indexOf(listener);\n      if (index > -1) {\n        events.splice(index, 1);\n      }\n      // Make sure references to the unlisten function do not keep\n      // alive too much.\n      listener = null;\n      events = null;\n      callback = null;\n    }\n  });\n}\n\n/**\n * Returns a promise that resolves when one of given messages has been observed\n * for the first time. And remove listener for all other messages.\n * @param {!Element} iframe\n * @param {string|!Array<string>} typeOfMessages\n * @param {boolean=} opt_is3P\n * @return {!Promise<!{data: !JsonObject, source: !Window, origin: string, event: !MessageEvent}>}\n */\nexport function listenForOncePromise(iframe, typeOfMessages, opt_is3P) {\n  const unlistenList = [];\n  if (typeof typeOfMessages == 'string') {\n    typeOfMessages = [typeOfMessages];\n  }\n  return new Promise(resolve => {\n    for (let i = 0; i < typeOfMessages.length; i++) {\n      const message = typeOfMessages[i];\n      const unlisten = listenFor(\n        iframe,\n        message,\n        (data, source, origin, event) => {\n          for (let i = 0; i < unlistenList.length; i++) {\n            unlistenList[i]();\n          }\n          resolve({data, source, origin, event});\n        },\n        opt_is3P\n      );\n      unlistenList.push(unlisten);\n    }\n  });\n}\n\n/**\n * Posts a message to the iframe.\n * @param {!Element} iframe The iframe.\n * @param {string} type Type of the message.\n * @param {!JsonObject} object Message payload.\n * @param {string} targetOrigin origin of the target.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n */\nexport function postMessage(iframe, type, object, targetOrigin, opt_is3P) {\n  postMessageToWindows(\n    iframe,\n    [{win: iframe.contentWindow, origin: targetOrigin}],\n    type,\n    object,\n    opt_is3P\n  );\n}\n\n/**\n * Posts an identical message to multiple target windows with the same\n * sentinel.\n * The message is serialized only once.\n * @param {!Element} iframe The iframe.\n * @param {!Array<{win: !Window, origin: string}>} targets to send the message\n *     to, pairs of window and its origin.\n * @param {string} type Type of the message.\n * @param {!JsonObject} object Message payload.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n */\nexport function postMessageToWindows(iframe, targets, type, object, opt_is3P) {\n  if (!iframe.contentWindow) {\n    return;\n  }\n  object['type'] = type;\n  object['sentinel'] = getSentinel_(iframe, opt_is3P);\n  let payload = object;\n  if (opt_is3P) {\n    // Serialize ourselves because that is much faster in Chrome.\n    payload = 'amp-' + JSON.stringify(object);\n  }\n  for (let i = 0; i < targets.length; i++) {\n    const target = targets[i];\n    target.win./*OK*/ postMessage(payload, target.origin);\n  }\n}\n\n/**\n * Gets the sentinel string.\n * @param {!Element} iframe The iframe.\n * @param {boolean=} opt_is3P set to true if the iframe is 3p.\n * @return {string} Sentinel string.\n * @private\n */\nfunction getSentinel_(iframe, opt_is3P) {\n  return opt_is3P ? iframe.getAttribute('data-amp-3p-sentinel') : 'amp';\n}\n\n/**\n * JSON parses event.data if it needs to be\n * @param {*} data\n * @return {?JsonObject} object message\n * @private\n * @visibleForTesting\n */\nexport function parseIfNeeded(data) {\n  if (typeof data == 'string') {\n    if (data.charAt(0) == '{') {\n      data =\n        tryParseJson(data, e => {\n          dev().warn(\n            'IFRAME-HELPER',\n            'Postmessage could not be parsed. ' +\n              'Is it in a valid JSON format?',\n            e\n          );\n        }) || null;\n    } else if (isAmpMessage(data)) {\n      data = deserializeMessage(data);\n    } else {\n      data = null;\n    }\n  }\n  return /** @type {?JsonObject} */ (data);\n}\n\n/**\n * Manages a postMessage API for an iframe with a subscription message and\n * a way to broadcast messages to all subscribed windows, which\n * in turn must all be descendants of the contentWindow of the iframe.\n */\nexport class SubscriptionApi {\n  /**\n   * @param {!Element} iframe The iframe.\n   * @param {string} type Type of the subscription message.\n   * @param {boolean} is3p set to true if the iframe is 3p.\n   * @param {function(!JsonObject, !Window, string)} requestCallback Callback\n   *     invoked whenever a new window subscribes.\n   */\n  constructor(iframe, type, is3p, requestCallback) {\n    /** @private @const {!Element} */\n    this.iframe_ = iframe;\n    /** @private @const {boolean} */\n    this.is3p_ = is3p;\n    /** @private @const {!Array<{win: !Window, origin: string}>} */\n    this.clientWindows_ = [];\n\n    /** @private @const {!UnlistenDef} */\n    this.unlisten_ = listenFor(\n      this.iframe_,\n      type,\n      (data, source, origin) => {\n        // This message might be from any window within the iframe, we need\n        // to keep track of which windows want to be sent updates.\n        if (!this.clientWindows_.some(entry => entry.win == source)) {\n          this.clientWindows_.push({win: source, origin});\n        }\n        requestCallback(data, source, origin);\n      },\n      this.is3p_,\n      // For 3P frames we also allow nested frames within them to subscribe..\n      this.is3p_ /* opt_includingNestedWindows */\n    );\n  }\n\n  /**\n   * Sends a message to all subscribed windows.\n   * @param {string} type Type of the message.\n   * @param {!JsonObject} data Message payload.\n   */\n  send(type, data) {\n    // Remove clients that have been removed from the DOM.\n    remove(this.clientWindows_, client => !client.win.parent);\n    postMessageToWindows(\n      this.iframe_,\n      this.clientWindows_,\n      type,\n      data,\n      this.is3p_\n    );\n  }\n\n  /**\n   * Destroys iframe.\n   */\n  destroy() {\n    this.unlisten_();\n    this.clientWindows_.length = 0;\n  }\n}\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nexport function looksLikeTrackingIframe(element) {\n  const box = element.getLayoutBox();\n  // This heuristic is subject to change.\n  if (box.width > 10 || box.height > 10) {\n    return false;\n  }\n  // Iframe is not tracking iframe if open with user interaction\n  return !closestAncestorElementBySelector(element, '.i-amphtml-overlay');\n}\n\n// Most common ad sizes\n// Array of [width, height] pairs.\nconst adSizes = [[300, 250], [320, 50], [300, 50], [320, 100]];\n\n/**\n * Guess whether this element might be an ad.\n * @param {!Element} element An amp-iframe element.\n * @return {boolean}\n * @visibleForTesting\n */\nexport function isAdLike(element) {\n  const box = element.getLayoutBox();\n  const {height, width} = box;\n  for (let i = 0; i < adSizes.length; i++) {\n    const refWidth = adSizes[i][0];\n    const refHeight = adSizes[i][1];\n    if (refHeight > height) {\n      continue;\n    }\n    if (refWidth > width) {\n      continue;\n    }\n    // Fuzzy matching to account for padding.\n    if (height - refHeight <= 20 && width - refWidth <= 20) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * @param {!Element} iframe\n * @return {!Element}\n * @private\n */\nexport function disableScrollingOnIframe(iframe) {\n  addAttributesToElement(iframe, dict({'scrolling': 'no'}));\n\n  // This shouldn't work, but it does on Firefox.\n  // https://stackoverflow.com/a/15494969\n  setStyle(iframe, 'overflow', 'hidden');\n\n  return iframe;\n}\n\n/**\n * Returns true if win's properties can be accessed and win is defined.\n * This functioned is used to determine if a window is cross-domained\n * from the perspective of the current window.\n * @param {!Window} win\n * @return {boolean}\n * @private\n */\nexport function canInspectWindow(win) {\n  // TODO: this is not reliable.  The compiler assumes that property reads are\n  // side-effect free.  The recommended fix is to use goog.reflect.sinkValue\n  // but since we're not using the closure library I'm not sure how to do this.\n  // See https://github.com/google/closure-compiler/issues/3156\n  try {\n    // win['test'] could be truthy but not true the compiler shouldn't be able\n    // to optimize this check away.\n    return !!win.location.href && (win['test'] || true);\n  } catch (unusedErr) {\n    // eslint-disable-line no-unused-vars\n    return false;\n  }\n}\n\n/** @const {string} */\nexport const FIE_EMBED_PROP = '__AMP_EMBED__';\n\n/**\n * Returns the embed created using `installFriendlyIframeEmbed` or `null`.\n * Caution: This will only return the FIE after the iframe has 'loaded'. If you\n * are checking before this signal you may be in a race condition that returns\n * null.\n * @param {!HTMLIFrameElement} iframe\n * @return {?./friendly-iframe-embed.FriendlyIframeEmbed}\n */\nexport function getFriendlyIframeEmbedOptional(iframe) {\n  return /** @type {?./friendly-iframe-embed.FriendlyIframeEmbed} */ (iframe[\n    FIE_EMBED_PROP\n  ]);\n}\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isInFie(element) {\n  return (\n    element.classList.contains('i-amphtml-fie') ||\n    !!closestAncestorElementBySelector(element, '.i-amphtml-fie')\n  );\n}\n\n/**\n * @param {!HTMLIFrameElement} iframe\n */\nexport function makePausable(iframe) {\n  const oldAllow = (iframe.getAttribute('allow') || '').trim();\n  iframe.setAttribute(\n    'allow',\n    `${EXECUTION_WHILE_NOT_RENDERED} 'none';` + oldAllow\n  );\n}\n\n/**\n * @param {!HTMLIFrameElement} iframe\n * @return {boolean}\n */\nexport function isPausable(iframe) {\n  return (\n    !!iframe.featurePolicy &&\n    iframe.featurePolicy.features().indexOf(EXECUTION_WHILE_NOT_RENDERED) !=\n      -1 &&\n    !iframe.featurePolicy.allowsFeature(EXECUTION_WHILE_NOT_RENDERED)\n  );\n}\n\n/**\n * @param {!HTMLIFrameElement} iframe\n * @param {boolean} paused\n */\nexport function setPaused(iframe, paused) {\n  toggle(iframe, !paused);\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './utils/promise';\nimport {Services} from './services';\nimport {\n  addParamsToUrl,\n  isProxyOrigin,\n  parseQueryString,\n  parseUrlDeprecated,\n} from './url';\nimport {dev, user, userAssert} from './log';\nimport {getMode} from './mode';\nimport {isExperimentOn} from './experiments';\n\nconst TIMEOUT_VALUE = 8000;\n\nlet trackImpressionPromise = null;\n\nconst DEFAULT_APPEND_URL_PARAM = ['gclid', 'gclsrc'];\n\n/**\n * These domains are trusted with more sensitive viewer operations such as\n * sending impression requests. If you believe your domain should be here,\n * file the issue on GitHub to discuss. The process will be similar\n * (but somewhat more stringent) to the one described in the [3p/README.md](\n * https://github.com/ampproject/amphtml/blob/master/3p/README.md)\n *\n * @export {!Array<!RegExp>}\n */\nconst TRUSTED_REFERRER_HOSTS = [\n  /**\n   * Twitter's link wrapper domains:\n   * - t.co\n   */\n  /^t.co$/,\n];\n\n/**\n * A function to get the trackImpressionPromise;\n * @return {!Promise}\n */\nexport function getTrackImpressionPromise() {\n  return userAssert(trackImpressionPromise, 'E#19457 trackImpressionPromise');\n}\n\n/**\n * Function that reset the trackImpressionPromise only for testing\n * @visibleForTesting\n */\nexport function resetTrackImpressionPromiseForTesting() {\n  trackImpressionPromise = null;\n}\n\n/**\n * Emit a HTTP request to a destination defined on the incoming URL.\n * Launched for trusted viewer. Otherwise guarded by experiment.\n * @param {!Window} win\n */\nexport function maybeTrackImpression(win) {\n  const deferred = new Deferred();\n  const {promise, resolve: resolveImpression} = deferred;\n\n  trackImpressionPromise = Services.timerFor(win)\n    .timeoutPromise(TIMEOUT_VALUE, promise, 'TrackImpressionPromise timeout')\n    .catch(error => {\n      dev().warn('IMPRESSION', error);\n    });\n\n  const viewer = Services.viewerForDoc(win.document.documentElement);\n  const isTrustedViewerPromise = viewer.isTrustedViewer();\n  const isTrustedReferrerPromise = viewer\n    .getReferrerUrl()\n    .then(referrer => isTrustedReferrer(referrer));\n  Promise.all([isTrustedViewerPromise, isTrustedReferrerPromise]).then(\n    results => {\n      const isTrustedViewer = results[0];\n      const isTrustedReferrer = results[1];\n      // Enable the feature in the case of trusted viewer,\n      // or trusted referrer\n      // or with experiment turned on\n      if (\n        !isTrustedViewer &&\n        !isTrustedReferrer &&\n        !isExperimentOn(win, 'alp')\n      ) {\n        resolveImpression();\n        return;\n      }\n\n      const replaceUrlPromise = handleReplaceUrl(win);\n      const clickUrlPromise = handleClickUrl(win);\n\n      Promise.all([replaceUrlPromise, clickUrlPromise]).then(\n        () => {\n          resolveImpression();\n        },\n        () => {}\n      );\n    }\n  );\n}\n\n/**\n * Signal that impression tracking is not relevant in this environment.\n */\nexport function doNotTrackImpression() {\n  trackImpressionPromise = Promise.resolve();\n}\n\n/**\n * Handle the getReplaceUrl and return a promise when url is replaced Only\n * handles replaceUrl when viewer indicates AMP to do so. Viewer should indicate\n * by setting the legacy replaceUrl init param and add `replaceUrl` to its\n * capability param. Future plan is to change the type of legacy init replaceUrl\n * param from url string to boolean value. Please NOTE replaceUrl and adLocation\n * will never arrive at same time, so there is no race condition on the order of\n * handling url replacement.\n * @param {!Window} win\n * @return {!Promise}\n */\nfunction handleReplaceUrl(win) {\n  const viewer = Services.viewerForDoc(win.document.documentElement);\n\n  // ReplaceUrl substitution doesn't have to wait until the document is visible\n  if (!viewer.getParam('replaceUrl')) {\n    // The init replaceUrl param serve as a signal on whether replaceUrl is\n    // required for this doc.\n    return Promise.resolve();\n  }\n\n  if (!viewer.hasCapability('replaceUrl')) {\n    // If Viewer is not capability of providing async replaceUrl, use the legacy\n    // init replaceUrl param.\n    viewer.replaceUrl(viewer.getParam('replaceUrl') || null);\n    return Promise.resolve();\n  }\n\n  // request async replaceUrl is viewer support getReplaceUrl.\n  return viewer\n    .sendMessageAwaitResponse('getReplaceUrl', /* data */ undefined)\n    .then(\n      response => {\n        if (!response || typeof response != 'object') {\n          dev().warn('IMPRESSION', 'get invalid replaceUrl response');\n          return;\n        }\n        viewer.replaceUrl(response['replaceUrl'] || null);\n      },\n      err => {\n        dev().warn('IMPRESSION', 'Error request replaceUrl from viewer', err);\n      }\n    );\n}\n\n/**\n * @param {string} referrer\n * @return {boolean}\n * @visibleForTesting\n */\nexport function isTrustedReferrer(referrer) {\n  const url = parseUrlDeprecated(referrer);\n  if (url.protocol != 'https:') {\n    return false;\n  }\n  return TRUSTED_REFERRER_HOSTS.some(th => th.test(url.hostname));\n}\n\n/**\n * Perform the impression request if it has been provided via\n * the click param in the viewer arguments. Returns a promise.\n * @param {!Window} win\n * @return {!Promise}\n */\nfunction handleClickUrl(win) {\n  const ampdoc = Services.ampdoc(win.document.documentElement);\n  const viewer = Services.viewerForDoc(ampdoc);\n\n  /** @const {?string} */\n  const clickUrl = viewer.getParam('click');\n  if (!clickUrl) {\n    return Promise.resolve();\n  }\n\n  if (clickUrl.indexOf('https://') != 0) {\n    user().warn(\n      'IMPRESSION',\n      'click fragment param should start with https://. Found ',\n      clickUrl\n    );\n    return Promise.resolve();\n  }\n\n  if (win.location.hash) {\n    // This is typically done using replaceState inside the viewer.\n    // If for some reason it failed, get rid of the fragment here to\n    // avoid duplicate tracking.\n    win.location.hash = '';\n  }\n\n  // TODO(@zhouyx) need test with a real response.\n  return ampdoc\n    .whenFirstVisible()\n    .then(() => {\n      return invoke(win, dev().assertString(clickUrl));\n    })\n    .then(response => {\n      applyResponse(win, response);\n    })\n    .catch(err => {\n      user().warn('IMPRESSION', 'Error on request clickUrl: ', err);\n    });\n}\n\n/**\n * Send the url to ad server and wait for its response\n * @param {!Window} win\n * @param {string} clickUrl\n * @return {!Promise<?JsonObject>}\n */\nfunction invoke(win, clickUrl) {\n  if (getMode().localDev && !getMode().test) {\n    clickUrl = 'http://localhost:8000/impression-proxy?url=' + clickUrl;\n  }\n  return Services.xhrFor(win)\n    .fetchJson(clickUrl, {\n      credentials: 'include',\n    })\n    .then(res => {\n      // Treat 204 no content response specially\n      if (res.status == 204) {\n        return null;\n      }\n      return res.json();\n    });\n}\n\n/**\n * parse the response back from ad server\n * Set for analytics purposes\n * @param {!Window} win\n * @param {?JsonObject} response\n */\nfunction applyResponse(win, response) {\n  if (!response) {\n    return;\n  }\n\n  const adLocation = response['location'];\n  const adTracking = response['tracking_url'];\n\n  // If there is a tracking_url, need to track it\n  // Otherwise track the location\n  const trackUrl = adTracking || adLocation;\n\n  if (trackUrl && !isProxyOrigin(trackUrl)) {\n    // To request the provided trackUrl for tracking purposes.\n    new Image().src = trackUrl;\n  }\n\n  // Replace the location href params with new location params we get (if any).\n  if (adLocation) {\n    if (!win.history.replaceState) {\n      return;\n    }\n\n    const viewer = Services.viewerForDoc(win.document.documentElement);\n    const currentHref = win.location.href;\n    const url = parseUrlDeprecated(adLocation);\n    const params = parseQueryString(url.search);\n    const newHref = addParamsToUrl(currentHref, params);\n    // TODO: Avoid overwriting the fragment parameter.\n    win.history.replaceState(null, '', newHref);\n    viewer.maybeUpdateFragmentForCct();\n  }\n}\n\n/**\n * Return a promise that whether appending extra url params to outgoing link is\n * required.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<boolean>}\n */\nexport function shouldAppendExtraParams(ampdoc) {\n  return ampdoc.whenReady().then(() => {\n    return !!ampdoc\n      .getBody()\n      .querySelector('amp-analytics[type=googleanalytics]');\n  });\n}\n\n/**\n * Return the extra url params string that should be appended to outgoing link\n * @param {!Window} win\n * @param {!Element} target\n * @return {string}\n */\nexport function getExtraParamsUrl(win, target) {\n  // Get an array with extra params that needs to append.\n  const url = parseUrlDeprecated(win.location.href);\n  const params = parseQueryString(url.search);\n  const appendParams = [];\n  for (let i = 0; i < DEFAULT_APPEND_URL_PARAM.length; i++) {\n    const param = DEFAULT_APPEND_URL_PARAM[i];\n    if (typeof params[param] !== 'undefined') {\n      appendParams.push(param);\n    }\n  }\n\n  // Check if the param already exists\n  const additionalUrlParams = target.getAttribute('data-amp-addparams');\n  let {href} = target;\n  if (additionalUrlParams) {\n    href = addParamsToUrl(href, parseQueryString(additionalUrlParams));\n  }\n  const loc = parseUrlDeprecated(href);\n  const existParams = parseQueryString(loc.search);\n  for (let i = appendParams.length - 1; i >= 0; i--) {\n    const param = appendParams[i];\n    if (typeof existParams[param] !== 'undefined') {\n      appendParams.splice(i, 1);\n    }\n  }\n  return getQueryParamUrl(appendParams);\n}\n\n/**\n * Helper method to convert an query param array to string\n * @param {!Array<string>} params\n * @return {string}\n */\nfunction getQueryParamUrl(params) {\n  let url = '';\n  for (let i = 0; i < params.length; i++) {\n    const param = params[i];\n    url +=\n      i == 0\n        ? `${param}=QUERY_PARAM(${param})`\n        : `&${param}=QUERY_PARAM(${param})`;\n  }\n  return url;\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {READY_SCAN_SIGNAL} from './service/resources-interface';\nimport {Services} from './services';\n\n/** @const {!Array<string>} */\nconst EXCLUDE_INI_LOAD = [\n  'AMP-AD',\n  'AMP-ANALYTICS',\n  'AMP-PIXEL',\n  'AMP-AD-EXIT',\n];\n\n/**\n * Returns the promise that will be resolved when all content elements\n * have been loaded in the initially visible set.\n * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {!Window} hostWin\n * @param {!./layout-rect.LayoutRectDef} rect\n * @param {boolean=} opt_isInPrerender signifies if we are in prerender mode.\n * @return {!Promise}\n */\nexport function whenContentIniLoad(\n  elementOrAmpDoc,\n  hostWin,\n  rect,\n  opt_isInPrerender\n) {\n  const ampdoc = Services.ampdoc(elementOrAmpDoc);\n  return getMeasuredResources(ampdoc, hostWin, r => {\n    // TODO(jridgewell): Remove isFixed check here once the position\n    // is calculted correctly in a separate layer for embeds.\n    if (\n      !r.isDisplayed() ||\n      (!r.overlaps(rect) && !r.isFixed()) ||\n      (opt_isInPrerender && !r.prerenderAllowed())\n    ) {\n      return false;\n    }\n    return true;\n  }).then(resources => {\n    const promises = [];\n    resources.forEach(r => {\n      if (!EXCLUDE_INI_LOAD.includes(r.element.tagName)) {\n        promises.push(r.loadedOnce());\n      }\n    });\n    return Promise.all(promises);\n  });\n}\n\n/**\n * Returns a subset of resources which are (1) belong to the specified host\n * window, and (2) meet the filterFn given.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {!Window} hostWin\n * @param {function(!./service/resource.Resource):boolean} filterFn\n * @return {!Promise<!Array<!./service/resource.Resource>>}\n */\nexport function getMeasuredResources(ampdoc, hostWin, filterFn) {\n  // First, wait for the `ready-scan` signal. Waiting for each element\n  // individually is too expensive and `ready-scan` will cover most of\n  // the initially parsed elements.\n  // TODO(jridgewell): this path should be switched to use a future\n  // \"layer has been measured\" signal.\n  return ampdoc\n    .signals()\n    .whenSignal(READY_SCAN_SIGNAL)\n    .then(() => {\n      // Second, wait for any left-over elements to complete measuring.\n      const measurePromiseArray = [];\n      const resources = Services.resourcesForDoc(ampdoc);\n      resources.get().forEach(r => {\n        if (!r.hasBeenMeasured() && r.hostWin == hostWin && !r.hasOwner()) {\n          measurePromiseArray.push(r.getPageLayoutBoxAsync());\n        }\n      });\n      return Promise.all(measurePromiseArray);\n    })\n    .then(() => {\n      const resources = Services.resourcesForDoc(ampdoc);\n      return resources.get().filter(r => {\n        return (\n          r.hostWin == hostWin &&\n          !r.hasOwner() &&\n          r.hasBeenMeasured() &&\n          filterFn(r)\n        );\n      });\n    });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from './observable';\nimport {Services} from './services';\nimport {dev} from './log';\nimport {listenOnce, listenOncePromise} from './event-helper';\nimport {registerServiceBuilder} from './service';\n\nconst TAG_ = 'Input';\n\nconst MAX_MOUSE_CONFIRM_ATTEMPS_ = 3;\nconst CLICK_TIMEOUT_ = 300;\n\n/**\n * Detects and maintains different types of input such as touch, mouse or\n * keyboard.\n */\nexport class Input {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private {!Function} */\n    this.boundOnKeyDown_ = this.onKeyDown_.bind(this);\n\n    /** @private {!Function} */\n    this.boundOnMouseDown_ = this.onMouseDown_.bind(this);\n\n    /** @private {?function(!Event)} */\n    this.boundOnMouseMove_ = null;\n\n    /** @private {?Function} */\n    this.boundMouseCanceled_ = null;\n\n    /** @private {?Function} */\n    this.boundMouseConfirmed_ = null;\n\n    /** @private {boolean} */\n    this.hasTouch_ =\n      'ontouchstart' in win ||\n      (win.navigator['maxTouchPoints'] !== undefined &&\n        win.navigator['maxTouchPoints'] > 0) ||\n      win['DocumentTouch'] !== undefined;\n    dev().fine(TAG_, 'touch detected:', this.hasTouch_);\n\n    /** @private {boolean} */\n    this.keyboardActive_ = false;\n    this.win.document.addEventListener('keydown', this.boundOnKeyDown_);\n    this.win.document.addEventListener('mousedown', this.boundOnMouseDown_);\n\n    /** @private {boolean} */\n    this.hasMouse_ = true;\n\n    /** @private {number} */\n    this.mouseConfirmAttemptCount_ = 0;\n\n    /** @private {!Observable<boolean>} */\n    this.touchDetectedObservable_ = new Observable();\n\n    /** @private {!Observable<boolean>} */\n    this.mouseDetectedObservable_ = new Observable();\n\n    /** @private {!Observable<boolean>} */\n    this.keyboardStateObservable_ = new Observable();\n\n    // If touch available, temporarily set hasMouse to false and wait for\n    // mouse events.\n    if (this.hasTouch_) {\n      this.hasMouse_ = !this.hasTouch_;\n      this.boundOnMouseMove_ = /** @type {function(!Event)} */ (this.onMouseMove_.bind(\n        this\n      ));\n      listenOnce(win.document, 'mousemove', this.boundOnMouseMove_);\n    }\n  }\n\n  /**\n   * Whether the touch input has been detected.\n   * @return {boolean}\n   */\n  isTouchDetected() {\n    return this.hasTouch_;\n  }\n\n  /**\n   * Registers an event handle in case if the touch is detected.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onTouchDetected(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isTouchDetected());\n    }\n    return this.touchDetectedObservable_.add(handler);\n  }\n\n  /**\n   * Whether the mouse input has been detected.\n   * @return {boolean}\n   */\n  isMouseDetected() {\n    return this.hasMouse_;\n  }\n\n  /**\n   * Registers an event handle in case if the mouse is detected.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onMouseDetected(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isMouseDetected());\n    }\n    return this.mouseDetectedObservable_.add(handler);\n  }\n\n  /**\n   * Whether the keyboard input is currently active.\n   * @return {boolean}\n   */\n  isKeyboardActive() {\n    return this.keyboardActive_;\n  }\n\n  /**\n   * Registers an event handle for changes in the keyboard input.\n   * @param {function(boolean)} handler\n   * @param {boolean=} opt_fireImmediately\n   * @return {!UnlistenDef}\n   */\n  onKeyboardStateChanged(handler, opt_fireImmediately) {\n    if (opt_fireImmediately) {\n      handler(this.isKeyboardActive());\n    }\n    return this.keyboardStateObservable_.add(handler);\n  }\n\n  /**\n   * @param {!Event} e\n   * @private\n   */\n  onKeyDown_(e) {\n    if (this.keyboardActive_) {\n      return;\n    }\n\n    if (e.defaultPrevented) {\n      return;\n    }\n\n    // Ignore inputs.\n    const {target} = e;\n    if (\n      target &&\n      (target.tagName == 'INPUT' ||\n        target.tagName == 'TEXTAREA' ||\n        target.tagName == 'SELECT' ||\n        target.tagName == 'OPTION' ||\n        target.hasAttribute('contenteditable'))\n    ) {\n      return;\n    }\n\n    this.keyboardActive_ = true;\n    this.keyboardStateObservable_.fire(true);\n    dev().fine(TAG_, 'keyboard activated');\n  }\n\n  /** @private */\n  onMouseDown_() {\n    if (!this.keyboardActive_) {\n      return;\n    }\n    this.keyboardActive_ = false;\n    this.keyboardStateObservable_.fire(false);\n    dev().fine(TAG_, 'keyboard deactivated');\n  }\n\n  /**\n   * @param {!Event} e\n   * @return {!Promise|undefined}\n   * @private\n   */\n  onMouseMove_(e) {\n    // The event explicitly states that it's a result of a touch event.\n    if (e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents) {\n      this.mouseCanceled_();\n      return undefined;\n    }\n    if (!this.boundMouseConfirmed_) {\n      this.boundMouseConfirmed_ = this.mouseConfirmed_.bind(this);\n      this.boundMouseCanceled_ = this.mouseCanceled_.bind(this);\n    }\n    // If \"click\" arrives within a timeout time, this is most likely a\n    // touch/mouse emulation. Otherwise, if timeout exceeded, this looks\n    // like a legitimate mouse event.\n    let unlisten;\n    const listenPromise = listenOncePromise(\n      this.win.document,\n      'click',\n      /* capture */ undefined,\n      unlistener => {\n        unlisten = unlistener;\n      }\n    );\n    return Services.timerFor(this.win)\n      .timeoutPromise(CLICK_TIMEOUT_, listenPromise)\n      .then(this.boundMouseCanceled_, () => {\n        if (unlisten) {\n          unlisten();\n        }\n        this.boundMouseConfirmed_();\n      });\n  }\n\n  /** @private */\n  mouseConfirmed_() {\n    this.hasMouse_ = true;\n    this.mouseDetectedObservable_.fire(true);\n    dev().fine(TAG_, 'mouse detected');\n  }\n\n  /** @private */\n  mouseCanceled_() {\n    // Repeat, if attempts allow.\n    this.mouseConfirmAttemptCount_++;\n    if (this.mouseConfirmAttemptCount_ <= MAX_MOUSE_CONFIRM_ATTEMPS_) {\n      listenOnce(\n        this.win.document,\n        'mousemove',\n        /** @type {function(!Event)} */ (this.boundOnMouseMove_)\n      );\n    } else {\n      dev().fine(TAG_, 'mouse detection failed');\n    }\n  }\n}\n\n/**\n * @param {!Window} win\n */\nexport function installInputService(win) {\n  registerServiceBuilder(win, 'input', Input);\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns the internal AMP runtime version. Note that this is not the RTV,\n * which is a prefix and the runtime version.\n *\n * The call sites for this function are replaced with a compile time constant\n * string.\n *\n * @return {string}\n */\nexport function internalRuntimeVersion() {\n  return '$internalRuntimeVersion$';\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Pass} from './pass';\nimport {Services} from './services';\nimport {SubscriptionApi} from './iframe-helper';\nimport {dev, devAssert} from './log';\nimport {dict} from './utils/object';\nimport {isArray, isFiniteNumber} from './types';\nimport {layoutRectLtwh, moveLayoutRect, rectIntersection} from './layout-rect';\n\n/**\n * The structure that defines the rectangle used in intersection observers.\n *\n * @typedef {{\n *   top: number,\n *   bottom: number,\n *   left: number,\n *   right: number,\n *   width: number,\n *   height: number,\n *   x: number,\n *   y: number,\n * }}\n */\nexport let DOMRect;\n\nexport const DEFAULT_THRESHOLD = [\n  0,\n  0.05,\n  0.1,\n  0.15,\n  0.2,\n  0.25,\n  0.3,\n  0.35,\n  0.4,\n  0.45,\n  0.5,\n  0.55,\n  0.6,\n  0.65,\n  0.7,\n  0.75,\n  0.8,\n  0.85,\n  0.9,\n  0.95,\n  1,\n];\n\n/** @typedef {{\n *    element: !Element,\n *    currentThresholdSlot: number,\n *  }}\n */\nlet ElementIntersectionStateDef;\n\n/** @const @private */\nconst TAG = 'INTERSECTION-OBSERVER';\n\n/** @const @private */\nconst INIT_TIME = Date.now();\n\n/**\n * A function to get the element's current IntersectionObserverEntry\n * regardless of the intersetion ratio. Only available when element is not\n * nested in a container iframe.\n * TODO: support opt_iframe if there's valid use cases.\n * @param {!./layout-rect.LayoutRectDef} element element's rect\n * @param {?./layout-rect.LayoutRectDef} owner element's owner rect\n * @param {!./layout-rect.LayoutRectDef} hostViewport hostViewport's rect\n * @return {!IntersectionObserverEntry} A change entry.\n */\nexport function getIntersectionChangeEntry(element, owner, hostViewport) {\n  const intersection =\n    rectIntersection(element, owner, hostViewport) ||\n    layoutRectLtwh(0, 0, 0, 0);\n  const ratio = intersectionRatio(intersection, element);\n  return calculateChangeEntry(element, hostViewport, intersection, ratio);\n}\n\n/**\n * @param {!Window} win\n * @return {boolean}\n */\nexport function nativeIntersectionObserverSupported(win) {\n  return (\n    'IntersectionObserver' in win &&\n    'IntersectionObserverEntry' in win &&\n    'intersectionRatio' in win.IntersectionObserverEntry.prototype\n  );\n}\n\n/**\n * A class to help amp-iframe and amp-ad nested iframe listen to intersection\n * change.\n */\nexport class IntersectionObserverApi {\n  /**\n   * @param {!AMP.BaseElement} baseElement\n   * @param {!Element} iframe\n   * @param {boolean=} opt_is3p\n   */\n  constructor(baseElement, iframe, opt_is3p) {\n    /** @private @const {!AMP.BaseElement} */\n    this.baseElement_ = baseElement;\n\n    /** @private {?IntersectionObserverPolyfill} */\n    this.intersectionObserver_ = null;\n\n    /** @private {boolean} */\n    this.shouldObserve_ = false;\n\n    /** @private {boolean} */\n    this.isInViewport_ = false;\n\n    /** @private {?function()} */\n    this.unlistenOnDestroy_ = null;\n\n    /** @private {!./service/viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = baseElement.getViewport();\n\n    /** @private {?SubscriptionApi} */\n    this.subscriptionApi_ = new SubscriptionApi(\n      iframe,\n      'send-intersections',\n      opt_is3p || false,\n      () => {\n        this.startSendingIntersection_();\n      }\n    );\n\n    this.intersectionObserver_ = new IntersectionObserverPolyfill(\n      entries => {\n        // Remove target info from cross origin iframe.\n        for (let i = 0; i < entries.length; i++) {\n          delete entries[i]['target'];\n        }\n        this.subscriptionApi_.send('intersection', dict({'changes': entries}));\n      },\n      {threshold: DEFAULT_THRESHOLD}\n    );\n    this.intersectionObserver_.tick(this.viewport_.getRect());\n\n    /** @const {function()} */\n    this.fire = () => {\n      if (!this.shouldObserve_ || !this.isInViewport_) {\n        return;\n      }\n      this.intersectionObserver_.tick(this.viewport_.getRect());\n    };\n  }\n\n  /**\n   * Function to start listening to viewport event. and observer intersection\n   * change on the element.\n   */\n  startSendingIntersection_() {\n    this.shouldObserve_ = true;\n    this.intersectionObserver_.observe(this.baseElement_.element);\n    this.baseElement_.getVsync().measure(() => {\n      this.isInViewport_ = this.baseElement_.isInViewport();\n      this.fire();\n    });\n\n    const unlistenViewportScroll = this.viewport_.onScroll(this.fire);\n    const unlistenViewportChange = this.viewport_.onChanged(this.fire);\n    this.unlistenOnDestroy_ = () => {\n      unlistenViewportScroll();\n      unlistenViewportChange();\n    };\n  }\n\n  /**\n   * Enable to the PositionObserver to listen to viewport events\n   * @param {boolean} inViewport\n   */\n  onViewportCallback(inViewport) {\n    this.isInViewport_ = inViewport;\n  }\n\n  /**\n   * Clean all listenrs\n   */\n  destroy() {\n    this.shouldObserve_ = false;\n    this.intersectionObserver_.disconnect();\n    this.intersectionObserver_ = null;\n    if (this.unlistenOnDestroy_) {\n      this.unlistenOnDestroy_();\n      this.unlistenOnDestroy_ = null;\n    }\n    this.subscriptionApi_.destroy();\n    this.subscriptionApi_ = null;\n  }\n}\n\n/**\n * The IntersectionObserverPolyfill class lets any element receive its\n * intersection data with the viewport. It acts like native browser supported\n * IntersectionObserver.\n * The IntersectionObserver receives a callback function and an optional option\n * as params. Whenever the element intersection ratio cross a threshold value,\n * IntersectionObserverPolyfill will call the provided callback function with\n * the change entry. Only Works with one document for now.\n * @visibleForTesting\n */\nexport class IntersectionObserverPolyfill {\n  /**\n   * @param {function(!Array<!IntersectionObserverEntry>)} callback\n   * @param {Object=} opt_option\n   */\n  constructor(callback, opt_option) {\n    /** @private @const {function(!Array<!IntersectionObserverEntry>)} */\n    this.callback_ = callback;\n\n    // The input threshold can be a number or an array of numbers.\n    let threshold = opt_option && opt_option.threshold;\n    if (threshold) {\n      threshold = isArray(threshold) ? threshold : [threshold];\n    } else {\n      threshold = [0];\n    }\n\n    for (let i = 0; i < threshold.length; i++) {\n      devAssert(\n        isFiniteNumber(threshold[i]),\n        'Threshold should be a finite number or an array of finite numbers'\n      );\n    }\n\n    /**\n     * A list of threshold, sorted in increasing numeric order\n     * @private @const {!Array}\n     */\n    this.threshold_ = threshold.sort();\n    devAssert(\n      this.threshold_[0] >= 0 &&\n        this.threshold_[this.threshold_.length - 1] <= 1,\n      'Threshold should be in the range from \"[0, 1]\"'\n    );\n\n    /** @private {?./layout-rect.LayoutRectDef} */\n    this.lastViewportRect_ = null;\n\n    /** @private {./layout-rect.LayoutRectDef|undefined} */\n    this.lastIframeRect_ = undefined;\n\n    /**\n     * Store a list of observed elements and their current threshold slot which\n     * their intersection ratio fills, range from [0, this.threshold_.length]\n     * @private {Array<!ElementIntersectionStateDef>}\n     */\n    this.observeEntries_ = [];\n\n    /**\n     * Mutation observer to fire off on visibility changes\n     * @private {?function()}\n     */\n    this.hiddenObserverUnlistener_ = null;\n\n    /** @private {Pass} */\n    this.mutationPass_ = null;\n  }\n\n  /**\n   * Function to unobserve all elements.\n   * and clean up the polyfill.\n   */\n  disconnect() {\n    this.observeEntries_.length = 0;\n    this.disconnectMutationObserver_();\n  }\n\n  /**\n   * Provide a way to observe the intersection change for a specific element\n   * Please note IntersectionObserverPolyfill only support AMP element now\n   * TODO: Support non AMP element\n   * @param {!Element} element\n   */\n  observe(element) {\n    // Check the element is an AMP element.\n    devAssert(element.getLayoutBox);\n\n    // If the element already exists in current observeEntries, do nothing\n    for (let i = 0; i < this.observeEntries_.length; i++) {\n      if (this.observeEntries_[i].element === element) {\n        dev().warn(TAG, 'should observe same element once');\n        return;\n      }\n    }\n\n    const newState = {\n      element,\n      currentThresholdSlot: 0,\n    };\n\n    // Get the new observed element's first changeEntry based on last viewport\n    if (this.lastViewportRect_) {\n      const change = this.getValidIntersectionChangeEntry_(\n        newState,\n        this.lastViewportRect_,\n        this.lastIframeRect_\n      );\n      if (change) {\n        this.callback_([change]);\n      }\n    }\n\n    // Add a mutation observer to tick ourself\n    // TODO (@torch2424): Allow this to observe elements,\n    // from multiple documents.\n    const ampdoc = Services.ampdoc(element);\n    if (ampdoc.win.MutationObserver && !this.hiddenObserverUnlistener_) {\n      this.mutationPass_ = new Pass(\n        ampdoc.win,\n        this.handleMutationObserverPass_.bind(this, element)\n      );\n      const hiddenObserver = Services.hiddenObserverForDoc(element);\n      this.hiddenObserverUnlistener_ = hiddenObserver.add(\n        this.handleMutationObserverNotification_.bind(this)\n      );\n    }\n\n    // push new observed element\n    this.observeEntries_.push(newState);\n  }\n\n  /**\n   * Provide a way to unobserve intersection change for a specified element\n   * @param {!Element} element\n   */\n  unobserve(element) {\n    // find the unobserved element in observeEntries\n    for (let i = 0; i < this.observeEntries_.length; i++) {\n      if (this.observeEntries_[i].element === element) {\n        this.observeEntries_.splice(i, 1);\n        if (this.observeEntries_.length <= 0) {\n          this.disconnectMutationObserver_();\n        }\n        return;\n      }\n    }\n    dev().warn(TAG, 'unobserve non-observed element');\n  }\n\n  /**\n   * Tick function that update the DOMRect of the root of observed elements.\n   * Caller needs to make sure to pass in the correct container.\n   * Note: the opt_iframe param is the iframe position relative to the host doc,\n   * The iframe must be a non-scrollable iframe.\n   * @param {!./layout-rect.LayoutRectDef} hostViewport\n   * @param {./layout-rect.LayoutRectDef=} opt_iframe\n   */\n  tick(hostViewport, opt_iframe) {\n    if (opt_iframe) {\n      // If element inside an iframe. Adjust origin to the iframe.left/top.\n      hostViewport = moveLayoutRect(\n        hostViewport,\n        -opt_iframe.left,\n        -opt_iframe.top\n      );\n      opt_iframe = moveLayoutRect(\n        opt_iframe,\n        -opt_iframe.left,\n        -opt_iframe.top\n      );\n    }\n\n    this.lastViewportRect_ = hostViewport;\n    this.lastIframeRect_ = opt_iframe;\n\n    const changes = [];\n\n    for (let i = 0; i < this.observeEntries_.length; i++) {\n      const change = this.getValidIntersectionChangeEntry_(\n        this.observeEntries_[i],\n        hostViewport,\n        opt_iframe\n      );\n      if (change) {\n        changes.push(change);\n      }\n    }\n\n    if (changes.length) {\n      this.callback_(changes);\n    }\n  }\n\n  /**\n   * Return a change entry for one element that should be compatible with\n   * IntersectionObserverEntry if it's valid with current config.\n   * When the new intersection ratio doesn't cross one of a threshold value,\n   * the function will return null.\n   *\n   * @param {!ElementIntersectionStateDef} state\n   * @param {!./layout-rect.LayoutRectDef} hostViewport hostViewport's rect\n   * @param {./layout-rect.LayoutRectDef=} opt_iframe iframe container rect\n   *    If opt_iframe is provided, all LayoutRect has position relative to\n   *    the iframe. If opt_iframe is not provided,\n   *    all LayoutRect has position relative to the host document.\n   * @return {?IntersectionObserverEntry} A valid change entry or null if ratio\n   * @private\n   */\n  getValidIntersectionChangeEntry_(state, hostViewport, opt_iframe) {\n    const {element} = state;\n\n    const elementRect = element.getLayoutBox();\n    const owner = element.getOwner();\n    const ownerRect = owner && owner.getLayoutBox();\n\n    // calculate intersectionRect. that the element intersects with hostViewport\n    // and intersects with owner element and container iframe if exists.\n    const intersectionRect =\n      rectIntersection(elementRect, ownerRect, hostViewport, opt_iframe) ||\n      layoutRectLtwh(0, 0, 0, 0);\n    // calculate ratio, call callback based on new ratio value.\n    const ratio = intersectionRatio(intersectionRect, elementRect);\n    const newThresholdSlot = getThresholdSlot(this.threshold_, ratio);\n\n    if (newThresholdSlot == state.currentThresholdSlot) {\n      return null;\n    }\n    state.currentThresholdSlot = newThresholdSlot;\n\n    // To get same behavior as native IntersectionObserver set hostViewport null\n    // if inside an iframe\n    const changeEntry = calculateChangeEntry(\n      elementRect,\n      opt_iframe ? null : hostViewport,\n      intersectionRect,\n      ratio\n    );\n    changeEntry.target = element;\n    return changeEntry;\n  }\n\n  /**\n   * Handle Mutation Oberserver events\n   * @private\n   */\n  handleMutationObserverNotification_() {\n    if (this.mutationPass_.isPending()) {\n      return;\n    }\n\n    // Wait one animation frame so that other mutations may arrive.\n    this.mutationPass_.schedule(16);\n  }\n\n  /**\n   * Handle Mutation Observer Pass\n   * This performas the tick, and is wrapped in a paas\n   * To handle throttling of the observer\n   * @param {!Element} element\n   * @private\n   */\n  handleMutationObserverPass_(element) {\n    const viewport = Services.viewportForDoc(element);\n    const resources = Services.resourcesForDoc(element);\n    resources.onNextPass(() => {\n      this.tick(viewport.getRect());\n    });\n  }\n\n  /**\n   * Clean up the mutation observer\n   * @private\n   */\n  disconnectMutationObserver_() {\n    if (this.hiddenObserverUnlistener_) {\n      this.hiddenObserverUnlistener_();\n    }\n    this.hiddenObserverUnlistener_ = null;\n    if (this.mutationPass_) {\n      this.mutationPass_.cancel();\n    }\n    this.mutationPass_ = null;\n  }\n}\n\n/**\n * Returns the ratio of the smaller box's area to the larger box's area.\n * @param {!./layout-rect.LayoutRectDef} smaller\n * @param {!./layout-rect.LayoutRectDef} larger\n * @return {number}\n * @visibleForTesting\n */\nexport function intersectionRatio(smaller, larger) {\n  const smallerBoxArea = smaller.width * smaller.height;\n  const largerBoxArea = larger.width * larger.height;\n\n  // Check for a divide by zero\n  return largerBoxArea === 0 ? 0 : smallerBoxArea / largerBoxArea;\n}\n\n/**\n * Returns the slot number that the current ratio fills in.\n * @param {!Array} sortedThreshold valid sorted IoB threshold\n * @param {number} ratio Range from [0, 1]\n * @return {number} Range from [0, threshold.length]\n * @visibleForTesting\n */\nexport function getThresholdSlot(sortedThreshold, ratio) {\n  let startIdx = 0;\n  let endIdx = sortedThreshold.length;\n  // 0 is a special case that does not fit into [small, large) range\n  if (ratio == 0) {\n    return 0;\n  }\n  let mid = ((startIdx + endIdx) / 2) | 0;\n  while (startIdx < mid) {\n    const midValue = sortedThreshold[mid];\n    // In the range of [small, large)\n    if (ratio < midValue) {\n      endIdx = mid;\n    } else {\n      startIdx = mid;\n    }\n    mid = ((startIdx + endIdx) / 2) | 0;\n  }\n  return endIdx;\n}\n\n/**\n * Helper function to calculate the IntersectionObserver change entry.\n * @param {!./layout-rect.LayoutRectDef} element element's rect\n * @param {?./layout-rect.LayoutRectDef} hostViewport hostViewport's rect\n * @param {!./layout-rect.LayoutRectDef} intersection\n * @param {number} ratio\n * @return {!IntersectionObserverEntry}}\n */\nfunction calculateChangeEntry(element, hostViewport, intersection, ratio) {\n  // If element not in an iframe.\n  // adjust all LayoutRect to hostViewport Origin.\n  let boundingClientRect = element;\n  let rootBounds = hostViewport;\n  // If no hostViewport is provided, element is inside an non-scrollable iframe.\n  // Every Layoutrect has already adjust their origin according to iframe\n  // rect origin. LayoutRect position is relative to iframe origin,\n  // thus relative to iframe's viewport origin because the viewport is at the\n  // iframe origin. No need to adjust position here.\n\n  if (hostViewport) {\n    // If element not in an iframe.\n    // adjust all LayoutRect to hostViewport Origin.\n    rootBounds = /** @type {!./layout-rect.LayoutRectDef} */ (rootBounds);\n    intersection = moveLayoutRect(\n      intersection,\n      -hostViewport.left,\n      -hostViewport.top\n    );\n    // The element is relative to (0, 0), while the viewport moves. So, we must\n    // adjust.\n    boundingClientRect = moveLayoutRect(\n      boundingClientRect,\n      -hostViewport.left,\n      -hostViewport.top\n    );\n    // Now, move the viewport to (0, 0)\n    rootBounds = moveLayoutRect(\n      rootBounds,\n      -hostViewport.left,\n      -hostViewport.top\n    );\n  }\n\n  return /** @type {!IntersectionObserverEntry} */ ({\n    time:\n      typeof performance !== 'undefined' && performance.now\n        ? performance.now()\n        : Date.now() - INIT_TIME,\n    rootBounds,\n    boundingClientRect,\n    intersectionRect: intersection,\n    intersectionRatio: ratio,\n  });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview This module declares JSON types as defined in the\n * {@link http://json.org/}.\n */\n\nimport {childElementsByTag, isJsonScriptTag} from './dom';\nimport {isObject} from './types';\n\n// NOTE Type are changed to {*} because of\n// https://github.com/google/closure-compiler/issues/1999\n\n/**\n * JSON scalar. It's either string, number or boolean.\n * @typedef {*} should be string|number|boolean|null\n */\nlet JSONScalarDef;\n\n/**\n * JSON object. It's a map with string keys and JSON values.\n * @typedef {*} should be !Object<string, ?JSONValueDef>\n */\nlet JSONObjectDef;\n\n/**\n * JSON array. It's an array with JSON values.\n * @typedef {*} should be !Array<?JSONValueDef>\n */\nlet JSONArrayDef;\n\n/**\n * JSON value. It's either a scalar, an object or an array.\n * @typedef {*} should be !JSONScalarDef|!JSONObjectDef|!JSONArrayDef\n */\nlet JSONValueDef;\n\n/**\n * Recreates objects with prototype-less copies.\n * @param {!JsonObject} obj\n * @return {!JsonObject}\n */\nexport function recreateNonProtoObject(obj) {\n  const copy = Object.create(null);\n  for (const k in obj) {\n    if (!hasOwnProperty(obj, k)) {\n      continue;\n    }\n    const v = obj[k];\n    copy[k] = isObject(v) ? recreateNonProtoObject(v) : v;\n  }\n  return /** @type {!JsonObject} */ (copy);\n}\n\n/**\n * Returns a value from an object for a field-based expression. The expression\n * is a simple nested dot-notation of fields, such as `field1.field2`. If any\n * field in a chain does not exist or is not an object or array, the returned\n * value will be `undefined`.\n *\n * @param {!JsonObject} obj\n * @param {string} expr\n * @return {*}\n */\nexport function getValueForExpr(obj, expr) {\n  // The `.` indicates \"the object itself\".\n  if (expr == '.') {\n    return obj;\n  }\n  // Otherwise, navigate via properties.\n  const parts = expr.split('.');\n  let value = obj;\n  for (let i = 0; i < parts.length; i++) {\n    const part = parts[i];\n    if (\n      part &&\n      value &&\n      value[part] !== undefined &&\n      hasOwnProperty(value, part)\n    ) {\n      value = value[part];\n      continue;\n    }\n    value = undefined;\n    break;\n  }\n  return value;\n}\n\n/**\n * Simple wrapper around JSON.parse that casts the return value\n * to JsonObject.\n * Create a new wrapper if an array return value is desired.\n * @param {*} json JSON string to parse\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function parseJson(json) {\n  return /** @type {?JsonObject} */ (JSON.parse(/** @type {string} */ (json)));\n}\n\n/**\n * Parses the given `json` string without throwing an exception if not valid.\n * Returns `undefined` if parsing fails.\n * Returns the `Object` corresponding to the JSON string when parsing succeeds.\n * @param {*} json JSON string to parse\n * @param {function(!Error)=} opt_onFailed Optional function that will be called\n *     with the error if parsing fails.\n * @return {?JsonObject} May be extend to parse arrays.\n */\nexport function tryParseJson(json, opt_onFailed) {\n  try {\n    return parseJson(json);\n  } catch (e) {\n    if (opt_onFailed) {\n      opt_onFailed(e);\n    }\n    return null;\n  }\n}\n\n/**\n * Helper method to get the json config from an element <script> tag\n * @param {!Element} element\n * @return {?JsonObject}\n * @throws {!Error} If element does not have exactly one <script> child\n * with type=\"application/json\", or if the <script> contents are not valid JSON.\n */\nexport function getChildJsonConfig(element) {\n  const scripts = childElementsByTag(element, 'script');\n  const n = scripts.length;\n  if (n !== 1) {\n    throw new Error(`Found ${scripts.length} <script> children. Expected 1.`);\n  }\n  const script = scripts[0];\n  if (!isJsonScriptTag(script)) {\n    throw new Error('<script> child must have type=\"application/json\"');\n  }\n  try {\n    return parseJson(script.textContent);\n  } catch (unusedError) {\n    throw new Error('Failed to parse <script> contents. Is it valid JSON?');\n  }\n}\n\n/**\n * Deeply checks strict equality of items in nested arrays and objects.\n *\n * @param {JSONValueDef} a\n * @param {JSONValueDef} b\n * @param {number} depth The maximum depth. Must be finite.\n * @return {boolean}\n * @throws {Error} If depth argument is not finite.\n */\nexport function deepEquals(a, b, depth = 5) {\n  if (!isFinite(depth) || depth < 0) {\n    throw new Error('Invalid depth: ' + depth);\n  }\n  if (a === b) {\n    return true;\n  }\n  /** @type {!Array<{a: JSONValueDef, b: JSONValueDef, depth: number}>} */\n  const queue = [{a, b, depth}];\n  while (queue.length > 0) {\n    const {a, b, depth} = queue.shift();\n    // Only check deep equality if depth > 0.\n    if (depth > 0) {\n      if (typeof a !== typeof b) {\n        return false;\n      } else if (Array.isArray(a) && Array.isArray(b)) {\n        if (a.length !== b.length) {\n          return false;\n        }\n        for (let i = 0; i < a.length; i++) {\n          queue.push({a: a[i], b: b[i], depth: depth - 1});\n        }\n        continue;\n      } else if (a && b && typeof a === 'object' && typeof b === 'object') {\n        const keysA = Object.keys(/** @type {!Object} */ (a));\n        const keysB = Object.keys(/** @type {!Object} */ (b));\n        if (keysA.length !== keysB.length) {\n          return false;\n        }\n        for (let i = 0; i < keysA.length; i++) {\n          const k = keysA[i];\n          queue.push({a: a[k], b: b[k], depth: depth - 1});\n        }\n        continue;\n      }\n    }\n    // If we get here, then depth == 0 or (a, b) are primitives.\n    if (a !== b) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * @param {*} obj\n * @param {string} key\n * @return {boolean}\n */\nfunction hasOwnProperty(obj, key) {\n  if (obj == null || typeof obj != 'object') {\n    return false;\n  }\n  return Object.prototype.hasOwnProperty.call(\n    /** @type {!Object} */ (obj),\n    key\n  );\n}\n\n/**\n * This helper function handles configurations specified in a JSON format.\n *\n * It allows the configuration is to be written in plain JS (which has better\n * dev ergonomics like comments and trailing commas), and allows the\n * configuration to be transformed into an efficient JSON-parsed representation\n * in the dist build. See https://v8.dev/blog/cost-of-javascript-2019#json\n *\n * @param {!Object} obj\n * @return {!JsonObject}\n */\nexport function jsonConfiguration(obj) {\n  return /** @type {!JsonObject} */ (obj);\n}\n\n/**\n * This converts an Object into a suitable type to be used in `includeJsonLiteral`.\n * This doesn't actually do any conversion, it only changes the closure type.\n *\n * @param {!Object|!Array|string|number|boolean|null} value\n * @return {!InternalJsonLiteralTypeDef}\n */\nexport function jsonLiteral(value) {\n  return /** @type {!InternalJsonLiteralTypeDef} */ (value);\n}\n\n/**\n * Allows inclusion of a variable (that's wrapped in a jsonLiteral\n * call) to be included inside a jsonConfiguration.\n *\n * @param {!InternalJsonLiteralTypeDef} value\n * @return {*}\n */\nexport function includeJsonLiteral(value) {\n  return value;\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {dev} from './log';\n\nconst LABEL_MAP = {\n  0: 'cld',\n  2: 'adld',\n};\n\n/**\n * Measures the time latency between \"first time in viewport\" and\n * \"start to layout\" of an element.\n */\nexport class LayoutDelayMeter {\n  /**\n   * @param {!Window} win\n   * @param {number} priority\n   */\n  constructor(win, priority) {\n    /** @private {!Window} */\n    this.win_ = win;\n    /** @private {?./service/performance-impl.Performance} */\n    this.performance_ = Services.performanceForOrNull(win);\n    /** @private {?number} */\n    this.firstInViewportTime_ = null;\n    /** @private {?number} */\n    this.firstLayoutTime_ = null;\n    /** @private {boolean} */\n    this.done_ = false;\n    /** @private {?string} */\n    this.label_ = LABEL_MAP[priority];\n  }\n\n  /**\n   *\n   */\n  enterViewport() {\n    if (!this.label_ || this.firstInViewportTime_) {\n      return;\n    }\n    this.firstInViewportTime_ = this.win_.Date.now();\n    this.tryMeasureDelay_();\n  }\n\n  /**\n   * starts layout\n   */\n  startLayout() {\n    if (!this.label_ || this.firstLayoutTime_) {\n      return;\n    }\n    this.firstLayoutTime_ = this.win_.Date.now();\n    this.tryMeasureDelay_();\n  }\n\n  /**\n   * Tries to measure delay\n   */\n  tryMeasureDelay_() {\n    if (!this.performance_ || !this.performance_.isPerformanceTrackingOn()) {\n      return;\n    }\n    if (this.done_) {\n      // Already measured.\n      return;\n    }\n    if (!this.firstInViewportTime_ || !this.firstLayoutTime_) {\n      // Not ready yet.\n      return;\n    }\n    const delay = this.win_.Math.max(\n      this.firstLayoutTime_ - this.firstInViewportTime_,\n      0\n    );\n    this.performance_.tickDelta(dev().assertString(this.label_), delay);\n    this.performance_.throttledFlush();\n    this.done_ = true;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The structure that combines position and size for an element. The exact\n * interpretation of position and size depends on the use case.\n *\n * @typedef {{\n *   top: number,\n *   bottom: number,\n *   left: number,\n *   right: number,\n *   width: number,\n *   height: number,\n *   x: number,\n *   y: number\n * }}\n */\nexport let LayoutRectDef;\n\n/**\n * The structure that represents the margins of an Element.\n *\n * @typedef {{\n *   top: number,\n *   right: number,\n *   bottom: number,\n *   left: number\n * }}\n */\nexport let LayoutMarginsDef;\n\n/**\n * The structure that represents a requested change to the margins of an\n * Element. Any new values specified will replace existing ones (rather than\n * being additive).\n *\n * @typedef {{\n *   top: (number|undefined),\n *   right: (number|undefined),\n *   bottom: (number|undefined),\n *   left: (number|undefined)\n * }}\n */\nexport let LayoutMarginsChangeDef;\n\n/**\n * RelativePositions\n *\n * Describes the relative position of an element to another (whether the\n * first is inside the second, on top of the second or on the bottom\n * @enum {string}\n */\nexport const RelativePositions = {\n  INSIDE: 'inside',\n  TOP: 'top',\n  BOTTOM: 'bottom',\n};\n\n/**\n * Creates a layout rect based on the left, top, width and height parameters\n * in that order.\n * @param {number} left\n * @param {number} top\n * @param {number} width\n * @param {number} height\n * @return {!LayoutRectDef}\n */\nexport function layoutRectLtwh(left, top, width, height) {\n  return {\n    left,\n    top,\n    width,\n    height,\n    bottom: top + height,\n    right: left + width,\n    x: left,\n    y: top,\n  };\n}\n\n/**\n * Creates a layout rect based on the DOMRect, e.g. obtained from calling\n * getBoundingClientRect.\n * @param {!ClientRect} rect\n * @return {!LayoutRectDef}\n */\nexport function layoutRectFromDomRect(rect) {\n  return layoutRectLtwh(\n    Number(rect.left),\n    Number(rect.top),\n    Number(rect.width),\n    Number(rect.height)\n  );\n}\n\n/**\n * Returns true if the specified two rects overlap by a single pixel.\n * @param {!LayoutRectDef} r1\n * @param {!LayoutRectDef} r2\n * @return {boolean}\n */\nexport function layoutRectsOverlap(r1, r2) {\n  return (\n    r1.top <= r2.bottom &&\n    r2.top <= r1.bottom &&\n    r1.left <= r2.right &&\n    r2.left <= r1.right\n  );\n}\n\n/**\n * Returns the intersection between a, b or null if there is none.\n * @param {...?LayoutRectDef|undefined} var_args\n * @return {?LayoutRectDef}\n */\nexport function rectIntersection(var_args) {\n  let x0 = -Infinity;\n  let x1 = Infinity;\n  let y0 = -Infinity;\n  let y1 = Infinity;\n  for (let i = 0; i < arguments.length; i++) {\n    const current = arguments[i];\n    if (!current) {\n      continue;\n    }\n    x0 = Math.max(x0, current.left);\n    x1 = Math.min(x1, current.left + current.width);\n    y0 = Math.max(y0, current.top);\n    y1 = Math.min(y1, current.top + current.height);\n    if (x1 < x0 || y1 < y0) {\n      return null;\n    }\n  }\n  if (x1 == Infinity) {\n    return null;\n  }\n  return layoutRectLtwh(x0, y0, x1 - x0, y1 - y0);\n}\n\n/**\n * Returns the position of r2 relative to r1\n * @param {!LayoutRectDef} r1\n * @param {!LayoutRectDef} r2\n * @return {RelativePositions}\n */\nexport function layoutRectsRelativePos(r1, r2) {\n  if (r1.top < r2.top) {\n    return RelativePositions.TOP;\n  } else if (r1.bottom > r2.bottom) {\n    return RelativePositions.BOTTOM;\n  } else {\n    return RelativePositions.INSIDE;\n  }\n}\n\n/**\n * Determines if any portion of a layoutBox would be onscreen in the given\n * viewport, when scrolled to the specified position.\n * @param {!LayoutRectDef} layoutBox\n * @param {!./service/viewport/viewport-interface.ViewportInterface} viewport\n * @param {number} scrollPos\n * @return {RelativePositions}\n */\nexport function layoutPositionRelativeToScrolledViewport(\n  layoutBox,\n  viewport,\n  scrollPos\n) {\n  const scrollLayoutBox = layoutRectFromDomRect(\n    /** @type {!ClientRect} */ ({\n      top: scrollPos,\n      bottom: scrollPos + viewport.getHeight(),\n      left: 0,\n      right: viewport.getWidth(),\n    })\n  );\n  if (layoutRectsOverlap(layoutBox, scrollLayoutBox)) {\n    return RelativePositions.INSIDE;\n  } else {\n    return layoutRectsRelativePos(layoutBox, scrollLayoutBox);\n  }\n}\n\n/**\n * Expand the layout rect using multiples of width and height.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dw Expansion in width, specified as a multiple of width.\n * @param {number} dh Expansion in height, specified as a multiple of height.\n * @return {!LayoutRectDef}\n */\nexport function expandLayoutRect(rect, dw, dh) {\n  return layoutRectLtwh(\n    rect.left - rect.width * dw,\n    rect.top - rect.height * dh,\n    rect.width * (1 + dw * 2),\n    rect.height * (1 + dh * 2)\n  );\n}\n\n/**\n * Moves the layout rect using dx and dy.\n * @param {!LayoutRectDef} rect Original rect.\n * @param {number} dx Move horizontally with this value.\n * @param {number} dy Move vertically with this value.\n * @return {!LayoutRectDef}\n */\nexport function moveLayoutRect(rect, dx, dy) {\n  if ((dx == 0 && dy == 0) || (rect.width == 0 && rect.height == 0)) {\n    return rect;\n  }\n  return layoutRectLtwh(rect.left + dx, rect.top + dy, rect.width, rect.height);\n}\n\n/**\n * @param {!LayoutMarginsDef} margins\n * @param {!LayoutMarginsChangeDef} change\n * @return {boolean}\n */\nexport function areMarginsChanged(margins, change) {\n  return (\n    (change.top !== undefined && change.top != margins.top) ||\n    (change.right !== undefined && change.right != margins.right) ||\n    (change.bottom !== undefined && change.bottom != margins.bottom) ||\n    (change.left !== undefined && change.left != margins.left)\n  );\n}\n\n/**\n * @param {!LayoutRectDef} from\n * @param {!LayoutRectDef} to\n * @return {boolean}\n */\nexport function layoutRectSizeEquals(from, to) {\n  return from.width == to.width && from.height === to.height;\n}\n\n/**\n * @param {?LayoutRectDef} r1\n * @param {?LayoutRectDef} r2\n * @return {boolean}\n */\nexport function layoutRectEquals(r1, r2) {\n  if (!r1 || !r2) {\n    return false;\n  }\n  return (\n    r1.left == r2.left &&\n    r1.top == r2.top &&\n    r1.width == r2.width &&\n    r1.height == r2.height\n  );\n}\n\n/**\n * @param {LayoutMarginsChangeDef|undefined} marginsChange\n * @return {LayoutMarginsChangeDef|undefined}\n */\nexport function cloneLayoutMarginsChangeDef(marginsChange) {\n  if (!marginsChange) {\n    return marginsChange;\n  }\n  return {\n    top: marginsChange.top,\n    bottom: marginsChange.bottom,\n    left: marginsChange.left,\n    right: marginsChange.right,\n  };\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Implements element layout. See https://goo.gl/9avXuT for\n * details.\n */\n\nimport {dev, devAssert, userAssert} from './log';\nimport {htmlFor} from './static-template';\nimport {isFiniteNumber} from './types';\nimport {setStyle, setStyles, toggle} from './style';\nimport {startsWith} from './string';\n\n/**\n * @enum {string}\n */\nexport const Layout = {\n  NODISPLAY: 'nodisplay',\n  FIXED: 'fixed',\n  FIXED_HEIGHT: 'fixed-height',\n  RESPONSIVE: 'responsive',\n  CONTAINER: 'container',\n  FILL: 'fill',\n  FLEX_ITEM: 'flex-item',\n  FLUID: 'fluid',\n  INTRINSIC: 'intrinsic',\n};\n\n/**\n * Layout priorities to use with BaseElement#getLayoutPriority() and\n * BaseElement#updateLayoutPriority().\n * @enum {number}\n */\nexport const LayoutPriority = {\n  CONTENT: 0,\n  METADATA: 1,\n  ADS: 2,\n  BACKGROUND: 3,\n};\n\n/**\n * CSS Length type. E.g. \"1px\" or \"20vh\".\n * @typedef {string}\n */\nexport let LengthDef;\n\n/**\n * @typedef {{\n *   width: string,\n *   height: string\n * }}\n */\nlet DimensionsDef;\n\n/**\n * The set of elements with natural dimensions, that is, elements\n * which have a known dimension either based on their value specified here,\n * or, if the value is null, a dimension specific to the browser.\n * `hasNaturalDimensions` checks for membership in this set.\n * `getNaturalDimensions` determines the dimensions for an element in the\n *    set and caches it.\n * @type {!Object<string, ?DimensionsDef>}\n * @private  Visible for testing only!\n */\nexport const naturalDimensions_ = {\n  'AMP-PIXEL': {width: '0px', height: '0px'},\n  'AMP-ANALYTICS': {width: '1px', height: '1px'},\n  // TODO(dvoytenko): audio should have width:auto.\n  'AMP-AUDIO': null,\n  'AMP-SOCIAL-SHARE': {width: '60px', height: '44px'},\n};\n\n/**\n * Elements that the progress can be shown for. This set has to be externalized\n * since the element's implementation may not be downloaded yet.\n * This list does not include video players which are found via regex later.\n * @enum {boolean}\n * @private  Visible for testing only!\n */\nexport const LOADING_ELEMENTS_ = {\n  'AMP-AD': true,\n  'AMP-ANIM': true,\n  'AMP-EMBED': true,\n  'AMP-FACEBOOK': true,\n  'AMP-FACEBOOK-COMMENTS': true,\n  'AMP-FACEBOOK-PAGE': true,\n  'AMP-GOOGLE-DOCUMENT-EMBED': true,\n  'AMP-IFRAME': true,\n  'AMP-IMG': true,\n  'AMP-INSTAGRAM': true,\n  'AMP-LIST': true,\n  'AMP-PINTEREST': true,\n  'AMP-PLAYBUZZ': true,\n  'AMP-TWITTER': true,\n};\n/**\n * All video player components must either have a) \"video\" or b) \"player\" in\n * their name. A few components don't follow this convention for historical\n * reasons, so they are listed individually.\n * @private @const {!RegExp}\n */\nconst videoPlayerTagNameRe = /^amp\\-(video|.+player)|AMP-BRIGHTCOVE|AMP-DAILYMOTION|AMP-YOUTUBE|AMP-VIMEO|AMP-IMA-VIDEO/i;\n\n/**\n * @param {string} s\n * @return {Layout|undefined} Returns undefined in case of failure to parse\n *   the layout string.\n */\nexport function parseLayout(s) {\n  for (const k in Layout) {\n    if (Layout[k] == s) {\n      return Layout[k];\n    }\n  }\n  return undefined;\n}\n\n/**\n * @param {!Layout} layout\n * @return {string}\n */\nexport function getLayoutClass(layout) {\n  return 'i-amphtml-layout-' + layout;\n}\n\n/**\n * Whether an element with this layout inherently defines the size.\n * @param {!Layout} layout\n * @return {boolean}\n */\nexport function isLayoutSizeDefined(layout) {\n  return (\n    layout == Layout.FIXED ||\n    layout == Layout.FIXED_HEIGHT ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.FILL ||\n    layout == Layout.FLEX_ITEM ||\n    layout == Layout.FLUID ||\n    layout == Layout.INTRINSIC\n  );\n}\n\n/**\n * Whether an element with this layout has a fixed dimension.\n * @param {!Layout} layout\n * @return {boolean}\n */\nexport function isLayoutSizeFixed(layout) {\n  return layout == Layout.FIXED || layout == Layout.FIXED_HEIGHT;\n}\n\n/**\n * Whether the tag is an internal (service) AMP tag.\n * @param {!Node|string} tag\n * @return {boolean}\n */\nexport function isInternalElement(tag) {\n  const tagName = typeof tag == 'string' ? tag : tag.tagName;\n  return tagName && startsWith(tagName.toLowerCase(), 'i-');\n}\n\n/**\n * Parses the CSS length value. If no units specified, the assumed value is\n * \"px\". Returns undefined in case of parsing error.\n * @param {string|undefined|null} s\n * @return {!LengthDef|undefined}\n */\nexport function parseLength(s) {\n  if (typeof s == 'number') {\n    return s + 'px';\n  }\n  if (!s) {\n    return undefined;\n  }\n  if (!/^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|cm|mm|q|in|pc|pt)?$/.test(s)) {\n    return undefined;\n  }\n  if (/^\\d+(\\.\\d+)?$/.test(s)) {\n    return s + 'px';\n  }\n  return s;\n}\n\n/**\n * Asserts that the supplied value is a non-percent CSS Length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {!LengthDef}\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertLength(length) {\n  userAssert(\n    /^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|cm|mm|q|in|pc|pt)$/.test(length),\n    'Invalid length value: %s',\n    length\n  );\n  return /** @type {!LengthDef} */ (length);\n}\n\n/**\n * Asserts that the supplied value is a CSS Length value\n * (including percent unit).\n * @param {!LengthDef|string} length\n * @return {!LengthDef}\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function assertLengthOrPercent(length) {\n  userAssert(\n    /^\\d+(\\.\\d+)?(px|em|rem|vh|vw|vmin|vmax|%)$/.test(length),\n    'Invalid length or percent value: %s',\n    length\n  );\n  return length;\n}\n\n/**\n * Returns units from the CSS length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {string}\n */\nexport function getLengthUnits(length) {\n  assertLength(length);\n  dev().assertString(length);\n  const m = userAssert(\n    length.match(/[a-z]+/i),\n    'Failed to read units from %s',\n    length\n  );\n  return m[0];\n}\n\n/**\n * Returns the numeric value of a CSS length value.\n * @param {!LengthDef|string|null|undefined} length\n * @return {number|undefined}\n */\nexport function getLengthNumeral(length) {\n  const res = parseFloat(length);\n  return isFiniteNumber(res) ? res : undefined;\n}\n\n/**\n * Determines whether the tagName is a known element that has natural dimensions\n * in our runtime or the browser.\n * @param {string} tagName The element tag name.\n * @return {boolean}\n */\nexport function hasNaturalDimensions(tagName) {\n  tagName = tagName.toUpperCase();\n  return naturalDimensions_[tagName] !== undefined;\n}\n\n/**\n * Determines the default dimensions for an element which could vary across\n * different browser implementations, like <audio> for instance.\n * This operation can only be completed for an element whitelisted by\n * `hasNaturalDimensions`.\n * @param {!Element} element\n * @return {DimensionsDef}\n */\nexport function getNaturalDimensions(element) {\n  const tagName = element.tagName.toUpperCase();\n  devAssert(naturalDimensions_[tagName] !== undefined);\n  if (!naturalDimensions_[tagName]) {\n    const doc = element.ownerDocument;\n    const naturalTagName = tagName.replace(/^AMP\\-/, '');\n    const temp = doc.createElement(naturalTagName);\n    // For audio, should no-op elsewhere.\n    temp.controls = true;\n    setStyles(temp, {\n      position: 'absolute',\n      visibility: 'hidden',\n    });\n    doc.body.appendChild(temp);\n    naturalDimensions_[tagName] = {\n      width: (temp./*OK*/ offsetWidth || 1) + 'px',\n      height: (temp./*OK*/ offsetHeight || 1) + 'px',\n    };\n    doc.body.removeChild(temp);\n  }\n  return /** @type {DimensionsDef} */ (naturalDimensions_[tagName]);\n}\n\n/**\n * Whether the loading can be shown for the specified elemeent. This set has\n * to be externalized since the element's implementation may not be\n * downloaded yet.\n * @param {!Element} element\n * @return {boolean}\n */\nexport function isLoadingAllowed(element) {\n  const tagName = element.tagName.toUpperCase();\n  return LOADING_ELEMENTS_[tagName] || isIframeVideoPlayerComponent(tagName);\n}\n\n/**\n * All video player components must either have a) \"video\" or b) \"player\" in\n * their name. A few components don't follow this convention for historical\n * reasons, so they're present in the LOADING_ELEMENTS_ whitelist.\n * @param {string} tagName\n * @return {boolean}\n */\nexport function isIframeVideoPlayerComponent(tagName) {\n  if (tagName == 'AMP-VIDEO') {\n    return false;\n  }\n  return videoPlayerTagNameRe.test(tagName);\n}\n\n/**\n * Applies layout to the element. Visible for testing only.\n *\n * \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  / _____|\n *  \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n *   \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n *    \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n *     \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n *\n * The equivalent of this method is used for server-side rendering (SSR) and\n * any changes made to it must be made in coordination with caches that\n * implement SSR. For more information on SSR see bit.ly/amp-ssr.\n *\n * @param {!Element} element\n * @return {!Layout}\n */\nexport function applyStaticLayout(element) {\n  // Check if the layout has already been done by server-side rendering or\n  // client-side rendering and the element was cloned. The document may be\n  // visible to the user if the boilerplate was removed so please take care in\n  // making changes here.\n  const completedLayoutAttr = element.getAttribute('i-amphtml-layout');\n  if (completedLayoutAttr) {\n    const layout = /** @type {!Layout} */ (devAssert(\n      parseLayout(completedLayoutAttr)\n    ));\n    if (\n      (layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) &&\n      element.firstElementChild\n    ) {\n      // Find sizer, but assume that it might not have been parsed yet.\n      element.sizerElement =\n        element.querySelector('i-amphtml-sizer') || undefined;\n    } else if (layout == Layout.NODISPLAY) {\n      toggle(element, false);\n      // TODO(jridgewell): Temporary hack while SSR still adds an inline\n      // `display: none`\n      element['style']['display'] = '';\n    }\n    return layout;\n  }\n\n  // If the layout was already done by server-side rendering (SSR), then the\n  // code below will not run. Any changes below will necessitate a change to SSR\n  // and must be coordinated with caches that implement SSR. See bit.ly/amp-ssr.\n\n  // Parse layout from the element.\n  const layoutAttr = element.getAttribute('layout');\n  const widthAttr = element.getAttribute('width');\n  const heightAttr = element.getAttribute('height');\n  const sizesAttr = element.getAttribute('sizes');\n  const heightsAttr = element.getAttribute('heights');\n\n  // Input layout attributes.\n  const inputLayout = layoutAttr ? parseLayout(layoutAttr) : null;\n  userAssert(inputLayout !== undefined, 'Unknown layout: %s', layoutAttr);\n  /** @const {string|null|undefined} */\n  const inputWidth =\n    widthAttr && widthAttr != 'auto' ? parseLength(widthAttr) : widthAttr;\n  userAssert(inputWidth !== undefined, 'Invalid width value: %s', widthAttr);\n  /** @const {string|null|undefined} */\n  const inputHeight =\n    heightAttr && heightAttr != 'fluid' ? parseLength(heightAttr) : heightAttr;\n  userAssert(inputHeight !== undefined, 'Invalid height value: %s', heightAttr);\n\n  // Effective layout attributes. These are effectively constants.\n  let width;\n  let height;\n  let layout;\n\n  // Calculate effective width and height.\n  if (\n    (!inputLayout ||\n      inputLayout == Layout.FIXED ||\n      inputLayout == Layout.FIXED_HEIGHT) &&\n    (!inputWidth || !inputHeight) &&\n    hasNaturalDimensions(element.tagName)\n  ) {\n    // Default width and height: handle elements that do not specify a\n    // width/height and are defined to have natural browser dimensions.\n    const dimensions = getNaturalDimensions(element);\n    width =\n      inputWidth || inputLayout == Layout.FIXED_HEIGHT\n        ? inputWidth\n        : dimensions.width;\n    height = inputHeight || dimensions.height;\n  } else {\n    width = inputWidth;\n    height = inputHeight;\n  }\n\n  // Calculate effective layout.\n  if (inputLayout) {\n    layout = inputLayout;\n  } else if (!width && !height) {\n    layout = Layout.CONTAINER;\n  } else if (height == 'fluid') {\n    layout = Layout.FLUID;\n  } else if (height && (!width || width == 'auto')) {\n    layout = Layout.FIXED_HEIGHT;\n  } else if (height && width && (sizesAttr || heightsAttr)) {\n    layout = Layout.RESPONSIVE;\n  } else {\n    layout = Layout.FIXED;\n  }\n\n  // Verify layout attributes.\n  if (\n    layout == Layout.FIXED ||\n    layout == Layout.FIXED_HEIGHT ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.INTRINSIC\n  ) {\n    userAssert(height, 'Expected height to be available: %s', heightAttr);\n  }\n  if (layout == Layout.FIXED_HEIGHT) {\n    userAssert(\n      !width || width == 'auto',\n      'Expected width to be either absent or equal \"auto\" ' +\n        'for fixed-height layout: %s',\n      widthAttr\n    );\n  }\n  if (\n    layout == Layout.FIXED ||\n    layout == Layout.RESPONSIVE ||\n    layout == Layout.INTRINSIC\n  ) {\n    userAssert(\n      width && width != 'auto',\n      'Expected width to be available and not equal to \"auto\": %s',\n      widthAttr\n    );\n  }\n\n  if (layout == Layout.RESPONSIVE || layout == Layout.INTRINSIC) {\n    userAssert(\n      getLengthUnits(width) == getLengthUnits(height),\n      'Length units should be the same for width and height: %s, %s',\n      widthAttr,\n      heightAttr\n    );\n  } else {\n    userAssert(\n      heightsAttr === null,\n      'Unexpected \"heights\" attribute for none-responsive layout'\n    );\n  }\n\n  // Apply UI.\n  element.classList.add(getLayoutClass(layout));\n  if (isLayoutSizeDefined(layout)) {\n    element.classList.add('i-amphtml-layout-size-defined');\n  }\n  if (layout == Layout.NODISPLAY) {\n    // CSS defines layout=nodisplay automatically with `display:none`. Thus\n    // no additional styling is needed.\n    toggle(element, false);\n    // TODO(jridgewell): Temporary hack while SSR still adds an inline\n    // `display: none`\n    element['style']['display'] = '';\n  } else if (layout == Layout.FIXED) {\n    setStyles(element, {\n      width: dev().assertString(width),\n      height: dev().assertString(height),\n    });\n  } else if (layout == Layout.FIXED_HEIGHT) {\n    setStyle(element, 'height', dev().assertString(height));\n  } else if (layout == Layout.RESPONSIVE) {\n    const sizer = element.ownerDocument.createElement('i-amphtml-sizer');\n    setStyles(sizer, {\n      paddingTop:\n        (getLengthNumeral(height) / getLengthNumeral(width)) * 100 + '%',\n    });\n    element.insertBefore(sizer, element.firstChild);\n    element.sizerElement = sizer;\n  } else if (layout == Layout.INTRINSIC) {\n    // Intrinsic uses an svg inside the sizer element rather than the padding\n    // trick Note a naked svg won't work becasue other thing expect the\n    // i-amphtml-sizer element\n    const sizer = htmlFor(element)`\n      <i-amphtml-sizer class=\"i-amphtml-sizer\">\n        <img alt=\"\" role=\"presentation\" aria-hidden=\"true\"\n             class=\"i-amphtml-intrinsic-sizer\" />\n      </i-amphtml-sizer>`;\n    const intrinsicSizer = sizer.firstElementChild;\n    intrinsicSizer.setAttribute(\n      'src',\n      `data:image/svg+xml;charset=utf-8,<svg height=\"${height}\" width=\"${width}\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\"/>`\n    );\n    element.insertBefore(sizer, element.firstChild);\n    element.sizerElement = sizer;\n  } else if (layout == Layout.FILL) {\n    // Do nothing.\n  } else if (layout == Layout.CONTAINER) {\n    // Do nothing. Elements themselves will check whether the supplied\n    // layout value is acceptable. In particular container is only OK\n    // sometimes.\n  } else if (layout == Layout.FLEX_ITEM) {\n    // Set height and width to a flex item if they exist.\n    // The size set to a flex item could be overridden by `display: flex` later.\n    if (width) {\n      setStyle(element, 'width', width);\n    }\n    if (height) {\n      setStyle(element, 'height', height);\n    }\n  } else if (layout == Layout.FLUID) {\n    element.classList.add('i-amphtml-layout-awaiting-size');\n    if (width) {\n      setStyle(element, 'width', width);\n    }\n    setStyle(element, 'height', 0);\n  }\n  // Mark the element as having completed static layout, in case it is cloned\n  // in the future.\n  element.setAttribute('i-amphtml-layout', layout);\n  return layout;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\n\n/**\n * Gets a Promise for the LoaderService, initiating a request to download the\n * code.\n * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n * @param {!Element} element\n * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n */\nfunction getLoaderServicePromise(ampDoc, element) {\n  return Services.extensionsFor(ampDoc.win)\n    .installExtensionForDoc(ampDoc, 'amp-loader')\n    .then(() => Services.loaderServiceForDoc(element));\n}\n\n/**\n * Creates a default \"loading indicator\" element based on the new design.\n *\n * Please see https://github.com/ampproject/amphtml/issues/20237 for details,\n * screenshots and various states of the new loader design.\n * @param {!./service/ampdoc-impl.AmpDoc} ampDoc\n * @param {!AmpElement} element\n * @param {number} elementWidth\n * @param {number} elementHeight\n * @return {!Element} The loader root element.\n */\nexport function createLoaderElement(\n  ampDoc,\n  element,\n  elementWidth,\n  elementHeight\n) {\n  const startTime = Date.now();\n  // We create the loader root element up front, since it is needed\n  // synchronously. We create the actual element with animations when the\n  // service is ready.\n  const loaderRoot = element.ownerDocument.createElement('div');\n\n  getLoaderServicePromise(ampDoc, element).then(loaderService => {\n    const endTime = Date.now();\n    const initDelay = endTime - startTime;\n\n    loaderService.initializeLoader(\n      element,\n      loaderRoot,\n      initDelay,\n      elementWidth,\n      elementHeight\n    );\n  });\n\n  return loaderRoot;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from './mode';\nimport {getModeObject} from './mode-object';\nimport {internalRuntimeVersion} from './internal-version';\nimport {isArray, isEnumValue} from './types';\nimport {once} from './utils/function';\nimport {urls} from './config';\n\nconst noop = () => {};\n\n/**\n * Triple zero width space.\n *\n * This is added to user error messages, so that we can later identify\n * them, when the only thing that we have is the message. This is the\n * case in many browsers when the global exception handler is invoked.\n *\n * @const {string}\n */\nexport const USER_ERROR_SENTINEL = '\\u200B\\u200B\\u200B';\n\n/**\n * Four zero width space.\n *\n * @const {string}\n */\nexport const USER_ERROR_EMBED_SENTINEL = '\\u200B\\u200B\\u200B\\u200B';\n\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a user error.\n */\nexport function isUserErrorMessage(message) {\n  return message.indexOf(USER_ERROR_SENTINEL) >= 0;\n}\n\n/**\n * @param {string} message\n * @return {boolean} Whether this message was a a user error from an iframe embed.\n */\nexport function isUserErrorEmbed(message) {\n  return message.indexOf(USER_ERROR_EMBED_SENTINEL) >= 0;\n}\n\n/**\n * @enum {number}\n * @private Visible for testing only.\n */\nexport const LogLevel = {\n  OFF: 0,\n  ERROR: 1,\n  WARN: 2,\n  INFO: 3,\n  FINE: 4,\n};\n\n/**\n * Sets reportError function. Called from error.js to break cyclic\n * dependency.\n * @param {function(*, !Element=)|undefined} fn\n */\nexport function setReportError(fn) {\n  self.__AMP_REPORT_ERROR = fn;\n}\n\n/**\n * @type {!LogLevel|undefined}\n * @private\n */\nlet levelOverride_ = undefined;\n\n/**\n * @param {!LogLevel} level\n */\nexport function overrideLogLevel(level) {\n  levelOverride_ = level;\n}\n\n/**\n * Prefixes `internalRuntimeVersion` with the `01` channel signifier (for prod.) for\n * extracted message URLs.\n * (Specific channel is irrelevant: message tables are invariant on internal version.)\n * @return {string}\n */\nconst messageUrlRtv = () => `01${internalRuntimeVersion()}`;\n\n/**\n * Gets a URL to display a message on amp.dev.\n * @param {string} id\n * @param {!Array} interpolatedParts\n * @return {string}\n */\nconst externalMessageUrl = (id, interpolatedParts) =>\n  interpolatedParts.reduce(\n    (prefix, arg) => `${prefix}&s[]=${messageArgToEncodedComponent(arg)}`,\n    `https://log.amp.dev/?v=${messageUrlRtv()}&id=${encodeURIComponent(id)}`\n  );\n\n/**\n * URL to simple log messages table JSON file, which contains an Object<string, string>\n * which maps message id to full message template.\n * @return {string}\n */\nconst externalMessagesSimpleTableUrl = () =>\n  `${urls.cdn}/rtv/${messageUrlRtv()}/log-messages.simple.json`;\n\n/**\n * @param {*} arg\n * @return {string}\n */\nconst messageArgToEncodedComponent = arg =>\n  encodeURIComponent(String(elementStringOrPassthru(arg)));\n\n/**\n * Logging class. Use of sentinel string instead of a boolean to check user/dev\n * errors because errors could be rethrown by some native code as a new error,\n * and only a message would survive. Also, some browser dont support a 5th\n * error object argument in window.onerror. List of supporting browser can be\n * found here:\n * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n * @final\n * @private Visible for testing only.\n */\nexport class Log {\n  /**\n   * opt_suffix will be appended to error message to identify the type of the\n   * error message. We can't rely on the error object to pass along the type\n   * because some browsers do not have this param in its window.onerror API.\n   * See:\n   * https://blog.sentry.io/2016/01/04/client-javascript-reporting-window-onerror.html\n   *\n   * @param {!Window} win\n   * @param {function(!./mode.ModeDef):!LogLevel} levelFunc\n   * @param {string=} opt_suffix\n   */\n  constructor(win, levelFunc, opt_suffix = '') {\n    /**\n     * In tests we use the main test window instead of the iframe where\n     * the tests runs because only the former is relayed to the console.\n     * @const {!Window}\n     */\n    this.win = getMode().test && win.__AMP_TEST_IFRAME ? win.parent : win;\n\n    /** @private @const {function(!./mode.ModeDef):!LogLevel} */\n    this.levelFunc_ = levelFunc;\n\n    /** @private @const {!LogLevel} */\n    this.level_ = this.defaultLevel_();\n\n    /** @private @const {string} */\n    this.suffix_ = opt_suffix;\n\n    /** @private {?JsonObject} */\n    this.messages_ = null;\n\n    this.fetchExternalMessagesOnce_ = once(() => {\n      win\n        .fetch(externalMessagesSimpleTableUrl())\n        .then(response => response.json(), noop)\n        .then(opt_messages => {\n          if (opt_messages) {\n            this.messages_ = /** @type {!JsonObject} */ (opt_messages);\n          }\n        });\n    });\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  getLevel_() {\n    return levelOverride_ !== undefined ? levelOverride_ : this.level_;\n  }\n\n  /**\n   * @return {!LogLevel}\n   * @private\n   */\n  defaultLevel_() {\n    // No console - can't enable logging.\n    if (!this.win.console || !this.win.console.log) {\n      return LogLevel.OFF;\n    }\n\n    // Logging has been explicitly disabled.\n    if (getMode().log == '0') {\n      return LogLevel.OFF;\n    }\n\n    // Logging is enabled for tests directly.\n    if (getMode().test && this.win.ENABLE_LOG) {\n      return LogLevel.FINE;\n    }\n\n    // LocalDev by default allows INFO level, unless overriden by `#log`.\n    if (getMode().localDev && !getMode().log) {\n      return LogLevel.INFO;\n    }\n\n    // Delegate to the specific resolver.\n    return this.levelFunc_(getModeObject());\n  }\n\n  /**\n   * @param {string} tag\n   * @param {string} level\n   * @param {!Array} messages\n   */\n  msg_(tag, level, messages) {\n    if (this.getLevel_() != LogLevel.OFF) {\n      let fn = this.win.console.log;\n      if (level == 'ERROR') {\n        fn = this.win.console.error || fn;\n      } else if (level == 'INFO') {\n        fn = this.win.console.info || fn;\n      } else if (level == 'WARN') {\n        fn = this.win.console.warn || fn;\n      }\n      const args = this.maybeExpandMessageArgs_(messages);\n      // Prefix console message with \"[tag]\".\n      const prefix = `[${tag}]`;\n      if (typeof args[0] === 'string') {\n        // Prepend string to avoid breaking string substitutions e.g. %s.\n        args[0] = prefix + ' ' + args[0];\n      } else {\n        args.unshift(prefix);\n      }\n      fn.apply(this.win.console, args);\n    }\n  }\n\n  /**\n   * Whether the logging is enabled.\n   * @return {boolean}\n   */\n  isEnabled() {\n    return this.getLevel_() != LogLevel.OFF;\n  }\n\n  /**\n   * Reports a fine-grained message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  fine(tag, var_args) {\n    if (this.getLevel_() >= LogLevel.FINE) {\n      this.msg_(tag, 'FINE', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * Reports a informational message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  info(tag, var_args) {\n    if (this.getLevel_() >= LogLevel.INFO) {\n      this.msg_(tag, 'INFO', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * Reports a warning message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  warn(tag, var_args) {\n    if (this.getLevel_() >= LogLevel.WARN) {\n      this.msg_(tag, 'WARN', Array.prototype.slice.call(arguments, 1));\n    }\n  }\n\n  /**\n   * Reports an error message. If the logging is disabled, the error is rethrown\n   * asynchronously.\n   * @param {string} tag\n   * @param {...*} var_args\n   * @return {!Error|undefined}\n   * @private\n   */\n  error_(tag, var_args) {\n    if (this.getLevel_() >= LogLevel.ERROR) {\n      this.msg_(tag, 'ERROR', Array.prototype.slice.call(arguments, 1));\n    } else {\n      const error = createErrorVargs.apply(\n        null,\n        Array.prototype.slice.call(arguments, 1)\n      );\n      this.prepareError_(error);\n      return error;\n    }\n  }\n\n  /**\n   * Reports an error message.\n   * @param {string} tag\n   * @param {...*} var_args\n   */\n  error(tag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      error.name = tag || error.name;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Reports an error message and marks with an expected property. If the\n   * logging is disabled, the error is rethrown asynchronously.\n   * @param {string} unusedTag\n   * @param {...*} var_args\n   */\n  expectedError(unusedTag, var_args) {\n    const error = this.error_.apply(this, arguments);\n    if (error) {\n      error.expected = true;\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(error);\n    }\n  }\n\n  /**\n   * Creates an error object.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    return error;\n  }\n\n  /**\n   * Creates an error object with its expected property set to true.\n   * @param {...*} var_args\n   * @return {!Error}\n   */\n  createExpectedError(var_args) {\n    const error = createErrorVargs.apply(null, arguments);\n    this.prepareError_(error);\n    error.expected = true;\n    return error;\n  }\n\n  /**\n   * Throws an error if the first argument isn't trueish.\n   *\n   * Supports argument substitution into the message via %s placeholders.\n   *\n   * Throws an error object that has two extra properties:\n   * - associatedElement: This is the first element provided in the var args.\n   *   It can be used for improved display of error messages.\n   * - messageArray: The elements of the substituted message as non-stringified\n   *   elements in an array. When e.g. passed to console.error this yields\n   *   native displays of things like HTML elements.\n   *\n   * NOTE: for an explanation of the tempate R implementation see\n   * https://github.com/google/closure-library/blob/08858804/closure/goog/asserts/asserts.js#L192-L213\n   *\n   * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n   *     not evaluate to true.\n   * @param {!Array|string=} opt_message The assertion message\n   * @param {...*} var_args Arguments substituted into %s in the message.\n   * @return {R} The value of shouldBeTrueish.\n   * @throws {!Error} When `value` is `null` or `undefined`.\n   * @template T\n   * @template R :=\n   *     mapunion(T, (V) =>\n   *         cond(eq(V, 'null'),\n   *             none(),\n   *             cond(eq(V, 'undefined'),\n   *                 none(),\n   *                 V)))\n   *  =:\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assert(shouldBeTrueish, opt_message, var_args) {\n    let firstElement;\n    if (isArray(opt_message)) {\n      return this.assert.apply(\n        this,\n        [shouldBeTrueish].concat(\n          this.expandMessageArgs_(/** @type {!Array} */ (opt_message))\n        )\n      );\n    }\n    if (!shouldBeTrueish) {\n      const message = opt_message || 'Assertion failed';\n      const splitMessage = message.split('%s');\n      const first = splitMessage.shift();\n      let formatted = first;\n      const messageArray = [];\n      let i = 2;\n      pushIfNonEmpty(messageArray, first);\n      while (splitMessage.length > 0) {\n        const nextConstant = splitMessage.shift();\n        const val = arguments[i++];\n        if (val && val.tagName) {\n          firstElement = val;\n        }\n        messageArray.push(val);\n        pushIfNonEmpty(messageArray, nextConstant.trim());\n        formatted += stringOrElementString(val) + nextConstant;\n      }\n      const e = new Error(formatted);\n      e.fromAssert = true;\n      e.associatedElement = firstElement;\n      e.messageArray = messageArray;\n      this.prepareError_(e);\n      // __AMP_REPORT_ERROR is installed globally per window in the entry point.\n      self.__AMP_REPORT_ERROR(e);\n      throw e;\n    }\n    return shouldBeTrueish;\n  }\n\n  /**\n   * Throws an error if the first argument isn't an Element\n   *\n   * Otherwise see `assert` for usage\n   *\n   * @param {*} shouldBeElement\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Element} The value of shouldBeTrueish.\n   * @template T\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertElement(shouldBeElement, opt_message) {\n    const shouldBeTrueish = shouldBeElement && shouldBeElement.nodeType == 1;\n    this.assertType_(\n      shouldBeElement,\n      shouldBeTrueish,\n      'Element expected',\n      opt_message\n    );\n    return /** @type {!Element} */ (shouldBeElement);\n  }\n\n  /**\n   * Throws an error if the first argument isn't a string. The string can\n   * be empty.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeString\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {string} The string value. Can be an empty string.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertString(shouldBeString, opt_message) {\n    this.assertType_(\n      shouldBeString,\n      typeof shouldBeString == 'string',\n      'String expected',\n      opt_message\n    );\n    return /** @type {string} */ (shouldBeString);\n  }\n\n  /**\n   * Throws an error if the first argument isn't a number. The allowed values\n   * include `0` and `NaN`.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeNumber\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {number} The number value. The allowed values include `0`\n   *   and `NaN`.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertNumber(shouldBeNumber, opt_message) {\n    this.assertType_(\n      shouldBeNumber,\n      typeof shouldBeNumber == 'number',\n      'Number expected',\n      opt_message\n    );\n    return /** @type {number} */ (shouldBeNumber);\n  }\n\n  /**\n   * Throws an error if the first argument is not an array.\n   * The array can be empty.\n   *\n   * @param {*} shouldBeArray\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {!Array} The array value\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertArray(shouldBeArray, opt_message) {\n    this.assertType_(\n      shouldBeArray,\n      isArray(shouldBeArray),\n      'Array expected',\n      opt_message\n    );\n    return /** @type {!Array} */ (shouldBeArray);\n  }\n\n  /**\n   * Throws an error if the first argument isn't a boolean.\n   *\n   * For more details see `assert`.\n   *\n   * @param {*} shouldBeBoolean\n   * @param {!Array|string=} opt_message The assertion message\n   * @return {boolean} The boolean value.\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertBoolean(shouldBeBoolean, opt_message) {\n    this.assertType_(\n      shouldBeBoolean,\n      !!shouldBeBoolean === shouldBeBoolean,\n      'Boolean expected',\n      opt_message\n    );\n    return /** @type {boolean} */ (shouldBeBoolean);\n  }\n\n  /**\n   * Asserts and returns the enum value. If the enum doesn't contain such a\n   * value, the error is thrown.\n   *\n   * @param {!Object<T>} enumObj\n   * @param {string} s\n   * @param {string=} opt_enumName\n   * @return {T}\n   * @template T\n   * @closurePrimitive {asserts.matchesReturn}\n   */\n  assertEnumValue(enumObj, s, opt_enumName) {\n    if (isEnumValue(enumObj, s)) {\n      return s;\n    }\n    this.assert(false, 'Unknown %s value: \"%s\"', opt_enumName || 'enum', s);\n  }\n\n  /**\n   * @param {!Error} error\n   * @private\n   */\n  prepareError_(error) {\n    error = duplicateErrorIfNecessary(error);\n    if (this.suffix_) {\n      if (!error.message) {\n        error.message = this.suffix_;\n      } else if (error.message.indexOf(this.suffix_) == -1) {\n        error.message += this.suffix_;\n      }\n    } else if (isUserErrorMessage(error.message)) {\n      error.message = error.message.replace(USER_ERROR_SENTINEL, '');\n    }\n  }\n\n  /**\n   * @param {!Array} args\n   * @return {!Array}\n   * @private\n   */\n  maybeExpandMessageArgs_(args) {\n    if (isArray(args[0])) {\n      return this.expandMessageArgs_(/** @type {!Array} */ (args[0]));\n    }\n    return args;\n  }\n\n  /**\n   * Either redirects a pair of (errorId, ...args) to a URL where the full\n   * message is displayed, or displays it from a fetched table.\n   *\n   * This method is used by the output of the `transform-log-methods` babel\n   * plugin. It should not be used directly. Use the (*error|assert*|info|warn)\n   * methods instead.\n   *\n   * @param {!Array} parts\n   * @return {!Array}\n   * @private\n   */\n  expandMessageArgs_(parts) {\n    // First value should exist.\n    const id = parts.shift();\n    // Best effort fetch of message template table.\n    // Since this is async, the first few logs might be indirected to a URL even\n    // if in development mode. Message table is ~small so this should be a short\n    // gap.\n    if (getMode(this.win).development) {\n      this.fetchExternalMessagesOnce_();\n    }\n    if (this.messages_ && id in this.messages_) {\n      return [this.messages_[id]].concat(parts);\n    }\n    return [`More info at ${externalMessageUrl(id, parts)}`];\n  }\n\n  /**\n   * Asserts types, backbone of `assertNumber`, `assertString`, etc.\n   *\n   * It understands array-based \"id\"-contracted messages.\n   *\n   * Otherwise creates a sprintf syntax string containing the optional message or the\n   * default. An interpolation token is added at the end to include the `subject`.\n   * @param {*} subject\n   * @param {*} assertion\n   * @param {string} defaultMessage\n   * @param {!Array|string=} opt_message\n   * @private\n   */\n  assertType_(subject, assertion, defaultMessage, opt_message) {\n    if (isArray(opt_message)) {\n      this.assert(assertion, opt_message.concat(subject));\n    } else {\n      this.assert(assertion, `${opt_message || defaultMessage}: %s`, subject);\n    }\n  }\n}\n\n/**\n * @param {string|!Element} val\n * @return {string}\n */\nconst stringOrElementString = val =>\n  /** @type {string} */ (elementStringOrPassthru(val));\n\n/**\n * @param {*} val\n * @return {*}\n */\nfunction elementStringOrPassthru(val) {\n  // Do check equivalent to `val instanceof Element` without cross-window bug\n  if (val && val.nodeType == 1) {\n    return val.tagName.toLowerCase() + (val.id ? '#' + val.id : '');\n  }\n  return val;\n}\n\n/**\n * @param {!Array} array\n * @param {*} val\n */\nfunction pushIfNonEmpty(array, val) {\n  if (val != '') {\n    array.push(val);\n  }\n}\n\n/**\n * Some exceptions (DOMException, namely) have read-only message.\n * @param {!Error} error\n * @return {!Error};\n */\nexport function duplicateErrorIfNecessary(error) {\n  const messageProperty = Object.getOwnPropertyDescriptor(error, 'message');\n  if (messageProperty && messageProperty.writable) {\n    return error;\n  }\n\n  const {message, stack} = error;\n  const e = new Error(message);\n  // Copy all the extraneous things we attach.\n  for (const prop in error) {\n    e[prop] = error[prop];\n  }\n  // Ensure these are copied.\n  e.stack = stack;\n  return e;\n}\n\n/**\n * @param {...*} var_args\n * @return {!Error}\n * @visibleForTesting\n */\nexport function createErrorVargs(var_args) {\n  let error = null;\n  let message = '';\n  for (let i = 0; i < arguments.length; i++) {\n    const arg = arguments[i];\n    if (arg instanceof Error && !error) {\n      error = duplicateErrorIfNecessary(arg);\n    } else {\n      if (message) {\n        message += ' ';\n      }\n      message += arg;\n    }\n  }\n\n  if (!error) {\n    error = new Error(message);\n  } else if (message) {\n    error.message = message + ': ' + error.message;\n  }\n  return error;\n}\n\n/**\n * Rethrows the error without terminating the current context. This preserves\n * whether the original error designation is a user error or a dev error.\n * @param {...*} var_args\n */\nexport function rethrowAsync(var_args) {\n  const error = createErrorVargs.apply(null, arguments);\n  setTimeout(() => {\n    // reportError is installed globally per window in the entry point.\n    self.__AMP_REPORT_ERROR(error);\n    throw error;\n  });\n}\n\n/**\n * Cache for logs. We do not use a Service since the service module depends\n * on Log and closure literally can't even.\n * @type {{user: ?Log, dev: ?Log, userForEmbed: ?Log}}\n */\nself.__AMP_LOG = self.__AMP_LOG || {\n  user: null,\n  dev: null,\n  userForEmbed: null,\n};\n\nconst logs = self.__AMP_LOG;\n\n/**\n * Eventually holds a constructor for Log objects. Lazily initialized, so we\n * can avoid ever referencing the real constructor except in JS binaries\n * that actually want to include the implementation.\n * @type {?Function}\n */\nlet logConstructor = null;\n\n/**\n * Initializes log contructor.\n */\nexport function initLogConstructor() {\n  logConstructor = Log;\n  // Initialize instances for use. If a binary (an extension for example) that\n  // does not call `initLogConstructor` invokes `dev()` or `user()` earlier than\n  // the binary that does call `initLogConstructor` (amp.js), the extension will\n  // throw an error as that extension will never be able to initialize the log\n  // instances and we also don't want it to call `initLogConstructor` either\n  // (since that will cause the Log implementation to be bundled into that\n  // binary). So we must initialize the instances eagerly so that they are ready\n  // for use (stored globally) after the main binary calls `initLogConstructor`.\n  dev();\n  user();\n}\n\n/**\n * Resets log contructor for testing.\n */\nexport function resetLogConstructorForTesting() {\n  logConstructor = null;\n}\n\n/**\n * Publisher level log.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Development mode is enabled via `#development=1` or logging is explicitly\n *     enabled via `#log=D` where D >= 1.\n *  3. AMP.setLogLevel(D) is called, where D >= 1.\n *\n * @param {!Element=} opt_element\n * @return {!Log}\n */\nexport function user(opt_element) {\n  if (!logs.user) {\n    logs.user = getUserLogger(USER_ERROR_SENTINEL);\n  }\n  if (!isFromEmbed(logs.user.win, opt_element)) {\n    return logs.user;\n  } else {\n    if (logs.userForEmbed) {\n      return logs.userForEmbed;\n    }\n    return (logs.userForEmbed = getUserLogger(USER_ERROR_EMBED_SENTINEL));\n  }\n}\n\n/**\n * Getter for user logger\n * @param {string=} suffix\n * @return {!Log}\n */\nfunction getUserLogger(suffix) {\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return new logConstructor(\n    self,\n    mode => {\n      const logNum = parseInt(mode.log, 10);\n      if (mode.development || logNum >= 1) {\n        return LogLevel.FINE;\n      }\n      return LogLevel.WARN;\n    },\n    suffix\n  );\n}\n\n/**\n * AMP development log. Calls to `devLog().assert` and `dev.fine` are stripped\n * in the PROD binary. However, `devLog().assert` result is preserved in either\n * case.\n *\n * Enabled in the following conditions:\n *  1. Not disabled using `#log=0`.\n *  2. Logging is explicitly enabled via `#log=D`, where D >= 2.\n *  3. AMP.setLogLevel(D) is called, where D >= 2.\n *\n * @return {!Log}\n */\nexport function dev() {\n  if (logs.dev) {\n    return logs.dev;\n  }\n  if (!logConstructor) {\n    throw new Error('failed to call initLogConstructor');\n  }\n  return (logs.dev = new logConstructor(self, mode => {\n    const logNum = parseInt(mode.log, 10);\n    if (logNum >= 3) {\n      return LogLevel.FINE;\n    }\n    if (logNum >= 2) {\n      return LogLevel.INFO;\n    }\n    return LogLevel.OFF;\n  }));\n}\n\n/**\n * @param {!Window} win\n * @param {!Element=} opt_element\n * @return {boolean} isEmbed\n */\nexport function isFromEmbed(win, opt_element) {\n  if (!opt_element) {\n    return false;\n  }\n  return opt_element.ownerDocument.defaultView != win;\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * NOTE: for an explanation of the tempate R implementation see\n * https://github.com/google/closure-library/blob/08858804/closure/goog/asserts/asserts.js#L192-L213\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {R} The value of shouldBeTrueish.\n * @template T\n * @template R :=\n *     mapunion(T, (V) =>\n *         cond(eq(V, 'null'),\n *             none(),\n *             cond(eq(V, 'undefined'),\n *                 none(),\n *                 V)))\n *  =:\n * @throws {!Error} When `value` is `null` or `undefined`.\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function devAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  if (getMode().minified) {\n    return shouldBeTrueish;\n  }\n  return dev()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n\n/**\n * Throws an error if the first argument isn't trueish.\n *\n * Supports argument substitution into the message via %s placeholders.\n *\n * Throws an error object that has two extra properties:\n * - associatedElement: This is the first element provided in the var args.\n *   It can be used for improved display of error messages.\n * - messageArray: The elements of the substituted message as non-stringified\n *   elements in an array. When e.g. passed to console.error this yields\n *   native displays of things like HTML elements.\n *\n * NOTE: for an explanation of the tempate R implementation see\n * https://github.com/google/closure-library/blob/08858804/closure/goog/asserts/asserts.js#L192-L213\n *\n * @param {T} shouldBeTrueish The value to assert. The assert fails if it does\n *     not evaluate to true.\n * @param {!Array|string=} opt_message The assertion message\n * @param {*=} opt_1 Optional argument (Var arg as individual params for better\n * @param {*=} opt_2 Optional argument inlining)\n * @param {*=} opt_3 Optional argument\n * @param {*=} opt_4 Optional argument\n * @param {*=} opt_5 Optional argument\n * @param {*=} opt_6 Optional argument\n * @param {*=} opt_7 Optional argument\n * @param {*=} opt_8 Optional argument\n * @param {*=} opt_9 Optional argument\n * @return {R} The value of shouldBeTrueish.\n * @template T\n * @template R :=\n *     mapunion(T, (V) =>\n *         cond(eq(V, 'null'),\n *             none(),\n *             cond(eq(V, 'undefined'),\n *                 none(),\n *                 V)))\n *  =:\n * @throws {!Error} When `value` is `null` or `undefined`.\n * @closurePrimitive {asserts.matchesReturn}\n */\nexport function userAssert(\n  shouldBeTrueish,\n  opt_message,\n  opt_1,\n  opt_2,\n  opt_3,\n  opt_4,\n  opt_5,\n  opt_6,\n  opt_7,\n  opt_8,\n  opt_9\n) {\n  return user()./*Orig call*/ assert(\n    shouldBeTrueish,\n    opt_message,\n    opt_1,\n    opt_2,\n    opt_3,\n    opt_4,\n    opt_5,\n    opt_6,\n    opt_7,\n    opt_8,\n    opt_9\n  );\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from './mode';\n\n/**\n * Provides info about the current app. This return value may be cached and\n * passed around as it will always be DCE'd.\n * @param {?Window=} opt_win\n * @return {!./mode.ModeDef}\n */\nexport function getModeObject(opt_win) {\n  return {\n    localDev: getMode(opt_win).localDev,\n    development: getMode(opt_win).development,\n    filter: getMode(opt_win).filter,\n    minified: getMode(opt_win).minified,\n    lite: getMode(opt_win).lite,\n    test: getMode(opt_win).test,\n    log: getMode(opt_win).log,\n    version: getMode(opt_win).version,\n    rtvVersion: getMode(opt_win).rtvVersion,\n    singlePassType: getMode(opt_win).singlePassType,\n  };\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {internalRuntimeVersion} from './internal-version';\nimport {parseQueryString_} from './url-parse-query-string';\n\n/**\n * @typedef {{\n *   localDev: boolean,\n *   development: boolean,\n *   minified: boolean,\n *   lite: boolean,\n *   test: boolean,\n *   log: (string|undefined),\n *   version: string,\n *   rtvVersion: string,\n *   runtime: (null|string|undefined),\n *   a4aId: (null|string|undefined),\n *   singlePassType: (string|undefined)\n * }}\n */\nexport let ModeDef;\n\n/**\n * `rtvVersion` is the prefixed version we serve off of the cdn.\n * The prefix denotes canary(00) or prod(01) or an experiment version ( > 01).\n * @type {string}\n */\nlet rtvVersion = '';\n\n/**\n * Provides info about the current app.\n * @param {?Window=} opt_win\n * @return {!ModeDef}\n */\nexport function getMode(opt_win) {\n  const win = opt_win || self;\n  if (win.__AMP_MODE) {\n    return win.__AMP_MODE;\n  }\n  return (win.__AMP_MODE = getMode_(win));\n}\n\n/**\n * Provides info about the current app.\n * @param {!Window} win\n * @return {!ModeDef}\n */\nfunction getMode_(win) {\n  // TODO(erwinmombay): simplify the logic here\n  const AMP_CONFIG = self.AMP_CONFIG || {};\n\n  // Magic constants that are replaced by closure compiler.\n  // IS_MINIFIED is always replaced with true when closure compiler is used\n  // while IS_DEV is only replaced when `gulp dist` is called without the\n  // --fortesting flag.\n  const IS_DEV = true;\n  const IS_MINIFIED = false;\n\n  const localDevEnabled = !!AMP_CONFIG.localDev;\n  const runningTests =\n    !!AMP_CONFIG.test || (IS_DEV && !!(win.__AMP_TEST || win.__karma__));\n  const runningTestsOnIe = win.__karma__ && win.__karma__.config.amp.testOnIe;\n  const isLocalDev = IS_DEV && (localDevEnabled || runningTests);\n  const hashQuery = parseQueryString_(\n    // location.originalHash is set by the viewer when it removes the fragment\n    // from the URL.\n    win.location.originalHash || win.location.hash\n  );\n  const singlePassType = AMP_CONFIG.spt;\n\n  const searchQuery = parseQueryString_(win.location.search);\n\n  if (!rtvVersion) {\n    rtvVersion = getRtvVersion(win, isLocalDev);\n  }\n\n  // The `minified`, `test` and `localDev` properties are replaced\n  // as boolean literals when we run `gulp dist` without the `--fortesting`\n  // flags. This improved DCE on the production file we deploy as the code\n  // paths for localhost/testing/development are eliminated.\n  return {\n    localDev: isLocalDev,\n    // Triggers validation or enable pub level logging. Validation can be\n    // bypassed via #validate=0.\n    // Note that AMP_DEV_MODE flag is used for testing purposes.\n    // Use Array.indexOf instead of Array.includes because of #24219\n    development: !!(\n      ['1', 'actions', 'amp', 'amp4ads', 'amp4email'].indexOf(\n        hashQuery['development']\n      ) >= 0 || win.AMP_DEV_MODE\n    ),\n    examiner: hashQuery['development'] == '2',\n    // amp-geo override\n    geoOverride: hashQuery['amp-geo'],\n    // amp-user-location override\n    userLocationOverride: hashQuery['amp-user-location'],\n    minified: IS_MINIFIED,\n    // Whether document is in an amp-lite viewer. It signal that the user\n    // would prefer to use less bandwidth.\n    lite: searchQuery['amp_lite'] != undefined,\n    test: runningTests,\n    testIe: runningTestsOnIe,\n    log: hashQuery['log'],\n    version: internalRuntimeVersion(),\n    rtvVersion,\n    singlePassType,\n  };\n}\n\n/**\n * Retrieve the `rtvVersion` which will have a numeric prefix\n * denoting canary/prod/experiment (unless `isLocalDev` is true).\n *\n * @param {!Window} win\n * @param {boolean} isLocalDev\n * @return {string}\n */\nfunction getRtvVersion(win, isLocalDev) {\n  // If it's local dev then we won't actually have a full version so\n  // just use the version.\n  if (isLocalDev) {\n    return internalRuntimeVersion();\n  }\n\n  if (win.AMP_CONFIG && win.AMP_CONFIG.v) {\n    return win.AMP_CONFIG.v;\n  }\n\n  // Currently `internalRuntimeVersion` and thus `mode.version` contain only\n  // major version. The full version however must also carry the minor version.\n  // We will default to production default `01` minor version for now.\n  // TODO(erwinmombay): decide whether internalRuntimeVersion should contain\n  // minor version.\n  return `01${internalRuntimeVersion()}`;\n}\n\n/**\n * @param {!Window} win\n * @param {boolean} isLocalDev\n * @return {string}\n * @visibleForTesting\n */\nexport function getRtvVersionForTesting(win, isLocalDev) {\n  return getRtvVersion(win, isLocalDev);\n}\n\n/** @visibleForTesting */\nexport function resetRtvVersionForTesting() {\n  rtvVersion = '';\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * This class helps to manage observers. Observers can be added, removed or\n * fired through and instance of this class.\n * @template TYPE\n */\nexport class Observable {\n  /**\n   * Creates an instance of Observable.\n   */\n  constructor() {\n    /** @type {?Array<function(TYPE)>} */\n    this.handlers_ = null;\n  }\n\n  /**\n   * Adds the observer to this instance.\n   * @param {function(TYPE)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  add(handler) {\n    if (!this.handlers_) {\n      this.handlers_ = [];\n    }\n    this.handlers_.push(handler);\n    return () => {\n      this.remove(handler);\n    };\n  }\n\n  /**\n   * Removes the observer from this instance.\n   * @param {function(TYPE)} handler Observer's instance.\n   */\n  remove(handler) {\n    if (!this.handlers_) {\n      return;\n    }\n    const index = this.handlers_.indexOf(handler);\n    if (index > -1) {\n      this.handlers_.splice(index, 1);\n    }\n  }\n\n  /**\n   * Removes all observers.\n   */\n  removeAll() {\n    if (!this.handlers_) {\n      return;\n    }\n    this.handlers_.length = 0;\n  }\n\n  /**\n   * Fires an event. All observers are called.\n   * @param {TYPE=} opt_event\n   */\n  fire(opt_event) {\n    if (!this.handlers_) {\n      return;\n    }\n    const handlers = this.handlers_;\n    for (let i = 0; i < handlers.length; i++) {\n      const handler = handlers[i];\n      handler(opt_event);\n    }\n  }\n\n  /**\n   * Returns number of handlers. Mostly needed for tests.\n   * @return {number}\n   */\n  getHandlerCount() {\n    if (!this.handlers_) {\n      return 0;\n    }\n    return this.handlers_.length;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\n\n/**\n * Pass class helps to manage single-pass process. A pass is scheduled using\n * delay method. Only one pass can be pending at a time. If no pass is pending\n * the process is considered to be \"idle\".\n */\nexport class Pass {\n  /**\n   * Creates a new Pass instance.\n   * @param {!Window} win\n   * @param {function()} handler Handler to be executed when pass is triggered.\n   * @param {number=} opt_defaultDelay Default delay to be used when schedule\n   *   is called without one.\n   */\n  constructor(win, handler, opt_defaultDelay) {\n    this.timer_ = Services.timerFor(win);\n\n    /** @private @const {function()} */\n    this.handler_ = handler;\n\n    /** @private @const {number} */\n    this.defaultDelay_ = opt_defaultDelay || 0;\n\n    /** @private {number|string} */\n    this.scheduled_ = -1;\n\n    /** @private {number} */\n    this.nextTime_ = 0;\n\n    /** @private {boolean} */\n    this.running_ = false;\n\n    /**\n     * @private\n     * @const {function()}\n     */\n    this.boundPass_ = () => {\n      this.pass_();\n    };\n  }\n\n  /**\n   * Whether or not a pass is currently pending.\n   * @return {boolean}\n   */\n  isPending() {\n    return this.scheduled_ != -1;\n  }\n\n  /**\n   * Tries to schedule a new pass optionally with specified delay. If the new\n   * requested pass is requested before the pending pass, the pending pass is\n   * canceled. If the new pass is requested after the pending pass, the newly\n   * requested pass is ignored.\n   *\n   * Returns {@code true} if the pass has been scheduled and {@code false} if\n   * ignored.\n   *\n   * @param {number=} opt_delay Delay to schedule the pass. If not specified\n   *   the default delay is used, falling back to 0.\n   * @return {boolean}\n   */\n  schedule(opt_delay) {\n    let delay = opt_delay || this.defaultDelay_;\n    if (this.running_ && delay < 10) {\n      // If we get called recursively, wait at least 10ms for the next\n      // execution.\n      delay = 10;\n    }\n\n    const nextTime = Date.now() + delay;\n    // Schedule anew if nothing is scheduled currently or if the new time is\n    // sooner then previously requested.\n    if (!this.isPending() || nextTime - this.nextTime_ < -10) {\n      this.cancel();\n      this.nextTime_ = nextTime;\n      this.scheduled_ = this.timer_.delay(this.boundPass_, delay);\n\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   *\n   */\n  pass_() {\n    this.scheduled_ = -1;\n    this.nextTime_ = 0;\n    this.running_ = true;\n    this.handler_();\n    this.running_ = false;\n  }\n\n  /**\n   * Cancels the pending pass if any.\n   */\n  cancel() {\n    if (this.isPending()) {\n      this.timer_.cancel(this.scheduled_);\n      this.scheduled_ = -1;\n    }\n  }\n}\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {WindowInterface} from '../src/window-interface';\nimport {createElementWithAttributes} from '../src/dom';\nimport {dict} from '../src/utils/object';\nimport {user} from '../src/log';\n\n/** @const {string} */\nconst TAG = 'pixel';\n\n/**\n * @param {!Window} win\n * @param {string} src\n * @param {?string=} referrerPolicy\n * @return {!Element}\n */\nexport function createPixel(win, src, referrerPolicy) {\n  if (referrerPolicy && referrerPolicy !== 'no-referrer') {\n    user().error(TAG, 'Unsupported referrerPolicy: %s', referrerPolicy);\n  }\n\n  return referrerPolicy === 'no-referrer'\n    ? createNoReferrerPixel(win, src)\n    : createImagePixel(win, src);\n}\n\n/**\n * @param {!Window} win\n * @param {string} src\n * @return {!Element}\n */\nfunction createNoReferrerPixel(win, src) {\n  if (isReferrerPolicySupported()) {\n    return createImagePixel(win, src, true);\n  } else {\n    // if \"referrerPolicy\" is not supported, use iframe wrapper\n    // to scrub the referrer.\n    const iframe = createElementWithAttributes(\n      /** @type {!Document} */ (win.document),\n      'iframe',\n      dict({\n        'src': 'about:blank',\n        'style': 'display:none',\n      })\n    );\n    win.document.body.appendChild(iframe);\n    createImagePixel(iframe.contentWindow, src);\n    return iframe;\n  }\n}\n\n/**\n * @param {!Window} win\n * @param {string} src\n * @param {boolean=} noReferrer\n * @return {!Image}\n */\nfunction createImagePixel(win, src, noReferrer = false) {\n  const Image = WindowInterface.getImage(win);\n  const image = new Image();\n  if (noReferrer) {\n    image.referrerPolicy = 'no-referrer';\n  }\n  image.src = src;\n  return image;\n}\n\n/**\n * Check if element attribute \"referrerPolicy\" is supported by the browser.\n * Safari 11.1 does not support it yet.\n *\n * @return {boolean}\n */\nfunction isReferrerPolicySupported() {\n  return 'referrerPolicy' in Image.prototype;\n}\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @typedef {{\n *   promise: !Promise<undefined>,\n *   resolve: function(),\n * }}\n */\nlet DeferredDef;\n\n/**\n * @typedef {!Function}\n */\nlet CustomElementConstructorDef;\n\n/**\n * @typedef {{\n *  name: string,\n *  ctor: !CustomElementConstructorDef,\n * }}\n */\nlet CustomElementDef;\n\n/**\n * Validates the custom element's name.\n * This intentionally ignores \"valid\" higher Unicode Code Points.\n * https://html.spec.whatwg.org/multipage/custom-elements.html#valid-custom-element-name\n */\nconst VALID_NAME = /^[a-z][a-z0-9._]*-[a-z0-9._-]*$/;\nconst INVALID_NAMES = [\n  'annotation-xml',\n  'color-profile',\n  'font-face',\n  'font-face-src',\n  'font-face-uri',\n  'font-face-format',\n  'font-face-name',\n  'missing-glyph',\n];\n\n/**\n * A MutationObserverInit dictionary to track subtree modifications.\n */\nconst TRACK_SUBTREE = {\n  'childList': true,\n  'subtree': true,\n};\n\n/**\n * Asserts that the custom element name conforms to the spec.\n *\n * @param {!Function} SyntaxError\n * @param {string} name\n */\nfunction assertValidName(SyntaxError, name) {\n  if (!VALID_NAME.test(name) || INVALID_NAMES.includes(name)) {\n    throw new SyntaxError(`invalid custom element name \"${name}\"`);\n  }\n}\n\n/**\n * Does win have a full Custom Elements registry?\n *\n * @param {!Window} win\n * @return {boolean}\n */\nfunction hasCustomElements(win) {\n  const {customElements} = win;\n\n  return !!(\n    customElements &&\n    customElements.define &&\n    customElements.get &&\n    customElements.whenDefined\n  );\n}\n\n/**\n * Was HTMLElement already patched for this window?\n *\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isPatched(win) {\n  const tag = win.HTMLElement.toString();\n  return tag.indexOf('[native code]') === -1;\n}\n\n/**\n * Throws the error outside the current event loop.\n *\n * @param {!Error} error\n */\nfunction rethrowAsync(error) {\n  new /*OK*/ Promise(() => {\n    throw error;\n  });\n}\n\n/**\n * The public Custom Elements API.\n */\nclass CustomElementRegistry {\n  /**\n   * @param {!Window} win\n   * @param {!Registry} registry\n   */\n  constructor(win, registry) {\n    /**\n     * @const @private\n     */\n    this.win_ = win;\n\n    /**\n     * @const @private\n     */\n    this.registry_ = registry;\n\n    /**\n     * @type {!Object<string, DeferredDef>}\n     * @private\n     * @const\n     */\n    this.pendingDefines_ = win.Object.create(null);\n  }\n\n  /**\n   * Register the custom element.\n   *\n   * @param {string} name\n   * @param {!CustomElementConstructorDef} ctor\n   * @param {!Object=} options\n   */\n  define(name, ctor, options) {\n    this.registry_.define(name, ctor, options);\n\n    // If anyone is waiting for this custom element to be defined, resolve\n    // their promise.\n    const pending = this.pendingDefines_;\n    const deferred = pending[name];\n    if (deferred) {\n      deferred.resolve();\n      delete pending[name];\n    }\n  }\n\n  /**\n   * Get the constructor of the (already defined) custom element.\n   *\n   * @param {string} name\n   * @return {!CustomElementConstructorDef|undefined}\n   */\n  get(name) {\n    const def = this.registry_.getByName(name);\n    if (def) {\n      return def.ctor;\n    }\n  }\n\n  /**\n   * Returns a promise that waits until the custom element is defined.\n   * If the custom element is already defined, returns a resolved promise.\n   *\n   * @param {string} name\n   * @return {!Promise<undefined>}\n   */\n  whenDefined(name) {\n    const {Promise, SyntaxError} = this.win_;\n    assertValidName(SyntaxError, name);\n\n    if (this.registry_.getByName(name)) {\n      return Promise.resolve();\n    }\n\n    const pending = this.pendingDefines_;\n    const deferred = pending[name];\n    if (deferred) {\n      return deferred.promise;\n    }\n\n    let resolve;\n    const promise = new /*OK*/ Promise(res => (resolve = res));\n    pending[name] = {\n      promise,\n      resolve,\n    };\n\n    return promise;\n  }\n\n  /**\n   * Upgrade all custom elements inside root.\n   *\n   * @param {!Node} root\n   */\n  upgrade(root) {\n    this.registry_.upgrade(root);\n  }\n}\n\n/**\n * This internal APIs necessary to run the CustomElementRegistry.\n * Since Registry is never exposed externally, all methods are actually\n * available on the instance.\n */\nclass Registry {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /**\n     * @private @const\n     */\n    this.win_ = win;\n\n    /**\n     * @private @const\n     */\n    this.doc_ = win.document;\n\n    /**\n     * @type {!Object<string, !CustomElementDef>}\n     * @private\n     * @const\n     */\n    this.definitions_ = win.Object.create(null);\n\n    /**\n     * A up-to-date DOM selector for all custom elements.\n     * @type {string}\n     */\n    this.query_ = '';\n\n    /**\n     * The currently upgrading element.\n     * @private {Element}\n     */\n    this.current_ = null;\n\n    /**\n     * Once started (after the first Custom Element definition), this tracks\n     * DOM append and removals.\n     *\n     * @private {MutationObserver}\n     */\n    this.mutationObserver_ = null;\n\n    /**\n     * All the observed DOM trees, including shadow trees. This is cleared out\n     * when the mutation observer is created.\n     *\n     * @private @const {!Array<!Node>}\n     */\n    this.observed_ = [win.document];\n  }\n\n  /**\n   * The currently-being-upgraded custom element.\n   *\n   * When an already created (through the DOM parsing APIs, or innerHTML)\n   * custom element node is being upgraded, we can't just create a new node\n   * (it's illegal in the spec). But we still need to run the custom element's\n   * constructor code on the node. We avoid this conundrum by running the\n   * constructor while returning this current node in the HTMLElement\n   * class constructor (the base class of all custom elements).\n   *\n   * @return {Element}\n   */\n  current() {\n    const current = this.current_;\n    this.current_ = null;\n    return current;\n  }\n\n  /**\n   * Finds the custom element definition by name.\n   *\n   * @param {string} name\n   * @return {CustomElementDef|undefined}\n   */\n  getByName(name) {\n    const definition = this.definitions_[name];\n    if (definition) {\n      return definition;\n    }\n  }\n\n  /**\n   * Finds the custom element definition by constructor instance.\n   *\n   * @param {CustomElementConstructorDef} ctor\n   * @return {CustomElementDef|undefined}\n   */\n  getByConstructor(ctor) {\n    const definitions = this.definitions_;\n\n    for (const name in definitions) {\n      const def = definitions[name];\n      if (def.ctor === ctor) {\n        return def;\n      }\n    }\n  }\n\n  /**\n   * Registers the custom element definition, and upgrades all elements by that\n   * name in the root document.\n   *\n   * @param {string} name\n   * @param {!CustomElementConstructorDef} ctor\n   * @param {!Object|undefined} options\n   */\n  define(name, ctor, options) {\n    const {Error, SyntaxError} = this.win_;\n\n    if (options) {\n      throw new Error('Extending native custom elements is not supported');\n    }\n\n    assertValidName(SyntaxError, name);\n\n    if (this.getByName(name) || this.getByConstructor(ctor)) {\n      throw new Error(`duplicate definition \"${name}\"`);\n    }\n\n    // TODO(jridgewell): Record connectedCallback, disconnectedCallback,\n    // adoptedCallback, attributeChangedCallback, and observedAttributes.\n    // TODO(jridgewell): If attributeChangedCallback, gather observedAttributes\n    this.definitions_[name] = {\n      name,\n      ctor,\n    };\n\n    this.observe_(name);\n    this.upgrade(this.doc_, name);\n  }\n\n  /**\n   * Upgrades custom elements descendants of root (but not including root).\n   *\n   * When called with an opt_query, it both upgrades and connects the custom\n   * elements (this is used during the custom element define algorithm).\n   *\n   * @param {!Node} root\n   * @param {string=} opt_query\n   */\n  upgrade(root, opt_query) {\n    // Only CustomElementRegistry.p.define provides a query (the newly defined\n    // custom element). In this case, we are both upgrading _and_ connecting\n    // the custom elements.\n    const newlyDefined = !!opt_query;\n    const query = opt_query || this.query_;\n    const upgradeCandidates = this.queryAll_(root, query);\n\n    for (let i = 0; i < upgradeCandidates.length; i++) {\n      const candidate = upgradeCandidates[i];\n      if (newlyDefined) {\n        this.connectedCallback_(candidate);\n      } else {\n        this.upgradeSelf(candidate);\n      }\n    }\n  }\n\n  /**\n   * Upgrades the custom element node, if a custom element has been registered\n   * by this name.\n   *\n   * @param {!Node} node\n   */\n  upgradeSelf(node) {\n    const def = this.getByName(node.localName);\n    if (!def) {\n      return;\n    }\n\n    this.upgradeSelf_(/** @type {!Element} */ (node), def);\n  }\n\n  /**\n   * @param {!Node} root\n   * @param {string} query\n   * @return {!Array|!NodeList}\n   */\n  queryAll_(root, query) {\n    if (!query || !root.querySelectorAll) {\n      // Nothing to do...\n      return [];\n    }\n\n    return root.querySelectorAll(query);\n  }\n\n  /**\n   * Upgrades the (already created via DOM parsing) custom element.\n   *\n   * @param {!Element} node\n   * @param {!CustomElementDef} def\n   */\n  upgradeSelf_(node, def) {\n    const {ctor} = def;\n    if (node instanceof ctor) {\n      return;\n    }\n\n    // Despite how it looks, this is not a useless construction.\n    // HTMLElementPolyfill (the base class of all custom elements) will return\n    // the current node, allowing the custom element's subclass constructor to\n    // run on the node. The node itself is already constructed, so the return\n    // value is just the node.\n    this.current_ = node;\n    try {\n      const el = new ctor();\n\n      if (el !== node) {\n        throw new this.win_.Error(\n          'Constructor illegally returned a different instance.'\n        );\n      }\n    } catch (e) {\n      rethrowAsync(e);\n    }\n  }\n\n  /**\n   * Fires connectedCallback on the custom element, if it has one.\n   * This also upgrades the custom element, since it may not have been\n   * accessible via the root document before (a detached DOM tree).\n   *\n   * @param {!Node} node\n   */\n  connectedCallback_(node) {\n    const def = this.getByName(node.localName);\n    if (!def) {\n      return;\n    }\n    this.upgradeSelf_(/** @type {!Element} */ (node), def);\n    // TODO(jridgewell): It may be appropriate to adoptCallback, if the node\n    // used to be in another doc.\n    // TODO(jridgewell): I should be calling the definitions connectedCallback\n    // with node as the context.\n    if (node.connectedCallback) {\n      try {\n        node.connectedCallback();\n      } catch (e) {\n        rethrowAsync(e);\n      }\n    }\n  }\n\n  /**\n   * Fires disconnectedCallback on the custom element, if it has one.\n   *\n   * @param {!Node} node\n   */\n  disconnectedCallback_(node) {\n    // TODO(jridgewell): I should be calling the definitions connectedCallback\n    // with node as the context.\n    if (node.disconnectedCallback) {\n      try {\n        node.disconnectedCallback();\n      } catch (e) {\n        rethrowAsync(e);\n      }\n    }\n  }\n\n  /**\n   * Records name as a registered custom element to observe.\n   *\n   * Starts the Mutation Observer if this is the first registered custom\n   * element. This is deferred until the first custom element is defined to\n   * speed up initial rendering of the page.\n   *\n   * Mutation Observers are conveniently available in every browser we care\n   * about. When a node is connected to the root document, all custom\n   * elements (including that node iteself) will be upgraded and call\n   * connectedCallback. When a node is disconnectedCallback from the root\n   * document, all custom elements will call disconnectedCallback.\n   *\n   * @param {string} name\n   */\n  observe_(name) {\n    if (this.query_) {\n      this.query_ += `,${name}`;\n      return;\n    }\n\n    this.query_ = name;\n\n    // The first registered name starts the mutation observer.\n    const mo = new this.win_.MutationObserver(records => {\n      if (records) {\n        this.handleRecords_(records);\n      }\n    });\n    this.mutationObserver_ = mo;\n\n    this.observed_.forEach(tree => {\n      mo.observe(tree, TRACK_SUBTREE);\n    });\n    this.observed_.length = 0;\n\n    installPatches(this.win_, this);\n  }\n\n  /**\n   * Adds the shadow tree to be observed by the polyfill.\n   *\n   * @param {!Node} tree\n   */\n  observe(tree) {\n    if (this.mutationObserver_) {\n      this.mutationObserver_.observe(tree, TRACK_SUBTREE);\n    } else {\n      this.observed_.push(tree);\n    }\n  }\n\n  /**\n   * This causes a synchronous handling of all the Mutation Observer's tracked\n   * mutations. This does nothing until the mutation observer is actually\n   * registered on the first Custom Element definition.\n   */\n  sync() {\n    if (this.mutationObserver_) {\n      this.handleRecords_(this.mutationObserver_.takeRecords());\n    }\n  }\n\n  /**\n   * Handle all the Mutation Observer's Mutation Records.\n   * All added custom elements will be upgraded (if not already) and call\n   * connectedCallback. All removed custom elements will call\n   * disconnectedCallback.\n   *\n   * @param {!Array<!MutationRecord>} records\n   */\n  handleRecords_(records) {\n    for (let i = 0; i < records.length; i++) {\n      const record = records[i];\n      if (!record) {\n        continue;\n      }\n\n      const {addedNodes, removedNodes} = record;\n      for (let i = 0; i < addedNodes.length; i++) {\n        const node = addedNodes[i];\n        const connectedCandidates = this.queryAll_(node, this.query_);\n        this.connectedCallback_(node);\n        for (let i = 0; i < connectedCandidates.length; i++) {\n          this.connectedCallback_(connectedCandidates[i]);\n        }\n      }\n\n      for (let i = 0; i < removedNodes.length; i++) {\n        const node = removedNodes[i];\n        const disconnectedCandidates = this.queryAll_(node, this.query_);\n        this.disconnectedCallback_(node);\n        for (let i = 0; i < disconnectedCandidates.length; i++) {\n          this.disconnectedCallback_(disconnectedCandidates[i]);\n        }\n      }\n    }\n  }\n}\n\n/**\n * Patches the DOM APIs to support synchronous Custom Elements.\n * @param {!Window} win\n * @param {!Registry} registry\n */\nfunction installPatches(win, registry) {\n  const {Document, Element, Node, Object, document} = win;\n  const docProto = Document.prototype;\n  const elProto = Element.prototype;\n  const nodeProto = Node.prototype;\n  const {createElement, importNode} = docProto;\n  const {\n    appendChild,\n    cloneNode,\n    insertBefore,\n    removeChild,\n    replaceChild,\n  } = nodeProto;\n\n  // Patch createElement to immediately upgrade the custom element.\n  // This has the added benefit that it avoids the \"already created but needs\n  // constructor code run\" chicken-and-egg problem.\n  docProto.createElement = function(name) {\n    const def = registry.getByName(name);\n    if (def) {\n      return new def.ctor();\n    }\n    return createElement.apply(this, arguments);\n  };\n\n  // Patch importNode to immediately upgrade custom elements.\n  // TODO(jridgewell): Can fire adoptedCallback for cross doc imports.\n  docProto.importNode = function() {\n    const imported = importNode.apply(this, arguments);\n\n    // Only upgrade elements if the document that the nodes were imported into\n    // is _this_ document. If it's another document, then that document's\n    // element registry must do the upgrade.\n    // Eg, when importing from a <template>, the cloned document fragment\n    // should be upgraded. But importing from document into the <template>\n    // should not.\n    if (imported && this === document) {\n      registry.upgradeSelf(imported);\n      registry.upgrade(imported);\n    }\n    return imported;\n  };\n\n  // Patch appendChild to upgrade custom elements before returning.\n  nodeProto.appendChild = function() {\n    const appended = appendChild.apply(this, arguments);\n    registry.sync();\n    return appended;\n  };\n\n  // Patch insertBefore to upgrade custom elements before returning.\n  nodeProto.insertBefore = function() {\n    const inserted = insertBefore.apply(this, arguments);\n    registry.sync();\n    return inserted;\n  };\n\n  // Patch removeChild to upgrade custom elements before returning.\n  nodeProto.removeChild = function() {\n    const removed = removeChild.apply(this, arguments);\n    registry.sync();\n    return removed;\n  };\n\n  // Patch replaceChild to upgrade and detach custom elements before returning.\n  nodeProto.replaceChild = function() {\n    const replaced = replaceChild.apply(this, arguments);\n    registry.sync();\n    return replaced;\n  };\n\n  // Patch cloneNode to immediately upgrade custom elements.\n  nodeProto.cloneNode = function() {\n    const cloned = cloneNode.apply(this, arguments);\n\n    // Only upgrade elements if the cloned node belonged to _this_ document.\n    // Eg, when cloning a <template>'s content, the cloned document fragment\n    // does not belong to this document.\n    if (cloned.ownerDocument === document) {\n      registry.upgradeSelf(cloned);\n      registry.upgrade(cloned);\n    }\n    return cloned;\n  };\n\n  // Patch the innerHTML setter to immediately upgrade custom elements.\n  // Note, this could technically fire connectedCallbacks if this node was\n  // connected, but we leave that to the Mutation Observer.\n  let innerHTMLProto = elProto;\n  let innerHTMLDesc = Object.getOwnPropertyDescriptor(\n    innerHTMLProto,\n    'innerHTML'\n  );\n  if (!innerHTMLDesc) {\n    // Sigh... IE11 puts innerHTML desciptor on HTMLElement. But, we've\n    // replaced HTMLElement with a polyfill wrapper, so have to get its proto.\n    innerHTMLProto =\n      /** @type {!Object} */ (win.HTMLElement.prototype.__proto__);\n    innerHTMLDesc = Object.getOwnPropertyDescriptor(\n      innerHTMLProto,\n      'innerHTML'\n    );\n  }\n  const innerHTMLSetter = innerHTMLDesc.set;\n  innerHTMLDesc.set = function(html) {\n    innerHTMLSetter.call(this, html);\n    registry.upgrade(this);\n  };\n  Object.defineProperty(innerHTMLProto, 'innerHTML', innerHTMLDesc);\n}\n\n/**\n * Does the polyfilling.\n * @param {!Window} win\n */\nfunction polyfill(win) {\n  const {Element, HTMLElement, Object, document} = win;\n  const {createElement} = document;\n\n  const registry = new Registry(win);\n  const customElements = new CustomElementRegistry(win, registry);\n\n  // Expose the custom element registry.\n  // Object.getOwnPropertyDescriptor(window, 'customElements')\n  // {get: , set: undefined, enumerable: true, configurable: true}\n  Object.defineProperty(win, 'customElements', {\n    enumerable: true,\n    configurable: true,\n    // writable: false,\n    value: customElements,\n  });\n\n  // Have to patch shadow methods now, since there's no way to find shadow trees\n  // later.\n  const elProto = Element.prototype;\n  const {attachShadow, createShadowRoot} = elProto;\n  if (attachShadow) {\n    /**\n     * @param {!{mode: string}} unused\n     * @return {!ShadowRoot}\n     */\n    elProto.attachShadow = function(unused) {\n      const shadow = attachShadow.apply(this, arguments);\n      registry.observe(shadow);\n      return shadow;\n    };\n    // Necessary for Shadow AMP\n    elProto.attachShadow.toString = function() {\n      return attachShadow.toString();\n    };\n  }\n  if (createShadowRoot) {\n    /**\n     * @return {!ShadowRoot}\n     */\n    elProto.createShadowRoot = function() {\n      const shadow = createShadowRoot.apply(this, arguments);\n      registry.observe(shadow);\n      return shadow;\n    };\n    // Necessary for Shadow AMP\n    elProto.createShadowRoot.toString = function() {\n      return createShadowRoot.toString();\n    };\n  }\n\n  /**\n   * You can't use the real HTMLElement constructor, because you can't subclass\n   * it without using native classes. So, mock its approximation using\n   * createElement.\n   * @return {*} TODO(#23582): Specify return type\n   */\n  function HTMLElementPolyfill() {\n    const {constructor} = this;\n\n    // If we're upgrading an already created custom element, we can't create\n    // another new node (by the spec, it must be the same node).\n    let el = registry.current();\n\n    // If there's not a already created custom element, we're being invoked via\n    // `new`ing the constructor.\n    //\n    // Technically, we could get here via createElement, but we patched that.\n    // If it the custom element was registered, the patch turned it into a\n    // `new` call.\n    // If it was not registered, the native createElement is used. And if\n    // native createElement is being used and we got to this code, we're really\n    // in an infinite loop (a native createElement call just below) so we've\n    // got bigger problems.\n    //\n    // So just take my word we got here via `new`.\n    if (!el) {\n      // The custom element definition is an invariant. If the custom element\n      // is registered, everything works. If it's not, it throws in the member\n      // property access (only defined custom elements can be directly\n      // constructed via `new`).\n      const def = registry.getByConstructor(constructor);\n      el = createElement.call(document, def.name);\n    }\n\n    // Finally, if the node was already constructed, we need to reset its\n    // prototype to the custom element prototype. And if it wasn't already\n    // constructed, we created a new node via native createElement, and we need\n    // to reset its prototype. Basically always reset the prototype.\n    el.__proto__ = constructor.prototype;\n    return el;\n  }\n  subClass(Object, HTMLElement, HTMLElementPolyfill);\n\n  // Expose the polyfilled HTMLElement constructor for everyone to extend from.\n  win.HTMLElement = HTMLElementPolyfill;\n}\n\n/**\n * Wraps HTMLElement in a Reflect.construct constructor, so that transpiled\n * classes can `_this = superClass.call(this)` during their construction.\n *\n * This is only used when Custom Elements v1 is already available _and_ we're\n * using transpiled classes (which use ES5 construction idioms).\n *\n * @param {!Window} win\n * @suppress {globalThis}\n */\nfunction wrapHTMLElement(win) {\n  const {HTMLElement, Reflect, Object} = win;\n  /**\n   * @return {!Element}\n   */\n  function HTMLElementWrapper() {\n    const ctor = /** @type {function(...?):?|undefined} */ (this.constructor);\n\n    // Reflect.construct allows us to construct a new HTMLElement without using\n    // `new` (which will always fail because native HTMLElement is a restricted\n    // constructor).\n    return Reflect.construct(HTMLElement, [], ctor);\n  }\n  subClass(Object, HTMLElement, HTMLElementWrapper);\n\n  // Expose the wrapped HTMLElement constructor for everyone to extend from.\n  win.HTMLElement = HTMLElementWrapper;\n}\n\n/**\n * Setups up prototype inheritance\n *\n * @param {!Object} Object\n * @param {!Function} superClass\n * @param {!Function} subClass\n */\nfunction subClass(Object, superClass, subClass) {\n  // Object.getOwnPropertyDescriptor(superClass.prototype, 'constructor')\n  // {value: , writable: true, enumerable: false, configurable: true}\n  subClass.prototype = Object.create(superClass.prototype, {\n    constructor: {\n      // enumerable: false,\n      configurable: true,\n      writable: true,\n      value: subClass,\n    },\n  });\n  subClass.__proto__ = superClass;\n}\n\n/**\n * Polyfills Custom Elements v1 API. This has 5 modes:\n *\n * 1. Custom elements v1 already supported, using native classes\n * 2. Custom elements v1 already supported, using transpiled classes\n * 3. Custom elements v1 not supported, using native classes\n * 4. Custom elements v1 not supported, using transpiled classes\n * 5. No sample class constructor provided\n *\n * In mode 1, nothing is done. In mode 2, a minimal polyfill is used to support\n * extending the HTMLElement base class. In mode 3, 4, and 5 a full polyfill is\n * done.\n *\n * @param {!Window} win\n * @param {!Function=} opt_ctor\n */\nexport function install(win, opt_ctor) {\n  // Don't install in no-DOM environments e.g. worker.\n  const shouldInstall = win.document;\n  const hasCE = hasCustomElements(win);\n  if (!shouldInstall || (hasCE && isPatched(win))) {\n    return;\n  }\n\n  let install = true;\n  let installWrapper = false;\n\n  if (opt_ctor && hasCE) {\n    // If ctor is constructable without new, it's a function. That means it was\n    // compiled down, and we need to do the minimal polyfill because all you\n    // cannot extend HTMLElement without native classes.\n    try {\n      const {Object, Reflect} = win;\n\n      // \"Construct\" ctor using ES5 idioms\n      const instance = Object.create(opt_ctor.prototype);\n      opt_ctor.call(instance);\n\n      // If that succeeded, we're in a transpiled environment\n      // Let's find out if we can wrap HTMLElement and avoid a full patch.\n      installWrapper = !!(Reflect && Reflect.construct);\n    } catch (e) {\n      // The ctor threw when we constructed is via ES5, so it's a real class.\n      // We're ok to not install the polyfill.\n      install = false;\n    }\n  }\n\n  if (installWrapper) {\n    wrapHTMLElement(win);\n  } else if (install) {\n    polyfill(win);\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Polyfill for `document.contains()` method. Notice that according to spec\n * `document.contains` is inclusionary.\n * See https://developer.mozilla.org/en-US/docs/Web/API/Node/contains\n * @param {?Node} node\n * @return {boolean}\n * @this {Node}\n */\nfunction documentContainsPolyfill(node) {\n  // Per spec, \"contains\" method is inclusionary\n  // i.e. `node.contains(node) == true`. However, we still need to test\n  // equality to the document itself.\n  return node == this || this.documentElement.contains(node);\n}\n\n/**\n * Polyfills `HTMLDocument.contains` API.\n * @param {!Window} win\n */\nexport function install(win) {\n  // HTMLDocument is undefined in Internet Explorer 10, but it has Document,\n  // so we use that as a fallback.\n  const documentClass = win.HTMLDocument || win.Document;\n  if (documentClass && !documentClass.prototype.contains) {\n    win.Object.defineProperty(documentClass.prototype, 'contains', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: documentContainsPolyfill,\n    });\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Polyfill for `DOMTokenList.prototype.toggle(token, opt_force)` method. This\n * is specially important because IE does not support `opt_force` attribute. See\n * https://goo.gl/hgKNYY for details.\n * @param {string} token\n * @param {boolean=} opt_force\n * @this {DOMTokenList}\n * @return {boolean}\n */\nfunction domTokenListTogglePolyfill(token, opt_force) {\n  const remove = opt_force === undefined ? this.contains(token) : !opt_force;\n  if (remove) {\n    this.remove(token);\n    return false;\n  } else {\n    this.add(token);\n    return true;\n  }\n}\n\n/**\n * Polyfills `DOMTokenList.prototype.toggle` API and makes `.add` accepts N\n * classes in IE.\n * @param {!Window} win\n */\nexport function install(win) {\n  if (isIe(win) && win.DOMTokenList) {\n    win.Object.defineProperty(win.DOMTokenList.prototype, 'toggle', {\n      enumerable: false,\n      configurable: true,\n      writable: true,\n      value: domTokenListTogglePolyfill,\n    });\n\n    const {add} = win.DOMTokenList.prototype;\n    win.DOMTokenList.prototype.add = function() {\n      for (let i = 0; i < arguments.length; i++) {\n        add.call(this, arguments[i]);\n      }\n    };\n  }\n}\n\n/**\n * Whether the current browser is a IE browser.\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isIe(win) {\n  return /Trident|MSIE|IEMobile/i.test(win.navigator.userAgent);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Provides a services to preconnect to a url to warm up the\n * connection before the real request can be made.\n */\n\nimport {Services} from './services';\nimport {dev} from './log';\nimport {getService, registerServiceBuilder} from './service';\nimport {htmlFor} from './static-template';\nimport {parseUrlDeprecated} from './url';\nimport {startsWith} from './string';\nimport {toWin} from './types';\nimport {whenDocumentComplete} from './document-ready';\n\nconst ACTIVE_CONNECTION_TIMEOUT_MS = 180 * 1000;\nconst PRECONNECT_TIMEOUT_MS = 10 * 1000;\n\n/**\n * @typedef {{\n *   preload: (boolean|undefined),\n *   preconnect: (boolean|undefined)\n * }}\n */\nlet PreconnectFeaturesDef;\n\n/** @private {?PreconnectFeaturesDef} */\nlet preconnectFeatures = null;\n\n/**\n * Detect related features if feature detection is supported by the\n * browser. Even if this fails, the browser may support the feature.\n * @param {!Window} win\n * @return {!PreconnectFeaturesDef}\n */\nfunction getPreconnectFeatures(win) {\n  if (!preconnectFeatures) {\n    const linkTag = win.document.createElement('link');\n    const tokenList = linkTag['relList'];\n    linkTag.as = 'invalid-value';\n    if (!tokenList || !tokenList.supports) {\n      return {};\n    }\n    preconnectFeatures = {\n      preconnect: tokenList.supports('preconnect'),\n      preload: tokenList.supports('preload'),\n      onlyValidAs: linkTag.as != 'invalid-value',\n    };\n  }\n  return preconnectFeatures;\n}\n\n/**\n * @param {?PreconnectFeaturesDef} features\n */\nexport function setPreconnectFeaturesForTesting(features) {\n  preconnectFeatures = features;\n}\n\nclass PreconnectService {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private @const {!Document} */\n    this.document_ = win.document;\n\n    /** @private @const {!Element} */\n    this.head_ = dev().assertElement(win.document.head);\n    /**\n     * Origin we've preconnected to and when that connection\n     * expires as a timestamp in MS.\n     * @private @const {!Object<string, number>}\n     */\n    this.origins_ = {};\n    /**\n     * Urls we've prefetched.\n     * @private @const {!Object<string, boolean>}\n     */\n    this.urls_ = {};\n    /** @private @const {!./service/platform-impl.Platform}  */\n    this.platform_ = Services.platformFor(win);\n    // Mark current origin as preconnected.\n    this.origins_[parseUrlDeprecated(win.location.href).origin] = true;\n\n    /**\n     * Detect support for the given resource hints.\n     * Unfortunately not all browsers support this, so this can only\n     * be used as an affirmative signal.\n     * @private @const {!PreconnectFeaturesDef}\n     */\n    this.features_ = getPreconnectFeatures(win);\n\n    /** @private @const {!./service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n  }\n\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   */\n  url(ampdoc, url, opt_alsoConnecting) {\n    ampdoc.whenFirstVisible().then(() => {\n      this.url_(ampdoc, url, opt_alsoConnecting);\n    });\n  }\n\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   * @private\n   */\n  url_(ampdoc, url, opt_alsoConnecting) {\n    if (!this.isInterestingUrl_(url)) {\n      return;\n    }\n    const {origin} = parseUrlDeprecated(url);\n    const now = Date.now();\n    const lastPreconnectTimeout = this.origins_[origin];\n    if (lastPreconnectTimeout && now < lastPreconnectTimeout) {\n      if (opt_alsoConnecting) {\n        this.origins_[origin] = now + ACTIVE_CONNECTION_TIMEOUT_MS;\n      }\n      return;\n    }\n    // If we are about to use the connection, don't re-preconnect for\n    // 180 seconds.\n    const timeout = opt_alsoConnecting\n      ? ACTIVE_CONNECTION_TIMEOUT_MS\n      : PRECONNECT_TIMEOUT_MS;\n    this.origins_[origin] = now + timeout;\n    // If we know that preconnect is supported, there is no need to do\n    // dedicated dns-prefetch.\n    let dns;\n    if (!this.features_.preconnect) {\n      dns = this.document_.createElement('link');\n      dns.setAttribute('rel', 'dns-prefetch');\n      dns.setAttribute('href', origin);\n      this.head_.appendChild(dns);\n    }\n    const preconnect = this.document_.createElement('link');\n    preconnect.setAttribute('rel', 'preconnect');\n    preconnect.setAttribute('href', origin);\n    preconnect.setAttribute('referrerpolicy', 'origin');\n    this.head_.appendChild(preconnect);\n\n    // Remove the tags eventually to free up memory.\n    this.timer_.delay(() => {\n      if (dns && dns.parentNode) {\n        dns.parentNode.removeChild(dns);\n      }\n      if (preconnect.parentNode) {\n        preconnect.parentNode.removeChild(preconnect);\n      }\n    }, 10000);\n\n    this.preconnectPolyfill_(ampdoc, origin);\n  }\n\n  /**\n   * Asks the browser to preload a URL. Always also does a preconnect\n   * because browser support for that is better.\n   *\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} url\n   * @param {string=} opt_preloadAs\n   */\n  preload(ampdoc, url, opt_preloadAs) {\n    if (!this.isInterestingUrl_(url)) {\n      return;\n    }\n    if (this.urls_[url]) {\n      return;\n    }\n    this.urls_[url] = true;\n    this.url(ampdoc, url, /* opt_alsoConnecting */ true);\n    if (!this.features_.preload) {\n      return;\n    }\n    if (opt_preloadAs == 'document' && this.platform_.isSafari()) {\n      // Preloading documents currently does not work in Safari,\n      // because it\n      // - does not support preloading iframes\n      // - and uses a different cache for iframes (when loaded without\n      //   as attribute).\n      return;\n    }\n    ampdoc.whenFirstVisible().then(() => {\n      this.performPreload_(url);\n    });\n  }\n\n  /**\n   * Performs a preload using `<link rel=\"preload\">`.\n   * @param {string} url\n   * @private\n   */\n  performPreload_(url) {\n    const preload = htmlFor(this.document_)`\n        <link rel=\"preload\" referrerpolicy=\"origin\" />`;\n    preload.setAttribute('href', url);\n    // Do not set 'as' attribute to correct value for now, for 2 reasons\n    // - document value is not yet supported and dropped\n    // - script is blocked due to CSP.\n    // Due to spec change we now have to also preload with the \"as\"\n    // being set to `fetch` when it would previously would be empty.\n    // See https://github.com/w3c/preload/issues/80\n    // for details.\n    if (this.features_.onlyValidAs) {\n      preload.as = 'fetch';\n    } else {\n      preload.as = '';\n    }\n    this.head_.appendChild(preload);\n    // As opposed to preconnect we do not clean this tag up, because there is\n    // no expectation as to it having an immediate effect.\n  }\n\n  /**\n   * Skips over non HTTP/HTTPS URL.\n   * @param {string} url\n   * @return {boolean}\n   */\n  isInterestingUrl_(url) {\n    if (startsWith(url, 'https:') || startsWith(url, 'http:')) {\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Safari does not support preconnecting, but due to its significant\n   * performance benefits we implement this crude polyfill.\n   *\n   * We make an image connection to a \"well-known\" file on the origin adding\n   * a random query string to bust the cache (no caching because we do want to\n   * actually open the connection).\n   *\n   * This should get us an open SSL connection to these hosts and significantly\n   * speed up the next connections.\n   *\n   * The actual URL is expected to 404. If you see errors for\n   * amp_preconnect_polyfill in your DevTools console or server log:\n   * This is expected and fine to leave as is. Its fine to send a non 404\n   * response, but please make it small :)\n   *\n   * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} origin\n   * @private\n   */\n  preconnectPolyfill_(ampdoc, origin) {\n    // Unfortunately there is no reliable way to feature detect whether\n    // preconnect is supported, so we do this only in Safari, which is\n    // the most important browser without support for it.\n    if (\n      this.features_.preconnect ||\n      !(this.platform_.isSafari() || this.platform_.isIos())\n    ) {\n      return;\n    }\n\n    // Don't attempt to preconnect for ACTIVE_CONNECTION_TIMEOUT_MS since\n    // we effectively create an active connection.\n    // TODO(@cramforce): Confirm actual http2 timeout in Safari.\n    const now = Date.now();\n    this.origins_[origin] = now + ACTIVE_CONNECTION_TIMEOUT_MS;\n    // Make the URL change whenever we want to make a new request,\n    // but make it stay stable in between. While a given page\n    // would not actually make a new request, another page might\n    // and with this it has the same URL. If (and that is a big if)\n    // the server responds with a cacheable response, this reduces\n    // requests we make. More importantly, though, it reduces URL\n    // entropy as seen by servers and thus allows reverse proxies\n    // (read CDNs) to respond more efficiently.\n    const cacheBust = now - (now % ACTIVE_CONNECTION_TIMEOUT_MS);\n    const url =\n      origin +\n      '/robots.txt?_AMP_safari_preconnect_polyfill_cachebust=' +\n      cacheBust;\n    const xhr = new XMLHttpRequest();\n    xhr.open('HEAD', url, true);\n    // We only support credentialed preconnect for now.\n    xhr.withCredentials = true;\n\n    xhr.send();\n  }\n}\n\nexport class Preconnect {\n  /**\n   * @param {!PreconnectService} preconnectService\n   * @param {!Element} element\n   */\n  constructor(preconnectService, element) {\n    /** @const @private {!PreconnectService} */\n    this.preconnectService_ = preconnectService;\n\n    /** @const @private {!Element} */\n    this.element_ = element;\n\n    /** @private {?./service/ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = null;\n  }\n\n  /**\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   * @private\n   */\n  getAmpdoc_() {\n    if (!this.ampdoc_) {\n      this.ampdoc_ = Services.ampdoc(this.element_);\n    }\n    return this.ampdoc_;\n  }\n\n  /**\n   * Preconnects to a URL. Always also does a dns-prefetch because\n   * browser support for that is better.\n   * @param {string} url\n   * @param {boolean=} opt_alsoConnecting Set this flag if you also just\n   *    did or are about to connect to this host. This is for the case\n   *    where preconnect is issued immediate before or after actual connect\n   *    and preconnect is used to flatten a deep HTTP request chain.\n   *    E.g. when you preconnect to a host that an embed will connect to\n   *    when it is more fully rendered, you already know that the connection\n   *    will be used very soon.\n   */\n  url(url, opt_alsoConnecting) {\n    this.preconnectService_.url(this.getAmpdoc_(), url, opt_alsoConnecting);\n  }\n\n  /**\n   * Asks the browser to preload a URL. Always also does a preconnect\n   * because browser support for that is better.\n   *\n   * @param {string} url\n   * @param {string=} opt_preloadAs\n   */\n  preload(url, opt_preloadAs) {\n    this.preconnectService_.preload(this.getAmpdoc_(), url, opt_preloadAs);\n  }\n}\n\n/**\n * @param {!Element} element\n * @return {!Preconnect}\n */\nexport function preconnectForElement(element) {\n  const serviceHolder = toWin(element.ownerDocument.defaultView);\n  registerServiceBuilder(serviceHolder, 'preconnect', PreconnectService);\n  const preconnectService = getService(serviceHolder, 'preconnect');\n  return new Preconnect(preconnectService, element);\n}\n\n/**\n * Preconnects to the source URL and canonical domains to make sure\n * outbound navigations are quick. Waits for onload to avoid blocking\n * more high priority loads.\n * @param {!Document} document\n * @return {Promise} When work is done.\n */\nexport function preconnectToOrigin(document) {\n  return whenDocumentComplete(document).then(() => {\n    const element = document.documentElement;\n    const preconnect = preconnectForElement(element);\n    const info = Services.documentInfoForDoc(element);\n    preconnect.url(info.sourceUrl);\n    preconnect.url(info.canonicalUrl);\n  });\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from './services';\nimport {devAssert} from './log';\nimport {getServicePromise} from './service';\n\n/**\n * A map of services that delay rendering. The key is the name of the service\n * and the value is a DOM query which is used to check if the service is needed\n * in the current document.\n * Do not add a service unless absolutely necessary.\n *\n * \\   \\  /  \\  /   / /   \\     |   _  \\     |  \\ |  | |  | |  \\ |  |  / _____|\n *  \\   \\/    \\/   / /  ^  \\    |  |_)  |    |   \\|  | |  | |   \\|  | |  |  __\n *   \\            / /  /_\\  \\   |      /     |  . `  | |  | |  . `  | |  | |_ |\n *    \\    /\\    / /  _____  \\  |  |\\  \\----.|  |\\   | |  | |  |\\   | |  |__| |\n *     \\__/  \\__/ /__/     \\__\\ | _| `._____||__| \\__| |__| |__| \\__|  \\______|\n *\n * The equivalent of this list is used for server-side rendering (SSR) and any\n * changes made to it must be made in coordination with caches that implement\n * SSR. For more information on SSR see bit.ly/amp-ssr.\n *\n * @const {!Object<string, string>}\n */\nconst SERVICES = {\n  'amp-dynamic-css-classes': '[custom-element=amp-dynamic-css-classes]',\n  'variant': 'amp-experiment',\n  'amp-story-render': 'amp-story[standalone]',\n};\n\n/**\n * Base class for render delaying services.\n * This should be extended to ensure the service\n * is properly handled\n *\n * @interface\n */\nexport class RenderDelayingService {\n  /**\n   * Function to return a promise for when\n   * it is finished delaying render, and is ready.\n   * NOTE: This should simply return Promise.resolve,\n   * if your service does not need to perform any logic\n   * after being registered.\n   * @return {!Promise}\n   */\n  whenReady() {}\n}\n\n/**\n * Maximum milliseconds to wait for all extensions to load before erroring.\n * @const\n */\nconst LOAD_TIMEOUT = 3000;\n\n/**\n * Detects any render delaying services that are required on the page, and\n * returns a promise with a timeout.\n * @param {!Window} win\n * @return {!Promise<!Array<*>>} resolves to an Array that has the same length\n *     as the detected render delaying services\n */\nexport function waitForServices(win) {\n  const promises = includedServices(win).map(serviceId => {\n    const serviceReadyPromise = getServicePromise(win, serviceId).then(\n      service => {\n        if (service && isRenderDelayingService(service)) {\n          return service.whenReady().then(() => {\n            return service;\n          });\n        }\n        return service;\n      }\n    );\n\n    return Services.timerFor(win).timeoutPromise(\n      LOAD_TIMEOUT,\n      serviceReadyPromise,\n      `Render timeout waiting for service ${serviceId} to be ready.`\n    );\n  });\n  return Promise.all(promises);\n}\n\n/**\n * Returns true if the page has a render delaying service.\n * @param {!Window} win\n * @return {boolean}\n */\nexport function hasRenderDelayingServices(win) {\n  return includedServices(win).length > 0;\n}\n\n/**\n * Function to determine if the passed\n * Object is a Render Delaying Service\n * @param {!Object} service\n * @return {boolean}\n */\nexport function isRenderDelayingService(service) {\n  const maybeRenderDelayingService = /** @type {!RenderDelayingService}*/ (service);\n  return typeof maybeRenderDelayingService.whenReady == 'function';\n}\n\n/**\n * Detects which, if any, render-delaying extensions are included on the page.\n * @param {!Window} win\n * @return {!Array<string>}\n */\nexport function includedServices(win) {\n  /** @const {!Document} */\n  const doc = win.document;\n  devAssert(doc.body);\n\n  return Object.keys(SERVICES).filter(service => {\n    return doc.querySelector(SERVICES[service]);\n  });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Registration and getter functions for AMP services.\n *\n * Invariant: Service getters never return null for registered services.\n */\n\nimport {Deferred} from './utils/promise';\nimport {dev, devAssert} from './log';\nimport {isExperimentOn} from './experiments';\nimport {toWin} from './types';\n\n/**\n * Holds info about a service.\n * - obj: Actual service implementation when available.\n * - promise: Promise for the obj.\n * - resolve: Function to resolve the promise with the object.\n * - context: Argument for ctor, either a window or an ampdoc.\n * - ctor: Function that constructs and returns the service.\n * @typedef {{\n *   obj: (?Object),\n *   promise: (?Promise),\n *   resolve: (?function(!Object)),\n *   reject: (?function((*))),\n *   context: (?Window|?./service/ampdoc-impl.AmpDoc),\n *   ctor: (?function(new:Object, !Window)|\n *          ?function(new:Object, !./service/ampdoc-impl.AmpDoc)),\n * }}\n */\nlet ServiceHolderDef;\n\n/**\n * This interface provides a `dispose` method that will be called by\n * runtime when a service needs to be disposed of.\n * @interface\n */\nexport class Disposable {\n  /**\n   * Instructs the service to release any resources it might be holding. Can\n   * be called only once in the lifecycle of a service.\n   */\n  dispose() {}\n}\n\n/**\n * Services must implement this interface to be embeddable in FIEs.\n * @interface\n */\nexport class EmbeddableService {\n  /**\n   * Installs a new instance of the service in the given FIE window.\n   * @param {!Window} unusedEmbedWin\n   * @param {!./service/ampdoc-impl.AmpDoc} unusedAmpDoc\n   */\n  static installInEmbedWindow(unusedEmbedWin, unusedAmpDoc) {}\n}\n\n/**\n * Returns a service with the given id. Assumes that it has been constructed\n * already.\n *\n * @param {!Element|!ShadowRoot} element\n * @param {string} id\n * @return {?Object}\n */\nexport function getExistingServiceForDocInEmbedScope(element, id) {\n  // TODO(#22733): completely remove this method once ampdoc-fie launches.\n  const document = element.ownerDocument;\n  const win = toWin(document.defaultView);\n  const topWin = getTopWindow(win);\n  // First, try to resolve via local embed window (if applicable).\n  const isEmbed = win != topWin;\n  const ampdocFieExperimentOn = isExperimentOn(topWin, 'ampdoc-fie');\n  if (isEmbed && !ampdocFieExperimentOn) {\n    if (isServiceRegistered(win, id)) {\n      return getServiceInternal(win, id);\n    }\n    // Fallback from FIE to parent is intentionally unsupported for safety.\n    return null;\n  } else {\n    // Resolve via the element's ampdoc.\n    return getServiceForDocOrNullInternal(element, id);\n  }\n}\n\n/**\n * Installs a service override on amp-doc level.\n * @param {!Window} embedWin\n * @param {string} id\n * @param {!Object} service The service.\n */\nexport function installServiceInEmbedScope(embedWin, id, service) {\n  const topWin = getTopWindow(embedWin);\n  devAssert(\n    embedWin != topWin,\n    'Service override can only be installed in embed window: %s',\n    id\n  );\n  devAssert(\n    !isServiceRegistered(embedWin, id),\n    'Service override has already been installed: %s',\n    id\n  );\n  const ampdocFieExperimentOn = isExperimentOn(topWin, 'ampdoc-fie');\n  if (ampdocFieExperimentOn) {\n    const ampdoc = getAmpdoc(embedWin.document);\n    registerServiceInternal(\n      getAmpdocServiceHolder(ampdoc),\n      ampdoc,\n      id,\n      () => service,\n      /* override */ true\n    );\n  } else {\n    registerServiceInternal(embedWin, embedWin, id, () => service);\n    getServiceInternal(embedWin, id); // Force service to build.\n  }\n}\n\n/**\n * Registers a service given a class to be used as implementation.\n * @param {!Window} win\n * @param {string} id of the service.\n * @param {function(new:Object, !Window)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilder(win, id, constructor, opt_instantiate) {\n  win = getTopWindow(win);\n  registerServiceInternal(win, win, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(win, id);\n  }\n}\n\n/**\n * Returns a service and registers it given a class to be used as\n * implementation.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id of the service.\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} constructor\n * @param {boolean=} opt_instantiate Whether to immediately create the service\n */\nexport function registerServiceBuilderForDoc(\n  nodeOrDoc,\n  id,\n  constructor,\n  opt_instantiate\n) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  registerServiceInternal(holder, ampdoc, id, constructor);\n  if (opt_instantiate) {\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * Reject a service promise.\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @param {string} id\n * @param {*} error\n */\nexport function rejectServicePromiseForDoc(nodeOrDoc, id, error) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  rejectServicePromiseInternal(holder, id, error);\n}\n\n/**\n * Returns a service for the given id and window (a per-window singleton). Users\n * should typically wrap this as a special purpose function (e.g.\n * `Services.vsyncFor(win)`) for type safety and because the factory should not\n * be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @template T\n * @return {T}\n */\nexport function getService(win, id) {\n  win = getTopWindow(win);\n  return getServiceInternal(win, id);\n}\n\n/**\n * Returns a promise for a service for the given id and window. Also expects an\n * element that has the actual implementation. The promise resolves when the\n * implementation loaded. Users should typically wrap this as a special purpose\n * function (e.g. `Services.vsyncFor(win)`) for type safety and because the\n * factory should not be passed around.\n * @param {!Window} win\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nexport function getServicePromise(win, id) {\n  return getServicePromiseInternal(win, id);\n}\n\n/**\n * Returns a service or null with the given id.\n * @param {!Window} win\n * @param {string} id\n * @return {?Object} The service.\n */\nexport function getExistingServiceOrNull(win, id) {\n  win = getTopWindow(win);\n  if (isServiceRegistered(win, id)) {\n    return getServiceInternal(win, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Like getServicePromise but returns null if the service was never registered.\n * @param {!Window} win\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNull(win, id) {\n  return getServicePromiseOrNullInternal(win, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * Expects service `id` to be registered.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {T}\n * @template T\n */\nexport function getServiceForDoc(elementOrAmpDoc, id) {\n  const ampdoc = getAmpdoc(elementOrAmpDoc);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  return getServiceInternal(holder, id);\n}\n\n/**\n * Returns a service for the given id and ampdoc (a per-ampdoc singleton).\n * If service `id` is not registered, returns null.\n * @param {!Element|!ShadowRoot} element\n * @param {string} id\n * @return {?Object}\n */\nfunction getServiceForDocOrNullInternal(element, id) {\n  const ampdoc = getAmpdoc(element);\n  const holder = getAmpdocServiceHolder(ampdoc);\n  if (isServiceRegistered(holder, id)) {\n    return getServiceInternal(holder, id);\n  } else {\n    return null;\n  }\n}\n\n/**\n * Returns a promise for a service for the given id and ampdoc. Also expects\n * a service that has the actual implementation. The promise resolves when\n * the implementation loaded.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {!Promise<!Object>}\n */\nexport function getServicePromiseForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseInternal(getAmpdocServiceHolder(elementOrAmpDoc), id);\n}\n\n/**\n * Like getServicePromiseForDoc but returns null if the service was never\n * registered for this ampdoc.\n * @param {!Element|!ShadowRoot|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n * @param {string} id\n * @return {?Promise<!Object>}\n */\nexport function getServicePromiseOrNullForDoc(elementOrAmpDoc, id) {\n  return getServicePromiseOrNullInternal(\n    getAmpdocServiceHolder(elementOrAmpDoc),\n    id\n  );\n}\n\n/**\n * Set the parent and top windows on a child window (friendly iframe).\n * @param {!Window} win\n * @param {!Window} parentWin\n */\nexport function setParentWindow(win, parentWin) {\n  win.__AMP_PARENT = parentWin;\n  win.__AMP_TOP = getTopWindow(parentWin);\n}\n\n/**\n * Returns the parent window for a child window (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getParentWindow(win) {\n  return win.__AMP_PARENT || win;\n}\n\n/**\n * Returns the top window where AMP Runtime is installed for a child window\n * (friendly iframe).\n * @param {!Window} win\n * @return {!Window}\n */\nexport function getTopWindow(win) {\n  return win.__AMP_TOP || (win.__AMP_TOP = win);\n}\n\n/**\n * Returns the parent \"friendly\" iframe if the node belongs to a child window.\n * @param {!Node} node\n * @param {!Window=} opt_topWin\n * @return {?HTMLIFrameElement}\n */\nexport function getParentWindowFrameElement(node, opt_topWin) {\n  const childWin = (node.ownerDocument || node).defaultView;\n  const topWin = opt_topWin || getTopWindow(childWin);\n  if (childWin && childWin != topWin && getTopWindow(childWin) == topWin) {\n    try {\n      return /** @type {?HTMLIFrameElement} */ (childWin.frameElement);\n    } catch (e) {\n      // Ignore the error.\n    }\n  }\n  return null;\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc}\n */\nexport function getAmpdoc(nodeOrDoc) {\n  if (nodeOrDoc.nodeType) {\n    const win = toWin(\n      /** @type {!Document} */ (nodeOrDoc.ownerDocument || nodeOrDoc)\n        .defaultView\n    );\n    return getAmpdocService(win).getAmpDoc(/** @type {!Node} */ (nodeOrDoc));\n  }\n  return /** @type {!./service/ampdoc-impl.AmpDoc} */ (nodeOrDoc);\n}\n\n/**\n * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {!./service/ampdoc-impl.AmpDoc|!Window}\n */\nfunction getAmpdocServiceHolder(nodeOrDoc) {\n  const ampdoc = getAmpdoc(nodeOrDoc);\n  return ampdoc.isSingleDoc() ? ampdoc.win : ampdoc;\n}\n\n/**\n * This is essentially a duplicate of `ampdoc.js`, but necessary to avoid\n * circular dependencies.\n * @param {!Window} win\n * @return {!./service/ampdoc-impl.AmpDocService}\n */\nfunction getAmpdocService(win) {\n  return /** @type {!./service/ampdoc-impl.AmpDocService} */ (getService(\n    win,\n    'ampdoc'\n  ));\n}\n\n/**\n * Get service `id` from `holder`. Assumes the service\n * has already been registered.\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {Object}\n * @template T\n */\nfunction getServiceInternal(holder, id) {\n  devAssert(\n    isServiceRegistered(holder, id),\n    `Expected service ${id} to be registered`\n  );\n  const services = getServices(holder);\n  const s = services[id];\n  if (!s.obj) {\n    devAssert(s.ctor, `Service ${id} registered without ctor nor impl.`);\n    devAssert(s.context, `Service ${id} registered without context.`);\n    s.obj = new s.ctor(s.context);\n    devAssert(s.obj, `Service ${id} constructed to null.`);\n    s.ctor = null;\n    s.context = null;\n    // The service may have been requested already, in which case we have a\n    // pending promise we need to fulfill.\n    if (s.resolve) {\n      s.resolve(s.obj);\n    }\n  }\n  return s.obj;\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {!Window|!./service/ampdoc-impl.AmpDoc} context Win or AmpDoc.\n * @param {string} id of the service.\n * @param {?function(new:Object, !Window)|?function(new:Object, !./service/ampdoc-impl.AmpDoc)} ctor Constructor function to new the service. Called with context.\n * @param {boolean=} opt_override\n */\nfunction registerServiceInternal(holder, context, id, ctor, opt_override) {\n  const services = getServices(holder);\n  let s = services[id];\n\n  if (!s) {\n    s = services[id] = {\n      obj: null,\n      promise: null,\n      resolve: null,\n      reject: null,\n      context: null,\n      ctor: null,\n    };\n  }\n\n  if (!opt_override && (s.ctor || s.obj)) {\n    // Service already registered.\n    return;\n  }\n\n  s.ctor = ctor;\n  s.context = context;\n\n  // The service may have been requested already, in which case there is a\n  // pending promise that needs to fulfilled.\n  if (s.resolve) {\n    // getServiceInternal will resolve the promise.\n    getServiceInternal(holder, id);\n  }\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {!Promise<!Object>}\n */\nfunction getServicePromiseInternal(holder, id) {\n  const cached = getServicePromiseOrNullInternal(holder, id);\n  if (cached) {\n    return cached;\n  }\n  // Service is not registered.\n\n  // TODO(@cramforce): Add a check that if the element is eventually registered\n  // that the service is actually provided and this promise resolves.\n  const services = getServices(holder);\n  services[id] = emptyServiceHolderWithPromise();\n  return /** @type {!Promise<!Object>} */ (services[id].promise);\n}\n\n/**\n * @param {!Object} holder\n * @param {string} id of the service.\n * @param {*} error\n */\nfunction rejectServicePromiseInternal(holder, id, error) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.reject) {\n      s.reject(error);\n    }\n    return;\n  }\n\n  services[id] = emptyServiceHolderWithPromise();\n  services[id].reject(error);\n}\n\n/**\n * Returns a promise for service `id` if the service has been registered\n * on `holder`.\n * @param {!Object} holder\n * @param {string} id of the service.\n * @return {?Promise<!Object>}\n */\nfunction getServicePromiseOrNullInternal(holder, id) {\n  const services = getServices(holder);\n  const s = services[id];\n  if (s) {\n    if (s.promise) {\n      return s.promise;\n    } else {\n      // Instantiate service if not already instantiated.\n      getServiceInternal(holder, id);\n      return (s.promise = Promise.resolve(/** @type {!Object} */ (s.obj)));\n    }\n  }\n  return null;\n}\n\n/**\n * Returns the object that holds the services registered in a holder.\n * @param {!Object} holder\n * @return {!Object<string,!ServiceHolderDef>}\n */\nfunction getServices(holder) {\n  let services = holder.__AMP_SERVICES;\n  if (!services) {\n    services = holder.__AMP_SERVICES = {};\n  }\n  return services;\n}\n\n/**\n * Whether the specified service implements `Disposable` interface.\n * @param {!Object} service\n * @return {boolean}\n */\nexport function isDisposable(service) {\n  return typeof service.dispose == 'function';\n}\n\n/**\n * Asserts that the specified service implements `Disposable` interface and\n * typecasts the instance to `Disposable`.\n * @param {!Object} service\n * @return {!Disposable}\n */\nexport function assertDisposable(service) {\n  devAssert(isDisposable(service), 'required to implement Disposable');\n  return /** @type {!Disposable} */ (service);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * ampdoc scope.\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n */\nexport function disposeServicesForDoc(ampdoc) {\n  disposeServicesInternal(ampdoc);\n}\n\n/**\n * Disposes all disposable (implements `Disposable` interface) services in\n * embed scope.\n * @param {!Window} embedWin\n */\nexport function disposeServicesForEmbed(embedWin) {\n  disposeServicesInternal(embedWin);\n}\n\n/**\n * @param {!Object} holder Object holding the service instances.\n */\nfunction disposeServicesInternal(holder) {\n  // TODO(dvoytenko): Consider marking holder as destroyed for later-arriving\n  // service to be canceled automatically.\n  const services = getServices(holder);\n  for (const id in services) {\n    if (!Object.prototype.hasOwnProperty.call(services, id)) {\n      continue;\n    }\n    const serviceHolder = services[id];\n    if (serviceHolder.obj) {\n      disposeServiceInternal(id, serviceHolder.obj);\n    } else if (serviceHolder.promise) {\n      serviceHolder.promise.then(instance =>\n        disposeServiceInternal(id, instance)\n      );\n    }\n  }\n}\n\n/**\n * @param {string} id\n * @param {!Object} service\n */\nfunction disposeServiceInternal(id, service) {\n  if (!isDisposable(service)) {\n    return;\n  }\n  try {\n    assertDisposable(service).dispose();\n  } catch (e) {\n    // Ensure that a failure to dispose a service does not disrupt other\n    // services.\n    dev().error('SERVICE', 'failed to dispose service', id, e);\n  }\n}\n\n/**\n * Adopts an embeddable (implements `EmbeddableService` interface) service\n * in embed scope.\n * @param {!Window} embedWin\n * @param {function(new:Object, !./service/ampdoc-impl.AmpDoc)} serviceClass\n * @suppress {missingProperties}\n * @return {boolean}\n */\nexport function installServiceInEmbedIfEmbeddable(embedWin, serviceClass) {\n  const isEmbeddableService =\n    typeof serviceClass.installInEmbedWindow === 'function';\n  if (!isEmbeddableService) {\n    return false;\n  }\n  const frameElement = dev().assertElement(\n    embedWin.frameElement,\n    'frameElement not found for embed'\n  );\n  const ampdoc = getAmpdoc(frameElement);\n  serviceClass.installInEmbedWindow(embedWin, ampdoc);\n  return true;\n}\n\n/**\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc\n * @param {string} id\n */\nexport function adoptServiceForEmbedDoc(ampdoc, id) {\n  const service = getServiceInternal(\n    getAmpdocServiceHolder(devAssert(ampdoc.getParent())),\n    id\n  );\n  registerServiceInternal(\n    getAmpdocServiceHolder(ampdoc),\n    ampdoc,\n    id,\n    () => service\n  );\n}\n\n/**\n * Resets a single service, so it gets recreated on next getService invocation.\n * @param {!Object} holder\n * @param {string} id of the service.\n */\nexport function resetServiceForTesting(holder, id) {\n  if (holder.__AMP_SERVICES) {\n    holder.__AMP_SERVICES[id] = null;\n  }\n}\n\n/**\n * @param {!Object} holder Object holding the service instance.\n * @param {string} id of the service.\n * @return {boolean}\n */\nfunction isServiceRegistered(holder, id) {\n  const service = holder.__AMP_SERVICES && holder.__AMP_SERVICES[id];\n  // All registered services must have an implementation or a constructor.\n  return !!(service && (service.ctor || service.obj));\n}\n\n/** @return {!ServiceHolderDef} */\nfunction emptyServiceHolderWithPromise() {\n  const deferred = new Deferred();\n  const {promise, resolve, reject} = deferred;\n  promise.catch(() => {}); // avoid uncaught exception when service gets rejected\n  return {\n    obj: null,\n    promise,\n    resolve,\n    reject,\n    context: null,\n    ctor: null,\n  };\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ActionTrust,\n  DEFAULT_ACTION,\n  RAW_OBJECT_ARGS_KEY,\n} from '../action-constants';\nimport {Keys} from '../utils/key-codes';\nimport {Services} from '../services';\nimport {debounce, throttle} from '../utils/rate-limit';\nimport {dev, devAssert, user, userAssert} from '../log';\nimport {dict, hasOwn, map} from '../utils/object';\nimport {getDetail} from '../event-helper';\nimport {getMode} from '../mode';\nimport {getValueForExpr} from '../json';\nimport {\n  installServiceInEmbedScope,\n  registerServiceBuilderForDoc,\n} from '../service';\nimport {isArray, isFiniteNumber, toWin} from '../types';\nimport {isEnabled} from '../dom';\nimport {reportError} from '../error';\n\n/** @const {string} */\nconst TAG_ = 'Action';\n\n/** @const {string} */\nconst ACTION_MAP_ = '__AMP_ACTION_MAP__' + Math.random();\n\n/** @const {string} */\nconst ACTION_QUEUE_ = '__AMP_ACTION_QUEUE__';\n\n/** @const {string} */\nconst ACTION_HANDLER_ = '__AMP_ACTION_HANDLER__';\n\n/** @const {number} */\nconst DEFAULT_DEBOUNCE_WAIT = 300; // ms\n\n/** @const {number} */\nconst DEFAULT_THROTTLE_INTERVAL = 100; // ms\n\n/** @const {!Object<string,!Array<string>>} */\nconst NON_AMP_ELEMENTS_ACTIONS_ = {\n  'form': ['submit', 'clear'],\n};\n\n/**\n * Interactable widgets which should trigger tap events when the user clicks\n * or activates via the keyboard. Not all are here, e.g. progressbar, tabpanel,\n * since they are text inputs, readonly, or composite widgets that shouldn't\n * need to trigger tap events from spacebar or enter on their own.\n * See https://www.w3.org/TR/wai-aria-1.1/#widget_roles\n * @const {!Object<boolean>}\n */\nexport const TAPPABLE_ARIA_ROLES = {\n  'button': true,\n  'checkbox': true,\n  'link': true,\n  'listbox': true,\n  'menuitem': true,\n  'menuitemcheckbox': true,\n  'menuitemradio': true,\n  'option': true,\n  'radio': true,\n  'scrollbar': true,\n  'slider': true,\n  'spinbutton': true,\n  'switch': true,\n  'tab': true,\n  'treeitem': true,\n};\n\n/**\n * An expression arg value, e.g. `foo.bar` in `e:t.m(arg=foo.bar)`.\n * @typedef {{expression: string}}\n */\nlet ActionInfoArgExpressionDef;\n\n/**\n * An arg value.\n * @typedef {(boolean|number|string|ActionInfoArgExpressionDef)}\n */\nlet ActionInfoArgValueDef;\n\n/**\n * Map of arg names to their values, e.g. {arg: 123} in `e:t.m(arg=123)`.\n * @typedef {Object<string, ActionInfoArgValueDef>}\n */\nlet ActionInfoArgsDef;\n\n/**\n * @typedef {{\n *   event: string,\n *   target: string,\n *   method: string,\n *   args: ?ActionInfoArgsDef,\n *   str: string\n * }}\n */\nexport let ActionInfoDef;\n\n/**\n * Function called when an action is invoked.\n *\n * Optionally, takes this action's position within all actions triggered by\n * the same event, as well as said action array, as params.\n *\n * If the action is chainable, returns a Promise which resolves when the\n * action is complete. Otherwise, returns null.\n *\n * @typedef {function(!ActionInvocation, number=, !Array<!ActionInfoDef>=):?Promise}\n */\nlet ActionHandlerDef;\n\n/**\n * @typedef {Event|DeferredEvent}\n */\nexport let ActionEventDef;\n\n/**\n * The structure that contains all details of the action method invocation.\n * @struct @const @package For type.\n */\nexport class ActionInvocation {\n  /**\n   * For example:\n   *\n   *   <div id=\"div\" on=\"tap:myForm.submit(foo=bar)\">\n   *     <button id=\"btn\">Submit</button>\n   *   </div>\n   *\n   * `node` is #myForm.\n   * `method` is \"submit\".\n   * `args` is {'foo': 'bar'}.\n   * `source` is #btn.\n   * `caller` is #div.\n   * `event` is a \"click\" Event object.\n   * `actionEventType` is \"tap\".\n   * `trust` depends on whether this action was a result of a user gesture.\n   * `tagOrTarget` is \"amp-form\".\n   * `sequenceId` is a pseudo-UUID.\n   *\n   * @param {!Node} node Element whose action is being invoked.\n   * @param {string} method Name of the action being invoked.\n   * @param {?JsonObject} args Named action arguments.\n   * @param {?Element} source Element that generated the `event`.\n   * @param {?Element} caller Element containing the on=\"...\" action handler.\n   * @param {?ActionEventDef} event The event object that triggered this action.\n   * @param {!ActionTrust} trust The trust level of this invocation's trigger.\n   * @param {?string} actionEventType The AMP event name that triggered this.\n   * @param {?string} tagOrTarget The global target name or the element tagName.\n   * @param {number} sequenceId An identifier for this action's sequence (all\n   *   actions triggered by one event e.g. \"tap:form1.submit, form2.submit\").\n   */\n  constructor(\n    node,\n    method,\n    args,\n    source,\n    caller,\n    event,\n    trust,\n    actionEventType = '?',\n    tagOrTarget = null,\n    sequenceId = Math.random()\n  ) {\n    /** @type {!Node} */\n    this.node = node;\n    /** @const {string} */\n    this.method = method;\n    /** @const {?JsonObject} */\n    this.args = args;\n    /** @const {?Element} */\n    this.source = source;\n    /** @const {?Element} */\n    this.caller = caller;\n    /** @const {?ActionEventDef} */\n    this.event = event;\n    /** @const {!ActionTrust} */\n    this.trust = trust;\n    /** @const {?string} */\n    this.actionEventType = actionEventType;\n    /** @const {string} */\n    this.tagOrTarget = tagOrTarget || node.tagName;\n    /** @const {number} */\n    this.sequenceId = sequenceId;\n  }\n\n  /**\n   * Returns true if the trigger event has a trust equal to or greater than\n   * `minimumTrust`. Otherwise, logs a user error and returns false.\n   * @param {ActionTrust} minimumTrust\n   * @return {boolean}\n   */\n  satisfiesTrust(minimumTrust) {\n    // Sanity check.\n    if (!isFiniteNumber(this.trust)) {\n      dev().error(TAG_, `Invalid trust for '${this.method}': ${this.trust}`);\n      return false;\n    }\n    if (this.trust < minimumTrust) {\n      user().error(\n        TAG_,\n        `\"${this.actionEventType}\" is not allowed to invoke ` +\n          `\"${this.tagOrTarget}.${this.method}\".`\n      );\n      return false;\n    }\n    return true;\n  }\n}\n\n/**\n * TODO(dvoytenko): consider splitting this class into two:\n * 1. A class that has a method \"trigger(element, eventType, data)\" and\n *    simply can search target in DOM and trigger methods on it.\n * 2. A class that configures event recognizers and rules and then\n *    simply calls action.trigger.\n * @implements {../service.EmbeddableService}\n */\nexport class ActionService {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_root\n   */\n  constructor(ampdoc, opt_root) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!Document|!ShadowRoot} */\n    this.root_ = opt_root || ampdoc.getRootNode();\n\n    /**\n     * Optional whitelist of actions, e.g.:\n     *\n     *     [{tagOrTarget: 'AMP', method: 'navigateTo'},\n     *      {tagOrTarget: 'AMP-FORM', method: 'submit'},\n     *      {tagOrTarget: '*', method: 'show'}]\n     *\n     * If not null, any actions that are not in the whitelist will be ignored\n     * and throw a user error at invocation time. Note that `tagOrTarget` is\n     * always the canonical uppercased form (same as\n     * `Element.prototype.tagName`). If `tagOrTarget` is the wildcard '*', then\n     * the whitelisted method is allowed on any tag or target.\n     * @private {?Array<{tagOrTarget: string, method: string}>}\n     */\n    this.whitelist_ = this.queryWhitelist_();\n\n    /** @const @private {!Object<string, ActionHandlerDef>} */\n    this.globalTargets_ = map();\n\n    /**\n     * @const @private {!Object<string, {handler: ActionHandlerDef, minTrust: ActionTrust}>}\n     */\n    this.globalMethodHandlers_ = map();\n\n    // Add core events.\n    this.addEvent('tap');\n    this.addEvent('submit');\n    this.addEvent('change');\n    this.addEvent('input-debounced');\n    this.addEvent('input-throttled');\n    this.addEvent('valid');\n    this.addEvent('invalid');\n  }\n\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n  static installInEmbedWindow(embedWin, ampdoc) {\n    installServiceInEmbedScope(\n      embedWin,\n      'action',\n      new ActionService(ampdoc, embedWin.document)\n    );\n  }\n\n  /**\n   * @param {string} name\n   * TODO(dvoytenko): switch to a system where the event recognizers are\n   * registered with Action instead, e.g. \"doubletap\", \"tap to zoom\".\n   */\n  addEvent(name) {\n    if (name == 'tap') {\n      // TODO(dvoytenko): if needed, also configure touch-based tap, e.g. for\n      // fast-click.\n      this.root_.addEventListener('click', event => {\n        if (!event.defaultPrevented) {\n          const element = dev().assertElement(event.target);\n          this.trigger(element, name, event, ActionTrust.HIGH);\n        }\n      });\n      this.root_.addEventListener('keydown', event => {\n        const {key, target} = event;\n        const element = dev().assertElement(target);\n        if (key == Keys.ENTER || key == Keys.SPACE) {\n          const role = element.getAttribute('role');\n          const isTapEventRole =\n            role && hasOwn(TAPPABLE_ARIA_ROLES, role.toLowerCase());\n          if (!event.defaultPrevented && isTapEventRole) {\n            const hasAction = this.trigger(\n              element,\n              name,\n              event,\n              ActionTrust.HIGH\n            );\n            // Only if the element has an action do we prevent the default.\n            // In the absence of an action, e.g. on=\"[event].method\", we do not\n            // want to stop default behavior.\n            if (hasAction) {\n              event.preventDefault();\n            }\n          }\n        }\n      });\n    } else if (name == 'submit') {\n      this.root_.addEventListener(name, event => {\n        const element = dev().assertElement(event.target);\n        // For get requests, the delegating to the viewer needs to happen\n        // before this.\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    } else if (name == 'change') {\n      this.root_.addEventListener(name, event => {\n        const element = dev().assertElement(event.target);\n        this.addTargetPropertiesAsDetail_(event);\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    } else if (name == 'input-debounced') {\n      const debouncedInput = debounce(\n        this.ampdoc.win,\n        event => {\n          const target = dev().assertElement(event.target);\n          this.trigger(\n            target,\n            name,\n            /** @type {!ActionEventDef} */ (event),\n            ActionTrust.HIGH\n          );\n        },\n        DEFAULT_DEBOUNCE_WAIT\n      );\n\n      this.root_.addEventListener('input', event => {\n        // Create a DeferredEvent to avoid races where the browser cleans up\n        // the event object before the async debounced function is called.\n        const deferredEvent = new DeferredEvent(event);\n        this.addTargetPropertiesAsDetail_(deferredEvent);\n        debouncedInput(deferredEvent);\n      });\n    } else if (name == 'input-throttled') {\n      const throttledInput = throttle(\n        this.ampdoc.win,\n        event => {\n          const target = dev().assertElement(event.target);\n          this.trigger(\n            target,\n            name,\n            /** @type {!ActionEventDef} */ (event),\n            ActionTrust.HIGH\n          );\n        },\n        DEFAULT_THROTTLE_INTERVAL\n      );\n\n      this.root_.addEventListener('input', event => {\n        const deferredEvent = new DeferredEvent(event);\n        this.addTargetPropertiesAsDetail_(deferredEvent);\n        throttledInput(deferredEvent);\n      });\n    } else if (name == 'valid' || name == 'invalid') {\n      this.root_.addEventListener(name, event => {\n        const element = dev().assertElement(event.target);\n        this.trigger(element, name, event, ActionTrust.HIGH);\n      });\n    }\n  }\n\n  /**\n   * Registers the action target that will receive all designated actions.\n   * @param {string} name\n   * @param {ActionHandlerDef} handler\n   */\n  addGlobalTarget(name, handler) {\n    this.globalTargets_[name] = handler;\n  }\n\n  /**\n   * Registers the action handler for a common method.\n   * @param {string} name\n   * @param {ActionHandlerDef} handler\n   * @param {ActionTrust} minTrust\n   */\n  addGlobalMethodHandler(name, handler, minTrust = ActionTrust.HIGH) {\n    this.globalMethodHandlers_[name] = {handler, minTrust};\n  }\n\n  /**\n   * Triggers the specified event on the target element.\n   * @param {!Element} target\n   * @param {string} eventType\n   * @param {?ActionEventDef} event\n   * @param {!ActionTrust} trust\n   * @param {?JsonObject=} opt_args\n   * @return {boolean} true if the target has an action.\n   */\n  trigger(target, eventType, event, trust, opt_args) {\n    return this.action_(target, eventType, event, trust, opt_args);\n  }\n\n  /**\n   * Triggers execution of the method on a target/method.\n   * @param {!Element} target\n   * @param {string} method\n   * @param {?JsonObject} args\n   * @param {?Element} source\n   * @param {?Element} caller\n   * @param {?ActionEventDef} event\n   * @param {ActionTrust} trust\n   */\n  execute(target, method, args, source, caller, event, trust) {\n    const invocation = new ActionInvocation(\n      target,\n      method,\n      args,\n      source,\n      caller,\n      event,\n      trust\n    );\n    this.invoke_(invocation);\n  }\n\n  /**\n   * Installs action handler for the specified element. The action handler is\n   * responsible for checking invocation trust.\n   *\n   * For AMP elements, use base-element.registerAction() instead.\n   *\n   * @param {!Element} target\n   * @param {ActionHandlerDef} handler\n   */\n  installActionHandler(target, handler) {\n    // TODO(dvoytenko, #7063): switch back to `target.id` with form proxy.\n    const targetId = target.getAttribute('id') || '';\n\n    devAssert(\n      isAmpTagName(targetId) ||\n        target.tagName.toLowerCase() in NON_AMP_ELEMENTS_ACTIONS_,\n      'AMP or special element expected: %s',\n      target.tagName + '#' + targetId\n    );\n\n    if (target[ACTION_HANDLER_]) {\n      dev().error(TAG_, `Action handler already installed for ${target}`);\n      return;\n    }\n    target[ACTION_HANDLER_] = handler;\n\n    /** @const {Array<!ActionInvocation>} */\n    const queuedInvocations = target[ACTION_QUEUE_];\n    if (isArray(queuedInvocations)) {\n      // Invoke and clear all queued invocations now handler is installed.\n      Services.timerFor(toWin(target.ownerDocument.defaultView)).delay(() => {\n        // TODO(dvoytenko, #1260): dedupe actions.\n        queuedInvocations.forEach(invocation => {\n          try {\n            handler(invocation);\n          } catch (e) {\n            dev().error(TAG_, 'Action execution failed:', invocation, e);\n          }\n        });\n        target[ACTION_QUEUE_].length = 0;\n      }, 1);\n    }\n  }\n\n  /**\n   * Checks if the given element has registered a particular action type.\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasAction(element, actionEventType, opt_stopAt) {\n    return !!this.findAction_(element, actionEventType, opt_stopAt);\n  }\n\n  /**\n   * Checks if the given element's registered action resolves to at least one\n   * existing element by id or a global target (e.g. \"AMP\").\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasResolvableAction(element, actionEventType, opt_stopAt) {\n    const action = this.findAction_(element, actionEventType, opt_stopAt);\n    if (!action) {\n      return false;\n    }\n    return action.actionInfos.some(({target}) => !!this.getActionNode_(target));\n  }\n\n  /**\n   * Checks if the given element's registered action resolves to at least one\n   * existing element by id or a global target (e.g. \"AMP\").\n   * @param {!Element} element\n   * @param {string} actionEventType\n   * @param {!Element} targetElement\n   * @param {!Element=} opt_stopAt\n   * @return {boolean}\n   */\n  hasResolvableActionForTarget(\n    element,\n    actionEventType,\n    targetElement,\n    opt_stopAt\n  ) {\n    const action = this.findAction_(element, actionEventType, opt_stopAt);\n    if (!action) {\n      return false;\n    }\n    return action.actionInfos.some(({target}) => {\n      return this.getActionNode_(target) == targetElement;\n    });\n  }\n\n  /**\n   * For global targets e.g. \"AMP\", returns the document root. Otherwise,\n   * `target` is an element id and the corresponding element is returned.\n   * @param {string} target\n   * @return {?Document|?Element|?ShadowRoot}\n   * @private\n   */\n  getActionNode_(target) {\n    return this.globalTargets_[target]\n      ? this.root_\n      : this.root_.getElementById(target);\n  }\n\n  /**\n   * Sets the action whitelist. Can be used to clear it.\n   * @param {!Array<{tagOrTarget: string, method: string}>} whitelist\n   */\n  setWhitelist(whitelist) {\n    this.whitelist_ = whitelist;\n  }\n\n  /**\n   * Adds an action to the whitelist.\n   * @param {string} tagOrTarget The tag or target to whitelist, e.g.\n   *     'AMP-LIST', '*'.\n   * @param {string} method The method to whitelist, e.g. 'show', 'hide'.\n   */\n  addToWhitelist(tagOrTarget, method) {\n    if (!this.whitelist_) {\n      this.whitelist_ = [];\n    }\n    this.whitelist_.push({tagOrTarget, method});\n  }\n\n  /**\n   * @param {!Element} source\n   * @param {string} actionEventType\n   * @param {?ActionEventDef} event\n   * @param {!ActionTrust} trust\n   * @param {?JsonObject=} opt_args\n   * @return {boolean} True if the element has an action.\n   * @private\n   */\n  action_(source, actionEventType, event, trust, opt_args) {\n    const action = this.findAction_(source, actionEventType);\n    if (!action) {\n      return false;\n    }\n    // Use a pseudo-UUID to uniquely identify this sequence of actions.\n    // A sequence is all actions triggered by a single event.\n    const sequenceId = Math.random();\n    // Invoke actions serially, where each action waits for its predecessor\n    // to complete. `currentPromise` is the i'th promise in the chain.\n    /** @type {?Promise} */\n    let currentPromise = null;\n    action.actionInfos.forEach(({target, args, method, str}) => {\n      const dereferencedArgs = dereferenceArgsVariables(args, event, opt_args);\n      const invokeAction = () => {\n        const node = this.getActionNode_(target);\n        if (!node) {\n          this.error_(`Target \"${target}\" not found for action [${str}].`);\n          return;\n        }\n        const invocation = new ActionInvocation(\n          node,\n          method,\n          dereferencedArgs,\n          source,\n          action.node,\n          event,\n          trust,\n          actionEventType,\n          node.tagName || target,\n          sequenceId\n        );\n        return this.invoke_(invocation);\n      };\n      // Wait for the previous action, if any.\n      currentPromise = currentPromise\n        ? currentPromise.then(invokeAction)\n        : invokeAction();\n    });\n\n    return action.actionInfos.length >= 1;\n  }\n\n  /**\n   * @param {string} message\n   * @param {?Element=} opt_element\n   * @private\n   */\n  error_(message, opt_element) {\n    if (opt_element) {\n      // reportError() supports displaying the element in dev console.\n      const e = user().createError(`[${TAG_}] ${message}`);\n      reportError(e, opt_element);\n      throw e;\n    } else {\n      user().error(TAG_, message);\n    }\n  }\n\n  /**\n   * @param {!ActionInvocation} invocation\n   * @return {?Promise}\n   * @private\n   */\n  invoke_(invocation) {\n    const {method, tagOrTarget} = invocation;\n\n    // Check that this action is whitelisted (if a whitelist is set).\n    if (this.whitelist_) {\n      if (!isActionWhitelisted(invocation, this.whitelist_)) {\n        this.error_(\n          `\"${tagOrTarget}.${method}\" is not whitelisted ${JSON.stringify(\n            this.whitelist_\n          )}.`\n        );\n        return null;\n      }\n    }\n\n    // Handle global targets e.g. \"AMP\".\n    const globalTarget = this.globalTargets_[tagOrTarget];\n    if (globalTarget) {\n      return globalTarget(invocation);\n    }\n\n    // Subsequent handlers assume that invocation target is an Element.\n    const node = dev().assertElement(invocation.node);\n\n    // Handle global actions e.g. \"<any-element-id>.toggle\".\n    const globalMethod = this.globalMethodHandlers_[method];\n    if (globalMethod && invocation.satisfiesTrust(globalMethod.minTrust)) {\n      return globalMethod.handler(invocation);\n    }\n\n    // Handle element-specific actions.\n    const lowerTagName = node.tagName.toLowerCase();\n    if (isAmpTagName(lowerTagName)) {\n      if (node.enqueAction) {\n        node.enqueAction(invocation);\n      } else {\n        this.error_(`Unrecognized AMP element \"${lowerTagName}\".`, node);\n      }\n      return null;\n    }\n\n    // Special non-AMP elements with AMP ID or known supported actions.\n    const nonAmpActions = NON_AMP_ELEMENTS_ACTIONS_[lowerTagName];\n    // TODO(dvoytenko, #7063): switch back to `target.id` with form proxy.\n    const targetId = node.getAttribute('id') || '';\n    if (\n      isAmpTagName(targetId) ||\n      (nonAmpActions && nonAmpActions.indexOf(method) > -1)\n    ) {\n      const handler = node[ACTION_HANDLER_];\n      if (handler) {\n        handler(invocation);\n      } else {\n        node[ACTION_QUEUE_] = node[ACTION_QUEUE_] || [];\n        node[ACTION_QUEUE_].push(invocation);\n      }\n      return null;\n    }\n\n    // Unsupported method.\n    this.error_(\n      `Target (${tagOrTarget}) doesn't support \"${method}\" action.`,\n      invocation.caller\n    );\n\n    return null;\n  }\n\n  /**\n   * @param {!Element} target\n   * @param {string} actionEventType\n   * @param {!Element=} opt_stopAt\n   * @return {?{node: !Element, actionInfos: !Array<!ActionInfoDef>}}\n   */\n  findAction_(target, actionEventType, opt_stopAt) {\n    // Go from target up the DOM tree and find the applicable action.\n    let n = target;\n    while (n) {\n      if (opt_stopAt && n == opt_stopAt) {\n        return null;\n      }\n      const actionInfos = this.matchActionInfos_(n, actionEventType);\n      if (actionInfos && isEnabled(n)) {\n        return {node: n, actionInfos: devAssert(actionInfos)};\n      }\n      n = n.parentElement;\n    }\n    return null;\n  }\n\n  /**\n   * @param {!Element} node\n   * @param {string} actionEventType\n   * @return {?Array<!ActionInfoDef>}\n   */\n  matchActionInfos_(node, actionEventType) {\n    const actionMap = this.getActionMap_(node, actionEventType);\n    if (!actionMap) {\n      return null;\n    }\n    return actionMap[actionEventType] || null;\n  }\n\n  /**\n   * @param {!Element} node\n   * @param {string} actionEventType\n   * @return {?Object<string, !Array<!ActionInfoDef>>}\n   */\n  getActionMap_(node, actionEventType) {\n    let actionMap = node[ACTION_MAP_];\n    if (actionMap === undefined) {\n      actionMap = null;\n      if (node.hasAttribute('on')) {\n        const action = node.getAttribute('on');\n        actionMap = parseActionMap(action, node);\n        node[ACTION_MAP_] = actionMap;\n      } else if (node.hasAttribute('execute')) {\n        const action = node.getAttribute('execute');\n        actionMap = parseActionMap(`${actionEventType}:${action}`, node);\n        node[ACTION_MAP_] = actionMap;\n      }\n    }\n    return actionMap;\n  }\n\n  /**\n   * Resets a node's actions with those defined in the given actions string.\n   * @param {!Element} node\n   * @param {string} actionsStr\n   */\n  setActions(node, actionsStr) {\n    node.setAttribute('on', actionsStr);\n\n    // Clear cache.\n    delete node[ACTION_MAP_];\n  }\n\n  /**\n   * Searches for a whitelist meta tag, parses and returns its contents.\n   *\n   * For example:\n   * <meta name=\"amp-action-whitelist\" content=\"AMP.setState, amp-form.submit\">\n   *\n   * Returns:\n   * [{tagOrTarget: 'AMP', method: 'setState'},\n   *  {tagOrTarget: 'AMP-FORM', method: 'submit'}]\n   *\n   * @return {?Array<{tagOrTarget: string, method: string}>}\n   * @private\n   */\n  queryWhitelist_() {\n    const {head} = this.ampdoc.getRootNode();\n    if (!head) {\n      return null;\n    }\n    const meta = head.querySelector('meta[name=\"amp-action-whitelist\"]');\n    if (!meta) {\n      return null;\n    }\n    return (\n      meta\n        .getAttribute('content')\n        .split(',')\n        // Turn an empty string whitelist into an empty array, otherwise the\n        // parse error in the mapper below would trigger.\n        .filter(action => action)\n        .map(action => {\n          const parts = action.split('.');\n          if (parts.length < 2) {\n            this.error_(`Invalid action whitelist entry: ${action}.`);\n            return;\n          }\n          const tagOrTarget = parts[0].trim();\n          const method = parts[1].trim();\n          return {tagOrTarget, method};\n        })\n        // Filter out undefined elements because of the parse error above.\n        .filter(action => action)\n    );\n  }\n\n  /**\n   * Given a browser 'change' or 'input' event, add `details` property to it\n   * containing whitelisted properties of the target element.\n   * @param {!ActionEventDef} event\n   * @private\n   */\n  addTargetPropertiesAsDetail_(event) {\n    const detail = /** @type {!JsonObject} */ (map());\n    const {target} = event;\n\n    if (target.value !== undefined) {\n      detail['value'] = target.value;\n    }\n\n    // Check tagName instead since `valueAsNumber` isn't supported on IE.\n    if (target.tagName == 'INPUT') {\n      // Probably supported natively but convert anyways for consistency.\n      detail['valueAsNumber'] = Number(target.value);\n    }\n\n    if (target.checked !== undefined) {\n      detail['checked'] = target.checked;\n    }\n\n    if (target.min !== undefined || target.max !== undefined) {\n      detail['min'] = target.min;\n      detail['max'] = target.max;\n    }\n\n    if (Object.keys(detail).length > 0) {\n      event.detail = detail;\n    }\n  }\n}\n\n/**\n * @param {string} lowercaseTagName\n * @return {boolean}\n * @private\n */\nfunction isAmpTagName(lowercaseTagName) {\n  return lowercaseTagName.substring(0, 4) === 'amp-';\n}\n\n/**\n * Returns `true` if the given action invocation is whitelisted in the given\n * whitelist. Default actions' alias, 'activate', are automatically\n * whitelisted if their corresponding registered alias is whitelisted.\n * @param {!ActionInvocation} invocation\n * @param {!Array<{tagOrTarget: string, method: string}>} whitelist\n * @return {boolean}\n * @private\n */\nfunction isActionWhitelisted(invocation, whitelist) {\n  let {method} = invocation;\n  const {node, tagOrTarget} = invocation;\n  // Use alias if default action is invoked.\n  if (\n    method === DEFAULT_ACTION &&\n    typeof node.getDefaultActionAlias == 'function'\n  ) {\n    method = node.getDefaultActionAlias();\n  }\n  const lcMethod = method.toLowerCase();\n  const lcTagOrTarget = tagOrTarget.toLowerCase();\n  return whitelist.some(w => {\n    if (\n      w.tagOrTarget.toLowerCase() === lcTagOrTarget ||\n      w.tagOrTarget === '*'\n    ) {\n      if (w.method.toLowerCase() === lcMethod) {\n        return true;\n      }\n    }\n    return false;\n  });\n}\n\n/**\n * A clone of an event object with its function properties replaced.\n * This is useful e.g. for event objects that need to be passed to an async\n * context, but the browser might have cleaned up the original event object.\n * This clone replaces functions with error throws since they won't behave\n * normally after the original object has been destroyed.\n * @private visible for testing\n */\nexport class DeferredEvent {\n  /**\n   * @param {!Event} event\n   */\n  constructor(event) {\n    /** @type {?Object} */\n    this.detail = null;\n\n    cloneWithoutFunctions(event, this);\n  }\n}\n\n/**\n * Clones an object and replaces its function properties with throws.\n * @param {!T} original\n * @param {!T=} opt_dest\n * @return {!T}\n * @template T\n * @private\n */\nfunction cloneWithoutFunctions(original, opt_dest) {\n  const clone = opt_dest || map();\n  for (const prop in original) {\n    const value = original[prop];\n    if (typeof value === 'function') {\n      clone[prop] = notImplemented;\n    } else {\n      clone[prop] = original[prop];\n    }\n  }\n  return clone;\n}\n\n/** @private */\nfunction notImplemented() {\n  devAssert(null, 'Deferred events cannot access native event functions.');\n}\n\n/**\n * @param {string} action\n * @param {!Element} context\n * @return {?Object<string, !Array<!ActionInfoDef>>}\n * @private Visible for testing only.\n */\nexport function parseActionMap(action, context) {\n  const assertAction = assertActionForParser.bind(null, action, context);\n  const assertToken = assertTokenForParser.bind(null, action, context);\n\n  let actionMap = null;\n\n  const toks = new ParserTokenizer(action);\n  let tok;\n  let peek;\n  do {\n    tok = toks.next();\n    if (\n      tok.type == TokenType.EOF ||\n      (tok.type == TokenType.SEPARATOR && tok.value == ';')\n    ) {\n      // Expected, ignore.\n    } else if (tok.type == TokenType.LITERAL || tok.type == TokenType.ID) {\n      // Format: event:target.method\n\n      // Event: \"event:\"\n      const event = tok.value;\n\n      // Target: \":target.\" separator\n      assertToken(toks.next(), [TokenType.SEPARATOR], ':');\n\n      const actions = [];\n\n      // Handlers for event.\n      do {\n        const target = assertToken(toks.next(), [\n          TokenType.LITERAL,\n          TokenType.ID,\n        ]).value;\n\n        // Method: \".method\". Method is optional.\n        let method = DEFAULT_ACTION;\n        let args = null;\n\n        peek = toks.peek();\n        if (peek.type == TokenType.SEPARATOR && peek.value == '.') {\n          toks.next(); // Skip '.'\n          method =\n            assertToken(toks.next(), [TokenType.LITERAL, TokenType.ID]).value ||\n            method;\n\n          // Optionally, there may be arguments: \"(key = value, key = value)\".\n          peek = toks.peek();\n          if (peek.type == TokenType.SEPARATOR && peek.value == '(') {\n            toks.next(); // Skip '('\n            args = tokenizeMethodArguments(toks, assertToken, assertAction);\n          }\n        }\n\n        actions.push({\n          event,\n          target,\n          method,\n          args:\n            args && getMode().test && Object.freeze\n              ? Object.freeze(args)\n              : args,\n          str: action,\n        });\n\n        peek = toks.peek();\n      } while (\n        peek.type == TokenType.SEPARATOR &&\n        peek.value == ',' &&\n        toks.next()\n      ); // skip \",\" when found\n\n      if (!actionMap) {\n        actionMap = map();\n      }\n\n      actionMap[event] = actions;\n    } else {\n      // Unexpected token.\n      assertAction(false, `; unexpected token [${tok.value || ''}]`);\n    }\n  } while (tok.type != TokenType.EOF);\n\n  return actionMap;\n}\n\n/**\n * Tokenizes and returns method arguments, e.g. target.method(arguments).\n * @param {!ParserTokenizer} toks\n * @param {!Function} assertToken\n * @param {!Function} assertAction\n * @return {?ActionInfoArgsDef}\n * @private\n */\nfunction tokenizeMethodArguments(toks, assertToken, assertAction) {\n  let peek = toks.peek();\n  let tok;\n  let args = null;\n  // Object literal. Format: {...}\n  if (peek.type == TokenType.OBJECT) {\n    // Don't parse object literals. Tokenize as a single expression\n    // fragment and delegate to specific action handler.\n    args = map();\n    const {value} = toks.next();\n    args[RAW_OBJECT_ARGS_KEY] = value;\n    assertToken(toks.next(), [TokenType.SEPARATOR], ')');\n  } else {\n    // Key-value pairs. Format: key = value, ....\n    do {\n      tok = toks.next();\n      const {type, value} = tok;\n      if (type == TokenType.SEPARATOR && (value == ',' || value == ')')) {\n        // Expected: ignore.\n      } else if (type == TokenType.LITERAL || type == TokenType.ID) {\n        // Key: \"key = \"\n        assertToken(toks.next(), [TokenType.SEPARATOR], '=');\n        // Value is either a literal or an expression: \"foo.bar.baz\"\n        tok = assertToken(toks.next(/* convertValue */ true), [\n          TokenType.LITERAL,\n          TokenType.ID,\n        ]);\n        const argValueTokens = [tok];\n        // Expressions have one or more dereferences: \".identifier\"\n        if (tok.type == TokenType.ID) {\n          for (\n            peek = toks.peek();\n            peek.type == TokenType.SEPARATOR && peek.value == '.';\n            peek = toks.peek()\n          ) {\n            toks.next(); // Skip '.'.\n            tok = assertToken(toks.next(false), [TokenType.ID]);\n            argValueTokens.push(tok);\n          }\n        }\n        const argValue = argValueForTokens(argValueTokens);\n        if (!args) {\n          args = map();\n        }\n        args[value] = argValue;\n        peek = toks.peek();\n        assertAction(\n          peek.type == TokenType.SEPARATOR &&\n            (peek.value == ',' || peek.value == ')'),\n          'Expected either [,] or [)]'\n        );\n      } else {\n        // Unexpected token.\n        assertAction(false, `; unexpected token [${tok.value || ''}]`);\n      }\n    } while (!(tok.type == TokenType.SEPARATOR && tok.value == ')'));\n  }\n  return args;\n}\n\n/**\n * @param {Array<!TokenDef>} tokens\n * @return {?ActionInfoArgValueDef}\n * @private\n */\nfunction argValueForTokens(tokens) {\n  if (tokens.length == 0) {\n    return null;\n  } else if (tokens.length == 1) {\n    return /** @type {(boolean|number|string)} */ (tokens[0].value);\n  } else {\n    const values = tokens.map(token => token.value);\n    const expression = values.join('.');\n    return /** @type {ActionInfoArgExpressionDef} */ ({expression});\n  }\n}\n\n/**\n * Dereferences expression args in `args` using values in data.\n * @param {?ActionInfoArgsDef} args\n * @param {?ActionEventDef} event\n * @param {?JsonObject=} opt_args\n * @return {?JsonObject}\n * @private\n */\nexport function dereferenceArgsVariables(args, event, opt_args) {\n  if (!args) {\n    return args;\n  }\n  const data = opt_args || dict({});\n  if (event) {\n    const detail = getDetail(/** @type {!Event} */ (event));\n    if (detail) {\n      data['event'] = detail;\n    }\n  }\n  const applied = map();\n  Object.keys(args).forEach(key => {\n    let value = args[key];\n    // Only JSON expression strings that contain dereferences (e.g. `foo.bar`)\n    // are processed as ActionInfoArgExpressionDef. We also support\n    // dereferencing strings like `foo` iff there is a corresponding key in\n    // `data`. Otherwise, `foo` is treated as a string \"foo\".\n    if (typeof value == 'object' && value.expression) {\n      const expr = /** @type {ActionInfoArgExpressionDef} */ (value).expression;\n      const exprValue = getValueForExpr(data, expr);\n      // If expr can't be found in data, use null instead of undefined.\n      value = exprValue === undefined ? null : exprValue;\n    }\n    if (data[value]) {\n      applied[key] = data[value];\n    } else {\n      applied[key] = value;\n    }\n  });\n  return applied;\n}\n\n/**\n * @param {string} s\n * @param {!Element} context\n * @param {?T} condition\n * @param {string=} opt_message\n * @return {T}\n * @template T\n * @private\n */\nfunction assertActionForParser(s, context, condition, opt_message) {\n  return userAssert(\n    condition,\n    'Invalid action definition in %s: [%s] %s',\n    context,\n    s,\n    opt_message || ''\n  );\n}\n\n/**\n * @param {string} s\n * @param {!Element} context\n * @param {!TokenDef} tok\n * @param {Array<TokenType>} types\n * @param {*=} opt_value\n * @return {!TokenDef}\n * @private\n */\nfunction assertTokenForParser(s, context, tok, types, opt_value) {\n  if (opt_value !== undefined) {\n    assertActionForParser(\n      s,\n      context,\n      types.includes(tok.type) && tok.value == opt_value,\n      `; expected [${opt_value}]`\n    );\n  } else {\n    assertActionForParser(s, context, types.includes(tok.type));\n  }\n  return tok;\n}\n\n/**\n * @enum {number}\n */\nconst TokenType = {\n  INVALID: 0,\n  EOF: 1,\n  SEPARATOR: 2,\n  LITERAL: 3,\n  ID: 4,\n  OBJECT: 5,\n};\n\n/**\n * @typedef {{type: TokenType, value: *}}\n */\nlet TokenDef;\n\n/** @private @const {string} */\nconst WHITESPACE_SET = ' \\t\\n\\r\\f\\v\\u00A0\\u2028\\u2029';\n\n/** @private @const {string} */\nconst SEPARATOR_SET = ';:.()=,|!';\n\n/** @private @const {string} */\nconst STRING_SET = '\"\\'';\n\n/** @private @const {string} */\nconst OBJECT_SET = '{}';\n\n/** @private @const {string} */\nconst SPECIAL_SET = WHITESPACE_SET + SEPARATOR_SET + STRING_SET + OBJECT_SET;\n\n/** @private */\nclass ParserTokenizer {\n  /**\n   * @param {string} str\n   */\n  constructor(str) {\n    /** @private @const {string} */\n    this.str_ = str;\n\n    /** @private {number} */\n    this.index_ = -1;\n  }\n\n  /**\n   * Returns the next token and advances the position.\n   * @param {boolean=} opt_convertValues\n   * @return {!TokenDef}\n   */\n  next(opt_convertValues) {\n    const tok = this.next_(opt_convertValues || false);\n    this.index_ = tok.index;\n    return tok;\n  }\n\n  /**\n   * Returns the next token but keeps the current position.\n   * @param {boolean=} opt_convertValues\n   * @return {!TokenDef}\n   */\n  peek(opt_convertValues) {\n    return this.next_(opt_convertValues || false);\n  }\n\n  /**\n   * @param {boolean} convertValues\n   * @return {!{type: TokenType, value: *, index: number}}\n   */\n  next_(convertValues) {\n    let newIndex = this.index_ + 1;\n    if (newIndex >= this.str_.length) {\n      return {type: TokenType.EOF, index: this.index_};\n    }\n\n    let c = this.str_.charAt(newIndex);\n\n    // Whitespace: standard set.\n    if (WHITESPACE_SET.indexOf(c) != -1) {\n      newIndex++;\n      for (; newIndex < this.str_.length; newIndex++) {\n        if (WHITESPACE_SET.indexOf(this.str_.charAt(newIndex)) == -1) {\n          break;\n        }\n      }\n      if (newIndex >= this.str_.length) {\n        return {type: TokenType.EOF, index: newIndex};\n      }\n      c = this.str_.charAt(newIndex);\n    }\n\n    // A numeric. Notice that it steals the `.` from separators.\n    if (\n      convertValues &&\n      (isNum(c) ||\n        (c == '.' &&\n          newIndex + 1 < this.str_.length &&\n          isNum(this.str_[newIndex + 1])))\n    ) {\n      let hasFraction = c == '.';\n      let end = newIndex + 1;\n      for (; end < this.str_.length; end++) {\n        const c2 = this.str_.charAt(end);\n        if (c2 == '.') {\n          hasFraction = true;\n          continue;\n        }\n        if (!isNum(c2)) {\n          break;\n        }\n      }\n      const s = this.str_.substring(newIndex, end);\n      const value = hasFraction ? parseFloat(s) : parseInt(s, 10);\n      newIndex = end - 1;\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Different separators.\n    if (SEPARATOR_SET.indexOf(c) != -1) {\n      return {type: TokenType.SEPARATOR, value: c, index: newIndex};\n    }\n\n    // String literal.\n    if (STRING_SET.indexOf(c) != -1) {\n      let end = -1;\n      for (let i = newIndex + 1; i < this.str_.length; i++) {\n        if (this.str_.charAt(i) == c) {\n          end = i;\n          break;\n        }\n      }\n      if (end == -1) {\n        return {type: TokenType.INVALID, index: newIndex};\n      }\n      const value = this.str_.substring(newIndex + 1, end);\n      newIndex = end;\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Object literal.\n    if (c == '{') {\n      let numberOfBraces = 1;\n      let end = -1;\n      for (let i = newIndex + 1; i < this.str_.length; i++) {\n        const char = this.str_[i];\n        if (char == '{') {\n          numberOfBraces++;\n        } else if (char == '}') {\n          numberOfBraces--;\n        }\n        if (numberOfBraces <= 0) {\n          end = i;\n          break;\n        }\n      }\n      if (end == -1) {\n        return {type: TokenType.INVALID, index: newIndex};\n      }\n      const value = this.str_.substring(newIndex, end + 1);\n      newIndex = end;\n      return {type: TokenType.OBJECT, value, index: newIndex};\n    }\n\n    // Advance until next special character.\n    let end = newIndex + 1;\n    for (; end < this.str_.length; end++) {\n      if (SPECIAL_SET.indexOf(this.str_.charAt(end)) != -1) {\n        break;\n      }\n    }\n    const s = this.str_.substring(newIndex, end);\n    newIndex = end - 1;\n\n    // Boolean literal.\n    if (convertValues && (s == 'true' || s == 'false')) {\n      const value = s == 'true';\n      return {type: TokenType.LITERAL, value, index: newIndex};\n    }\n\n    // Identifier.\n    if (!isNum(s.charAt(0))) {\n      return {type: TokenType.ID, value: s, index: newIndex};\n    }\n\n    // Key.\n    return {type: TokenType.LITERAL, value: s, index: newIndex};\n  }\n}\n\n/**\n * Tests whether a chacter is a number.\n * @param {string} c\n * @return {boolean}\n */\nfunction isNum(c) {\n  return c >= '0' && c <= '9';\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installActionServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'action',\n    ActionService,\n    /* opt_instantiate */ true\n  );\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Xhr} from './xhr-impl';\nimport {getService, registerServiceBuilder} from '../service';\nimport {map} from '../utils/object';\nimport {removeFragment} from '../url';\n\n/**\n * A wrapper around the Xhr service which batches the result of GET requests\n *\n * @package Visible for type.\n * @visibleForTesting\n */\nexport class BatchedXhr extends Xhr {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    super(win);\n\n    /** @const {!Object<!Promise<!Response>>} */\n    this.fetchPromises_ = map();\n  }\n\n  /**\n   * Fetch and batch the requests if possible.\n   *\n   * @param {string} input URL\n   * @param {?FetchInitDef=} opt_init Fetch options object.\n   * @return {!Promise<!Response>}\n   * @override\n   */\n  fetch(input, opt_init) {\n    const accept =\n      (opt_init && opt_init.headers && opt_init.headers['Accept']) || '';\n    const isBatchable =\n      !opt_init || !opt_init.method || opt_init.method === 'GET';\n    const key = this.getMapKey_(input, accept);\n    const isBatched = !!this.fetchPromises_[key];\n\n    if (isBatchable && isBatched) {\n      return this.fetchPromises_[key].then(response => response.clone());\n    }\n\n    const fetchPromise = super.fetch(input, opt_init);\n\n    if (isBatchable) {\n      this.fetchPromises_[key] = fetchPromise.then(\n        response => {\n          delete this.fetchPromises_[key];\n          return response.clone();\n        },\n        err => {\n          delete this.fetchPromises_[key];\n          throw err;\n        }\n      );\n    }\n\n    return fetchPromise;\n  }\n\n  /**\n   * Creates a map key for a fetch.\n   *\n   * @param {string} input URL\n   * @param {string} responseType\n   * @return {string}\n   * @private\n   */\n  getMapKey_(input, responseType) {\n    return removeFragment(input) + responseType;\n  }\n}\n\n/**\n * @param {!Window} window\n * @return {!BatchedXhr}\n */\nexport function batchedXhrServiceForTesting(window) {\n  installBatchedXhrService(window);\n  return getService(window, 'batched-xhr');\n}\n\n/**\n * @param {!Window} window\n */\nexport function installBatchedXhrService(window) {\n  registerServiceBuilder(window, 'batched-xhr', BatchedXhr);\n}\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {dev} from '../log';\nimport {dict} from '../utils/object';\nimport {getSourceOrigin} from '../url';\n\n/**\n * The Client ID service key.\n * @const @private {string}\n */\nconst SERVICE_KEY_ = 'AIzaSyDKtqGxnoeIqVM33Uf7hRSa3GJxuzR7mLc';\n\n/**\n * Tag for debug logging.\n * @const @private {string}\n */\nconst TAG_ = 'CacheCidApi';\n\n/**\n * The URL for the cache-served CID API.\n * @const @private {string}\n */\nconst CACHE_API_URL = 'https://ampcid.google.com/v1/cache:getClientId?key=';\n\n/**\n * The XHR timeout in milliseconds for requests to the CID API.\n * @const @private {number}\n */\nconst TIMEOUT_ = 30000;\n\n/**\n * Exposes CID API for cache-served pages without a viewer.\n */\nexport class CacheCidApi {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  constructor(ampdoc) {\n    /** @private {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private {!./viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(this.ampdoc_);\n\n    /** @private {?Promise<?string>} */\n    this.publisherCidPromise_ = null;\n\n    /** @private {!./timer-impl.Timer} */\n    this.timer_ = Services.timerFor(this.ampdoc_.win);\n  }\n\n  /**\n   * Returns true if the page is embedded in CCT and is served by a proxy.\n   * @return {boolean}\n   */\n  isSupported() {\n    return this.viewer_.isCctEmbedded() && this.viewer_.isProxyOrigin();\n  }\n\n  /**\n   * Returns scoped CID retrieved from the Viewer.\n   * @param {string} scope\n   * @return {!Promise<?string>}\n   */\n  getScopedCid(scope) {\n    if (!this.viewer_.isCctEmbedded()) {\n      return /** @type {!Promise<?string>} */ (Promise.resolve(null));\n    }\n\n    if (!this.publisherCidPromise_) {\n      const url = CACHE_API_URL + SERVICE_KEY_;\n      this.publisherCidPromise_ = this.fetchCid_(url);\n    }\n\n    return this.publisherCidPromise_.then(publisherCid => {\n      return publisherCid ? this.scopeCid_(publisherCid, scope) : null;\n    });\n  }\n\n  /**\n   * Returns scoped CID retrieved from the Viewer.\n   * @param {string} url\n   * @param {boolean=} useAlternate\n   * @return {!Promise<?string>}\n   */\n  fetchCid_(url, useAlternate = true) {\n    const payload = dict({\n      'publisherOrigin': getSourceOrigin(this.ampdoc_.win.location),\n    });\n\n    // Make the XHR request to the cache endpoint.\n    const timeoutMessage = 'fetchCidTimeout';\n    return this.timer_\n      .timeoutPromise(\n        TIMEOUT_,\n        Services.xhrFor(this.ampdoc_.win).fetchJson(url, {\n          method: 'POST',\n          ampCors: false,\n          credentials: 'include',\n          mode: 'cors',\n          body: payload,\n        }),\n        timeoutMessage\n      )\n      .then(res => {\n        return res.json().then(response => {\n          if (response['optOut']) {\n            return null;\n          }\n          const cid = response['publisherClientId'];\n          if (!cid && useAlternate && response['alternateUrl']) {\n            // If an alternate url is provided, try again with the alternate url\n            // The client is still responsible for appending API keys to the URL.\n            const alt = `${response['alternateUrl']}?key=${SERVICE_KEY_}`;\n            return this.fetchCid_(dev().assertString(alt), false);\n          }\n          return cid;\n        });\n      })\n      .catch(e => {\n        if (e && e.response) {\n          e.response.json().then(res => {\n            dev().error(TAG_, JSON.stringify(res));\n          });\n        } else {\n          const isTimeout = e && e.message == timeoutMessage;\n          if (isTimeout) {\n            dev().expectedError(TAG_, e);\n          } else {\n            dev().error(TAG_, e);\n          }\n        }\n        return null;\n      });\n  }\n\n  /**\n   * Returns scoped CID extracted from the fetched publisherCid.\n   * @param {string} publisherCid\n   * @param {string} scope\n   * @return {!Promise<string>}\n   */\n  scopeCid_(publisherCid, scope) {\n    const text = publisherCid + ';' + scope;\n    return Services.cryptoFor(this.ampdoc_.win)\n      .sha384Base64(text)\n      .then(enc => {\n        return 'amp-' + enc;\n      });\n  }\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {WindowInterface} from '../window-interface';\nimport {dev} from '../log';\nimport {dict} from '../utils/object';\nimport {getCookie, setCookie} from '../cookies';\nimport {isProxyOrigin, parseUrlDeprecated} from '../url';\n\nconst GOOGLE_API_URL =\n  'https://ampcid.google.com/v1/publisher:getClientId?key=';\n\nconst TAG = 'GoogleCidApi';\nconst AMP_TOKEN = 'AMP_TOKEN';\n\n/** @enum {string} */\nexport const TokenStatus = {\n  RETRIEVING: '$RETRIEVING',\n  OPT_OUT: '$OPT_OUT',\n  NOT_FOUND: '$NOT_FOUND',\n  ERROR: '$ERROR',\n};\n\nconst TIMEOUT = 30000;\nconst HOUR = 60 * 60 * 1000;\nconst DAY = 24 * HOUR;\nconst YEAR = 365 * DAY;\n\n/**\n * Client impl for Google CID API\n */\nexport class GoogleCidApi {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  constructor(ampdoc) {\n    /**\n     * @private {!Window}\n     */\n    this.win_ = ampdoc.win;\n    /**\n     * @private {!./timer-impl.Timer}\n     */\n    this.timer_ = Services.timerFor(this.win_);\n\n    /**\n     * @private {!Object<string, !Promise<?string>>}\n     */\n    this.cidPromise_ = {};\n\n    const {canonicalUrl} = Services.documentInfoForDoc(ampdoc);\n\n    /** @private {?string} */\n    this.canonicalOrigin_ = canonicalUrl\n      ? parseUrlDeprecated(canonicalUrl).origin\n      : null;\n  }\n\n  /**\n   * @param {string} apiKey\n   * @param {string} scope\n   * @return {!Promise<?string>}\n   */\n  getScopedCid(apiKey, scope) {\n    if (this.cidPromise_[scope]) {\n      return this.cidPromise_[scope];\n    }\n    let token;\n    // Block the request if a previous request is on flight\n    // Poll every 200ms. Longer interval means longer latency for the 2nd CID.\n    return (this.cidPromise_[scope] = this.timer_\n      .poll(200, () => {\n        token = getCookie(this.win_, AMP_TOKEN);\n        return token !== TokenStatus.RETRIEVING;\n      })\n      .then(() => {\n        if (token === TokenStatus.OPT_OUT) {\n          return TokenStatus.OPT_OUT;\n        }\n        // If the page referrer is proxy origin, we force to use API even the\n        // token indicates a previous fetch returned nothing\n        const forceFetch =\n          token === TokenStatus.NOT_FOUND && this.isReferrerProxyOrigin_();\n\n        // Token is in a special state, fallback to existing cookie\n        if (!forceFetch && this.isStatusToken_(token)) {\n          return null;\n        }\n\n        if (!token || this.isStatusToken_(token)) {\n          this.persistToken_(TokenStatus.RETRIEVING, TIMEOUT);\n        }\n\n        const url = GOOGLE_API_URL + apiKey;\n        return this.fetchCid_(dev().assertString(url), scope, token)\n          .then(response => {\n            const cid = this.handleResponse_(response);\n            if (!cid && response['alternateUrl']) {\n              // If an alternate url is provided, try again with the alternate\n              // url The client is still responsible for appending API keys to\n              // the URL.\n              const altUrl = `${response['alternateUrl']}?key=${apiKey}`;\n              return this.fetchCid_(\n                dev().assertString(altUrl),\n                scope,\n                token\n              ).then(this.handleResponse_.bind(this));\n            }\n            return cid;\n          })\n          .catch(e => {\n            this.persistToken_(TokenStatus.ERROR, TIMEOUT);\n            if (e && e.response) {\n              e.response.json().then(res => {\n                dev().error(TAG, JSON.stringify(res));\n              });\n            } else {\n              dev().error(TAG, e);\n            }\n            return null;\n          });\n      }));\n  }\n\n  /**\n   * @param {string} url\n   * @param {string} scope\n   * @param {?string} token\n   * @return {!Promise<!JsonObject>}\n   */\n  fetchCid_(url, scope, token) {\n    const payload = dict({\n      'originScope': scope,\n      'canonicalOrigin': this.canonicalOrigin_,\n    });\n    if (token) {\n      payload['securityToken'] = token;\n    }\n    return this.timer_.timeoutPromise(\n      TIMEOUT,\n      Services.xhrFor(this.win_)\n        .fetchJson(url, {\n          method: 'POST',\n          ampCors: false,\n          credentials: 'include',\n          mode: 'cors',\n          body: payload,\n        })\n        .then(res => res.json())\n    );\n  }\n\n  /**\n   * @param {!JsonObject} res\n   * @return {?string}\n   */\n  handleResponse_(res) {\n    if (res['optOut']) {\n      this.persistToken_(TokenStatus.OPT_OUT, YEAR);\n      return TokenStatus.OPT_OUT;\n    }\n    if (res['clientId']) {\n      this.persistToken_(res['securityToken'], YEAR);\n      return res['clientId'];\n    }\n    if (res['alternateUrl']) {\n      return null;\n    }\n    this.persistToken_(TokenStatus.NOT_FOUND, HOUR);\n    return null;\n  }\n\n  /**\n   * @param {string|undefined} tokenValue\n   * @param {number} expires\n   */\n  persistToken_(tokenValue, expires) {\n    if (tokenValue) {\n      setCookie(this.win_, AMP_TOKEN, tokenValue, this.expiresIn_(expires), {\n        highestAvailableDomain: true,\n      });\n    }\n  }\n\n  /**\n   * @param {number} time\n   * @return {number}\n   */\n  expiresIn_(time) {\n    return this.win_.Date.now() + time;\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isReferrerProxyOrigin_() {\n    return isProxyOrigin(WindowInterface.getDocumentReferrer(this.win_));\n  }\n\n  /**\n   * @param {?string} token\n   * @return {boolean}\n   */\n  isStatusToken_(token) {\n    return /** @type {boolean} */ (token && token[0] === '$');\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Provides per AMP document source origin and use case\n * persistent client identifiers for use in analytics and similar use\n * cases.\n *\n * For details, see https://goo.gl/Mwaacs\n */\n\nimport {GoogleCidApi, TokenStatus} from './cid-api';\nimport {dev, rethrowAsync, user, userAssert} from '../log';\nimport {getCookie, setCookie} from '../cookies';\nimport {getServiceForDoc, registerServiceBuilderForDoc} from '../service';\nimport {getSourceOrigin, isProxyOrigin, parseUrlDeprecated} from '../url';\nimport {parseJson, tryParseJson} from '../json';\n\nimport {CacheCidApi} from './cache-cid-api';\nimport {Services} from '../services';\nimport {ViewerCidApi} from './viewer-cid-api';\nimport {base64UrlEncodeFromBytes} from '../utils/base64';\nimport {dict} from '../utils/object';\nimport {getCryptoRandomBytesArray} from '../utils/bytes';\nimport {isIframed} from '../dom';\nimport {tryResolve} from '../utils/promise';\n\nconst ONE_DAY_MILLIS = 24 * 3600 * 1000;\n\n/**\n * We ignore base cids that are older than (roughly) one year.\n */\nexport const BASE_CID_MAX_AGE_MILLIS = 365 * ONE_DAY_MILLIS;\n\nconst SCOPE_NAME_VALIDATOR = /^[a-zA-Z0-9-_.]+$/;\n\nconst CID_OPTOUT_STORAGE_KEY = 'amp-cid-optout';\n\nconst CID_OPTOUT_VIEWER_MESSAGE = 'cidOptOut';\n\n/**\n * Tag for debug logging.\n * @const @private {string}\n */\nconst TAG_ = 'CID';\n\n/**\n * The name of the Google CID API as it appears in the meta tag to opt-in.\n * @const @private {string}\n */\nconst GOOGLE_CID_API_META_NAME = 'amp-google-client-id-api';\n\n/**\n * The mapping from analytics providers to CID scopes.\n * @const @private {Object<string, string>}\n */\nconst CID_API_SCOPE_WHITELIST = {\n  'googleanalytics': 'AMP_ECID_GOOGLE',\n};\n\n/**\n * The mapping from analytics providers to their CID API service keys.\n * @const @private {Object<string, string>}\n */\nconst API_KEYS = {\n  'googleanalytics': 'AIzaSyA65lEHUEizIsNtlbNo-l2K18dT680nsaM',\n};\n\n/**\n * A base cid string value and the time it was last read / stored.\n * @typedef {{time: time, cid: string}}\n */\nlet BaseCidInfoDef;\n\n/**\n * The \"get CID\" parameters.\n * - createCookieIfNotPresent: Whether CID is allowed to create a cookie when.\n *   Default value is `false`.\n * @typedef {{\n *   scope: string,\n *   createCookieIfNotPresent: (boolean|undefined),\n *   cookieName: (string|undefined),\n * }}\n */\nlet GetCidDef;\n\n/**\n * @interface\n */\nexport class CidDef {\n  /**\n   * @param {!GetCidDef} unusedGetCidStruct an object provides CID scope name for\n   *     proxy case and cookie name for non-proxy case.\n   * @param {!Promise} unusedConsent Promise for when the user has given consent\n   *     (if deemed necessary by the publisher) for use of the client\n   *     identifier.\n   * @param {!Promise=} opt_persistenceConsent Dedicated promise for when\n   *     it is OK to persist a new tracking identifier. This could be\n   *     supplied ONLY by the code that supplies the actual consent\n   *     cookie.\n   *     If this is given, the consent param should be a resolved promise\n   *     because this call should be only made in order to get consent.\n   *     The consent promise passed to other calls should then itself\n   *     depend on the opt_persistenceConsent promise (and the actual\n   *     consent, of course).\n   * @return {!Promise<?string>} A client identifier that should be used\n   *      within the current source origin and externalCidScope. Might be\n   *      null if user has opted out of cid or no identifier was found\n   *      or it could be made.\n   *      This promise may take a long time to resolve if consent isn't\n   *      given.\n   */\n  get(unusedGetCidStruct, unusedConsent, opt_persistenceConsent) {}\n\n  /**\n   * User will be opted out of Cid issuance for all scopes.\n   * When opted-out Cid service will reject all `get` requests.\n   *\n   * @return {!Promise}\n   */\n  optOut() {}\n}\n\n/**\n * @implements {CidDef}\n */\nclass Cid {\n  /** @param {!./ampdoc-impl.AmpDoc} ampdoc */\n  constructor(ampdoc) {\n    /** @const */\n    this.ampdoc = ampdoc;\n\n    /**\n     * Cached base cid once read from storage to avoid repeated\n     * reads.\n     * @private {?Promise<string>}\n     * @restricted\n     */\n    this.baseCid_ = null;\n\n    /**\n     * Cache to store external cids. Scope is used as the key and cookie value\n     * is the value.\n     * @private {!Object<string, !Promise<string>>}\n     * @restricted\n     */\n    this.externalCidCache_ = Object.create(null);\n\n    /**\n     * @private @const {!CacheCidApi}\n     */\n    this.cacheCidApi_ = new CacheCidApi(ampdoc);\n\n    /**\n     * @private {!ViewerCidApi}\n     */\n    this.viewerCidApi_ = new ViewerCidApi(ampdoc);\n\n    this.cidApi_ = new GoogleCidApi(ampdoc);\n\n    /** @private {?Object<string, string>} */\n    this.apiKeyMap_ = null;\n  }\n\n  /** @override */\n  get(getCidStruct, consent, opt_persistenceConsent) {\n    userAssert(\n      SCOPE_NAME_VALIDATOR.test(getCidStruct.scope) &&\n        SCOPE_NAME_VALIDATOR.test(getCidStruct.cookieName),\n      'The CID scope and cookie name must only use the characters ' +\n        '[a-zA-Z0-9-_.]+\\nInstead found: %s',\n      getCidStruct.scope\n    );\n    return consent\n      .then(() => {\n        return this.ampdoc.whenFirstVisible();\n      })\n      .then(() => {\n        // Check if user has globally opted out of CID, we do this after\n        // consent check since user can optout during consent process.\n        return isOptedOutOfCid(this.ampdoc);\n      })\n      .then(optedOut => {\n        if (optedOut) {\n          return '';\n        }\n        const cidPromise = this.getExternalCid_(\n          getCidStruct,\n          opt_persistenceConsent || consent\n        );\n        // Getting the CID might involve an HTTP request. We timeout after 10s.\n        return Services.timerFor(this.ampdoc.win)\n          .timeoutPromise(\n            10000,\n            cidPromise,\n            `Getting cid for \"${getCidStruct.scope}\" timed out`\n          )\n          .catch(error => {\n            rethrowAsync(error);\n          });\n      });\n  }\n\n  /** @override */\n  optOut() {\n    return optOutOfCid(this.ampdoc);\n  }\n\n  /**\n   * Returns the \"external cid\". This is a cid for a specific purpose\n   * (Say Analytics provider X). It is unique per user, userAssert, that purpose\n   * and the AMP origin site.\n   * @param {!GetCidDef} getCidStruct\n   * @param {!Promise} persistenceConsent\n   * @return {!Promise<?string>}\n   */\n  getExternalCid_(getCidStruct, persistenceConsent) {\n    const {scope} = getCidStruct;\n    /** @const {!Location} */\n    const url = parseUrlDeprecated(this.ampdoc.win.location.href);\n    if (!isProxyOrigin(url)) {\n      const apiKey = this.isScopeOptedIn_(scope);\n      if (apiKey) {\n        return this.cidApi_.getScopedCid(apiKey, scope).then(scopedCid => {\n          if (scopedCid == TokenStatus.OPT_OUT) {\n            return null;\n          }\n          if (scopedCid) {\n            const cookieName = getCidStruct.cookieName || scope;\n            setCidCookie(this.ampdoc.win, cookieName, scopedCid);\n            return scopedCid;\n          }\n          return getOrCreateCookie(this, getCidStruct, persistenceConsent);\n        });\n      }\n      return getOrCreateCookie(this, getCidStruct, persistenceConsent);\n    }\n\n    return this.viewerCidApi_.isSupported().then(supported => {\n      if (supported) {\n        const apiKey = this.isScopeOptedIn_(scope);\n        return this.viewerCidApi_.getScopedCid(apiKey, scope);\n      }\n\n      if (this.cacheCidApi_.isSupported() && this.isScopeOptedIn_(scope)) {\n        return this.cacheCidApi_.getScopedCid(scope).then(scopedCid => {\n          if (scopedCid) {\n            return scopedCid;\n          }\n          return this.scopeBaseCid_(persistenceConsent, scope, url);\n        });\n      }\n      return this.scopeBaseCid_(persistenceConsent, scope, url);\n    });\n  }\n\n  /**\n   *\n   * @param {!Promise} persistenceConsent\n   * @param {*} scope\n   * @param {!Location} url\n   * @return {*}\n   */\n  scopeBaseCid_(persistenceConsent, scope, url) {\n    return getBaseCid(this, persistenceConsent).then(baseCid => {\n      return Services.cryptoFor(this.ampdoc.win).sha384Base64(\n        baseCid + getProxySourceOrigin(url) + scope\n      );\n    });\n  }\n\n  /**\n   * Checks if the page has opted in CID API for the given scope.\n   * Returns the API key that should be used, or null if page hasn't opted in.\n   *\n   * @param {string} scope\n   * @return {string|undefined}\n   */\n  isScopeOptedIn_(scope) {\n    if (!this.apiKeyMap_) {\n      this.apiKeyMap_ = this.getOptedInScopes_();\n    }\n    return this.apiKeyMap_[scope];\n  }\n\n  /**\n   * Reads meta tags for opted in scopes.  Meta tags will have the form\n   * <meta name=\"provider-api-name\" content=\"provider-name\">\n   * @return {!Object<string, string>}\n   */\n  getOptedInScopes_() {\n    const apiKeyMap = {};\n    const optInMeta = this.ampdoc.win.document.head./*OK*/ querySelector(\n      `meta[name=${GOOGLE_CID_API_META_NAME}]`\n    );\n    if (optInMeta && optInMeta.hasAttribute('content')) {\n      const list = optInMeta.getAttribute('content').split(',');\n      list.forEach(item => {\n        item = item.trim();\n        if (item.indexOf('=') > 0) {\n          const pair = item.split('=');\n          const scope = pair[0].trim();\n          apiKeyMap[scope] = pair[1].trim();\n        } else {\n          const clientName = item;\n          const scope = CID_API_SCOPE_WHITELIST[clientName];\n          if (scope) {\n            apiKeyMap[scope] = API_KEYS[clientName];\n          } else {\n            user().warn(\n              TAG_,\n              `Unsupported client for Google CID API: ${clientName}.` +\n                `Please remove or correct ${optInMeta./*OK*/ outerHTML}`\n            );\n          }\n        }\n      });\n    }\n    return apiKeyMap;\n  }\n}\n\n/**\n * User will be opted out of Cid issuance for all scopes.\n * When opted-out Cid service will reject all `get` requests.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise}\n * @visibleForTesting\n */\nexport function optOutOfCid(ampdoc) {\n  // Tell the viewer that user has opted out.\n  Services.viewerForDoc(ampdoc)./*OK*/ sendMessage(\n    CID_OPTOUT_VIEWER_MESSAGE,\n    dict()\n  );\n\n  // Store the optout bit in storage\n  return Services.storageForDoc(ampdoc).then(storage => {\n    return storage.set(CID_OPTOUT_STORAGE_KEY, true);\n  });\n}\n\n/**\n * Whether user has opted out of Cid issuance for all scopes.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<boolean>}\n * @visibleForTesting\n */\nexport function isOptedOutOfCid(ampdoc) {\n  return Services.storageForDoc(ampdoc)\n    .then(storage => {\n      return storage.get(CID_OPTOUT_STORAGE_KEY).then(val => !!val);\n    })\n    .catch(() => {\n      // If we fail to read the flag, assume not opted out.\n      return false;\n    });\n}\n\n/**\n * Sets a new CID cookie for expire 1 year from now.\n * @param {!Window} win\n * @param {string} scope\n * @param {string} cookie\n */\nfunction setCidCookie(win, scope, cookie) {\n  const expiration = Date.now() + BASE_CID_MAX_AGE_MILLIS;\n  setCookie(win, scope, cookie, expiration, {\n    highestAvailableDomain: true,\n  });\n}\n\n/**\n * If cookie exists it's returned immediately. Otherwise, if instructed, the\n * new cookie is created.\n *\n * @param {!Cid} cid\n * @param {!GetCidDef} getCidStruct\n * @param {!Promise} persistenceConsent\n * @return {!Promise<?string>}\n */\nfunction getOrCreateCookie(cid, getCidStruct, persistenceConsent) {\n  const {win} = cid.ampdoc;\n  const {scope} = getCidStruct;\n  const cookieName = getCidStruct.cookieName || scope;\n  const existingCookie = getCookie(win, cookieName);\n\n  if (!existingCookie && !getCidStruct.createCookieIfNotPresent) {\n    return /** @type {!Promise<?string>} */ (Promise.resolve(null));\n  }\n\n  if (cid.externalCidCache_[scope]) {\n    return /** @type {!Promise<?string>} */ (cid.externalCidCache_[scope]);\n  }\n\n  if (existingCookie) {\n    // If we created the cookie, update it's expiration time.\n    if (/^amp-/.test(existingCookie)) {\n      setCidCookie(win, cookieName, existingCookie);\n    }\n    return /** @type {!Promise<?string>} */ (Promise.resolve(existingCookie));\n  }\n\n  const newCookiePromise = getRandomString64(win)\n    // Create new cookie, always prefixed with \"amp-\", so that we can see from\n    // the value whether we created it.\n    .then(randomStr => 'amp-' + randomStr);\n\n  // Store it as a cookie based on the persistence consent.\n  Promise.all([newCookiePromise, persistenceConsent]).then(results => {\n    // The initial CID generation is inherently racy. First one that gets\n    // consent wins.\n    const newCookie = results[0];\n    const relookup = getCookie(win, cookieName);\n    if (!relookup) {\n      setCidCookie(win, cookieName, newCookie);\n    }\n  });\n  return (cid.externalCidCache_[scope] = newCookiePromise);\n}\n\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin. Throws an error if the doc is not on a proxy origin.\n * @param {!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n * @visibleForTesting BUT if this is needed elsewhere it could be\n *     factored into its own package.\n */\nexport function getProxySourceOrigin(url) {\n  userAssert(isProxyOrigin(url), 'Expected proxy origin %s', url.origin);\n  return getSourceOrigin(url);\n}\n\n/**\n * Returns the base cid for the current user(). This string must not\n * be exposed to users without hashing with the current source origin\n * and the externalCidScope.\n * On a proxy this value is the same for a user across all source\n * origins.\n * @param {!Cid} cid\n * @param {!Promise} persistenceConsent\n * @return {!Promise<string>}\n */\nfunction getBaseCid(cid, persistenceConsent) {\n  if (cid.baseCid_) {\n    return cid.baseCid_;\n  }\n  const {win} = cid.ampdoc;\n\n  return (cid.baseCid_ = read(cid.ampdoc).then(stored => {\n    let needsToStore = false;\n    let baseCid;\n\n    // See if we have a stored base cid and whether it is still valid\n    // in terms of expiration.\n    if (stored && !isExpired(stored)) {\n      baseCid = Promise.resolve(stored.cid);\n      if (shouldUpdateStoredTime(stored)) {\n        needsToStore = true;\n      }\n    } else {\n      // We need to make a new one.\n      baseCid = Services.cryptoFor(win).sha384Base64(getEntropy(win));\n      needsToStore = true;\n    }\n\n    if (needsToStore) {\n      baseCid.then(baseCid => {\n        store(cid.ampdoc, persistenceConsent, baseCid);\n      });\n    }\n\n    return baseCid;\n  }));\n}\n\n/**\n * Stores a new cidString in localStorage. Adds the current time to the\n * stored value.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Promise} persistenceConsent\n * @param {string} cidString Actual cid string to store.\n */\nfunction store(ampdoc, persistenceConsent, cidString) {\n  const {win} = ampdoc;\n  if (isIframed(win)) {\n    // If we are being embedded, try to save the base cid to the viewer.\n    viewerBaseCid(ampdoc, createCidData(cidString));\n  } else {\n    // To use local storage, we need user's consent.\n    persistenceConsent.then(() => {\n      try {\n        win.localStorage.setItem('amp-cid', createCidData(cidString));\n      } catch (ignore) {\n        // Setting localStorage may fail. In practice we don't expect that to\n        // happen a lot (since we don't go anywhere near the quota, but\n        // in particular in Safari private browsing mode it always fails.\n        // In that case we just don't store anything, which is just fine.\n      }\n    });\n  }\n}\n\n/**\n * Get/set the Base CID from/to the viewer.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {string=} opt_data Stringified JSON object {cid, time}.\n * @return {!Promise<string|undefined>}\n */\nexport function viewerBaseCid(ampdoc, opt_data) {\n  const viewer = Services.viewerForDoc(ampdoc);\n  return viewer.isTrustedViewer().then(trusted => {\n    if (!trusted) {\n      return undefined;\n    }\n    // TODO(lannka, #11060): clean up when all Viewers get migrated\n    dev().expectedError('CID', 'Viewer does not provide cap=cid');\n    return viewer.sendMessageAwaitResponse('cid', opt_data).then(data => {\n      // For backward compatibility: #4029\n      if (data && !tryParseJson(data)) {\n        // TODO(lannka, #11060): clean up when all Viewers get migrated\n        dev().expectedError('CID', 'invalid cid format');\n        return JSON.stringify(\n          dict({\n            'time': Date.now(), // CID returned from old API is always fresh\n            'cid': data,\n          })\n        );\n      }\n      return data;\n    });\n  });\n}\n\n/**\n * Creates a JSON object that contains the given CID and the current time as\n * a timestamp.\n * @param {string} cidString\n * @return {string}\n */\nfunction createCidData(cidString) {\n  return JSON.stringify(\n    dict({\n      'time': Date.now(),\n      'cid': cidString,\n    })\n  );\n}\n\n/**\n * Gets the persisted CID data as a promise. It tries to read from\n * localStorage first then from viewer if it is in embedded mode.\n * Returns null if none was found.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Promise<?BaseCidInfoDef>}\n */\nfunction read(ampdoc) {\n  const {win} = ampdoc;\n  let data;\n  try {\n    data = win.localStorage.getItem('amp-cid');\n  } catch (ignore) {\n    // If reading from localStorage fails, we assume it is empty.\n  }\n  let dataPromise = Promise.resolve(data);\n  if (!data && isIframed(win)) {\n    // If we are being embedded, try to get the base cid from the viewer.\n    dataPromise = viewerBaseCid(ampdoc);\n  }\n  return dataPromise.then(data => {\n    if (!data) {\n      return null;\n    }\n    const item = parseJson(data);\n    return {\n      time: item['time'],\n      cid: item['cid'],\n    };\n  });\n}\n\n/**\n * Whether the retrieved cid object is expired and should be ignored.\n * @param {!BaseCidInfoDef} storedCidInfo\n * @return {boolean}\n */\nfunction isExpired(storedCidInfo) {\n  const createdTime = storedCidInfo.time;\n  const now = Date.now();\n  return createdTime + BASE_CID_MAX_AGE_MILLIS < now;\n}\n\n/**\n * Whether we should write a new timestamp to the stored cid value.\n * We say yes if it is older than 1 day, so we only do this max once\n * per day to avoid writing to localStorage all the time.\n * @param {!BaseCidInfoDef} storedCidInfo\n * @return {boolean}\n */\nfunction shouldUpdateStoredTime(storedCidInfo) {\n  const createdTime = storedCidInfo.time;\n  const now = Date.now();\n  return createdTime + ONE_DAY_MILLIS < now;\n}\n\n/**\n * Returns an array with a total of 128 of random values based on the\n * `win.crypto.getRandomValues` API. If that is not available concatenates\n * a string of other values that might be hard to guess including\n * `Math.random` and the current time.\n * @param {!Window} win\n * @return {!Uint8Array|string} Entropy.\n */\nfunction getEntropy(win) {\n  // Use win.crypto.getRandomValues to get 128 bits of random value\n  const uint8array = getCryptoRandomBytesArray(win, 16); // 128 bit\n  if (uint8array) {\n    return uint8array;\n  }\n\n  // Support for legacy browsers.\n  return String(\n    win.location.href +\n      Date.now() +\n      win.Math.random() +\n      win.screen.width +\n      win.screen.height\n  );\n}\n\n/**\n * Produces an external CID for use in a cookie.\n * @param {!Window} win\n * @return {!Promise<string>} The cid\n */\nexport function getRandomString64(win) {\n  const entropy = getEntropy(win);\n  if (typeof entropy == 'string') {\n    return Services.cryptoFor(win).sha384Base64(entropy);\n  } else {\n    // If our entropy is a pure random number, we can just directly turn it\n    // into base 64\n    const cast = /** @type {!Uint8Array} */ (entropy);\n    return tryResolve(() =>\n      base64UrlEncodeFromBytes(cast)\n        // Remove trailing padding\n        .replace(/\\.+$/, '')\n    );\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {*} TODO(#23582): Specify return type\n */\nexport function installCidService(ampdoc) {\n  return registerServiceBuilderForDoc(ampdoc, 'cid', Cid);\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!Cid}\n * @private visible for testing\n */\nexport function cidServiceForDocForTesting(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'cid', Cid);\n  return getServiceForDoc(ampdoc, 'cid');\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {adoptServiceForEmbedDoc} from '../service';\nimport {installActionServiceForDoc} from './action-impl';\nimport {installBatchedXhrService} from './batched-xhr-impl';\nimport {installCidService} from './cid-impl';\nimport {installCryptoService} from './crypto-impl';\nimport {installDocumentInfoServiceForDoc} from './document-info-impl';\nimport {installGlobalNavigationHandlerForDoc} from './navigation';\nimport {installGlobalSubmitListenerForDoc} from '../document-submit';\nimport {installHiddenObserverForDoc} from './hidden-observer-impl';\nimport {installHistoryServiceForDoc} from './history-impl';\nimport {installImg} from '../../builtins/amp-img';\nimport {installInputService} from '../input';\nimport {installLayout} from '../../builtins/amp-layout';\nimport {installOwnersServiceForDoc} from './owners-impl';\nimport {installPixel} from '../../builtins/amp-pixel';\nimport {installPlatformService} from './platform-impl';\nimport {installResourcesServiceForDoc} from './resources-impl';\nimport {installStandardActionsForDoc} from './standard-actions-impl';\nimport {installStorageServiceForDoc} from './storage-impl';\nimport {installTemplatesService} from './template-impl';\nimport {installTimerService} from './timer-impl';\nimport {installUrlForDoc} from './url-impl';\nimport {installUrlReplacementsServiceForDoc} from './url-replacements-impl';\nimport {installViewerServiceForDoc} from './viewer-impl';\nimport {installViewportServiceForDoc} from './viewport/viewport-impl';\nimport {installVsyncService} from './vsync-impl';\nimport {installXhrService} from './xhr-impl';\n\n/**\n * Install builtins.\n * @param {!Window} win\n * @restricted\n */\nexport function installBuiltinElements(win) {\n  installImg(win);\n  installPixel(win);\n  installLayout(win);\n}\n\n/**\n * Install runtime-level services.\n * @param {!Window} global Global scope to adopt.\n * @restricted\n */\nexport function installRuntimeServices(global) {\n  installCryptoService(global);\n  installBatchedXhrService(global);\n  installPlatformService(global);\n  installTemplatesService(global);\n  installTimerService(global);\n  installVsyncService(global);\n  installXhrService(global);\n  installInputService(global);\n}\n\n/**\n * Install ampdoc-level services.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @restricted\n */\nexport function installAmpdocServices(ampdoc) {\n  const isEmbedded = !!ampdoc.getParent();\n\n  // When making changes to this method:\n  // 1. Order is important!\n  // 2. Consider to install same services to amp-inabox.js\n  installUrlForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'documentInfo')\n    : installDocumentInfoServiceForDoc(ampdoc);\n  // those services are installed in amp-inabox.js\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'cid')\n    : installCidService(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'viewer')\n    : installViewerServiceForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'viewport')\n    : installViewportServiceForDoc(ampdoc);\n  installHiddenObserverForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'history')\n    : installHistoryServiceForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'resources')\n    : installResourcesServiceForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'owners')\n    : installOwnersServiceForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'url-replace')\n    : installUrlReplacementsServiceForDoc(ampdoc);\n  installActionServiceForDoc(ampdoc);\n  installStandardActionsForDoc(ampdoc);\n  isEmbedded\n    ? adoptServiceForEmbedDoc(ampdoc, 'storage')\n    : installStorageServiceForDoc(ampdoc);\n  installGlobalNavigationHandlerForDoc(ampdoc);\n  installGlobalSubmitListenerForDoc(ampdoc);\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {base64UrlEncodeFromBytes} from '../utils/base64';\nimport {dev, devAssert, user} from '../log';\nimport {getService, registerServiceBuilder} from '../service';\nimport {stringToBytes, utf8Encode} from '../utils/bytes';\n\n/** @const {string} */\nconst TAG = 'Crypto';\n\n/**\n * @typedef {function((string|Uint8Array))}\n */\nlet CryptoPolyfillDef;\n\nexport class Crypto {\n  /**\n   * Creates an instance of Crypto.\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private {!Window} */\n    this.win_ = win;\n\n    let subtle = null;\n    let isLegacyWebkit = false;\n    if (win.crypto) {\n      if (win.crypto.subtle) {\n        subtle = win.crypto.subtle;\n      } else if (win.crypto.webkitSubtle) {\n        subtle = win.crypto.webkitSubtle;\n        isLegacyWebkit = true;\n      }\n    }\n\n    /** @const {{name: string}} */\n    this.pkcsAlgo = {\n      name: 'RSASSA-PKCS1-v1_5',\n      hash: {name: 'SHA-256'},\n    };\n\n    /** @const {?webCrypto.SubtleCrypto} */\n    this.subtle = subtle;\n\n    /** @private @const {boolean} */\n    this.isLegacyWebkit_ = isLegacyWebkit;\n\n    /** @private {?Promise<!CryptoPolyfillDef>} */\n    this.polyfillPromise_ = null;\n  }\n\n  /**\n   * Returns the SHA-384 hash of the input string in a number array.\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<!Uint8Array>}\n   * @throws {!Error} when input string contains chars out of range [0,255]\n   */\n  sha384(input) {\n    if (typeof input === 'string') {\n      input = stringToBytes(input);\n    }\n\n    if (!this.subtle || this.polyfillPromise_) {\n      // means native Crypto API is not available or failed before.\n      return (this.polyfillPromise_ || this.loadPolyfill_()).then(\n        polyfillSha384 => polyfillSha384(input)\n      );\n    }\n\n    try {\n      return (\n        this.subtle\n          .digest({name: 'SHA-384'}, input)\n          /** @param {?} buffer */\n          .then(\n            buffer => new Uint8Array(buffer),\n            e => {\n              // Chrome doesn't allow the usage of Crypto API under\n              // non-secure origin: https://www.chromium.org/Home/chromium-security/prefer-secure-origins-for-powerful-new-features\n              if (e.message && e.message.indexOf('secure origin') < 0) {\n                // Log unexpected fallback.\n                user().error(\n                  TAG,\n                  'SubtleCrypto failed, fallback to closure lib.',\n                  e\n                );\n              }\n              return this.loadPolyfill_().then(() => this.sha384(input));\n            }\n          )\n      );\n    } catch (e) {\n      dev().error(TAG, 'SubtleCrypto failed, fallback to closure lib.', e);\n      return this.loadPolyfill_().then(() => this.sha384(input));\n    }\n  }\n\n  /**\n   * Returns the SHA-384 hash of the input string in the format of web safe\n   * base64 (using -_. instead of +/=).\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<string>}\n   * @throws {!Error} when input string contains chars out of range [0,255]\n   */\n  sha384Base64(input) {\n    return this.sha384(input).then(buffer => base64UrlEncodeFromBytes(buffer));\n  }\n\n  /**\n   * Returns a uniform hash of the input string as a float number in the range\n   * of [0, 1).\n   * Input string cannot contain chars out of range [0,255].\n   * @param {string|!Uint8Array} input\n   * @return {!Promise<number>}\n   */\n  uniform(input) {\n    return this.sha384(input).then(buffer => {\n      // Consider the Uint8 array as a base256 fraction number,\n      // then convert it to the decimal form.\n      let result = 0;\n      for (let i = 2; i >= 0; i--) {\n        // 3 base256 digits give enough precision\n        result = (result + buffer[i]) / 256;\n      }\n      return result;\n    });\n  }\n\n  /**\n   * Loads Crypto polyfill library.\n   * @return {!Promise<!CryptoPolyfillDef>}\n   * @private\n   */\n  loadPolyfill_() {\n    if (this.polyfillPromise_) {\n      return this.polyfillPromise_;\n    }\n    return (this.polyfillPromise_ = Services.extensionsFor(this.win_)\n      .preloadExtension('amp-crypto-polyfill')\n      .then(() => getService(this.win_, 'crypto-polyfill')));\n  }\n\n  /**\n   * Checks whether Web Cryptography is available, which is required for PKCS 1\n   * operations. SHA-384 operations do not need this because there's a polyfill.\n   * This could be false if the browser does not support Web Cryptography, or if\n   * the current browsing context is not secure (e.g., it's on an insecure HTTP\n   * page, or an HTTPS iframe embedded in an insecure HTTP page).\n   *\n   * @return {boolean} whether Web Cryptography is available\n   */\n  isPkcsAvailable() {\n    return Boolean(this.subtle) && this.win_['isSecureContext'] !== false;\n  }\n\n  /**\n   * Converts an RSA JSON Web Key object to a browser-native cryptographic key.\n   * As a precondition, `isPkcsAvailable()` must be `true`.\n   *\n   * @param {!Object} jwk a deserialized RSA JSON Web Key, as specified in\n   *     Section 6.3 of RFC 7518\n   * @return {!Promise<!webCrypto.CryptoKey>}\n   * @throws {TypeError} if `jwk` is not an RSA JSON Web Key\n   */\n  importPkcsKey(jwk) {\n    devAssert(this.isPkcsAvailable());\n    // Safari 10 and earlier want this as an ArrayBufferView.\n    const keyData = this.isLegacyWebkit_\n      ? utf8Encode(JSON.stringify(/** @type {!JsonObject} */ (jwk)))\n      : /** @type {!webCrypto.JsonWebKey} */ (jwk);\n    return /** @type {!Promise<!webCrypto.CryptoKey>} */ (this.subtle.importKey(\n      'jwk',\n      keyData,\n      this.pkcsAlgo,\n      true,\n      ['verify']\n    ));\n  }\n\n  /**\n   * Verifies an RSASSA-PKCS1-v1_5 signature with a SHA-256 hash. As a\n   * precondition, `isPkcsAvailable()` must be `true`.\n   *\n   * @param {!webCrypto.CryptoKey} key an RSA public key\n   * @param {!Uint8Array} signature an RSASSA-PKCS1-v1_5 signature\n   * @param {!BufferSource} data the data that was signed\n   * @return {!Promise<boolean>} whether the signature is correct for the given\n   *     data and public key\n   */\n  verifyPkcs(key, signature, data) {\n    devAssert(this.isPkcsAvailable());\n    return /** @type {!Promise<boolean>} */ (this.subtle.verify(\n      this.pkcsAlgo,\n      key,\n      signature,\n      data\n    ));\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {*} TODO(#23582): Specify return type\n */\nexport function installCryptoService(win) {\n  return registerServiceBuilder(win, 'crypto', Crypto);\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ElementStub, stubbedElements} from '../element-stub';\nimport {createCustomElementClass} from '../custom-element';\nimport {extensionScriptsInNode} from '../element-service';\nimport {reportError} from '../error';\nimport {userAssert} from '../log';\n\n/**\n * @param {!Window} win\n * @return {!Object<string, function(new:../base-element.BaseElement, !Element)>}\n */\nfunction getExtendedElements(win) {\n  if (!win.__AMP_EXTENDED_ELEMENTS) {\n    win.__AMP_EXTENDED_ELEMENTS = {};\n  }\n  return win.__AMP_EXTENDED_ELEMENTS;\n}\n\n/**\n * Registers an element. Upgrades it if has previously been stubbed.\n * @param {!Window} win\n * @param {string} name\n * @param {function(new:../base-element.BaseElement, !Element)} toClass\n */\nexport function upgradeOrRegisterElement(win, name, toClass) {\n  const knownElements = getExtendedElements(win);\n  if (!knownElements[name]) {\n    registerElement(win, name, /** @type {!Function} */ (toClass));\n    return;\n  }\n  if (knownElements[name] == toClass) {\n    // Already registered this instance.\n    return;\n  }\n  userAssert(\n    knownElements[name] == ElementStub,\n    '%s is already registered. The script tag for ' +\n      '%s is likely included twice in the page.',\n    name,\n    name\n  );\n  knownElements[name] = toClass;\n  for (let i = 0; i < stubbedElements.length; i++) {\n    const stub = stubbedElements[i];\n    // There are 3 possible states here:\n    // 1. We never made the stub because the extended impl. loaded first.\n    //    In that case the element won't be in the array.\n    // 2. We made a stub but the browser didn't attach it yet. In\n    //    that case we don't need to upgrade but simply switch to the new\n    //    implementation.\n    // 3. A stub was attached. We upgrade which means we replay the\n    //    implementation.\n    const {element} = stub;\n    if (\n      element.tagName.toLowerCase() == name &&\n      element.ownerDocument.defaultView == win\n    ) {\n      tryUpgradeElement_(element, toClass);\n      // Remove element from array.\n      stubbedElements.splice(i--, 1);\n    }\n  }\n}\n\n/**\n * This method should not be inlined to prevent TryCatch deoptimization.\n * @param {Element} element\n * @param {function(new:../base-element.BaseElement, !Element)} toClass\n * @private\n * @noinline\n */\nfunction tryUpgradeElement_(element, toClass) {\n  try {\n    element.upgrade(toClass);\n  } catch (e) {\n    reportError(e, element);\n  }\n}\n\n/**\n * Stub extended elements missing an implementation. It can be called multiple\n * times and on partial document in order to start stubbing as early as\n * possible.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function stubElementsForDoc(ampdoc) {\n  const extensions = extensionScriptsInNode(ampdoc.getHeadNode());\n  extensions.forEach(name => {\n    ampdoc.declareExtension(name);\n    stubElementIfNotKnown(ampdoc.win, name);\n  });\n}\n\n/**\n * Stub element if not yet known.\n * @param {!Window} win\n * @param {string} name\n */\nexport function stubElementIfNotKnown(win, name) {\n  const knownElements = getExtendedElements(win);\n  if (!knownElements[name]) {\n    registerElement(win, name, ElementStub);\n  }\n}\n\n/**\n * Copies the specified element to child window (friendly iframe). This way\n * all implementations of the AMP elements are shared between all friendly\n * frames.\n * @param {!Window} parentWin\n * @param {!Window} childWin\n * @param {string} name\n */\nexport function copyElementToChildWindow(parentWin, childWin, name) {\n  const toClass = getExtendedElements(parentWin)[name];\n  registerElement(childWin, name, toClass || ElementStub);\n}\n\n/**\n * Registers a new custom element with its implementation class.\n * @param {!Window} win The window in which to register the elements.\n * @param {string} name Name of the custom element\n * @param {function(new:../base-element.BaseElement, !Element)} implementationClass\n */\nexport function registerElement(win, name, implementationClass) {\n  const knownElements = getExtendedElements(win);\n  knownElements[name] = implementationClass;\n  const klass = createCustomElementClass(win, name);\n  win['customElements'].define(name, klass);\n}\n\n/**\n * In order to provide better error messages we only allow to retrieve\n * services from other elements if those elements are loaded in the page.\n * This makes it possible to mark an element as loaded in a test.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @visibleForTesting\n */\nexport function markElementScheduledForTesting(win, elementName) {\n  const knownElements = getExtendedElements(win);\n  if (!knownElements[elementName]) {\n    knownElements[elementName] = ElementStub;\n  }\n}\n\n/**\n * Resets our scheduled elements.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @visibleForTesting\n */\nexport function resetScheduledElementForTesting(win, elementName) {\n  if (win.__AMP_EXTENDED_ELEMENTS) {\n    delete win.__AMP_EXTENDED_ELEMENTS[elementName];\n  }\n}\n\n/**\n * Returns a currently registered element class.\n * @param {!Window} win\n * @param {string} elementName Name of an extended custom element.\n * @return {?function()}\n * @visibleForTesting\n */\nexport function getElementClassForTesting(win, elementName) {\n  const knownElements = win.__AMP_EXTENDED_ELEMENTS;\n  return (knownElements && knownElements[elementName]) || null;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  getProxyServingType,\n  getSourceUrl,\n  parseQueryString,\n  parseUrlDeprecated,\n} from '../url';\n\nimport {getRandomString64} from './cid-impl';\nimport {isArray} from '../types';\nimport {map} from '../utils/object';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/** @private @const {!Array<string>} */\nconst filteredLinkRels = ['prefetch', 'preload', 'preconnect', 'dns-prefetch'];\n\n/**\n * Properties:\n *     - sourceUrl: the source url of an amp document.\n *     - canonicalUrl: The doc's canonical.\n *     - pageViewId: Id for this page view. Low entropy but should be unique\n *     - pageViewId64: Id for this page view. High entropy but should be unique\n *       for concurrent page views of a user().\n *     - linkRels: A map object of link tag's rel (key) and corresponding\n *       hrefs (value). rel could be 'canonical', 'icon', etc.\n *     - metaTags: A map object of meta tag's name (key) and corresponding\n *       contents (value).\n *     - replaceParams: A map object of extra query string parameter names (key)\n *       to corresponding values, used for custom analytics.\n *       Null if not applicable.\n *\n * @typedef {{\n *   sourceUrl: string,\n *   canonicalUrl: string,\n *   pageViewId: string,\n *   pageViewId64: !Promise<string>,\n *   linkRels: !Object<string, string|!Array<string>>,\n *   metaTags: !Object<string, string|!Array<string>>,\n *   replaceParams: ?Object<string, string|!Array<string>>\n * }}\n */\nexport let DocumentInfoDef;\n\n/**\n * @param {!Node|!./ampdoc-impl.AmpDoc} nodeOrDoc\n * @return {*} TODO(#23582): Specify return type\n */\nexport function installDocumentInfoServiceForDoc(nodeOrDoc) {\n  return registerServiceBuilderForDoc(nodeOrDoc, 'documentInfo', DocInfo);\n}\n\nexport class DocInfo {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private @const  */\n    this.ampdoc_ = ampdoc;\n    /** @private {?DocumentInfoDef} */\n    this.info_ = null;\n    /** @private {?Promise<string>} */\n    this.pageViewId64_ = null;\n  }\n\n  /** @return {!DocumentInfoDef} */\n  get() {\n    if (this.info_) {\n      return this.info_;\n    }\n    const ampdoc = this.ampdoc_;\n    const url = ampdoc.getUrl();\n    const sourceUrl = getSourceUrl(url);\n    const rootNode = ampdoc.getRootNode();\n    let canonicalUrl = rootNode && rootNode.AMP && rootNode.AMP.canonicalUrl;\n    if (!canonicalUrl) {\n      const canonicalTag = rootNode.querySelector('link[rel=canonical]');\n      canonicalUrl = canonicalTag\n        ? parseUrlDeprecated(canonicalTag.href).href\n        : sourceUrl;\n    }\n    const pageViewId = getPageViewId(ampdoc.win);\n    const linkRels = getLinkRels(ampdoc.win.document);\n    const metaTags = getMetaTags(ampdoc.win.document);\n    const replaceParams = getReplaceParams(ampdoc);\n\n    return (this.info_ = {\n      /** @return {string} */\n      get sourceUrl() {\n        return getSourceUrl(ampdoc.getUrl());\n      },\n      canonicalUrl,\n      pageViewId,\n      get pageViewId64() {\n        // Must be calculated async since getRandomString64() can load the\n        // amp-crypto-polyfill on some browsers, and extensions service\n        // may not be registered yet.\n        if (!this.pageViewId64_) {\n          this.pageViewId64_ = getRandomString64(ampdoc.win);\n        }\n        return this.pageViewId64_;\n      },\n      linkRels,\n      metaTags,\n      replaceParams,\n    });\n  }\n}\n\n/**\n * Returns a relatively low entropy random string.\n * This should be called once per window and then cached for subsequent\n * access to the same value to be persistent per page.\n * @param {!Window} win\n * @return {string}\n */\nfunction getPageViewId(win) {\n  return String(Math.floor(win.Math.random() * 10000));\n}\n\n/**\n * Returns a map object of link tag relations in document head.\n * Key is the link rel, value is a list of corresponding hrefs.\n * @param {!Document} doc\n * @return {!JsonObject<string, string|!Array<string>>}\n */\nfunction getLinkRels(doc) {\n  const linkRels = map();\n  if (doc.head) {\n    const links = doc.head.querySelectorAll('link[rel]');\n    for (let i = 0; i < links.length; i++) {\n      const link = links[i];\n      const {href} = link;\n      const rels = link.getAttribute('rel');\n      if (!rels || !href) {\n        continue;\n      }\n\n      rels.split(/\\s+/).forEach(rel => {\n        if (filteredLinkRels.indexOf(rel) != -1) {\n          return;\n        }\n\n        let value = linkRels[rel];\n        if (value) {\n          // Change to array if more than one href for the same rel\n          if (!isArray(value)) {\n            value = linkRels[rel] = [value];\n          }\n          value.push(href);\n        } else {\n          linkRels[rel] = href;\n        }\n      });\n    }\n  }\n  return linkRels;\n}\n\n/**\n * Returns a map object of meta tags in document head.\n * Key is the meta name, value is a list of corresponding content values.\n * @param {!Document} doc\n * @return {!JsonObject<string, string|!Array<string>>}\n */\nfunction getMetaTags(doc) {\n  const metaTags = map();\n  if (doc.head) {\n    const metas = doc.head.querySelectorAll('meta[name]');\n    for (let i = 0; i < metas.length; i++) {\n      const meta = metas[i];\n      const content = meta.getAttribute('content');\n      const name = meta.getAttribute('name');\n      if (!name || !content) {\n        continue;\n      }\n\n      let value = metaTags[name];\n      if (value) {\n        // Change to array if more than one content for the same name\n        if (!isArray(value)) {\n          value = metaTags[name] = [value];\n        }\n        value.push(content);\n      } else {\n        metaTags[name] = content;\n      }\n    }\n  }\n  return metaTags;\n}\n\n/**\n * Attempts to retrieve extra parameters from the \"amp_r\" query param,\n * returning null if invalid.\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {?JsonObject<string, string|!Array<string>>}\n */\nfunction getReplaceParams(ampdoc) {\n  // The \"amp_r\" parameter is only supported for ads.\n  if (\n    !ampdoc.isSingleDoc() ||\n    getProxyServingType(ampdoc.win.location.href) != 'a'\n  ) {\n    return null;\n  }\n  const url = parseUrlDeprecated(ampdoc.win.location.href);\n  const replaceRaw = parseQueryString(url.search)['amp_r'];\n  if (replaceRaw === undefined) {\n    // Differentiate the case between empty replace params and invalid result\n    return null;\n  }\n  return parseQueryString(replaceRaw);\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from '../mode';\nimport {urls} from '../config';\n\n/**\n * Internal structure that maintains the state of an extension through loading.\n *\n * @typedef {{\n *   extensionId: (string|undefined),\n *   extensionVersion: (string|undefined),\n * }}\n * @private\n */\nlet ExtensionInfoDef;\n\n/**\n * Calculate the base url for any scripts.\n * @param {!Location} location The window's location\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateScriptBaseUrl(location, opt_isLocalDev) {\n  if (opt_isLocalDev) {\n    let prefix = `${location.protocol}//${location.host}`;\n    if (location.protocol == 'about:') {\n      prefix = '';\n    }\n    return `${prefix}/dist`;\n  }\n  return urls.cdn;\n}\n\n/**\n * Calculate script url for an extension.\n * @param {!Location} location The window's location\n * @param {string} extensionId\n * @param {string=} opt_extensionVersion\n * @param {boolean=} opt_isLocalDev\n * @return {string}\n */\nexport function calculateExtensionScriptUrl(\n  location,\n  extensionId,\n  opt_extensionVersion,\n  opt_isLocalDev\n) {\n  const base = calculateScriptBaseUrl(location, opt_isLocalDev);\n  const rtv = getMode().rtvVersion;\n  if (opt_extensionVersion == null) {\n    opt_extensionVersion = '0.1';\n  }\n  const extensionVersion = opt_extensionVersion\n    ? '-' + opt_extensionVersion\n    : '';\n  return `${base}/rtv/${rtv}/v0/${extensionId}${extensionVersion}.js`;\n}\n\n/**\n * Calculate script url for an entry point.\n * If `opt_rtv` is true, returns the URL matching the current RTV.\n * @param {!Location} location The window's location\n * @param {string} entryPoint\n * @param {boolean=} isLocalDev\n * @param {boolean=} opt_rtv\n * @return {string}\n */\nexport function calculateEntryPointScriptUrl(\n  location,\n  entryPoint,\n  isLocalDev,\n  opt_rtv\n) {\n  const base = calculateScriptBaseUrl(location, isLocalDev);\n  if (opt_rtv) {\n    return `${base}/rtv/${getMode().rtvVersion}/${entryPoint}.js`;\n  }\n  return `${base}/${entryPoint}.js`;\n}\n\n/**\n * Parse the extension version from a given script URL.\n * @param {string} scriptUrl\n * @return {!ExtensionInfoDef}\n */\nexport function parseExtensionUrl(scriptUrl) {\n  const regex = /^(.*)\\/(.*)-([0-9.]+)\\.js$/i;\n  const matches = scriptUrl.match(regex);\n\n  return {\n    extensionId: matches ? matches[2] : undefined,\n    extensionVersion: matches ? matches[3] : undefined,\n  };\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../utils/promise';\nimport {Services} from '../services';\nimport {\n  calculateExtensionScriptUrl,\n  parseExtensionUrl,\n} from './extension-location';\nimport {dev, devAssert, rethrowAsync} from '../log';\nimport {getMode} from '../mode';\nimport {installStylesForDoc} from '../style-installer';\nimport {map} from '../utils/object';\nimport {registerServiceBuilder, registerServiceBuilderForDoc} from '../service';\nimport {startsWith} from '../string';\nimport {\n  stubElementIfNotKnown,\n  upgradeOrRegisterElement,\n} from './custom-element-registry';\n\nexport const LEGACY_ELEMENTS = ['amp-ad', 'amp-embed', 'amp-video'];\nconst TAG = 'extensions';\nconst UNKNOWN_EXTENSION = '_UNKNOWN_';\nconst CUSTOM_TEMPLATES = ['amp-mustache'];\nconst LOADER_PROP = '__AMP_EXT_LDR';\n\n/**\n * Default milliseconds to wait for all extensions to load before erroring.\n * (8 seconds is the same as the CSS boilerplate timoeout)\n * @const\n */\nconst LOAD_TIMEOUT = 8000;\n\n/**\n * Contains data for the declaration of a custom element.\n *\n * @typedef {{\n *   implementationClass:\n *       function(new:../base-element.BaseElement, !Element),\n *   css: (?string|undefined),\n * }}\n */\nlet ExtensionElementDef;\n\n/**\n * Contains data for the declaration of an extension service.\n *\n * @typedef {{serviceName: string, serviceClass: function(new:Object, !./ampdoc-impl.AmpDoc)}}\n */\nlet ExtensionServiceDef;\n\n/**\n * The structure that contains the resources declared by an extension.\n *\n * @typedef {{\n *   elements: !Object<string, !ExtensionElementDef>,\n *   services: !Object<string, !ExtensionServiceDef>,\n * }}\n */\nlet ExtensionDef;\n\n/**\n * Internal structure that maintains the state of an extension through loading.\n *\n * @typedef {{\n *   extension: !ExtensionDef,\n *   auto: boolean,\n *   docFactories: !Array<function(!./ampdoc-impl.AmpDoc)>,\n *   promise: (!Promise<!ExtensionDef>|undefined),\n *   resolve: (function(!ExtensionDef)|undefined),\n *   reject: (function(!Error)|undefined),\n *   loaded: (boolean|undefined),\n *   error: (!Error|undefined),\n *   scriptPresent: (boolean|undefined),\n * }}\n * @private\n */\nlet ExtensionHolderDef;\n\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\nexport function isTemplateExtension(extensionId) {\n  return CUSTOM_TEMPLATES.indexOf(extensionId) >= 0;\n}\n\n/**\n * @param {string} extensionId\n * @return {boolean}\n */\nfunction isIntermediateExtension(extensionId) {\n  return startsWith(extensionId, '_');\n}\n\n/**\n * Install extensions service.\n * @param {!Window} window\n * @restricted\n */\nexport function installExtensionsService(window) {\n  registerServiceBuilder(window, 'extensions', Extensions);\n}\n\n/**\n * The services that manages extensions in the runtime.\n * @visibleForTesting\n */\nexport class Extensions {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @const @private */\n    this.ampdocService_ = Services.ampdocServiceFor(win);\n\n    /** @private @const {!Object<string, !ExtensionHolderDef>} */\n    this.extensions_ = {};\n\n    /** @private {?string} */\n    this.currentExtensionId_ = null;\n  }\n\n  /**\n   * Register and process the specified extension. The factory is called\n   * immediately, which in turn is expected to register elements, templates,\n   * services and document factories. This method is called by the extension's\n   * script itself when it's loaded using the regular `AMP.push()` callback.\n   * @param {string} extensionId\n   * @param {function(!Object, !Object)} factory\n   * @param {!Object} arg\n   * @restricted\n   */\n  registerExtension(extensionId, factory, arg) {\n    const holder = this.getExtensionHolder_(extensionId, /* auto */ true);\n    try {\n      this.currentExtensionId_ = extensionId;\n      factory(arg, arg['_']);\n      if (getMode().localDev || getMode().test) {\n        if (Object.freeze) {\n          const m = holder.extension;\n          m.elements = Object.freeze(m.elements);\n          holder.extension = Object.freeze(m);\n        }\n      }\n      holder.loaded = true;\n      if (holder.resolve) {\n        holder.resolve(holder.extension);\n      }\n    } catch (e) {\n      holder.error = e;\n      if (holder.reject) {\n        holder.reject(e);\n      }\n      throw e;\n    } finally {\n      this.currentExtensionId_ = null;\n    }\n  }\n\n  /**\n   * Waits for the previously included extension to complete\n   * loading/registration.\n   * @param {!Window} win\n   * @param {string} extensionId\n   * @param {number=} opt_timeout\n   * @return {!Promise<?ExtensionDef>}\n   */\n  waitForExtension(win, extensionId, opt_timeout) {\n    return /** @type {!Promise<?ExtensionDef>} */ (Services.timerFor(\n      win\n    ).timeoutPromise(\n      opt_timeout || LOAD_TIMEOUT,\n      this.waitFor_(this.getExtensionHolder_(extensionId, /* auto */ false)),\n      `Render timeout waiting for extension ${extensionId} to be load.`\n    ));\n  }\n\n  /**\n   * Returns the promise that will be resolved when the extension has been\n   * loaded. If necessary, adds the extension script to the page.\n   * @param {string} extensionId\n   * @param {string=} opt_extensionVersion\n   * @return {!Promise<!ExtensionDef>}\n   */\n  preloadExtension(extensionId, opt_extensionVersion) {\n    if (extensionId == 'amp-embed') {\n      extensionId = 'amp-ad';\n    }\n    const holder = this.getExtensionHolder_(extensionId, /* auto */ false);\n    this.insertExtensionScriptIfNeeded_(\n      extensionId,\n      holder,\n      opt_extensionVersion\n    );\n    return this.waitFor_(holder);\n  }\n\n  /**\n   * Returns the promise that will be resolved when the extension has been\n   * loaded. If necessary, adds the extension script to the page.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} extensionId\n   * @param {string=} opt_extensionVersion\n   * @return {!Promise<!ExtensionDef>}\n   */\n  installExtensionForDoc(ampdoc, extensionId, opt_extensionVersion) {\n    const rootNode = ampdoc.getRootNode();\n    let extLoaders = rootNode[LOADER_PROP];\n    if (!extLoaders) {\n      extLoaders = rootNode[LOADER_PROP] = map();\n    }\n    if (extLoaders[extensionId]) {\n      return extLoaders[extensionId];\n    }\n    stubElementIfNotKnown(ampdoc.win, extensionId);\n    return (extLoaders[extensionId] = this.preloadExtension(\n      extensionId,\n      opt_extensionVersion\n    ).then(() => this.installExtensionInDoc(ampdoc, extensionId)));\n  }\n\n  /**\n   * Reloads the new version of the extension.\n   * @param {string} extensionId\n   * @return {!Promise<!ExtensionDef>}\n   */\n  reloadExtension(extensionId) {\n    // Ignore inserted script elements to prevent recursion.\n    const el = this.getExtensionScript_(\n      extensionId,\n      /* includeInserted */ false\n    );\n    devAssert(el, 'Cannot find script for extension: %s', extensionId);\n    // \"Disconnect\" the old script element and extension record.\n    const holder = this.extensions_[extensionId];\n    if (holder) {\n      devAssert(!holder.loaded && !holder.error);\n      delete this.extensions_[extensionId];\n    }\n    el.setAttribute('i-amphtml-loaded-new-version', extensionId);\n    const urlParts = parseExtensionUrl(el.src);\n    return this.preloadExtension(extensionId, urlParts.extensionVersion);\n  }\n\n  /**\n   * Returns the extension <script> element and attribute for the given\n   * extension ID, if it exists. Otherwise, returns null.\n   * @param {string} extensionId\n   * @param {boolean=} includeInserted If true, includes script elements that\n   *   are inserted by the runtime dynamically. Default is true.\n   * @return {?Element}\n   * @private\n   */\n  getExtensionScript_(extensionId, includeInserted = true) {\n    // Always ignore <script> elements that have a mismatched RTV.\n    const modifier =\n      ':not([i-amphtml-loaded-new-version])' +\n      (includeInserted ? '' : ':not([i-amphtml-inserted])');\n    return this.win.document.head./*OK*/ querySelector(\n      `script[src*=\"/${extensionId}-\"]` + modifier\n    );\n  }\n\n  /**\n   * Returns the promise that will be resolved with the extension element's\n   * class when the extension has been loaded. If necessary, adds the extension\n   * script to the page.\n   * @param {string} elementName\n   * @return {!Promise<function(new:../base-element.BaseElement, !Element)>}\n   */\n  loadElementClass(elementName) {\n    return this.preloadExtension(elementName).then(extension => {\n      const element = devAssert(\n        extension.elements[elementName],\n        'Element not found: %s',\n        elementName\n      );\n      return element.implementationClass;\n    });\n  }\n\n  /**\n   * Add an element to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {string} name\n   * @param {function(new:../base-element.BaseElement, !Element)} implementationClass\n   * @param {?string|undefined} css\n   * @restricted\n   */\n  addElement(name, implementationClass, css) {\n    const holder = this.getCurrentExtensionHolder_(name);\n    holder.extension.elements[name] = {implementationClass, css};\n    this.addDocFactory(ampdoc => {\n      this.installElement_(ampdoc, name, implementationClass, css);\n    });\n  }\n\n  /**\n   * Installs the specified element implementation in the ampdoc.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} name\n   * @param {!Function} implementationClass\n   * @param {?string|undefined} css\n   * @private\n   */\n  installElement_(ampdoc, name, implementationClass, css) {\n    if (css) {\n      installStylesForDoc(\n        ampdoc,\n        css,\n        () => {\n          this.registerElementInWindow_(ampdoc.win, name, implementationClass);\n        },\n        /* isRuntimeCss */ false,\n        name\n      );\n    } else {\n      this.registerElementInWindow_(ampdoc.win, name, implementationClass);\n    }\n  }\n\n  /**\n   * @param {!Window} win\n   * @param {string} name\n   * @param {!Function} implementationClass\n   * @private\n   */\n  registerElementInWindow_(win, name, implementationClass) {\n    // Register the element in the window.\n    upgradeOrRegisterElement(win, name, implementationClass);\n    // Register this extension to resolve its Service Promise.\n    registerServiceBuilder(win, name, emptyService);\n  }\n\n  /**\n   * Add a service to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {string} name\n   * @param {function(new:Object, !./ampdoc-impl.AmpDoc)} implementationClass\n   */\n  addService(name, implementationClass) {\n    const holder = this.getCurrentExtensionHolder_();\n    holder.extension.services.push(\n      /** @type {!ExtensionServiceDef} */ ({\n        serviceName: name,\n        serviceClass: implementationClass,\n      })\n    );\n    this.addDocFactory(ampdoc => {\n      registerServiceBuilderForDoc(\n        ampdoc,\n        name,\n        implementationClass,\n        /* instantiate */ true\n      );\n    });\n  }\n\n  /**\n   * Add a ampdoc factory to the extension currently being registered. This is a\n   * restricted method and it's allowed to be called only during the overall\n   * extension registration.\n   * @param {function(!./ampdoc-impl.AmpDoc)} factory\n   * @param {string=} opt_forName\n   * @restricted\n   */\n  addDocFactory(factory, opt_forName) {\n    const holder = this.getCurrentExtensionHolder_(opt_forName);\n    holder.docFactories.push(factory);\n\n    // If a single-doc mode, run factory right away if it's included by the doc.\n    if (this.currentExtensionId_ && this.ampdocService_.isSingleDoc()) {\n      const ampdoc = this.ampdocService_.getAmpDoc(this.win.document);\n      const extensionId = dev().assertString(this.currentExtensionId_);\n      // Note that this won't trigger for FIE extensions that are not present\n      // in the parent doc.\n      if (ampdoc.declaresExtension(extensionId) || holder.auto) {\n        factory(ampdoc);\n      }\n    }\n  }\n\n  /**\n   * Installs all ampdoc factories previously registered with\n   * `addDocFactory`.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Array<string>} extensionIds\n   * @return {!Promise}\n   * @restricted\n   */\n  installExtensionsInDoc(ampdoc, extensionIds) {\n    const promises = [];\n    extensionIds.forEach(extensionId => {\n      promises.push(this.installExtensionInDoc(ampdoc, extensionId));\n    });\n    return Promise.all(promises);\n  }\n\n  /**\n   * Installs all ampdoc factories for the specified extension.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {string} extensionId\n   * @return {!Promise}\n   */\n  installExtensionInDoc(ampdoc, extensionId) {\n    const holder = this.getExtensionHolder_(extensionId, /* auto */ false);\n    return this.waitFor_(holder).then(() => {\n      ampdoc.declareExtension(extensionId);\n      holder.docFactories.forEach(factory => {\n        try {\n          factory(ampdoc);\n        } catch (e) {\n          rethrowAsync('Doc factory failed: ', e, extensionId);\n        }\n      });\n    });\n  }\n\n  /**\n   * Creates or returns an existing extension holder.\n   * @param {string} extensionId\n   * @param {boolean} auto\n   * @return {!ExtensionHolderDef}\n   * @private\n   */\n  getExtensionHolder_(extensionId, auto) {\n    let holder = this.extensions_[extensionId];\n    if (!holder) {\n      const extension = /** @type {ExtensionDef} */ ({\n        elements: {},\n        services: [],\n      });\n      holder = /** @type {ExtensionHolderDef} */ ({\n        extension,\n        auto,\n        docFactories: [],\n        promise: undefined,\n        resolve: undefined,\n        reject: undefined,\n        loaded: undefined,\n        error: undefined,\n        scriptPresent: undefined,\n      });\n      this.extensions_[extensionId] = holder;\n    }\n    return holder;\n  }\n\n  /**\n   * Returns the holder for the extension currently being registered.\n   * @param {string=} opt_forName Used for logging only.\n   * @return {!ExtensionHolderDef}\n   * @private\n   */\n  getCurrentExtensionHolder_(opt_forName) {\n    if (!this.currentExtensionId_ && !getMode().test) {\n      dev().error(TAG, 'unknown extension for ', opt_forName);\n    }\n    return this.getExtensionHolder_(\n      this.currentExtensionId_ || UNKNOWN_EXTENSION,\n      /* auto */ true\n    );\n  }\n\n  /**\n   * Creates or returns an existing promise that will yield as soon as the\n   * extension has been loaded.\n   * @param {!ExtensionHolderDef} holder\n   * @return {!Promise<!ExtensionDef>}\n   * @private\n   */\n  waitFor_(holder) {\n    if (!holder.promise) {\n      if (holder.loaded) {\n        holder.promise = Promise.resolve(holder.extension);\n      } else if (holder.error) {\n        holder.promise = Promise.reject(holder.error);\n      } else {\n        const deferred = new Deferred();\n        holder.promise = deferred.promise;\n        holder.resolve = deferred.resolve;\n        holder.reject = deferred.reject;\n      }\n    }\n    return holder.promise;\n  }\n\n  /**\n   * Ensures that the script has already been injected in the page.\n   * @param {string} extensionId\n   * @param {!ExtensionHolderDef} holder\n   * @param {string=} opt_extensionVersion\n   * @private\n   */\n  insertExtensionScriptIfNeeded_(extensionId, holder, opt_extensionVersion) {\n    if (this.isExtensionScriptRequired_(extensionId, holder)) {\n      const scriptElement = this.createExtensionScript_(\n        extensionId,\n        opt_extensionVersion\n      );\n      this.win.document.head.appendChild(scriptElement);\n      holder.scriptPresent = true;\n    }\n  }\n\n  /**\n   * Determine the need to add amp extension script to document.\n   * @param {string} extensionId\n   * @param {!ExtensionHolderDef} holder\n   * @return {boolean}\n   * @private\n   */\n  isExtensionScriptRequired_(extensionId, holder) {\n    if (holder.loaded || holder.error) {\n      return false;\n    }\n    if (holder.scriptPresent === undefined) {\n      const scriptInHead = this.getExtensionScript_(extensionId);\n      holder.scriptPresent = !!scriptInHead;\n    }\n    return !holder.scriptPresent;\n  }\n\n  /**\n   * Create the missing amp extension HTML script element.\n   * @param {string} extensionId\n   * @param {string=} opt_extensionVersion\n   * @return {!Element} Script object\n   * @private\n   */\n  createExtensionScript_(extensionId, opt_extensionVersion) {\n    const scriptElement = this.win.document.createElement('script');\n    scriptElement.async = true;\n    if (isIntermediateExtension(extensionId)) {\n      opt_extensionVersion = '';\n    } else {\n      scriptElement.setAttribute(\n        this.attributeForExtension_(extensionId),\n        extensionId\n      );\n    }\n    scriptElement.setAttribute('data-script', extensionId);\n    scriptElement.setAttribute('i-amphtml-inserted', '');\n    let loc = this.win.location;\n    if (getMode().test && this.win.testLocation) {\n      loc = this.win.testLocation;\n    }\n    const scriptSrc = calculateExtensionScriptUrl(\n      loc,\n      extensionId,\n      opt_extensionVersion,\n      getMode().localDev\n    );\n    scriptElement.src = scriptSrc;\n    return scriptElement;\n  }\n\n  /**\n   * @param {string} extensionId\n   * @return {string}\n   * @private\n   */\n  attributeForExtension_(extensionId) {\n    return isTemplateExtension(extensionId)\n      ? 'custom-template'\n      : 'custom-element';\n  }\n}\n\n/**\n * @param {!Window} win\n */\nexport function stubLegacyElements(win) {\n  LEGACY_ELEMENTS.forEach(name => {\n    stubElementIfNotKnown(win, name);\n  });\n}\n\n/**\n * @return {!Object}\n */\nfunction emptyService() {\n  // All services need to resolve to an object.\n  return {};\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Pass} from '../pass';\nimport {Services} from '../services';\nimport {\n  assertDoesNotContainDisplay,\n  computedStyle,\n  getStyle,\n  getVendorJsPropertyName,\n  setImportantStyles,\n  setInitialDisplay,\n  setStyle,\n  setStyles,\n  toggle,\n} from '../style';\nimport {closest, domOrderComparator, matches} from '../dom';\nimport {dev, user} from '../log';\nimport {endsWith} from '../string';\nimport {isExperimentOn} from '../experiments';\nimport {remove} from '../utils/array';\n\nconst TAG = 'FixedLayer';\n\nconst DECLARED_FIXED_PROP = '__AMP_DECLFIXED';\nconst DECLARED_STICKY_PROP = '__AMP_DECLSTICKY';\n\nconst LIGHTBOX_MODE_ATTR = 'i-amphtml-lightbox';\nconst LIGHTBOX_ELEMENT_CLASS = 'i-amphtml-lightbox-element';\n\n/**\n * @param {!Element} el\n * @return {boolean}\n */\nfunction isLightbox(el) {\n  return el.tagName.indexOf('LIGHTBOX') !== -1;\n}\n\n/**\n * The fixed layer is a *sibling* of the body element. I.e. it's a direct\n * child of documentElement. It's used to manage the `position:fixed` and\n * `position:sticky` elements in iOS-iframe case due to the\n * https://bugs.webkit.org/show_bug.cgi?id=154399 bug, which is itself\n * a result of workaround for the issue where scrolling is not supported\n * in iframes (https://bugs.webkit.org/show_bug.cgi?id=149264).\n * This implementation finds all elements that could be `fixed` or `sticky`\n * and checks on major relayouts if they are indeed `fixed`/`sticky`.\n * Some `fixed` elements may be moved into the \"transfer layer\".\n */\nexport class FixedLayer {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!./vsync-impl.Vsync} vsync\n   * @param {number} borderTop\n   * @param {number} paddingTop\n   * @param {boolean} transfer\n   */\n  constructor(ampdoc, vsync, borderTop, paddingTop, transfer) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @private @const */\n    this.vsync_ = vsync;\n\n    /** @const @private {number} */\n    this.borderTop_ = borderTop;\n\n    /** @private {number} */\n    this.paddingTop_ = paddingTop;\n\n    /** @private {number} */\n    this.committedPaddingTop_ = paddingTop;\n\n    /** @private @const {boolean} */\n    this.transfer_ = transfer && ampdoc.isSingleDoc();\n\n    /** @private {?TransferLayerDef} */\n    this.transferLayer_ = null;\n\n    /** @private {number} */\n    this.counter_ = 0;\n\n    /** @const @private {!Array<!ElementDef>} */\n    this.elements_ = [];\n\n    /** @const @private {!Pass} */\n    this.updatePass_ = new Pass(ampdoc.win, () => {\n      this.update();\n    });\n\n    /** @private {?function()} */\n    this.hiddenObserverUnlistener_ = null;\n\n    /** @private {!Array<string>} */\n    this.fixedSelectors_ = [];\n\n    /** @private {!Array<string>} */\n    this.stickySelectors_ = [];\n  }\n\n  /**\n   * Informs FixedLayer that a lightbox was opened.\n   *\n   * - FixedLayer hides any transfer layer elements that may be overlayed on\n   *   top of the lightbox, which is confusing UX.\n   * - When `onComplete` resolves, FixedLayer scans and transfers any fixed\n   *   descendants of `lightbox`. This enables unjanky fixed elements in\n   *   lightboxes on iOS.\n   *\n   * @param {!Element=} opt_lightbox\n   * @param {!Promise=} opt_onComplete Promise that resolves when lightbox\n   *   UX completes e.g. open transition animation.\n   */\n  enterLightbox(opt_lightbox, opt_onComplete) {\n    const transferLayer = this.getTransferLayer_();\n    if (transferLayer) {\n      transferLayer.setLightboxMode(true);\n    }\n\n    if (opt_lightbox && opt_onComplete) {\n      opt_onComplete.then(() => {\n        this.scanNode_(\n          dev().assertElement(opt_lightbox),\n          /* lightboxMode */ true\n        );\n      });\n    }\n  }\n\n  /**\n   * Reverses the actions performed by `enterLightbox()`.\n   */\n  leaveLightbox() {\n    const transferLayer = this.getTransferLayer_();\n    if (transferLayer) {\n      transferLayer.setLightboxMode(false);\n    }\n\n    const fes = remove(this.elements_, fe => !!fe.lightboxed);\n    this.returnFixedElements_(fes);\n    if (!this.elements_.length) {\n      this.unobserveHiddenMutations_();\n    }\n  }\n\n  /**\n   * Must be always called after DOMReady.\n   */\n  setup() {\n    const root = this.ampdoc.getRootNode();\n    const stylesheets = root.styleSheets;\n    if (!stylesheets) {\n      return;\n    }\n\n    this.fixedSelectors_.length = 0;\n    this.stickySelectors_.length = 0;\n\n    for (let i = 0; i < stylesheets.length; i++) {\n      const stylesheet = stylesheets[i];\n      // Rare but may happen if the document is being concurrently disposed.\n      if (!stylesheet) {\n        dev().error(TAG, 'Aborting setup due to null stylesheet.');\n        return;\n      }\n      const {disabled, ownerNode} = stylesheet;\n      if (\n        disabled ||\n        !ownerNode ||\n        ownerNode.tagName != 'STYLE' ||\n        ownerNode.hasAttribute('amp-boilerplate') ||\n        ownerNode.hasAttribute('amp-runtime') ||\n        ownerNode.hasAttribute('amp-extension')\n      ) {\n        continue;\n      }\n      // Don't dereference cssRules early to avoid \"Cannot access rules\"\n      // DOMException due to reading a CORS stylesheet e.g. font.\n      this.discoverSelectors_(stylesheet.cssRules);\n    }\n\n    this.scanNode_(root);\n\n    if (this.elements_.length > 0) {\n      this.observeHiddenMutations();\n    }\n\n    const platform = Services.platformFor(this.ampdoc.win);\n    if (this.elements_.length > 0 && !this.transfer_ && platform.isIos()) {\n      user().warn(\n        TAG,\n        'Please test this page inside of an AMP Viewer such' +\n          \" as Google's because the fixed or sticky positioning might have\" +\n          ' slightly different layout.'\n      );\n    }\n  }\n\n  /**\n   * @param {!Node} node\n   * @param {boolean=} opt_lightboxMode\n   * @private\n   */\n  scanNode_(node, opt_lightboxMode) {\n    this.trySetupSelectors_(node, opt_lightboxMode);\n\n    // Sort tracked elements in document order.\n    this.sortInDomOrder_();\n\n    this.update();\n  }\n\n  /**\n   * Begin observing changes to the hidden attribute.\n   * @visibleForTesting\n   */\n  observeHiddenMutations() {\n    if (!isExperimentOn(this.ampdoc.win, 'hidden-mutation-observer')) {\n      return;\n    }\n    this.initHiddenObserver_();\n  }\n\n  /**\n   * Stop observing changes to the hidden attribute.\n   */\n  unobserveHiddenMutations_() {\n    this.updatePass_.cancel();\n    const unlisten = this.hiddenObserverUnlistener_;\n    if (unlisten) {\n      unlisten();\n      this.hiddenObserverUnlistener_ = null;\n    }\n  }\n\n  /**\n   * Start observing changes to the hidden attribute, if we haven't already\n   * started.\n   */\n  initHiddenObserver_() {\n    if (this.hiddenObserverUnlistener_) {\n      return;\n    }\n\n    const root = this.ampdoc.getRootNode();\n    const element = root.documentElement || root;\n    const hiddenObserver = Services.hiddenObserverForDoc(element);\n    this.hiddenObserverUnlistener_ = hiddenObserver.add(() => {\n      if (!this.updatePass_.isPending()) {\n        // Wait one animation frame so that other mutations may arrive.\n        this.updatePass_.schedule(16);\n      }\n    });\n  }\n\n  /**\n   * Updates the viewer's padding-top position and recalculates offsets of\n   * all elements. The padding update can be transient, in which case the\n   * UI itself is not updated leaving the blank space up top, which is invisible\n   * due to scroll position. This mode saves significant resources. However,\n   * eventhough layout is not updated, the fixed/sticky coordinates still need\n   * to be recalculated.\n   * @param {number} paddingTop\n   * @param {boolean} opt_transient\n   */\n  updatePaddingTop(paddingTop, opt_transient) {\n    this.paddingTop_ = paddingTop;\n    if (!opt_transient) {\n      this.committedPaddingTop_ = paddingTop;\n    }\n    this.update();\n  }\n\n  /**\n   * Apply or reset transform style to fixed elements. The existing transition,\n   * if any, is disabled when custom transform is supplied.\n   * @param {?string} transform\n   */\n  transformMutate(transform) {\n    // Unfortunately, we can't do anything with sticky elements here. Updating\n    // `top` in animation frames causes reflow on all platforms and we can't\n    // determine whether an element is currently docked to apply transform.\n    if (transform) {\n      // Apply transform style to all fixed elements\n      this.elements_.forEach(e => {\n        if (e.fixedNow && e.top) {\n          setStyle(e.element, 'transition', 'none');\n          if (e.transform && e.transform != 'none') {\n            setStyle(e.element, 'transform', e.transform + ' ' + transform);\n          } else {\n            setStyle(e.element, 'transform', transform);\n          }\n        }\n      });\n    } else {\n      // Reset transform style to all fixed elements\n      this.elements_.forEach(e => {\n        if (e.fixedNow && e.top) {\n          setStyles(e.element, {\n            transform: '',\n            transition: '',\n          });\n        }\n      });\n    }\n  }\n\n  /**\n   * Adds the element directly into the fixed/sticky layer, bypassing discovery.\n   * @param {!Element} element\n   * @param {boolean=} opt_forceTransfer If set to true, then the element needs\n   *    to be forcefully transferred to the transfer layer. If false, then it\n   *    will only receive top-padding compensation for the header and never be\n   *    transferred.\n   * @return {!Promise}\n   */\n  addElement(element, opt_forceTransfer) {\n    const added = this.setupElement_(\n      element,\n      /* selector */ '*',\n      /* position */ 'fixed',\n      opt_forceTransfer\n    );\n    if (!added) {\n      return Promise.resolve();\n    }\n    this.sortInDomOrder_();\n\n    // If this is the first element, we need to start the mutation observer.\n    // This'll only be created once.\n    this.observeHiddenMutations();\n\n    return this.update();\n  }\n\n  /**\n   * Removes the element from the fixed/sticky layer.\n   * @param {!Element} element\n   */\n  removeElement(element) {\n    const fes = this.tearDownElement_(element);\n    this.returnFixedElements_(fes);\n  }\n\n  /**\n   * Returns fixed elements from the transfer layer.\n   * @param {!Array<ElementDef>} fes\n   * @private\n   */\n  returnFixedElements_(fes) {\n    if (fes.length > 0 && this.transferLayer_) {\n      this.vsync_.mutate(() => {\n        for (let i = 0; i < fes.length; i++) {\n          const fe = fes[i];\n          if (fe.position == 'fixed') {\n            this.transferLayer_.returnFrom(fe);\n          }\n        }\n      });\n    }\n  }\n\n  /**\n   * Whether the element is declared as fixed in any of the user's stylesheets.\n   * Will include any matches, not necessarily currently fixed elements.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  isDeclaredFixed(element) {\n    return !!element[DECLARED_FIXED_PROP];\n  }\n\n  /**\n   * Whether the element is declared as sticky in any of the user's stylesheets.\n   * Will include any matches, not necessarily currently sticky elements.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  isDeclaredSticky(element) {\n    return !!element[DECLARED_STICKY_PROP];\n  }\n\n  /**\n   * Performs fixed/sticky actions.\n   * 1. Updates `top` styling if necessary.\n   * 2. On iOS/Iframe moves elements between fixed layer and BODY depending on\n   * whether they are currently visible and fixed\n   * @return {!Promise}\n   */\n  update() {\n    // Some of the elements may no longer be in DOM.\n    /** @type {!Array<!ElementDef>} */\n    const toRemove = this.elements_.filter(\n      fe => !this.ampdoc.contains(fe.element)\n    );\n    toRemove.forEach(fe => this.tearDownElement_(fe.element));\n\n    if (this.elements_.length == 0) {\n      return Promise.resolve();\n    }\n\n    // Clear out the update pass since we're doing the work now.\n    this.updatePass_.cancel();\n\n    // Next, the positioning-related properties will be measured. If a\n    // potentially fixed/sticky element turns out to be actually fixed/sticky,\n    // it will be decorated and possibly moved to a separate layer.\n    let hasTransferables = false;\n    return this.vsync_\n      .runPromise(\n        {\n          measure: state => {\n            const elements = this.elements_;\n            const autoTops = [];\n            const {win} = this.ampdoc;\n\n            // Notice that this code intentionally breaks vsync contract.\n            // Unfortunately, there's no way to reliably test whether or not\n            // `top` has been set to a non-auto value on all platforms. To work\n            // this around, this code compares `style.top` values with a new\n            // `style.bottom` value.\n            // 1. Unset top from previous mutates and set bottom to an extremely\n            // large value (to catch cases where sticky-tops are in a long way\n            // down inside a scroller).\n            for (let i = 0; i < elements.length; i++) {\n              setImportantStyles(elements[i].element, {\n                top: '',\n                bottom: '-9999vh',\n                transition: 'none',\n              });\n            }\n            // 2. Capture the `style.top` with this new `style.bottom` value. If\n            // this element has a non-auto top, this value will remain constant\n            // regardless of bottom.\n            for (let i = 0; i < elements.length; i++) {\n              autoTops.push(computedStyle(win, elements[i].element).top);\n            }\n            // 3. Cleanup the `style.bottom`.\n            for (let i = 0; i < elements.length; i++) {\n              setStyle(elements[i].element, 'bottom', '');\n            }\n\n            for (let i = 0; i < elements.length; i++) {\n              const fe = elements[i];\n              const {element, forceTransfer} = fe;\n              const style = computedStyle(win, element);\n\n              const {offsetWidth, offsetHeight, offsetTop} = element;\n              const {position = '', display = '', bottom, zIndex} = style;\n              const opacity = parseFloat(style.opacity);\n              const transform =\n                style[getVendorJsPropertyName(style, 'transform')];\n              let {top} = style;\n\n              const isFixed =\n                position === 'fixed' &&\n                (forceTransfer || (offsetWidth > 0 && offsetHeight > 0));\n              const isSticky = endsWith(position, 'sticky');\n              const isDisplayed = display !== 'none';\n\n              if (!isDisplayed || !(isFixed || isSticky)) {\n                state[fe.id] = {\n                  fixed: false,\n                  sticky: false,\n                  transferrable: false,\n                  top: '',\n                  zIndex: '',\n                };\n                continue;\n              }\n\n              if (top === 'auto' || autoTops[i] !== top) {\n                if (\n                  isFixed &&\n                  offsetTop === this.committedPaddingTop_ + this.borderTop_\n                ) {\n                  top = '0px';\n                } else {\n                  top = '';\n                }\n              }\n\n              // Transferability requires an element to be:\n              // 1. Greater than 0% opacity. That's a lot of work for no benefit.\n              //    Additionally, transparent elements used for \"service\" needs and\n              //    thus best kept in the original tree. The visibility, however,\n              //    is not considered because `visibility` CSS is inherited.\n              // 2. Height < 300. This avoids transferring large sections of UI,\n              //    e.g. publisher-customized amp-consent UI (#17995).\n              // 3. Has `top` or `bottom` CSS set. This ensures we only transfer\n              //    fixed elements that are _not_ auto-positioned to avoid jumping\n              //    position after transferring to the fixed layer (due to loss of\n              //    parent positioning context). We could calculate this offset, but\n              //    we don't (yet).\n              let isTransferrable = false;\n              if (isFixed) {\n                if (forceTransfer === true) {\n                  isTransferrable = true;\n                } else if (forceTransfer === false) {\n                  isTransferrable = false;\n                } else {\n                  isTransferrable =\n                    opacity > 0 && offsetHeight < 300 && !!(top || bottom);\n                }\n              }\n              if (isTransferrable) {\n                hasTransferables = true;\n              }\n              state[fe.id] = {\n                fixed: isFixed,\n                sticky: isSticky,\n                transferrable: isTransferrable,\n                top,\n                zIndex,\n                transform,\n              };\n            }\n          },\n          mutate: state => {\n            if (hasTransferables && this.transfer_) {\n              this.getTransferLayer_().update();\n            }\n            const elements = this.elements_;\n            for (let i = 0; i < elements.length; i++) {\n              const fe = elements[i];\n              const feState = state[fe.id];\n\n              // Fix a bug with Safari. For some reason, you cannot unset\n              // transition when it's important. You can, however, set it to a valid\n              // non-important value, then unset it.\n              setStyle(fe.element, 'transition', 'none');\n              // Note: This MUST be done after measurements are taken.\n              // Transitions will mess up everything and, depending on when paints\n              // happen, mutates of transition and bottom at the same time may be\n              // make the transition active.\n              setStyle(fe.element, 'transition', '');\n\n              if (feState) {\n                this.mutateElement_(fe, i, feState);\n              }\n            }\n          },\n        },\n        {}\n      )\n      .catch(error => {\n        // Fail silently.\n        dev().error(TAG, 'Failed to mutate fixed elements:', error);\n      });\n  }\n\n  /**\n   * Calls `setupSelectors_` in a try-catch.\n   * Fails quietly with a dev error if call fails.\n   * This method should not be inlined to prevent TryCatch deoptimization.\n   * @param {!Node} root\n   * @param {boolean=} opt_lightboxMode\n   * @private\n   * @noinline\n   */\n  trySetupSelectors_(root, opt_lightboxMode) {\n    try {\n      this.setupSelectors_(root, opt_lightboxMode);\n    } catch (e) {\n      // Fail quietly.\n      dev().error(TAG, 'Failed to setup fixed elements:', e);\n    }\n  }\n\n  /**\n   * Calls `setupElement_` for up to 10 elements matching each selector\n   * in `fixedSelectors` and for all selectors in `stickySelectors`.\n   * @param {!Node} root\n   * @param {boolean=} opt_lightboxMode\n   * @private\n   */\n  setupSelectors_(root, opt_lightboxMode) {\n    for (let i = 0; i < this.fixedSelectors_.length; i++) {\n      const fixedSelector = this.fixedSelectors_[i];\n      const elements = root.querySelectorAll(fixedSelector);\n      for (let j = 0; j < elements.length; j++) {\n        if (this.elements_.length > 10) {\n          // We shouldn't have too many of `fixed` elements.\n          break;\n        }\n        this.setupElement_(\n          elements[j],\n          fixedSelector,\n          'fixed',\n          /* opt_forceTransfer */ undefined,\n          opt_lightboxMode\n        );\n      }\n    }\n    for (let i = 0; i < this.stickySelectors_.length; i++) {\n      const stickySelector = this.stickySelectors_[i];\n      const elements = root.querySelectorAll(stickySelector);\n      for (let j = 0; j < elements.length; j++) {\n        this.setupElement_(\n          elements[j],\n          stickySelector,\n          'sticky',\n          /* opt_forceTransfer */ undefined,\n          opt_lightboxMode\n        );\n      }\n    }\n  }\n\n  /**\n   * If the given element has a `style` attribute with a top/bottom CSS rule,\n   * display a user error. FixedLayer's implementation currently overrides\n   * top, bottom and a few other CSS rules.\n   * @param {!Element} element\n   * @private\n   */\n  warnAboutInlineStylesIfNecessary_(element) {\n    if (\n      element.hasAttribute('style') &&\n      (getStyle(element, 'top') || getStyle(element, 'bottom'))\n    ) {\n      user().error(\n        TAG,\n        'Inline styles with `top`, `bottom` and other ' +\n          'CSS rules are not supported yet for fixed or sticky elements ' +\n          '(#14186). Unexpected behavior may occur.',\n        element\n      );\n    }\n  }\n\n  /**\n   * This method records the potentially fixed or sticky element. One of a more\n   * critical functions - it records all selectors that may apply \"fixed\"\n   * or \"sticky\" to this element to check them later.\n   *\n   * @param {!Element} element\n   * @param {string} selector\n   * @param {string} position\n   * @param {boolean=} opt_forceTransfer If true, then the element will\n   *    be forcibly transferred to the transfer layer.\n   * @param {boolean=} opt_lightboxMode If true, then descendants of lightboxes\n   *    are allowed to be set up. Default is false.\n   * @return {boolean}\n   * @private\n   */\n  setupElement_(\n    element,\n    selector,\n    position,\n    opt_forceTransfer,\n    opt_lightboxMode\n  ) {\n    // Warn that pub-authored inline styles may be overriden by FixedLayer.\n    if (!opt_forceTransfer) {\n      this.warnAboutInlineStylesIfNecessary_(element);\n    }\n\n    // Ignore lightboxes because FixedLayer can interfere with their\n    // opening/closing animations (#19149).\n    if (isLightbox(element)) {\n      return false;\n    }\n    const isLightboxDescendant = closest(element, isLightbox);\n    if (!opt_lightboxMode && isLightboxDescendant) {\n      return false;\n    }\n\n    const elements = this.elements_;\n\n    // Avoid ancestor-descendant relationships in tracked elements to prevent\n    // \"double top-offset\" (#22860).\n    const removals = [];\n    for (let i = 0; i < elements.length; i++) {\n      const el = elements[i].element;\n      if (el === element) {\n        break;\n      }\n      // Early exit if element is a child of an already-tracked element...\n      if (el.contains(element)) {\n        return false;\n      }\n      // Remove the already-tracked element if it is a child of the new\n      // element...\n      if (element.contains(el)) {\n        removals.push(el);\n      }\n    }\n    for (let i = 0; i < removals.length; i++) {\n      this.removeElement(removals[i]);\n    }\n\n    let fe = null;\n    for (let i = 0; i < elements.length; i++) {\n      const el = elements[i];\n      if (el.element == element && el.position == position) {\n        fe = el;\n        break;\n      }\n    }\n    const isFixed = position == 'fixed';\n    if (fe) {\n      if (!fe.selectors.includes(selector)) {\n        // Already seen.\n        fe.selectors.push(selector);\n      }\n    } else {\n      // A new entry.\n      const id = 'F' + this.counter_++;\n      element.setAttribute('i-amphtml-fixedid', id);\n      if (isFixed) {\n        element[DECLARED_FIXED_PROP] = true;\n      } else {\n        element[DECLARED_STICKY_PROP] = true;\n      }\n      fe = {\n        id,\n        element,\n        position,\n        selectors: [selector],\n        fixedNow: false,\n        stickyNow: false,\n        lightboxed: !!isLightboxDescendant,\n      };\n      elements.push(fe);\n    }\n\n    fe.forceTransfer = isFixed ? opt_forceTransfer : false;\n    return true;\n  }\n\n  /**\n   * Undoes set up by removing element record and and resets `top` style.\n   * Does _not_ return the element from the transfer layer.\n   *\n   * @param {!Element} element\n   * @return {!Array<!ElementDef>}\n   * @private\n   */\n  tearDownElement_(element) {\n    const removed = [];\n    for (let i = 0; i < this.elements_.length; i++) {\n      const fe = this.elements_[i];\n      if (fe.element === element) {\n        if (!fe.lightboxed) {\n          this.vsync_.mutate(() => {\n            setStyle(element, 'top', '');\n          });\n        }\n        this.elements_.splice(i, 1);\n        removed.push(fe);\n      }\n    }\n    if (!this.elements_.length) {\n      this.unobserveHiddenMutations_();\n    }\n    return removed;\n  }\n\n  /**\n   * @private\n   */\n  sortInDomOrder_() {\n    this.elements_.sort((fe1, fe2) => {\n      return domOrderComparator(fe1.element, fe2.element);\n    });\n  }\n\n  /**\n   * Mutates the fixed/sticky element. At this point it's determined that the\n   * element is indeed fixed/sticky. There are two main functions here:\n   *  1. `top` has to be updated to reflect viewer's paddingTop.\n   *  2. The element may need to be transfered to the separate fixed layer.\n   *\n   * @param {!ElementDef} fe\n   * @param {number} index\n   * @param {!ElementStateDef} state\n   * @private\n   */\n  mutateElement_(fe, index, state) {\n    const {element, fixedNow: oldFixed} = fe;\n\n    fe.fixedNow = state.fixed;\n    fe.stickyNow = state.sticky;\n    fe.top = state.fixed || state.sticky ? state.top : '';\n    fe.transform = state.transform;\n\n    // Move back to the BODY layer and reset transfer z-index.\n    if (\n      oldFixed &&\n      (!state.fixed || !state.transferrable) &&\n      this.transferLayer_\n    ) {\n      this.transferLayer_.returnFrom(fe);\n    }\n\n    // Update `top` to adjust position to the viewer's paddingTop. However,\n    // ignore lightboxed elements since lightboxes ignore the viewer header.\n    if (state.top && (state.fixed || state.sticky) && !fe.lightboxed) {\n      if (state.fixed || !this.transfer_) {\n        // Fixed positions always need top offsetting, as well as stickies on\n        // non iOS Safari.\n        setStyle(element, 'top', `calc(${state.top} + ${this.paddingTop_}px)`);\n      } else {\n        // On iOS Safari (this.transfer_ = true), stickies cannot\n        // have an offset because they are already offset by the padding-top.\n        if (this.committedPaddingTop_ === this.paddingTop_) {\n          // So, when the header is shown, just use top.\n          setStyle(element, 'top', state.top);\n        } else {\n          // When the header is not shown, we need to subtract the padding top.\n          setStyle(\n            element,\n            'top',\n            `calc(${state.top} - ${this.committedPaddingTop_}px)`\n          );\n        }\n      }\n    }\n\n    // Move element to the fixed layer.\n    if (this.transfer_ && state.fixed && state.transferrable) {\n      this.getTransferLayer_().transferTo(fe, index, state);\n    }\n  }\n\n  /**\n   * @return {?TransferLayerDef}\n   */\n  getTransferLayer_() {\n    // This mode is only allowed for a single-doc case.\n    if (!this.transfer_ || this.transferLayer_) {\n      return this.transferLayer_;\n    }\n    const doc = this.ampdoc.win.document;\n    this.transferLayer_ = doc.body.shadowRoot\n      ? new TransferLayerShadow(doc, this.vsync_)\n      : new TransferLayerBody(doc, this.vsync_);\n    return this.transferLayer_;\n  }\n\n  /**\n   * Find all `position:fixed` and `position:sticky` elements.\n   * @param {!Array<CSSRule>} rules\n   * @private\n   */\n  discoverSelectors_(rules) {\n    for (let i = 0; i < rules.length; i++) {\n      const rule = rules[i];\n      if (\n        rule.type == /* CSSMediaRule */ 4 ||\n        rule.type == /* CSSSupportsRule */ 12\n      ) {\n        this.discoverSelectors_(rule.cssRules);\n        continue;\n      }\n\n      if (rule.type == /* CSSStyleRule */ 1) {\n        const {selectorText} = rule;\n        const {position} = rule.style;\n        if (selectorText === '*' || !position) {\n          continue;\n        }\n        if (position === 'fixed') {\n          this.fixedSelectors_.push(selectorText);\n        } else if (endsWith(position, 'sticky')) {\n          this.stickySelectors_.push(selectorText);\n        }\n      }\n    }\n  }\n}\n\n/**\n * @typedef {{\n *   id: string,\n *   selectors: !Array,\n *   element: !Element,\n *   position: string,\n *   placeholder: (?Element|undefined),\n *   fixedNow: boolean,\n *   stickyNow: boolean,\n *   top: (string|undefined),\n *   transform: (string|undefined),\n *   forceTransfer: (boolean|undefined),\n *   lightboxed: (boolean|undefined),\n * }}\n */\nlet ElementDef;\n\n/**\n * @typedef {{\n *   fixed: boolean,\n *   sticky: boolean,\n *   transferrable: boolean,\n *   top: string,\n *   zIndex: string,\n * }}\n */\nlet ElementStateDef;\n\n/**\n * The contract for transfer layer.\n * @interface\n */\nclass TransferLayerDef {\n  /**\n   * @return {!Element}\n   */\n  getRoot() {}\n\n  /**\n   * Update most current styles for the transfer layer.\n   */\n  update() {}\n\n  /**\n   * Toggles internal state after entering or leaving lightbox mode.\n   * @param {boolean} unusedOn\n   */\n  setLightboxMode(unusedOn) {}\n\n  /**\n   * Transfer the element from the body into the transfer layer.\n   * @param {!ElementDef} unusedFe\n   * @param {number} unusedIndex\n   * @param {!ElementStateDef} unusedState\n   */\n  transferTo(unusedFe, unusedIndex, unusedState) {}\n\n  /**\n   * Return the element from the transfer layer back to the body.\n   * @param {!ElementDef} unusedFe\n   */\n  returnFrom(unusedFe) {}\n}\n\n/**\n * The parallel `<body>` element is created and fixed elements are moved into\n * this element.\n * @implements {TransferLayerDef}\n */\nclass TransferLayerBody {\n  /**\n   * @param {!Document} doc\n   * @param {!./vsync-impl.Vsync} vsync\n   */\n  constructor(doc, vsync) {\n    /** @private @const {!Document} */\n    this.doc_ = doc;\n\n    /** @private @const {!./vsync-impl.Vsync} */\n    this.vsync_ = vsync;\n\n    /** @private @const {!Element} */\n    this.layer_ = doc.body.cloneNode(/* deep */ false);\n    this.layer_.removeAttribute('style');\n    const styles = {\n      position: 'absolute',\n      top: 0,\n      left: 0,\n      height: 0,\n      width: 0,\n      pointerEvents: 'none',\n      overflow: 'hidden',\n      // Reset possible BODY styles.\n      animation: 'none',\n      background: 'none',\n      border: 'none',\n      borderImage: 'none',\n      boxSizing: 'border-box',\n      boxShadow: 'none',\n      float: 'none',\n      margin: 0,\n      opacity: 1,\n      outline: 'none',\n      padding: 'none',\n      transform: 'none',\n      transition: 'none',\n    };\n    setStyles(this.layer_, assertDoesNotContainDisplay(styles));\n    setInitialDisplay(this.layer_, 'block');\n    doc.documentElement.appendChild(this.layer_);\n  }\n\n  /** @override */\n  getRoot() {\n    return this.layer_;\n  }\n\n  /** @override */\n  setLightboxMode(on) {\n    this.vsync_.mutate(() => {\n      const root = this.getRoot();\n      if (on) {\n        root.setAttribute(LIGHTBOX_MODE_ATTR, '');\n      } else {\n        root.removeAttribute(LIGHTBOX_MODE_ATTR);\n      }\n    });\n  }\n\n  /**\n   * Synchronizes any attribute mutations done on the real body to the layer.\n   * This is to better simulate the body in CSS selectors.\n   * @override\n   */\n  update() {\n    const {body} = this.doc_;\n    const layer = this.layer_;\n    const bodyAttrs = body.attributes;\n    const layerAttrs = layer.attributes;\n    for (let i = 0; i < bodyAttrs.length; i++) {\n      const attr = bodyAttrs[i];\n      // Style is not copied because the fixed-layer must have very precise\n      // styles to enable smooth scrolling.\n      if (attr.name === 'style') {\n        continue;\n      }\n      // Use cloneNode to get around invalid attribute names. Ahem, amp-bind.\n      layerAttrs.setNamedItem(attr.cloneNode(false));\n    }\n    for (let i = 0; i < layerAttrs.length; i++) {\n      const {name} = layerAttrs[i];\n      if (\n        name === 'style' ||\n        name === LIGHTBOX_MODE_ATTR ||\n        body.hasAttribute(name)\n      ) {\n        continue;\n      }\n      layer.removeAttribute(name);\n      i--;\n    }\n  }\n\n  /** @override */\n  transferTo(fe, index, state) {\n    const {element} = fe;\n    if (element.parentElement == this.layer_) {\n      return;\n    }\n\n    dev().fine(TAG, 'transfer to fixed:', fe.id, fe.element);\n    user().warn(\n      TAG,\n      'In order to improve scrolling performance in Safari,' +\n        ' we now move the element to a fixed positioning layer:',\n      fe.element\n    );\n\n    if (!fe.placeholder) {\n      // Never been transfered before: ensure that it's properly configured.\n      setStyle(element, 'pointer-events', 'initial');\n      const placeholder = (fe.placeholder = this.doc_.createElement(\n        'i-amphtml-fpa'\n      ));\n      toggle(placeholder, false);\n      placeholder.setAttribute('i-amphtml-fixedid', fe.id);\n    }\n\n    // Calculate z-index based on the declared z-index and DOM position.\n    setStyle(\n      element,\n      'zIndex',\n      `calc(${10000 + index} + ${state.zIndex || 0})`\n    );\n\n    // Identify lightboxed elements so they can be visible when the transfer\n    // layer is \"hidden\", and hidden with the transfer layer is \"visible\".\n    if (fe.lightboxed) {\n      element.classList.add(LIGHTBOX_ELEMENT_CLASS);\n    }\n\n    element.parentElement.replaceChild(fe.placeholder, element);\n    this.layer_.appendChild(element);\n\n    // Test if the element still matches one of the `fixed` selectors. If not\n    // return it back to BODY.\n    const matches = fe.selectors.some(selector =>\n      this.matches_(element, selector)\n    );\n    if (!matches) {\n      user().warn(\n        TAG,\n        'Failed to move the element to the fixed position layer.' +\n          ' This is most likely due to the compound CSS selector:',\n        fe.element\n      );\n      this.returnFrom(fe);\n    }\n  }\n\n  /** @override */\n  returnFrom(fe) {\n    if (!fe.placeholder || !this.doc_.contains(fe.placeholder)) {\n      return;\n    }\n    const {element, placeholder} = fe;\n    dev().fine(TAG, 'return from fixed:', fe.id, element);\n\n    if (fe.lightboxed) {\n      element.classList.remove(LIGHTBOX_ELEMENT_CLASS);\n    }\n\n    if (this.doc_.contains(element)) {\n      setStyle(fe.element, 'zIndex', '');\n      placeholder.parentElement.replaceChild(element, placeholder);\n    } else {\n      placeholder.parentElement.removeChild(placeholder);\n    }\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {string} selector\n   * @return {boolean}\n   * @private\n   */\n  matches_(element, selector) {\n    try {\n      return matches(element, selector);\n    } catch (e) {\n      // Fail silently.\n      dev().error(TAG, 'Failed to test query match:', e);\n      return false;\n    }\n  }\n}\n\nconst FIXED_LAYER_SLOT = 'i-amphtml-fixed';\n\n/**\n * The fixed layer is created inside the shadow root of the `<body>` element\n * and fixed elements are distributed into this element via slots.\n * @implements {TransferLayerDef}\n */\nclass TransferLayerShadow {\n  /**\n   * @param {!Document} doc\n   * @param {!./vsync-impl.Vsync} vsync\n   */\n  constructor(doc, vsync) {\n    /** @private @const {!./vsync-impl.Vsync} */\n    this.vsync_ = vsync;\n\n    /** @private @const {!Element} */\n    this.layer_ = doc.createElement('div');\n    this.layer_.id = 'i-amphtml-fixed-layer';\n    setImportantStyles(this.layer_, {\n      position: 'absolute',\n      top: 0,\n      left: 0,\n      height: 0,\n      width: 0,\n      overflow: 'hidden',\n    });\n\n    // The slot where all fixed elements will be distributed.\n    const slot = doc.createElement('slot');\n    slot.setAttribute('name', FIXED_LAYER_SLOT);\n    this.layer_.appendChild(slot);\n\n    doc.body.shadowRoot.appendChild(this.layer_);\n  }\n\n  /** @override */\n  getRoot() {\n    return this.layer_;\n  }\n\n  /** @override */\n  setLightboxMode(on) {\n    this.vsync_.mutate(() => {\n      setStyle(this.getRoot(), 'visibility', on ? 'hidden' : 'visible');\n    });\n  }\n\n  /** @override */\n  update() {\n    // Nothing to do.\n  }\n\n  /** @override */\n  transferTo(fe) {\n    const {element} = fe;\n\n    dev().fine(TAG, 'transfer to fixed:', fe.id, fe.element);\n    user().warn(\n      TAG,\n      'In order to improve scrolling performance in Safari,' +\n        ' we now move the element to a fixed positioning layer:',\n      fe.element\n    );\n\n    // Distribute to the slot.\n    element.setAttribute('slot', FIXED_LAYER_SLOT);\n  }\n\n  /** @override */\n  returnFrom(fe) {\n    dev().fine(TAG, 'return from fixed:', fe.id, fe.element);\n    fe.element.removeAttribute('slot');\n  }\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from '../observable';\nimport {devAssert} from '../log';\nimport {\n  installServiceInEmbedScope,\n  registerServiceBuilderForDoc,\n} from '../service';\n\n/**\n * MutationObserverInit options to listen for mutations to the `hidden`\n * attribute.\n */\nconst OBSERVER_OPTIONS = {\n  attributes: true,\n  attributeFilter: ['hidden'],\n  subtree: true,\n};\n\n/**\n * A document level service that will listen for mutations on the `hidden`\n * attribute and notify listeners. The `hidden` attribute is used to toggle\n * `display: none` on elements.\n * @implements {../service.EmbeddableService}\n * @implements {../service.Disposable}\n */\nexport class HiddenObserver {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_root\n   */\n  constructor(ampdoc, opt_root) {\n    // TODO(#22733): remove subroooting once ampdoc-fie is launched.\n\n    /** @const {!Document|!ShadowRoot} */\n    this.root_ = opt_root || ampdoc.getRootNode();\n    const doc = this.root_.ownerDocument || this.root_;\n\n    /** @const {!Window} */\n    this.win_ = /** @type {!Window} */ (devAssert(doc.defaultView));\n\n    /** @private {?MutationObserver} */\n    this.mutationObserver_ = null;\n\n    /** @private {?Observable<!Array<!MutationRecord>>} */\n    this.observable_ = null;\n  }\n\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n  static installInEmbedWindow(embedWin, ampdoc) {\n    installServiceInEmbedScope(\n      embedWin,\n      'hidden-observer',\n      new HiddenObserver(ampdoc, embedWin.document)\n    );\n  }\n\n  /**\n   * Adds the observer to this instance.\n   * @param {function(!Array<!MutationRecord>)} handler Observer's handler.\n   * @return {!UnlistenDef}\n   */\n  add(handler) {\n    this.init_();\n\n    const remove = this.observable_.add(handler);\n    return () => {\n      remove();\n      if (this.observable_.getHandlerCount() === 0) {\n        this.dispose();\n      }\n    };\n  }\n\n  /**\n   * Initializes the mutation observer and observable.\n   */\n  init_() {\n    if (this.mutationObserver_) {\n      return;\n    }\n    this.observable_ = new Observable();\n\n    const mo = new this.win_.MutationObserver(mutations => {\n      if (mutations) {\n        this.observable_.fire(mutations);\n      }\n    });\n    this.mutationObserver_ = mo;\n    mo.observe(this.root_, OBSERVER_OPTIONS);\n  }\n\n  /**\n   * Cleans up the all the mutation observer once the last listener stops\n   * listening, or when the service's doc is disposing.\n   */\n  dispose() {\n    if (!this.mutationObserver_) {\n      return;\n    }\n    this.mutationObserver_.disconnect();\n    this.observable_.removeAll();\n    this.mutationObserver_ = null;\n    this.observable_ = null;\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installHiddenObserverForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'hidden-observer', HiddenObserver);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred, tryResolve} from '../utils/promise';\nimport {Services} from '../services';\nimport {dev, devAssert} from '../log';\nimport {dict, map} from '../utils/object';\nimport {getMode} from '../mode';\nimport {\n  getService,\n  registerServiceBuilder,\n  registerServiceBuilderForDoc,\n} from '../service';\nimport {getState} from '../history';\n\n/** @private @const {string} */\nconst TAG_ = 'History';\n\n/** @private @const {string} */\nconst HISTORY_PROP_ = 'AMP.History';\n\n/** @typedef {number} */\nlet HistoryIdDef;\n\n/**\n * @typedef {{stackIndex: HistoryIdDef, title: string, fragment: string, data: (!JsonObject|undefined)}}\n */\nlet HistoryStateDef;\n\n/**\n * @typedef {{title: (string|undefined), fragment: (string|undefined), url: (string|undefined), canonicalUrl: (string|undefined), data: (!JsonObject|undefined)}}\n */\nlet HistoryStateUpdateDef;\n\n/**\n * Wraps the browser's History API for viewer support and necessary polyfills.\n */\nexport class History {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!HistoryBindingInterface} binding\n   */\n  constructor(ampdoc, binding) {\n    /** @private @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private @const {!../service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(ampdoc.win);\n\n    /** @private @const {!HistoryBindingInterface} */\n    this.binding_ = binding;\n\n    /** @private {number} */\n    this.stackIndex_ = 0;\n\n    /** @private {!Array<!Function|undefined>} */\n    this.stackOnPop_ = [];\n\n    /**\n     * @private {!Array<!{\n     *   callback: function():!Promise,\n     *   resolve: !Function,\n     *   reject: !Function,\n     *   trace: (!Error|undefined)\n     * }>} */\n    this.queue_ = [];\n\n    this.binding_.setOnStateUpdated(this.onStateUpdated_.bind(this));\n  }\n\n  /** @visibleForTesting */\n  cleanup() {\n    this.binding_.cleanup();\n  }\n\n  /**\n   * Pushes new state into history stack with an optional callback to be called\n   * when this state is popped as well as an object with updates to be applied\n   * to the state.\n   * @param {!Function=} opt_onPop\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryIdDef>}\n   */\n  push(opt_onPop, opt_stateUpdate) {\n    return this.enque_(() => {\n      return this.binding_.push(opt_stateUpdate).then(historyState => {\n        this.onStateUpdated_(historyState);\n        if (opt_onPop) {\n          this.stackOnPop_[historyState.stackIndex] = opt_onPop;\n        }\n        return historyState.stackIndex;\n      });\n    }, 'push');\n  }\n\n  /**\n   * Pops a previously pushed state from the history stack. If onPop callback\n   * has been registered, it will be called with the state that was associated\n   * with the new head state within the history stack. All states coming\n   * after the supplied state will also be popped, and their\n   * callbacks executed in the same fashion.\n   * @param {!HistoryIdDef} stateId\n   * @return {!Promise}\n   */\n  pop(stateId) {\n    return this.enque_(() => {\n      return this.binding_.pop(stateId).then(historyState => {\n        this.onStateUpdated_(historyState);\n      });\n    }, 'pop');\n  }\n\n  /**\n   * Replaces the current state, optionally specifying updates to the state\n   * object to be associated with the replacement.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise}\n   */\n  replace(opt_stateUpdate) {\n    return this.enque_(() => this.binding_.replace(opt_stateUpdate), 'replace');\n  }\n\n  /**\n   * Retrieves the current state, containing the current fragment, title,\n   * and amp-bind state.\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  get() {\n    return this.enque_(() => this.binding_.get(), 'get');\n  }\n\n  /**\n   * Requests navigation one step back. This request is only satisifed\n   * when the history has at least one step to go back in the context\n   * of this document.\n   * @return {!Promise}\n   */\n  goBack() {\n    return this.enque_(() => {\n      if (this.stackIndex_ <= 0) {\n        // Nothing left to pop.\n        return Promise.resolve();\n      }\n      // Pop the current state. The binding will ignore the request if\n      // it cannot satisfy it.\n      return this.binding_.pop(this.stackIndex_).then(historyState => {\n        this.onStateUpdated_(historyState);\n      });\n    }, 'goBack');\n  }\n\n  /**\n   * Helper method to handle navigation to a local target, e.g. When a user\n   * clicks an anchor link to a local hash - <a href=\"#section1\">Go to section\n   * 1</a>.\n   *\n   * @param {string} target\n   * @return {!Promise}\n   */\n  replaceStateForTarget(target) {\n    devAssert(target[0] == '#', 'target should start with a #');\n    const previousHash = this.ampdoc_.win.location.hash;\n    return this.push(() => {\n      this.ampdoc_.win.location.replace(previousHash || '#');\n    }).then(() => {\n      this.binding_.replaceStateForTarget(target);\n    });\n  }\n\n  /**\n   * Get the fragment from the url or the viewer.\n   * Strip leading '#' in the fragment\n   * @return {!Promise<string>}\n   */\n  getFragment() {\n    return this.binding_.getFragment();\n  }\n\n  /**\n   * Update the page url fragment\n   * @param {string} fragment\n   * @return {!Promise}\n   */\n  updateFragment(fragment) {\n    if (fragment[0] == '#') {\n      fragment = fragment.substr(1);\n    }\n    return this.binding_.updateFragment(fragment);\n  }\n\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  onStateUpdated_(historyState) {\n    this.stackIndex_ = historyState.stackIndex;\n    this.doPop_(historyState);\n  }\n\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  doPop_(historyState) {\n    if (this.stackIndex_ >= this.stackOnPop_.length - 1) {\n      return;\n    }\n\n    const toPop = [];\n    for (let i = this.stackOnPop_.length - 1; i > this.stackIndex_; i--) {\n      if (this.stackOnPop_[i]) {\n        toPop.push(this.stackOnPop_[i]);\n        this.stackOnPop_[i] = undefined;\n      }\n    }\n    this.stackOnPop_.splice(this.stackIndex_ + 1);\n\n    if (toPop.length > 0) {\n      for (let i = 0; i < toPop.length; i++) {\n        // With the same delay timeouts must observe the order, although\n        // there's no hard requirement in this case to follow the pop order.\n        this.timer_.delay(() => toPop[i](historyState), 1);\n      }\n    }\n  }\n\n  /**\n   * @param {function():!Promise<RESULT>} callback\n   * @param {string} name\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   * @private\n   */\n  enque_(callback, name) {\n    const deferred = new Deferred();\n    const {promise, resolve, reject} = deferred;\n\n    // TODO(dvoytenko, #8785): cleanup after tracing.\n    const trace = new Error('history trace for ' + name + ': ');\n    this.queue_.push({callback, resolve, reject, trace});\n    if (this.queue_.length == 1) {\n      this.deque_();\n    }\n    return promise;\n  }\n\n  /**\n   * @private\n   */\n  deque_() {\n    if (this.queue_.length == 0) {\n      return;\n    }\n\n    const task = this.queue_[0];\n    let promise;\n    try {\n      promise = task.callback();\n    } catch (e) {\n      promise = Promise.reject(e);\n    }\n\n    promise\n      .then(\n        result => {\n          task.resolve(result);\n        },\n        reason => {\n          dev().error(TAG_, 'failed to execute a task:', reason);\n          // TODO(dvoytenko, #8785): cleanup after tracing.\n          if (task.trace) {\n            task.trace.message += reason;\n            dev().error(TAG_, task.trace);\n          }\n          task.reject(reason);\n        }\n      )\n      .then(() => {\n        this.queue_.splice(0, 1);\n        this.deque_();\n      });\n  }\n}\n\n/**\n * HistoryBindingInterface is an interface that defines an underlying technology\n * behind the {@link History}.\n * @interface\n */\nclass HistoryBindingInterface {\n  /** @protected */\n  cleanup() {}\n\n  /**\n   * Configures a callback to be called when the state has been updated.\n   * @param {function(!HistoryStateDef)} unusedCallback\n   * @protected\n   */\n  setOnStateUpdated(unusedCallback) {}\n\n  /**\n   * Pushes a new state onto the history stack, optionally specifying the state\n   * object associated with the current state.\n   * Returns a promise that yields the new state.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  push(opt_stateUpdate) {}\n\n  /**\n   * Pops a previously pushed state from the history stack. All history\n   * states coming after this state will also be popped.\n   * Returns a promise that yields the new state.\n   * @param {number} unusedStackIndex\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  pop(unusedStackIndex) {}\n\n  /**\n   * Replaces the current state, optionally specifying updates to the state\n   * object to be associated with the replacement.\n   * Returns a promise that yields the new state.\n   * @param {!HistoryStateUpdateDef=} opt_stateUpdate\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  replace(opt_stateUpdate) {}\n\n  /**\n   * Retrieves the current state, containing the current fragment, title,\n   * and amp-bind state.\n   * @return {!Promise<!HistoryStateDef>}\n   */\n  get() {}\n\n  /**\n   * Replaces the state for local target navigation.\n   * @param {string} unusedTarget\n   */\n  replaceStateForTarget(unusedTarget) {}\n\n  /**\n   * Get the fragment from the url or the viewer.\n   * Strip leading '#' in the fragment\n   * @return {!Promise<string>}\n   */\n  getFragment() {}\n\n  /**\n   * Update the page url fragment\n   * @param {string} unusedFragment\n   * @return {!Promise}\n   */\n  updateFragment(unusedFragment) {}\n}\n\n/**\n * Implementation of HistoryBindingInterface based on the native window. It uses\n * window.history properties and events.\n *\n * Visible for testing.\n *\n * @implements {HistoryBindingInterface}\n */\nexport class HistoryBindingNatural_ {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!../service/timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n\n    const {history} = this.win;\n\n    /** @private {number} */\n    this.startIndex_ = history.length - 1;\n    const state = getState(history);\n    if (state && state[HISTORY_PROP_] !== undefined) {\n      this.startIndex_ = Math.min(state[HISTORY_PROP_], this.startIndex_);\n    }\n\n    /** @private {number} */\n    this.stackIndex_ = this.startIndex_;\n\n    /**\n     * @private {{promise: !Promise, resolve: !Function,\n     *   reject: !Function}|undefined}\n     */\n    this.waitingState_;\n\n    /** @private {?function(!HistoryStateDef)} */\n    this.onStateUpdated_ = null;\n\n    // A number of browsers do not support history.state. In this cases,\n    // History will track its own version. See unsupportedState_.\n    /** @private {boolean} @const */\n    this.supportsState_ = 'state' in history;\n\n    /** @private {*} */\n    this.unsupportedState_ = this.historyState_(this.stackIndex_);\n\n    // There are still browsers who do not support push/replaceState.\n    let pushState, replaceState;\n    if (history.pushState && history.replaceState) {\n      /** @private @const {function(*, string=, string=)|undefined} */\n      this.origPushState_ =\n        history.originalPushState || history.pushState.bind(history);\n      /** @private @const {function(*, string=, string=)|undefined} */\n      this.origReplaceState_ =\n        history.originalReplaceState || history.replaceState.bind(history);\n      pushState = (state, opt_title, opt_url) => {\n        this.unsupportedState_ = state;\n        this.origPushState_(\n          state,\n          opt_title,\n          // A bug in edge causes paths to become undefined if URL is\n          // undefined, filed here: https://goo.gl/KlImZu\n          opt_url || null\n        );\n      };\n      replaceState = (state, opt_title, opt_url) => {\n        this.unsupportedState_ = state;\n        // NOTE: check for `undefined` since IE11 and Edge\n        // unexpectedly coerces it into a `string`.\n        if (opt_url !== undefined) {\n          this.origReplaceState_(state, opt_title, opt_url);\n        } else {\n          this.origReplaceState_(state, opt_title);\n        }\n      };\n      if (!history.originalPushState) {\n        history.originalPushState = this.origPushState_;\n      }\n      if (!history.originalReplaceState) {\n        history.originalReplaceState = this.origReplaceState_;\n      }\n    } else {\n      pushState = (state, opt_title, opt_url) => {\n        this.unsupportedState_ = state;\n      };\n      replaceState = (state, opt_title, opt_url) => {\n        this.unsupportedState_ = state;\n      };\n    }\n\n    /** @private @const {!Function} */\n    this.pushState_ = pushState;\n\n    /** @private @const {!Function} */\n    this.replaceState_ = replaceState;\n\n    try {\n      this.replaceState_(\n        this.historyState_(this.stackIndex_, /* replace */ true)\n      );\n    } catch (e) {\n      dev().error(TAG_, 'Initial replaceState failed: ' + e.message);\n    }\n\n    history.pushState = this.historyPushState_.bind(this);\n    history.replaceState = this.historyReplaceState_.bind(this);\n\n    this.popstateHandler_ = e => {\n      const event = /** @type {!PopStateEvent} */ (e);\n      const state = /** @type {!JsonObject} */ (event.state);\n      dev().fine(\n        TAG_,\n        'popstate event: ' +\n          this.win.history.length +\n          ', ' +\n          JSON.stringify(state)\n      );\n      this.onHistoryEvent_();\n    };\n    this.win.addEventListener('popstate', this.popstateHandler_);\n  }\n\n  /** @override */\n  cleanup() {\n    if (this.origPushState_) {\n      this.win.history.pushState = this.origPushState_;\n    }\n    if (this.origReplaceState_) {\n      this.win.history.replaceState = this.origReplaceState_;\n    }\n    this.win.removeEventListener('popstate', this.popstateHandler_);\n  }\n\n  /**\n   * @param {number} stackIndex\n   * @param {boolean=} opt_replace\n   * @return {*}\n   * @private\n   */\n  historyState_(stackIndex, opt_replace) {\n    const state = map(opt_replace ? this.getState_() : undefined);\n    state[HISTORY_PROP_] = stackIndex;\n    return state;\n  }\n\n  /** @override */\n  setOnStateUpdated(callback) {\n    this.onStateUpdated_ = callback;\n  }\n\n  /** @override */\n  push(opt_stateUpdate) {\n    return this.whenReady_(() => {\n      const newState = this.mergeStateUpdate_(\n        this.getState_(),\n        opt_stateUpdate || {}\n      );\n      this.historyPushState_(\n        newState,\n        /* title */ undefined,\n        newState.fragment ? '#' + newState.fragment : undefined\n      );\n      return tryResolve(() =>\n        this.mergeStateUpdate_(newState, {stackIndex: this.stackIndex_})\n      );\n    });\n  }\n\n  /** @override */\n  pop(stackIndex) {\n    // On pop, stack is not allowed to go prior to the starting point.\n    stackIndex = Math.max(stackIndex, this.startIndex_);\n    return this.whenReady_(() => {\n      return this.back_(this.stackIndex_ - stackIndex + 1);\n    }).then(newStackIndex => {\n      return this.mergeStateUpdate_(this.getState_(), {\n        stackIndex: newStackIndex,\n      });\n    });\n  }\n\n  /** @override */\n  replace(opt_stateUpdate = {}) {\n    return this.whenReady_(() => {\n      const newState = this.mergeStateUpdate_(\n        this.getState_(),\n        opt_stateUpdate || {}\n      );\n      const url = (newState.url || '').replace(/#.*/, '');\n      const fragment = newState.fragment ? '#' + newState.fragment : '';\n      this.historyReplaceState_(\n        newState,\n        newState.title,\n        url || fragment ? url + fragment : undefined\n      );\n      return tryResolve(() =>\n        this.mergeStateUpdate_(newState, {stackIndex: this.stackIndex_})\n      );\n    });\n  }\n\n  /** @override */\n  get() {\n    return tryResolve(() =>\n      this.mergeStateUpdate_(this.getState_(), {\n        stackIndex: this.stackIndex_,\n      })\n    );\n  }\n\n  /**\n   * @param {number} stackIndex\n   * @return {!Promise}\n   */\n  backTo(stackIndex) {\n    // On pop, stack is not allowed to go prior to the starting point.\n    stackIndex = Math.max(stackIndex, this.startIndex_);\n    return this.whenReady_(() => {\n      return this.back_(this.stackIndex_ - stackIndex);\n    });\n  }\n\n  /** @private */\n  onHistoryEvent_() {\n    let state = this.getState_();\n    dev().fine(\n      TAG_,\n      'history event: ' + this.win.history.length + ', ' + JSON.stringify(state)\n    );\n    const stackIndex = state ? state[HISTORY_PROP_] : undefined;\n    let newStackIndex = this.stackIndex_;\n    const waitingState = this.waitingState_;\n    this.waitingState_ = undefined;\n\n    if (newStackIndex > this.win.history.length - 2) {\n      // Make sure stack has enough space. Whether we are going forward or\n      // backward, the stack should have at least one extra cell.\n      newStackIndex = this.win.history.length - 2;\n      this.updateHistoryState_(\n        this.mergeStateUpdate_(state, {stackIndex: newStackIndex})\n      );\n    }\n\n    if (stackIndex == undefined) {\n      // A new navigation forward by the user.\n      newStackIndex = newStackIndex + 1;\n    } else if (stackIndex < this.win.history.length) {\n      // A simple trip back.\n      newStackIndex = stackIndex;\n    } else {\n      // Generally not possible, but for posterity.\n      newStackIndex = this.win.history.length - 1;\n    }\n\n    // If state index has been updated as the result replace the state.\n    if (!state) {\n      state = {};\n    }\n    state[HISTORY_PROP_] = newStackIndex;\n    this.replaceState_(state, undefined, undefined);\n\n    // Update the stack, pop squeezed states.\n    if (newStackIndex != this.stackIndex_) {\n      this.updateHistoryState_(\n        this.mergeStateUpdate_(state, {stackIndex: newStackIndex})\n      );\n    }\n\n    // User navigation is allowed to move past the starting point of\n    // the history stack.\n    if (newStackIndex < this.startIndex_) {\n      this.startIndex_ = newStackIndex;\n    }\n\n    if (waitingState) {\n      waitingState.resolve();\n    }\n  }\n\n  /** @private */\n  getState_() {\n    if (this.supportsState_) {\n      return getState(this.win.history);\n    }\n    return this.unsupportedState_;\n  }\n\n  /** @private */\n  assertReady_() {\n    devAssert(\n      !this.waitingState_,\n      'The history must not be in the waiting state'\n    );\n  }\n\n  /**\n   * @param {function():!Promise<RESULT>} callback\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   * @private\n   */\n  whenReady_(callback) {\n    if (!this.waitingState_) {\n      return callback();\n    }\n    return this.waitingState_.promise.then(callback, callback);\n  }\n\n  /**\n   * @return {!Promise}\n   * @private\n   */\n  wait_() {\n    this.assertReady_();\n    const deferred = new Deferred();\n    const {resolve, reject} = deferred;\n    const promise = this.timer_.timeoutPromise(500, deferred.promise);\n    this.waitingState_ = {promise, resolve, reject};\n    return promise;\n  }\n\n  /**\n   * @param {number} steps\n   * @return {!Promise}\n   */\n  back_(steps) {\n    this.assertReady_();\n    if (steps <= 0) {\n      return Promise.resolve(this.stackIndex_);\n    }\n    this.unsupportedState_ = this.historyState_(this.stackIndex_ - steps);\n    const promise = this.wait_();\n    this.win.history.go(-steps);\n    return promise.then(() => {\n      return Promise.resolve(this.stackIndex_);\n    });\n  }\n\n  /**\n   * @param {*=} state\n   * @param {(string|undefined)=} title\n   * @param {(string|undefined)=} url\n   * @private\n   */\n  historyPushState_(state, title, url) {\n    this.assertReady_();\n    if (!state) {\n      state = {};\n    }\n    let stackIndex = this.stackIndex_ + 1;\n    state[HISTORY_PROP_] = stackIndex;\n    this.pushState_(state, title, url);\n    if (stackIndex != this.win.history.length - 1) {\n      stackIndex = this.win.history.length - 1;\n      state[HISTORY_PROP_] = stackIndex;\n      this.replaceState_(state);\n    }\n    const newState = this.mergeStateUpdate_(\n      /** @type {!HistoryStateDef} */ (state),\n      {stackIndex}\n    );\n    this.updateHistoryState_(newState);\n  }\n\n  /**\n   * If this is a hash update the choice of `location.replace` vs\n   * `history.replaceState` is important. Due to bugs, not every browser\n   * triggers `:target` pseudo-class when `replaceState` is called.\n   * See http://www.zachleat.com/web/moving-target/ for more details.\n   * location.replace will trigger a `popstate` event, we temporarily\n   * disable handling it.\n   * @param {string} target\n   *\n   * @override\n   */\n  replaceStateForTarget(target) {\n    devAssert(target[0] == '#', 'target should start with a #');\n    this.whenReady_(() => {\n      // location.replace will fire a popstate event which is not a history\n      // event, so temporarily remove the event listener and re-add it after.\n      // As explained above in the function comment, typically we'd just do\n      // replaceState here but in order to trigger :target re-eval we have to\n      // use location.replace.\n      this.win.removeEventListener('popstate', this.popstateHandler_);\n      try {\n        // TODO(mkhatib, #6095): Chrome iOS will add extra states for\n        // location.replace.\n        this.win.location.replace(target);\n      } finally {\n        this.win.addEventListener('popstate', this.popstateHandler_);\n      }\n      this.historyReplaceState_();\n      return Promise.resolve();\n    });\n  }\n\n  /**\n   * @param {*=} state\n   * @param {(string|undefined)=} title\n   * @param {(string|undefined)=} url\n   * @private\n   */\n  historyReplaceState_(state, title, url) {\n    this.assertReady_();\n    if (!state) {\n      state = {};\n    }\n    const stackIndex = Math.min(this.stackIndex_, this.win.history.length - 1);\n    state[HISTORY_PROP_] = stackIndex;\n    this.replaceState_(state, title, url);\n    const newState = this.mergeStateUpdate_(\n      /** @type {!HistoryStateDef} */ (state),\n      {stackIndex}\n    );\n    this.updateHistoryState_(newState);\n  }\n\n  /**\n   * @param {!HistoryStateDef} historyState\n   * @private\n   */\n  updateHistoryState_(historyState) {\n    this.assertReady_();\n    historyState.stackIndex = Math.min(\n      historyState.stackIndex,\n      this.win.history.length - 1\n    );\n    if (this.stackIndex_ != historyState.stackIndex) {\n      dev().fine(\n        TAG_,\n        'stack index changed: ' +\n          this.stackIndex_ +\n          ' -> ' +\n          historyState.stackIndex\n      );\n      this.stackIndex_ = historyState.stackIndex;\n      if (this.onStateUpdated_) {\n        this.onStateUpdated_(historyState);\n      }\n    }\n  }\n\n  /** @override */\n  getFragment() {\n    let {hash} = this.win.location;\n    /* Strip leading '#' */\n    hash = hash.substr(1);\n    return Promise.resolve(hash);\n  }\n\n  /** @override */\n  updateFragment(fragment) {\n    return this.replace({fragment});\n  }\n\n  /**\n   * @param {?HistoryStateDef} state\n   * @param {!HistoryStateUpdateDef} update\n   * @return {!HistoryStateDef}\n   */\n  mergeStateUpdate_(state, update) {\n    const mergedData = /** @type {!JsonObject} */ (Object.assign(\n      {},\n      (state && state.data) || {},\n      update.data || {}\n    ));\n    return /** @type {!HistoryStateDef} */ (Object.assign(\n      {},\n      state || {},\n      update,\n      {data: mergedData}\n    ));\n  }\n}\n\n/**\n * Implementation of HistoryBindingInterface that assumes a virtual history that\n * relies on viewer's \"pushHistory\", \"popHistory\" and \"historyPopped\"\n * protocol.\n *\n * Visible for testing.\n *\n * @implements {HistoryBindingInterface}\n */\nexport class HistoryBindingVirtual_ {\n  /**\n   * @param {!Window} win\n   * @param {!./viewer-interface.ViewerInterface} viewer\n   */\n  constructor(win, viewer) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!./viewer-interface.ViewerInterface} */\n    this.viewer_ = viewer;\n\n    /** @private {number} */\n    this.stackIndex_ = 0;\n\n    /** @private {?function(!HistoryStateDef)} */\n    this.onStateUpdated_ = null;\n\n    /** @private {!UnlistenDef} */\n    this.unlistenOnHistoryPopped_ = this.viewer_.onMessage(\n      'historyPopped',\n      data => this.onHistoryPopped_(data)\n    );\n  }\n\n  /** @override */\n  replaceStateForTarget(target) {\n    devAssert(target[0] == '#', 'target should start with a #');\n    this.win.location.replace(target);\n  }\n\n  /** @override */\n  cleanup() {\n    this.unlistenOnHistoryPopped_();\n  }\n\n  /** @override */\n  setOnStateUpdated(callback) {\n    this.onStateUpdated_ = callback;\n  }\n\n  /**\n   * Gets the history state from a response. This checks if `maybeHistoryState`\n   * is a history state, and returns it if so, falling back to `fallbackState`\n   * otherwise.\n   * @param {*} maybeHistoryState\n   * @param {!HistoryStateDef} fallbackState\n   * @param {string} debugId\n   * @return {!HistoryStateDef}\n   * @private\n   */\n  toHistoryState_(maybeHistoryState, fallbackState, debugId) {\n    if (this.isHistoryState_(maybeHistoryState)) {\n      return /** @type {!HistoryStateDef} */ (maybeHistoryState);\n    } else {\n      dev().warn(\n        TAG_,\n        'Ignored unexpected \"%s\" data:',\n        debugId,\n        maybeHistoryState\n      );\n    }\n    return fallbackState;\n  }\n\n  /**\n   * @param {*} maybeHistoryState\n   * @return {boolean}\n   */\n  isHistoryState_(maybeHistoryState) {\n    return !!maybeHistoryState && maybeHistoryState['stackIndex'] !== undefined;\n  }\n\n  /**\n   * `pushHistory`\n   *\n   *   Request:  {'stackIndex': string}\n   *   Response: undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  push(opt_stateUpdate) {\n    const message = /** @type {!JsonObject} */ (Object.assign(\n      {'stackIndex': this.stackIndex_ + 1},\n      opt_stateUpdate || {}\n    ));\n    const push = 'pushHistory';\n    return this.viewer_\n      .sendMessageAwaitResponse(push, message)\n      .then(response => {\n        const fallbackState = /** @type {!HistoryStateDef} */ (message);\n        const newState = this.toHistoryState_(response, fallbackState, push);\n        this.updateHistoryState_(newState);\n        return newState;\n      });\n  }\n\n  /**\n   * `popHistory`\n   *\n   *   Request:  {'stackIndex': string}\n   *   Response: undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  pop(stackIndex) {\n    if (stackIndex > this.stackIndex_) {\n      return this.get();\n    }\n    const message = dict({'stackIndex': this.stackIndex_});\n    const pop = 'popHistory';\n    return this.viewer_\n      .sendMessageAwaitResponse(pop, message)\n      .then(response => {\n        const fallbackState = /** @type {!HistoryStateDef} */ (dict({\n          'stackIndex': this.stackIndex_ - 1,\n        }));\n        const newState = this.toHistoryState_(response, fallbackState, pop);\n        this.updateHistoryState_(newState);\n        return newState;\n      });\n  }\n\n  /**\n   * `replaceHistory`\n   *\n   *   Request:   {'fragment': string}\n   *   Response:  undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  replace(opt_stateUpdate) {\n    if (opt_stateUpdate && opt_stateUpdate.url) {\n      if (!this.viewer_.hasCapability('fullReplaceHistory')) {\n        // Full URL replacement requested, but not supported by the viewer.\n        // Don't update, and return the current state.\n        const curState = /** @type {!HistoryStateDef} */ (dict({\n          'stackIndex': this.stackIndex_,\n        }));\n        return Promise.resolve(curState);\n      }\n\n      // replace fragment, only explicit fragment param will be sent.\n      const url = opt_stateUpdate.url.replace(/#.*/, '');\n      opt_stateUpdate.url = url;\n    }\n\n    const message = /** @type {!JsonObject} */ (Object.assign(\n      {'stackIndex': this.stackIndex_},\n      opt_stateUpdate || {}\n    ));\n    const replace = 'replaceHistory';\n    return this.viewer_\n      .sendMessageAwaitResponse(replace, message, /* cancelUnsent */ true)\n      .then(response => {\n        const fallbackState = /** @type {!HistoryStateDef} */ (message);\n        const newState = this.toHistoryState_(response, fallbackState, replace);\n        this.updateHistoryState_(newState);\n        return newState;\n      });\n  }\n\n  /**\n   * Note: Only returns the current `stackIndex`.\n   * @override\n   */\n  get() {\n    // Not sure why this type coercion is necessary, but CC complains otherwise.\n    return Promise.resolve(\n      /** @type {!HistoryStateDef} */ ({\n        data: undefined,\n        fragment: '',\n        stackIndex: this.stackIndex_,\n        title: '',\n      })\n    );\n  }\n\n  /**\n   * `historyPopped` (from viewer)\n   *\n   *   Request:  {'newStackIndex': number} | {'stackIndex': number}\n   *   Response: undefined\n   *\n   * @param {!JsonObject} data\n   * @private\n   */\n  onHistoryPopped_(data) {\n    if (data['newStackIndex'] !== undefined) {\n      data['stackIndex'] = data['newStackIndex'];\n    }\n    if (this.isHistoryState_(data)) {\n      this.updateHistoryState_(/** @type {!HistoryStateDef} */ (data));\n    } else {\n      dev().warn(TAG_, 'Ignored unexpected \"historyPopped\" data:', data);\n    }\n  }\n\n  /**\n   * @param {!HistoryStateDef} state\n   * @private\n   */\n  updateHistoryState_(state) {\n    const {stackIndex} = state;\n    if (this.stackIndex_ != stackIndex) {\n      dev().fine(TAG_, `stackIndex: ${this.stackIndex_} -> ${stackIndex}`);\n      this.stackIndex_ = stackIndex;\n      if (this.onStateUpdated_) {\n        this.onStateUpdated_(state);\n      }\n    }\n  }\n\n  /**\n   * `getFragment`\n   *\n   *   Request:  undefined\n   *   Response: string\n   *\n   * @override\n   */\n  getFragment() {\n    if (!this.viewer_.hasCapability('fragment')) {\n      return Promise.resolve('');\n    }\n    return this.viewer_\n      .sendMessageAwaitResponse(\n        'getFragment',\n        undefined,\n        /* cancelUnsent */ true\n      )\n      .then(data => {\n        if (!data) {\n          return '';\n        }\n        let hash = dev().assertString(data);\n        /* Strip leading '#'*/\n        if (hash[0] == '#') {\n          hash = hash.substr(1);\n        }\n        return hash;\n      });\n  }\n\n  /**\n   * `replaceHistory`\n   *\n   *   Request:   {'fragment': string}\n   *   Response:  undefined | {'stackIndex': string}\n   *\n   * @override\n   */\n  updateFragment(fragment) {\n    if (!this.viewer_.hasCapability('fragment')) {\n      return Promise.resolve();\n    }\n    return /** @type {!Promise} */ (this.viewer_.sendMessageAwaitResponse(\n      'replaceHistory',\n      dict({'fragment': fragment}),\n      /* cancelUnsent */ true\n    ));\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @return {!History}\n * @private\n */\nfunction createHistory(ampdoc) {\n  const viewer = Services.viewerForDoc(ampdoc);\n  let binding;\n  if (\n    viewer.isOvertakeHistory() ||\n    getMode(ampdoc.win).test ||\n    ampdoc.win.__AMP_TEST_IFRAME\n  ) {\n    binding = new HistoryBindingVirtual_(ampdoc.win, viewer);\n  } else {\n    // Only one global \"natural\" binding is allowed since it works with the\n    // global history stack.\n    registerServiceBuilder(\n      ampdoc.win,\n      'global-history-binding',\n      HistoryBindingNatural_\n    );\n    binding = getService(ampdoc.win, 'global-history-binding');\n  }\n  return new History(ampdoc, binding);\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installHistoryServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'history', createHistory);\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {dev} from '../log';\n\nconst TAG = 'ie-media-bug';\n\n/**\n * An ugly fix for IE's problem with `matchMedia` API, where media queries\n * are evaluated incorrectly. See #2577 for more details. Returns the promise\n * that will be resolved when the bug is fixed.\n * @param {!Window} win\n * @param {!../service/platform-impl.Platform=} opt_platform\n * @return {?Promise}\n * @package\n */\nexport function checkAndFix(win, opt_platform) {\n  const platform = opt_platform || Services.platformFor(win);\n  if (!platform.isIe() || matchMediaIeQuite(win)) {\n    return null;\n  }\n\n  // Poll until the expression resolves correctly, but only up to a point.\n  return new Promise(resolve => {\n    /** @const {number} */\n    const endTime = Date.now() + 2000;\n    /** @const {number} */\n    const interval = win.setInterval(() => {\n      const now = Date.now();\n      const matches = matchMediaIeQuite(win);\n      if (matches || now > endTime) {\n        win.clearInterval(interval);\n        resolve();\n        if (!matches) {\n          dev().error(TAG, 'IE media never resolved');\n        }\n      }\n    }, 10);\n  });\n}\n\n/**\n * @param {!Window} win\n * @return {boolean}\n * @private\n */\nfunction matchMediaIeQuite(win) {\n  // The expression is `min-width <= W <= max-width`.\n  // In IE `min-width: X` actually compares string `<`, thus we add -1 to\n  // `min-width` and add +1 to `max-width`. Given the expression above, it's\n  // a non-essential correction by 1px.\n  const q =\n    `(min-width: ${win./*OK*/ innerWidth - 1}px)` +\n    ` AND (max-width: ${win./*OK*/ innerWidth + 1}px)`;\n  try {\n    return win.matchMedia(q).matches;\n  } catch (e) {\n    dev().error(TAG, 'IE matchMedia failed: ', e);\n    // Return `true` to avoid polling on a broken API.\n    return true;\n  }\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {dev, user} from '../log';\nimport {htmlFor} from '../static-template';\nimport {isExperimentOn} from '../experiments';\n\n/** @const {number} */\nconst NTH_FRAME = 200;\n\nexport class JankMeter {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @private {!Window} */\n    this.win_ = win;\n    /** @private {number} */\n    this.badFrameCnt_ = 0;\n    /** @private {number} */\n    this.totalFrameCnt_ = 0;\n    /** @private {number} */\n    this.longTaskChild_ = 0;\n    /** @private {number} */\n    this.longTaskSelf_ = 0;\n    /** @private {?number} */\n    this.scheduledTime_ = null;\n    /** @private {?./performance-impl.Performance} */\n    this.perf_ = Services.performanceForOrNull(win);\n\n    /** @private {?BatteryManager} */\n    this.batteryManager_ = null;\n    /** @private {?number} */\n    this.batteryLevelStart_ = null;\n    this.initializeBatteryManager_();\n\n    /** @private {?PerformanceObserver} */\n    this.longTaskObserver_ = null;\n    this.initializeLongTaskObserver_();\n  }\n\n  /**\n   * Callback for scheduled.\n   */\n  onScheduled() {\n    if (!this.isEnabled_()) {\n      return;\n    }\n    // only take the first schedule for the current frame.\n    if (this.scheduledTime_ == null) {\n      this.scheduledTime_ = this.win_.Date.now();\n    }\n  }\n\n  /**\n   * Callback for run.\n   */\n  onRun() {\n    if (!this.isEnabled_() || this.scheduledTime_ == null) {\n      return;\n    }\n    const paintLatency = this.win_.Date.now() - this.scheduledTime_;\n    this.scheduledTime_ = null;\n    this.totalFrameCnt_++;\n    if (paintLatency > 16) {\n      this.badFrameCnt_++;\n      dev().info('JANK', 'Paint latency: ' + paintLatency + 'ms');\n    }\n\n    // Report metrics on Nth frame, so we have sort of normalized numbers.\n    if (this.perf_ && this.totalFrameCnt_ == NTH_FRAME) {\n      // gfp: Good Frame Probability\n      const gfp = this.calculateGfp_();\n      this.perf_.tickDelta('gfp', gfp);\n      // bf: Bad Frames\n      this.perf_.tickDelta('bf', this.badFrameCnt_);\n      if (this.longTaskObserver_) {\n        // lts: Long Tasks of Self frame\n        this.perf_.tickDelta('lts', this.longTaskSelf_);\n        // ltc: Long Tasks of Child frames\n        this.perf_.tickDelta('ltc', this.longTaskChild_);\n        this.longTaskObserver_.disconnect();\n        this.longTaskObserver_ = null;\n      }\n      let batteryDrop = 0;\n      if (this.batteryManager_ && this.batteryLevelStart_ != null) {\n        batteryDrop = this.win_.Math.max(\n          0,\n          this.win_.Math.floor(\n            this.batteryManager_.level * 100 - this.batteryLevelStart_\n          )\n        );\n        // bd: Battery Drop\n        this.perf_.tickDelta('bd', batteryDrop);\n      }\n      this.perf_.flush();\n      if (isJankMeterEnabled(this.win_)) {\n        this.displayMeterDisplay_(batteryDrop);\n      }\n    }\n  }\n\n  /**\n   * Returns if is enabled\n   *\n   * @return {?boolean}\n   */\n  isEnabled_() {\n    return (\n      isJankMeterEnabled(this.win_) ||\n      (this.perf_ &&\n        this.perf_.isPerformanceTrackingOn() &&\n        this.totalFrameCnt_ < NTH_FRAME)\n    );\n  }\n\n  /**\n   * @param {number} batteryDrop\n   * @private\n   */\n  displayMeterDisplay_(batteryDrop) {\n    const doc = this.win_.document;\n    const display = htmlFor(doc)`\n      <div class=\"i-amphtml-jank-meter\"></div>`;\n    display.textContent =\n      `bf:${this.badFrameCnt_}, lts: ${this.longTaskSelf_}, ` +\n      `ltc:${this.longTaskChild_}, bd:${batteryDrop}`;\n    doc.body.appendChild(display);\n  }\n\n  /**\n   * Calculate Good Frame Probability, which is a value range from 0 to 100.\n   * @return {number}\n   * @private\n   */\n  calculateGfp_() {\n    return this.win_.Math.floor(\n      ((this.totalFrameCnt_ - this.badFrameCnt_) / this.totalFrameCnt_) * 100\n    );\n  }\n\n  /**\n   * Initializes long task observer.\n   */\n  initializeLongTaskObserver_() {\n    if (!this.isEnabled_() || !isLongTaskApiSupported(this.win_)) {\n      return;\n    }\n    this.longTaskObserver_ = new this.win_.PerformanceObserver(entryList => {\n      const entries = entryList.getEntries();\n      for (let i = 0; i < entries.length; i++) {\n        if (entries[i].entryType == 'longtask') {\n          // longtask is any task with duration of bigger than 50ms\n          // we sum up the number of 50ms a task spans.\n          const span = this.win_.Math.floor(entries[i].duration / 50);\n          if (entries[i].name == 'cross-origin-descendant') {\n            this.longTaskChild_ += span;\n            user().info(\n              'LONGTASK',\n              `from child frame ${entries[i].duration}ms`\n            );\n          } else {\n            this.longTaskSelf_ += span;\n            dev().info('LONGTASK', `from self frame ${entries[i].duration}ms`);\n          }\n        }\n      }\n    });\n    this.longTaskObserver_.observe({entryTypes: ['longtask']});\n  }\n\n  /**\n   * Initializes battery manager.\n   */\n  initializeBatteryManager_() {\n    if (isBatteryApiSupported(this.win_)) {\n      this.win_.navigator.getBattery().then(battery => {\n        this.batteryManager_ = battery;\n        this.batteryLevelStart_ = battery.level * 100;\n      });\n    }\n  }\n}\n\n/**\n * @param {!Window} win\n * @return {boolean}\n */\nfunction isJankMeterEnabled(win) {\n  return isExperimentOn(win, 'jank-meter');\n}\n\n/**\n * @param {!Window} win\n * @return {boolean}\n */\nexport function isLongTaskApiSupported(win) {\n  return (\n    !!win.PerformanceObserver &&\n    !!win['TaskAttributionTiming'] &&\n    'containerName' in win['TaskAttributionTiming'].prototype\n  );\n}\n\n/**\n * @param {!Window} unusedWin\n * @return {boolean}\n */\nfunction isBatteryApiSupported(unusedWin) {\n  // TODO: (@lannka, #9749)\n  return false;\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* eslint-disable no-unused-vars */\n/**\n * @interface\n */\nexport class MutatorInterface {\n  /**\n   * Requests the runtime to change the element's size. When the size is\n   * successfully updated then the opt_callback is called.\n   * @param {!Element} element\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {function()=} opt_callback A callback function.\n   * @param {!../layout-rect.LayoutMarginsChangeDef=} opt_newMargins\n   */\n  changeSize(element, newHeight, newWidth, opt_callback, opt_newMargins) {}\n\n  /**\n   * Return a promise that requests the runtime to update the size of\n   * this element to the specified value.\n   * The runtime will schedule this request and attempt to process it\n   * as soon as possible. However, unlike in {@link changeSize}, the runtime\n   * may refuse to make a change in which case it will reject promise, call the\n   * `overflowCallback` method on the target resource with the height value.\n   * Overflow callback is expected to provide the reader with the user action\n   * to update the height manually.\n   * Note that the runtime does not call the `overflowCallback` method if the\n   * requested height is 0 or negative.\n   * If the height is successfully updated then the promise is resolved.\n   * @param {!Element} element\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef=} opt_newMargins\n   * @return {!Promise}\n   * @param {?Event=} opt_event\n   */\n  attemptChangeSize(element, newHeight, newWidth, opt_newMargins, opt_event) {}\n\n  /**\n   * Expands the element.\n   * @param {!Element} element\n   */\n  expandElement(element) {}\n\n  /**\n   * Return a promise that requests runtime to collapse this element.\n   * The runtime will schedule this request and first attempt to resize\n   * the element to height and width 0. If success runtime will set element\n   * display to none, and notify element owner of this collapse.\n   * @param {!Element} element\n   * @return {!Promise}\n   */\n  attemptCollapse(element) {}\n\n  /**\n   * Collapses the element: ensures that it's `display:none`, notifies its\n   * owner and updates the layout box.\n   * @param {!Element} element\n   */\n  collapseElement(element) {}\n\n  /**\n   * Runs the specified measure, which is called in the \"measure\" vsync phase.\n   * This is simply a proxy to the privileged vsync service.\n   *\n   * @param {function()} measurer\n   * @return {!Promise}\n   */\n  measureElement(measurer) {}\n\n  /**\n   * Runs the specified mutation on the element and ensures that remeasures and\n   * layouts performed for the affected elements.\n   *\n   * This method should be called whenever a significant mutations are done\n   * on the DOM that could affect layout of elements inside this subtree or\n   * its siblings. The top-most affected element should be specified as the\n   * first argument to this method and all the mutation work should be done\n   * in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {!Element} element\n   * @param {function()} mutator\n   * @return {!Promise}\n   */\n  mutateElement(element, mutator) {}\n\n  /**\n   * Runs the specified mutation on the element and ensures that remeasures and\n   * layouts performed for the affected elements.\n   *\n   * This method should be called whenever a significant mutations are done\n   * on the DOM that could affect layout of elements inside this subtree or\n   * its siblings. The top-most affected element should be specified as the\n   * first argument to this method and all the mutation work should be done\n   * in the mutator callback which is called in the \"mutation\" vsync phase.\n   *\n   * @param {!Element} element\n   * @param {?function()} measurer\n   * @param {function()} mutator\n   * @return {!Promise}\n   */\n  measureMutateElement(element, measurer, mutator) {}\n}\n/* eslint-enable no-unused-vars */\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {\n  closestAncestorElementBySelector,\n  isIframed,\n  openWindowDialog,\n  tryFocus,\n} from '../dom';\nimport {dev, user, userAssert} from '../log';\nimport {dict} from '../utils/object';\nimport {escapeCssSelectorIdent} from '../css';\nimport {getExtraParamsUrl, shouldAppendExtraParams} from '../impression';\nimport {getMode} from '../mode';\nimport {\n  installServiceInEmbedScope,\n  registerServiceBuilderForDoc,\n} from '../service';\nimport {toWin} from '../types';\nimport PriorityQueue from '../utils/priority-queue';\n\nconst TAG = 'navigation';\n/** @private @const {string} */\nconst EVENT_TYPE_CLICK = 'click';\n/** @private @const {string} */\nconst EVENT_TYPE_CONTEXT_MENU = 'contextmenu';\nconst VALID_TARGETS = ['_top', '_blank'];\n\n/** @private @const {string} */\nconst ORIG_HREF_ATTRIBUTE = 'data-a4a-orig-href';\n\n/**\n * Key used for retargeting event target originating from shadow DOM.\n * @const {string}\n */\nconst AMP_CUSTOM_LINKER_TARGET = '__AMP_CUSTOM_LINKER_TARGET__';\n\n/**\n * @enum {number} Priority reserved for extensions in anchor mutations.\n * The higher the priority, the sooner it's invoked.\n */\nexport const Priority = {\n  LINK_REWRITER_MANAGER: 0,\n  ANALYTICS_LINKER: 2,\n};\n\n/**\n * Install navigation service for ampdoc, which handles navigations from anchor\n * tag clicks and other runtime features like AMP.navigateTo().\n *\n * Immediately instantiates the service.\n *\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installGlobalNavigationHandlerForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    TAG,\n    Navigation,\n    /* opt_instantiate */ true\n  );\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Event} e\n * @visibleForTesting\n */\nexport function maybeExpandUrlParamsForTesting(ampdoc, e) {\n  maybeExpandUrlParams(ampdoc, e);\n}\n\n/**\n * Intercept any click on the current document and prevent any\n * linking to an identifier from pushing into the history stack.\n * @implements {../service.EmbeddableService}\n * @visibleForTesting\n */\nexport class Navigation {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_rootNode\n   */\n  constructor(ampdoc, opt_rootNode) {\n    // TODO(#22733): remove subroooting once ampdoc-fie is launched.\n\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @private @const {!Document|!ShadowRoot} */\n    this.rootNode_ = opt_rootNode || ampdoc.getRootNode();\n\n    /** @private @const {!./viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(this.ampdoc);\n\n    /** @private @const {!./viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(this.ampdoc);\n\n    /** @private @const {!./history-impl.History} */\n    this.history_ = Services.historyForDoc(this.ampdoc);\n\n    /** @private @const {!./platform-impl.Platform} */\n    this.platform_ = Services.platformFor(this.ampdoc.win);\n\n    /** @private @const {boolean} */\n    this.isIosSafari_ = this.platform_.isIos() && this.platform_.isSafari();\n\n    /** @private @const {boolean} */\n    this.isIframed_ =\n      isIframed(this.ampdoc.win) && this.viewer_.isOvertakeHistory();\n\n    /** @private @const {boolean} */\n    this.isEmbed_ =\n      this.rootNode_ != this.ampdoc.getRootNode() || !!this.ampdoc.getParent();\n\n    /** @private @const {boolean} */\n    this.isInABox_ = getMode(this.ampdoc.win).runtime == 'inabox';\n\n    /**\n     * Must use URL parsing scoped to `rootNode_` for correct FIE behavior.\n     * @private @const {!Element|!ShadowRoot}\n     */\n    this.serviceContext_ =\n      /** @type {!Element|!ShadowRoot} */ (this.rootNode_.nodeType ==\n      Node.DOCUMENT_NODE\n        ? this.rootNode_.documentElement\n        : this.rootNode_);\n\n    /** @private @const {!function(!Event)|undefined} */\n    this.boundHandle_ = this.handle_.bind(this);\n    this.rootNode_.addEventListener(EVENT_TYPE_CLICK, this.boundHandle_);\n    this.rootNode_.addEventListener(EVENT_TYPE_CONTEXT_MENU, this.boundHandle_);\n    /** @private {boolean} */\n    this.appendExtraParams_ = false;\n    shouldAppendExtraParams(this.ampdoc).then(res => {\n      this.appendExtraParams_ = res;\n    });\n\n    /**\n     * Lazy-generated list of A2A-enabled navigation features.\n     * @private {?Array<string>}\n     */\n    this.a2aFeatures_ = null;\n\n    /**\n     * @type {!PriorityQueue<function(!Element, !Event)>}\n     * @private\n     * @const\n     */\n    this.anchorMutators_ = new PriorityQueue();\n\n    /**\n     * @type {!PriorityQueue<function(string)>}\n     * @private\n     * @const\n     */\n    this.navigateToMutators_ = new PriorityQueue();\n  }\n\n  /**\n   * Registers a handler that performs URL replacement on the href\n   * of an ad click.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Window} win\n   */\n  static installAnchorClickInterceptor(ampdoc, win) {\n    win.document.documentElement.addEventListener(\n      'click',\n      maybeExpandUrlParams.bind(null, ampdoc),\n      /* capture */ true\n    );\n  }\n\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n  static installInEmbedWindow(embedWin, ampdoc) {\n    installServiceInEmbedScope(\n      embedWin,\n      TAG,\n      new Navigation(ampdoc, embedWin.document)\n    );\n  }\n\n  /**\n   * Removes all event listeners.\n   */\n  cleanup() {\n    if (this.boundHandle_) {\n      this.rootNode_.removeEventListener(EVENT_TYPE_CLICK, this.boundHandle_);\n      this.rootNode_.removeEventListener(\n        EVENT_TYPE_CONTEXT_MENU,\n        this.boundHandle_\n      );\n    }\n  }\n\n  /**\n   * Opens a new window with the specified target.\n   *\n   * @param {!Window} win A window to use to open a new window.\n   * @param {string} url THe URL to open.\n   * @param {string} target The target for the newly opened window.\n   * @param {boolean} opener Whether or not the new window should have acccess\n   *   to the opener (win).\n   */\n  openWindow(win, url, target, opener) {\n    let options = '';\n    // We don't pass noopener for Chrome since it opens a new window without\n    // tabs. Instead, we remove the opener property from the newly opened\n    // window.\n    // Note: for Safari, we need to use noopener instead of clearing the opener\n    // property.\n    if ((this.platform_.isIos() || !this.platform_.isChrome()) && !opener) {\n      options += 'noopener';\n    }\n\n    const newWin = openWindowDialog(win, url, target, options);\n    // For Chrome, since we cannot use noopener.\n    if (newWin && !opener) {\n      newWin.opener = null;\n    }\n  }\n\n  /**\n   * Navigates a window to a URL.\n   *\n   * If opt_requestedBy matches a feature name in a <meta> tag with attribute\n   * name=\"amp-to-amp-navigation\", then treats the URL as an AMP URL (A2A).\n   *\n   * @param {!Window} win\n   * @param {string} url\n   * @param {string=} opt_requestedBy\n   * @param {!{\n   *   target: (string|undefined),\n   *   opener: (boolean|undefined),\n   * }=} opt_options\n   */\n  navigateTo(\n    win,\n    url,\n    opt_requestedBy,\n    {target = '_top', opener = false} = {}\n  ) {\n    url = this.applyNavigateToMutators_(url);\n    const urlService = Services.urlForDoc(this.serviceContext_);\n    if (!urlService.isProtocolValid(url)) {\n      user().error(TAG, 'Cannot navigate to invalid protocol: ' + url);\n      return;\n    }\n\n    userAssert(\n      VALID_TARGETS.includes(target),\n      `Target '${target}' not supported.`\n    );\n\n    // Resolve navigateTos relative to the source URL, not the proxy URL.\n    url = urlService.getSourceUrl(url);\n\n    // If we have a target of \"_blank\", we will want to open a new window. A\n    // target of \"_top\" should behave like it would on an anchor tag and\n    // update the URL.\n    if (target == '_blank') {\n      this.openWindow(win, url, target, opener);\n      return;\n    }\n\n    // If this redirect was requested by a feature that opted into A2A,\n    // try to ask the viewer to navigate this AMP URL.\n    if (opt_requestedBy) {\n      if (!this.a2aFeatures_) {\n        this.a2aFeatures_ = this.queryA2AFeatures_();\n      }\n      if (this.a2aFeatures_.includes(opt_requestedBy)) {\n        if (this.navigateToAmpUrl(url, opt_requestedBy)) {\n          return;\n        }\n      }\n    }\n\n    // Otherwise, perform normal behavior of navigating the top frame.\n    win.top.location.href = url;\n  }\n\n  /**\n   * Requests A2A navigation to the given destination. If the viewer does\n   * not support this operation, does nothing.\n   * The URL is assumed to be in AMP Cache format already.\n   * @param {string} url An AMP article URL.\n   * @param {string} requestedBy Informational string about the entity that\n   *     requested the navigation.\n   * @return {boolean} Returns true if navigation message was sent to viewer.\n   *     Otherwise, returns false.\n   */\n  navigateToAmpUrl(url, requestedBy) {\n    if (this.viewer_.hasCapability('a2a')) {\n      this.viewer_.sendMessage(\n        'a2aNavigate',\n        dict({\n          'url': url,\n          'requestedBy': requestedBy,\n        })\n      );\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * @return {!Array<string>}\n   * @private\n   */\n  queryA2AFeatures_() {\n    const meta = this.rootNode_.querySelector(\n      'meta[name=\"amp-to-amp-navigation\"]'\n    );\n    if (meta && meta.hasAttribute('content')) {\n      return meta\n        .getAttribute('content')\n        .split(',')\n        .map(s => s.trim());\n    }\n    return [];\n  }\n\n  /**\n   * Intercept any click on the current document and prevent any\n   * linking to an identifier from pushing into the history stack.\n   *\n   * This also handles custom protocols (e.g. whatsapp://) when iframed\n   * on iOS Safari.\n   *\n   * @param {!Event} e\n   * @private\n   */\n  handle_(e) {\n    if (e.defaultPrevented) {\n      return;\n    }\n    const element = dev().assertElement(\n      e[AMP_CUSTOM_LINKER_TARGET] || e.target\n    );\n    const target = closestAncestorElementBySelector(element, 'A');\n    if (!target || !target.href) {\n      return;\n    }\n\n    if (e.type == EVENT_TYPE_CLICK) {\n      this.handleClick_(target, e);\n    } else if (e.type == EVENT_TYPE_CONTEXT_MENU) {\n      this.handleContextMenuClick_(target, e);\n    }\n  }\n\n  /**\n   * @param {!Element} target\n   * @param {!Event} e\n   * @private\n   */\n  handleClick_(target, e) {\n    this.expandVarsForAnchor_(target);\n\n    let tgtLoc = this.parseUrl_(target.href);\n\n    // Handle AMP-to-AMP navigation if rel=amphtml.\n    if (this.handleA2AClick_(e, target, tgtLoc)) {\n      return;\n    }\n\n    // Handle navigating to custom protocol if applicable.\n    if (this.handleCustomProtocolClick_(e, target, tgtLoc)) {\n      return;\n    }\n\n    // In test mode, we're not able to properly fix the anchor tag's base URL.\n    // So, we have to use the (mocked) window's location instead.\n    const baseHref =\n      getMode().test && !this.isEmbed_ ? this.ampdoc.win.location.href : '';\n    const curLoc = this.parseUrl_(baseHref);\n    const tgtHref = getHref(tgtLoc);\n    const curHref = getHref(curLoc);\n\n    if (tgtHref != curHref) {\n      // Only apply anchor mutator if this is an external navigation\n      this.applyAnchorMutators_(target, e);\n      tgtLoc = this.parseUrl_(target.href);\n    }\n\n    // Finally, handle normal click-navigation behavior.\n    this.handleNavClick_(e, target, tgtLoc, curLoc);\n  }\n\n  /**\n   * @param {!Element} target\n   * @param {!Event} e\n   * @private\n   */\n  handleContextMenuClick_(target, e) {\n    // Handles contextmenu click. Note that currently this only deals\n    // with url variable substitution and expansion, as there is\n    // straightforward way of determining what the user clicked in the\n    // context menu, required for A2A navigation and custom link protocol\n    // handling.\n    // TODO(alabiaga): investigate fix for handling A2A and custom link\n    // protocols.\n    this.expandVarsForAnchor_(target);\n    this.applyAnchorMutators_(target, e);\n  }\n\n  /**\n   * Apply anchor transformations.\n   * @param {!Element} target\n   * @param {!Event} e\n   */\n  applyAnchorMutators_(target, e) {\n    this.anchorMutators_.forEach(anchorMutator => {\n      anchorMutator(target, e);\n    });\n  }\n\n  /**\n   * Apply URL transformations for AMP.navigateTo.\n   * @param {string} url\n   * @return {string}\n   */\n  applyNavigateToMutators_(url) {\n    this.navigateToMutators_.forEach(mutator => {\n      url = mutator(url);\n    });\n    return url;\n  }\n\n  /**\n   * @param {!Element} el\n   * @private\n   */\n  expandVarsForAnchor_(el) {\n    // First check if need to handle external link decoration.\n    let defaultExpandParamsUrl = null;\n    if (this.appendExtraParams_ && !this.isEmbed_) {\n      // Only decorate outgoing link when needed to and is not in FIE.\n      defaultExpandParamsUrl = getExtraParamsUrl(this.ampdoc.win, el);\n    }\n\n    const urlReplacements = Services.urlReplacementsForDoc(el);\n    urlReplacements.maybeExpandLink(el, defaultExpandParamsUrl);\n  }\n\n  /**\n   * Handles clicking on a custom protocol link.\n   * Returns true if the navigation was handled. Otherwise, returns false.\n   * @param {!Event} e\n   * @param {!Element} target\n   * @param {!Location} location\n   * @return {boolean}\n   * @private\n   */\n  handleCustomProtocolClick_(e, target, location) {\n    // Handle custom protocols only if the document is iframed.\n    if (!this.isIframed_) {\n      return false;\n    }\n\n    /** @const {!Window} */\n    const win = toWin(target.ownerDocument.defaultView);\n    const url = target.href;\n    const {protocol} = location;\n\n    // On Safari iOS, custom protocol links will fail to open apps when the\n    // document is iframed - in order to go around this, we set the top.location\n    // to the custom protocol href.\n    const isFTP = protocol == 'ftp:';\n\n    // In case of FTP Links in embedded documents always open then in _blank.\n    if (isFTP) {\n      openWindowDialog(win, url, '_blank');\n      e.preventDefault();\n      return true;\n    }\n\n    const isNormalProtocol = /^(https?|mailto):$/.test(protocol);\n    if (this.isIosSafari_ && !isNormalProtocol) {\n      openWindowDialog(win, url, '_top');\n      // Without preventing default the page would should an alert error twice\n      // in the case where there's no app to handle the custom protocol.\n      e.preventDefault();\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Handles clicking on an AMP link.\n   * Returns true if the navigation was handled. Otherwise, returns false.\n   * @param {!Event} e\n   * @param {!Element} target\n   * @param {!Location} location\n   * @return {boolean}\n   * @private\n   */\n  handleA2AClick_(e, target, location) {\n    if (!target.hasAttribute('rel')) {\n      return false;\n    }\n    const relations = target\n      .getAttribute('rel')\n      .split(' ')\n      .map(s => s.trim());\n    if (!relations.includes('amphtml')) {\n      return false;\n    }\n    // The viewer may not support the capability for navigating AMP links.\n    if (this.navigateToAmpUrl(location.href, '<a rel=amphtml>')) {\n      e.preventDefault();\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Handles clicking on a link with hash navigation.\n   * @param {!Event} e\n   * @param {!Element} target\n   * @param {!Location} tgtLoc\n   * @param {!Location} curLoc\n   * @private\n   */\n  handleNavClick_(e, target, tgtLoc, curLoc) {\n    const tgtHref = getHref(tgtLoc);\n    const curHref = getHref(curLoc);\n\n    // If the current target anchor link is the same origin + path\n    // as the current document then we know we are just linking to an\n    // identifier in the document. Otherwise, it's an external navigation.\n    if (!tgtLoc.hash || tgtHref != curHref) {\n      if (this.isEmbed_ || this.isInABox_) {\n        // Target in the embed must be either _top or _blank. If none specified,\n        // force to _blank.\n        const targetAttr = (target.getAttribute('target') || '').toLowerCase();\n        if (targetAttr != '_top' && targetAttr != '_blank') {\n          target.setAttribute('target', '_blank');\n        }\n        return; // bail early.\n      }\n\n      // Accessibility fix for IE browser.\n      // Issue: anchor navigation in IE changes visual focus of the browser\n      // and shifts to the element being linked to,\n      // where the input focus stays where it was.\n      // @see https://humanwhocodes.com/blog/2013/01/15/fixing-skip-to-content-links/\n      // @see https://github.com/ampproject/amphtml/issues/18671\n      if (Services.platformFor(this.ampdoc.win).isIe()) {\n        const internalTargetElmId = tgtLoc.hash.substring(1);\n        const internalElm = this.ampdoc.getElementById(internalTargetElmId);\n        if (internalElm) {\n          if (\n            !/^(?:a|select|input|button|textarea)$/i.test(internalElm.tagName)\n          ) {\n            internalElm.tabIndex = -1;\n          }\n          tryFocus(internalElm);\n        }\n      }\n      return;\n    }\n\n    this.handleInternalNavigation_(e, tgtLoc, curLoc);\n  }\n\n  /**\n   * Handles clicking on an internal link\n   * @param {!Event} e\n   * @param {!Location} tgtLoc\n   * @param {!Location} curLoc\n   * @private\n   */\n  handleInternalNavigation_(e, tgtLoc, curLoc) {\n    // We prevent default so that the current click does not push\n    // into the history stack as this messes up the external documents\n    // history which contains the amp document.\n    e.preventDefault();\n\n    // For an embed, do not perform scrolling or global history push - both have\n    // significant UX and browser problems.\n    if (this.isEmbed_) {\n      return;\n    }\n\n    // Look for the referenced element.\n    const hash = tgtLoc.hash.slice(1);\n    let elem = null;\n    if (hash) {\n      const escapedHash = escapeCssSelectorIdent(hash);\n      elem =\n        this.rootNode_.getElementById(hash) ||\n        // Fallback to anchor[name] if element with id is not found.\n        // Linking to an anchor element with name is obsolete in html5.\n        this.rootNode_./*OK*/ querySelector(`a[name=\"${escapedHash}\"]`);\n    }\n\n    // If possible do update the URL with the hash. As explained above\n    // we do `replace` to avoid messing with the container's history.\n    if (tgtLoc.hash != curLoc.hash) {\n      this.history_.replaceStateForTarget(tgtLoc.hash).then(() => {\n        this.scrollToElement_(elem, hash);\n      });\n    } else {\n      // If the hash did not update just scroll to the element.\n      this.scrollToElement_(elem, hash);\n    }\n  }\n\n  /**\n   * @param {function(!Element, !Event)} callback\n   * @param {number} priority\n   */\n  registerAnchorMutator(callback, priority) {\n    this.anchorMutators_.enqueue(callback, priority);\n  }\n\n  /**\n   * @param {function(string)} callback\n   * @param {number} priority\n   */\n  registerNavigateToMutator(callback, priority) {\n    this.navigateToMutators_.enqueue(callback, priority);\n  }\n\n  /**\n   * Scrolls the page to the given element.\n   * @param {?Element} elem\n   * @param {string} hash\n   * @private\n   */\n  scrollToElement_(elem, hash) {\n    // Scroll to the element if found.\n    if (elem) {\n      // The first call to scrollIntoView overrides browsers' default scrolling\n      // behavior. The second call insides setTimeout allows us to scroll to\n      // that element properly. Without doing this, the viewport will not catch\n      // the updated scroll position on iOS Safari and hence calculate the wrong\n      // scrollTop for the scrollbar jumping the user back to the top for\n      // failing to calculate the new jumped offset. Without the first call\n      // there will be a visual jump due to browser scroll. See\n      // https://github.com/ampproject/amphtml/issues/5334 for more details.\n      this.viewport_./*OK*/ scrollIntoView(elem);\n      Services.timerFor(this.ampdoc.win).delay(\n        () => this.viewport_./*OK*/ scrollIntoView(dev().assertElement(elem)),\n        1\n      );\n    } else {\n      dev().warn(\n        TAG,\n        `failed to find element with id=${hash} or a[name=${hash}]`\n      );\n    }\n  }\n\n  /**\n   * @param {string} url\n   * @return {!Location}\n   * @private\n   */\n  parseUrl_(url) {\n    return Services.urlForDoc(this.serviceContext_).parse(url);\n  }\n}\n\n/**\n * Handle click on links and replace variables in the click URL.\n * The function changes the actual href value and stores the\n * template in the ORIGINAL_HREF_ATTRIBUTE attribute\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Event} e\n */\nfunction maybeExpandUrlParams(ampdoc, e) {\n  const target = closestAncestorElementBySelector(\n    dev().assertElement(e.target),\n    'A'\n  );\n  if (!target || !target.href) {\n    // Not a click on a link.\n    return;\n  }\n  const hrefToExpand =\n    target.getAttribute(ORIG_HREF_ATTRIBUTE) || target.getAttribute('href');\n  if (!hrefToExpand) {\n    return;\n  }\n  const vars = {\n    'CLICK_X': () => {\n      return e.pageX;\n    },\n    'CLICK_Y': () => {\n      return e.pageY;\n    },\n  };\n  const newHref = Services.urlReplacementsForDoc(target).expandUrlSync(\n    hrefToExpand,\n    vars,\n    undefined,\n    /* opt_whitelist */ {\n      // For now we only allow to replace the click location vars\n      // and nothing else.\n      // NOTE: Addition to this whitelist requires additional review.\n      'CLICK_X': true,\n      'CLICK_Y': true,\n    }\n  );\n  if (newHref != hrefToExpand) {\n    // Store original value so that later clicks can be processed with\n    // freshest values.\n    if (!target.getAttribute(ORIG_HREF_ATTRIBUTE)) {\n      target.setAttribute(ORIG_HREF_ATTRIBUTE, hrefToExpand);\n    }\n    target.setAttribute('href', newHref);\n  }\n}\n\n/**\n * Calculate and return the href from the Location\n * @param {!Location} location\n * @return {string}\n */\nfunction getHref(location) {\n  return `${location.origin}${location.pathname}${location.search}`;\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// TODO(powerivq)\n// Resource.setOwner, Resource.getOwner should be moved here.\n// ResourceState.NOT_BUILT might not be needed here.\nimport {OwnersInterface} from './owners-interface';\nimport {Resource, ResourceState} from './resource';\nimport {Services} from '../services';\nimport {devAssert} from '../log';\nimport {isArray} from '../types';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/**\n * @param {!Element|!Array<!Element>} elements\n * @return {!Array<!Element>}\n */\nfunction elements(elements) {\n  return /** @type {!Array<!Element>} */ (isArray(elements)\n    ? elements\n    : [elements]);\n}\n\n/**\n * @implements {OwnersInterface}\n * @visibleForTesting\n */\nexport class OwnersImpl {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const @private {!./resources-interface.ResourcesInterface} */\n    this.resources_ = Services.resourcesForDoc(ampdoc);\n  }\n\n  /** @override */\n  setOwner(element, owner) {\n    Resource.setOwner(element, owner);\n  }\n\n  /** @override */\n  schedulePreload(parentElement, subElements) {\n    this.scheduleLayoutOrPreloadForSubresources_(\n      this.resources_.getResourceForElement(parentElement),\n      /* layout */ false,\n      elements(subElements)\n    );\n  }\n\n  /** @override */\n  scheduleLayout(parentElement, subElements) {\n    this.scheduleLayoutOrPreloadForSubresources_(\n      this.resources_.getResourceForElement(parentElement),\n      /* layout */ true,\n      elements(subElements)\n    );\n  }\n\n  /** @override */\n  schedulePause(parentElement, subElements) {\n    const parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n\n    this.findResourcesInElements_(parentResource, subElements, resource => {\n      resource.pause();\n    });\n  }\n\n  /** @override */\n  scheduleResume(parentElement, subElements) {\n    const parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n\n    this.findResourcesInElements_(parentResource, subElements, resource => {\n      resource.resume();\n    });\n  }\n\n  /** @override */\n  scheduleUnlayout(parentElement, subElements) {\n    const parentResource = this.resources_.getResourceForElement(parentElement);\n    subElements = elements(subElements);\n\n    this.findResourcesInElements_(parentResource, subElements, resource => {\n      resource.unlayout();\n    });\n  }\n\n  /** @override */\n  updateInViewport(parentElement, subElements, inLocalViewport) {\n    this.updateInViewportForSubresources_(\n      this.resources_.getResourceForElement(parentElement),\n      elements(subElements),\n      inLocalViewport\n    );\n  }\n\n  /** @override */\n  requireLayout(element, opt_parentPriority) {\n    const promises = [];\n    this.discoverResourcesForElement_(element, resource => {\n      if (resource.getState() == ResourceState.LAYOUT_COMPLETE) {\n        return;\n      }\n      if (resource.getState() != ResourceState.LAYOUT_SCHEDULED) {\n        promises.push(\n          resource.whenBuilt().then(() => {\n            resource.measure();\n            if (!resource.isDisplayed()) {\n              return;\n            }\n            this.resources_.scheduleLayoutOrPreload(\n              resource,\n              /* layout */ true,\n              opt_parentPriority,\n              /* forceOutsideViewport */ true\n            );\n            return resource.loadedOnce();\n          })\n        );\n      } else if (resource.isDisplayed()) {\n        promises.push(resource.loadedOnce());\n      }\n    });\n    return Promise.all(promises);\n  }\n\n  /**\n   * Finds resources within the parent resource's shallow subtree.\n   * @param {!Resource} parentResource\n   * @param {!Array<!Element>} elements\n   * @param {function(!Resource)} callback\n   * @private\n   */\n  findResourcesInElements_(parentResource, elements, callback) {\n    elements.forEach(element => {\n      devAssert(parentResource.element.contains(element));\n      this.discoverResourcesForElement_(element, callback);\n    });\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {function(!Resource)} callback\n   */\n  discoverResourcesForElement_(element, callback) {\n    // Breadth-first search.\n    if (element.classList.contains('i-amphtml-element')) {\n      callback(this.resources_.getResourceForElement(element));\n      // Also schedule amp-element that is a placeholder for the element.\n      const placeholder = element.getPlaceholder();\n      if (placeholder) {\n        this.discoverResourcesForElement_(placeholder, callback);\n      }\n    } else {\n      const ampElements = element.getElementsByClassName('i-amphtml-element');\n      const seen = [];\n      for (let i = 0; i < ampElements.length; i++) {\n        const ampElement = ampElements[i];\n        let covered = false;\n        for (let j = 0; j < seen.length; j++) {\n          if (seen[j].contains(ampElement)) {\n            covered = true;\n            break;\n          }\n        }\n        if (!covered) {\n          seen.push(ampElement);\n          callback(this.resources_.getResourceForElement(ampElement));\n        }\n      }\n    }\n  }\n\n  /**\n   * Schedules layout or preload for the sub-resources of the specified\n   * resource.\n   * @param {!Resource} parentResource\n   * @param {boolean} layout\n   * @param {!Array<!Element>} subElements\n   * @private\n   */\n  scheduleLayoutOrPreloadForSubresources_(parentResource, layout, subElements) {\n    this.findResourcesInElements_(parentResource, subElements, resource => {\n      if (resource.getState() === ResourceState.NOT_BUILT) {\n        resource.whenBuilt().then(() => {\n          this.measureAndTryScheduleLayout_(\n            resource,\n            !layout,\n            parentResource.getLayoutPriority()\n          );\n        });\n      } else {\n        this.measureAndTryScheduleLayout_(\n          resource,\n          !layout,\n          parentResource.getLayoutPriority()\n        );\n      }\n    });\n  }\n\n  /**\n   * @param {!Resource} resource\n   * @param {boolean} isPreload\n   * @param {number=} opt_parentPriority\n   * @private\n   */\n  measureAndTryScheduleLayout_(resource, isPreload, opt_parentPriority) {\n    resource.measure();\n    if (\n      resource.getState() === ResourceState.READY_FOR_LAYOUT &&\n      resource.isDisplayed()\n    ) {\n      this.resources_.scheduleLayoutOrPreload(\n        resource,\n        !isPreload,\n        opt_parentPriority\n      );\n    }\n  }\n\n  /**\n   * Updates inViewport state for the specified sub-resources of a resource.\n   * @param {!Resource} parentResource\n   * @param {!Array<!Element>} subElements\n   * @param {boolean} inLocalViewport\n   * @private\n   */\n  updateInViewportForSubresources_(\n    parentResource,\n    subElements,\n    inLocalViewport\n  ) {\n    const inViewport = parentResource.isInViewport() && inLocalViewport;\n    this.findResourcesInElements_(parentResource, subElements, resource => {\n      resource.setInViewport(inViewport);\n    });\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installOwnersServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'owners', OwnersImpl);\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* eslint-disable no-unused-vars */\n/**\n * @interface\n */\nexport class OwnersInterface {\n  /**\n   * Assigns an owner for the specified element. This means that the resources\n   * within this element will be managed by the owner and not Resources manager.\n   * @param {!Element} element\n   * @param {!AmpElement} owner\n   * @package\n   */\n  setOwner(element, owner) {}\n\n  /**\n   * Schedules preload for the specified sub-elements that are children of the\n   * parent element. The parent element may choose to send this signal either\n   * because it's an owner (see {@link setOwner}) or because it wants the\n   * preloads to be done sooner. In either case, both parent's and children's\n   * priority is observed when scheduling this work.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  schedulePreload(parentElement, subElements) {}\n\n  /**\n   * Schedules layout for the specified sub-elements that are children of the\n   * parent element. The parent element may choose to send this signal either\n   * because it's an owner (see {@link setOwner}) or because it wants the\n   * layouts to be done sooner. In either case, both parent's and children's\n   * priority is observed when scheduling this work.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  scheduleLayout(parentElement, subElements) {}\n\n  /**\n   * Invokes `unload` on the elements' resource which in turn will invoke\n   * the `documentBecameInactive` callback on the custom element.\n   * Resources that call `schedulePause` must also call `scheduleResume`.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  schedulePause(parentElement, subElements) {}\n\n  /**\n   * Invokes `resume` on the elements' resource which in turn will invoke\n   * `resumeCallback` only on paused custom elements.\n   * Resources that call `schedulePause` must also call `scheduleResume`.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  scheduleResume(parentElement, subElements) {}\n\n  /**\n   * Schedules unlayout for specified sub-elements that are children of the\n   * parent element. The parent element can choose to send this signal when\n   * it want to unload resources for its children.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   */\n  scheduleUnlayout(parentElement, subElements) {}\n\n  /**\n   * A parent resource, especially in when it's an owner (see {@link setOwner}),\n   * may request the Resources manager to update children's inViewport state.\n   * A child's inViewport state is a logical AND between inLocalViewport\n   * specified here and parent's own inViewport state.\n   * @param {!Element} parentElement\n   * @param {!Element|!Array<!Element>} subElements\n   * @param {boolean} inLocalViewport\n   */\n  updateInViewport(parentElement, subElements, inLocalViewport) {}\n\n  /**\n   * Requires the layout of the specified element or top-level sub-elements\n   * within.\n   * @param {!Element} element\n   * @param {number=} opt_parentPriority\n   * @return {!Promise}\n   */\n  requireLayout(element, opt_parentPriority) {}\n}\n/* eslint-enable no-unused-vars */\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {registerServiceBuilder} from '../service';\n\n/**\n * A helper class that provides information about device/OS/browser currently\n * running.\n */\nexport class Platform {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const @private {!Navigator} */\n    this.navigator_ = /** @type {!Navigator} */ (win.navigator);\n\n    /** @const @private */\n    this.win_ = win;\n  }\n\n  /**\n   * Whether the current platform an Android device.\n   * @return {boolean}\n   */\n  isAndroid() {\n    return /Android/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current platform an iOS device.\n   * @return {boolean}\n   */\n  isIos() {\n    return /iPhone|iPad|iPod/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is Safari.\n   * @return {boolean}\n   */\n  isSafari() {\n    return (\n      /Safari/i.test(this.navigator_.userAgent) &&\n      !this.isChrome() &&\n      !this.isIe() &&\n      !this.isEdge() &&\n      !this.isFirefox() &&\n      !this.isOpera()\n    );\n  }\n\n  /**\n   * Whether the current browser is a Chrome browser.\n   * @return {boolean}\n   */\n  isChrome() {\n    // Also true for MS Edge :)\n    return (\n      /Chrome|CriOS/i.test(this.navigator_.userAgent) &&\n      !this.isEdge() &&\n      !this.isOpera()\n    );\n  }\n\n  /**\n   * Whether the current browser is a Firefox browser.\n   * @return {boolean}\n   */\n  isFirefox() {\n    return /Firefox|FxiOS/i.test(this.navigator_.userAgent) && !this.isEdge();\n  }\n\n  /**\n   * Whether the current browser is an Opera browser.\n   * @return {boolean}\n   */\n  isOpera() {\n    // Chrome UA on Android may include OPR<v> (build code referring to Oreo),\n    // however real Opera puts put a / after OPR and that's the only tell, so\n    // we check for OPR/ instead of OPR\n    return /OPR\\/|Opera|OPiOS/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is a IE browser.\n   * @return {boolean}\n   */\n  isIe() {\n    return /Trident|MSIE|IEMobile/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is an Edge browser.\n   * @return {boolean}\n   */\n  isEdge() {\n    return /Edge/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is based on the WebKit engine.\n   * @return {boolean}\n   */\n  isWebKit() {\n    return /WebKit/i.test(this.navigator_.userAgent) && !this.isEdge();\n  }\n\n  /**\n   * Whether the current browser is running on Windows.\n   * @return {boolean}\n   */\n  isWindows() {\n    return /Windows/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Whether the current browser is isStandalone.\n   * @return {boolean}\n   */\n  isStandalone() {\n    return (\n      (this.isIos() && this.navigator_.standalone) ||\n      (this.isChrome() &&\n        this.win_.matchMedia('(display-mode: standalone)').matches)\n    );\n  }\n\n  /**\n   * Whether the current platform matches a bot user agent.\n   * @return {boolean}\n   */\n  isBot() {\n    return /bot/i.test(this.navigator_.userAgent);\n  }\n\n  /**\n   * Returns the major version of the browser.\n   * @return {number}\n   */\n  getMajorVersion() {\n    if (this.isSafari()) {\n      return this.isIos()\n        ? this.getIosMajorVersion() || 0\n        : this.evalMajorVersion_(/\\sVersion\\/(\\d+)/, 1);\n    }\n    if (this.isChrome()) {\n      return this.evalMajorVersion_(/(Chrome|CriOS)\\/(\\d+)/, 2);\n    }\n    if (this.isFirefox()) {\n      return this.evalMajorVersion_(/(Firefox|FxiOS)\\/(\\d+)/, 2);\n    }\n    if (this.isOpera()) {\n      return this.evalMajorVersion_(/(OPR|Opera|OPiOS)\\/(\\d+)/, 2);\n    }\n    if (this.isIe()) {\n      return this.evalMajorVersion_(/MSIE\\s(\\d+)/, 1);\n    }\n    if (this.isEdge()) {\n      return this.evalMajorVersion_(/Edge\\/(\\d+)/, 1);\n    }\n    return 0;\n  }\n\n  /**\n   * @param {!RegExp} expr\n   * @param {number} index The index in the result that's interpreted as the\n   *   major version (integer).\n   * @return {number}\n   */\n  evalMajorVersion_(expr, index) {\n    if (!this.navigator_.userAgent) {\n      return 0;\n    }\n    const res = this.navigator_.userAgent.match(expr);\n    if (!res || index >= res.length) {\n      return 0;\n    }\n    return parseInt(res[index], 10);\n  }\n\n  /**\n   * Returns the minor ios version in string.\n   * The ios version can contain two numbers (10.2) or three numbers (10.2.1).\n   * Direct string equality check is not suggested, use startWith instead.\n   * @return {string}\n   */\n  getIosVersionString() {\n    if (!this.navigator_.userAgent) {\n      return '';\n    }\n    if (!this.isIos()) {\n      return '';\n    }\n    let version = this.navigator_.userAgent.match(\n      /OS ([0-9]+[_.][0-9]+([_.][0-9]+)?)\\b/\n    );\n    if (!version) {\n      return '';\n    }\n    version = version[1].replace(/_/g, '.');\n    return version;\n  }\n\n  /**\n   * Returns the major ios version in number.\n   * @return {?number}\n   */\n  getIosMajorVersion() {\n    const currentIosVersion = this.getIosVersionString();\n    if (currentIosVersion == '') {\n      return null;\n    }\n    return Number(currentIosVersion.split('.')[0]);\n  }\n}\n\n/**\n * @param {!Window} window\n * @return {*} TODO(#23582): Specify return type\n */\nexport function installPlatformService(window) {\n  return registerServiceBuilder(window, 'platform', Platform);\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred, tryResolve} from '../utils/promise';\nimport {Layout} from '../layout';\nimport {Services} from '../services';\nimport {computedStyle, toggle} from '../style';\nimport {dev, devAssert} from '../log';\nimport {isBlockedByConsent} from '../error';\nimport {\n  layoutRectLtwh,\n  layoutRectSizeEquals,\n  layoutRectsOverlap,\n  moveLayoutRect,\n} from '../layout-rect';\nimport {startsWith} from '../string';\nimport {toWin} from '../types';\n\nconst TAG = 'Resource';\nconst RESOURCE_PROP_ = '__AMP__RESOURCE';\nconst OWNER_PROP_ = '__AMP__OWNER';\n\n/**\n * Resource state.\n *\n * @enum {number}\n */\nexport const ResourceState = {\n  /**\n   * The resource has not been built yet. Measures, layouts, preloads or\n   * viewport signals are not allowed.\n   */\n  NOT_BUILT: 0,\n\n  /**\n   * The resource has been built, but not measured yet and not yet ready\n   * for layout.\n   */\n  NOT_LAID_OUT: 1,\n\n  /**\n   * The resource has been built and measured and ready for layout.\n   */\n  READY_FOR_LAYOUT: 2,\n\n  /**\n   * The resource is currently scheduled for layout.\n   */\n  LAYOUT_SCHEDULED: 3,\n\n  /**\n   * The resource has been laid out.\n   */\n  LAYOUT_COMPLETE: 4,\n\n  /**\n   * The latest resource's layout failed.\n   */\n  LAYOUT_FAILED: 5,\n};\n\n/** @typedef {{\n  distance: (boolean|number),\n    viewportHeight: (number|undefined),\n    scrollPenalty: (number|undefined),\n  }} */\nlet ViewportRatioDef;\n\n/**\n * A Resource binding for an AmpElement.\n * @package\n */\nexport class Resource {\n  /**\n   * @param {!Element} element\n   * @return {!Resource}\n   */\n  static forElement(element) {\n    return /** @type {!Resource} */ (devAssert(\n      Resource.forElementOptional(element),\n      'Missing resource prop on %s',\n      element\n    ));\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {Resource}\n   */\n  static forElementOptional(element) {\n    return /** @type {Resource} */ (element[RESOURCE_PROP_]);\n  }\n\n  /**\n   * Assigns an owner for the specified element. This means that the resources\n   * within this element will be managed by the owner and not Resources manager.\n   * @param {!Element} element\n   * @param {!AmpElement} owner\n   */\n  static setOwner(element, owner) {\n    devAssert(owner.contains(element), 'Owner must contain the element');\n    if (Resource.forElementOptional(element)) {\n      Resource.forElementOptional(element).updateOwner(owner);\n    }\n    element[OWNER_PROP_] = owner;\n\n    // Need to clear owner cache for all child elements\n    const cachedElements = element.getElementsByClassName('i-amphtml-element');\n    for (let i = 0; i < cachedElements.length; i++) {\n      const ele = cachedElements[i];\n      if (Resource.forElementOptional(ele)) {\n        Resource.forElementOptional(ele).updateOwner(undefined);\n      }\n    }\n  }\n\n  /**\n   * @param {number} id\n   * @param {!AmpElement} element\n   * @param {!./resources-interface.ResourcesInterface} resources\n   */\n  constructor(id, element, resources) {\n    element[RESOURCE_PROP_] = this;\n\n    /** @private {number} */\n    this.id_ = id;\n\n    /** @export @const {!AmpElement} */\n    this.element = element;\n\n    /** @export @const {string} */\n    this.debugid = element.tagName.toLowerCase() + '#' + id;\n\n    /** @const {!Window} */\n    this.hostWin = toWin(element.ownerDocument.defaultView);\n\n    /** @const @private {!./resources-interface.ResourcesInterface} */\n    this.resources_ = resources;\n\n    /** @const @private {boolean} */\n    this.isPlaceholder_ = element.hasAttribute('placeholder');\n\n    /** @private {boolean} */\n    this.isBuilding_ = false;\n\n    /** @private {!AmpElement|undefined|null} */\n    this.owner_ = undefined;\n\n    /** @private {!ResourceState} */\n    this.state_ = element.isBuilt()\n      ? ResourceState.NOT_LAID_OUT\n      : ResourceState.NOT_BUILT;\n\n    /** @private {number} */\n    this.priorityOverride_ = -1;\n\n    /** @private {number} */\n    this.layoutCount_ = 0;\n\n    /** @private {*} */\n    this.lastLayoutError_ = null;\n\n    /** @private {boolean} */\n    this.isFixed_ = false;\n\n    /** @private {!../layout-rect.LayoutRectDef} */\n    this.layoutBox_ = layoutRectLtwh(-10000, -10000, 0, 0);\n\n    /** @private {?../layout-rect.LayoutRectDef} */\n    this.initialLayoutBox_ = null;\n\n    /** @private {boolean} */\n    this.isMeasureRequested_ = false;\n\n    /**\n     * Really, this is a <number, !Deferred> map,\n     * but CC's type system can't handle it.\n     * @private {?Object<string, !Deferred>}\n     */\n    this.withViewportDeferreds_ = null;\n\n    /** @private {?Promise<undefined>} */\n    this.layoutPromise_ = null;\n\n    /**\n     * Pending change size that was requested but could not be satisfied.\n     * @private {!./resources-impl.SizeDef|undefined}\n     */\n    this.pendingChangeSize_ = undefined;\n\n    /** @private {boolean} */\n    this.loadedOnce_ = false;\n\n    const deferred = new Deferred();\n\n    /** @private @const {!Promise} */\n    this.loadPromise_ = deferred.promise;\n\n    /** @private {?Function} */\n    this.loadPromiseResolve_ = deferred.resolve;\n  }\n\n  /**\n   * Returns resource's ID.\n   * @return {number}\n   */\n  getId() {\n    return this.id_;\n  }\n\n  /**\n   * Update owner element\n   * @param {AmpElement|undefined} owner\n   */\n  updateOwner(owner) {\n    this.owner_ = owner;\n  }\n\n  /**\n   * Returns an owner element or null.\n   * @return {?AmpElement}\n   */\n  getOwner() {\n    if (this.owner_ === undefined) {\n      for (let n = this.element; n; n = n.parentElement) {\n        if (n[OWNER_PROP_]) {\n          this.owner_ = n[OWNER_PROP_];\n          break;\n        }\n      }\n      if (this.owner_ === undefined) {\n        this.owner_ = null;\n      }\n    }\n    return this.owner_;\n  }\n\n  /**\n   * Whether the resource has an owner.\n   * @return {boolean}\n   */\n  hasOwner() {\n    return !!this.getOwner();\n  }\n\n  /**\n   * Returns the resource's element priority.\n   * @return {number}\n   */\n  getLayoutPriority() {\n    if (this.priorityOverride_ != -1) {\n      return this.priorityOverride_;\n    }\n    return this.element.getLayoutPriority();\n  }\n\n  /**\n   * Overrides the element's priority.\n   * @param {number} newPriority\n   */\n  updateLayoutPriority(newPriority) {\n    this.priorityOverride_ = newPriority;\n  }\n\n  /**\n   * Returns the resource's state. See {@link ResourceState} for details.\n   * @return {!ResourceState}\n   */\n  getState() {\n    return this.state_;\n  }\n\n  /**\n   * Returns whether the resource has been fully built.\n   * @return {boolean}\n   */\n  isBuilt() {\n    return this.element.isBuilt();\n  }\n\n  /**\n   * Returns whether the resource is currently being built.\n   * @return {boolean}\n   */\n  isBuilding() {\n    return this.isBuilding_;\n  }\n\n  /**\n   * Returns promise that resolves when the element has been built.\n   * @return {!Promise}\n   */\n  whenBuilt() {\n    // TODO(dvoytenko): merge with the standard BUILT signal.\n    return this.element.signals().whenSignal('res-built');\n  }\n\n  /**\n   * Requests the resource's element to be built. See {@link AmpElement.build}\n   * for details.\n   * @return {?Promise}\n   */\n  build() {\n    if (this.isBuilding_ || !this.element.isUpgraded()) {\n      return null;\n    }\n    this.isBuilding_ = true;\n    return this.element.build().then(\n      () => {\n        this.isBuilding_ = false;\n        this.state_ = ResourceState.NOT_LAID_OUT;\n        // TODO(dvoytenko): merge with the standard BUILT signal.\n        this.element.signals().signal('res-built');\n      },\n      reason => {\n        this.maybeReportErrorOnBuildFailure(reason);\n        this.isBuilding_ = false;\n        this.element.signals().rejectSignal('res-built', reason);\n        throw reason;\n      }\n    );\n  }\n\n  /**\n   * @param {*} reason\n   * @visibleForTesting\n   */\n  maybeReportErrorOnBuildFailure(reason) {\n    if (!isBlockedByConsent(reason)) {\n      dev().error(TAG, 'failed to build:', this.debugid, reason);\n    }\n  }\n\n  /**\n   * Optionally hides or shows the element depending on the media query.\n   */\n  applySizesAndMediaQuery() {\n    this.element.applySizesAndMediaQuery();\n  }\n\n  /**\n   * Instructs the element to change its size and transitions to the state\n   * awaiting the measure and possibly layout.\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef=} opt_newMargins\n   */\n  changeSize(newHeight, newWidth, opt_newMargins) {\n    this.element./*OK*/ changeSize(newHeight, newWidth, opt_newMargins);\n\n    // Schedule for re-measure and possible re-layout.\n    this.requestMeasure();\n  }\n\n  /**\n   * Informs the element that it's either overflown or not.\n   * @param {boolean} overflown\n   * @param {number|undefined} requestedHeight\n   * @param {number|undefined} requestedWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef|undefined} requestedMargins\n   */\n  overflowCallback(\n    overflown,\n    requestedHeight,\n    requestedWidth,\n    requestedMargins\n  ) {\n    if (overflown) {\n      this.pendingChangeSize_ = {\n        height: requestedHeight,\n        width: requestedWidth,\n        margins: requestedMargins,\n      };\n    }\n    this.element.overflowCallback(\n      overflown,\n      requestedHeight,\n      requestedWidth,\n      requestedMargins\n    );\n  }\n\n  /** reset pending change sizes */\n  resetPendingChangeSize() {\n    this.pendingChangeSize_ = undefined;\n  }\n\n  /**\n   * @return {!./resources-impl.SizeDef|undefined}\n   */\n  getPendingChangeSize() {\n    return this.pendingChangeSize_;\n  }\n\n  /**\n   * Time delay imposed by baseElement upgradeCallback.  If no\n   * upgradeCallback specified or not yet executed, delay is 0.\n   * @return {number}\n   */\n  getUpgradeDelayMs() {\n    return this.element.getUpgradeDelayMs();\n  }\n\n  /**\n   * Measures the resource's boundaries. An upgraded element will be\n   * transitioned to the \"ready for layout\" state.\n   */\n  measure() {\n    // Check if the element is ready to be measured.\n    // Placeholders are special. They are technically \"owned\" by parent AMP\n    // elements, sized by parents, but laid out independently. This means\n    // that placeholders need to at least wait until the parent element\n    // has been stubbed. We can tell whether the parent has been stubbed\n    // by whether a resource has been attached to it.\n    if (\n      this.isPlaceholder_ &&\n      this.element.parentElement &&\n      // Use prefix to recognize AMP element. This is necessary because stub\n      // may not be attached yet.\n      startsWith(this.element.parentElement.tagName, 'AMP-') &&\n      !(RESOURCE_PROP_ in this.element.parentElement)\n    ) {\n      return;\n    }\n\n    this.isMeasureRequested_ = false;\n\n    // TODO\n    const oldBox = this.layoutBox_;\n    this.measureViaResources_();\n    const box = this.layoutBox_;\n\n    // Note that \"left\" doesn't affect readiness for the layout.\n    const sizeChanges = !layoutRectSizeEquals(oldBox, box);\n    if (\n      this.state_ == ResourceState.NOT_LAID_OUT ||\n      oldBox.top != box.top ||\n      sizeChanges\n    ) {\n      if (\n        this.element.isUpgraded() &&\n        this.state_ != ResourceState.NOT_BUILT &&\n        (this.state_ == ResourceState.NOT_LAID_OUT ||\n          this.element.isRelayoutNeeded())\n      ) {\n        this.state_ = ResourceState.READY_FOR_LAYOUT;\n      }\n    }\n\n    if (!this.hasBeenMeasured()) {\n      this.initialLayoutBox_ = box;\n    }\n\n    this.element.updateLayoutBox(box, sizeChanges);\n  }\n\n  /** Use resources for measurement */\n  measureViaResources_() {\n    const viewport = Services.viewportForDoc(this.element);\n    const box = viewport.getLayoutRect(this.element);\n    this.layoutBox_ = box;\n\n    // Calculate whether the element is currently is or in `position:fixed`.\n    let isFixed = false;\n    if (viewport.supportsPositionFixed() && this.isDisplayed()) {\n      const {win} = this.resources_.getAmpdoc();\n      const {body} = win.document;\n      for (let n = this.element; n && n != body; n = n./*OK*/ offsetParent) {\n        if (n.isAlwaysFixed && n.isAlwaysFixed()) {\n          isFixed = true;\n          break;\n        }\n        if (\n          viewport.isDeclaredFixed(n) &&\n          computedStyle(win, n).position == 'fixed'\n        ) {\n          isFixed = true;\n          break;\n        }\n      }\n    }\n    this.isFixed_ = isFixed;\n\n    if (isFixed) {\n      // For fixed position elements, we need the relative position to the\n      // viewport. When accessing the layoutBox through #getLayoutBox, we'll\n      // return the new absolute position.\n      this.layoutBox_ = moveLayoutRect(\n        box,\n        -viewport.getScrollLeft(),\n        -viewport.getScrollTop()\n      );\n    }\n  }\n\n  /**\n   * Completes collapse: ensures that the element is `display:none` and\n   * updates layout box.\n   */\n  completeCollapse() {\n    toggle(this.element, false);\n    this.layoutBox_ = layoutRectLtwh(\n      this.layoutBox_.left,\n      this.layoutBox_.top,\n      0,\n      0\n    );\n    this.isFixed_ = false;\n    this.element.updateLayoutBox(this.getLayoutBox());\n    const owner = this.getOwner();\n    if (owner) {\n      owner.collapsedCallback(this.element);\n    }\n  }\n\n  /**\n   * Completes expand: ensures that the element is not `display:none` and\n   * updates measurements.\n   */\n  completeExpand() {\n    toggle(this.element, true);\n    this.requestMeasure();\n  }\n\n  /**\n   * @return {boolean}\n   */\n  isMeasureRequested() {\n    return this.isMeasureRequested_;\n  }\n\n  /**\n   * Checks if the current resource has been measured.\n   * @return {boolean}\n   */\n  hasBeenMeasured() {\n    return !!this.initialLayoutBox_;\n  }\n\n  /**\n   * Requests the element to be remeasured on the next pass.\n   */\n  requestMeasure() {\n    this.isMeasureRequested_ = true;\n  }\n\n  /**\n   * Returns a previously measured layout box adjusted to the viewport. This\n   * mainly affects fixed-position elements that are adjusted to be always\n   * relative to the document position in the viewport.\n   * @return {!../layout-rect.LayoutRectDef}\n   */\n  getLayoutBox() {\n    if (!this.isFixed_) {\n      return this.layoutBox_;\n    }\n    const viewport = Services.viewportForDoc(this.element);\n    return moveLayoutRect(\n      this.layoutBox_,\n      viewport.getScrollLeft(),\n      viewport.getScrollTop()\n    );\n  }\n\n  /**\n   * Returns a previously measured layout box relative to the page. The\n   * fixed-position elements are relative to the top of the document.\n   * @return {!../layout-rect.LayoutRectDef}\n   */\n  getPageLayoutBox() {\n    return this.layoutBox_;\n  }\n\n  /**\n   * Returns the resource's layout box relative to the page. It will be\n   * measured if the resource hasn't ever be measured.\n   *\n   * @return {!Promise<!../layout-rect.LayoutRectDef>}\n   */\n  getPageLayoutBoxAsync() {\n    if (this.hasBeenMeasured()) {\n      return tryResolve(() => this.getPageLayoutBox());\n    }\n    return Services.vsyncFor(this.hostWin).measurePromise(() => {\n      this.measure();\n      return this.getPageLayoutBox();\n    });\n  }\n\n  /**\n   * Returns the first measured layout box.\n   * @return {!../layout-rect.LayoutRectDef}\n   */\n  getInitialLayoutBox() {\n    // Before the first measure, there will be no initial layoutBox.\n    // Luckily, layoutBox will be present but essentially useless.\n    return this.initialLayoutBox_ || this.layoutBox_;\n  }\n\n  /**\n   * Whether the resource is displayed, i.e. if it has non-zero width and\n   * height.\n   * @return {boolean}\n   */\n  isDisplayed() {\n    const isFluid = this.element.getLayout() == Layout.FLUID;\n    // TODO(jridgewell): #getSize\n    const box = this.getLayoutBox();\n    const hasNonZeroSize = box.height > 0 && box.width > 0;\n    return (\n      (isFluid || hasNonZeroSize) &&\n      !!this.element.ownerDocument &&\n      !!this.element.ownerDocument.defaultView\n    );\n  }\n\n  /**\n   * Whether the element is fixed according to the latest measurement.\n   * @return {boolean}\n   */\n  isFixed() {\n    return this.isFixed_;\n  }\n\n  /**\n   * Whether the element's layout box overlaps with the specified rect.\n   * @param {!../layout-rect.LayoutRectDef} rect\n   * @return {boolean}\n   */\n  overlaps(rect) {\n    return layoutRectsOverlap(this.getLayoutBox(), rect);\n  }\n\n  /**\n   * Whether this element can be pre-rendered.\n   * @return {boolean}\n   */\n  prerenderAllowed() {\n    return this.element.prerenderAllowed();\n  }\n\n  /**\n   * Whether this element has render-blocking service.\n   * @return {boolean}\n   */\n  isBuildRenderBlocking() {\n    return this.element.isBuildRenderBlocking();\n  }\n\n  /**\n   * @param {number|boolean} viewport derived from renderOutsideViewport.\n   * @return {!Promise} resolves when underlying element is built and within the\n   *    viewport range given.\n   */\n  whenWithinViewport(viewport) {\n    devAssert(viewport !== false);\n    // Resolve is already laid out or viewport is true.\n    if (!this.isLayoutPending() || viewport === true) {\n      return Promise.resolve();\n    }\n    // See if pre-existing promise.\n    const viewportNum = dev().assertNumber(viewport);\n    const key = String(viewportNum);\n    if (this.withViewportDeferreds_ && this.withViewportDeferreds_[key]) {\n      return this.withViewportDeferreds_[key].promise;\n    }\n    // See if already within viewport multiplier.\n    if (this.isWithinViewportRatio(viewportNum)) {\n      return Promise.resolve();\n    }\n    // return promise that will trigger when within viewport multiple.\n    this.withViewportDeferreds_ = this.withViewportDeferreds_ || {};\n    this.withViewportDeferreds_[key] = new Deferred();\n    return this.withViewportDeferreds_[key].promise;\n  }\n\n  /** @private resolves promises populated via whenWithinViewport. */\n  resolveDeferredsWhenWithinViewports_() {\n    if (!this.withViewportDeferreds_) {\n      return;\n    }\n    const viewportRatio = this.getDistanceViewportRatio();\n    for (const key in this.withViewportDeferreds_) {\n      if (this.isWithinViewportRatio(parseFloat(key), viewportRatio)) {\n        this.withViewportDeferreds_[key].resolve();\n        delete this.withViewportDeferreds_[key];\n      }\n    }\n  }\n\n  /** @return {!ViewportRatioDef} */\n  getDistanceViewportRatio() {\n    // Numeric interface, element is allowed to render outside viewport when it\n    // is within X times the viewport height of the current viewport.\n    const viewport = Services.viewportForDoc(this.element);\n    const viewportBox = viewport.getRect();\n    const layoutBox = this.getLayoutBox();\n    const scrollDirection = this.resources_.getScrollDirection();\n    let scrollPenalty = 1;\n    let distance = 0;\n\n    if (\n      viewportBox.right < layoutBox.left ||\n      viewportBox.left > layoutBox.right\n    ) {\n      // If outside of viewport's x-axis, element is not in viewport so return\n      // false.\n      return {distance: false};\n    }\n\n    if (viewportBox.bottom < layoutBox.top) {\n      // Element is below viewport\n      distance = layoutBox.top - viewportBox.bottom;\n\n      // If we're scrolling away from the element\n      if (scrollDirection == -1) {\n        scrollPenalty = 2;\n      }\n    } else if (viewportBox.top > layoutBox.bottom) {\n      // Element is above viewport\n      distance = viewportBox.top - layoutBox.bottom;\n\n      // If we're scrolling away from the element\n      if (scrollDirection == 1) {\n        scrollPenalty = 2;\n      }\n    } else {\n      // Element is in viewport so return true for all but boolean false.\n      return {distance: true};\n    }\n    return {distance, scrollPenalty, viewportHeight: viewportBox.height};\n  }\n\n  /**\n   * @param {number|boolean} multiplier\n   * @param {ViewportRatioDef=} opt_viewportRatio\n   * @return {boolean} whether multiplier given is within viewport ratio\n   * @visibleForTesting\n   */\n  isWithinViewportRatio(multiplier, opt_viewportRatio) {\n    if (typeof multiplier === 'boolean') {\n      return multiplier;\n    }\n    const {distance, scrollPenalty, viewportHeight} =\n      opt_viewportRatio || this.getDistanceViewportRatio();\n    if (typeof distance == 'boolean') {\n      return distance;\n    }\n    return distance < (viewportHeight * multiplier) / scrollPenalty;\n  }\n\n  /**\n   * Whether this is allowed to render when not in viewport.\n   * @return {boolean}\n   */\n  renderOutsideViewport() {\n    // The exception is for owned resources, since they only attempt to\n    // render outside viewport when the owner has explicitly allowed it.\n    // TODO(jridgewell, #5803): Resources should be asking owner if it can\n    // prerender this resource, so that it can avoid expensive elements wayyy\n    // outside of viewport. For now, blindly trust that owner knows what it's\n    // doing.\n    this.resolveDeferredsWhenWithinViewports_();\n    return (\n      this.hasOwner() ||\n      this.isWithinViewportRatio(this.element.renderOutsideViewport())\n    );\n  }\n\n  /**\n   * Whether this is allowed to render when scheduler is idle but not in\n   * viewport.\n   * @return {boolean}\n   */\n  idleRenderOutsideViewport() {\n    return this.isWithinViewportRatio(this.element.idleRenderOutsideViewport());\n  }\n\n  /**\n   * Sets the resource's state to LAYOUT_SCHEDULED.\n   * @param {number} scheduleTime The time at which layout was scheduled.\n   */\n  layoutScheduled(scheduleTime) {\n    this.state_ = ResourceState.LAYOUT_SCHEDULED;\n    this.element.layoutScheduleTime = scheduleTime;\n  }\n\n  /**\n   * Undoes `layoutScheduled`.\n   */\n  layoutCanceled() {\n    this.state_ = this.hasBeenMeasured()\n      ? ResourceState.READY_FOR_LAYOUT\n      : ResourceState.NOT_LAID_OUT;\n  }\n\n  /**\n   * Starts the layout of the resource. Returns the promise that will yield\n   * once layout is complete. Only allowed to be called on a upgraded, built\n   * and displayed element.\n   * @return {!Promise}\n   * @package\n   */\n  startLayout() {\n    if (this.layoutPromise_) {\n      return this.layoutPromise_;\n    }\n    if (this.state_ == ResourceState.LAYOUT_COMPLETE) {\n      return Promise.resolve();\n    }\n    if (this.state_ == ResourceState.LAYOUT_FAILED) {\n      return Promise.reject(this.lastLayoutError_);\n    }\n\n    devAssert(\n      this.state_ != ResourceState.NOT_BUILT,\n      'Not ready to start layout: %s (%s)',\n      this.debugid,\n      this.state_\n    );\n    devAssert(this.isDisplayed(), 'Not displayed for layout: %s', this.debugid);\n\n    // Unwanted re-layouts are ignored.\n    if (this.layoutCount_ > 0 && !this.element.isRelayoutNeeded()) {\n      dev().fine(\n        TAG,\n        \"layout canceled since it wasn't requested:\",\n        this.debugid,\n        this.state_\n      );\n      this.state_ = ResourceState.LAYOUT_COMPLETE;\n      return Promise.resolve();\n    }\n\n    dev().fine(TAG, 'start layout:', this.debugid, 'count:', this.layoutCount_);\n    this.layoutCount_++;\n    this.state_ = ResourceState.LAYOUT_SCHEDULED;\n\n    const promise = new Promise((resolve, reject) => {\n      Services.vsyncFor(this.hostWin).mutate(() => {\n        try {\n          resolve(this.element.layoutCallback());\n        } catch (e) {\n          reject(e);\n        }\n      });\n    });\n\n    this.layoutPromise_ = promise.then(\n      () => this.layoutComplete_(true),\n      reason => this.layoutComplete_(false, reason)\n    );\n    return this.layoutPromise_;\n  }\n\n  /**\n   * @param {boolean} success\n   * @param {*=} opt_reason\n   * @return {!Promise|undefined}\n   */\n  layoutComplete_(success, opt_reason) {\n    if (this.loadPromiseResolve_) {\n      this.loadPromiseResolve_();\n      this.loadPromiseResolve_ = null;\n    }\n    this.layoutPromise_ = null;\n    this.loadedOnce_ = true;\n    this.state_ = success\n      ? ResourceState.LAYOUT_COMPLETE\n      : ResourceState.LAYOUT_FAILED;\n    this.lastLayoutError_ = opt_reason;\n    if (success) {\n      dev().fine(TAG, 'layout complete:', this.debugid);\n    } else {\n      dev().fine(TAG, 'loading failed:', this.debugid, opt_reason);\n      return Promise.reject(opt_reason);\n    }\n  }\n\n  /**\n   * Returns true if the resource layout has not completed or failed.\n   * @return {boolean}\n   * */\n  isLayoutPending() {\n    return (\n      this.state_ != ResourceState.LAYOUT_COMPLETE &&\n      this.state_ != ResourceState.LAYOUT_FAILED\n    );\n  }\n\n  /**\n   * Returns a promise that is resolved when this resource is laid out\n   * for the first time and the resource was loaded. Note that the resource\n   * could be unloaded subsequently. This method returns resolved promise for\n   * sunch unloaded elements.\n   * @return {!Promise}\n   */\n  loadedOnce() {\n    return this.loadPromise_;\n  }\n\n  /**\n   * @return {boolean} true if the resource has been loaded at least once.\n   */\n  hasLoadedOnce() {\n    return this.loadedOnce_;\n  }\n\n  /**\n   * Whether the resource is currently visible in the viewport.\n   * @return {boolean}\n   */\n  isInViewport() {\n    const isInViewport = this.element.isInViewport();\n    if (isInViewport) {\n      this.resolveDeferredsWhenWithinViewports_();\n    }\n    return isInViewport;\n  }\n\n  /**\n   * Updates the inViewport state of the element.\n   * @param {boolean} inViewport\n   */\n  setInViewport(inViewport) {\n    this.element.viewportCallback(inViewport);\n  }\n\n  /**\n   * Calls element's unlayoutCallback callback and resets state for\n   * relayout in case document becomes active again.\n   */\n  unlayout() {\n    if (\n      this.state_ == ResourceState.NOT_BUILT ||\n      this.state_ == ResourceState.NOT_LAID_OUT\n    ) {\n      return;\n    }\n    this.setInViewport(false);\n    if (this.element.unlayoutCallback()) {\n      this.element.togglePlaceholder(true);\n      this.state_ = ResourceState.NOT_LAID_OUT;\n      this.layoutCount_ = 0;\n      this.layoutPromise_ = null;\n    }\n  }\n\n  /**\n   * Returns the task ID for this resource.\n   * @param {string} localId\n   * @return {string}\n   */\n  getTaskId(localId) {\n    return this.debugid + '#' + localId;\n  }\n\n  /**\n   * Calls element's pauseCallback callback.\n   */\n  pause() {\n    this.element.pauseCallback();\n    if (this.element.unlayoutOnPause()) {\n      this.unlayout();\n    }\n  }\n\n  /**\n   * Calls element's pauseCallback callback.\n   */\n  pauseOnRemove() {\n    this.element.pauseCallback();\n  }\n\n  /**\n   * Calls element's resumeCallback callback.\n   */\n  resume() {\n    this.element.resumeCallback();\n  }\n\n  /**\n   * Called when a previously visible element is no longer displayed.\n   */\n  unload() {\n    this.pause();\n    this.unlayout();\n  }\n\n  /**\n   * Disconnect the resource. Mainly intended for embed resources that do not\n   * receive `disconnectedCallback` naturally via CE API.\n   */\n  disconnect() {\n    delete this.element[RESOURCE_PROP_];\n    this.element.disconnect(/* opt_pretendDisconnected */ true);\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../utils/promise';\nimport {FiniteStateMachine} from '../finite-state-machine';\nimport {FocusHistory} from '../focus-history';\nimport {Pass} from '../pass';\nimport {READY_SCAN_SIGNAL, ResourcesInterface} from './resources-interface';\nimport {Resource, ResourceState} from './resource';\nimport {Services} from '../services';\nimport {TaskQueue} from './task-queue';\nimport {VisibilityState} from '../visibility-state';\nimport {areMarginsChanged, expandLayoutRect} from '../layout-rect';\nimport {closest, hasNextNodeInDocumentOrder} from '../dom';\nimport {computedStyle} from '../style';\nimport {dev, devAssert} from '../log';\nimport {dict} from '../utils/object';\nimport {getSourceUrl} from '../url';\nimport {checkAndFix as ieMediaCheckAndFix} from './ie-media-bug';\nimport {isBlockedByConsent, reportError} from '../error';\nimport {isExperimentOn} from '../experiments';\nimport {loadPromise} from '../event-helper';\nimport {registerServiceBuilderForDoc} from '../service';\nimport {remove} from '../utils/array';\nimport {startupChunk} from '../chunk';\n\nconst TAG_ = 'Resources';\nconst LAYOUT_TASK_ID_ = 'L';\nconst LAYOUT_TASK_OFFSET_ = 0;\nconst PRELOAD_TASK_ID_ = 'P';\nconst PRELOAD_TASK_OFFSET_ = 2;\nconst PRIORITY_BASE_ = 10;\nconst PRIORITY_PENALTY_TIME_ = 1000;\nconst POST_TASK_PASS_DELAY_ = 1000;\nconst MUTATE_DEFER_DELAY_ = 500;\nconst FOCUS_HISTORY_TIMEOUT_ = 1000 * 60; // 1min\nconst FOUR_FRAME_DELAY_ = 70;\n\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   newMargins: !../layout-rect.LayoutMarginsChangeDef,\n *   currentMargins: !../layout-rect.LayoutMarginsDef\n * }}\n */\nlet MarginChangeDef;\n\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   resource: !Resource,\n *   newHeight: (number|undefined),\n *   newWidth: (number|undefined),\n *   marginChange: (!MarginChangeDef|undefined),\n *   event: (?Event|undefined),\n *   force: boolean,\n *   callback: (function(boolean)|undefined),\n * }}\n */\nlet ChangeSizeRequestDef;\n\n/**\n * @implements {ResourcesInterface}\n */\nexport class ResourcesImpl {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!Window} */\n    this.win = ampdoc.win;\n\n    /** @const @private {!./viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(ampdoc);\n\n    /** @private {boolean} */\n    this.isRuntimeOn_ = this.viewer_.isRuntimeOn();\n\n    /**\n     * Used primarily for testing to allow build phase to proceed.\n     * @const @private {boolean}\n     */\n    this.isBuildOn_ = false;\n\n    /** @private {number} */\n    this.resourceIdCounter_ = 0;\n\n    /** @private @const {!Array<!Resource>} */\n    this.resources_ = [];\n\n    /** @private {number} */\n    this.addCount_ = 0;\n\n    /** @private {number} */\n    this.buildAttemptsCount_ = 0;\n\n    /** @private {boolean} */\n    this.visible_ = this.ampdoc.isVisible();\n\n    /** @private {number} */\n    this.prerenderSize_ = this.viewer_.getPrerenderSize();\n\n    /** @private {boolean} */\n    this.documentReady_ = false;\n\n    /**\n     * We want to do some work in the first pass after\n     * the document is ready.\n     * @private {boolean}\n     */\n    this.firstPassAfterDocumentReady_ = true;\n\n    /**\n     * Whether AMP has been fully initialized.\n     * @private {boolean}\n     */\n    this.ampInitialized_ = false;\n\n    /**\n     * We also adjust the timeout penalty shortly after the first pass.\n     * @private {number}\n     */\n    this.firstVisibleTime_ = -1;\n\n    /** @private {boolean} */\n    this.relayoutAll_ = true;\n\n    /**\n     * TODO(jridgewell): relayoutTop should be replaced with parent layer\n     * dirtying.\n     * @private {number}\n     */\n    this.relayoutTop_ = -1;\n\n    /** @private {time} */\n    this.lastScrollTime_ = 0;\n\n    /** @private {number} */\n    this.lastVelocity_ = 0;\n\n    /** @const @private {!Pass} */\n    this.pass_ = new Pass(this.win, () => this.doPass());\n\n    /** @const @private {!Pass} */\n    this.remeasurePass_ = new Pass(this.win, () => {\n      this.relayoutAll_ = true;\n      this.schedulePass();\n    });\n\n    /** @const {!TaskQueue} */\n    this.exec_ = new TaskQueue();\n\n    /** @const {!TaskQueue} */\n    this.queue_ = new TaskQueue();\n\n    /** @const {!function(./task-queue.TaskDef, !Object<string, *>):number} */\n    this.boundTaskScorer_ = this.calcTaskScore_.bind(this);\n\n    /**\n     * @private {!Array<!ChangeSizeRequestDef>}\n     */\n    this.requestsChangeSize_ = [];\n\n    /** @private {?Array<!Resource>} */\n    this.pendingBuildResources_ = [];\n\n    /** @private {boolean} */\n    this.isCurrentlyBuildingPendingResources_ = false;\n\n    /** @private @const {!./viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(this.ampdoc);\n\n    /** @private @const {!./vsync-impl.Vsync} */\n    this.vsync_ = Services./*OK*/ vsyncFor(this.win);\n\n    /** @private @const {!FocusHistory} */\n    this.activeHistory_ = new FocusHistory(this.win, FOCUS_HISTORY_TIMEOUT_);\n\n    /** @private {boolean} */\n    this.vsyncScheduled_ = false;\n\n    /** @private {number} */\n    this.contentHeight_ = 0;\n\n    /** @private {boolean} */\n    this.maybeChangeHeight_ = false;\n\n    /** @const @private {!Array<function()>} */\n    this.passCallbacks_ = [];\n\n    /** @const @private {!Deferred} */\n    this.firstPassDone_ = new Deferred();\n\n    /** @private @const {!FiniteStateMachine<!VisibilityState>} */\n    this.visibilityStateMachine_ = new FiniteStateMachine(\n      this.ampdoc.getVisibilityState()\n    );\n\n    // When viewport is resized, we have to re-measure all elements.\n    this.viewport_.onChanged(event => {\n      this.lastScrollTime_ = Date.now();\n      this.lastVelocity_ = event.velocity;\n      if (event.relayoutAll) {\n        this.relayoutAll_ = true;\n        this.maybeChangeHeight_ = true;\n      }\n      this.schedulePass();\n    });\n    this.viewport_.onScroll(() => {\n      this.lastScrollTime_ = Date.now();\n    });\n\n    // When document becomes visible, e.g. from \"prerender\" mode, do a\n    // simple pass.\n    this.ampdoc.onVisibilityChanged(() => {\n      if (this.firstVisibleTime_ == -1 && this.ampdoc.isVisible()) {\n        this.firstVisibleTime_ = Date.now();\n      }\n      this.schedulePass();\n    });\n\n    this.viewer_.onRuntimeState(state => {\n      dev().fine(TAG_, 'Runtime state:', state);\n      this.isRuntimeOn_ = state;\n      this.schedulePass(1);\n    });\n\n    this.activeHistory_.onFocus(element => {\n      this.checkPendingChangeSize_(element);\n    });\n\n    // Schedule initial passes. This must happen in a startup task\n    // to avoid blocking body visible.\n    startupChunk(this.ampdoc, () => {\n      this.setupVisibilityStateMachine_(this.visibilityStateMachine_);\n      this.schedulePass(0);\n    });\n\n    this.rebuildDomWhenReady_();\n  }\n\n  /** @private */\n  rebuildDomWhenReady_() {\n    // Ensure that we attempt to rebuild things when DOM is ready.\n    this.ampdoc.whenReady().then(() => {\n      this.documentReady_ = true;\n      this.buildReadyResources_();\n      this.pendingBuildResources_ = null;\n      const fixPromise = ieMediaCheckAndFix(this.win);\n      const remeasure = () => this.remeasurePass_.schedule();\n      if (fixPromise) {\n        fixPromise.then(remeasure);\n      } else {\n        // No promise means that there's no problem.\n        remeasure();\n      }\n      this.monitorInput_();\n\n      // Safari 10 and under incorrectly estimates font spacing for\n      // `@font-face` fonts. This leads to wild measurement errors. The best\n      // course of action is to remeasure everything on window.onload or font\n      // timeout (3s), whichever is earlier. This has to be done on the global\n      // window because this is where the fonts are always added.\n      // Unfortunately, `document.fonts.ready` cannot be used here due to\n      // https://bugs.webkit.org/show_bug.cgi?id=174030.\n      // See https://bugs.webkit.org/show_bug.cgi?id=174031 for more details.\n      Promise.race([\n        loadPromise(this.win),\n        Services.timerFor(this.win).promise(3100),\n      ]).then(remeasure);\n\n      // Remeasure the document when all fonts loaded.\n      if (\n        this.win.document.fonts &&\n        this.win.document.fonts.status != 'loaded'\n      ) {\n        this.win.document.fonts.ready.then(remeasure);\n      }\n    });\n  }\n\n  /** @override */\n  get() {\n    return this.resources_.slice(0);\n  }\n\n  /** @override */\n  getAmpdoc() {\n    return this.ampdoc;\n  }\n\n  /** @private */\n  monitorInput_() {\n    const input = Services.inputFor(this.win);\n    input.onTouchDetected(detected => {\n      this.toggleInputClass_('amp-mode-touch', detected);\n    }, true);\n    input.onMouseDetected(detected => {\n      this.toggleInputClass_('amp-mode-mouse', detected);\n    }, true);\n    input.onKeyboardStateChanged(active => {\n      this.toggleInputClass_('amp-mode-keyboard-active', active);\n    }, true);\n  }\n\n  /**\n   * @param {string} clazz\n   * @param {boolean} on\n   * @private\n   */\n  toggleInputClass_(clazz, on) {\n    this.ampdoc.waitForBodyOpen().then(body => {\n      this.vsync_.mutate(() => {\n        body.classList.toggle(clazz, on);\n      });\n    });\n  }\n\n  /** @override */\n  getResourceForElement(element) {\n    return Resource.forElement(element);\n  }\n\n  /** @override */\n  getResourceForElementOptional(element) {\n    return Resource.forElementOptional(element);\n  }\n\n  /** @override */\n  getScrollDirection() {\n    return Math.sign(this.lastVelocity_) || 1;\n  }\n\n  /** @override */\n  add(element) {\n    // Ensure the viewport is ready to accept the first element.\n    this.addCount_++;\n    if (this.addCount_ == 1) {\n      this.viewport_.ensureReadyForElements();\n    }\n\n    // First check if the resource is being reparented and if it requires\n    // reconstruction. Only already built elements are eligible.\n    let resource = Resource.forElementOptional(element);\n    if (\n      resource &&\n      resource.getState() != ResourceState.NOT_BUILT &&\n      !element.reconstructWhenReparented()\n    ) {\n      resource.requestMeasure();\n      dev().fine(TAG_, 'resource reused:', resource.debugid);\n    } else {\n      // Create and add a new resource.\n      resource = new Resource(++this.resourceIdCounter_, element, this);\n      dev().fine(TAG_, 'resource added:', resource.debugid);\n    }\n    this.resources_.push(resource);\n    this.remeasurePass_.schedule(1000);\n  }\n\n  /**\n   * Limits the number of elements being build in pre-render phase to\n   * a finite number. Returns false if the number has been reached.\n   * @return {boolean}\n   */\n  isUnderBuildQuota_() {\n    // For pre-render we want to limit the amount of CPU used, so we limit\n    // the number of elements build. For pre-render to \"seem complete\"\n    // we only need to build elements in the first viewport. We can't know\n    // which are actually in the viewport (because the decision is pre-layout,\n    // so we use a heuristic instead.\n    // Most documents have 10 or less AMP tags. By building 20 we should not\n    // change the behavior for the vast majority of docs, and almost always\n    // catch everything in the first viewport.\n    return this.buildAttemptsCount_ < 20 || this.ampdoc.hasBeenVisible();\n  }\n\n  /**\n   * Builds the element if ready to be built, otherwise adds it to pending\n   * resources.\n   * @param {!Resource} resource\n   * @param {boolean=} checkForDupes\n   * @param {boolean=} scheduleWhenBuilt\n   * @param {boolean=} force\n   * @private\n   */\n  buildOrScheduleBuildForResource_(\n    resource,\n    checkForDupes = false,\n    scheduleWhenBuilt = true,\n    force = false\n  ) {\n    const buildingEnabled = this.isRuntimeOn_ || this.isBuildOn_;\n\n    // During prerender mode, don't build elements that aren't allowed to be\n    // prerendered. This avoids wasting our prerender build quota.\n    // See isUnderBuildQuota_() for more details.\n    const shouldBuildResource =\n      this.ampdoc.getVisibilityState() != VisibilityState.PRERENDER ||\n      resource.prerenderAllowed();\n\n    if (buildingEnabled && shouldBuildResource) {\n      if (this.documentReady_) {\n        // Build resource immediately, the document has already been parsed.\n        this.buildResourceUnsafe_(resource, scheduleWhenBuilt, force);\n      } else if (!resource.isBuilt() && !resource.isBuilding()) {\n        if (!checkForDupes || !this.pendingBuildResources_.includes(resource)) {\n          // Otherwise add to pending resources and try to build any ready ones.\n          this.pendingBuildResources_.push(resource);\n          this.buildReadyResources_(scheduleWhenBuilt);\n        }\n      }\n    }\n  }\n\n  /**\n   * Builds resources that are ready to be built.\n   * @param {boolean=} scheduleWhenBuilt\n   * @private\n   */\n  buildReadyResources_(scheduleWhenBuilt = true) {\n    // Avoid cases where elements add more elements inside of them\n    // and cause an infinite loop of building - see #3354 for details.\n    if (this.isCurrentlyBuildingPendingResources_) {\n      return;\n    }\n    try {\n      this.isCurrentlyBuildingPendingResources_ = true;\n      this.buildReadyResourcesUnsafe_(scheduleWhenBuilt);\n    } finally {\n      this.isCurrentlyBuildingPendingResources_ = false;\n    }\n  }\n\n  /**\n   * @param {boolean=} scheduleWhenBuilt\n   * @private\n   */\n  buildReadyResourcesUnsafe_(scheduleWhenBuilt = true) {\n    // This will loop over all current pending resources and those that\n    // get added by other resources build-cycle, this will make sure all\n    // elements get a chance to be built.\n    for (let i = 0; i < this.pendingBuildResources_.length; i++) {\n      const resource = this.pendingBuildResources_[i];\n      if (\n        this.documentReady_ ||\n        hasNextNodeInDocumentOrder(resource.element, this.ampdoc.getRootNode())\n      ) {\n        // Remove resource before build to remove it from the pending list\n        // in either case the build succeed or throws an error.\n        this.pendingBuildResources_.splice(i--, 1);\n        this.buildResourceUnsafe_(resource, scheduleWhenBuilt);\n      }\n    }\n  }\n\n  /**\n   * @param {!Resource} resource\n   * @param {boolean} schedulePass\n   * @param {boolean=} force\n   * @return {?Promise}\n   * @private\n   */\n  buildResourceUnsafe_(resource, schedulePass, force = false) {\n    if (\n      !this.isUnderBuildQuota_() &&\n      !force &&\n      !resource.isBuildRenderBlocking()\n    ) {\n      return null;\n    }\n    const promise = resource.build();\n    if (!promise) {\n      return null;\n    }\n    this.buildAttemptsCount_++;\n    if (!schedulePass) {\n      return promise;\n    }\n    return promise.then(\n      () => this.schedulePass(),\n      error => {\n        // Build failed: remove the resource. No other state changes are\n        // needed.\n        this.removeResource_(resource);\n        if (!isBlockedByConsent(error)) {\n          throw error;\n        }\n      }\n    );\n  }\n\n  /** @override */\n  remove(element) {\n    const resource = Resource.forElementOptional(element);\n    if (!resource) {\n      return;\n    }\n    this.removeResource_(resource);\n  }\n\n  /**\n   * @param {!Resource} resource\n   * @private\n   */\n  removeResource_(resource) {\n    const index = this.resources_.indexOf(resource);\n    if (index != -1) {\n      this.resources_.splice(index, 1);\n    }\n    if (resource.isBuilt()) {\n      resource.pauseOnRemove();\n    }\n    this.cleanupTasks_(resource, /* opt_removePending */ true);\n    dev().fine(TAG_, 'element removed:', resource.debugid);\n  }\n\n  /** @override */\n  upgraded(element) {\n    const resource = Resource.forElement(element);\n    this.buildOrScheduleBuildForResource_(resource);\n    dev().fine(TAG_, 'element upgraded:', resource.debugid);\n  }\n\n  /** @override */\n  updateLayoutPriority(element, newLayoutPriority) {\n    const resource = Resource.forElement(element);\n\n    resource.updateLayoutPriority(newLayoutPriority);\n\n    // Update affected tasks\n    this.queue_.forEach(task => {\n      if (task.resource == resource) {\n        task.priority = newLayoutPriority;\n      }\n    });\n\n    this.schedulePass();\n  }\n\n  /** @override */\n  changeSize(element, newHeight, newWidth, opt_callback, opt_newMargins) {\n    this.scheduleChangeSize_(\n      Resource.forElement(element),\n      newHeight,\n      newWidth,\n      opt_newMargins,\n      /* event */ undefined,\n      /* force */ true,\n      opt_callback\n    );\n  }\n\n  /** @override */\n  attemptChangeSize(element, newHeight, newWidth, opt_newMargins, opt_event) {\n    return new Promise((resolve, reject) => {\n      this.scheduleChangeSize_(\n        Resource.forElement(element),\n        newHeight,\n        newWidth,\n        opt_newMargins,\n        opt_event,\n        /* force */ false,\n        success => {\n          if (success) {\n            resolve();\n          } else {\n            reject(new Error('changeSize attempt denied'));\n          }\n        }\n      );\n    });\n  }\n\n  /** @override */\n  measureElement(measurer) {\n    return this.vsync_.measurePromise(measurer);\n  }\n\n  /** @override */\n  mutateElement(element, mutator) {\n    return this.measureMutateElement(element, null, mutator);\n  }\n\n  /** @override */\n  measureMutateElement(element, measurer, mutator) {\n    return this.measureMutateElementResources_(element, measurer, mutator);\n  }\n\n  /**\n   * Handles element mutation (and measurement) APIs in the Resources system.\n   *\n   * @param {!Element} element\n   * @param {?function()} measurer\n   * @param {function()} mutator\n   * @return {!Promise}\n   */\n  measureMutateElementResources_(element, measurer, mutator) {\n    const calcRelayoutTop = () => {\n      const box = this.viewport_.getLayoutRect(element);\n      if (box.width != 0 && box.height != 0) {\n        return box.top;\n      }\n      return -1;\n    };\n    let relayoutTop = -1;\n    // TODO(jridgewell): support state\n    return this.vsync_.runPromise({\n      measure: () => {\n        if (measurer) {\n          measurer();\n        }\n        relayoutTop = calcRelayoutTop();\n      },\n      mutate: () => {\n        mutator();\n\n        if (element.classList.contains('i-amphtml-element')) {\n          const r = Resource.forElement(element);\n          r.requestMeasure();\n        }\n        const ampElements = element.getElementsByClassName('i-amphtml-element');\n        for (let i = 0; i < ampElements.length; i++) {\n          const r = Resource.forElement(ampElements[i]);\n          r.requestMeasure();\n        }\n        if (relayoutTop != -1) {\n          this.setRelayoutTop_(relayoutTop);\n        }\n        this.schedulePass(FOUR_FRAME_DELAY_);\n\n        // Need to measure again in case the element has become visible or\n        // shifted.\n        this.vsync_.measure(() => {\n          const updatedRelayoutTop = calcRelayoutTop();\n          if (updatedRelayoutTop != -1 && updatedRelayoutTop != relayoutTop) {\n            this.setRelayoutTop_(updatedRelayoutTop);\n            this.schedulePass(FOUR_FRAME_DELAY_);\n          }\n          this.maybeChangeHeight_ = true;\n        });\n      },\n    });\n  }\n\n  /**\n   * Dirties the cached element measurements after a mutation occurs.\n   *\n   * TODO(jridgewell): This API needs to be audited. Common practice is\n   * to pass the amp-element in as the root even though we are only\n   * mutating children. If the amp-element is passed, we invalidate\n   * everything in the parent layer above it, where only invalidating the\n   * amp-element was necessary (only children were mutated, only\n   * amp-element's scroll box is affected).\n   *\n   * @param {!Element} element\n   */\n  dirtyElement(element) {\n    let relayoutAll = false;\n    const isAmpElement = element.classList.contains('i-amphtml-element');\n    if (isAmpElement) {\n      const r = Resource.forElement(element);\n      this.setRelayoutTop_(r.getLayoutBox().top);\n    } else {\n      relayoutAll = true;\n    }\n    this.schedulePass(FOUR_FRAME_DELAY_, relayoutAll);\n  }\n\n  /** @override */\n  attemptCollapse(element) {\n    return new Promise((resolve, reject) => {\n      this.scheduleChangeSize_(\n        Resource.forElement(element),\n        0,\n        0,\n        /* newMargin */ undefined,\n        /* event */ undefined,\n        /* force */ false,\n        success => {\n          if (success) {\n            const resource = Resource.forElement(element);\n            resource.completeCollapse();\n            resolve();\n          } else {\n            reject(dev().createExpectedError('collapse attempt denied'));\n          }\n        }\n      );\n    });\n  }\n\n  /** @override */\n  collapseElement(element) {\n    const box = this.viewport_.getLayoutRect(element);\n    const resource = Resource.forElement(element);\n    if (box.width != 0 && box.height != 0) {\n      if (isExperimentOn(this.win, 'dirty-collapse-element')) {\n        this.dirtyElement(element);\n      } else {\n        this.setRelayoutTop_(box.top);\n      }\n    }\n    resource.completeCollapse();\n    this.schedulePass(FOUR_FRAME_DELAY_);\n  }\n\n  /** @override */\n  expandElement(element) {\n    const resource = Resource.forElement(element);\n    resource.completeExpand();\n\n    const owner = resource.getOwner();\n    if (owner) {\n      owner.expandedCallback(element);\n    }\n\n    this.schedulePass(FOUR_FRAME_DELAY_);\n  }\n\n  /** @override */\n  schedulePass(opt_delay, opt_relayoutAll) {\n    if (opt_relayoutAll) {\n      this.relayoutAll_ = true;\n    }\n    return this.pass_.schedule(opt_delay);\n  }\n\n  /**\n   * Schedules the work pass at the latest with the specified delay.\n   * @private\n   */\n  schedulePassVsync_() {\n    if (this.vsyncScheduled_) {\n      return;\n    }\n    this.vsyncScheduled_ = true;\n    this.vsync_.mutate(() => this.doPass());\n  }\n\n  /** @override */\n  ampInitComplete() {\n    this.ampInitialized_ = true;\n    this.schedulePass();\n  }\n\n  /** @override */\n  onNextPass(callback) {\n    this.passCallbacks_.push(callback);\n  }\n\n  /**\n   * Runs a pass immediately.\n   *\n   * @visibleForTesting\n   */\n  doPass() {\n    if (!this.isRuntimeOn_) {\n      dev().fine(TAG_, 'runtime is off');\n      return;\n    }\n\n    this.visible_ = this.ampdoc.isVisible();\n    this.prerenderSize_ = this.viewer_.getPrerenderSize();\n\n    const firstPassAfterDocumentReady =\n      this.documentReady_ && this.firstPassAfterDocumentReady_;\n    if (firstPassAfterDocumentReady) {\n      this.firstPassAfterDocumentReady_ = false;\n      const doc = this.win.document;\n      const documentInfo = Services.documentInfoForDoc(this.ampdoc);\n      this.viewer_.sendMessage(\n        'documentLoaded',\n        dict({\n          'title': doc.title,\n          'sourceUrl': getSourceUrl(this.ampdoc.getUrl()),\n          'serverLayout': doc.documentElement.hasAttribute('i-amphtml-element'),\n          'linkRels': documentInfo.linkRels,\n          'metaTags': documentInfo.metaTags,\n        }),\n        /* cancelUnsent */ true\n      );\n\n      this.contentHeight_ = this.viewport_.getContentHeight();\n      this.viewer_.sendMessage(\n        'documentHeight',\n        dict({'height': this.contentHeight_}),\n        /* cancelUnsent */ true\n      );\n      dev().fine(TAG_, 'document height on load: %s', this.contentHeight_);\n    }\n\n    const viewportSize = this.viewport_.getSize();\n    dev().fine(\n      TAG_,\n      'PASS: visible=',\n      this.visible_,\n      ', relayoutAll=',\n      this.relayoutAll_,\n      ', relayoutTop=',\n      this.relayoutTop_,\n      ', viewportSize=',\n      viewportSize.width,\n      viewportSize.height,\n      ', prerenderSize=',\n      this.prerenderSize_\n    );\n    this.pass_.cancel();\n    this.vsyncScheduled_ = false;\n\n    this.visibilityStateMachine_.setState(this.ampdoc.getVisibilityState());\n    if (\n      this.documentReady_ &&\n      this.ampInitialized_ &&\n      !this.ampdoc.signals().get(READY_SCAN_SIGNAL)\n    ) {\n      // This signal mainly signifies that most of elements have been measured\n      // by now. This is mostly used to avoid measuring too many elements\n      // individually. This will be superceeded by layers API, e.g.\n      // \"layer measured\".\n      // May not be called in shadow mode.\n      this.ampdoc.signals().signal(READY_SCAN_SIGNAL);\n    }\n\n    if (this.maybeChangeHeight_) {\n      this.maybeChangeHeight_ = false;\n      this.vsync_.measure(() => {\n        const measuredContentHeight = this.viewport_.getContentHeight();\n        if (measuredContentHeight != this.contentHeight_) {\n          this.viewer_.sendMessage(\n            'documentHeight',\n            dict({'height': measuredContentHeight}),\n            /* cancelUnsent */ true\n          );\n          this.contentHeight_ = measuredContentHeight;\n          dev().fine(TAG_, 'document height changed: %s', this.contentHeight_);\n          this.viewport_.contentHeightChanged();\n        }\n      });\n    }\n\n    for (let i = 0; i < this.passCallbacks_.length; i++) {\n      const fn = this.passCallbacks_[i];\n      fn();\n    }\n    this.passCallbacks_.length = 0;\n  }\n\n  /**\n   * Returns `true` when there's mutate work currently batched.\n   * @return {boolean}\n   * @private\n   */\n  hasMutateWork_() {\n    return this.requestsChangeSize_.length > 0;\n  }\n\n  /**\n   * Performs pre-discovery mutates.\n   * @private\n   */\n  mutateWork_() {\n    // Read all necessary data before mutates.\n    // The height changing depends largely on the target element's position\n    // in the active viewport. When not in prerendering, we also consider the\n    // active viewport the part of the visible viewport below 10% from the top\n    // and above 25% from the bottom.\n    // This is basically the portion of the viewport where the reader is most\n    // likely focused right now. The main goal is to avoid drastic UI changes\n    // in that part of the content. The elements below the active viewport are\n    // freely resized. The elements above the viewport are resized and request\n    // scroll adjustment to avoid active viewport changing without user's\n    // action. The elements in the active viewport are not resized and instead\n    // the overflow callbacks are called.\n    const now = Date.now();\n    const viewportRect = this.viewport_.getRect();\n    const topOffset = viewportRect.height / 10;\n    const bottomOffset = viewportRect.height / 10;\n    const isScrollingStopped =\n      (Math.abs(this.lastVelocity_) < 1e-2 &&\n        now - this.lastScrollTime_ > MUTATE_DEFER_DELAY_) ||\n      now - this.lastScrollTime_ > MUTATE_DEFER_DELAY_ * 2;\n\n    // TODO(jridgewell, #12780): Update resize rules to account for layers.\n    if (this.requestsChangeSize_.length > 0) {\n      dev().fine(\n        TAG_,\n        'change size requests:',\n        this.requestsChangeSize_.length\n      );\n      const requestsChangeSize = this.requestsChangeSize_;\n      this.requestsChangeSize_ = [];\n\n      // Find minimum top position and run all mutates.\n      let minTop = -1;\n      const scrollAdjSet = [];\n      let aboveVpHeightChange = 0;\n      for (let i = 0; i < requestsChangeSize.length; i++) {\n        const request = requestsChangeSize[i];\n        const {\n          resource,\n          event,\n        } = /** @type {!ChangeSizeRequestDef} */ (request);\n        const box = resource.getLayoutBox();\n\n        let topMarginDiff = 0;\n        let bottomMarginDiff = 0;\n        let leftMarginDiff = 0;\n        let rightMarginDiff = 0;\n        let {top: topUnchangedBoundary, bottom: bottomDisplacedBoundary} = box;\n        let newMargins = undefined;\n        if (request.marginChange) {\n          newMargins = request.marginChange.newMargins;\n          const margins = request.marginChange.currentMargins;\n          if (newMargins.top != undefined) {\n            topMarginDiff = newMargins.top - margins.top;\n          }\n          if (newMargins.bottom != undefined) {\n            bottomMarginDiff = newMargins.bottom - margins.bottom;\n          }\n          if (newMargins.left != undefined) {\n            leftMarginDiff = newMargins.left - margins.left;\n          }\n          if (newMargins.right != undefined) {\n            rightMarginDiff = newMargins.right - margins.right;\n          }\n          if (topMarginDiff) {\n            topUnchangedBoundary = box.top - margins.top;\n          }\n          if (bottomMarginDiff) {\n            // The lowest boundary of the element that would appear to be\n            // resized as a result of this size change. If the bottom margin is\n            // being changed then it is the bottom edge of the margin box,\n            // otherwise it is the bottom edge of the layout box as set above.\n            bottomDisplacedBoundary = box.bottom + margins.bottom;\n          }\n        }\n        const heightDiff = request.newHeight - box.height;\n        const widthDiff = request.newWidth - box.width;\n\n        // Check resize rules. It will either resize element immediately, or\n        // wait until scrolling stops or will call the overflow callback.\n        let resize = false;\n        if (\n          heightDiff == 0 &&\n          topMarginDiff == 0 &&\n          bottomMarginDiff == 0 &&\n          widthDiff == 0 &&\n          leftMarginDiff == 0 &&\n          rightMarginDiff == 0\n        ) {\n          // 1. Nothing to resize.\n        } else if (request.force || !this.visible_) {\n          // 2. An immediate execution requested or the document is hidden.\n          resize = true;\n        } else if (\n          this.activeHistory_.hasDescendantsOf(resource.element) ||\n          (event && event.userActivation && event.userActivation.hasBeenActive)\n        ) {\n          // 3. Active elements are immediately resized. The assumption is that\n          // the resize is triggered by the user action or soon after.\n          resize = true;\n        } else if (\n          topUnchangedBoundary >= viewportRect.bottom - bottomOffset ||\n          (topMarginDiff == 0 &&\n            box.bottom + Math.min(heightDiff, 0) >=\n              viewportRect.bottom - bottomOffset)\n        ) {\n          // 4. Elements under viewport are resized immediately, but only if\n          // an element's boundary is not changed above the viewport after\n          // resize.\n          resize = true;\n        } else if (\n          viewportRect.top > 1 &&\n          bottomDisplacedBoundary <= viewportRect.top + topOffset\n        ) {\n          // 5. Elements above the viewport can only be resized if we are able\n          // to compensate the height change by setting scrollTop and only if\n          // the page has already been scrolled by some amount (1px due to iOS).\n          // Otherwise the scrolling might move important things like the menu\n          // bar out of the viewport at initial page load.\n          if (\n            heightDiff < 0 &&\n            viewportRect.top + aboveVpHeightChange < -heightDiff\n          ) {\n            // Do nothing if height abobe viewport height can't compensate\n            // height decrease\n            continue;\n          }\n          // Can only resized when scrollinghas stopped,\n          // otherwise defer util next cycle.\n          if (isScrollingStopped) {\n            // These requests will be executed in the next animation cycle and\n            // adjust the scroll position.\n            aboveVpHeightChange = aboveVpHeightChange + heightDiff;\n            scrollAdjSet.push(request);\n          } else {\n            // Defer till next cycle.\n            this.requestsChangeSize_.push(request);\n          }\n          continue;\n        } else if (this.elementNearBottom_(resource, box)) {\n          // 6. Elements close to the bottom of the document (not viewport)\n          // are resized immediately.\n          resize = true;\n        } else if (\n          heightDiff < 0 ||\n          topMarginDiff < 0 ||\n          bottomMarginDiff < 0\n        ) {\n          // 7. The new height (or one of the margins) is smaller than the\n          // current one.\n        } else if (\n          request.newHeight == box.height &&\n          this.isWidthOnlyReflowFreeExpansion_(\n            resource.element,\n            request.newWidth || 0\n          )\n        ) {\n          // 8. Element is in viewport, but this is a width-only expansion that\n          // should not cause reflow.\n          resize = true;\n        } else {\n          // 9. Element is in viewport don't resize and try overflow callback\n          // instead.\n          request.resource.overflowCallback(\n            /* overflown */ true,\n            request.newHeight,\n            request.newWidth,\n            newMargins\n          );\n        }\n\n        if (resize) {\n          if (box.top >= 0) {\n            minTop = minTop == -1 ? box.top : Math.min(minTop, box.top);\n          }\n          request.resource./*OK*/ changeSize(\n            request.newHeight,\n            request.newWidth,\n            newMargins\n          );\n          request.resource.overflowCallback(\n            /* overflown */ false,\n            request.newHeight,\n            request.newWidth,\n            newMargins\n          );\n          this.maybeChangeHeight_ = true;\n        }\n\n        if (request.callback) {\n          request.callback(/* hasSizeChanged */ resize);\n        }\n      }\n\n      if (minTop != -1) {\n        this.setRelayoutTop_(minTop);\n      }\n\n      // Execute scroll-adjusting resize requests, if any.\n      if (scrollAdjSet.length > 0) {\n        this.vsync_.run(\n          {\n            measure: state => {\n              state./*OK*/ scrollHeight = this.viewport_./*OK*/ getScrollHeight();\n              state./*OK*/ scrollTop = this.viewport_./*OK*/ getScrollTop();\n            },\n            mutate: state => {\n              let minTop = -1;\n              scrollAdjSet.forEach(request => {\n                const box = request.resource.getLayoutBox();\n                minTop = minTop == -1 ? box.top : Math.min(minTop, box.top);\n                request.resource./*OK*/ changeSize(\n                  request.newHeight,\n                  request.newWidth,\n                  request.marginChange\n                    ? request.marginChange.newMargins\n                    : undefined\n                );\n                if (request.callback) {\n                  request.callback(/* hasSizeChanged */ true);\n                }\n              });\n              if (minTop != -1) {\n                this.setRelayoutTop_(minTop);\n              }\n              // Sync is necessary here to avoid UI jump in the next frame.\n              const newScrollHeight = this.viewport_./*OK*/ getScrollHeight();\n              if (newScrollHeight != state./*OK*/ scrollHeight) {\n                this.viewport_.setScrollTop(\n                  state./*OK*/ scrollTop +\n                    (newScrollHeight - state./*OK*/ scrollHeight)\n                );\n              }\n              this.maybeChangeHeight_ = true;\n            },\n          },\n          {}\n        );\n      }\n    }\n  }\n\n  /**\n   * Returns true if reflow will not be caused by expanding the given element's\n   * width to the given amount.\n   * @param {!Element} element\n   * @param {number} width\n   * @return {boolean}\n   */\n  isWidthOnlyReflowFreeExpansion_(element, width) {\n    const parent = element.parentElement;\n    // If the element has siblings, it's possible that a width-expansion will\n    // cause some of them to be pushed down.\n    if (!parent || parent.childElementCount > 1) {\n      return false;\n    }\n    const parentWidth =\n      (parent.getImpl && parent.getImpl().getLayoutWidth()) || -1;\n    // Reflow will not happen if the parent element is at least as wide as the\n    // new width.\n    return parentWidth >= width;\n  }\n\n  /**\n   * Returns true if element is within 15% and 1000px of document bottom.\n   * Caller can provide current/initial layout boxes as an optimization.\n   * @param {!./resource.Resource} resource\n   * @param {!../layout-rect.LayoutRectDef=} opt_layoutBox\n   * @param {!../layout-rect.LayoutRectDef=} opt_initialLayoutBox\n   * @return {boolean}\n   * @private\n   */\n  elementNearBottom_(resource, opt_layoutBox, opt_initialLayoutBox) {\n    const contentHeight = this.viewport_.getContentHeight();\n    const threshold = Math.max(contentHeight * 0.85, contentHeight - 1000);\n\n    const box = opt_layoutBox || resource.getLayoutBox();\n    const initialBox = opt_initialLayoutBox || resource.getInitialLayoutBox();\n    return box.bottom >= threshold || initialBox.bottom >= threshold;\n  }\n\n  /**\n   * @param {number} relayoutTop\n   * @private\n   */\n  setRelayoutTop_(relayoutTop) {\n    if (this.relayoutTop_ == -1) {\n      this.relayoutTop_ = relayoutTop;\n    } else {\n      this.relayoutTop_ = Math.min(relayoutTop, this.relayoutTop_);\n    }\n  }\n\n  /**\n   * Reschedules change size request when an overflown element is activated.\n   * @param {!Element} element\n   * @private\n   */\n  checkPendingChangeSize_(element) {\n    const resourceElement = closest(\n      element,\n      el => !!Resource.forElementOptional(el)\n    );\n    if (!resourceElement) {\n      return;\n    }\n    const resource = Resource.forElement(resourceElement);\n    const pendingChangeSize = resource.getPendingChangeSize();\n    if (pendingChangeSize !== undefined) {\n      this.scheduleChangeSize_(\n        resource,\n        pendingChangeSize.height,\n        pendingChangeSize.width,\n        pendingChangeSize.margins,\n        /* event */ undefined,\n        /* force */ true\n      );\n    }\n  }\n\n  /**\n   * Discovers work that needs to be done since the last pass. If viewport\n   * has changed, it will try to build new elements, measure changed elements,\n   * and schedule layouts and preloads within a reasonable distance of the\n   * current viewport. Finally, this process also updates inViewport state\n   * of changed elements.\n   *\n   * Layouts and preloads are not executed immediately, but instead scheduled\n   * in the queue with different priorities.\n   *\n   * @private\n   */\n  discoverWork_() {\n    // TODO(dvoytenko): vsync separation may be needed for different phases\n\n    const now = Date.now();\n\n    // Ensure all resources layout phase complete; when relayoutAll is requested\n    // force re-layout.\n    const relayoutAll = this.relayoutAll_;\n    this.relayoutAll_ = false;\n    const relayoutTop = this.relayoutTop_;\n    this.relayoutTop_ = -1;\n\n    // Phase 1: Build and relayout as needed. All mutations happen here.\n    let relayoutCount = 0;\n    let remeasureCount = 0;\n    for (let i = 0; i < this.resources_.length; i++) {\n      const r = this.resources_[i];\n      if (r.getState() == ResourceState.NOT_BUILT && !r.isBuilding()) {\n        this.buildOrScheduleBuildForResource_(r, /* checkForDupes */ true);\n      }\n      if (\n        relayoutAll ||\n        !r.hasBeenMeasured() ||\n        r.getState() == ResourceState.NOT_LAID_OUT\n      ) {\n        r.applySizesAndMediaQuery();\n        relayoutCount++;\n      }\n      if (r.isMeasureRequested()) {\n        remeasureCount++;\n      }\n    }\n\n    // Phase 2: Remeasure if there were any relayouts. Unfortunately, currently\n    // there's no way to optimize this. All reads happen here.\n    let toUnload;\n    if (\n      relayoutCount > 0 ||\n      remeasureCount > 0 ||\n      relayoutAll ||\n      relayoutTop != -1\n    ) {\n      for (let i = 0; i < this.resources_.length; i++) {\n        const r = this.resources_[i];\n        if (r.hasOwner() && !r.isMeasureRequested()) {\n          // If element has owner, and measure is not requested, do nothing.\n          continue;\n        }\n        if (\n          relayoutAll ||\n          r.getState() == ResourceState.NOT_LAID_OUT ||\n          !r.hasBeenMeasured() ||\n          r.isMeasureRequested() ||\n          (relayoutTop != -1 && r.getLayoutBox().bottom >= relayoutTop)\n        ) {\n          const wasDisplayed = r.isDisplayed();\n          r.measure();\n          if (wasDisplayed && !r.isDisplayed()) {\n            if (!toUnload) {\n              toUnload = [];\n            }\n            toUnload.push(r);\n          }\n        }\n      }\n    }\n\n    // Unload all in one cycle.\n    if (toUnload) {\n      this.vsync_.mutate(() => {\n        toUnload.forEach(r => {\n          r.unload();\n          this.cleanupTasks_(r);\n        });\n      });\n    }\n\n    const viewportRect = this.viewport_.getRect();\n    // Load viewport = viewport + 3x up/down when document is visible or\n    // depending on prerenderSize in pre-render mode.\n    let loadRect;\n    if (this.visible_) {\n      loadRect = expandLayoutRect(viewportRect, 0.25, 2);\n    } else if (this.prerenderSize_ > 0) {\n      loadRect = expandLayoutRect(viewportRect, 0, this.prerenderSize_ - 1);\n    } else {\n      loadRect = null;\n    }\n\n    const visibleRect = this.visible_\n      ? // When the doc is visible, consider the viewport to be 25% larger,\n        // to minimize effect from small scrolling and notify things that\n        // they are in viewport just before they are actually visible.\n        expandLayoutRect(viewportRect, 0.25, 0.25)\n      : viewportRect;\n\n    // Phase 3: Trigger \"viewport enter/exit\" events.\n    for (let i = 0; i < this.resources_.length; i++) {\n      const r = this.resources_[i];\n      if (r.getState() == ResourceState.NOT_BUILT || r.hasOwner()) {\n        continue;\n      }\n      // Note that when the document is not visible, neither are any of its\n      // elements to reduce CPU cycles.\n      // TODO(dvoytenko, #3434): Reimplement the use of `isFixed` with\n      // layers. This is currently a short-term fix to the problem that\n      // the fixed elements get incorrect top coord.\n      const shouldBeInViewport =\n        this.visible_ && r.isDisplayed() && r.overlaps(visibleRect);\n      r.setInViewport(shouldBeInViewport);\n    }\n\n    // Phase 4: Schedule elements for layout within a reasonable distance from\n    // current viewport.\n    if (loadRect) {\n      for (let i = 0; i < this.resources_.length; i++) {\n        const r = this.resources_[i];\n        // TODO(dvoytenko): This extra build has to be merged with the\n        // scheduleLayoutOrPreload method below.\n        // Force build for all resources visible, measured, and in the viewport.\n        if (\n          !r.isBuilt() &&\n          !r.hasOwner() &&\n          r.hasBeenMeasured() &&\n          r.isDisplayed() &&\n          r.overlaps(loadRect)\n        ) {\n          this.buildOrScheduleBuildForResource_(\n            r,\n            /* checkForDupes */ true,\n            /* scheduleWhenBuilt */ undefined,\n            /* force */ true\n          );\n        }\n        if (r.getState() != ResourceState.READY_FOR_LAYOUT || r.hasOwner()) {\n          continue;\n        }\n        // TODO(dvoytenko, #3434): Reimplement the use of `isFixed` with\n        // layers. This is currently a short-term fix to the problem that\n        // the fixed elements get incorrect top coord.\n        if (r.isDisplayed() && r.overlaps(loadRect)) {\n          this.scheduleLayoutOrPreload(r, /* layout */ true);\n        }\n      }\n    }\n\n    if (\n      this.visible_ &&\n      this.exec_.getSize() == 0 &&\n      this.queue_.getSize() == 0 &&\n      now > this.exec_.getLastDequeueTime() + 5000\n    ) {\n      // Phase 5: Idle Render Outside Viewport layout: layout up to 4 items\n      // with idleRenderOutsideViewport true\n      let idleScheduledCount = 0;\n      for (\n        let i = 0;\n        i < this.resources_.length && idleScheduledCount < 4;\n        i++\n      ) {\n        const r = this.resources_[i];\n        if (\n          r.getState() == ResourceState.READY_FOR_LAYOUT &&\n          !r.hasOwner() &&\n          r.isDisplayed() &&\n          r.idleRenderOutsideViewport()\n        ) {\n          dev().fine(TAG_, 'idleRenderOutsideViewport layout:', r.debugid);\n          this.scheduleLayoutOrPreload(r, /* layout */ false);\n          idleScheduledCount++;\n        }\n      }\n      // Phase 6: Idle layout: layout more if we are otherwise not doing much.\n      // TODO(dvoytenko): document/estimate IDLE timeouts and other constants\n      for (\n        let i = 0;\n        i < this.resources_.length && idleScheduledCount < 4;\n        i++\n      ) {\n        const r = this.resources_[i];\n        if (\n          r.getState() == ResourceState.READY_FOR_LAYOUT &&\n          !r.hasOwner() &&\n          r.isDisplayed()\n        ) {\n          dev().fine(TAG_, 'idle layout:', r.debugid);\n          this.scheduleLayoutOrPreload(r, /* layout */ false);\n          idleScheduledCount++;\n        }\n      }\n    }\n  }\n\n  /**\n   * Dequeues layout and preload tasks from the queue and initiates their\n   * execution.\n   *\n   * There are two main drivers to dequeueing: a task's score and timeout. The\n   * score is built based on the resource's priority and viewport location\n   * (see {@link calcTaskScore_}). Timeout depends on the priority and age\n   * of tasks currently in the execution pool (see {@link calcTaskTimeout_}).\n   *\n   * @return {!time}\n   * @private\n   */\n  work_() {\n    const now = Date.now();\n\n    let timeout = -1;\n    const state = Object.create(null);\n    let task = this.queue_.peek(this.boundTaskScorer_, state);\n    while (task) {\n      timeout = this.calcTaskTimeout_(task);\n      dev().fine(\n        TAG_,\n        'peek from queue:',\n        task.id,\n        'sched at',\n        task.scheduleTime,\n        'score',\n        this.boundTaskScorer_(task, state),\n        'timeout',\n        timeout\n      );\n      if (timeout > 16) {\n        break;\n      }\n\n      this.queue_.dequeue(task);\n\n      // Do not override a task in execution. This task will have to wait\n      // until the current one finished the execution.\n      const executing = this.exec_.getTaskById(task.id);\n      if (executing) {\n        // Reschedule post execution.\n        const reschedule = this.reschedule_.bind(this, task);\n        executing.promise.then(reschedule, reschedule);\n      } else {\n        task.resource.measure();\n        if (this.isLayoutAllowed_(task.resource, task.forceOutsideViewport)) {\n          task.promise = task.callback();\n          task.startTime = now;\n          dev().fine(TAG_, 'exec:', task.id, 'at', task.startTime);\n          this.exec_.enqueue(task);\n          task.promise\n            .then(\n              this.taskComplete_.bind(this, task, true),\n              this.taskComplete_.bind(this, task, false)\n            )\n            .catch(/** @type {function (*)} */ (reportError));\n        } else {\n          dev().fine(TAG_, 'cancelled', task.id);\n          task.resource.layoutCanceled();\n        }\n      }\n\n      task = this.queue_.peek(this.boundTaskScorer_, state);\n      timeout = -1;\n    }\n\n    dev().fine(TAG_, 'queue size:', this.queue_.getSize());\n    dev().fine(TAG_, 'exec size:', this.exec_.getSize());\n\n    if (timeout >= 0) {\n      // Still tasks in the queue, but we took too much time.\n      // Schedule the next work pass.\n      return timeout;\n    }\n\n    // No tasks left in the queue.\n    // Schedule the next idle pass.\n    let nextPassDelay = (now - this.exec_.getLastDequeueTime()) * 2;\n    nextPassDelay = Math.max(Math.min(30000, nextPassDelay), 5000);\n    return nextPassDelay;\n  }\n\n  /**\n   * Calculates the task's score. A task with the lowest score will be dequeued\n   * from the queue the first.\n   *\n   * There are three components of the score: element's priority, operation or\n   * offset priority and viewport priority.\n   *\n   * Element's priority is constant of the element's name. E.g. amp-img has a\n   * priority of 0, while amp-ad has a priority of 2.\n   *\n   * The operation (offset) priority is the priority of the task. A layout is\n   * a high-priority task while preload is a lower-priority task.\n   *\n   * Viewport priority is a function of the distance of the element from the\n   * currently visible viewports. The elements in the visible viewport get\n   * higher priority and further away from the viewport get lower priority.\n   * This priority also depends on whether or not the user is scrolling towards\n   * this element or away from it.\n   *\n   * @param {!./task-queue.TaskDef} task\n   * @param {!Object<string, *>} unusedCache\n   * @return {number}\n   * @private\n   */\n  calcTaskScore_(task, unusedCache) {\n    // TODO(jridgewell): these should be taking into account the active\n    // scroller, which may not be the root scroller. Maybe a weighted average\n    // of \"scroller scrolls necessary\" to see the element.\n    // Demo at https://output.jsbin.com/hicigom/quiet\n    const viewport = this.viewport_.getRect();\n    const box = task.resource.getLayoutBox();\n    let posPriority = Math.floor((box.top - viewport.top) / viewport.height);\n    if (Math.sign(posPriority) != this.getScrollDirection()) {\n      posPriority *= 2;\n    }\n    posPriority = Math.abs(posPriority);\n    return task.priority * PRIORITY_BASE_ + posPriority;\n  }\n\n  /**\n   * Calculates the timeout of a task. The timeout depends on two main factors:\n   * the priorities of the tasks currently in the execution pool and their age.\n   * The timeout is calculated against each task in the execution pool and the\n   * maximum value is returned.\n   *\n   * A task is penalized with higher timeout values when it's lower in priority\n   * than the task in the execution pool. However, this penalty is judged\n   * against the age of the executing task. If it has been in executing for\n   * some time, the penalty is reduced.\n   *\n   * @param {!./task-queue.TaskDef} task\n   * @private\n   */\n  calcTaskTimeout_(task) {\n    const now = Date.now();\n\n    if (this.exec_.getSize() == 0) {\n      // If we've never been visible, return 0. This follows the previous\n      // behavior of not delaying tasks when there's nothing to do.\n      if (this.firstVisibleTime_ === -1) {\n        return 0;\n      }\n\n      // Scale off the first visible time, so penalized tasks must wait a\n      // second or two to run. After we have been visible for a time, we no\n      // longer have to wait.\n      const penalty = task.priority * PRIORITY_PENALTY_TIME_;\n      return Math.max(penalty - (now - this.firstVisibleTime_), 0);\n    }\n\n    let timeout = 0;\n    this.exec_.forEach(other => {\n      // Higher priority tasks get the head start. Currently 500ms per a drop\n      // in priority (note that priority is 10-based).\n      const penalty = Math.max(\n        (task.priority - other.priority) * PRIORITY_PENALTY_TIME_,\n        0\n      );\n      // TODO(dvoytenko): Consider running total and not maximum.\n      timeout = Math.max(timeout, penalty - (now - other.startTime));\n    });\n\n    return timeout;\n  }\n\n  /**\n   * @param {!./task-queue.TaskDef} task\n   * @private\n   */\n  reschedule_(task) {\n    if (!this.queue_.getTaskById(task.id)) {\n      this.queue_.enqueue(task);\n    }\n  }\n\n  /**\n   * @param {!./task-queue.TaskDef} task\n   * @param {boolean} success\n   * @param {*=} opt_reason\n   * @return {!Promise|undefined}\n   * @private\n   */\n  taskComplete_(task, success, opt_reason) {\n    this.exec_.dequeue(task);\n    this.schedulePass(POST_TASK_PASS_DELAY_);\n    if (!success) {\n      dev().info(\n        TAG_,\n        'task failed:',\n        task.id,\n        task.resource.debugid,\n        opt_reason\n      );\n      return Promise.reject(opt_reason);\n    }\n  }\n\n  /**\n   * Schedules change of the element's height.\n   * @param {!Resource} resource\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!../layout-rect.LayoutMarginsChangeDef|undefined} newMargins\n   * @param {?Event|undefined} event\n   * @param {boolean} force\n   * @param {function(boolean)=} opt_callback A callback function\n   * @private\n   */\n  scheduleChangeSize_(\n    resource,\n    newHeight,\n    newWidth,\n    newMargins,\n    event,\n    force,\n    opt_callback\n  ) {\n    if (resource.hasBeenMeasured() && !newMargins) {\n      this.completeScheduleChangeSize_(\n        resource,\n        newHeight,\n        newWidth,\n        undefined,\n        event,\n        force,\n        opt_callback\n      );\n    } else {\n      // This is a rare case since most of times the element itself schedules\n      // resize requests. However, this case is possible when another element\n      // requests resize of a controlled element. This also happens when a\n      // margin size change is requested, since existing margins have to be\n      // measured in this instance.\n      this.vsync_.measure(() => {\n        if (!resource.hasBeenMeasured()) {\n          resource.measure();\n        }\n        const marginChange = newMargins\n          ? {\n              newMargins,\n              currentMargins: this.getLayoutMargins_(resource),\n            }\n          : undefined;\n        this.completeScheduleChangeSize_(\n          resource,\n          newHeight,\n          newWidth,\n          marginChange,\n          event,\n          force,\n          opt_callback\n        );\n      });\n    }\n  }\n\n  /**\n   * Returns the layout margins for the resource.\n   * @param {!Resource} resource\n   * @return {!../layout-rect.LayoutMarginsDef}\n   * @private\n   */\n  getLayoutMargins_(resource) {\n    const style = computedStyle(this.win, resource.element);\n    return {\n      top: parseInt(style.marginTop, 10) || 0,\n      right: parseInt(style.marginRight, 10) || 0,\n      bottom: parseInt(style.marginBottom, 10) || 0,\n      left: parseInt(style.marginLeft, 10) || 0,\n    };\n  }\n\n  /**\n   * @param {!Resource} resource\n   * @param {number|undefined} newHeight\n   * @param {number|undefined} newWidth\n   * @param {!MarginChangeDef|undefined} marginChange\n   * @param {?Event|undefined} event\n   * @param {boolean} force\n   * @param {function(boolean)=} opt_callback A callback function\n   * @private\n   */\n  completeScheduleChangeSize_(\n    resource,\n    newHeight,\n    newWidth,\n    marginChange,\n    event,\n    force,\n    opt_callback\n  ) {\n    resource.resetPendingChangeSize();\n    const layoutBox = resource.getPageLayoutBox();\n    if (\n      (newHeight === undefined || newHeight == layoutBox.height) &&\n      (newWidth === undefined || newWidth == layoutBox.width) &&\n      (marginChange === undefined ||\n        !areMarginsChanged(\n          marginChange.currentMargins,\n          marginChange.newMargins\n        ))\n    ) {\n      if (\n        newHeight === undefined &&\n        newWidth === undefined &&\n        marginChange === undefined\n      ) {\n        dev().error(\n          TAG_,\n          'attempting to change size with undefined dimensions',\n          resource.debugid\n        );\n      }\n      // Nothing to do.\n      if (opt_callback) {\n        opt_callback(/* success */ true);\n      }\n      return;\n    }\n\n    let request = null;\n    for (let i = 0; i < this.requestsChangeSize_.length; i++) {\n      if (this.requestsChangeSize_[i].resource == resource) {\n        request = this.requestsChangeSize_[i];\n        break;\n      }\n    }\n\n    if (request) {\n      request.newHeight = newHeight;\n      request.newWidth = newWidth;\n      request.marginChange = marginChange;\n      request.event = event;\n      request.force = force || request.force;\n      request.callback = opt_callback;\n    } else {\n      this.requestsChangeSize_.push(\n        /** {!ChangeSizeRequestDef} */ {\n          resource,\n          newHeight,\n          newWidth,\n          marginChange,\n          event,\n          force,\n          callback: opt_callback,\n        }\n      );\n    }\n    this.schedulePassVsync_();\n  }\n\n  /**\n   * Returns whether the resource should be preloaded at this time.\n   * The element must be measured by this time.\n   * @param {!Resource} resource\n   * @param {boolean} forceOutsideViewport\n   * @return {boolean}\n   * @private\n   */\n  isLayoutAllowed_(resource, forceOutsideViewport) {\n    // Only built and displayed elements can be loaded.\n    if (\n      resource.getState() == ResourceState.NOT_BUILT ||\n      !resource.isDisplayed()\n    ) {\n      return false;\n    }\n\n    // Don't schedule elements when we're not visible, or in prerender mode\n    // (and they can't prerender).\n    if (!this.visible_) {\n      if (\n        this.ampdoc.getVisibilityState() != VisibilityState.PRERENDER ||\n        !resource.prerenderAllowed()\n      ) {\n        return false;\n      }\n    }\n\n    // The element has to be in its rendering corridor.\n    if (\n      !forceOutsideViewport &&\n      !resource.isInViewport() &&\n      !resource.renderOutsideViewport() &&\n      !resource.idleRenderOutsideViewport()\n    ) {\n      return false;\n    }\n\n    return true;\n  }\n\n  /** @override */\n  scheduleLayoutOrPreload(\n    resource,\n    layout,\n    opt_parentPriority,\n    opt_forceOutsideViewport\n  ) {\n    devAssert(\n      resource.getState() != ResourceState.NOT_BUILT && resource.isDisplayed(),\n      'Not ready for layout: %s (%s)',\n      resource.debugid,\n      resource.getState()\n    );\n    const forceOutsideViewport = opt_forceOutsideViewport || false;\n    if (!this.isLayoutAllowed_(resource, forceOutsideViewport)) {\n      return;\n    }\n\n    if (layout) {\n      this.schedule_(\n        resource,\n        LAYOUT_TASK_ID_,\n        LAYOUT_TASK_OFFSET_,\n        opt_parentPriority || 0,\n        forceOutsideViewport,\n        resource.startLayout.bind(resource)\n      );\n    } else {\n      this.schedule_(\n        resource,\n        PRELOAD_TASK_ID_,\n        PRELOAD_TASK_OFFSET_,\n        opt_parentPriority || 0,\n        forceOutsideViewport,\n        resource.startLayout.bind(resource)\n      );\n    }\n  }\n\n  /**\n   * Schedules a task.\n   * @param {!Resource} resource\n   * @param {string} localId\n   * @param {number} priorityOffset\n   * @param {number} parentPriority\n   * @param {boolean} forceOutsideViewport\n   * @param {function():!Promise} callback\n   * @private\n   */\n  schedule_(\n    resource,\n    localId,\n    priorityOffset,\n    parentPriority,\n    forceOutsideViewport,\n    callback\n  ) {\n    const taskId = resource.getTaskId(localId);\n\n    const task = {\n      id: taskId,\n      resource,\n      priority:\n        Math.max(resource.getLayoutPriority(), parentPriority) + priorityOffset,\n      forceOutsideViewport,\n      callback,\n      scheduleTime: Date.now(),\n      startTime: 0,\n      promise: null,\n    };\n    dev().fine(TAG_, 'schedule:', task.id, 'at', task.scheduleTime);\n\n    // Only schedule a new task if there's no one enqueued yet or if this task\n    // has a higher priority.\n    const queued = this.queue_.getTaskById(taskId);\n    if (!queued || task.priority < queued.priority) {\n      if (queued) {\n        this.queue_.dequeue(queued);\n      }\n      this.queue_.enqueue(task);\n      this.schedulePass(this.calcTaskTimeout_(task));\n    }\n    task.resource.layoutScheduled(task.scheduleTime);\n  }\n\n  /**\n   * @return {!Promise} when first pass executed.\n   */\n  whenFirstPass() {\n    return this.firstPassDone_.promise;\n  }\n\n  /**\n   * Calls iterator on each sub-resource\n   * @param {!FiniteStateMachine<!VisibilityState>} vsm\n   */\n  setupVisibilityStateMachine_(vsm) {\n    const {\n      PRERENDER: prerender,\n      VISIBLE: visible,\n      HIDDEN: hidden,\n      PAUSED: paused,\n      INACTIVE: inactive,\n    } = VisibilityState;\n    const doWork = () => {\n      // If viewport size is 0, the manager will wait for the resize event.\n      const viewportSize = this.viewport_.getSize();\n      if (viewportSize.height > 0 && viewportSize.width > 0) {\n        if (this.hasMutateWork_()) {\n          this.mutateWork_();\n        }\n        this.discoverWork_();\n        let delay = this.work_();\n        if (this.hasMutateWork_()) {\n          // Overflow mutate work.\n          delay = Math.min(delay, MUTATE_DEFER_DELAY_);\n        }\n        if (this.visible_) {\n          if (this.schedulePass(delay)) {\n            dev().fine(TAG_, 'next pass:', delay);\n          } else {\n            dev().fine(TAG_, 'pass already scheduled');\n          }\n        } else {\n          dev().fine(TAG_, 'document is not visible: no scheduling');\n        }\n        this.firstPassDone_.resolve();\n      }\n    };\n    const noop = () => {};\n    const pause = () => {\n      this.resources_.forEach(r => r.pause());\n    };\n    const unload = () => {\n      this.resources_.forEach(r => {\n        r.unload();\n        this.cleanupTasks_(r);\n      });\n      this.unselectText_();\n    };\n    const resume = () => {\n      this.resources_.forEach(r => r.resume());\n      doWork();\n    };\n\n    vsm.addTransition(prerender, prerender, doWork);\n    vsm.addTransition(prerender, visible, doWork);\n    vsm.addTransition(prerender, hidden, doWork);\n    vsm.addTransition(prerender, inactive, doWork);\n    vsm.addTransition(prerender, paused, doWork);\n\n    vsm.addTransition(visible, visible, doWork);\n    vsm.addTransition(visible, hidden, doWork);\n    vsm.addTransition(visible, inactive, unload);\n    vsm.addTransition(visible, paused, pause);\n\n    vsm.addTransition(hidden, visible, doWork);\n    vsm.addTransition(hidden, hidden, doWork);\n    vsm.addTransition(hidden, inactive, unload);\n    vsm.addTransition(hidden, paused, pause);\n\n    vsm.addTransition(inactive, visible, resume);\n    vsm.addTransition(inactive, hidden, resume);\n    vsm.addTransition(inactive, inactive, noop);\n    vsm.addTransition(inactive, paused, doWork);\n\n    vsm.addTransition(paused, visible, resume);\n    vsm.addTransition(paused, hidden, doWork);\n    vsm.addTransition(paused, inactive, unload);\n    vsm.addTransition(paused, paused, noop);\n  }\n\n  /**\n   * Unselects any selected text\n   * @private\n   */\n  unselectText_() {\n    try {\n      this.win.getSelection().removeAllRanges();\n    } catch (e) {\n      // Selection API not supported.\n    }\n  }\n\n  /**\n   * Cleanup task queues from tasks for elements that has been unloaded.\n   * @param {Resource} resource\n   * @param {boolean=} opt_removePending Whether to remove from pending\n   *     build resources.\n   * @private\n   */\n  cleanupTasks_(resource, opt_removePending) {\n    if (resource.getState() == ResourceState.NOT_LAID_OUT) {\n      // If the layout promise for this resource has not resolved yet, remove\n      // it from the task queues to make sure this resource can be rescheduled\n      // for layout again later on.\n      // TODO(mkhatib): Think about how this might affect preload tasks once the\n      // prerender change is in.\n      this.queue_.purge(task => {\n        return task.resource == resource;\n      });\n      this.exec_.purge(task => {\n        return task.resource == resource;\n      });\n      remove(this.requestsChangeSize_, request => {\n        return request.resource === resource;\n      });\n    }\n\n    if (\n      resource.getState() == ResourceState.NOT_BUILT &&\n      opt_removePending &&\n      this.pendingBuildResources_\n    ) {\n      const pendingIndex = this.pendingBuildResources_.indexOf(resource);\n      if (pendingIndex != -1) {\n        this.pendingBuildResources_.splice(pendingIndex, 1);\n      }\n    }\n  }\n}\n\n/**\n * The internal structure of a ChangeHeightRequest.\n * @typedef {{\n *   height: (number|undefined),\n *   width: (number|undefined),\n *   margins: (!../layout-rect.LayoutMarginsChangeDef|undefined)\n * }}\n */\nexport let SizeDef;\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installResourcesServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'resources', ResourcesImpl);\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {MutatorInterface} from './mutator-interface';\n\n/** @const {string} */\nexport const READY_SCAN_SIGNAL = 'ready-scan';\n\n/* eslint-disable no-unused-vars */\n/**\n * @interface\n */\nexport class ResourcesInterface extends MutatorInterface {\n  /**\n   * Returns a list of resources.\n   * @return {!Array<!./resource.Resource>}\n   * @export\n   */\n  get() {}\n\n  /**\n   * @return {!./ampdoc-impl.AmpDoc}\n   */\n  getAmpdoc() {}\n\n  /**\n   * Returns the {@link Resource} instance corresponding to the specified AMP\n   * Element. If no Resource is found, the exception is thrown.\n   * @param {!AmpElement} element\n   * @return {!./resource.Resource}\n   */\n  getResourceForElement(element) {}\n\n  /**\n   * Returns the {@link Resource} instance corresponding to the specified AMP\n   * Element. Returns null if no resource is found.\n   * @param {!AmpElement} element\n   * @return {?./resource.Resource}\n   */\n  getResourceForElementOptional(element) {}\n\n  /**\n   * Returns the direction the user last scrolled.\n   *  - -1 for scrolling up\n   *  - 1 for scrolling down\n   *  - Defaults to 1\n   * TODO(lannka): this method should not belong to resources.\n   * @return {number}\n   */\n  getScrollDirection() {}\n\n  /**\n   * Signals that an element has been added to the DOM. Resources manager\n   * will start tracking it from this point on.\n   * @param {!AmpElement} element\n   */\n  add(element) {}\n\n  /**\n   * Signals that an element has been upgraded to the DOM. Resources manager\n   * will perform build and enable layout/viewport signals for this element.\n   * @param {!AmpElement} element\n   */\n  upgraded(element) {}\n\n  /**\n   * Signals that an element has been removed to the DOM. Resources manager\n   * will stop tracking it from this point on.\n   * @param {!AmpElement} element\n   */\n  remove(element) {}\n\n  /**\n   * Schedules layout or preload for the specified resource.\n   * @param {!./resource.Resource} resource\n   * @param {boolean} layout\n   * @param {number=} opt_parentPriority\n   * @param {boolean=} opt_forceOutsideViewport\n   * @package\n   */\n  scheduleLayoutOrPreload(\n    resource,\n    layout,\n    opt_parentPriority,\n    opt_forceOutsideViewport\n  ) {}\n\n  /**\n   * Schedules the work pass at the latest with the specified delay.\n   * @param {number=} opt_delay\n   * @param {boolean=} opt_relayoutAll\n   * @return {boolean}\n   */\n  schedulePass(opt_delay, opt_relayoutAll) {}\n\n  /**\n   * Registers a callback to be called when the next pass happens.\n   * @param {function()} callback\n   */\n  onNextPass(callback) {}\n\n  /**\n   * @return {!Promise} when first pass executed.\n   */\n  whenFirstPass() {}\n\n  /**\n   * Called when main AMP binary is fully initialized.\n   * May never be called in Shadow Mode.\n   */\n  ampInitComplete() {}\n\n  /**\n   * Updates the priority of the resource. If there are tasks currently\n   * scheduled, their priority is updated as well.\n   * @param {!Element} element\n   * @param {number} newLayoutPriority\n   */\n  updateLayoutPriority(element, newLayoutPriority) {}\n}\n/* eslint-enable no-unused-vars */\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {ActionTrust} from '../action-constants';\nimport {Layout, getLayoutClass} from '../layout';\nimport {Services} from '../services';\nimport {computedStyle, toggle} from '../style';\nimport {dev, user, userAssert} from '../log';\nimport {\n  getAmpdoc,\n  installServiceInEmbedScope,\n  registerServiceBuilderForDoc,\n} from '../service';\nimport {isFiniteNumber, toWin} from '../types';\nimport {startsWith} from '../string';\nimport {tryFocus} from '../dom';\n\n/**\n * @param {!Element} element\n * @return {boolean}\n */\nfunction isShowable(element) {\n  return element.hasAttribute('hidden');\n}\n\n/**\n * @param {!Element} element\n * @return {?Element}\n * @visibleForTesting\n */\nexport function getAutofocusElementForShowAction(element) {\n  if (element.hasAttribute('autofocus')) {\n    return element;\n  }\n  return element.querySelector('[autofocus]');\n}\n\n/** @const {string} */\nconst TAG = 'STANDARD-ACTIONS';\n\n/**\n * Regular expression that identifies AMP CSS classes with 'i-amphtml-' prefixes.\n * @type {!RegExp}\n */\nconst AMP_CSS_RE = /^i-amphtml-/;\n\n/**\n * This service contains implementations of some of the most typical actions,\n * such as hiding DOM elements.\n * @implements {../service.EmbeddableService}\n * @private Visible for testing.\n */\nexport class StandardActions {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!Window=} opt_win\n   */\n  constructor(ampdoc, opt_win) {\n    // TODO(#22733): remove subroooting once ampdoc-fie is launched.\n\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    const context = opt_win\n      ? opt_win.document.documentElement\n      : ampdoc.getHeadNode();\n\n    /** @const @private {!./resources-interface.ResourcesInterface} */\n    this.resources_ = Services.resourcesForDoc(ampdoc);\n\n    /** @const @private {!./viewport/viewport-interface.ViewportInterface} */\n    this.viewport_ = Services.viewportForDoc(ampdoc);\n\n    // Explicitly not setting `Action` as a member to scope installation to one\n    // method and for bundle size savings. \n    this.installActions_(Services.actionServiceForDoc(context));\n  }\n\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n  static installInEmbedWindow(embedWin, ampdoc) {\n    installServiceInEmbedScope(\n      embedWin,\n      'standard-actions',\n      new StandardActions(ampdoc, embedWin)\n    );\n  }\n\n  /**\n   * @param {!./action-impl.ActionService} actionService\n   * @private\n   */\n  installActions_(actionService) {\n    actionService.addGlobalTarget('AMP', this.handleAmpTarget_.bind(this));\n\n    // All standard actions require high trust by default via\n    // addGlobalMethodHandler.\n\n    actionService.addGlobalMethodHandler('hide', this.handleHide_.bind(this));\n\n    actionService.addGlobalMethodHandler('show', this.handleShow_.bind(this));\n\n    actionService.addGlobalMethodHandler(\n      'toggleVisibility',\n      this.handleToggle_.bind(this)\n    );\n\n    actionService.addGlobalMethodHandler(\n      'scrollTo',\n      this.handleScrollTo_.bind(this)\n    );\n\n    actionService.addGlobalMethodHandler('focus', this.handleFocus_.bind(this));\n\n    actionService.addGlobalMethodHandler(\n      'toggleClass',\n      this.handleToggleClass_.bind(this)\n    );\n  }\n\n  /**\n   * Handles global `AMP` actions.\n   * See `amp-actions-and-events.md` for details.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @throws If the invocation method is unrecognized.\n   * @private Visible to tests only.\n   */\n  handleAmpTarget_(invocation) {\n    // All global `AMP` actions require high trust.\n    if (!invocation.satisfiesTrust(ActionTrust.HIGH)) {\n      return null;\n    }\n    const {node, method, args} = invocation;\n    const win = (node.ownerDocument || node).defaultView;\n    switch (method) {\n      case 'pushState':\n      case 'setState':\n        const element =\n          node.nodeType === Node.DOCUMENT_NODE ? node.documentElement : node;\n        return Services.bindForDocOrNull(element).then(bind => {\n          userAssert(bind, 'AMP-BIND is not installed.');\n          return bind.invoke(invocation);\n        });\n\n      case 'navigateTo':\n        return this.handleNavigateTo_(invocation);\n\n      case 'closeOrNavigateTo':\n        return this.handleCloseOrNavigateTo_(invocation);\n\n      case 'scrollTo':\n        userAssert(args['id'], 'AMP.scrollTo must provide element ID');\n        invocation.node = dev().assertElement(\n          getAmpdoc(node).getElementById(args['id']),\n          'scrollTo element ID must exist on page'\n        );\n        return this.handleScrollTo_(invocation);\n\n      case 'goBack':\n        Services.historyForDoc(this.ampdoc).goBack();\n        return null;\n\n      case 'print':\n        win.print();\n        return null;\n\n      case 'optoutOfCid':\n        return Services.cidForDoc(this.ampdoc)\n          .then(cid => cid.optOut())\n          .catch(reason => {\n            dev().error(TAG, 'Failed to opt out of CID', reason);\n          });\n    }\n    throw user().createError('Unknown AMP action ', method);\n  }\n\n  /**\n   * Handles the `navigateTo` action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {!Promise}\n   * @private Visible to tests only.\n   */\n  handleNavigateTo_(invocation) {\n    const {node, caller, method, args} = invocation;\n    const win = (node.ownerDocument || node).defaultView;\n    // Some components have additional constraints on allowing navigation.\n    let permission = Promise.resolve();\n    if (startsWith(caller.tagName, 'AMP-')) {\n      permission = caller.getImpl().then(impl => {\n        if (typeof impl.throwIfCannotNavigate == 'function') {\n          impl.throwIfCannotNavigate();\n        }\n      });\n    }\n    return permission.then(\n      () => {\n        Services.navigationForDoc(this.ampdoc).navigateTo(\n          win,\n          args['url'],\n          `AMP.${method}`,\n          {target: args['target'], opener: args['opener']}\n        );\n      },\n      /* onrejected */ e => {\n        user().error(TAG, e.message);\n      }\n    );\n  }\n\n  /**\n   * Handles the `handleCloseOrNavigateTo_` action.\n   * This action tries to close the requesting window if allowed, otherwise\n   * navigates the window.\n   *\n   * Window can be closed only from top-level documents that have an opener.\n   * Without an opener or if embedded, it will deny the close method.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {!Promise}\n   * @private Visible to tests only.\n   */\n  handleCloseOrNavigateTo_(invocation) {\n    const {node} = invocation;\n    const win = (node.ownerDocument || node).defaultView;\n\n    // Don't allow closing if embedded in iframe or does not have an opener or\n    // embedded in a multi-doc shadowDOM case.\n    // Note that browser denies win.close in some of these cases already anyway,\n    // so not every check here is strictly needed but works as a short-circuit.\n    const hasParent = win.parent != win;\n    const canBeClosed = win.opener && this.ampdoc.isSingleDoc() && !hasParent;\n\n    let wasClosed = false;\n    if (canBeClosed) {\n      // Browser may still deny win.close() call, that would be reflected\n      // synchronously in win.closed\n      win.close();\n      wasClosed = win.closed;\n    }\n\n    if (!wasClosed) {\n      return this.handleNavigateTo_(invocation);\n    }\n\n    return Promise.resolve();\n  }\n  /**\n   * Handles the `scrollTo` action where given an element, we smooth scroll to\n   * it with the given animation duration.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleScrollTo_(invocation) {\n    const node = dev().assertElement(invocation.node);\n    const {args} = invocation;\n\n    // Duration and position are optional.\n    // Default values are set by the viewport service, so they're passed through\n    // when undefined or invalid.\n    let posOrUndef = args && args['position'];\n    let durationOrUndef = args && args['duration'];\n\n    if (posOrUndef && !['top', 'bottom', 'center'].includes(posOrUndef)) {\n      posOrUndef = undefined;\n    }\n\n    if (!isFiniteNumber(durationOrUndef)) {\n      durationOrUndef = undefined;\n    }\n\n    // Animate the scroll\n    // Should return a promise instead of null\n    return this.viewport_.animateScrollIntoView(\n      node,\n      posOrUndef,\n      durationOrUndef\n    );\n  }\n\n  /**\n   * Handles the `focus` action where given an element, we give it focus\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleFocus_(invocation) {\n    const node = dev().assertElement(invocation.node);\n\n    // Set focus\n    tryFocus(node);\n\n    return null;\n  }\n\n  /**\n   * Handles \"hide\" action. This is a very simple action where \"display: none\"\n   * is applied to the target element.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleHide_(invocation) {\n    const target = dev().assertElement(invocation.node);\n\n    this.resources_.mutateElement(target, () => {\n      if (target.classList.contains('i-amphtml-element')) {\n        target./*OK*/ collapse();\n      } else {\n        toggle(target, false);\n      }\n    });\n\n    return null;\n  }\n\n  /**\n   * Handles \"show\" action. This is a very simple action where \"display: none\"\n   * is removed from the target element.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleShow_({node}) {\n    const target = dev().assertElement(node);\n    const ownerWindow = toWin(target.ownerDocument.defaultView);\n\n    if (target.classList.contains(getLayoutClass(Layout.NODISPLAY))) {\n      user().warn(\n        TAG,\n        'Elements with layout=nodisplay cannot be dynamically shown.',\n        target\n      );\n      return null;\n    }\n\n    this.resources_.measureElement(() => {\n      if (\n        computedStyle(ownerWindow, target).display == 'none' &&\n        !isShowable(target)\n      ) {\n        user().warn(\n          TAG,\n          'Elements can only be dynamically shown when they have the ' +\n            '\"hidden\" attribute set or when they were dynamically hidden.',\n          target\n        );\n      }\n    });\n\n    const autofocusElOrNull = getAutofocusElementForShowAction(target);\n\n    // iOS only honors focus in sync operations.\n    if (autofocusElOrNull && Services.platformFor(ownerWindow).isIos()) {\n      this.handleShowSync_(target, autofocusElOrNull);\n    } else {\n      this.resources_.mutateElement(target, () => {\n        this.handleShowSync_(target, autofocusElOrNull);\n      });\n    }\n\n    return null;\n  }\n\n  /**\n   * @param {!Element} target\n   * @param {?Element} autofocusElOrNull\n   * @private Visible to tests only.\n   */\n  handleShowSync_(target, autofocusElOrNull) {\n    if (target.classList.contains('i-amphtml-element')) {\n      target./*OK*/ expand();\n    } else {\n      toggle(target, true);\n    }\n    if (autofocusElOrNull) {\n      tryFocus(autofocusElOrNull);\n    }\n  }\n\n  /**\n   * Handles \"toggle\" action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleToggle_(invocation) {\n    if (isShowable(dev().assertElement(invocation.node))) {\n      return this.handleShow_(invocation);\n    }\n    return this.handleHide_(invocation);\n  }\n\n  /**\n   * Handles \"toggleClass\" action.\n   * @param {!./action-impl.ActionInvocation} invocation\n   * @return {?Promise}\n   * @private Visible to tests only.\n   */\n  handleToggleClass_(invocation) {\n    const target = dev().assertElement(invocation.node);\n    const {args} = invocation;\n    const className = user().assertString(\n      args['class'],\n      \"Argument 'class' must be a string.\"\n    );\n    // prevent toggling of amp internal classes\n    if (AMP_CSS_RE.test(className)) {\n      return null;\n    }\n\n    this.resources_.mutateElement(target, () => {\n      if (args['force'] !== undefined) {\n        // must be boolean, won't do type conversion\n        const shouldForce = user().assertBoolean(\n          args['force'],\n          \"Optional argument 'force' must be a boolean.\"\n        );\n        target.classList.toggle(className, shouldForce);\n      } else {\n        target.classList.toggle(className);\n      }\n    });\n\n    return null;\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installStandardActionsForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'standard-actions',\n    StandardActions,\n    /* opt_instantiate */ true\n  );\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {dev, devAssert} from '../log';\nimport {dict} from '../utils/object';\nimport {getSourceOrigin} from '../url';\nimport {parseJson, recreateNonProtoObject} from '../json';\nimport {registerServiceBuilderForDoc} from '../service';\n\n/** @const */\nconst TAG = 'Storage';\n\n/** @const */\nconst MAX_VALUES_PER_ORIGIN = 8;\n\n/**\n * The storage API. This is an API equivalent to the Web LocalStorage API but\n * extended to all AMP embedding scenarios.\n *\n * The storage is done per source origin. See `get`, `set` and `remove` methods\n * for more info.\n *\n * @see https://html.spec.whatwg.org/multipage/webstorage.html\n * @private Visible for testing only.\n */\nexport class Storage {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!../service/viewer-interface.ViewerInterface} viewer\n   * @param {!StorageBindingDef} binding\n   */\n  constructor(ampdoc, viewer, binding) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @private @const {!../service/viewer-interface.ViewerInterface} */\n    this.viewer_ = viewer;\n\n    /** @private @const {!StorageBindingDef} */\n    this.binding_ = binding;\n\n    /** @const @private {string} */\n    this.origin_ = getSourceOrigin(this.ampdoc.win.location);\n\n    /** @private {?Promise<!Store>} */\n    this.storePromise_ = null;\n  }\n\n  /**\n   * @return {!Storage}\n   * @protected\n   */\n  start_() {\n    this.listenToBroadcasts_();\n    return this;\n  }\n\n  /**\n   * Returns the promise that yields the value of the property for the specified\n   * key.\n   * @param {string} name\n   * @return {!Promise<*>}\n   */\n  get(name) {\n    return this.getStore_().then(store => store.get(name));\n  }\n\n  /**\n   * Saves the value (restricted to boolean value) of the specified property.\n   * Returns the promise that's resolved when the operation completes.\n   * @param {string} name\n   * @param {*} value\n   * @param {boolean=} opt_isUpdate\n   * @return {!Promise}\n   */\n  set(name, value, opt_isUpdate) {\n    devAssert(typeof value == 'boolean', 'Only boolean values accepted');\n    return this.setNonBoolean(name, value, opt_isUpdate);\n  }\n\n  /**\n   * Saves the value of the specified property. Returns the promise that's\n   * resolved when the operation completes.\n   * Note: More restrict privacy review is required to store non boolean value.\n   * @param {string} name\n   * @param {*} value\n   * @param {boolean=} opt_isUpdate\n   * @return {!Promise}\n   */\n  setNonBoolean(name, value, opt_isUpdate) {\n    return this.saveStore_(store => store.set(name, value, opt_isUpdate));\n  }\n\n  /**\n   * Removes the specified property. Returns the promise that's resolved when\n   * the operation completes.\n   * @param {string} name\n   * @return {!Promise}\n   */\n  remove(name) {\n    return this.saveStore_(store => store.remove(name));\n  }\n\n  /**\n   * @return {!Promise<!Store>}\n   * @private\n   */\n  getStore_() {\n    if (!this.storePromise_) {\n      this.storePromise_ = this.binding_\n        .loadBlob(this.origin_)\n        .then(blob => (blob ? parseJson(atob(blob)) : {}))\n        .catch(reason => {\n          dev().expectedError(TAG, 'Failed to load store: ', reason);\n          return {};\n        })\n        .then(obj => new Store(obj));\n    }\n    return this.storePromise_;\n  }\n\n  /**\n   * @param {function(!Store)} mutator\n   * @return {!Promise}\n   * @private\n   */\n  saveStore_(mutator) {\n    return this.getStore_()\n      .then(store => {\n        mutator(store);\n        // Need to encode stored object to avoid plain text,\n        // but doesn't need to be base64encode. Can convert to some other\n        // encoding method for further improvement.\n        const blob = btoa(JSON.stringify(store.obj));\n        return this.binding_.saveBlob(this.origin_, blob);\n      })\n      .then(this.broadcastReset_.bind(this));\n  }\n\n  /** @private */\n  listenToBroadcasts_() {\n    this.viewer_.onBroadcast(message => {\n      if (\n        message['type'] == 'amp-storage-reset' &&\n        message['origin'] == this.origin_\n      ) {\n        dev().fine(TAG, 'Received reset message');\n        this.storePromise_ = null;\n      }\n    });\n  }\n\n  /** @private */\n  broadcastReset_() {\n    dev().fine(TAG, 'Broadcasted reset message');\n    this.viewer_.broadcast(\n      /** @type {!JsonObject} */ ({\n        'type': 'amp-storage-reset',\n        'origin': this.origin_,\n      })\n    );\n  }\n}\n\n/**\n * The implementation of store logic for get, set and remove.\n *\n * The structure of the store is equivalent to the following typedef:\n * ```\n * {\n *   vv: !Object<key(string), !{\n *     v: *,\n *     t: time\n *   }>\n * }\n * ```\n *\n * @private Visible for testing only.\n */\nexport class Store {\n  /**\n   * @param {!JsonObject} obj\n   * @param {number=} opt_maxValues\n   */\n  constructor(obj, opt_maxValues) {\n    /** @const {!JsonObject} */\n    this.obj = /** @type {!JsonObject} */ (recreateNonProtoObject(obj));\n\n    /** @private @const {number} */\n    this.maxValues_ = opt_maxValues || MAX_VALUES_PER_ORIGIN;\n\n    /** @private @const {!Object<string, !JsonObject>} */\n    this.values_ = this.obj['vv'] || Object.create(null);\n    if (!this.obj['vv']) {\n      this.obj['vv'] = this.values_;\n    }\n  }\n\n  /**\n   * @param {string} name\n   * @return {*|undefined}\n   */\n  get(name) {\n    // The structure is {key: {v: *, t: time}}\n    const item = this.values_[name];\n    return item ? item['v'] : undefined;\n  }\n\n  /**\n   * Set the storage value along with the current timestamp.\n   * When opt_isUpdated is true, timestamp will be the creation timestamp,\n   * the stored value will be updated w/o updating timestamp.\n   * @param {string} name\n   * @param {*} value\n   * @param {boolean=} opt_isUpdate\n   */\n  set(name, value, opt_isUpdate) {\n    devAssert(\n      name != '__proto__' && name != 'prototype',\n      'Name is not allowed: %s',\n      name\n    );\n    // The structure is {key: {v: *, t: time}}\n    if (this.values_[name] !== undefined) {\n      const item = this.values_[name];\n      let timestamp = Date.now();\n      if (opt_isUpdate) {\n        // Update value w/o timestamp\n        timestamp = item['t'];\n      }\n      item['v'] = value;\n      item['t'] = timestamp;\n    } else {\n      this.values_[name] = dict({\n        'v': value,\n        't': Date.now(),\n      });\n    }\n\n    // Purge old values.\n    const keys = Object.keys(this.values_);\n    if (keys.length > this.maxValues_) {\n      let minTime = Infinity;\n      let minKey = null;\n      for (let i = 0; i < keys.length; i++) {\n        const item = this.values_[keys[i]];\n        if (item['t'] < minTime) {\n          minKey = keys[i];\n          minTime = item['t'];\n        }\n      }\n      if (minKey) {\n        delete this.values_[minKey];\n      }\n    }\n  }\n\n  /**\n   * @param {string} name\n   */\n  remove(name) {\n    // The structure is {key: {v: *, t: time}}\n    delete this.values_[name];\n  }\n}\n\n/**\n * A binding provides the specific implementation of storage technology.\n * @interface\n */\nclass StorageBindingDef {\n  /**\n   * Returns the promise that yields the store blob for the specified origin.\n   * @param {string} unusedOrigin\n   * @return {!Promise<?string>}\n   */\n  loadBlob(unusedOrigin) {}\n\n  /**\n   * Saves the store blob for the specified origin and returns the promise\n   * that's resolved when the operation completes.\n   * @param {string} unusedOrigin\n   * @param {string} unusedBlob\n   * @return {!Promise}\n   */\n  saveBlob(unusedOrigin, unusedBlob) {}\n}\n\n/**\n * Storage implementation using Web LocalStorage API.\n * @implements {StorageBindingDef}\n * @private Visible for testing only.\n */\nexport class LocalStorageBinding {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {boolean} */\n    this.isLocalStorageSupported_ = this.checkIsLocalStorageSupported_();\n\n    if (!this.isLocalStorageSupported_) {\n      const error = new Error('localStorage not supported.');\n      dev().expectedError(TAG, error);\n    }\n  }\n\n  /**\n   * Determines whether localStorage API is supported by ensuring it is declared\n   * and does not throw an exception when used.\n   * @return {boolean}\n   * @private\n   */\n  checkIsLocalStorageSupported_() {\n    try {\n      if (!('localStorage' in this.win)) {\n        return false;\n      }\n\n      // We do not care about the value fetched from local storage; we only care\n      // whether the call throws an exception or not.  As such, we can look up\n      // any arbitrary key.\n      this.win.localStorage.getItem('test');\n      return true;\n    } catch (e) {\n      return false;\n    }\n  }\n\n  /**\n   * @param {string} origin\n   * @return {string}\n   * @private\n   */\n  getKey_(origin) {\n    return `amp-store:${origin}`;\n  }\n\n  /** @override */\n  loadBlob(origin) {\n    return new Promise(resolve => {\n      if (!this.isLocalStorageSupported_) {\n        resolve(null);\n        return;\n      }\n      resolve(this.win.localStorage.getItem(this.getKey_(origin)));\n    });\n  }\n\n  /** @override */\n  saveBlob(origin, blob) {\n    return new Promise(resolve => {\n      if (!this.isLocalStorageSupported_) {\n        resolve();\n        return;\n      }\n      this.win.localStorage.setItem(this.getKey_(origin), blob);\n      resolve();\n    });\n  }\n}\n\n/**\n * Storage implementation delegated to the Viewer.\n * @implements {StorageBindingDef}\n * @private Visible for testing only.\n */\nexport class ViewerStorageBinding {\n  /**\n   * @param {!../service/viewer-interface.ViewerInterface} viewer\n   */\n  constructor(viewer) {\n    /** @private @const {!../service/viewer-interface.ViewerInterface} */\n    this.viewer_ = viewer;\n  }\n\n  /** @override */\n  loadBlob(origin) {\n    return this.viewer_\n      .sendMessageAwaitResponse('loadStore', dict({'origin': origin}))\n      .then(response => response['blob']);\n  }\n\n  /** @override */\n  saveBlob(origin, blob) {\n    return /** @type {!Promise} */ (this.viewer_.sendMessageAwaitResponse(\n      'saveStore',\n      dict({'origin': origin, 'blob': blob})\n    ));\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installStorageServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'storage',\n    function() {\n      const viewer = Services.viewerForDoc(ampdoc);\n      const overrideStorage = parseInt(viewer.getParam('storage'), 10);\n      const binding = overrideStorage\n        ? new ViewerStorageBinding(viewer)\n        : new LocalStorageBinding(ampdoc.win);\n      return new Storage(ampdoc, viewer, binding).start_();\n    },\n    /* opt_instantiate */ true\n  );\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../log';\n\n/**\n * The internal structure for the task.\n * @typedef {{\n *   id: string,\n *   resource: !./resource.Resource,\n *   priority: number,\n *   forceOutsideViewport: boolean,\n *   callback: function(),\n *   scheduleTime: time,\n *   startTime: time,\n *   promise: (?Promise|undefined)\n * }}\n */\nexport let TaskDef;\n\n/**\n * @typedef {Object<string, *>}\n */\nlet PeekStateDef;\n\n/**\n * A scheduling queue for Resources.\n *\n * @package\n */\nexport class TaskQueue {\n  /**\n   * Creates an instance of TaskQueue.\n   */\n  constructor() {\n    /** @private @const {!Array<!TaskDef>} */\n    this.tasks_ = [];\n\n    /** @private @const {!Object<string, !TaskDef>} */\n    this.taskIdMap_ = {};\n\n    /** @private {!time} */\n    this.lastEnqueueTime_ = 0;\n\n    /** @private {!time} */\n    this.lastDequeueTime_ = 0;\n  }\n\n  /**\n   * Size of the queue.\n   * @return {number}\n   */\n  getSize() {\n    return this.tasks_.length;\n  }\n\n  /**\n   * Last time a task was enqueued.\n   * @return {!time}\n   */\n  getLastEnqueueTime() {\n    return this.lastEnqueueTime_;\n  }\n\n  /**\n   * Last time a task was dequeued.\n   * @return {!time}\n   */\n  getLastDequeueTime() {\n    return this.lastDequeueTime_;\n  }\n\n  /**\n   * Returns the task with the specified ID or null.\n   * @param {string} taskId\n   * @return {?TaskDef}\n   */\n  getTaskById(taskId) {\n    return this.taskIdMap_[taskId] || null;\n  }\n\n  /**\n   * Enqueues the task. If the task is already in the queue, the error is\n   * thrown.\n   * @param {!TaskDef} task\n   */\n  enqueue(task) {\n    devAssert(!this.taskIdMap_[task.id], 'Task already enqueued: %s', task.id);\n    this.tasks_.push(task);\n    this.taskIdMap_[task.id] = task;\n    this.lastEnqueueTime_ = Date.now();\n  }\n\n  /**\n   * Dequeues the task and returns \"true\" if dequeueing is successful. Otherwise\n   * returns \"false\", e.g. when this task is not currently enqueued.\n   * @param {!TaskDef} task\n   * @return {boolean}\n   */\n  dequeue(task) {\n    const existing = this.taskIdMap_[task.id];\n    const dequeued = this.removeAtIndex(task, this.tasks_.indexOf(existing));\n    if (!dequeued) {\n      return false;\n    }\n    this.lastDequeueTime_ = Date.now();\n    return true;\n  }\n\n  /**\n   * Returns the task with the minimal score based on the provided scoring\n   * callback.\n   * @param {function(!TaskDef, !PeekStateDef):number} scorer\n   * @param {!PeekStateDef} state\n   * @return {?TaskDef}\n   */\n  peek(scorer, state) {\n    let minScore = 1e6;\n    let minTask = null;\n    for (let i = 0; i < this.tasks_.length; i++) {\n      const task = this.tasks_[i];\n      const score = scorer(task, state);\n      if (score < minScore) {\n        minScore = score;\n        minTask = task;\n      }\n    }\n    return minTask;\n  }\n\n  /**\n   * Iterates over all tasks in queue in the insertion order.\n   * @param {function(!TaskDef)} callback\n   */\n  forEach(callback) {\n    this.tasks_.forEach(callback);\n  }\n\n  /**\n   * Removes the task and returns \"true\" if dequeueing is successful. Otherwise\n   * returns \"false\", e.g. when this task is not currently enqueued.\n   * @param {!TaskDef} task\n   * @param {number} index of the task to remove.\n   * @return {boolean}\n   */\n  removeAtIndex(task, index) {\n    const existing = this.taskIdMap_[task.id];\n    if (!existing || this.tasks_[index] != existing) {\n      return false;\n    }\n    this.tasks_.splice(index, 1);\n    delete this.taskIdMap_[task.id];\n    return true;\n  }\n\n  /**\n   * Removes tasks in queue that pass the callback test.\n   * @param {function(!TaskDef):boolean} callback Return true to remove the task.\n   */\n  purge(callback) {\n    let index = this.tasks_.length;\n    while (index--) {\n      if (callback(this.tasks_[index])) {\n        this.removeAtIndex(this.tasks_[index], index);\n      }\n    }\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../utils/promise';\nimport {Services} from '../services';\nimport {dev, userAssert} from '../log';\nimport {getService, registerServiceBuilder} from '../service';\nimport {rootNodeFor, scopedQuerySelector} from '../dom';\n\n/**\n * @fileoverview\n * For the set of decisions made on templating see:\n * {@link https://docs.google.com/document/d/1q-5MPQHnOHLF_uL7lQsGZdzuBgrPTkCy2PdRP-YCbOw/edit#}\n */\n\n/**\n * @typedef {function(new:BaseTemplate, !Element, !Window)}\n */\nlet TemplateClassDef;\n\n/** @private @const {string} */\nconst PROP_ = '__AMP_IMPL_';\n\n/** @private @const {string} */\nconst PROP_PROMISE_ = '__AMP_WAIT_';\n\n/**\n * The interface that is implemented by all templates.\n */\nexport class BaseTemplate {\n  /**\n   * @param {!Element} element\n   * @param {!Window} win\n   */\n  constructor(element, win) {\n    /** @public @const */\n    this.element = element;\n\n    /** @public @const {!Window} */\n    this.win = element.ownerDocument.defaultView || win;\n\n    /** @private @const */\n    this.viewer_ = Services.viewerForDoc(this.element);\n\n    this.compileCallback();\n  }\n\n  /**\n   * Override in subclass if the element needs to compile the template.\n   * @protected\n   */\n  compileCallback() {\n    // Subclasses may override.\n  }\n\n  /**\n   * Bypasses template rendering and directly sets HTML. Should only be used\n   * for server-side rendering case. To be implemented by subclasses.\n   * @param {string} unusedData\n   * @return {!Element}\n   */\n  setHtml(unusedData) {\n    throw new Error('Not implemented');\n  }\n\n  /**\n   * To be implemented by subclasses.\n   * @param {!JsonObject|string} unusedData\n   * @return {!Element}\n   */\n  render(unusedData) {\n    throw new Error('Not implemented');\n  }\n\n  /**\n   * Helps the template implementation to unwrap the root element. The root\n   * element can be unwrapped only when it contains a single element or a\n   * single element surrounded by empty text nodes.\n   * @param {!Element} root\n   * @return {!Element}\n   * @protected @final\n   */\n  unwrap(root) {\n    let singleElement = null;\n    for (let n = root.firstChild; n != null; n = n.nextSibling) {\n      if (n.nodeType == /* TEXT */ 3) {\n        if (n.textContent.trim()) {\n          // Non-empty text node - can't unwrap.\n          singleElement = null;\n          break;\n        }\n      } else if (n.nodeType == /* COMMENT */ 8) {\n        // Ignore comments.\n      } else if (n.nodeType == /* ELEMENT */ 1) {\n        if (!singleElement) {\n          singleElement = dev().assertElement(n);\n        } else {\n          // This is not the first element - can't unwrap.\n          singleElement = null;\n          break;\n        }\n      } else {\n        singleElement = null;\n      }\n    }\n    return singleElement || root;\n  }\n\n  /**\n   * @protected @final\n   * @return {boolean}\n   */\n  viewerCanRenderTemplates() {\n    return this.viewer_.hasCapability('viewerRenderTemplate');\n  }\n}\n\n/**\n */\nexport class Templates {\n  /** @param {!Window} win */\n  constructor(win) {\n    /** @private @const {!Window} */\n    this.win_ = win;\n\n    /**\n     * A map from template type to template's class promise.\n     * @private @const {!Object<string, !Promise<!TemplateClassDef>>}\n     */\n    this.templateClassMap_ = {};\n\n    /**\n     * A map from template type to template's class promise. This is a transient\n     * storage. As soon as the template class loaded, the entry is removed.\n     * @private @const {!Object<string, function(!TemplateClassDef)>}\n     */\n    this.templateClassResolvers_ = {};\n  }\n\n  /**\n   * Inserts the specified template element.\n   * @param {!Element} templateElement\n   * @param {string} html\n   * @return {!Promise<!Element>}\n   */\n  setHtmlForTemplate(templateElement, html) {\n    return this.getImplementation_(templateElement).then(impl => {\n      return this.setHtml_(impl, html);\n    });\n  }\n\n  /**\n   * Renders the specified template element using the supplied data.\n   * @param {!Element} templateElement\n   * @param {!JsonObject} data\n   * @return {!Promise<!Element>}\n   */\n  renderTemplate(templateElement, data) {\n    return this.getImplementation_(templateElement).then(impl => {\n      return this.render_(impl, data);\n    });\n  }\n\n  /**\n   * Renders the specified template element using the supplied array of data\n   * and returns an array of resulting elements.\n   * @param {!Element} templateElement\n   * @param {!Array<!JsonObject>} array\n   * @return {!Promise<!Array<!Element>>}\n   */\n  renderTemplateArray(templateElement, array) {\n    if (array.length == 0) {\n      return Promise.resolve([]);\n    }\n    return this.getImplementation_(templateElement).then(impl => {\n      return array.map(item => {\n        return this.render_(impl, item);\n      });\n    });\n  }\n\n  /**\n   * Discovers the template for the specified parent and renders it using the\n   * supplied data. The template can be specified either via \"template\"\n   * attribute  or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element.\n   * @param {!Element} parent\n   * @param {!JsonObject} data\n   * @param {string=} opt_querySelector\n   * @return {!Promise<!Element>}\n   */\n  findAndRenderTemplate(parent, data, opt_querySelector) {\n    return this.renderTemplate(\n      this.findTemplate(parent, opt_querySelector),\n      data\n    );\n  }\n\n  /**\n   * Discovers the already rendered template for the specified parent and\n   * inserts it in the DOM. The template can be specified either via \"template\"\n   * attribute  or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element.\n   * @param {!Element} parent\n   * @param {string} html\n   * @param {string=} opt_querySelector\n   * @return {!Promise<!Element>}\n   */\n  findAndSetHtmlForTemplate(parent, html, opt_querySelector) {\n    return this.setHtmlForTemplate(\n      this.findTemplate(parent, opt_querySelector),\n      html\n    );\n  }\n\n  /**\n   * Discovers the template for the specified parent and renders it using the\n   * supplied array of data. The template can be specified either via \"template\"\n   * attribute or as a child \"template\" element. When specified via \"template\"\n   * attribute, the value indicates the ID of the template element. Returns\n   * the array of the rendered elements.\n   * @param {!Element} parent\n   * @param {!Array<!JsonObject>} array\n   * @param {string=} opt_querySelector\n   * @return {!Promise<!Array<!Element>>}\n   */\n  findAndRenderTemplateArray(parent, array, opt_querySelector) {\n    return this.renderTemplateArray(\n      this.findTemplate(parent, opt_querySelector),\n      array\n    );\n  }\n\n  /**\n   * Detect if a template is present inside the parent.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {boolean}\n   */\n  hasTemplate(parent, opt_querySelector) {\n    return !!this.maybeFindTemplate(parent, opt_querySelector);\n  }\n\n  /**\n   * Find a specified template inside the parent. Fail if the template is\n   * not present.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {!Element}\n   */\n  findTemplate(parent, opt_querySelector) {\n    const templateElement = this.maybeFindTemplate(parent, opt_querySelector);\n    userAssert(templateElement, 'Template not found for %s', parent);\n    const templateTagName = templateElement.tagName;\n    userAssert(\n      templateTagName == 'TEMPLATE' ||\n        (templateTagName == 'SCRIPT' &&\n          templateElement.getAttribute('type') === 'text/plain'),\n      'Template must be defined in a <template> or ' +\n        '<script type=\"text/plain\"> tag'\n    );\n    return templateElement;\n  }\n\n  /**\n   * Find a specified template inside the parent. Returns null if not present.\n   * The template can be specified either via \"template\" attribute or as a\n   * child \"template\" element. When specified via \"template\" attribute,\n   * the value indicates the ID of the template element. The template\n   * can be defined either via the <template> or <script> tag.\n   * @param {!Element} parent\n   * @param {string=} opt_querySelector\n   * @return {?Element}\n   */\n  maybeFindTemplate(parent, opt_querySelector) {\n    const templateId = parent.getAttribute('template');\n    if (templateId) {\n      return rootNodeFor(parent).getElementById(templateId);\n    } else if (opt_querySelector) {\n      return scopedQuerySelector(parent, opt_querySelector);\n    } else {\n      return parent.querySelector('template, script');\n    }\n  }\n\n  /**\n   * Returns the promise that will eventually yield the template implementation\n   * for the specified template element.\n   * @param {!Element} element\n   * @return {!Promise<!BaseTemplate>}\n   * @private\n   */\n  getImplementation_(element) {\n    /** @const {!BaseTemplate} */\n    const impl = element[PROP_];\n    if (impl) {\n      return Promise.resolve(impl);\n    }\n\n    let type = '';\n    const {tagName} = element;\n    if (tagName == 'TEMPLATE') {\n      type = element.getAttribute('type');\n    } else if (tagName == 'SCRIPT') {\n      type = element.getAttribute('template');\n    }\n    userAssert(type, 'Type must be specified: %s', element);\n\n    let promise = element[PROP_PROMISE_];\n    if (promise) {\n      return promise;\n    }\n\n    promise = this.waitForTemplateClass_(element, type).then(templateClass => {\n      const impl = (element[PROP_] = new templateClass(element, this.win_));\n      delete element[PROP_PROMISE_];\n      return impl;\n    });\n    element[PROP_PROMISE_] = promise;\n    return promise;\n  }\n\n  /**\n   * Returns the promise that will eventually yield the template class. This\n   * will wait until the actual template script has been downloaded and parsed.\n   * @param {!Element} element\n   * @param {string} type\n   * @return {!Promise<!TemplateClassDef>}\n   * @private\n   */\n  waitForTemplateClass_(element, type) {\n    if (this.templateClassMap_[type]) {\n      return this.templateClassMap_[type];\n    }\n\n    const deferred = new Deferred();\n    const {promise, resolve} = deferred;\n\n    this.templateClassMap_[type] = promise;\n    this.templateClassResolvers_[type] = resolve;\n    return promise;\n  }\n\n  /**\n   * Registers an extended template. This function should typically be called\n   * through the registerTemplate method on the AMP runtime.\n   * @param {string} type\n   * @param {!TemplateClassDef} templateClass\n   * @private\n   * @restricted\n   */\n  registerTemplate_(type, templateClass) {\n    if (!this.templateClassMap_[type]) {\n      this.templateClassMap_[type] = Promise.resolve(templateClass);\n    } else {\n      const resolver = this.templateClassResolvers_[type];\n      userAssert(resolver, 'Duplicate template type: %s', type);\n      delete this.templateClassResolvers_[type];\n      resolver(templateClass);\n    }\n  }\n\n  /**\n   * @param {!BaseTemplate} impl\n   * @param {!JsonObject} data\n   * @return {!Element}\n   * @private\n   */\n  render_(impl, data) {\n    return impl.render(data);\n  }\n\n  /**\n   * @param {!BaseTemplate} impl\n   * @param {string} html\n   * @return {!Element}\n   * @private\n   */\n  setHtml_(impl, html) {\n    return impl.setHtml(html);\n  }\n}\n\n/**\n * @param {!Window} win\n */\nexport function installTemplatesService(win) {\n  registerServiceBuilder(win, 'templates', Templates);\n}\n\n/**\n * Registers an extended template. This function should typically be called\n * through the registerTemplate method on the AMP runtime.\n * @param {!Window} win\n * @param {string} type\n * @param {!TemplateClassDef} templateClass\n * @return {undefined}\n */\nexport function registerExtendedTemplate(win, type, templateClass) {\n  const templatesService = getService(win, 'templates');\n  return templatesService.registerTemplate_(type, templateClass);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {getMode} from '../mode';\nimport {installServiceInEmbedScope, registerServiceBuilder} from '../service';\nimport {reportError} from '../error';\nimport {user} from '../log';\n\nconst TAG = 'timer';\nlet timersForTesting;\n\n/**\n * Helper with all things Timer.\n */\nexport class Timer {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!Promise}  */\n    this.resolved_ = this.win.Promise.resolve();\n\n    this.taskCount_ = 0;\n\n    this.canceled_ = {};\n\n    /** @const {number} */\n    this.startTime_ = Date.now();\n  }\n\n  /**\n   * Returns time since start in milliseconds.\n   * @return {number}\n   */\n  timeSinceStart() {\n    return Date.now() - this.startTime_;\n  }\n\n  /**\n   * Runs the provided callback after the specified delay. This uses a micro\n   * task for 0 or no specified time. This means that the delay will actually\n   * be close to 0 and this will NOT yield to the event queue.\n   *\n   * Returns the timer ID that can be used to cancel the timer (cancel method).\n   * @param {function()} callback\n   * @param {number=} opt_delay\n   * @return {number|string}\n   */\n  delay(callback, opt_delay) {\n    if (!opt_delay) {\n      // For a delay of zero,  schedule a promise based micro task since\n      // they are predictably fast.\n      const id = 'p' + this.taskCount_++;\n      this.resolved_\n        .then(() => {\n          if (this.canceled_[id]) {\n            delete this.canceled_[id];\n            return;\n          }\n          callback();\n        })\n        .catch(reportError);\n      return id;\n    }\n    const wrapped = () => {\n      try {\n        callback();\n      } catch (e) {\n        reportError(e);\n        throw e;\n      }\n    };\n    const index = this.win.setTimeout(wrapped, opt_delay);\n    if (getMode().test) {\n      if (!timersForTesting) {\n        timersForTesting = [];\n      }\n      timersForTesting.push(index);\n    }\n    return index;\n  }\n\n  /**\n   * Cancels the previously scheduled callback.\n   * @param {number|string|null} timeoutId\n   */\n  cancel(timeoutId) {\n    if (typeof timeoutId == 'string') {\n      this.canceled_[timeoutId] = true;\n      return;\n    }\n    this.win.clearTimeout(timeoutId);\n  }\n\n  /**\n   * Returns a promise that will resolve after the delay. Optionally, the\n   * resolved value can be provided as opt_result argument.\n   * @param {number=} opt_delay\n   * @return {!Promise}\n   */\n  promise(opt_delay) {\n    return new this.win.Promise(resolve => {\n      // Avoid wrapping in closure if no specific result is produced.\n      const timerKey = this.delay(resolve, opt_delay);\n      if (timerKey == -1) {\n        throw new Error('Failed to schedule timer.');\n      }\n    });\n  }\n\n  /**\n   * Returns a promise that will fail after the specified delay. Optionally,\n   * this method can take opt_racePromise parameter. In this case, the\n   * resulting promise will either fail when the specified delay expires or\n   * will resolve based on the opt_racePromise, whichever happens first.\n   * @param {number} delay\n   * @param {?Promise<RESULT>|undefined} opt_racePromise\n   * @param {string=} opt_message\n   * @return {!Promise<RESULT>}\n   * @template RESULT\n   */\n  timeoutPromise(delay, opt_racePromise, opt_message) {\n    let timerKey;\n    const delayPromise = new this.win.Promise((_resolve, reject) => {\n      timerKey = this.delay(() => {\n        reject(user().createError(opt_message || 'timeout'));\n      }, delay);\n\n      if (timerKey == -1) {\n        throw new Error('Failed to schedule timer.');\n      }\n    });\n    if (!opt_racePromise) {\n      return delayPromise;\n    }\n    const cancel = () => {\n      this.cancel(timerKey);\n    };\n    opt_racePromise.then(cancel, cancel);\n    return this.win.Promise.race([delayPromise, opt_racePromise]);\n  }\n\n  /**\n   * Returns a promise that resolves after `predicate` returns true.\n   * Polls with interval `delay`\n   * @param {number} delay\n   * @param {function():boolean} predicate\n   * @return {!Promise}\n   */\n  poll(delay, predicate) {\n    return new this.win.Promise(resolve => {\n      const interval = this.win.setInterval(() => {\n        if (predicate()) {\n          this.win.clearInterval(interval);\n          resolve();\n        }\n      }, delay);\n    });\n  }\n}\n\n/**\n * @param {!Window} window\n */\nexport function installTimerService(window) {\n  registerServiceBuilder(window, TAG, Timer);\n}\n\n/**\n * @param {!Window} embedWin\n */\nexport function installTimerInEmbedWindow(embedWin) {\n  installServiceInEmbedScope(embedWin, TAG, new Timer(embedWin));\n}\n\n/**\n * Cancels all timers scheduled during the current test\n */\nexport function cancelTimersForTesting() {\n  if (!timersForTesting) {\n    return;\n  }\n  timersForTesting.forEach(clearTimeout);\n  timersForTesting = null;\n}\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {hasOwn} from '../../utils/object';\nimport {rethrowAsync, user, userAssert} from '../../log';\nimport {trimStart} from '../../string';\nimport {tryResolve} from '../../utils/promise';\n\n/** @private @const {string} */\nconst PARSER_IGNORE_FLAG = '`';\n\n/** @private @const {string} */\nconst TAG = 'Expander';\n\n/** A whitelist for replacements whose values should not be %-encoded. */\n/** @const {Object<string, boolean>} */\nexport const NOENCODE_WHITELIST = {'ANCESTOR_ORIGIN': true};\n\n/** Rudamentary parser to handle nested Url replacement. */\nexport class Expander {\n  /**\n   * Link this instance of parser to the calling UrlReplacment\n   * @param {?../variable-source.VariableSource} variableSource the keywords to replace\n   * @param {!Object<string, *>=} opt_bindings additional one-off bindings\n   * @param {!Object<string, *>=} opt_collectVars Object passed in to collect\n   *   variable resolutions.\n   * @param {boolean=} opt_sync If the method should resolve syncronously.\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of names\n   *   that can be substituted.\n   * @param {boolean=} opt_noEncode Should not urlEncode macro resolution.\n   */\n  constructor(\n    variableSource,\n    opt_bindings,\n    opt_collectVars,\n    opt_sync,\n    opt_whiteList,\n    opt_noEncode\n  ) {\n    /** @const {?../variable-source.VariableSource} */\n    this.variableSource_ = variableSource;\n\n    /**@const {!Object<string, *>|undefined} */\n    this.bindings_ = opt_bindings;\n\n    // TODO(ccordry): Remove this output object passed into constructor.\n    /**@const {!Object<string, *>|undefined} */\n    this.collectVars_ = opt_collectVars;\n\n    /**@const {boolean|undefined} */\n    this.sync_ = opt_sync;\n\n    /**@const {!Object<string, boolean>|undefined} */\n    this.whiteList_ = opt_whiteList;\n\n    /**@const {boolean|undefined} */\n    this.encode_ = !opt_noEncode;\n  }\n\n  /**\n   * take the template url and return a promise of its evaluated value\n   * @param {string} url url to be substituted\n   * @return {!Promise<string>|string}\n   */\n  expand(url) {\n    if (!url.length) {\n      return this.sync_ ? url : Promise.resolve(url);\n    }\n    const expr = this.variableSource_.getExpr(this.bindings_, this.whiteList_);\n\n    const matches = this.findMatches_(url, expr);\n    // if no keywords move on\n    if (!matches.length) {\n      return this.sync_ ? url : Promise.resolve(url);\n    }\n    return this.parseUrlRecursively_(url, matches);\n  }\n\n  /**\n   * Return any macros that exist in the given url.\n   * @param {string} url\n   * @return {!Array}\n   */\n  getMacroNames(url) {\n    const expr = this.variableSource_.getExpr(this.bindings_, this.whiteList_);\n    const matches = url.match(expr);\n    if (matches) {\n      return matches;\n    }\n    return [];\n  }\n\n  /**\n   * Structures the regex matching into the desired format\n   * @param {string} url url to be substituted\n   * @param {RegExp} expression regex containing all keywords\n   * @return {Array<Object<string, string|number>>} array of objects representing\n   *  matching keywords\n   */\n  findMatches_(url, expression) {\n    const matches = [];\n    url.replace(expression, (match, name, startPosition) => {\n      const {length} = match;\n      const stopPosition = length + startPosition - 1;\n      const info = {\n        start: startPosition,\n        stop: stopPosition,\n        name,\n        length,\n      };\n      matches.push(info);\n    });\n    return matches;\n  }\n\n  /**\n   * @param {string} url\n   * @param {!Array<Object<string, string|number>>} matches Array of objects\n   *   representing matching keywords.\n   * @return {!Promise<string>|string}\n   */\n  parseUrlRecursively_(url, matches) {\n    const stack = [];\n    let urlIndex = 0;\n    let matchIndex = 0;\n    let match = matches[matchIndex];\n    let numOfPendingCalls = 0;\n    let ignoringChars = false;\n    let nextArgShouldBeRaw = false;\n\n    const evaluateNextLevel = encode => {\n      let builder = '';\n      let results = [];\n      const args = [];\n\n      while (urlIndex < url.length && matchIndex <= matches.length) {\n        if (match && urlIndex === match.start) {\n          // Collect any chars that may be prefixing the macro, if we are in\n          // a nested context trim the args.\n          if (builder.trim().length) {\n            results.push(numOfPendingCalls ? trimStart(builder) : builder);\n          }\n\n          // If we know we are at the start of a macro, we figure out how to\n          // resolve it, and move our pointer to after the token.\n          let binding;\n          // Find out where this macro is coming from. Could be from the passed\n          // in optional bindings, or the global variable source.\n          if (this.bindings_ && hasOwn(this.bindings_, match.name)) {\n            // Macro is from optional bindings.\n            binding = {\n              // This construction helps us save the match name and determine\n              // precedence of resolution choices in #expandBinding_ later.\n              name: match.name,\n              prioritized: this.bindings_[match.name],\n              encode,\n            };\n          } else {\n            // Macro is from the global source.\n            binding = Object.assign({}, this.variableSource_.get(match.name), {\n              name: match.name,\n              encode,\n            });\n          }\n\n          urlIndex = match.stop + 1;\n          match = matches[++matchIndex];\n\n          if (url[urlIndex] === '(') {\n            // When we see a `(` we know we need to resolve one level deeper\n            // before continuing. We push the binding in the stack for\n            // resolution later, and then make the recursive call.\n            urlIndex++;\n            numOfPendingCalls++;\n            stack.push(binding);\n            results.push(evaluateNextLevel(/* encode */ false));\n          } else {\n            // Many macros do not take arguments, in this case we do not need to\n            // recurse, we just start resolution in it's position.\n            results.push(this.evaluateBinding_(binding));\n          }\n\n          builder = '';\n        } else if (url[urlIndex] === PARSER_IGNORE_FLAG) {\n          if (!ignoringChars) {\n            ignoringChars = true;\n            nextArgShouldBeRaw = true;\n            userAssert(\n              builder.trim() === '',\n              `The substring \"${builder}\" was lost during url-replacement. ` +\n                'Please ensure the url syntax is correct'\n            );\n            builder = '';\n          } else {\n            ignoringChars = false;\n          }\n          urlIndex++;\n        } else if (\n          numOfPendingCalls &&\n          url[urlIndex] === ',' &&\n          !ignoringChars\n        ) {\n          // Commas tell us to create a new argument when in nested context and\n          // not ignoring them due to backticks. We push any string built so far,\n          // create a new array for the next argument, and reset our string\n          // builder.\n          if (builder.length) {\n            const nextArg = nextArgShouldBeRaw ? builder : builder.trim();\n            results.push(nextArg);\n            nextArgShouldBeRaw = false;\n          }\n          args.push(results);\n          results = [];\n          // Support existing two comma format by pushing an empty string as\n          // argument. eg CLIENT_ID(__ga,,ga-url)\n          if (url[urlIndex + 1] === ',') {\n            args.push(['']);\n            urlIndex++;\n          }\n          builder = '';\n          urlIndex++;\n        }\n\n        // Invoke a function on every right parenthesis unless the stack is\n        // empty. This is where we actually evaluate any macro that takes an\n        // argument. We pop the macro resover off the stack, and take anying left\n        // in our string builder and add it as the final section of the final\n        // arg. Then we call the resolver.\n        else if (numOfPendingCalls && url[urlIndex] === ')' && !ignoringChars) {\n          urlIndex++;\n          numOfPendingCalls--;\n          const binding = stack.pop();\n          const nextArg = nextArgShouldBeRaw ? builder : builder.trim();\n          if (nextArg) {\n            results.push(nextArg);\n          }\n          args.push(results);\n          nextArgShouldBeRaw = false;\n          const value = this.evaluateBinding_(binding, /* opt_args */ args);\n          return value;\n        } else {\n          // This is the most common case. Just building a string as we walk\n          // along.\n          builder += url[urlIndex];\n          urlIndex++;\n        }\n\n        // Capture any trailing characters.\n        if (urlIndex === url.length && builder.length) {\n          results.push(builder);\n        }\n      }\n\n      // TODO: If there is a single item in results, we should preserve it's\n      // type when returning here and the async version below.\n      if (this.sync_) {\n        return results.join('');\n      }\n\n      return Promise.all(results)\n        .then(promiseArray => promiseArray.join(''))\n        .catch(e => {\n          rethrowAsync(e);\n          return '';\n        });\n    };\n\n    return evaluateNextLevel(this.encode_);\n  }\n\n  /**\n   * Called when a binding is ready to be resolved. Determines which version of\n   * binding to use and if syncronous or asyncronous version should be called.\n   * @param {Object<string, *>} bindingInfo An object containing the name of\n   *    macro and value to be resolved.\n   * @param {Array=} opt_args Arguments passed to the macro. Arguments come as\n   *    an array of arrays that will be eventually passed to a function.apply\n   *    invocation. For example: FOO(BARBAR, 123) => When we are ready to evaluate\n   *    the FOO binding opt_args will be [[Result of BAR, Result of BAR], [123]].\n   *    This structure is so that the outer array will have the correct number of\n   *    arguments, but we still can resolve each macro separately.\n   * @return {string|!Promise<string>}\n   */\n  evaluateBinding_(bindingInfo, opt_args) {\n    const {encode, name} = bindingInfo;\n    let binding;\n    if (bindingInfo.prioritized != undefined) {\n      // Has to explicity check for undefined because bindingInfo.priorityized\n      // could not be a function but a false value. For example {FOO: 0}\n      // If a binding is passed in through the bindings argument it always takes\n      // precedence.\n      binding = bindingInfo.prioritized;\n    } else if (this.sync_ && bindingInfo.sync != undefined) {\n      // Use the sync resolution if avaliable when called synchronously.\n      binding = bindingInfo.sync;\n    } else if (this.sync_) {\n      // If there is no sync resolution we can not wait.\n      user().error(TAG, 'ignoring async replacement key: ', bindingInfo.name);\n      binding = '';\n    } else {\n      // Prefer the async over the sync but it may not exist.\n      binding = bindingInfo.async || bindingInfo.sync;\n    }\n\n    // We should only ever encode the top level resolution, or not at all.\n    const shouldEncode = encode && !NOENCODE_WHITELIST[name];\n    if (this.sync_) {\n      const result = this.evaluateBindingSync_(binding, name, opt_args);\n      return shouldEncode ? encodeURIComponent(result) : result;\n    } else {\n      return this.evaluateBindingAsync_(binding, name, opt_args).then(result =>\n        shouldEncode ? encodeURIComponent(result) : result\n      );\n    }\n  }\n\n  /**\n   * Resolves binding to value to be substituted asyncronously.\n   * @param {*} binding Container for sync/async resolutions.\n   * @param {string} name\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   * @return {!Promise<string>} Resolved value.\n   */\n  evaluateBindingAsync_(binding, name, opt_args) {\n    let value;\n    try {\n      if (typeof binding === 'function') {\n        if (opt_args) {\n          value = this.processArgsAsync_(opt_args).then(args =>\n            binding.apply(null, args)\n          );\n        } else {\n          value = tryResolve(binding);\n        }\n      } else {\n        value = Promise.resolve(binding);\n      }\n      return value\n        .then(val => {\n          this.maybeCollectVars_(name, val, opt_args);\n\n          let result;\n\n          if (val == null) {\n            result = '';\n          } else {\n            result = val;\n          }\n          return result;\n        })\n        .catch(e => {\n          rethrowAsync(e);\n          this.maybeCollectVars_(name, '', opt_args);\n          return Promise.resolve('');\n        });\n    } catch (e) {\n      // Report error, but do not disrupt URL replacement. This will\n      // interpolate as the empty string.\n      rethrowAsync(e);\n      this.maybeCollectVars_(name, '', opt_args);\n      return Promise.resolve('');\n    }\n  }\n\n  /**\n   * Flattens the inner layer of an array of arrays so that the result can be\n   * passed to a function.apply call. Must wait for any inner macros to resolve.\n   * This will cast all arguments to string before calling the macro.\n   *  [[Result of BAR, Result of BAR], 123]. => ['resultresult', '123']\n   * @param {!Array<!Array>} argsArray\n   * @return {!Promise<Array<string>>}\n   */\n  processArgsAsync_(argsArray) {\n    return Promise.all(\n      argsArray.map(argArray => {\n        return Promise.all(argArray).then(resolved => resolved.join(''));\n      })\n    );\n  }\n\n  /**\n   * Resolves binding to value to be substituted asyncronously.\n   * @param {*} binding Container for sync/async resolutions.\n   * @param {string} name\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   * @return {string} Resolved value.\n   */\n  evaluateBindingSync_(binding, name, opt_args) {\n    try {\n      let value = binding;\n      if (typeof binding === 'function') {\n        value = binding.apply(null, this.processArgsSync_(opt_args));\n      }\n\n      let result;\n\n      if (value && value.then) {\n        // If binding is passed in as opt_binding we try to resolve it and it\n        // may return a promise. NOTE: We do not collect this discarded value,\n        // even if collectVars exists.\n        user().error(TAG, 'ignoring async macro resolution');\n        result = '';\n      } else if (\n        typeof value === 'string' ||\n        typeof value === 'number' ||\n        typeof value === 'boolean'\n      ) {\n        // Normal case.\n        this.maybeCollectVars_(name, value, opt_args);\n        // TODO: We should try to preserve type here.\n        result = value.toString();\n      } else {\n        // Most likely a broken binding gets us here.\n        this.maybeCollectVars_(name, '', opt_args);\n        result = '';\n      }\n\n      return result;\n    } catch (e) {\n      // Report error, but do not disrupt URL replacement. This will\n      // interpolate as the empty string.\n      rethrowAsync(e);\n      this.maybeCollectVars_(name, '', opt_args);\n      return '';\n    }\n  }\n\n  /**\n   * Flattens the inner layer of an array of arrays so that the result can be\n   * passed to a function.apply call. Will not wait for any promise to resolve.\n   * This will cast all arguments to string before calling the macro.\n   *  [[Result of BAR, Result of BAR], 123]. => ['resultresult', '123']\n   * @param {Array<!Array>|undefined} argsArray\n   * @return {Array<string>|undefined}\n   */\n  processArgsSync_(argsArray) {\n    if (!argsArray) {\n      return argsArray;\n    }\n    return argsArray.map(argArray => {\n      return argArray.join('');\n    });\n  }\n\n  /**\n   * Collect vars if given the optional object. Handles formatting of kv pairs.\n   * @param {string} name Name of the macro.\n   * @param {*} value Raw macro resolution value.\n   * @param {?Array=} opt_args Arguments to be passed if binding is function.\n   */\n  maybeCollectVars_(name, value, opt_args) {\n    if (!this.collectVars_) {\n      return;\n    }\n\n    let args = '';\n    if (opt_args) {\n      const rawArgs = opt_args.filter(arg => arg !== '').join(',');\n      args = `(${rawArgs})`;\n    }\n    this.collectVars_[`${name}${args}`] = value || '';\n  }\n}\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LruCache} from '../utils/lru-cache';\nimport {\n  assertAbsoluteHttpOrHttpsUrl,\n  assertHttpsUrl,\n  getSourceOrigin,\n  getSourceUrl,\n  isProtocolValid,\n  isProxyOrigin,\n  isSecureUrlDeprecated,\n  parseUrlWithA,\n} from '../url';\nimport {\n  installServiceInEmbedScope,\n  registerServiceBuilderForDoc,\n} from '../service';\nimport {urls} from '../config';\n\nconst SERVICE = 'url';\n\n/**\n * @implements {../service.EmbeddableService}\n */\nexport class Url {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {(!Document|!ShadowRoot)=} opt_rootNode\n   */\n  constructor(ampdoc, opt_rootNode) {\n    // TODO(#22733): remove subroooting once ampdoc-fie is launched.\n\n    const root = opt_rootNode || ampdoc.getRootNode();\n    const doc = root.ownerDocument || root;\n\n    /** @private @const {!HTMLAnchorElement} */\n    this.anchor_ = /** @type {!HTMLAnchorElement} */ (doc.createElement('a'));\n\n    /** @private @const {!LruCache} */\n    this.cache_ = new LruCache(100);\n  }\n\n  /**\n   * @param {!Window} embedWin\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @nocollapse\n   */\n  static installInEmbedWindow(embedWin, ampdoc) {\n    installServiceInEmbedScope(\n      embedWin,\n      SERVICE,\n      new Url(ampdoc, embedWin.document)\n    );\n  }\n\n  /**\n   * Parses the URL in the context of the current document.\n   *\n   * @param {string} url\n   * @param {boolean=} opt_nocache\n   * @return {!Location}\n   */\n  parse(url, opt_nocache) {\n    return parseUrlWithA(this.anchor_, url, opt_nocache ? null : this.cache_);\n  }\n\n  /**\n   * @param {string|!Location} url\n   * @return {!Location}\n   * @private\n   */\n  parse_(url) {\n    if (typeof url !== 'string') {\n      return url;\n    }\n    return this.parse(url);\n  }\n\n  /**\n   * Returns whether the URL has valid protocol.\n   * Deep link protocol is valid, but not javascript etc.\n   * @param {string|!Location} url\n   * @return {boolean}\n   */\n  isProtocolValid(url) {\n    return isProtocolValid(url);\n  }\n\n  /**\n   * Returns the source origin of an AMP document for documents served\n   * on a proxy origin or directly.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {string} The source origin of the URL.\n   */\n  getSourceOrigin(url) {\n    return getSourceOrigin(this.parse_(url));\n  }\n\n  /**\n   * Returns the source URL of an AMP document for documents served\n   * on a proxy origin or directly.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {string}\n   */\n  getSourceUrl(url) {\n    return getSourceUrl(this.parse_(url));\n  }\n\n  /**\n   * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n   * assert.\n   *\n   * Provides an exception for localhost.\n   *\n   * @param {?string|undefined} urlString\n   * @param {!Element|string} elementContext Element where the url was found.\n   * @param {string=} sourceName Used for error messages.\n   * @return {string}\n   */\n  assertHttpsUrl(urlString, elementContext, sourceName = 'source') {\n    return assertHttpsUrl(urlString, elementContext, sourceName);\n  }\n\n  /**\n   * Asserts that a given url is an absolute HTTP or HTTPS URL.\n   * @param {string} urlString\n   * @return {string}\n   */\n  assertAbsoluteHttpOrHttpsUrl(urlString) {\n    return assertAbsoluteHttpOrHttpsUrl(urlString);\n  }\n\n  /**\n   * Returns whether the URL has the origin of a proxy.\n   * @param {string|!Location} url URL of an AMP document.\n   * @return {boolean}\n   */\n  isProxyOrigin(url) {\n    return isProxyOrigin(this.parse_(url));\n  }\n\n  /**\n   * Returns `true` if the URL is secure: either HTTPS or localhost (for\n   * testing).\n   * @param {string} url\n   * @return {boolean}\n   */\n  isSecure(url) {\n    return isSecureUrlDeprecated(this.parse_(url));\n  }\n\n  /**\n   * Returns the correct origin for a given window.\n   * @param {!Window} win\n   * @return {string} origin\n   */\n  getWinOrigin(win) {\n    return win.origin || this.parse_(win.location.href).origin;\n  }\n\n  /**\n   * If the resource URL is referenced from the publisher's origin,\n   * convert the URL to be referenced from the cache.\n   * @param {string} resourceUrl The URL of the document to load\n   * @return {string}\n   */\n  getCdnUrlOnOrigin(resourceUrl) {\n    if (isProxyOrigin(resourceUrl)) {\n      return resourceUrl;\n    }\n\n    const {host, hash, pathname, search} = this.parse_(resourceUrl);\n    const encodedHost = encodeURIComponent(host);\n    return `${urls.cdn}/c/${encodedHost}${pathname}${search}${hash}`;\n  }\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installUrlForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    SERVICE,\n    Url,\n    /* opt_instantiate */ true\n  );\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  AsyncResolverDef,\n  ResolverReturnDef,\n  SyncResolverDef,\n  VariableSource,\n  getNavigationData,\n  getTimingDataAsync,\n  getTimingDataSync,\n} from './variable-source';\nimport {\n  addMissingParamsToUrl,\n  addParamsToUrl,\n  getSourceUrl,\n  isProtocolValid,\n  parseQueryString,\n  parseUrlDeprecated,\n  removeAmpJsParamsFromUrl,\n  removeFragment,\n} from '../url';\nimport {dev, devAssert, user, userAssert} from '../log';\nimport {\n  installServiceInEmbedScope,\n  registerServiceBuilderForDoc,\n} from '../service';\n\nimport {Expander} from './url-expander/expander';\nimport {Services} from '../services';\nimport {WindowInterface} from '../window-interface';\nimport {getTrackImpressionPromise} from '../impression.js';\nimport {hasOwn} from '../utils/object';\nimport {internalRuntimeVersion} from '../internal-version';\nimport {tryResolve} from '../utils/promise';\n\n/** @private @const {string} */\nconst TAG = 'UrlReplacements';\nconst EXPERIMENT_DELIMITER = '!';\nconst VARIANT_DELIMITER = '.';\nconst GEO_DELIM = ',';\nconst ORIGINAL_HREF_PROPERTY = 'amp-original-href';\nconst ORIGINAL_VALUE_PROPERTY = 'amp-original-value';\n\n/**\n * Returns a function that executes method on a new Date instance. This is a\n * byte saving hack.\n *\n * @param {string} method\n * @return {!SyncResolverDef}\n */\nfunction dateMethod(method) {\n  return () => new Date()[method]();\n}\n\n/**\n * Returns a function that returns property of screen. This is a byte saving\n * hack.\n *\n * @param {!Screen} screen\n * @param {string} property\n * @return {!SyncResolverDef}\n */\nfunction screenProperty(screen, property) {\n  return () => screen[property];\n}\n\n/**\n * Class to provide variables that pertain to top level AMP window.\n */\nexport class GlobalVariableSource extends VariableSource {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    super(ampdoc);\n\n    /** @private {?Promise<?ShareTrackingFragmentsDef>} */\n    this.shareTrackingFragments_ = null;\n  }\n\n  /**\n   * Utility function for setting resolver for timing data that supports\n   * sync and async.\n   * @param {string} varName\n   * @param {string} startEvent\n   * @param {string=} endEvent\n   * @return {!VariableSource}\n   * @private\n   */\n  setTimingResolver_(varName, startEvent, endEvent) {\n    return this.setBoth(\n      varName,\n      () => {\n        return getTimingDataSync(this.ampdoc.win, startEvent, endEvent);\n      },\n      () => {\n        return getTimingDataAsync(this.ampdoc.win, startEvent, endEvent);\n      }\n    );\n  }\n\n  /** @override */\n  initialize() {\n    const {win} = this.ampdoc;\n    const element = this.ampdoc.getHeadNode();\n\n    /** @const {!./viewport/viewport-interface.ViewportInterface} */\n    const viewport = Services.viewportForDoc(this.ampdoc);\n\n    // Returns a random value for cache busters.\n    this.set('RANDOM', () => Math.random());\n\n    // Provides a counter starting at 1 per given scope.\n    const counterStore = Object.create(null);\n    this.set('COUNTER', scope => {\n      return (counterStore[scope] = (counterStore[scope] | 0) + 1);\n    });\n\n    // Returns the canonical URL for this AMP document.\n    this.set('CANONICAL_URL', () => this.getDocInfo_().canonicalUrl);\n\n    // Returns the host of the canonical URL for this AMP document.\n    this.set(\n      'CANONICAL_HOST',\n      () => parseUrlDeprecated(this.getDocInfo_().canonicalUrl).host\n    );\n\n    // Returns the hostname of the canonical URL for this AMP document.\n    this.set(\n      'CANONICAL_HOSTNAME',\n      () => parseUrlDeprecated(this.getDocInfo_().canonicalUrl).hostname\n    );\n\n    // Returns the path of the canonical URL for this AMP document.\n    this.set(\n      'CANONICAL_PATH',\n      () => parseUrlDeprecated(this.getDocInfo_().canonicalUrl).pathname\n    );\n\n    // Returns the referrer URL.\n    this.setAsync(\n      'DOCUMENT_REFERRER',\n      /** @type {AsyncResolverDef} */ (() => {\n        return Services.viewerForDoc(this.ampdoc).getReferrerUrl();\n      })\n    );\n\n    // Like DOCUMENT_REFERRER, but returns null if the referrer is of\n    // same domain or the corresponding CDN proxy.\n    this.setAsync(\n      'EXTERNAL_REFERRER',\n      /** @type {AsyncResolverDef} */ (() => {\n        return Services.viewerForDoc(this.ampdoc)\n          .getReferrerUrl()\n          .then(referrer => {\n            if (!referrer) {\n              return null;\n            }\n            const referrerHostname = parseUrlDeprecated(getSourceUrl(referrer))\n              .hostname;\n            const currentHostname = WindowInterface.getHostname(win);\n            return referrerHostname === currentHostname ? null : referrer;\n          });\n      })\n    );\n\n    // Returns the title of this AMP document.\n    this.set('TITLE', () => {\n      // The environment may override the title and set originalTitle. Prefer\n      // that if available.\n      const doc = win.document;\n      return doc['originalTitle'] || doc.title;\n    });\n\n    // Returns the URL for this AMP document.\n    this.set('AMPDOC_URL', () => {\n      return removeFragment(this.addReplaceParamsIfMissing_(win.location.href));\n    });\n\n    // Returns the host of the URL for this AMP document.\n    this.set('AMPDOC_HOST', () => {\n      const url = parseUrlDeprecated(win.location.href);\n      return url && url.host;\n    });\n\n    // Returns the hostname of the URL for this AMP document.\n    this.set('AMPDOC_HOSTNAME', () => {\n      const url = parseUrlDeprecated(win.location.href);\n      return url && url.hostname;\n    });\n\n    // Returns the Source URL for this AMP document.\n    const expandSourceUrl = () => {\n      const docInfo = this.getDocInfo_();\n      return removeFragment(this.addReplaceParamsIfMissing_(docInfo.sourceUrl));\n    };\n    this.setBoth(\n      'SOURCE_URL',\n      () => expandSourceUrl(),\n      () => getTrackImpressionPromise().then(() => expandSourceUrl())\n    );\n\n    // Returns the host of the Source URL for this AMP document.\n    this.set(\n      'SOURCE_HOST',\n      () => parseUrlDeprecated(this.getDocInfo_().sourceUrl).host\n    );\n\n    // Returns the hostname of the Source URL for this AMP document.\n    this.set(\n      'SOURCE_HOSTNAME',\n      () => parseUrlDeprecated(this.getDocInfo_().sourceUrl).hostname\n    );\n\n    // Returns the path of the Source URL for this AMP document.\n    this.set(\n      'SOURCE_PATH',\n      () => parseUrlDeprecated(this.getDocInfo_().sourceUrl).pathname\n    );\n\n    // Returns a random string that will be the constant for the duration of\n    // single page view. It should have sufficient entropy to be unique for\n    // all the page views a single user is making at a time.\n    this.set('PAGE_VIEW_ID', () => this.getDocInfo_().pageViewId);\n\n    // Returns a random string that will be the constant for the duration of\n    // single page view. It should have sufficient entropy to be unique for\n    // all the page views a single user is making at a time.\n    this.setAsync('PAGE_VIEW_ID_64', () => this.getDocInfo_().pageViewId64);\n\n    this.setBoth(\n      'QUERY_PARAM',\n      (param, defaultValue = '') => {\n        return this.getQueryParamData_(param, defaultValue);\n      },\n      (param, defaultValue = '') => {\n        return getTrackImpressionPromise().then(() => {\n          return this.getQueryParamData_(param, defaultValue);\n        });\n      }\n    );\n\n    // Returns the value of the given field name in the fragment query string.\n    // Second parameter is an optional default value.\n    // For example, if location is 'pub.com/amp.html?x=1#y=2' then\n    // FRAGMENT_PARAM(y) returns '2' and FRAGMENT_PARAM(z, 3) returns 3.\n    this.set('FRAGMENT_PARAM', (param, defaultValue = '') => {\n      return this.getFragmentParamData_(param, defaultValue);\n    });\n\n    // Returns the first item in the ancestorOrigins array, if available.\n    this.setAsync(\n      'ANCESTOR_ORIGIN',\n      this.getViewerIntegrationValue_('ancestorOrigin', 'ANCESTOR_ORIGIN')\n    );\n\n    /**\n     * Stores client ids that were generated during this page view\n     * indexed by scope.\n     * @type {?Object<string, string>}\n     */\n    let clientIds = null;\n    // Synchronous alternative. Only works for scopes that were previously\n    // requested using the async method.\n    this.setBoth(\n      'CLIENT_ID',\n      scope => {\n        if (!clientIds) {\n          return null;\n        }\n        return clientIds[scope];\n      },\n      (scope, opt_userNotificationId, opt_cookieName) => {\n        userAssert(\n          scope,\n          'The first argument to CLIENT_ID, the fallback' +\n            /*OK*/ ' Cookie name, is required'\n        );\n\n        let consent = Promise.resolve();\n\n        // If no `opt_userNotificationId` argument is provided then\n        // assume consent is given by default.\n        if (opt_userNotificationId) {\n          consent = Services.userNotificationManagerForDoc(element).then(\n            service => {\n              return service.get(opt_userNotificationId);\n            }\n          );\n        }\n        return Services.cidForDoc(this.ampdoc)\n          .then(cid => {\n            return cid.get(\n              {\n                /** @type {string} */ scope,\n                createCookieIfNotPresent: true,\n                cookieName: opt_cookieName,\n              },\n              consent\n            );\n          })\n          .then(cid => {\n            if (!clientIds) {\n              clientIds = Object.create(null);\n            }\n\n            // A temporary work around to extract Client ID from _ga cookie. #5761\n            // TODO: replace with \"filter\" when it's in place. #2198\n            const cookieName = opt_cookieName || scope;\n            if (cid && cookieName == '_ga') {\n              if (typeof cid === 'string') {\n                cid = extractClientIdFromGaCookie(cid);\n              } else {\n                // TODO(@jridgewell, #11120): remove once #11120 is figured out.\n                // Do not log the CID directly, that's PII.\n                dev().error(\n                  TAG,\n                  'non-string cid, what is it?',\n                  Object.keys(cid)\n                );\n              }\n            }\n\n            clientIds[scope] = cid;\n            return cid;\n          });\n      }\n    );\n\n    // Returns assigned variant name for the given experiment.\n    this.setAsync(\n      'VARIANT',\n      /** @type {AsyncResolverDef} */ (experiment => {\n        return this.getVariantsValue_(variants => {\n          const variant = variants[/** @type {string} */ (experiment)];\n          userAssert(\n            variant !== undefined,\n            'The value passed to VARIANT() is not a valid experiment name:' +\n              experiment\n          );\n          // When no variant assigned, use reserved keyword 'none'.\n          return variant === null ? 'none' : /** @type {string} */ (variant);\n        }, 'VARIANT');\n      })\n    );\n\n    // Returns all assigned experiment variants in a serialized form.\n    this.setAsync(\n      'VARIANTS',\n      /** @type {AsyncResolverDef} */ (() => {\n        return this.getVariantsValue_(variants => {\n          const experiments = [];\n          for (const experiment in variants) {\n            const variant = variants[experiment];\n            experiments.push(\n              experiment + VARIANT_DELIMITER + (variant || 'none')\n            );\n          }\n          return experiments.join(EXPERIMENT_DELIMITER);\n        }, 'VARIANTS');\n      })\n    );\n\n    // Returns assigned geo value for geoType or all groups.\n    this.setAsync(\n      'AMP_GEO',\n      /** @type {AsyncResolverDef} */ (geoType => {\n        return this.getGeo_(geos => {\n          if (geoType) {\n            userAssert(\n              geoType === 'ISOCountry',\n              'The value passed to AMP_GEO() is not valid name:' + geoType\n            );\n            return /** @type {string} */ (geos[geoType] || 'unknown');\n          }\n          return /** @type {string} */ (geos.matchedISOCountryGroups.join(\n            GEO_DELIM\n          ));\n        }, 'AMP_GEO');\n      })\n    );\n\n    // Attempt to returns user location data if available, otherwise null.\n    this.setAsync(\n      'AMP_USER_LOCATION',\n      /** @type {AsyncResolverDef} */ (type => {\n        // Type may be \"\",\"lat\",\"lon\", and undefined\n        return this.getUserLocation_(userLocationService => {\n          return userLocationService.getReplacementLocation(\n            'AMP_USER_LOCATION',\n            type\n          );\n        }, 'AMP_USER_LOCATION');\n      })\n    );\n\n    // Returns user location data only if available,\n    // and waits for the user to approve.\n    this.setAsync(\n      'AMP_USER_LOCATION_POLL',\n      /** @type {AsyncResolverDef} */ (type => {\n        // Type may be \"\",\"lat\",\"lon\", and undefined\n        return this.getUserLocation_(userLocationService => {\n          return userLocationService.getReplacementLocation(\n            'AMP_USER_LOCATION_POLL',\n            type,\n            /*opt_poll*/ true\n          );\n        }, 'AMP_USER_LOCATION_POLL');\n      })\n    );\n\n    // Returns incoming share tracking fragment.\n    this.setAsync(\n      'SHARE_TRACKING_INCOMING',\n      /** @type {AsyncResolverDef} */ (() => {\n        return this.getShareTrackingValue_(fragments => {\n          return fragments.incomingFragment;\n        }, 'SHARE_TRACKING_INCOMING');\n      })\n    );\n\n    // Returns outgoing share tracking fragment.\n    this.setAsync(\n      'SHARE_TRACKING_OUTGOING',\n      /** @type {AsyncResolverDef} */ (() => {\n        return this.getShareTrackingValue_(fragments => {\n          return fragments.outgoingFragment;\n        }, 'SHARE_TRACKING_OUTGOING');\n      })\n    );\n\n    // Returns the number of milliseconds since 1 Jan 1970 00:00:00 UTC.\n    this.set('TIMESTAMP', dateMethod('getTime'));\n\n    // Returns the human readable timestamp in format of\n    // 2011-01-01T11:11:11.612Z.\n    this.set('TIMESTAMP_ISO', dateMethod('toISOString'));\n\n    // Returns the user's time-zone offset from UTC, in minutes.\n    this.set('TIMEZONE', dateMethod('getTimezoneOffset'));\n\n    // Returns the IANA timezone code\n    this.set('TIMEZONE_CODE', () => {\n      let tzCode;\n      if ('Intl' in win && 'DateTimeFormat' in win.Intl) {\n        // It could be undefined (i.e. IE11)\n        tzCode = new Intl.DateTimeFormat().resolvedOptions().timeZone;\n      }\n\n      return tzCode || '';\n    });\n\n    // Returns a promise resolving to viewport.getScrollTop.\n    this.set('SCROLL_TOP', () => viewport.getScrollTop());\n\n    // Returns a promise resolving to viewport.getScrollLeft.\n    this.set('SCROLL_LEFT', () => viewport.getScrollLeft());\n\n    // Returns a promise resolving to viewport.getScrollHeight.\n    this.set('SCROLL_HEIGHT', () => viewport.getScrollHeight());\n\n    // Returns a promise resolving to viewport.getScrollWidth.\n    this.set('SCROLL_WIDTH', () => viewport.getScrollWidth());\n\n    // Returns the viewport height.\n    this.set('VIEWPORT_HEIGHT', () => viewport.getHeight());\n\n    // Returns the viewport width.\n    this.set('VIEWPORT_WIDTH', () => viewport.getWidth());\n\n    const {screen} = win;\n    // Returns screen.width.\n    this.set('SCREEN_WIDTH', screenProperty(screen, 'width'));\n\n    // Returns screen.height.\n    this.set('SCREEN_HEIGHT', screenProperty(screen, 'height'));\n\n    // Returns screen.availHeight.\n    this.set('AVAILABLE_SCREEN_HEIGHT', screenProperty(screen, 'availHeight'));\n\n    // Returns screen.availWidth.\n    this.set('AVAILABLE_SCREEN_WIDTH', screenProperty(screen, 'availWidth'));\n\n    // Returns screen.ColorDepth.\n    this.set('SCREEN_COLOR_DEPTH', screenProperty(screen, 'colorDepth'));\n\n    // Returns document characterset.\n    this.set('DOCUMENT_CHARSET', () => {\n      const doc = win.document;\n      return doc.characterSet || doc.charset;\n    });\n\n    // Returns the browser language.\n    this.set('BROWSER_LANGUAGE', () => {\n      const nav = win.navigator;\n      return (\n        nav.language ||\n        nav.userLanguage ||\n        nav.browserLanguage ||\n        ''\n      ).toLowerCase();\n    });\n\n    // Returns the user agent.\n    this.set('USER_AGENT', () => {\n      return win.navigator.userAgent;\n    });\n\n    // Returns the time it took to load the whole page. (excludes amp-* elements\n    // that are not rendered by the system yet.)\n    this.setTimingResolver_(\n      'PAGE_LOAD_TIME',\n      'navigationStart',\n      'loadEventStart'\n    );\n\n    // Returns the time it took to perform DNS lookup for the domain.\n    this.setTimingResolver_(\n      'DOMAIN_LOOKUP_TIME',\n      'domainLookupStart',\n      'domainLookupEnd'\n    );\n\n    // Returns the time it took to connect to the server.\n    this.setTimingResolver_('TCP_CONNECT_TIME', 'connectStart', 'connectEnd');\n\n    // Returns the time it took for server to start sending a response to the\n    // request.\n    this.setTimingResolver_(\n      'SERVER_RESPONSE_TIME',\n      'requestStart',\n      'responseStart'\n    );\n\n    // Returns the time it took to download the page.\n    this.setTimingResolver_(\n      'PAGE_DOWNLOAD_TIME',\n      'responseStart',\n      'responseEnd'\n    );\n\n    // Returns the time it took for redirects to complete.\n    this.setTimingResolver_('REDIRECT_TIME', 'navigationStart', 'fetchStart');\n\n    // Returns the time it took for DOM to become interactive.\n    this.setTimingResolver_(\n      'DOM_INTERACTIVE_TIME',\n      'navigationStart',\n      'domInteractive'\n    );\n\n    // Returns the time it took for content to load.\n    this.setTimingResolver_(\n      'CONTENT_LOAD_TIME',\n      'navigationStart',\n      'domContentLoadedEventStart'\n    );\n\n    // Access: Reader ID.\n    this.setAsync(\n      'ACCESS_READER_ID',\n      /** @type {AsyncResolverDef} */ (() => {\n        return this.getAccessValue_(accessService => {\n          return accessService.getAccessReaderId();\n        }, 'ACCESS_READER_ID');\n      })\n    );\n\n    // Access: data from the authorization response.\n    this.setAsync(\n      'AUTHDATA',\n      /** @type {AsyncResolverDef} */ (field => {\n        userAssert(\n          field,\n          'The first argument to AUTHDATA, the field, is required'\n        );\n        return this.getAccessValue_(accessService => {\n          return accessService.getAuthdataField(field);\n        }, 'AUTHDATA');\n      })\n    );\n\n    // Returns an identifier for the viewer.\n    this.setAsync('VIEWER', () => {\n      return Services.viewerForDoc(this.ampdoc)\n        .getViewerOrigin()\n        .then(viewer => {\n          return viewer == undefined ? '' : viewer;\n        });\n    });\n\n    // Returns the total engaged time since the content became viewable.\n    this.setAsync('TOTAL_ENGAGED_TIME', () => {\n      return Services.activityForDoc(element).then(activity => {\n        return activity.getTotalEngagedTime();\n      });\n    });\n\n    // Returns the incremental engaged time since the last push under the\n    // same name.\n    this.setAsync('INCREMENTAL_ENGAGED_TIME', (name, reset) => {\n      return Services.activityForDoc(element).then(activity => {\n        return activity.getIncrementalEngagedTime(\n          /** @type {string} */ (name),\n          reset !== 'false'\n        );\n      });\n    });\n\n    this.set('NAV_TIMING', (startAttribute, endAttribute) => {\n      userAssert(\n        startAttribute,\n        'The first argument to NAV_TIMING, the ' +\n          'start attribute name, is required'\n      );\n      return getTimingDataSync(\n        win,\n        /**@type {string}*/ (startAttribute),\n        /**@type {string}*/ (endAttribute)\n      );\n    });\n    this.setAsync('NAV_TIMING', (startAttribute, endAttribute) => {\n      userAssert(\n        startAttribute,\n        'The first argument to NAV_TIMING, the ' +\n          'start attribute name, is required'\n      );\n      return getTimingDataAsync(\n        win,\n        /**@type {string}*/ (startAttribute),\n        /**@type {string}*/ (endAttribute)\n      );\n    });\n\n    this.set('NAV_TYPE', () => {\n      return getNavigationData(win, 'type');\n    });\n\n    this.set('NAV_REDIRECT_COUNT', () => {\n      return getNavigationData(win, 'redirectCount');\n    });\n\n    // returns the AMP version number\n    this.set('AMP_VERSION', () => internalRuntimeVersion());\n\n    this.set('BACKGROUND_STATE', () => {\n      return this.ampdoc.isVisible() ? '0' : '1';\n    });\n\n    this.setAsync('VIDEO_STATE', (id, property) => {\n      const root = this.ampdoc.getRootNode();\n      const video = user().assertElement(\n        root.getElementById(/** @type {string} */ (id)),\n        `Could not find an element with id=\"${id}\" for VIDEO_STATE`\n      );\n      return Services.videoManagerForDoc(this.ampdoc)\n        .getAnalyticsDetails(video)\n        .then(details => (details ? details[property] : ''));\n    });\n\n    this.setAsync(\n      'STORY_PAGE_INDEX',\n      this.getStoryValue_('pageIndex', 'STORY_PAGE_INDEX')\n    );\n\n    this.setAsync(\n      'STORY_PAGE_ID',\n      this.getStoryValue_('pageId', 'STORY_PAGE_ID')\n    );\n\n    this.setAsync('FIRST_CONTENTFUL_PAINT', () => {\n      return tryResolve(() =>\n        Services.performanceFor(win).getFirstContentfulPaint()\n      );\n    });\n\n    this.setAsync('FIRST_VIEWPORT_READY', () => {\n      return tryResolve(() =>\n        Services.performanceFor(win).getFirstViewportReady()\n      );\n    });\n\n    this.setAsync('MAKE_BODY_VISIBLE', () => {\n      return tryResolve(() =>\n        Services.performanceFor(win).getMakeBodyVisible()\n      );\n    });\n\n    this.setAsync('AMP_STATE', key => {\n      // This is safe since AMP_STATE is not an A4A whitelisted variable.\n      const root = this.ampdoc.getRootNode();\n      const element =\n        /** @type {!Element|!ShadowRoot} */ (root.documentElement || root);\n      return Services.bindForDocOrNull(element).then(bind => {\n        if (!bind) {\n          return '';\n        }\n        return bind.getStateValue(/** @type {string} */ (key));\n      });\n    });\n  }\n\n  /**\n   * Merges any replacement parameters into a given URL's query string,\n   * preferring values set in the original query string.\n   * @param {string} orig The original URL\n   * @return {string} The resulting URL\n   * @private\n   */\n  addReplaceParamsIfMissing_(orig) {\n    const {replaceParams} = /** @type {!Object} */ (this.getDocInfo_());\n    if (!replaceParams) {\n      return orig;\n    }\n    return addMissingParamsToUrl(removeAmpJsParamsFromUrl(orig), replaceParams);\n  }\n\n  /**\n   * Return the document info for the current ampdoc.\n   * @return {./document-info-impl.DocumentInfoDef}\n   */\n  getDocInfo_() {\n    return Services.documentInfoForDoc(this.ampdoc);\n  }\n\n  /**\n   * Resolves the value via access service. If access service is not configured,\n   * the resulting value is `null`.\n   * @param {function(!../../extensions/amp-access/0.1/access-vars.AccessVars):(T|!Promise<T>)} getter\n   * @param {string} expr\n   * @return {T|null}\n   * @template T\n   * @private\n   */\n  getAccessValue_(getter, expr) {\n    const element = this.ampdoc.getHeadNode();\n    return Promise.all([\n      Services.accessServiceForDocOrNull(element),\n      Services.subscriptionsServiceForDocOrNull(element),\n    ]).then(services => {\n      const service =\n        /** @type {?../../extensions/amp-access/0.1/access-vars.AccessVars} */ (services[0] ||\n        services[1]);\n      if (!service) {\n        // Access/subscriptions service is not installed.\n        user().error(\n          TAG,\n          'Access or subsciptions service is not installed to access: ',\n          expr\n        );\n        return null;\n      }\n      return getter(service);\n    });\n  }\n\n  /**\n   * Return the QUERY_PARAM from the current location href\n   * @param {string} param\n   * @param {string} defaultValue\n   * @return {string}\n   * @private\n   */\n  getQueryParamData_(param, defaultValue) {\n    userAssert(\n      param,\n      'The first argument to QUERY_PARAM, the query string ' +\n        'param is required'\n    );\n    const url = parseUrlDeprecated(\n      removeAmpJsParamsFromUrl(this.ampdoc.win.location.href)\n    );\n    const params = parseQueryString(url.search);\n    const {replaceParams} = this.getDocInfo_();\n    if (typeof params[param] !== 'undefined') {\n      return params[param];\n    }\n    if (replaceParams && typeof replaceParams[param] !== 'undefined') {\n      return /** @type {string} */ (replaceParams[param]);\n    }\n    return defaultValue;\n  }\n\n  /**\n   * Return the FRAGMENT_PARAM from the original location href\n   * @param {*} param\n   * @param {string} defaultValue\n   * @return {string}\n   * @private\n   */\n  getFragmentParamData_(param, defaultValue) {\n    userAssert(\n      param,\n      'The first argument to FRAGMENT_PARAM, the fragment string ' +\n        'param is required'\n    );\n    userAssert(typeof param == 'string', 'param should be a string');\n    const hash = this.ampdoc.win.location.originalHash;\n    const params = parseQueryString(hash);\n    return params[param] === undefined ? defaultValue : params[param];\n  }\n\n  /**\n   * Resolves the value via amp-experiment's variants service.\n   * @param {function(!Object<string, string>):(?string)} getter\n   * @param {string} expr\n   * @return {!Promise<?string>}\n   * @template T\n   * @private\n   */\n  getVariantsValue_(getter, expr) {\n    return Services.variantsForDocOrNull(this.ampdoc.getHeadNode())\n      .then(variants => {\n        userAssert(\n          variants,\n          'To use variable %s, amp-experiment should be configured',\n          expr\n        );\n        return variants.getVariants();\n      })\n      .then(variantsMap => getter(variantsMap));\n  }\n\n  /**\n   * Resolves the value via geo service.\n   * @param {function(Object<string, string>)} getter\n   * @param {string} expr\n   * @return {!Promise<Object<string,(string|Array<string>)>>}\n   * @template T\n   * @private\n   */\n  getGeo_(getter, expr) {\n    const element = this.ampdoc.getHeadNode();\n    return Services.geoForDocOrNull(element).then(geo => {\n      userAssert(geo, 'To use variable %s, amp-geo should be configured', expr);\n      return getter(geo);\n    });\n  }\n\n  /**\n   * Resolves the value via the user location service.\n   * @param {function(Object<string, string>)} getter\n   * @param {string} expr\n   * @return {!Promise<Object<string,(string|Array<string>)>>}\n   * @template T\n   * @private\n   */\n  getUserLocation_(getter, expr) {\n    const element = this.ampdoc.getHeadNode();\n    return Services.userLocationForDocOrNull(element).then(\n      userLocationService => {\n        userAssert(\n          userLocationService,\n          'To use variable %s, amp-user-location should be configured',\n          expr\n        );\n        return getter(userLocationService);\n      }\n    );\n  }\n\n  /**\n   * Resolves the value via amp-share-tracking's service.\n   * @param {function(!ShareTrackingFragmentsDef):T} getter\n   * @param {string} expr\n   * @return {!Promise<T>}\n   * @template T\n   * @private\n   */\n  getShareTrackingValue_(getter, expr) {\n    if (!this.shareTrackingFragments_) {\n      this.shareTrackingFragments_ = Services.shareTrackingForOrNull(\n        this.ampdoc.win\n      );\n    }\n    return this.shareTrackingFragments_.then(fragments => {\n      userAssert(\n        fragments,\n        'To use variable %s, amp-share-tracking should be configured',\n        expr\n      );\n      return getter(/** @type {!ShareTrackingFragmentsDef} */ (fragments));\n    });\n  }\n\n  /**\n   * Resolves the value via amp-story's service.\n   * @param {string} property\n   * @param {string} name\n   * @return {!AsyncResolverDef}\n   * @private\n   */\n  getStoryValue_(property, name) {\n    return () => {\n      const service = Services.storyVariableServiceForOrNull(this.ampdoc.win);\n      return service.then(storyVariables => {\n        userAssert(\n          storyVariables,\n          'To use variable %s amp-story should be configured',\n          name\n        );\n        return storyVariables[property];\n      });\n    };\n  }\n\n  /**\n   * Resolves the value via amp-viewer-integration's service.\n   * @param {string} property\n   * @param {string} name\n   * @return {!AsyncResolverDef}\n   * @private\n   */\n  getViewerIntegrationValue_(property, name) {\n    return /** @type {!AsyncResolverDef} */ ((param, defaultValue = '') => {\n      const service = Services.viewerIntegrationVariableServiceForOrNull(\n        this.ampdoc.win\n      );\n      return service.then(viewerIntegrationVariables => {\n        userAssert(\n          viewerIntegrationVariables,\n          'To use variable %s amp-viewer-integration must be installed',\n          name\n        );\n        return viewerIntegrationVariables[property](param, defaultValue);\n      });\n    });\n  }\n}\n\n/**\n * This class replaces substitution variables with their values.\n * Document new values in ../spec/amp-var-substitutions.md\n * @package For export\n */\nexport class UrlReplacements {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   * @param {!VariableSource} variableSource\n   */\n  constructor(ampdoc, variableSource) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @type {VariableSource} */\n    this.variableSource_ = variableSource;\n  }\n\n  /**\n   * Synchronously expands the provided source by replacing all known variables\n   * with their resolved values. Optional `opt_bindings` can be used to add new\n   * variables or override existing ones.  Any async bindings are ignored.\n   * @param {string} source\n   * @param {!Object<string, (ResolverReturnDef|!SyncResolverDef)>=} opt_bindings\n   * @param {!Object<string, ResolverReturnDef>=} opt_collectVars\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of\n   *     names that can be substituted.\n   * @return {string}\n   */\n  expandStringSync(source, opt_bindings, opt_collectVars, opt_whiteList) {\n    return /** @type {string} */ (new Expander(\n      this.variableSource_,\n      opt_bindings,\n      opt_collectVars,\n      /* opt_sync */ true,\n      opt_whiteList,\n      /* opt_noEncode */ true\n    )./*OK*/ expand(source));\n  }\n\n  /**\n   * Expands the provided source by replacing all known variables with their\n   * resolved values. Optional `opt_bindings` can be used to add new variables\n   * or override existing ones.\n   * @param {string} source\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_whiteList\n   * @return {!Promise<string>}\n   */\n  expandStringAsync(source, opt_bindings, opt_whiteList) {\n    return /** @type {!Promise<string>} */ (new Expander(\n      this.variableSource_,\n      opt_bindings,\n      /* opt_collectVars */ undefined,\n      /* opt_sync */ undefined,\n      opt_whiteList,\n      /* opt_noEncode */ true\n    )./*OK*/ expand(source));\n  }\n\n  /**\n   * Synchronously expands the provided URL by replacing all known variables\n   * with their resolved values. Optional `opt_bindings` can be used to add new\n   * variables or override existing ones.  Any async bindings are ignored.\n   * @param {string} url\n   * @param {!Object<string, (ResolverReturnDef|!SyncResolverDef)>=} opt_bindings\n   * @param {!Object<string, ResolverReturnDef>=} opt_collectVars\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of\n   *     names that can be substituted.\n   * @return {string}\n   */\n  expandUrlSync(url, opt_bindings, opt_collectVars, opt_whiteList) {\n    return this.ensureProtocolMatches_(\n      url,\n      /** @type {string} */ (new Expander(\n        this.variableSource_,\n        opt_bindings,\n        opt_collectVars,\n        /* opt_sync */ true,\n        opt_whiteList\n      )./*OK*/ expand(url))\n    );\n  }\n\n  /**\n   * Expands the provided URL by replacing all known variables with their\n   * resolved values. Optional `opt_bindings` can be used to add new variables\n   * or override existing ones.\n   * @param {string} url\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of names\n   *     that can be substituted.\n   * @param {boolean=} opt_noEncode should not encode URL\n   * @return {!Promise<string>}\n   */\n  expandUrlAsync(url, opt_bindings, opt_whiteList, opt_noEncode) {\n    return /** @type {!Promise<string>} */ (new Expander(\n      this.variableSource_,\n      opt_bindings,\n      /* opt_collectVars */ undefined,\n      /* opt_sync */ undefined,\n      opt_whiteList,\n      opt_noEncode\n    )\n      ./*OK*/ expand(url)\n      .then(replacement => this.ensureProtocolMatches_(url, replacement)));\n  }\n\n  /**\n   * Expands an input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @return {!Promise<string>}\n   */\n  expandInputValueAsync(element) {\n    return /** @type {!Promise<string>} */ (this.expandInputValue_(\n      element,\n      /*opt_sync*/ false\n    ));\n  }\n\n  /**\n   * Expands an input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @return {string} Replaced string for testing\n   */\n  expandInputValueSync(element) {\n    return /** @type {string} */ (this.expandInputValue_(\n      element,\n      /*opt_sync*/ true\n    ));\n  }\n\n  /**\n   * Expands in input element value attribute with variable substituted.\n   * @param {!HTMLInputElement} element\n   * @param {boolean=} opt_sync\n   * @return {string|!Promise<string>}\n   */\n  expandInputValue_(element, opt_sync) {\n    devAssert(\n      element.tagName == 'INPUT' &&\n        (element.getAttribute('type') || '').toLowerCase() == 'hidden',\n      'Input value expansion only works on hidden input fields: %s',\n      element\n    );\n\n    const whitelist = this.getWhitelistForElement_(element);\n    if (!whitelist) {\n      return opt_sync ? element.value : Promise.resolve(element.value);\n    }\n    if (element[ORIGINAL_VALUE_PROPERTY] === undefined) {\n      element[ORIGINAL_VALUE_PROPERTY] = element.value;\n    }\n    const result = new Expander(\n      this.variableSource_,\n      /* opt_bindings */ undefined,\n      /* opt_collectVars */ undefined,\n      /* opt_sync */ opt_sync,\n      /* opt_whitelist */ whitelist\n    )./*OK*/ expand(element[ORIGINAL_VALUE_PROPERTY] || element.value);\n\n    if (opt_sync) {\n      return (element.value = result);\n    }\n    return result.then(newValue => {\n      element.value = newValue;\n      return newValue;\n    });\n  }\n\n  /**\n   * Returns a replacement whitelist from elements' data-amp-replace attribute.\n   * @param {!Element} element\n   * @param {!Object<string, boolean>=} opt_supportedReplacement Optional supported\n   * replacement that filters whitelist to a subset.\n   * @return {!Object<string, boolean>|undefined}\n   */\n  getWhitelistForElement_(element, opt_supportedReplacement) {\n    const whitelist = element.getAttribute('data-amp-replace');\n    if (!whitelist) {\n      return;\n    }\n    const requestedReplacements = {};\n    whitelist\n      .trim()\n      .split(/\\s+/)\n      .forEach(replacement => {\n        if (\n          !opt_supportedReplacement ||\n          hasOwn(opt_supportedReplacement, replacement)\n        ) {\n          requestedReplacements[replacement] = true;\n        } else {\n          user().warn('URL', 'Ignoring unsupported replacement', replacement);\n        }\n      });\n    return requestedReplacements;\n  }\n\n  /**\n   * Returns whether variable substitution is allowed for given url.\n   * @param {!Location} url\n   * @return {boolean}\n   */\n  isAllowedOrigin_(url) {\n    const docInfo = Services.documentInfoForDoc(this.ampdoc);\n    if (\n      url.origin == parseUrlDeprecated(docInfo.canonicalUrl).origin ||\n      url.origin == parseUrlDeprecated(docInfo.sourceUrl).origin\n    ) {\n      return true;\n    }\n\n    const meta = this.ampdoc\n      .getRootNode()\n      .querySelector('meta[name=amp-link-variable-allowed-origin]');\n\n    if (meta && meta.hasAttribute('content')) {\n      const whitelist = meta\n        .getAttribute('content')\n        .trim()\n        .split(/\\s+/);\n      for (let i = 0; i < whitelist.length; i++) {\n        if (url.origin == parseUrlDeprecated(whitelist[i]).origin) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Replaces values in the link of an anchor tag if\n   * - the link opts into it (via data-amp-replace argument)\n   * - the destination is the source or canonical origin of this doc.\n   * @param {!Element} element An anchor element.\n   * @param {?string} defaultUrlParams to expand link if caller request.\n   * @return {string|undefined} Replaced string for testing\n   */\n  maybeExpandLink(element, defaultUrlParams) {\n    devAssert(element.tagName == 'A');\n    const supportedReplacements = {\n      'CLIENT_ID': true,\n      'QUERY_PARAM': true,\n      'PAGE_VIEW_ID': true,\n      'PAGE_VIEW_ID_64': true,\n      'NAV_TIMING': true,\n    };\n    const additionalUrlParameters =\n      element.getAttribute('data-amp-addparams') || '';\n    const whitelist = this.getWhitelistForElement_(\n      element,\n      supportedReplacements\n    );\n\n    if (!whitelist && !additionalUrlParameters && !defaultUrlParams) {\n      return;\n    }\n    // ORIGINAL_HREF_PROPERTY has the value of the href \"pre-replacement\".\n    // We set this to the original value before doing any work and use it\n    // on subsequent replacements, so that each run gets a fresh value.\n    let href = dev().assertString(\n      element[ORIGINAL_HREF_PROPERTY] || element.getAttribute('href')\n    );\n    const url = parseUrlDeprecated(href);\n    if (element[ORIGINAL_HREF_PROPERTY] == null) {\n      element[ORIGINAL_HREF_PROPERTY] = href;\n    }\n    if (additionalUrlParameters) {\n      href = addParamsToUrl(href, parseQueryString(additionalUrlParameters));\n    }\n\n    const isAllowedOrigin = this.isAllowedOrigin_(url);\n    if (!isAllowedOrigin) {\n      if (whitelist) {\n        user().warn(\n          'URL',\n          'Ignoring link replacement %s' +\n            \" because the link does not go to the document's\" +\n            ' source, canonical, or whitelisted origin.',\n          href\n        );\n      }\n      return (element.href = href);\n    }\n\n    // Note that defaultUrlParams is treated differently than\n    // additionalUrlParameters in two ways #1: If the outgoing url origin is not\n    // whitelisted: additionalUrlParameters are always appended by not expanded,\n    // defaultUrlParams will not be appended. #2: If the expansion function is\n    // not whitelisted: additionalUrlParamters will not be expanded,\n    // defaultUrlParams will by default support QUERY_PARAM, and will still be\n    // expanded.\n    if (defaultUrlParams) {\n      if (!whitelist || !whitelist['QUERY_PARAM']) {\n        // override whitelist and expand defaultUrlParams;\n        const overrideWhitelist = {'QUERY_PARAM': true};\n        defaultUrlParams = this.expandUrlSync(\n          defaultUrlParams,\n          /* opt_bindings */ undefined,\n          /* opt_collectVars */ undefined,\n          /* opt_whitelist */ overrideWhitelist\n        );\n      }\n      href = addParamsToUrl(href, parseQueryString(defaultUrlParams));\n    }\n\n    if (whitelist) {\n      href = this.expandUrlSync(\n        href,\n        /* opt_bindings */ undefined,\n        /* opt_collectVars */ undefined,\n        /* opt_whitelist */ whitelist\n      );\n    }\n\n    return (element.href = href);\n  }\n\n  /**\n   * Collects all substitutions in the provided URL and expands them to the\n   * values for known variables. Optional `opt_bindings` can be used to add\n   * new variables or override existing ones.\n   * @param {string} url\n   * @param {!Object<string, *>=} opt_bindings\n   * @return {!Promise<!Object<string, *>>}\n   */\n  collectVars(url, opt_bindings) {\n    const vars = Object.create(null);\n    return new Expander(this.variableSource_, opt_bindings, vars)\n      ./*OK*/ expand(url)\n      .then(() => vars);\n  }\n\n  /**\n   * Collects substitutions in the `src` attribute of the given element\n   * that are _not_ whitelisted via `data-amp-replace` opt-in attribute.\n   * @param {!Element} element\n   * @return {!Array<string>}\n   */\n  collectUnwhitelistedVarsSync(element) {\n    const url = element.getAttribute('src');\n    const macroNames = new Expander(this.variableSource_).getMacroNames(url);\n    const whitelist = this.getWhitelistForElement_(element);\n    if (whitelist) {\n      return macroNames.filter(v => !whitelist[v]);\n    } else {\n      // All vars are unwhitelisted if the element has no whitelist.\n      return macroNames;\n    }\n  }\n\n  /**\n   * Ensures that the protocol of the original url matches the protocol of the\n   * replacement url. Returns the replacement if they do, the original if they\n   * do not.\n   * @param {string} url\n   * @param {string} replacement\n   * @return {string}\n   */\n  ensureProtocolMatches_(url, replacement) {\n    const newProtocol = parseUrlDeprecated(replacement, /* opt_nocache */ true)\n      .protocol;\n    const oldProtocol = parseUrlDeprecated(url, /* opt_nocache */ true)\n      .protocol;\n    if (newProtocol != oldProtocol) {\n      user().error(TAG, 'Illegal replacement of the protocol: ', url);\n      return url;\n    }\n    userAssert(\n      isProtocolValid(replacement),\n      'The replacement url has invalid protocol: %s',\n      replacement\n    );\n\n    return replacement;\n  }\n\n  /**\n   * @return {VariableSource}\n   */\n  getVariableSource() {\n    return this.variableSource_;\n  }\n}\n\n/**\n * Extracts client ID from a _ga cookie.\n * https://developers.google.com/analytics/devguides/collection/analyticsjs/cookies-user-id\n * @param {string} gaCookie\n * @return {string}\n */\nexport function extractClientIdFromGaCookie(gaCookie) {\n  return gaCookie.replace(/^(GA1|1)\\.[\\d-]+\\./, '');\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installUrlReplacementsServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(ampdoc, 'url-replace', function(doc) {\n    return new UrlReplacements(doc, new GlobalVariableSource(doc));\n  });\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n * @param {!Window} embedWin\n * @param {!VariableSource} varSource\n */\nexport function installUrlReplacementsForEmbed(ampdoc, embedWin, varSource) {\n  installServiceInEmbedScope(\n    embedWin,\n    'url-replace',\n    new UrlReplacements(ampdoc, varSource)\n  );\n}\n\n/**\n * @typedef {{incomingFragment: string, outgoingFragment: string}}\n */\nlet ShareTrackingFragmentsDef;\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport {Services} from '../services';\nimport {devAssert} from '../log';\nimport {isFiniteNumber} from '../types';\nimport {loadPromise} from '../event-helper';\nimport {whenDocumentComplete} from '../document-ready';\n\n/** @typedef {string|number|boolean|undefined|null} */\nexport let ResolverReturnDef;\n\n/** @typedef {function(...string):ResolverReturnDef} */\nexport let SyncResolverDef;\n\n/** @typedef {function(...string):!Promise<ResolverReturnDef>} */\nexport let AsyncResolverDef;\n\n/** @typedef {{sync: SyncResolverDef, async: AsyncResolverDef}} */\nlet ReplacementDef;\n\n/**\n * A list of events that the navTiming needs to wait for.\n * Sort event in order\n * @enum {number}\n */\nconst WAITFOR_EVENTS = {\n  VIEWER_FIRST_VISIBLE: 1,\n  DOCUMENT_COMPLETE: 2,\n  LOAD: 3,\n  LOAD_END: 4,\n};\n\n/**\n * A list of events on which event they should wait\n * @const {!Object<string, WAITFOR_EVENTS>}\n */\nconst NAV_TIMING_WAITFOR_EVENTS = {\n  // ready on viewer first visible\n  'navigationStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'redirectStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'redirectEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'fetchStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'domainLookupStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'domainLookupEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'connectStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'secureConnectionStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'connectEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'requestStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'responseStart': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  'responseEnd': WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE,\n  // ready on document complte\n  'domLoading': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domInteractive': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domContentLoaded': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  'domComplete': WAITFOR_EVENTS.DOCUMENT_COMPLETE,\n  // ready on load\n  'loadEventStart': WAITFOR_EVENTS.LOAD,\n  // ready on load complete\n  'loadEventEnd': WAITFOR_EVENTS.LOAD_END,\n};\n\n/**\n * Returns navigation timing information based on the start and end events.\n * The data for the timing events is retrieved from performance.timing API.\n * If start and end events are both given, the result is the difference between\n * the two. If only start event is given, the result is the timing value at\n * start event.\n * @param {!Window} win\n * @param {string} startEvent\n * @param {string=} endEvent\n * @return {!Promise<ResolverReturnDef>}\n */\nexport function getTimingDataAsync(win, startEvent, endEvent) {\n  // Fallback to load event if we don't know what to wait for\n  const startWaitForEvent =\n    NAV_TIMING_WAITFOR_EVENTS[startEvent] || WAITFOR_EVENTS.LOAD;\n  const endWaitForEvent = endEvent\n    ? NAV_TIMING_WAITFOR_EVENTS[endEvent] || WAITFOR_EVENTS.LOAD\n    : startWaitForEvent;\n\n  const waitForEvent = Math.max(startWaitForEvent, endWaitForEvent);\n\n  // set wait for onload to be default\n  let readyPromise;\n  if (waitForEvent === WAITFOR_EVENTS.VIEWER_FIRST_VISIBLE) {\n    readyPromise = Promise.resolve();\n  } else if (waitForEvent === WAITFOR_EVENTS.DOCUMENT_COMPLETE) {\n    readyPromise = whenDocumentComplete(win.document);\n  } else if (waitForEvent === WAITFOR_EVENTS.LOAD) {\n    readyPromise = loadPromise(win);\n  } else if (waitForEvent === WAITFOR_EVENTS.LOAD_END) {\n    // performance.timing.loadEventEnd returns 0 before the load event handler\n    // has terminated, that's when the load event is completed.\n    // To wait for the event handler to terminate, wait 1ms and defer to the\n    // event loop.\n    const timer = Services.timerFor(win);\n    readyPromise = loadPromise(win).then(() => timer.promise(1));\n  }\n\n  devAssert(readyPromise, 'waitForEvent not supported ' + waitForEvent);\n\n  return readyPromise.then(() => {\n    return getTimingDataSync(win, startEvent, endEvent);\n  });\n}\n\n/**\n * Returns navigation timing information based on the start and end events.\n * The data for the timing events is retrieved from performance.timing API.\n * If start and end events are both given, the result is the difference between\n * the two. If only start event is given, the result is the timing value at\n * start event. Enforces synchronous evaluation.\n * @param {!Window} win\n * @param {string} startEvent\n * @param {string=} endEvent\n * @return {ResolverReturnDef} undefined if API is not available, empty string\n *    if it is not yet available, or value as string\n */\nexport function getTimingDataSync(win, startEvent, endEvent) {\n  const timingInfo = win['performance'] && win['performance']['timing'];\n  if (!timingInfo || timingInfo['navigationStart'] == 0) {\n    // Navigation timing API is not supported.\n    return;\n  }\n\n  const metric =\n    endEvent === undefined\n      ? timingInfo[startEvent]\n      : timingInfo[endEvent] - timingInfo[startEvent];\n\n  if (!isFiniteNumber(metric) || metric < 0) {\n    // The metric is not supported.\n    return;\n  } else {\n    return metric;\n  }\n}\n\n/**\n * Returns navigation information from the current browsing context.\n * @param {!Window} win\n * @param {string} attribute\n * @return {ResolverReturnDef}\n * @private\n */\nexport function getNavigationData(win, attribute) {\n  const navigationInfo = win['performance'] && win['performance']['navigation'];\n  if (!navigationInfo || navigationInfo[attribute] === undefined) {\n    // PerformanceNavigation interface is not supported or attribute is not\n    // implemented.\n    return;\n  }\n  return navigationInfo[attribute];\n}\n\n/**\n * A class to provide variable substitution related features. Extend this class\n * and override initialize() to add more supported variables.\n */\nexport class VariableSource {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @protected @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @private @const {!Object<string, !ReplacementDef>} */\n    this.replacements_ = Object.create(null);\n\n    /** @private {boolean} */\n    this.initialized_ = false;\n\n    this.getUrlMacroWhitelist_();\n  }\n\n  /**\n   * Lazily initialize the default replacements.\n   * @private\n   */\n  initialize_() {\n    this.initialize();\n    this.initialized_ = true;\n  }\n\n  /**\n   * Override this method to set all the variables supported by derived class.\n   */\n  initialize() {\n    // Needs to be implemented by derived classes.\n  }\n\n  /**\n   * Method exists to assist stubbing in tests.\n   * @param {string} name\n   * @return {!ReplacementDef}\n   */\n  get(name) {\n    if (!this.initialized_) {\n      this.initialize_();\n    }\n\n    return this.replacements_[name];\n  }\n\n  /**\n   * Sets a synchronous value resolver for the variable with the specified name.\n   * The value resolver may optionally take an extra parameter.\n   * Can be called in conjunction with setAsync to allow for additional\n   * asynchronous resolver where expand will use async and expandSync the sync\n   * version.\n   * @param {string} varName\n   * @param {!SyncResolverDef} syncResolver\n   * @return {!VariableSource}\n   */\n  set(varName, syncResolver) {\n    devAssert(varName.indexOf('RETURN') == -1);\n    this.replacements_[varName] = this.replacements_[varName] || {\n      sync: undefined,\n      async: undefined,\n    };\n    this.replacements_[varName].sync = syncResolver;\n    return this;\n  }\n\n  /**\n   * Sets an async value resolver for the variable with the specified name.\n   * The value resolver may optionally take an extra parameter.\n   * Can be called in conjuction with setAsync to allow for additional\n   * asynchronous resolver where expand will use async and expandSync the sync\n   * version.\n   * @param {string} varName\n   * @param {!AsyncResolverDef} asyncResolver\n   * @return {!VariableSource}\n   */\n  setAsync(varName, asyncResolver) {\n    devAssert(varName.indexOf('RETURN') == -1);\n    this.replacements_[varName] = this.replacements_[varName] || {\n      sync: undefined,\n      async: undefined,\n    };\n    this.replacements_[varName].async = asyncResolver;\n    return this;\n  }\n\n  /**\n   * Helper method to set both sync and async resolvers.\n   * @param {string} varName\n   * @param {!SyncResolverDef} syncResolver\n   * @param {!AsyncResolverDef} asyncResolver\n   * @return {!VariableSource}\n   */\n  setBoth(varName, syncResolver, asyncResolver) {\n    return this.set(varName, syncResolver).setAsync(varName, asyncResolver);\n  }\n\n  /**\n   * Returns a Regular expression that can be used to detect all the variables\n   * in a template.\n   * @param {!Object<string, *>=} opt_bindings\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of names\n   *   that can be substituted.\n   * @return {!RegExp}\n   */\n  getExpr(opt_bindings, opt_whiteList) {\n    if (!this.initialized_) {\n      this.initialize_();\n    }\n    const all = Object.assign({}, this.replacements_, opt_bindings);\n    return this.buildExpr_(Object.keys(all), opt_whiteList);\n  }\n\n  /**\n   * @param {!Array<string>} keys\n   * @param {!Object<string, boolean>=} opt_whiteList Optional white list of names\n   *   that can be substituted.\n   * @return {!RegExp}\n   * @private\n   */\n  buildExpr_(keys, opt_whiteList) {\n    // If a whitelist is present, the keys must belong to the whitelist.\n    // We filter the keys one last time to ensure no unwhitelisted key is\n    // allowed.\n    if (this.getUrlMacroWhitelist_()) {\n      keys = keys.filter(key => this.getUrlMacroWhitelist_().includes(key));\n    }\n    // If a whitelist is passed into the call to GlobalVariableSource.expand_\n    // then we only resolve values contained in the whitelist.\n    if (opt_whiteList) {\n      keys = keys.filter(key => opt_whiteList[key]);\n    }\n    if (keys.length === 0) {\n      const regexThatMatchesNothing = /_^/g; // lgtm [js/regex/unmatchable-caret]\n      return regexThatMatchesNothing;\n    }\n    // The keys must be sorted to ensure that the longest keys are considered\n    // first. This avoids a problem where a RANDOM conflicts with RANDOM_ONE.\n    keys.sort((s1, s2) => s2.length - s1.length);\n    // Keys that start with a `$` need to be escaped so that they do not\n    // interfere with the regex that is constructed.\n    const escaped = keys.map(key => {\n      if (key[0] === '$') {\n        return '\\\\' + key;\n      }\n      return key;\n    });\n\n    const all = escaped.join('|');\n    // Match the given replacement patterns, as well as optionally\n    // arguments to the replacement behind it in parentheses.\n    // Example string that match\n    // FOO_BAR\n    // FOO_BAR(arg1)\n    // FOO_BAR(arg1,arg2)\n    // FOO_BAR(arg1, arg2)\n    const regexStr = '\\\\$?(' + all + ')';\n    return new RegExp(regexStr, 'g');\n  }\n\n  /**\n   * @return {?Array<string>} The whitelist of allowed AMP variables. (if provided in\n   *     a meta tag).\n   * @private\n   */\n  getUrlMacroWhitelist_() {\n    if (this.variableWhitelist_) {\n      return this.variableWhitelist_;\n    }\n\n    const {head} = this.ampdoc.getRootNode();\n    if (!head) {\n      return null;\n    }\n\n    // A meta[name=\"amp-allowed-url-macros\"] tag, if present,\n    // contains, in its content attribute, a whitelist of variable substitution.\n    const meta = head.querySelector('meta[name=\"amp-allowed-url-macros\"]');\n    if (!meta) {\n      return null;\n    }\n\n    /**\n     * The whitelist of variables allowed for variable substitution.\n     * @private {?Array<string>}\n     */\n    this.variableWhitelist_ = meta\n      .getAttribute('content')\n      .split(',')\n      .map(variable => variable.trim());\n    return this.variableWhitelist_;\n  }\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {dict} from '../utils/object';\nimport {parseUrlDeprecated} from '../url';\n\n/**\n * Exposes CID API if provided by the Viewer.\n */\nexport class ViewerCidApi {\n  /**\n   * Creates an instance of ViewerCidApi.\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @private {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc_ = ampdoc;\n\n    /** @private {!./viewer-interface.ViewerInterface} */\n    this.viewer_ = Services.viewerForDoc(this.ampdoc_);\n\n    const {canonicalUrl} = Services.documentInfoForDoc(this.ampdoc_);\n\n    /** @private {?string} */\n    this.canonicalOrigin_ = canonicalUrl\n      ? parseUrlDeprecated(canonicalUrl).origin\n      : null;\n  }\n\n  /**\n   * Resolves to true if Viewer is trusted and supports CID API.\n   * @return {!Promise<boolean>}\n   */\n  isSupported() {\n    if (!this.viewer_.hasCapability('cid')) {\n      return Promise.resolve(false);\n    }\n    return this.viewer_.isTrustedViewer();\n  }\n\n  /**\n   * Returns scoped CID retrieved from the Viewer.\n   * @param {string|undefined} apiKey\n   * @param {string} scope\n   * @return {!Promise<?JsonObject|string|undefined>}\n   */\n  getScopedCid(apiKey, scope) {\n    const payload = dict({\n      'scope': scope,\n      'clientIdApi': !!apiKey,\n      'canonicalOrigin': this.canonicalOrigin_,\n    });\n    if (apiKey) {\n      payload['apiKey'] = apiKey;\n    }\n    return this.viewer_.sendMessageAwaitResponse('cid', payload);\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred, tryResolve} from '../utils/promise';\nimport {Observable} from '../observable';\nimport {Services} from '../services';\nimport {ViewerInterface} from './viewer-interface';\nimport {VisibilityState} from '../visibility-state';\nimport {dev, devAssert, duplicateErrorIfNecessary} from '../log';\nimport {findIndex} from '../utils/array';\nimport {\n  getSourceOrigin,\n  isProxyOrigin,\n  parseQueryString,\n  parseUrlDeprecated,\n  removeFragment,\n  serializeQueryString,\n} from '../url';\nimport {isIframed} from '../dom';\nimport {map} from '../utils/object';\nimport {registerServiceBuilderForDoc} from '../service';\nimport {reportError} from '../error';\nimport {startsWith} from '../string';\nimport {urls} from '../config';\n\nconst TAG_ = 'Viewer';\n\n/** @enum {string} */\nexport const Capability = {\n  VIEWER_RENDER_TEMPLATE: 'viewerRenderTemplate',\n};\n\n/**\n * Duration in milliseconds to wait for viewerOrigin to be set before an empty\n * string is returned.\n * @const\n * @private {number}\n */\nconst VIEWER_ORIGIN_TIMEOUT_ = 1000;\n\n/**\n * Prefixes to remove when trimming a hostname for comparison.\n * @const\n * @private {!RegExp}\n */\nconst TRIM_ORIGIN_PATTERN_ = /^(https?:\\/\\/)((www[0-9]*|web|ftp|wap|home|mobile|amp|m)\\.)+/i;\n\n/**\n * An AMP representation of the Viewer. This class doesn't do any work itself\n * but instead delegates everything to the actual viewer. This class and the\n * actual Viewer are connected via \"AMP.viewer\" using three methods:\n * {@link getParam}, {@link receiveMessage} and {@link setMessageDeliverer}.\n * @implements {ViewerInterface}\n * @package Visible for type.\n */\nexport class ViewerImpl {\n  /**\n   * @param {!./ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!./ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!Window} */\n    this.win = ampdoc.win;\n\n    /** @private @const {boolean} */\n    this.isIframed_ = isIframed(this.win);\n\n    /** @private {boolean} */\n    this.isRuntimeOn_ = true;\n\n    /** @private {boolean} */\n    this.overtakeHistory_ = false;\n\n    /** @private {number} */\n    this.prerenderSize_ = 1;\n\n    /** @private {!Object<string, !Observable<!JsonObject>>} */\n    this.messageObservables_ = map();\n\n    /** @private {!Object<string, !./viewer-interface.RequestResponderDef>} */\n    this.messageResponders_ = map();\n\n    /** @private {!Observable<boolean>} */\n    this.runtimeOnObservable_ = new Observable();\n\n    /** @private {!Observable<!JsonObject>} */\n    this.broadcastObservable_ = new Observable();\n\n    /**\n     * @private {?function(string, (?JsonObject|string|undefined), boolean):\n     *     (Promise<*>|undefined)}\n     */\n    this.messageDeliverer_ = null;\n\n    /** @private {?string} */\n    this.messagingOrigin_ = null;\n\n    /**\n     * @private {!Array<!{\n     *   eventType: string,\n     *   data: (?JsonObject|string|undefined),\n     *   awaitResponse: boolean,\n     *   responsePromise: (Promise<*>|undefined),\n     *   responseResolver: function(*)\n     * }>}\n     */\n    this.messageQueue_ = [];\n\n    /**\n     * Subset of this.params_ that only contains parameters in the URL hash,\n     * e.g. \"#foo=bar\".\n     * @const @private {!Object<string, string>}\n     */\n    this.hashParams_ = map();\n\n    if (ampdoc.isSingleDoc()) {\n      Object.assign(this.hashParams_, parseQueryString(this.win.location.hash));\n    }\n\n    this.isRuntimeOn_ = !parseInt(ampdoc.getParam('off'), 10);\n    dev().fine(TAG_, '- runtimeOn:', this.isRuntimeOn_);\n\n    this.overtakeHistory_ = !!(\n      parseInt(ampdoc.getParam('history'), 10) || this.overtakeHistory_\n    );\n    dev().fine(TAG_, '- history:', this.overtakeHistory_);\n\n    dev().fine(TAG_, '- visibilityState:', this.ampdoc.getVisibilityState());\n\n    this.prerenderSize_ =\n      parseInt(ampdoc.getParam('prerenderSize'), 10) || this.prerenderSize_;\n    dev().fine(TAG_, '- prerenderSize:', this.prerenderSize_);\n\n    /**\n     * Whether the AMP document is embedded in a Chrome Custom Tab.\n     * @private {?boolean}\n     */\n    this.isCctEmbedded_ = null;\n\n    /**\n     * Whether the AMP document was served by a proxy.\n     * @private @const {boolean}\n     */\n    this.isProxyOrigin_ = isProxyOrigin(\n      parseUrlDeprecated(this.ampdoc.win.location.href)\n    );\n\n    const messagingDeferred = new Deferred();\n    /** @const @private {!Function} */\n    this.messagingReadyResolver_ = messagingDeferred.resolve;\n    /** @const @private {?Promise} */\n    this.messagingReadyPromise_ = this.initMessagingChannel_(\n      messagingDeferred.promise\n    );\n\n    /** @private {?Promise<boolean>} */\n    this.isTrustedViewer_ = null;\n\n    /** @private {?Promise<string>} */\n    this.viewerOrigin_ = null;\n\n    const referrerParam = ampdoc.getParam('referrer');\n    /** @private {string} */\n    this.unconfirmedReferrerUrl_ =\n      this.isEmbedded() &&\n      referrerParam != null &&\n      this.isTrustedAncestorOrigins_() !== false\n        ? referrerParam\n        : this.win.document.referrer;\n\n    /** @const @private {!Promise<string>} */\n    this.referrerUrl_ = new Promise(resolve => {\n      if (this.isEmbedded() && ampdoc.getParam('referrer') != null) {\n        // Viewer override, but only for whitelisted viewers. Only allowed for\n        // iframed documents.\n        this.isTrustedViewer().then(isTrusted => {\n          if (isTrusted) {\n            resolve(ampdoc.getParam('referrer'));\n          } else {\n            resolve(this.win.document.referrer);\n            if (this.unconfirmedReferrerUrl_ != this.win.document.referrer) {\n              dev().expectedError(\n                TAG_,\n                'Untrusted viewer referrer override: ' +\n                  this.unconfirmedReferrerUrl_ +\n                  ' at ' +\n                  this.messagingOrigin_\n              );\n              this.unconfirmedReferrerUrl_ = this.win.document.referrer;\n            }\n          }\n        });\n      } else {\n        resolve(this.win.document.referrer);\n      }\n    });\n\n    /** @private {string} */\n    this.resolvedViewerUrl_ = removeFragment(this.win.location.href || '');\n\n    /** @const @private {!Promise<string>} */\n    this.viewerUrl_ = new Promise(resolve => {\n      /** @const {?string} */\n      const viewerUrlOverride = ampdoc.getParam('viewerUrl');\n      if (this.isEmbedded() && viewerUrlOverride) {\n        // Viewer override, but only for whitelisted viewers. Only allowed for\n        // iframed documents.\n        this.isTrustedViewer().then(isTrusted => {\n          if (isTrusted) {\n            this.resolvedViewerUrl_ = devAssert(viewerUrlOverride);\n          } else {\n            dev().expectedError(\n              TAG_,\n              'Untrusted viewer url override: ' +\n                viewerUrlOverride +\n                ' at ' +\n                this.messagingOrigin_\n            );\n          }\n          resolve(this.resolvedViewerUrl_);\n        });\n      } else {\n        resolve(this.resolvedViewerUrl_);\n      }\n    });\n\n    // Remove hash when we have an incoming click tracking string\n    // (see impression.js).\n    if (this.hashParams_['click']) {\n      const newUrl = removeFragment(this.win.location.href);\n      if (newUrl != this.win.location.href && this.win.history.replaceState) {\n        // Persist the hash that we removed has location.originalHash.\n        // This is currently used by mode.js to infer development mode.\n        if (!this.win.location.originalHash) {\n          this.win.location.originalHash = this.win.location.hash;\n        }\n        this.win.history.replaceState({}, '', newUrl);\n        delete this.hashParams_['click'];\n        dev().fine(TAG_, 'replace fragment:' + this.win.location.href);\n      }\n    }\n\n    // This fragment may get cleared by impression tracking. If so, it will be\n    // restored afterward.\n    this.ampdoc.whenFirstVisible().then(() => {\n      this.maybeUpdateFragmentForCct();\n    });\n  }\n\n  /**\n   * Initialize messaging channel with Viewer host.\n   * This promise will resolve when communications channel has been\n   * established or timeout in 20 seconds. The timeout is needed to avoid\n   * this promise becoming a memory leak with accumulating undelivered\n   * messages. The promise is only available when the document is embedded.\n   *\n   * @param {!Promise} messagingPromise\n   * @return {?Promise}\n   * @private\n   */\n  initMessagingChannel_(messagingPromise) {\n    const isEmbedded = !!(\n      (this.isIframed_ &&\n        !this.win.__AMP_TEST_IFRAME &&\n        // Checking param \"origin\", as we expect all viewers to provide it.\n        // See https://github.com/ampproject/amphtml/issues/4183\n        // There appears to be a bug under investigation where the\n        // origin is sometimes failed to be detected. Since failure mode\n        // if we fail to initialize communication is very bad, we also check\n        // for visibilityState.\n        // After https://github.com/ampproject/amphtml/issues/6070\n        // is fixed we should probably only keep the amp_js_v check here.\n        (this.ampdoc.getParam('origin') ||\n          this.ampdoc.getParam('visibilityState') ||\n          // Parent asked for viewer JS. We must be embedded.\n          this.win.location.search.indexOf('amp_js_v') != -1)) ||\n      this.isWebviewEmbedded() ||\n      this.isCctEmbedded() ||\n      !this.ampdoc.isSingleDoc()\n    );\n\n    if (!isEmbedded) {\n      return null;\n    }\n    return Services.timerFor(this.win)\n      .timeoutPromise(20000, messagingPromise, 'initMessagingChannel')\n      .catch(reason => {\n        const error = getChannelError(\n          /** @type {!Error|string|undefined} */ (reason)\n        );\n        reportError(error);\n        throw error;\n      });\n  }\n\n  /** @override */\n  getAmpDoc() {\n    return this.ampdoc;\n  }\n\n  /** @override */\n  getParam(name) {\n    return this.ampdoc.getParam(name);\n  }\n\n  /** @override */\n  hasCapability(name) {\n    const capabilities = this.ampdoc.getParam('cap');\n    if (!capabilities) {\n      return false;\n    }\n    // TODO(@cramforce): Consider caching the split.\n    return capabilities.split(',').indexOf(name) != -1;\n  }\n\n  /** @override */\n  isEmbedded() {\n    return !!this.messagingReadyPromise_;\n  }\n\n  /** @override */\n  isWebviewEmbedded() {\n    return !this.isIframed_ && this.ampdoc.getParam('webview') == '1';\n  }\n\n  /** @override */\n  isCctEmbedded() {\n    if (this.isCctEmbedded_ != null) {\n      return this.isCctEmbedded_;\n    }\n    this.isCctEmbedded_ = false;\n    if (!this.isIframed_) {\n      const queryParams = parseQueryString(this.win.location.search);\n      this.isCctEmbedded_ =\n        queryParams['amp_gsa'] === '1' &&\n        startsWith(queryParams['amp_js_v'] || '', 'a');\n    }\n    return this.isCctEmbedded_;\n  }\n\n  /** @override */\n  isProxyOrigin() {\n    return this.isProxyOrigin_;\n  }\n\n  /** @override */\n  maybeUpdateFragmentForCct() {\n    if (!this.isCctEmbedded()) {\n      return;\n    }\n    // CCT only works with versions of Chrome that support the history API.\n    if (!this.win.history.replaceState) {\n      return;\n    }\n    const sourceOrigin = getSourceOrigin(this.win.location.href);\n    const {canonicalUrl} = Services.documentInfoForDoc(this.ampdoc);\n    const canonicalSourceOrigin = getSourceOrigin(canonicalUrl);\n    if (this.hasRoughlySameOrigin_(sourceOrigin, canonicalSourceOrigin)) {\n      this.hashParams_['ampshare'] = canonicalUrl;\n      this.win.history.replaceState(\n        {},\n        '',\n        '#' +\n          serializeQueryString(/** @type {!JsonObject} */ (this.hashParams_))\n      );\n    }\n  }\n\n  /**\n   * Compares URLs to determine if they match once common subdomains are\n   * removed. Everything else must match.\n   * @param {string} first Origin to compare.\n   * @param {string} second Origin to compare.\n   * @return {boolean} Whether the origins match without subdomains.\n   * @private\n   */\n  hasRoughlySameOrigin_(first, second) {\n    const trimOrigin = origin => {\n      if (origin.split('.').length > 2) {\n        return origin.replace(TRIM_ORIGIN_PATTERN_, '$1');\n      }\n      return origin;\n    };\n    return trimOrigin(first) == trimOrigin(second);\n  }\n\n  /** @override */\n  isRuntimeOn() {\n    return this.isRuntimeOn_;\n  }\n\n  /** @override */\n  toggleRuntime() {\n    this.isRuntimeOn_ = !this.isRuntimeOn_;\n    dev().fine(TAG_, 'Runtime state:', this.isRuntimeOn_);\n    this.runtimeOnObservable_.fire(this.isRuntimeOn_);\n  }\n\n  /** @override */\n  onRuntimeState(handler) {\n    return this.runtimeOnObservable_.add(handler);\n  }\n\n  /** @override */\n  isOvertakeHistory() {\n    return this.overtakeHistory_;\n  }\n\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  getVisibilityState() {\n    return this.ampdoc.getVisibilityState();\n  }\n\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  isVisible() {\n    return this.ampdoc.isVisible();\n  }\n\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  hasBeenVisible() {\n    return this.ampdoc.hasBeenVisible();\n  }\n\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  whenFirstVisible() {\n    return this.ampdoc.whenFirstVisible();\n  }\n\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  whenNextVisible() {\n    return this.ampdoc.whenNextVisible();\n  }\n\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  getFirstVisibleTime() {\n    return this.ampdoc.getFirstVisibleTime();\n  }\n\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  getLastVisibleTime() {\n    return this.ampdoc.getLastVisibleTime();\n  }\n\n  /**\n   * Passthrough for ampdoc visibility state. Only to be used by viewer\n   * integration.\n   * @restricted\n   * TODO(#22733): remove if no longer used by the viewer.\n   */\n  onVisibilityChanged(handler) {\n    return this.ampdoc.onVisibilityChanged(handler);\n  }\n\n  /**\n   * Sets the viewer defined visibility state.\n   * @param {?string|undefined} state\n   * @private\n   */\n  setVisibilityState_(state) {\n    if (!state) {\n      return;\n    }\n    state = dev().assertEnumValue(VisibilityState, state, 'VisibilityState');\n\n    // The viewer is informing us we are not currently active because we are\n    // being pre-rendered, or the user swiped to another doc (or closed the\n    // viewer). Unfortunately, the viewer sends HIDDEN instead of PRERENDER or\n    // INACTIVE, though we know better.\n    if (state === VisibilityState.HIDDEN) {\n      state =\n        this.ampdoc.getLastVisibleTime() != null\n          ? VisibilityState.INACTIVE\n          : VisibilityState.PRERENDER;\n    }\n\n    this.ampdoc.overrideVisibilityState(state);\n    dev().fine(\n      TAG_,\n      'visibilitychange event:',\n      this.ampdoc.getVisibilityState()\n    );\n  }\n\n  /** @override */\n  getPrerenderSize() {\n    return this.prerenderSize_;\n  }\n\n  /** @override */\n  getResolvedViewerUrl() {\n    return this.resolvedViewerUrl_;\n  }\n\n  /**\n   * Returns the promise that will yield the viewer URL value. It's by default\n   * the current page's URL. The trusted viewers are allowed to override this\n   * value.\n   * @return {!Promise<string>}\n   * @visibleForTesting\n   */\n  getViewerUrl() {\n    return this.viewerUrl_;\n  }\n\n  /** @override */\n  maybeGetMessagingOrigin() {\n    return this.messagingOrigin_;\n  }\n\n  /** @override */\n  getUnconfirmedReferrerUrl() {\n    return this.unconfirmedReferrerUrl_;\n  }\n\n  /** @override */\n  getReferrerUrl() {\n    return this.referrerUrl_;\n  }\n\n  /** @override */\n  isTrustedViewer() {\n    if (!this.isTrustedViewer_) {\n      const isTrustedAncestorOrigins = this.isTrustedAncestorOrigins_();\n      this.isTrustedViewer_ =\n        isTrustedAncestorOrigins !== undefined\n          ? Promise.resolve(isTrustedAncestorOrigins)\n          : this.messagingReadyPromise_.then(origin => {\n              return origin ? this.isTrustedViewerOrigin_(origin) : false;\n            });\n    }\n    return /** @type {!Promise<boolean>} */ (this.isTrustedViewer_);\n  }\n\n  /**\n   * Whether the viewer is has been whitelisted for more sensitive operations\n   * by looking at the ancestorOrigins.\n   * @return {boolean|undefined}\n   */\n  isTrustedAncestorOrigins_() {\n    if (!this.isEmbedded()) {\n      // Not embedded in IFrame - can't trust the viewer.\n      return false;\n    } else if (\n      this.win.location.ancestorOrigins &&\n      !this.isWebviewEmbedded() &&\n      !this.isCctEmbedded()\n    ) {\n      // Ancestors when available take precedence. This is the main API used\n      // for this determination. Fallback is only done when this API is not\n      // supported by the browser.\n      return (\n        this.win.location.ancestorOrigins.length > 0 &&\n        this.isTrustedViewerOrigin_(this.win.location.ancestorOrigins[0])\n      );\n    }\n  }\n\n  /** @override */\n  getViewerOrigin() {\n    if (!this.viewerOrigin_) {\n      let origin;\n      if (!this.isEmbedded()) {\n        // Viewer is only determined for iframed documents at this time.\n        origin = '';\n      } else if (\n        this.win.location.ancestorOrigins &&\n        this.win.location.ancestorOrigins.length > 0\n      ) {\n        origin = this.win.location.ancestorOrigins[0];\n      }\n      this.viewerOrigin_ =\n        origin !== undefined\n          ? Promise.resolve(origin)\n          : Services.timerFor(this.win)\n              .timeoutPromise(\n                VIEWER_ORIGIN_TIMEOUT_,\n                this.messagingReadyPromise_\n              )\n              .catch(() => '');\n    }\n    return /** @type {!Promise<string>} */ (this.viewerOrigin_);\n  }\n\n  /**\n   * @param {string} urlString\n   * @return {boolean}\n   * @private\n   */\n  isTrustedViewerOrigin_(urlString) {\n    /** @const {!Location} */\n    const url = parseUrlDeprecated(urlString);\n    const {protocol} = url;\n    // Mobile WebView x-thread is allowed.\n    if (protocol == 'x-thread:') {\n      return true;\n    }\n    if (protocol != 'https:') {\n      // Non-https origins are never trusted.\n      return false;\n    }\n    return urls.trustedViewerHosts.some(th => th.test(url.hostname));\n  }\n\n  /** @override */\n  onMessage(eventType, handler) {\n    let observable = this.messageObservables_[eventType];\n    if (!observable) {\n      observable = new Observable();\n      this.messageObservables_[eventType] = observable;\n    }\n    return observable.add(handler);\n  }\n\n  /** @override */\n  onMessageRespond(eventType, responder) {\n    this.messageResponders_[eventType] = responder;\n    return () => {\n      if (this.messageResponders_[eventType] === responder) {\n        delete this.messageResponders_[eventType];\n      }\n    };\n  }\n\n  /** @override */\n  receiveMessage(eventType, data, unusedAwaitResponse) {\n    if (eventType == 'visibilitychange') {\n      if (data['prerenderSize'] !== undefined) {\n        this.prerenderSize_ = data['prerenderSize'];\n        dev().fine(TAG_, '- prerenderSize change:', this.prerenderSize_);\n      }\n      this.setVisibilityState_(data['state']);\n      return Promise.resolve();\n    }\n    if (eventType == 'broadcast') {\n      this.broadcastObservable_.fire(\n        /** @type {!JsonObject|undefined} */ (data)\n      );\n      return Promise.resolve();\n    }\n    const observable = this.messageObservables_[eventType];\n    if (observable) {\n      observable.fire(data);\n    }\n    const responder = this.messageResponders_[eventType];\n    if (responder) {\n      return responder(data);\n    } else if (observable) {\n      return Promise.resolve();\n    }\n    dev().fine(TAG_, 'unknown message:', eventType);\n    return undefined;\n  }\n\n  /** @override */\n  setMessageDeliverer(deliverer, origin) {\n    if (this.messageDeliverer_) {\n      throw new Error('message channel can only be initialized once');\n    }\n    if (origin == null) {\n      throw new Error('message channel must have an origin');\n    }\n    dev().fine(TAG_, 'message channel established with origin: ', origin);\n    this.messageDeliverer_ = deliverer;\n    this.messagingOrigin_ = origin;\n    this.messagingReadyResolver_(origin);\n\n    if (this.messageQueue_.length > 0) {\n      const queue = this.messageQueue_.slice(0);\n      this.messageQueue_ = [];\n      queue.forEach(message => {\n        const responsePromise = this.messageDeliverer_(\n          message.eventType,\n          message.data,\n          message.awaitResponse\n        );\n\n        if (message.awaitResponse) {\n          message.responseResolver(responsePromise);\n        }\n      });\n    }\n  }\n\n  /** @override */\n  sendMessage(eventType, data, cancelUnsent = false) {\n    this.sendMessageInternal_(eventType, data, cancelUnsent, false);\n  }\n\n  /** @override */\n  sendMessageAwaitResponse(eventType, data, cancelUnsent = false) {\n    return this.sendMessageInternal_(eventType, data, cancelUnsent, true);\n  }\n\n  /**\n   * Sends the message to the viewer.\n   *\n   * @param {string} eventType\n   * @param {?JsonObject|string|undefined} data\n   * @param {boolean} cancelUnsent\n   * @param {boolean} awaitResponse\n   * @return {!Promise<(?JsonObject|string|undefined)>} the response promise\n   */\n  sendMessageInternal_(eventType, data, cancelUnsent, awaitResponse) {\n    if (this.messageDeliverer_) {\n      // Certain message deliverers return fake \"Promise\" instances called\n      // \"Thenables\". Convert from these values into trusted Promise instances,\n      // assimilating with the resolved (or rejected) internal value.\n      return /** @type {!Promise<?JsonObject|string|undefined>} */ (tryResolve(\n        () =>\n          this.messageDeliverer_(\n            eventType,\n            /** @type {?JsonObject|string|undefined} */ (data),\n            awaitResponse\n          )\n      ));\n    }\n\n    if (!this.messagingReadyPromise_) {\n      if (awaitResponse) {\n        return Promise.reject(getChannelError());\n      } else {\n        return Promise.resolve();\n      }\n    }\n\n    if (!cancelUnsent) {\n      return this.messagingReadyPromise_.then(() => {\n        return this.messageDeliverer_(eventType, data, awaitResponse);\n      });\n    }\n\n    const found = findIndex(this.messageQueue_, m => m.eventType == eventType);\n\n    let message;\n    if (found != -1) {\n      message = this.messageQueue_.splice(found, 1)[0];\n      message.data = data;\n      message.awaitResponse = message.awaitResponse || awaitResponse;\n    } else {\n      const deferred = new Deferred();\n      const {promise: responsePromise, resolve: responseResolver} = deferred;\n\n      message = {\n        eventType,\n        data,\n        awaitResponse,\n        responsePromise,\n        responseResolver,\n      };\n    }\n    this.messageQueue_.push(message);\n    return message.responsePromise;\n  }\n\n  /** @override */\n  broadcast(message) {\n    if (!this.messagingReadyPromise_) {\n      // Messaging is not expected.\n      return Promise.resolve(false);\n    }\n\n    return this.sendMessageInternal_('broadcast', message, false, false).then(\n      () => true,\n      () => false\n    );\n  }\n\n  /** @override */\n  onBroadcast(handler) {\n    return this.broadcastObservable_.add(handler);\n  }\n\n  /** @override */\n  whenMessagingReady() {\n    return this.messagingReadyPromise_;\n  }\n\n  /** @override */\n  replaceUrl(newUrl) {\n    if (\n      !newUrl ||\n      !this.ampdoc.isSingleDoc() ||\n      !this.win.history.replaceState\n    ) {\n      return;\n    }\n\n    try {\n      // The origin and source origin must match.\n      const url = parseUrlDeprecated(this.win.location.href);\n      const replaceUrl = parseUrlDeprecated(\n        removeFragment(newUrl) + this.win.location.hash\n      );\n      if (\n        url.origin == replaceUrl.origin &&\n        getSourceOrigin(url) == getSourceOrigin(replaceUrl)\n      ) {\n        this.win.history.replaceState({}, '', replaceUrl.href);\n        this.win.location.originalHref = url.href;\n        dev().fine(TAG_, 'replace url:' + replaceUrl.href);\n      }\n    } catch (e) {\n      dev().error(TAG_, 'replaceUrl failed', e);\n    }\n  }\n}\n\n/**\n * Creates an error for the case where a channel cannot be established.\n * @param {*=} opt_reason\n * @return {!Error}\n */\nfunction getChannelError(opt_reason) {\n  if (opt_reason instanceof Error) {\n    opt_reason = duplicateErrorIfNecessary(opt_reason);\n    opt_reason.message = 'No messaging channel: ' + opt_reason.message;\n    return opt_reason;\n  }\n  return new Error('No messaging channel: ' + opt_reason);\n}\n\n/**\n * @param {!./ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installViewerServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'viewer',\n    ViewerImpl,\n    /* opt_instantiate */ true\n  );\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @typedef {function(!JsonObject):(!Promise|undefined)}\n */\nexport let RequestResponderDef;\n\n/* eslint-disable no-unused-vars */\n/**\n * @interface\n */\nexport class ViewerInterface {\n  /**\n   * @return {!./ampdoc-impl.AmpDoc}\n   */\n  getAmpDoc() {}\n\n  /**\n   * Returns the value of a viewer's startup parameter with the specified\n   * name or \"undefined\" if the parameter wasn't defined at startup time.\n   * TODO(#22733): deprecate/remove when ampdoc-fie is launched. Be careful that it's\n   * exported. Need to make sure it's not used externally.\n   * @param {string} name\n   * @return {?string}\n   * @export\n   */\n  getParam(name) {}\n\n  /**\n   * Viewers can communicate their \"capabilities\" and this method allows\n   * checking them.\n   * @param {string} name Of the capability.\n   * @return {boolean}\n   */\n  hasCapability(name) {}\n\n  /**\n   * Whether the document is embedded in a viewer.\n   * @return {boolean}\n   */\n  isEmbedded() {}\n\n  /**\n   * Whether the document is embedded in a webview.\n   * @return {boolean}\n   */\n  isWebviewEmbedded() {}\n\n  /**\n   * Whether the document is embedded in a Chrome Custom Tab.\n   * @return {boolean}\n   */\n  isCctEmbedded() {}\n\n  /**\n   * Whether the document was served by a proxy.\n   * @return {boolean}\n   */\n  isProxyOrigin() {}\n\n  /**\n   * Update the URL fragment with data needed to support custom tabs. This will\n   * not clear query string parameters, but will clear the fragment.\n   */\n  maybeUpdateFragmentForCct() {}\n\n  /**\n   * @return {boolean}\n   */\n  isRuntimeOn() {}\n\n  /**\n   */\n  toggleRuntime() {}\n\n  /**\n   * @param {function(boolean)} handler\n   * @return {!UnlistenDef}\n   */\n  onRuntimeState(handler) {}\n\n  /**\n   * Whether the viewer overtakes the history for AMP document. If yes,\n   * the viewer must implement history messages \"pushHistory\" and \"popHistory\"\n   * and emit message \"historyPopped\"\n   * @return {boolean}\n   */\n  isOvertakeHistory() {}\n\n  /**\n   * How much the viewer has requested the runtime to prerender the document.\n   * The values are in number of screens.\n   * @return {number}\n   */\n  getPrerenderSize() {}\n\n  /**\n   * Returns the resolved viewer URL value. It's by default the current page's\n   * URL. The trusted viewers are allowed to override this value.\n   * @return {string}\n   */\n  getResolvedViewerUrl() {}\n\n  /**\n   * Possibly return the messaging origin if set. This would be the origin\n   * of the parent viewer.\n   * @return {?string}\n   */\n  maybeGetMessagingOrigin() {}\n\n  /**\n   * Returns an unconfirmed \"referrer\" URL that can be optionally customized by\n   * the viewer. Consider using `getReferrerUrl()` instead, which returns the\n   * promise that will yield the confirmed \"referrer\" URL.\n   * @return {string}\n   */\n  getUnconfirmedReferrerUrl() {}\n\n  /**\n   * Returns the promise that will yield the confirmed \"referrer\" URL. This\n   * URL can be optionally customized by the viewer, but viewer is required\n   * to be a trusted viewer.\n   * @return {!Promise<string>}\n   */\n  getReferrerUrl() {}\n\n  /**\n   * Whether the viewer has been whitelisted for more sensitive operations\n   * such as customizing referrer.\n   * @return {!Promise<boolean>}\n   */\n  isTrustedViewer() {}\n\n  /**\n   * Returns the promise that resolves to URL representing the origin of the\n   * viewer. If the document is not embedded or if a viewer origin can't be\n   * found, empty string is returned.\n   * @return {!Promise<string>}\n   */\n  getViewerOrigin() {}\n\n  /**\n   * Adds a eventType listener for viewer events.\n   * @param {string} eventType\n   * @param {function(!JsonObject)} handler\n   * @return {!UnlistenDef}\n   */\n  onMessage(eventType, handler) {}\n\n  /**\n   * Adds a eventType listener for viewer events.\n   * @param {string} eventType\n   * @param {!RequestResponderDef} responder\n   * @return {!UnlistenDef}\n   */\n  onMessageRespond(eventType, responder) {}\n\n  /**\n   * Requests AMP document to receive a message from Viewer.\n   * @param {string} eventType\n   * @param {!JsonObject} data\n   * @param {boolean} unusedAwaitResponse\n   * @return {(!Promise<*>|undefined)}\n   * @export\n   */\n  receiveMessage(eventType, data, unusedAwaitResponse) {}\n\n  /**\n   * Provides a message delivery mechanism by which AMP document can send\n   * messages to the viewer.\n   * @param {function(string, (?JsonObject|string|undefined), boolean):\n   *     (!Promise<*>|undefined)} deliverer\n   * @param {string} origin\n   * @export\n   */\n  setMessageDeliverer(deliverer, origin) {}\n\n  /**\n   * Sends the message to the viewer without waiting for any response.\n   * If cancelUnsent is true, the previous message of the same message type will\n   * be canceled.\n   *\n   * This is a restricted API.\n   *\n   * @param {string} eventType\n   * @param {?JsonObject|string|undefined} data\n   * @param {boolean=} cancelUnsent\n   */\n  sendMessage(eventType, data, cancelUnsent = false) {}\n\n  /**\n   * Sends the message to the viewer and wait for response.\n   * If cancelUnsent is true, the previous message of the same message type will\n   * be canceled.\n   *\n   * This is a restricted API.\n   *\n   * @param {string} eventType\n   * @param {?JsonObject|string|undefined} data\n   * @param {boolean=} cancelUnsent\n   * @return {!Promise<(?JsonObject|string|undefined)>} the response promise\n   */\n  sendMessageAwaitResponse(eventType, data, cancelUnsent = false) {}\n\n  /**\n   * Broadcasts a message to all other AMP documents under the same viewer. It\n   * will attempt to deliver messages when the messaging channel has been\n   * established, but it will not fail if the channel is timed out.\n   *\n   * @param {!JsonObject} message\n   * @return {!Promise<boolean>} a Promise of success or not\n   */\n  broadcast(message) {}\n\n  /**\n   * Registers receiver for the broadcast events.\n   * @param {function(!JsonObject)} handler\n   * @return {!UnlistenDef}\n   */\n  onBroadcast(handler) {}\n\n  /**\n   * Resolves when there is a messaging channel established with the viewer.\n   * Will be null if no messaging is needed like in an non-embedded document.\n   * Deprecated: do not use. sendMessage and sendMessageAwaitResponse already\n   *             wait for messaging channel ready.\n   * @return {?Promise}\n   */\n  whenMessagingReady() {}\n\n  /**\n   * Replace the document url with the viewer provided new replaceUrl.\n   * @param {?string} newUrl\n   */\n  replaceUrl(newUrl) {}\n}\n/* eslint-enable no-unused-vars */\n","import {computedStyle} from '../../style';\n\n/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * ViewportBindingDef is an interface that defines an underlying technology\n * behind the {@link ViewportInterface}.\n * @interface\n */\nexport class ViewportBindingDef {\n  /**\n   * Called before a first AMP element is added to resources. The final\n   * preparations must be completed here. Called in the mutate context.\n   */\n  ensureReadyForElements() {}\n\n  /**\n   * Add listeners for global resources.\n   */\n  connect() {}\n\n  /**\n   * Remove listeners for global resources.\n   */\n  disconnect() {}\n\n  /**\n   * Returns the width of top border if this type of viewport needs border\n   * offsetting. This is currently only needed for iOS to avoid scroll freeze.\n   * @return {number}\n   */\n  getBorderTop() {}\n\n  /**\n   * Whether the binding requires fixed elements to be transfered to a\n   * independent fixed layer.\n   * @return {boolean}\n   */\n  requiresFixedLayerTransfer() {}\n\n  /**\n   * Whether the binding requires the global window's `scrollTo` to be\n   * indirected via methods of this binding.\n   * @return {boolean}\n   */\n  overrideGlobalScrollTo() {}\n\n  /**\n   * Whether the binding supports fix-positioned elements.\n   * @return {boolean}\n   */\n  supportsPositionFixed() {}\n\n  /**\n   * Register a callback for scroll events.\n   * @param {function()} unusedCallback\n   */\n  onScroll(unusedCallback) {}\n\n  /**\n   * Register a callback for resize events.\n   * @param {function()} unusedCallback\n   */\n  onResize(unusedCallback) {}\n\n  /**\n   * Updates binding with the new padding.\n   * @param {number} unusedPaddingTop\n   */\n  updatePaddingTop(unusedPaddingTop) {}\n\n  /**\n   * Updates binding with the new padding when hiding viewer header.\n   * @param {boolean} unusedTransient\n   * @param {number} unusedLastPaddingTop\n   */\n  hideViewerHeader(unusedTransient, unusedLastPaddingTop) {}\n\n  /**\n   * Updates binding with the new padding when showing viewer header.\n   * @param {boolean} unusedTransient\n   * @param {number} unusedPaddingTop\n   */\n  showViewerHeader(unusedTransient, unusedPaddingTop) {}\n\n  /**\n   * Disable the scrolling by setting overflow: hidden.\n   * Should only be used for temporarily disabling scroll.\n   */\n  disableScroll() {}\n\n  /**\n   * Reset the scrolling by removing overflow: hidden.\n   */\n  resetScroll() {}\n\n  /**\n   * Updates the viewport whether it's currently in the lightbox or a normal\n   * mode.\n   * @param {boolean} unusedLightboxMode\n   * @return {!Promise}\n   */\n  updateLightboxMode(unusedLightboxMode) {}\n\n  /**\n   * Returns the size of the viewport.\n   * @return {!{width: number, height: number}}\n   */\n  getSize() {}\n\n  /**\n   * Returns the top scroll position for the viewport.\n   * @return {number}\n   */\n  getScrollTop() {}\n\n  /**\n   * Sets scroll top position to the specified value or the nearest possible.\n   * @param {number} unusedScrollTop\n   */\n  setScrollTop(unusedScrollTop) {}\n\n  /**\n   * Returns the left scroll position for the viewport.\n   * @return {number}\n   */\n  getScrollLeft() {}\n\n  /**\n   * Returns the scroll width of the content of the document.\n   * @return {number}\n   */\n  getScrollWidth() {}\n\n  /**\n   * Returns the scroll height of the content of the document, including the\n   * padding top for the viewer header.\n   * The scrollHeight will be the viewport height if there's not enough content\n   * to fill up the viewport.\n   * @return {number}\n   */\n  getScrollHeight() {}\n\n  /**\n   * Returns the height of the content of the document, including the\n   * padding top for the viewer header.\n   * contentHeight will match scrollHeight in all cases unless the viewport is\n   * taller than the content.\n   * @return {number}\n   */\n  getContentHeight() {}\n\n  /**\n   * Resource manager signals to the viewport that content height is changed\n   * and some action may need to be taken.\n   * @restricted Use is restricted due to potentially very heavy performance\n   *   impact. Can only be called when not actively scrolling.\n   */\n  contentHeightChanged() {}\n\n  /**\n   * Returns the rect of the element within the document.\n   * @param {!Element} unusedEl\n   * @param {number=} unusedScrollLeft Optional arguments that the caller may\n   *     pass in, if they cached these values and would like to avoid\n   *     remeasure. Requires appropriate updating the values on scroll.\n   * @param {number=} unusedScrollTop Same comment as above.\n   * @return {!../../layout-rect.LayoutRectDef}\n   */\n  getLayoutRect(unusedEl, unusedScrollLeft, unusedScrollTop) {}\n\n  /**\n   * Returns the client rect of the current window.\n   * @return {Promise<null>|Promise<!../../layout-rect.LayoutRectDef>}\n   */\n  getRootClientRectAsync() {}\n\n  /**\n   * Returns the element considered the root scroller for this binding.\n   * @return {!Element}\n   */\n  getScrollingElement() {}\n\n  /**\n   * Whether the root scroller is a native root scroller (behaves like a\n   * viewport), or an overflow scroller (scrolls like an element).\n   * @return {boolean}\n   */\n  getScrollingElementScrollsLikeViewport() {}\n}\n\n/**\n * Returns the margin-bottom of the last child of `element` that affects\n * document height (is static/relative position with non-zero height),\n * if any. Otherwise, returns 0.\n *\n * TODO(choumx): This is a weird location, so refactor to improve code sharing\n * among implementations of ViewportBindingDef generally.\n *\n * @param {!Window} win\n * @param {!Element} element\n * @return {number}\n */\nexport function marginBottomOfLastChild(win, element) {\n  let style;\n  for (let n = element.lastElementChild; n; n = n.previousElementSibling) {\n    const r = n./*OK*/ getBoundingClientRect();\n    if (r.height > 0) {\n      const s = computedStyle(win, n);\n      if (s.position == 'static' || s.position == 'relative') {\n        style = s;\n        break;\n      }\n    }\n  }\n  return style ? parseInt(style.marginBottom, 10) : 0;\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from '../../observable';\nimport {Services} from '../../services';\nimport {\n  ViewportBindingDef,\n  marginBottomOfLastChild,\n} from './viewport-binding-def';\nimport {computedStyle, px, setImportantStyles} from '../../style';\nimport {dev} from '../../log';\nimport {isExperimentOn} from '../../experiments';\nimport {layoutRectLtwh} from '../../layout-rect';\nimport {waitForBodyOpen} from '../../dom';\nimport {whenDocumentReady} from '../../document-ready';\n\nconst TAG_ = 'Viewport';\n\n/**\n * Implementation of ViewportBindingDef based for iframed iOS case where iframes\n * are not scrollable. Scrolling accomplished here by inserting a scrollable\n * wrapper `<html id=\"i-amphtml-wrapper\">` inside the `<html>` element and\n * reparenting the original `<body>` inside.\n *\n * @implements {ViewportBindingDef}\n * @visibleForTesting\n */\nexport class ViewportBindingIosEmbedWrapper_ {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @protected {!../vsync-impl.Vsync} */\n    this.vsync_ = Services.vsyncFor(win);\n\n    const doc = this.win.document;\n    const {documentElement} = doc;\n    const topClasses = documentElement.className;\n    documentElement.classList.add('i-amphtml-ios-embed');\n\n    const wrapper = doc.createElement('html');\n    /** @private @const {!Element} */\n    this.wrapper_ = wrapper;\n    wrapper.id = 'i-amphtml-wrapper';\n    wrapper.className = topClasses;\n\n    /** @private @const {!Observable} */\n    this.scrollObservable_ = new Observable();\n\n    /** @private @const {!Observable} */\n    this.resizeObservable_ = new Observable();\n\n    /** @const {function()} */\n    this.boundScrollEventListener_ = this.onScrolled_.bind(this);\n\n    // eslint-disable-next-line jsdoc/require-returns\n    /** @const {function()} */\n    this.boundResizeEventListener_ = () => this.resizeObservable_.fire();\n\n    /** @private {number} */\n    this.paddingTop_ = 0;\n\n    // Setup UI.\n    /** @private {boolean} */\n    this.setupDone_ = false;\n    waitForBodyOpen(doc, this.setup_.bind(this));\n\n    // Set overscroll (`-webkit-overflow-scrolling: touch`) later to avoid\n    // iOS rendering bugs. See #8798 for details.\n    whenDocumentReady(doc).then(() => {\n      documentElement.classList.add('i-amphtml-ios-overscroll');\n    });\n\n    dev().fine(TAG_, 'initialized ios-embed-wrapper viewport');\n  }\n\n  /** @override */\n  ensureReadyForElements() {\n    this.setup_();\n  }\n\n  /** @private */\n  setup_() {\n    if (this.setupDone_) {\n      return;\n    }\n    this.setupDone_ = true;\n\n    // Embedded scrolling on iOS is rather complicated. IFrames cannot be sized\n    // and be scrollable. Sizing iframe by scrolling height has a big negative\n    // that \"fixed\" position is essentially impossible. The only option we\n    // found is to reset scrolling on the AMP doc, which wraps the natural BODY\n    // inside the `overflow:auto` element. For reference, here are related\n    // iOS issues (Chrome issues are also listed for reference):\n    // - https://code.google.com/p/chromium/issues/detail?id=2891\n    // - https://code.google.com/p/chromium/issues/detail?id=157855\n    // - https://bugs.webkit.org/show_bug.cgi?id=106133\n    // - https://bugs.webkit.org/show_bug.cgi?id=149264\n    const doc = this.win.document;\n    const body = dev().assertElement(doc.body, 'body is not available');\n    doc.documentElement.appendChild(this.wrapper_);\n    this.wrapper_.appendChild(body);\n    // Redefine `document.body`, otherwise it'd be `null`.\n    Object.defineProperty(doc, 'body', {\n      get: () => body,\n    });\n\n    // Make sure the scroll position is adjusted correctly.\n    this.onScrolled_();\n  }\n\n  /** @override */\n  connect() {\n    this.win.addEventListener('resize', this.boundResizeEventListener_);\n    this.wrapper_.addEventListener('scroll', this.boundScrollEventListener_);\n  }\n\n  /** @override */\n  disconnect() {\n    this.win.removeEventListener('resize', this.boundResizeEventListener_);\n    this.wrapper_.removeEventListener('scroll', this.boundScrollEventListener_);\n  }\n\n  /** @override */\n  getBorderTop() {\n    // iOS needs an extra pixel to avoid scroll freezing.\n    return 1;\n  }\n\n  /** @override */\n  requiresFixedLayerTransfer() {\n    if (!isExperimentOn(this.win, 'ios-fixed-no-transfer')) {\n      return true;\n    }\n    // The jumping fixed elements have been fixed in iOS 12.2.\n    const iosVersion = parseFloat(\n      Services.platformFor(this.win).getIosVersionString()\n    );\n    return iosVersion < 12.2;\n  }\n\n  /** @override */\n  overrideGlobalScrollTo() {\n    return true;\n  }\n\n  /** @override */\n  supportsPositionFixed() {\n    return true;\n  }\n\n  /** @override */\n  onScroll(callback) {\n    this.scrollObservable_.add(callback);\n  }\n\n  /** @override */\n  onResize(callback) {\n    this.resizeObservable_.add(callback);\n  }\n\n  /** @override */\n  updatePaddingTop(paddingTop) {\n    this.paddingTop_ = paddingTop;\n    setImportantStyles(this.wrapper_, {\n      'padding-top': px(paddingTop),\n    });\n  }\n\n  /** @override */\n  hideViewerHeader(transient, unusedLastPaddingTop) {\n    if (!transient) {\n      this.updatePaddingTop(0);\n    }\n  }\n\n  /** @override */\n  showViewerHeader(transient, paddingTop) {\n    if (!transient) {\n      this.updatePaddingTop(paddingTop);\n    }\n  }\n\n  /** @override */\n  disableScroll() {\n    // TODO(jridgewell): Recursively disable scroll\n    this.wrapper_.classList.add('i-amphtml-scroll-disabled');\n  }\n\n  /** @override */\n  resetScroll() {\n    // TODO(jridgewell): Recursively disable scroll\n    this.wrapper_.classList.remove('i-amphtml-scroll-disabled');\n  }\n\n  /** @override */\n  updateLightboxMode(unusedLightboxMode) {\n    // The layout is always accurate.\n    return Promise.resolve();\n  }\n\n  /** @override */\n  getSize() {\n    return {\n      width: this.win./*OK*/ innerWidth,\n      height: this.win./*OK*/ innerHeight,\n    };\n  }\n\n  /** @override */\n  getScrollTop() {\n    return this.wrapper_./*OK*/ scrollTop;\n  }\n\n  /** @override */\n  getScrollLeft() {\n    // The wrapper is set to overflow-x: hidden so the document cannot be\n    // scrolled horizontally. The scrollLeft will always be 0.\n    return 0;\n  }\n\n  /** @override */\n  getScrollWidth() {\n    return this.wrapper_./*OK*/ scrollWidth;\n  }\n\n  /** @override */\n  getScrollHeight() {\n    return this.wrapper_./*OK*/ scrollHeight;\n  }\n\n  /** @override */\n  getContentHeight() {\n    // The wrapped body, not this.wrapper_ itself, will have the correct height.\n    const content = this.win.document.body;\n    const {height} = content./*OK*/ getBoundingClientRect();\n\n    // Unlike other viewport bindings, there's no need to include the\n    // rect top since the wrapped body accounts for the top margin of children.\n    // However, the parent's padding-top (this.paddingTop_) must be added.\n\n    // As of Safari 12.1.1, the getBoundingClientRect().height does not include\n    // the bottom margin of children and there's no other API that does.\n    const childMarginBottom = marginBottomOfLastChild(this.win, content);\n\n    const style = computedStyle(this.win, content);\n    return (\n      parseInt(style.marginTop, 10) +\n      this.paddingTop_ +\n      height +\n      childMarginBottom +\n      parseInt(style.marginBottom, 10)\n    );\n  }\n\n  /** @override */\n  contentHeightChanged() {}\n\n  /** @override */\n  getLayoutRect(el, opt_scrollLeft, opt_scrollTop) {\n    const b = el./*OK*/ getBoundingClientRect();\n    const scrollTop =\n      opt_scrollTop != undefined ? opt_scrollTop : this.getScrollTop();\n    const scrollLeft =\n      opt_scrollLeft != undefined ? opt_scrollLeft : this.getScrollLeft();\n    return layoutRectLtwh(\n      Math.round(b.left + scrollLeft),\n      Math.round(b.top + scrollTop),\n      Math.round(b.width),\n      Math.round(b.height)\n    );\n  }\n\n  /** @override */\n  getRootClientRectAsync() {\n    return Promise.resolve(null);\n  }\n\n  /** @override */\n  setScrollTop(scrollTop) {\n    // If scroll top is 0, it's set to 1 to avoid scroll-freeze issue. See\n    // `onScrolled_` for more details.\n    this.wrapper_./*OK*/ scrollTop = scrollTop || 1;\n  }\n\n  /**\n   * @param {!Event=} opt_event\n   * @private\n   */\n  onScrolled_(opt_event) {\n    // Scroll document into a safe position to avoid scroll freeze on iOS.\n    // This means avoiding scrollTop to be minimum (0) or maximum value.\n    // This is very sad but very necessary. See #330 for more details.\n    // Unfortunately, the same is very expensive to do on the bottom, due to\n    // costly scrollHeight.\n    if (this.wrapper_./*OK*/ scrollTop == 0) {\n      this.wrapper_./*OK*/ scrollTop = 1;\n      if (opt_event) {\n        opt_event.preventDefault();\n      }\n    }\n    if (opt_event) {\n      this.scrollObservable_.fire();\n    }\n  }\n\n  /** @override */\n  getScrollingElement() {\n    return this.wrapper_;\n  }\n\n  /** @override */\n  getScrollingElementScrollsLikeViewport() {\n    return false;\n  }\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Observable} from '../../observable';\nimport {Services} from '../../services';\nimport {\n  ViewportBindingDef,\n  marginBottomOfLastChild,\n} from './viewport-binding-def';\nimport {computedStyle, px, setImportantStyles} from '../../style';\nimport {dev} from '../../log';\nimport {layoutRectLtwh} from '../../layout-rect';\n\nconst TAG_ = 'Viewport';\n\n/**\n * Implementation of ViewportBindingDef based on the native window. It assumes\n * that the native window is sized properly and events represent the actual\n * scroll/resize events. This mode is applicable to a standalone document\n * display or when an iframe has a fixed size.\n *\n * Visible for testing.\n *\n * @implements {ViewportBindingDef}\n */\nexport class ViewportBindingNatural_ {\n  /**\n   * @param {!../ampdoc-impl.AmpDoc} ampdoc\n   */\n  constructor(ampdoc) {\n    /** @const {!../ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /** @const {!Window} */\n    this.win = ampdoc.win;\n\n    /** @const {!../../service/platform-impl.Platform} */\n    this.platform_ = Services.platformFor(this.win);\n\n    /** @private @const {!Observable} */\n    this.scrollObservable_ = new Observable();\n\n    /** @private @const {!Observable} */\n    this.resizeObservable_ = new Observable();\n\n    /**\n     * See `handleScrollEvent_` for details.\n     * @private @const {boolean}\n     */\n    this.resetScrollX_ = this.platform_.isIos() && this.win.parent !== this.win;\n\n    /** @const {function()} */\n    this.boundScrollEventListener_ = this.handleScrollEvent_.bind(this);\n\n    // eslint-disable-next-line jsdoc/require-returns\n    /** @const {function()} */\n    this.boundResizeEventListener_ = () => this.resizeObservable_.fire();\n\n    dev().fine(TAG_, 'initialized natural viewport');\n  }\n\n  /** @private */\n  handleScrollEvent_() {\n    if (\n      this.resetScrollX_ &&\n      this.getScrollingElement()./*OK*/ scrollLeft > 0\n    ) {\n      // In the iframed iOS Safari case the `touch-action` and\n      // `overscroll-behavior` are not observed which leads to the overscroll\n      // bugs on the horizontal axis. The solution is to reset the horizontal\n      // scrolling in this case. See b/140131460 for more details.\n      this.getScrollingElement()./*OK*/ scrollLeft = 0;\n    }\n    this.scrollObservable_.fire();\n  }\n\n  /** @override */\n  connect() {\n    this.win.addEventListener('scroll', this.boundScrollEventListener_);\n    this.win.addEventListener('resize', this.boundResizeEventListener_);\n  }\n\n  /** @override */\n  disconnect() {\n    this.win.removeEventListener('scroll', this.boundScrollEventListener_);\n    this.win.removeEventListener('resize', this.boundResizeEventListener_);\n  }\n\n  /** @override */\n  ensureReadyForElements() {\n    // Nothing.\n  }\n\n  /** @override */\n  getBorderTop() {\n    return 0;\n  }\n\n  /** @override */\n  requiresFixedLayerTransfer() {\n    return false;\n  }\n\n  /** @override */\n  overrideGlobalScrollTo() {\n    return false;\n  }\n\n  /** @override */\n  supportsPositionFixed() {\n    return true;\n  }\n\n  /** @override */\n  onScroll(callback) {\n    this.scrollObservable_.add(callback);\n  }\n\n  /** @override */\n  onResize(callback) {\n    this.resizeObservable_.add(callback);\n  }\n\n  /** @override */\n  updatePaddingTop(paddingTop) {\n    setImportantStyles(this.win.document.documentElement, {\n      'padding-top': px(paddingTop),\n    });\n  }\n\n  /** @override */\n  hideViewerHeader(transient, unusedLastPaddingTop) {\n    if (!transient) {\n      this.updatePaddingTop(0);\n    }\n  }\n\n  /** @override */\n  showViewerHeader(transient, paddingTop) {\n    if (!transient) {\n      this.updatePaddingTop(paddingTop);\n    }\n  }\n\n  /** @override */\n  disableScroll() {\n    // TODO(jridgewell): Recursively disable scroll\n    this.win.document.documentElement.classList.add(\n      'i-amphtml-scroll-disabled'\n    );\n  }\n\n  /** @override */\n  resetScroll() {\n    // TODO(jridgewell): Recursively disable scroll\n    this.win.document.documentElement.classList.remove(\n      'i-amphtml-scroll-disabled'\n    );\n  }\n\n  /** @override */\n  updateLightboxMode(unusedLightboxMode) {\n    // The layout is always accurate.\n    return Promise.resolve();\n  }\n\n  /** @override */\n  getSize() {\n    // Prefer window innerWidth/innerHeight but fall back to\n    // documentElement clientWidth/clientHeight.\n    // documentElement./*OK*/clientHeight is buggy on iOS Safari\n    // and thus cannot be used.\n    const winWidth = this.win./*OK*/ innerWidth;\n    const winHeight = this.win./*OK*/ innerHeight;\n    if (winWidth && winHeight) {\n      return {width: winWidth, height: winHeight};\n    }\n    const el = this.win.document.documentElement;\n    return {width: el./*OK*/ clientWidth, height: el./*OK*/ clientHeight};\n  }\n\n  /** @override */\n  getScrollTop() {\n    const pageScrollTop =\n      this.getScrollingElement()./*OK*/ scrollTop ||\n      this.win./*OK*/ pageYOffset;\n    const {host} = this.ampdoc.getRootNode();\n    return host ? pageScrollTop - host./*OK*/ offsetTop : pageScrollTop;\n  }\n\n  /** @override */\n  getScrollLeft() {\n    // The html is set to overflow-x: hidden so the document cannot be\n    // scrolled horizontally. The scrollLeft will always be 0.\n    return 0;\n  }\n\n  /** @override */\n  getScrollWidth() {\n    return this.getScrollingElement()./*OK*/ scrollWidth;\n  }\n\n  /** @override */\n  getScrollHeight() {\n    return this.getScrollingElement()./*OK*/ scrollHeight;\n  }\n\n  /** @override */\n  getContentHeight() {\n    // Don't use scrollHeight, since it returns `MAX(viewport_height,\n    // document_height)` (we only want the latter), and it doesn't account\n    // for margins. Also, don't use documentElement's rect height because\n    // there's no workable analog for either ios-embed-* modes.\n    const content = this.getScrollingElement();\n    const rect = content./*OK*/ getBoundingClientRect();\n\n    // The Y-position of `content` can be offset by the vertical margin\n    // of its first child, and this is _not_ accounted for in `rect.height`.\n    // This causes smaller than expected content height, so add it manually.\n    // Note this \"top\" value already includes padding-top of ancestor elements\n    // and getBorderTop().\n    const top = rect.top + this.getScrollTop();\n\n    // As of Safari 12.1.1, the getBoundingClientRect().height does not include\n    // the bottom margin of children and there's no other API that does.\n    const childMarginBottom = Services.platformFor(this.win).isSafari()\n      ? marginBottomOfLastChild(this.win, content)\n      : 0;\n\n    const style = computedStyle(this.win, content);\n    return (\n      top +\n      parseInt(style.marginTop, 10) +\n      rect.height +\n      childMarginBottom +\n      parseInt(style.marginBottom, 10)\n    );\n  }\n\n  /** @override */\n  contentHeightChanged() {\n    // Nothing to do here.\n  }\n\n  /** @override */\n  getLayoutRect(el, opt_scrollLeft, opt_scrollTop) {\n    const b = el./*OK*/ getBoundingClientRect();\n    const scrollTop =\n      opt_scrollTop != undefined ? opt_scrollTop : this.getScrollTop();\n    const scrollLeft =\n      opt_scrollLeft != undefined ? opt_scrollLeft : this.getScrollLeft();\n    return layoutRectLtwh(\n      Math.round(b.left + scrollLeft),\n      Math.round(b.top + scrollTop),\n      Math.round(b.width),\n      Math.round(b.height)\n    );\n  }\n\n  /** @override */\n  getRootClientRectAsync() {\n    return Promise.resolve(null);\n  }\n\n  /** @override */\n  setScrollTop(scrollTop) {\n    this.getScrollingElement()./*OK*/ scrollTop = scrollTop;\n  }\n\n  /** @override */\n  getScrollingElement() {\n    const doc = this.win.document;\n    if (doc./*OK*/ scrollingElement) {\n      return doc./*OK*/ scrollingElement;\n    }\n    if (\n      doc.body &&\n      // Due to https://bugs.webkit.org/show_bug.cgi?id=106133, WebKit\n      // browsers have to use `body` and NOT `documentElement` for\n      // scrolling purposes. This has mostly being resolved via\n      // `scrollingElement` property, but this branch is still necessary\n      // for backward compatibility purposes.\n      this.platform_.isWebKit()\n    ) {\n      return doc.body;\n    }\n    return doc.documentElement;\n  }\n\n  /** @override */\n  getScrollingElementScrollsLikeViewport() {\n    return true;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Animation} from '../../animation';\nimport {FixedLayer} from './../fixed-layer';\nimport {Observable} from '../../observable';\nimport {Services} from '../../services';\nimport {ViewportBindingDef} from './viewport-binding-def';\nimport {ViewportBindingIosEmbedWrapper_} from './viewport-binding-ios-embed-wrapper';\nimport {ViewportBindingNatural_} from './viewport-binding-natural';\nimport {ViewportInterface} from './viewport-interface';\nimport {VisibilityState} from '../../visibility-state';\nimport {clamp} from '../../utils/math';\nimport {\n  closestAncestorElementBySelector,\n  getVerticalScrollbarWidth,\n  isIframed,\n} from '../../dom';\nimport {computedStyle, setStyle} from '../../style';\nimport {dev, devAssert} from '../../log';\nimport {dict} from '../../utils/object';\nimport {getFriendlyIframeEmbedOptional} from '../../iframe-helper';\nimport {getMode} from '../../mode';\nimport {\n  getParentWindowFrameElement,\n  registerServiceBuilderForDoc,\n} from '../../service';\nimport {isExperimentOn} from '../../experiments';\nimport {\n  layoutRectFromDomRect,\n  layoutRectLtwh,\n  moveLayoutRect,\n} from '../../layout-rect';\nimport {numeric} from '../../transition';\nimport {tryResolve} from '../../utils/promise';\n\nconst TAG_ = 'Viewport';\n\n/**\n * This object represents the viewport. It tracks scroll position, resize\n * and other events and notifies interesting parties when viewport has changed\n * and how.\n *\n * @implements {ViewportInterface}\n */\nexport class ViewportImpl {\n  /**\n   * @param {!../ampdoc-impl.AmpDoc} ampdoc\n   * @param {!ViewportBindingDef} binding\n   * @param {!../viewer-interface.ViewerInterface} viewer\n   */\n  constructor(ampdoc, binding, viewer) {\n    const {win} = ampdoc;\n\n    /** @const {!../ampdoc-impl.AmpDoc} */\n    this.ampdoc = ampdoc;\n\n    /**\n     * Some viewport operations require the global document.\n     * @private @const {!Document}\n     */\n    this.globalDoc_ = this.ampdoc.win.document;\n\n    /** @const {!ViewportBindingDef} */\n    this.binding_ = binding;\n\n    /** @const {!../viewer-interface.ViewerInterface} */\n    this.viewer_ = viewer;\n\n    /**\n     * Used to cache the rect of the viewport.\n     * @private {?../../layout-rect.LayoutRectDef}\n     */\n    this.rect_ = null;\n\n    /**\n     * Used to cache the size of the viewport. Also used as last known size,\n     * so users should call getSize early on to get a value. The timing should\n     * be chosen to avoid extra style recalcs.\n     * @private {{width: number, height: number}|null}\n     */\n    this.size_ = null;\n\n    /** @private {?number} */\n    this./*OK*/ scrollTop_ = null;\n\n    /** @private {boolean} */\n    this.scrollAnimationFrameThrottled_ = false;\n\n    /** @private {?number} */\n    this./*OK*/ scrollLeft_ = null;\n\n    /** @private {number} */\n    this.paddingTop_ = Number(viewer.getParam('paddingTop') || 0);\n\n    /** @private {number} */\n    this.lastPaddingTop_ = 0;\n\n    /** @private {!../timer-impl.Timer} */\n    this.timer_ = Services.timerFor(win);\n\n    /** @private {!../vsync-impl.Vsync} */\n    this.vsync_ = Services.vsyncFor(win);\n\n    /** @private {boolean} */\n    this.scrollTracking_ = false;\n\n    /** @private {number} */\n    this.scrollCount_ = 0;\n\n    /** @private @const {!Observable<!./viewport-interface.ViewportChangedEventDef>} */\n    this.changeObservable_ = new Observable();\n\n    /** @private @const {!Observable} */\n    this.scrollObservable_ = new Observable();\n\n    /** @private @const {!Observable<!./viewport-interface.ViewportResizedEventDef>} */\n    this.resizeObservable_ = new Observable();\n\n    /** @private {?Element|undefined} */\n    this.viewportMeta_ = undefined;\n\n    /** @private {string|undefined} */\n    this.originalViewportMetaString_ = undefined;\n\n    /** @private @const {!FixedLayer} */\n    this.fixedLayer_ = new FixedLayer(\n      ampdoc,\n      this.vsync_,\n      this.binding_.getBorderTop(),\n      this.paddingTop_,\n      this.binding_.requiresFixedLayerTransfer()\n    );\n    ampdoc.whenReady().then(() => this.fixedLayer_.setup());\n\n    this.viewer_.onMessage('viewport', this.updateOnViewportEvent_.bind(this));\n    this.viewer_.onMessage('scroll', this.viewerSetScrollTop_.bind(this));\n    this.viewer_.onMessage(\n      'disableScroll',\n      this.disableScrollEventHandler_.bind(this)\n    );\n    this.binding_.updatePaddingTop(this.paddingTop_);\n\n    this.binding_.onScroll(this.scroll_.bind(this));\n    this.binding_.onResize(this.resize_.bind(this));\n\n    this.onScroll(this.sendScrollMessage_.bind(this));\n\n    /** @private {boolean} */\n    this.visible_ = false;\n    this.ampdoc.onVisibilityChanged(this.updateVisibility_.bind(this));\n    this.updateVisibility_();\n\n    // Top-level mode classes.\n    const globalDocElement = this.globalDoc_.documentElement;\n    if (ampdoc.isSingleDoc()) {\n      globalDocElement.classList.add('i-amphtml-singledoc');\n    }\n    if (viewer.isEmbedded()) {\n      globalDocElement.classList.add('i-amphtml-embedded');\n    } else {\n      globalDocElement.classList.add('i-amphtml-standalone');\n    }\n    if (isIframed(win)) {\n      globalDocElement.classList.add('i-amphtml-iframed');\n    }\n    if (viewer.getParam('webview') === '1') {\n      globalDocElement.classList.add('i-amphtml-webview');\n    }\n\n    // To avoid browser restore scroll position when traverse history\n    if (isIframed(win) && 'scrollRestoration' in win.history) {\n      win.history.scrollRestoration = 'manual';\n    }\n\n    // Override global scrollTo if requested.\n    if (this.binding_.overrideGlobalScrollTo()) {\n      try {\n        Object.defineProperty(win, 'scrollTo', {\n          value: (x, y) => this.setScrollTop(y),\n        });\n        ['pageYOffset', 'scrollY'].forEach(prop => {\n          Object.defineProperty(win, prop, {\n            get: () => this.getScrollTop(),\n          });\n        });\n      } catch (e) {\n        // Ignore errors.\n      }\n    }\n  }\n\n  /** @override */\n  dispose() {\n    this.binding_.disconnect();\n  }\n\n  /** @override */\n  ensureReadyForElements() {\n    this.binding_.ensureReadyForElements();\n  }\n\n  /** @private */\n  updateVisibility_() {\n    const visible = this.ampdoc.isVisible();\n    if (visible != this.visible_) {\n      this.visible_ = visible;\n      if (visible) {\n        this.binding_.connect();\n        if (this.size_) {\n          // If the size has already been intialized, check it again in case\n          // the size has changed between `disconnect` and `connect`.\n          this.resize_();\n        }\n      } else {\n        this.binding_.disconnect();\n      }\n    }\n  }\n\n  /** @override */\n  getPaddingTop() {\n    return this.paddingTop_;\n  }\n\n  /** @override */\n  getScrollTop() {\n    if (this./*OK*/ scrollTop_ == null) {\n      this./*OK*/ scrollTop_ = this.binding_.getScrollTop();\n    }\n    return this./*OK*/ scrollTop_;\n  }\n\n  /** @override */\n  getScrollLeft() {\n    if (this./*OK*/ scrollLeft_ == null) {\n      this./*OK*/ scrollLeft_ = this.binding_.getScrollLeft();\n    }\n    return this./*OK*/ scrollLeft_;\n  }\n\n  /** @override */\n  setScrollTop(scrollPos) {\n    this./*OK*/ scrollTop_ = null;\n    this.binding_.setScrollTop(scrollPos);\n  }\n\n  /** @override */\n  updatePaddingBottom(paddingBottom) {\n    this.ampdoc.waitForBodyOpen().then(body => {\n      setStyle(body, 'borderBottom', `${paddingBottom}px solid transparent`);\n    });\n  }\n\n  /** @override */\n  getSize() {\n    if (this.size_) {\n      return this.size_;\n    }\n    this.size_ = this.binding_.getSize();\n    if (this.size_.width == 0 || this.size_.height == 0) {\n      // Only report when the visibility is \"visible\" or \"prerender\".\n      const visibilityState = this.ampdoc.getVisibilityState();\n      if (\n        visibilityState == VisibilityState.PRERENDER ||\n        visibilityState == VisibilityState.VISIBLE\n      ) {\n        if (Math.random() < 0.01) {\n          dev().error(TAG_, 'viewport has zero dimensions');\n        }\n      }\n    }\n    return this.size_;\n  }\n\n  /** @override */\n  getHeight() {\n    return this.getSize().height;\n  }\n\n  /** @override */\n  getWidth() {\n    return this.getSize().width;\n  }\n\n  /** @override */\n  getScrollWidth() {\n    return this.binding_.getScrollWidth();\n  }\n\n  /** @override */\n  getScrollHeight() {\n    return this.binding_.getScrollHeight();\n  }\n\n  /** @override */\n  getContentHeight() {\n    return this.binding_.getContentHeight();\n  }\n\n  /** @override */\n  contentHeightChanged() {\n    this.binding_.contentHeightChanged();\n  }\n\n  /** @override */\n  getRect() {\n    if (this.rect_ == null) {\n      const scrollTop = this.getScrollTop();\n      const scrollLeft = this.getScrollLeft();\n      const size = this.getSize();\n      this.rect_ = layoutRectLtwh(\n        scrollLeft,\n        scrollTop,\n        size.width,\n        size.height\n      );\n    }\n    return this.rect_;\n  }\n\n  /** @override */\n  getLayoutRect(el) {\n    const scrollLeft = this.getScrollLeft();\n    const scrollTop = this.getScrollTop();\n\n    // Go up the window hierarchy through friendly iframes.\n    const frameElement = getParentWindowFrameElement(el, this.ampdoc.win);\n    if (frameElement) {\n      const b = this.binding_.getLayoutRect(el, 0, 0);\n      const c = this.binding_.getLayoutRect(\n        frameElement,\n        scrollLeft,\n        scrollTop\n      );\n      return layoutRectLtwh(\n        Math.round(b.left + c.left),\n        Math.round(b.top + c.top),\n        Math.round(b.width),\n        Math.round(b.height)\n      );\n    }\n\n    return this.binding_.getLayoutRect(el, scrollLeft, scrollTop);\n  }\n\n  /** @override */\n  getClientRectAsync(el) {\n    const local = this.vsync_.measurePromise(() => {\n      return el./*OK*/ getBoundingClientRect();\n    });\n\n    let root = this.binding_.getRootClientRectAsync();\n    const frameElement = getParentWindowFrameElement(el, this.ampdoc.win);\n    if (frameElement) {\n      root = this.vsync_.measurePromise(() => {\n        return frameElement./*OK*/ getBoundingClientRect();\n      });\n    }\n\n    return Promise.all([local, root]).then(values => {\n      const l = values[0];\n      const r = values[1];\n      if (!r) {\n        return layoutRectFromDomRect(l);\n      }\n      return moveLayoutRect(l, r.left, r.top);\n    });\n  }\n\n  /** @override */\n  supportsPositionFixed() {\n    return this.binding_.supportsPositionFixed();\n  }\n\n  /** @override */\n  isDeclaredFixed(element) {\n    return this.fixedLayer_.isDeclaredFixed(element);\n  }\n\n  /** @override */\n  scrollIntoView(element) {\n    return this.getScrollingContainerFor_(element).then(parent =>\n      this.scrollIntoViewInternal_(element, parent)\n    );\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {!Element} parent\n   */\n  scrollIntoViewInternal_(element, parent) {\n    const elementTop = this.binding_.getLayoutRect(element).top;\n    const newScrollTopPromise = tryResolve(() =>\n      Math.max(0, elementTop - this.paddingTop_)\n    );\n\n    newScrollTopPromise.then(newScrollTop =>\n      this.setElementScrollTop_(parent, newScrollTop)\n    );\n  }\n\n  /** @override */\n  animateScrollIntoView(element, pos = 'top', opt_duration, opt_curve) {\n    devAssert(\n      !opt_curve || opt_duration !== undefined,\n      \"Curve without duration doesn't make sense.\"\n    );\n\n    return this.getScrollingContainerFor_(element).then(parent =>\n      this.animateScrollWithinParent(\n        element,\n        parent,\n        dev().assertString(pos),\n        opt_duration,\n        opt_curve\n      )\n    );\n  }\n\n  /** @override */\n  animateScrollWithinParent(element, parent, pos, opt_duration, opt_curve) {\n    devAssert(\n      !opt_curve || opt_duration !== undefined,\n      \"Curve without duration doesn't make sense.\"\n    );\n\n    const elementRect = this.binding_.getLayoutRect(element);\n\n    const {height: parentHeight} = this.isScrollingElement_(parent)\n      ? this.getSize()\n      : this.getLayoutRect(parent);\n\n    let offset;\n    switch (pos) {\n      case 'bottom':\n        offset = -parentHeight + elementRect.height;\n        break;\n      case 'center':\n        offset = -parentHeight / 2 + elementRect.height / 2;\n        break;\n      default:\n        offset = 0;\n        break;\n    }\n\n    return this.getElementScrollTop_(parent).then(curScrollTop => {\n      const calculatedScrollTop = elementRect.top - this.paddingTop_ + offset;\n      const newScrollTop = Math.max(0, calculatedScrollTop);\n      if (newScrollTop == curScrollTop) {\n        return;\n      }\n      return this.interpolateScrollIntoView_(\n        parent,\n        curScrollTop,\n        newScrollTop,\n        opt_duration,\n        opt_curve\n      );\n    });\n  }\n\n  /**\n   * @param {!Element} parent\n   * @param {number} curScrollTop\n   * @param {number} newScrollTop\n   * @param {number=} opt_duration\n   * @param {string=} curve\n   * @private\n   */\n  interpolateScrollIntoView_(\n    parent,\n    curScrollTop,\n    newScrollTop,\n    opt_duration,\n    curve = 'ease-in'\n  ) {\n    const duration =\n      opt_duration !== undefined\n        ? dev().assertNumber(opt_duration)\n        : getDefaultScrollAnimationDuration(curScrollTop, newScrollTop);\n\n    /** @const {!TransitionDef<number>} */\n    const interpolate = numeric(curScrollTop, newScrollTop);\n    return Animation.animate(\n      parent,\n      position => {\n        this.setElementScrollTop_(parent, interpolate(position));\n      },\n      duration,\n      curve\n    ).thenAlways(() => {\n      this.setElementScrollTop_(parent, newScrollTop);\n    });\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {!Promise<!Element>}\n   */\n  getScrollingContainerFor_(element) {\n    return this.vsync_.measurePromise(\n      () =>\n        closestAncestorElementBySelector(element, '.i-amphtml-scrollable') ||\n        this.binding_.getScrollingElement()\n    );\n  }\n\n  /**\n   * @param {!Element} element\n   * @param {number} scrollTop\n   */\n  setElementScrollTop_(element, scrollTop) {\n    if (this.isScrollingElement_(element)) {\n      this.binding_.setScrollTop(scrollTop);\n      return;\n    }\n    this.vsync_.mutate(() => {\n      element./*OK*/ scrollTop = scrollTop;\n    });\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {!Promise<number>}\n   */\n  getElementScrollTop_(element) {\n    if (this.isScrollingElement_(element)) {\n      return tryResolve(() => this.getScrollTop());\n    }\n    return this.vsync_.measurePromise(() => element./*OK*/ scrollTop);\n  }\n\n  /**\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  isScrollingElement_(element) {\n    return element == this.binding_.getScrollingElement();\n  }\n\n  /** @override */\n  getScrollingElement() {\n    return this.binding_.getScrollingElement();\n  }\n\n  /** @override */\n  onChanged(handler) {\n    return this.changeObservable_.add(handler);\n  }\n\n  /** @override */\n  onScroll(handler) {\n    return this.scrollObservable_.add(handler);\n  }\n\n  /** @override */\n  onResize(handler) {\n    return this.resizeObservable_.add(handler);\n  }\n\n  /** @override */\n  enterLightboxMode(opt_requestingElement, opt_onComplete) {\n    this.viewer_.sendMessage(\n      'requestFullOverlay',\n      dict(),\n      /* cancelUnsent */ true\n    );\n\n    this.enterOverlayMode();\n    this.fixedLayer_.enterLightbox(opt_requestingElement, opt_onComplete);\n\n    if (opt_requestingElement) {\n      this.maybeEnterFieLightboxMode(\n        dev().assertElement(opt_requestingElement)\n      );\n    }\n\n    return this.binding_.updateLightboxMode(true);\n  }\n\n  /** @override */\n  leaveLightboxMode(opt_requestingElement) {\n    this.viewer_.sendMessage(\n      'cancelFullOverlay',\n      dict(),\n      /* cancelUnsent */ true\n    );\n\n    this.fixedLayer_.leaveLightbox();\n    this.leaveOverlayMode();\n\n    if (opt_requestingElement) {\n      this.maybeLeaveFieLightboxMode(\n        dev().assertElement(opt_requestingElement)\n      );\n    }\n\n    return this.binding_.updateLightboxMode(false);\n  }\n\n  /**\n   * @return {boolean}\n   * @visibleForTesting\n   */\n  isLightboxExperimentOn() {\n    return isExperimentOn(this.ampdoc.win, 'amp-lightbox-a4a-proto');\n  }\n\n  /**\n   * Enters frame lightbox mode if under a Friendly Iframe Embed.\n   * @param {!Element} requestingElement\n   * @visibleForTesting\n   */\n  maybeEnterFieLightboxMode(requestingElement) {\n    const fieOptional = this.getFriendlyIframeEmbed_(requestingElement);\n\n    if (fieOptional) {\n      devAssert(\n        this.isLightboxExperimentOn(),\n        'Lightbox mode for A4A is only available when ' +\n          \"'amp-lightbox-a4a-proto' experiment is on\"\n      );\n\n      fieOptional.enterFullOverlayMode();\n    }\n  }\n\n  /**\n   * Leaves frame lightbox mode if under a Friendly Iframe Embed.\n   * @param {!Element} requestingElement\n   * @visibleForTesting\n   */\n  maybeLeaveFieLightboxMode(requestingElement) {\n    const fieOptional = this.getFriendlyIframeEmbed_(requestingElement);\n\n    if (fieOptional) {\n      devAssert(fieOptional).leaveFullOverlayMode();\n    }\n  }\n\n  /**\n   * Get FriendlyIframeEmbed if available.\n   * @param {!Element} element Element supposedly inside the FIE.\n   * @return {?../../friendly-iframe-embed.FriendlyIframeEmbed}\n   * @private\n   */\n  getFriendlyIframeEmbed_(element) {\n    const iframeOptional = getParentWindowFrameElement(\n      element,\n      this.ampdoc.win\n    );\n\n    return (\n      iframeOptional &&\n      getFriendlyIframeEmbedOptional(\n        /** @type {!HTMLIFrameElement} */\n        (dev().assertElement(iframeOptional))\n      )\n    );\n  }\n\n  /** @override */\n  enterOverlayMode() {\n    this.disableTouchZoom();\n    this.disableScroll();\n  }\n\n  /** @override */\n  leaveOverlayMode() {\n    this.resetScroll();\n    this.restoreOriginalTouchZoom();\n  }\n\n  /** @override */\n  disableScroll() {\n    const {win} = this.ampdoc;\n    const {documentElement} = win.document;\n    let requestedMarginRight;\n\n    // Calculate the scrollbar width so we can set it as a right margin. This\n    // is so that we do not cause content to shift when we disable scroll on\n    // platforms that have a width-taking scrollbar.\n    this.vsync_.measure(() => {\n      const existingMargin = computedStyle(win, documentElement).marginRight;\n      const scrollbarWidth = getVerticalScrollbarWidth(this.ampdoc.win);\n\n      requestedMarginRight = parseInt(existingMargin, 10) + scrollbarWidth;\n    });\n\n    this.vsync_.mutate(() => {\n      setStyle(documentElement, 'margin-right', requestedMarginRight, 'px');\n      this.binding_.disableScroll();\n    });\n  }\n\n  /** @override */\n  resetScroll() {\n    const {win} = this.ampdoc;\n    const {documentElement} = win.document;\n\n    this.vsync_.mutate(() => {\n      setStyle(documentElement, 'margin-right', '');\n      this.binding_.resetScroll();\n    });\n  }\n\n  /** @override */\n  resetTouchZoom() {\n    const windowHeight = this.ampdoc.win./*OK*/ innerHeight;\n    const documentHeight = this.globalDoc_.documentElement./*OK*/ clientHeight;\n    if (windowHeight && documentHeight && windowHeight === documentHeight) {\n      // This code only works when scrollbar overlay content and take no space,\n      // which is fine on mobile. For non-mobile devices this code is\n      // irrelevant.\n      return;\n    }\n    if (this.disableTouchZoom()) {\n      this.timer_.delay(() => {\n        this.restoreOriginalTouchZoom();\n      }, 50);\n    }\n  }\n\n  /** @override */\n  disableTouchZoom() {\n    const viewportMeta = this.getViewportMeta_();\n    if (!viewportMeta) {\n      // This should never happen in a valid AMP document, thus shortcircuit.\n      return false;\n    }\n    // Setting maximum-scale=1 and user-scalable=no zooms page back to normal\n    // and prohibit further default zooming.\n    const newValue = updateViewportMetaString(viewportMeta.content, {\n      'maximum-scale': '1',\n      'user-scalable': 'no',\n    });\n    return this.setViewportMetaString_(newValue);\n  }\n\n  /** @override */\n  restoreOriginalTouchZoom() {\n    if (this.originalViewportMetaString_ !== undefined) {\n      return this.setViewportMetaString_(this.originalViewportMetaString_);\n    }\n    return false;\n  }\n\n  /** @override */\n  updateFixedLayer() {\n    this.fixedLayer_.update();\n  }\n\n  /** @override */\n  addToFixedLayer(element, opt_forceTransfer) {\n    return this.fixedLayer_.addElement(element, opt_forceTransfer);\n  }\n\n  /** @override */\n  removeFromFixedLayer(element) {\n    this.fixedLayer_.removeElement(element);\n  }\n\n  /**\n   * Updates touch zoom meta data. Returns `true` if any actual\n   * changes have been done.\n   * @param {string} viewportMetaString\n   * @return {boolean}\n   */\n  setViewportMetaString_(viewportMetaString) {\n    const viewportMeta = this.getViewportMeta_();\n    if (viewportMeta && viewportMeta.content != viewportMetaString) {\n      dev().fine(TAG_, 'changed viewport meta to:', viewportMetaString);\n      viewportMeta.content = viewportMetaString;\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * @return {?Element}\n   * @private\n   */\n  getViewportMeta_() {\n    if (isIframed(this.ampdoc.win)) {\n      // An embedded document does not control its viewport meta tag.\n      return null;\n    }\n    if (this.viewportMeta_ === undefined) {\n      this.viewportMeta_ = /** @type {?HTMLMetaElement} */ (this.globalDoc_.querySelector(\n        'meta[name=viewport]'\n      ));\n      if (this.viewportMeta_) {\n        this.originalViewportMetaString_ = this.viewportMeta_.content;\n      }\n    }\n    return this.viewportMeta_;\n  }\n\n  /**\n   * @param {!JsonObject} data\n   * @private\n   */\n  viewerSetScrollTop_(data) {\n    const targetScrollTop = data['scrollTop'];\n    this.setScrollTop(targetScrollTop);\n  }\n\n  /**\n   * @param {!JsonObject} data\n   * @private\n   */\n  updateOnViewportEvent_(data) {\n    const paddingTop = data['paddingTop'];\n    const duration = data['duration'] || 0;\n    const curve = data['curve'];\n    /** @const {boolean} */\n    const transient = data['transient'];\n\n    if (paddingTop == undefined || paddingTop == this.paddingTop_) {\n      return;\n    }\n\n    this.lastPaddingTop_ = this.paddingTop_;\n    this.paddingTop_ = paddingTop;\n\n    const animPromise = this.animateFixedElements_(duration, curve, transient);\n    if (paddingTop < this.lastPaddingTop_) {\n      this.binding_.hideViewerHeader(transient, this.lastPaddingTop_);\n      return;\n    }\n    animPromise.then(() => {\n      this.binding_.showViewerHeader(transient, paddingTop);\n    });\n  }\n\n  /**\n   * @param {!JsonObject} data\n   * @private\n   */\n  disableScrollEventHandler_(data) {\n    if (!!data) {\n      this.disableScroll();\n    } else {\n      this.resetScroll();\n    }\n  }\n\n  /**\n   * @param {number} duration\n   * @param {string} curve\n   * @param {boolean} transient\n   * @return {!Promise}\n   * @private\n   */\n  animateFixedElements_(duration, curve, transient) {\n    this.fixedLayer_.updatePaddingTop(this.paddingTop_, transient);\n    if (duration <= 0) {\n      return Promise.resolve();\n    }\n    // Add transit effect on position fixed element\n    const tr = numeric(this.lastPaddingTop_ - this.paddingTop_, 0);\n    return Animation.animate(\n      this.ampdoc.getRootNode(),\n      time => {\n        const p = tr(time);\n        this.fixedLayer_.transformMutate(`translateY(${p}px)`);\n      },\n      duration,\n      curve\n    ).thenAlways(() => {\n      this.fixedLayer_.transformMutate(null);\n    });\n  }\n\n  /**\n   * @param {boolean} relayoutAll\n   * @param {number} velocity\n   * @private\n   */\n  changed_(relayoutAll, velocity) {\n    const size = this.getSize();\n    const scrollTop = this.getScrollTop();\n    const scrollLeft = this.getScrollLeft();\n    dev().fine(\n      TAG_,\n      'changed event:',\n      'relayoutAll=',\n      relayoutAll,\n      'top=',\n      scrollTop,\n      'left=',\n      scrollLeft,\n      'bottom=',\n      scrollTop + size.height,\n      'velocity=',\n      velocity\n    );\n    this.changeObservable_.fire({\n      relayoutAll,\n      top: scrollTop,\n      left: scrollLeft,\n      width: size.width,\n      height: size.height,\n      velocity,\n    });\n  }\n\n  /** @private */\n  scroll_() {\n    this.rect_ = null;\n    this.scrollCount_++;\n    this.scrollLeft_ = this.binding_.getScrollLeft();\n    const newScrollTop = this.binding_.getScrollTop();\n    if (newScrollTop < 0) {\n      // iOS and some other browsers use negative values of scrollTop for\n      // overscroll. Overscroll does not affect the viewport and thus should\n      // be ignored here.\n      return;\n    }\n    this.scrollTop_ = newScrollTop;\n    if (!this.scrollTracking_) {\n      this.scrollTracking_ = true;\n      const now = Date.now();\n      // Wait 2 frames and then request an animation frame.\n      this.timer_.delay(() => {\n        this.vsync_.measure(() => {\n          this.throttledScroll_(now, newScrollTop);\n        });\n      }, 36);\n    }\n    this.scrollObservable_.fire();\n  }\n\n  /**\n   * This method is called about every 3 frames (assuming 60hz) and it\n   * is called in a vsync measure task.\n   * @param {number} referenceTime Time when the scroll measurement, that\n   *     triggered this call made, was made.\n   * @param {number} referenceTop Scrolltop at that time.\n   * @private\n   */\n  throttledScroll_(referenceTime, referenceTop) {\n    this.scrollTop_ = this.binding_.getScrollTop();\n    /**  @const {number} */\n    const newScrollTop = this.scrollTop_;\n    const now = Date.now();\n    let velocity = 0;\n    if (now != referenceTime) {\n      velocity = (newScrollTop - referenceTop) / (now - referenceTime);\n    }\n    dev().fine(\n      TAG_,\n      'scroll: scrollTop=' + newScrollTop + '; velocity=' + velocity\n    );\n    if (Math.abs(velocity) < 0.03) {\n      this.changed_(/* relayoutAll */ false, velocity);\n      this.scrollTracking_ = false;\n    } else {\n      this.timer_.delay(\n        () =>\n          this.vsync_.measure(\n            this.throttledScroll_.bind(this, now, newScrollTop)\n          ),\n        20\n      );\n    }\n  }\n\n  /**\n   * Send scroll message via the viewer per animation frame\n   * @private\n   */\n  sendScrollMessage_() {\n    if (!this.scrollAnimationFrameThrottled_) {\n      this.scrollAnimationFrameThrottled_ = true;\n      this.vsync_.measure(() => {\n        this.scrollAnimationFrameThrottled_ = false;\n        this.viewer_.sendMessage(\n          'scroll',\n          dict({'scrollTop': this.getScrollTop()}),\n          /* cancelUnsent */ true\n        );\n      });\n    }\n  }\n\n  /** @private */\n  resize_() {\n    this.rect_ = null;\n    const oldSize = this.size_;\n    this.size_ = null; // Need to recalc.\n    const newSize = this.getSize();\n    this.fixedLayer_.update().then(() => {\n      const widthChanged = !oldSize || oldSize.width != newSize.width;\n      this.changed_(/*relayoutAll*/ widthChanged, 0);\n      const sizeChanged = widthChanged || oldSize.height != newSize.height;\n      if (sizeChanged) {\n        this.resizeObservable_.fire({\n          relayoutAll: widthChanged,\n          width: newSize.width,\n          height: newSize.height,\n        });\n      }\n    });\n  }\n}\n\n/**\n * Parses viewport meta value. It usually looks like:\n * ```\n * width=device-width,initial-scale=1,minimum-scale=1\n * ```\n * @param {string} content\n * @return {!Object<string, (string|undefined)>}\n * @private Visible for testing only.\n */\nexport function parseViewportMeta(content) {\n  // Ex: width=device-width,initial-scale=1,minimal-ui\n  const params = Object.create(null);\n  if (!content) {\n    return params;\n  }\n  const pairs = content.split(/,|;/);\n  for (let i = 0; i < pairs.length; i++) {\n    const pair = pairs[i];\n    const split = pair.split('=');\n    const name = split[0].trim();\n    let value = split[1];\n    value = (value || '').trim();\n    if (name) {\n      params[name] = value;\n    }\n  }\n  return params;\n}\n\n/**\n * Stringifies viewport meta value based on the provided map. It usually looks\n * like:\n * ```\n * width=device-width,initial-scale=1,minimum-scale=1\n * ```\n * @param {!Object<string, string>} params\n * @return {string}\n * @private Visible for testing only.\n */\nexport function stringifyViewportMeta(params) {\n  // Ex: width=device-width,initial-scale=1,minimal-ui\n  let content = '';\n  for (const k in params) {\n    if (content.length > 0) {\n      content += ',';\n    }\n    if (params[k]) {\n      content += k + '=' + params[k];\n    } else {\n      content += k;\n    }\n  }\n  return content;\n}\n\n/**\n * This method makes a minimal effort to keep the original viewport string\n * unchanged if in fact none of the values have been updated. Returns the\n * updated string or the `currentValue` if no changes were necessary.\n *\n * @param {string} currentValue\n * @param {!Object<string, string|undefined>} updateParams\n * @return {string}\n * @private Visible for testing only.\n */\nexport function updateViewportMetaString(currentValue, updateParams) {\n  const params = parseViewportMeta(currentValue);\n  let changed = false;\n  for (const k in updateParams) {\n    if (params[k] !== updateParams[k]) {\n      changed = true;\n      if (updateParams[k] !== undefined) {\n        params[k] = /** @type {string} */ (updateParams[k]);\n      } else {\n        delete params[k];\n      }\n    }\n  }\n  if (!changed) {\n    return currentValue;\n  }\n  return stringifyViewportMeta(params);\n}\n\n/**\n * Calculates a default duration for a scrollTop animation.\n * @param {number} scrollTopA commutative with b.\n * @param {number} scrollTopB commutative with a.\n * @param {number=} max in ms. default 500ms.\n * @return {number}\n */\nfunction getDefaultScrollAnimationDuration(scrollTopA, scrollTopB, max = 500) {\n  // 65% of scroll  to ms, eg 1000px -> 650ms, integer between 0 and max\n  return Math.floor(clamp(0.65 * Math.abs(scrollTopA - scrollTopB), 0, max));\n}\n\n/**\n * @param {!../ampdoc-impl.AmpDoc} ampdoc\n * @return {!ViewportImpl}\n * @private\n */\nfunction createViewport(ampdoc) {\n  const viewer = Services.viewerForDoc(ampdoc);\n  const {win} = ampdoc;\n  let binding;\n  if (\n    ampdoc.isSingleDoc() &&\n    getViewportType(win, viewer) == ViewportType.NATURAL_IOS_EMBED\n  ) {\n    binding = new ViewportBindingIosEmbedWrapper_(win);\n  } else {\n    binding = new ViewportBindingNatural_(ampdoc);\n  }\n  return new ViewportImpl(ampdoc, binding, viewer);\n}\n\n/**\n * The type of the viewport.\n * @enum {string}\n */\nconst ViewportType = {\n  /**\n   * Viewer leaves sizing and scrolling up to the AMP document's window.\n   */\n  NATURAL: 'natural',\n\n  /**\n   * This is AMP-specific type and doesn't come from viewer. This is the type\n   * that AMP sets when Viewer has requested \"natural\" viewport on a iOS\n   * device.\n   * See:\n   * https://github.com/ampproject/amphtml/blob/master/spec/amp-html-layout.md\n   */\n  NATURAL_IOS_EMBED: 'natural-ios-embed',\n};\n\n/**\n * @param {!Window} win\n * @param {!../viewer-interface.ViewerInterface} viewer\n * @return {string}\n */\nfunction getViewportType(win, viewer) {\n  const viewportType = viewer.getParam('viewportType') || ViewportType.NATURAL;\n  if (\n    !Services.platformFor(win).isIos() ||\n    viewportType != ViewportType.NATURAL\n  ) {\n    return viewportType;\n  }\n  const isIosIframeScrollableOn = isExperimentOn(win, 'ios-scrollable-iframe');\n  // Enable iOS Embedded mode so that it's easy to test against a more\n  // realistic iOS environment w/o an iframe.\n  if (\n    !isIframed(win) &&\n    (getMode(win).localDev || getMode(win).development) &&\n    !isIosIframeScrollableOn\n  ) {\n    return ViewportType.NATURAL_IOS_EMBED;\n  }\n\n  // Enable iOS Embedded mode for iframed tests (e.g. integration tests).\n  if (isIframed(win) && getMode(win).test) {\n    return ViewportType.NATURAL_IOS_EMBED;\n  }\n\n  // Override to ios-embed for iframe-viewer mode.\n  if (isIframed(win) && viewer.isEmbedded() && !isIosIframeScrollableOn) {\n    return ViewportType.NATURAL_IOS_EMBED;\n  }\n  return viewportType;\n}\n\n/**\n * @param {!../ampdoc-impl.AmpDoc} ampdoc\n */\nexport function installViewportServiceForDoc(ampdoc) {\n  registerServiceBuilderForDoc(\n    ampdoc,\n    'viewport',\n    createViewport,\n    /* opt_instantiate */ true\n  );\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Disposable} from '../../service';\n\n/**\n * @typedef {{\n *   relayoutAll: boolean,\n *   top: number,\n *   left: number,\n *   width: number,\n *   height: number,\n *   velocity: number\n * }}\n */\nexport let ViewportChangedEventDef;\n\n/**\n * @typedef {{\n *   relayoutAll: boolean,\n *   width: number,\n *   height: number\n * }}\n */\nexport let ViewportResizedEventDef;\n\n/* eslint-disable no-unused-vars */\n/**\n * @interface\n */\nexport class ViewportInterface extends Disposable {\n  /**\n   * Called before a first AMP element is added to resources. Called in the\n   * mutate context.\n   */\n  ensureReadyForElements() {}\n\n  /**\n   * Returns the top padding mandated by the viewer.\n   * @return {number}\n   */\n  getPaddingTop() {}\n\n  /**\n   * Returns the viewport's vertical scroll position.\n   * @return {number}\n   */\n  getScrollTop() {}\n\n  /**\n   * Returns the viewport's horizontal scroll position.\n   * @return {number}\n   */\n  getScrollLeft() {}\n\n  /**\n   * Sets the desired scroll position on the viewport.\n   * @param {number} scrollPos\n   */\n  setScrollTop(scrollPos) {}\n\n  /**\n   * Sets the body padding bottom to the specified value.\n   * @param {number} paddingBottom\n   */\n  updatePaddingBottom(paddingBottom) {}\n\n  /**\n   * Returns the size of the viewport.\n   * @return {!{width: number, height: number}}\n   */\n  getSize() {}\n\n  /**\n   * Returns the height of the viewport.\n   * @return {number}\n   */\n  getHeight() {}\n\n  /**\n   * Returns the width of the viewport.\n   * @return {number}\n   */\n  getWidth() {}\n\n  /**\n   * Returns the scroll width of the content of the document. Note that this\n   * method is not cached since we there's no indication when it might change.\n   * @return {number}\n   */\n  getScrollWidth() {}\n\n  /**\n   * Returns the scroll height of the content of the document, including the\n   * padding top for the viewer header.\n   * The scrollHeight will be the viewport height if there's not enough content\n   * to fill up the viewport.\n   * Note that this method is not cached since we there's no indication when\n   * it might change.\n   * @return {number}\n   */\n  getScrollHeight() {}\n\n  /**\n   * Returns the height of the content of the document, including the\n   * padding top for the viewer header.\n   * contentHeight will match scrollHeight in all cases unless the viewport is\n   * taller than the content.\n   * Note that this method is not cached since we there's no indication when\n   * it might change.\n   * @return {number}\n   */\n  getContentHeight() {}\n\n  /**\n   * Resource manager signals to the viewport that content height is changed\n   * and some action may need to be taken.\n   * @restricted Use is restricted due to potentially very heavy performance\n   *   impact. Can only be called when not actively scrolling.\n   */\n  contentHeightChanged() {}\n\n  /**\n   * Returns the rect of the viewport which includes scroll positions and size.\n   * @return {!../../layout-rect.LayoutRectDef}}\n   */\n  getRect() {}\n\n  /**\n   * Returns the rect of the element within the document.\n   * Note that this function should be called in vsync measure. Please consider\n   * using `getLayoutRectAsync` instead.\n   * @param {!Element} el\n   * @return {!../../layout-rect.LayoutRectDef}\n   */\n  getLayoutRect(el) {}\n\n  /**\n   * Returns the clientRect of the element.\n   * Note: This method does not taking intersection into account.\n   * @param {!Element} el\n   * @return {!Promise<!../../layout-rect.LayoutRectDef>}\n   */\n  getClientRectAsync(el) {}\n\n  /**\n   * Whether the binding supports fix-positioned elements.\n   * @return {boolean}\n   */\n  supportsPositionFixed() {}\n\n  /**\n   * Whether the element is declared as fixed in any of the user's stylesheets.\n   * Will include any matches, not necessarily currently fixed elements.\n   * @param {!Element} element\n   * @return {boolean}\n   */\n  isDeclaredFixed(element) {}\n\n  /**\n   * Scrolls element into view much like Element. scrollIntoView does but\n   * in the AMP/Viewer environment.\n   * @param {!Element} element\n   * @return {!Promise}\n   */\n  scrollIntoView(element) {}\n\n  /**\n   * Scrolls element into view much like Element. scrollIntoView does but\n   * in the AMP/Viewer environment. Adds animation for the sccrollIntoView\n   * transition.\n   *\n   * @param {!Element} element\n   * @param {string=} pos (takes one of 'top', 'bottom', 'center')\n   * @param {number=} opt_duration\n   * @param {string=} opt_curve\n   * @return {!Promise}\n   */\n  animateScrollIntoView(element, pos = 'top', opt_duration, opt_curve) {}\n\n  /**\n   * @param {!Element} element\n   * @param {!Element} parent Should be scrollable.\n   * @param {string} pos (takes one of 'top', 'bottom', 'center')\n   * @param {number=} opt_duration\n   * @param {string=} opt_curve\n   * @return {!Promise}\n   */\n  animateScrollWithinParent(element, parent, pos, opt_duration, opt_curve) {}\n\n  /**\n   * @return {!Element}\n   */\n  getScrollingElement() {}\n\n  /**\n   * Registers the handler for ViewportChangedEventDef events.\n   * @param {function(!ViewportChangedEventDef)} handler\n   * @return {!UnlistenDef}\n   */\n  onChanged(handler) {}\n\n  /**\n   * Registers the handler for scroll events. These events DO NOT contain\n   * scrolling offset and it's discouraged to read scrolling offset in the\n   * event handler. The primary use case for this handler is to inform that\n   * scrolling might be going on. To get more information {@link onChanged}\n   * handler should be used.\n   * @param {function()} handler\n   * @return {!UnlistenDef}\n   */\n  onScroll(handler) {}\n\n  /**\n   * Registers the handler for ViewportResizedEventDef events.\n   *\n   * Note that there is a known bug in Webkit that causes window.innerWidth\n   * and window.innerHeight values to be incorrect after resize. A temporary\n   * fix is to add a 500 ms delay before computing these values.\n   * Link: https://bugs.webkit.org/show_bug.cgi?id=170595\n   *\n   * @param {function(!ViewportResizedEventDef)} handler\n   * @return {!UnlistenDef}\n   */\n  onResize(handler) {}\n\n  /**\n   * Instruct the viewport to enter lightbox mode.\n   * @param {!Element=} opt_requestingElement Must be provided to be able to\n   *     enter lightbox mode under FIE cases.\n   * @param {!Promise=} opt_onComplete Optional promise that's resolved when\n   *     the caller finishes opening the lightbox e.g. transition animations.\n   * @return {!Promise}\n   */\n  enterLightboxMode(opt_requestingElement, opt_onComplete) {}\n\n  /**\n   * Instruct the viewport to leave lightbox mode.\n   * @param {!Element=} opt_requestingElement Must be provided to be able to\n   *     enter lightbox mode under FIE cases.\n   * @return {!Promise}\n   */\n  leaveLightboxMode(opt_requestingElement) {}\n\n  /**\n   * Instruct the viewport to enter overlay mode.\n   */\n  enterOverlayMode() {}\n\n  /**\n   * Instruct the viewport to leave overlay mode.\n   */\n  leaveOverlayMode() {}\n\n  /**\n   * Disable the scrolling by setting overflow: hidden.\n   * Should only be used for temporarily disabling scroll.\n   */\n  disableScroll() {}\n\n  /**\n   * Reset the scrolling by removing overflow: hidden.\n   */\n  resetScroll() {}\n\n  /**\n   * Resets touch zoom to initial scale of 1.\n   */\n  resetTouchZoom() {}\n\n  /**\n   * Disables touch zoom on this viewport. Returns `true` if any actual\n   * changes have been done.\n   * @return {boolean}\n   */\n  disableTouchZoom() {}\n\n  /**\n   * Restores original touch zoom parameters. Returns `true` if any actual\n   * changes have been done.\n   * @return {boolean}\n   */\n  restoreOriginalTouchZoom() {}\n\n  /**\n   * Updates the fixed layer.\n   */\n  updateFixedLayer() {}\n\n  /**\n   * Adds the element to the fixed layer.\n   * @param {!Element} element\n   * @param {boolean=} opt_forceTransfer If set to true , then the element needs\n   *    to be forcefully transferred to the fixed layer.\n   * @return {!Promise}\n   */\n  addToFixedLayer(element, opt_forceTransfer) {}\n\n  /**\n   * Removes the element from the fixed layer.\n   * @param {!Element} element\n   */\n  removeFromFixedLayer(element) {}\n}\n/* eslint-enable no-unused-vars */\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from '../utils/promise';\nimport {JankMeter} from './jank-meter';\nimport {Pass} from '../pass';\nimport {Services} from '../services';\nimport {\n  addDocumentVisibilityChangeListener,\n  isDocumentHidden,\n  removeDocumentVisibilityChangeListener,\n} from '../utils/document-visibility';\nimport {cancellation} from '../error';\nimport {dev, devAssert, rethrowAsync} from '../log';\nimport {getService, registerServiceBuilder} from '../service';\nimport {installTimerService} from './timer-impl';\n\n/** @const {time} */\nconst FRAME_TIME = 16;\n\n/**\n * @typedef {!Object<string, *>}\n */\nlet VsyncStateDef;\n\n/**\n * @typedef {{\n *   measure: (function(!VsyncStateDef):undefined|undefined),\n *   mutate: (function(!VsyncStateDef):undefined|undefined)\n * }}\n */\nlet VsyncTaskSpecDef;\n\n/**\n * Abstraction over requestAnimationFrame (rAF) that batches DOM read (measure)\n * and write (mutate) tasks in a single frame, to eliminate layout thrashing.\n *\n * NOTE: If the document is invisible due to prerendering (this includes\n * application-level prerendering where the doc is rendered in a hidden\n * iframe or webview), then no frame will be scheduled.\n * @package Visible for type.\n * @implements {../service.Disposable}\n */\nexport class Vsync {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    /** @private @const {!./ampdoc-impl.AmpDocService} */\n    this.ampdocService_ = Services.ampdocServiceFor(this.win);\n\n    /** @private @const {function(function())}  */\n    this.raf_ = this.getRaf_();\n\n    /**\n     * Tasks to run in the next frame.\n     * @private {!Array<!VsyncTaskSpecDef>}\n     */\n    this.tasks_ = [];\n\n    /**\n     * Double buffer for tasks.\n     * @private {!Array<!VsyncTaskSpecDef>}\n     */\n    this.nextTasks_ = [];\n\n    /**\n     * States for tasks in the next frame in the same order.\n     * @private {!Array<!VsyncStateDef>}\n     */\n    this.states_ = [];\n\n    /**\n     * Double buffer for states.\n     * @private {!Array<!VsyncStateDef>}\n     */\n    this.nextStates_ = [];\n\n    /**\n     * Whether a new animation frame has been scheduled.\n     * @private {boolean}\n     */\n    this.scheduled_ = false;\n\n    /** @private {?Promise} */\n    this.nextFramePromise_ = null;\n\n    /** @protected {?function()} */\n    this.nextFrameResolver_ = null;\n\n    /** @const {!Function} */\n    this.boundRunScheduledTasks_ = this.runScheduledTasks_.bind(this);\n\n    /**\n     * If the doc is invisible we use this instead of rAF because rAF\n     * does not run in that scenario.\n     * However, we only do this for non-animation tasks as running\n     * animations doesn't make sense when not visible.\n     * @const {!Pass}\n     */\n    this.invisiblePass_ = new Pass(\n      this.win,\n      this.boundRunScheduledTasks_,\n      FRAME_TIME\n    );\n\n    /**\n     * Similar to this.invisiblePass_, but backing up a real rAF call. If we\n     * somehow failed to know that we are throttled we use a timer (which\n     * may also be throttled but at least runs eventually) to make sure\n     * we continue to get work done.\n     * @const {!Pass}\n     */\n    this.backupPass_ = new Pass(\n      this.win,\n      this.boundRunScheduledTasks_,\n      // We cancel this when rAF fires and really only want it to fire\n      // if rAF doesn't work at all.\n      FRAME_TIME * 2.5\n    );\n\n    // When the document changes visibility, vsync has to reschedule the queue\n    // processing.\n    /** @private {function()} */\n    this.boundOnVisibilityChanged_ = this.onVisibilityChanged_.bind(this);\n    if (this.ampdocService_.isSingleDoc()) {\n      // In a single-doc mode, the visibility of the doc == global visibility.\n      // Thus, it's more efficient to only listen to it once.\n      this.ampdocService_\n        .getSingleDoc()\n        .onVisibilityChanged(this.boundOnVisibilityChanged_);\n    } else {\n      // In multi-doc mode, we track separately the global visibility and\n      // per-doc visibility when necessary.\n      addDocumentVisibilityChangeListener(\n        this.win.document,\n        this.boundOnVisibilityChanged_\n      );\n    }\n\n    /** @private {!JankMeter} */\n    this.jankMeter_ = new JankMeter(this.win);\n  }\n\n  /** @override */\n  dispose() {\n    removeDocumentVisibilityChangeListener(\n      this.win.document,\n      this.boundOnVisibilityChanged_\n    );\n  }\n\n  /** @private */\n  onVisibilityChanged_() {\n    if (this.scheduled_) {\n      this.forceSchedule_();\n    }\n  }\n\n  /**\n   * Runs vsync task: measure followed by mutate.\n   *\n   * If state is not provided, the value passed to the measure and mutate\n   * will be undefined.\n   *\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   */\n  run(task, opt_state) {\n    this.tasks_.push(task);\n    this.states_.push(opt_state || undefined);\n    this.schedule_();\n  }\n\n  /**\n   * Runs vsync task: measure followed by mutate. Returns the promise that\n   * will be resolved as soon as the task has been completed.\n   *\n   * If state is not provided, the value passed to the measure and mutate\n   * will be undefined.\n   *\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   * @return {!Promise}\n   */\n  runPromise(task, opt_state) {\n    this.run(task, opt_state);\n    if (this.nextFramePromise_) {\n      return this.nextFramePromise_;\n    }\n    const deferred = new Deferred();\n    this.nextFrameResolver_ = deferred.resolve;\n    return (this.nextFramePromise_ = deferred.promise);\n  }\n\n  /**\n   * Creates a function that will call {@link run} method.\n   * @param {!VsyncTaskSpecDef} task\n   * @return {function(!VsyncStateDef=)}\n   */\n  createTask(task) {\n    return /** @type {function(!VsyncStateDef=)} */ (opt_state => {\n      this.run(task, opt_state);\n    });\n  }\n\n  /**\n   * Runs the mutate operation via vsync.\n   * @param {function():undefined} mutator\n   */\n  mutate(mutator) {\n    this.run({\n      measure: undefined, // For uniform hidden class.\n      mutate: mutator,\n    });\n  }\n\n  /**\n   * Runs `mutate` wrapped in a promise.\n   * @param {function():undefined} mutator\n   * @return {!Promise}\n   */\n  mutatePromise(mutator) {\n    return this.runPromise({\n      measure: undefined,\n      mutate: mutator,\n    });\n  }\n\n  /**\n   * Runs the measure operation via vsync.\n   * @param {function():undefined} measurer\n   */\n  measure(measurer) {\n    this.run({\n      measure: measurer,\n      mutate: undefined, // For uniform hidden class.\n    });\n  }\n\n  /**\n   * Runs `measure` wrapped in a promise.\n   * @param {function():TYPE} measurer\n   * @return {!Promise<TYPE>}\n   * @template TYPE\n   */\n  measurePromise(measurer) {\n    return new Promise(resolve => {\n      this.measure(() => {\n        resolve(measurer());\n      });\n    });\n  }\n\n  /**\n   * Whether the runtime is allowed to animate at this time.\n   * @param {!Node} contextNode\n   * @return {boolean}\n   */\n  canAnimate(contextNode) {\n    return this.canAnimate_(devAssert(contextNode));\n  }\n\n  /**\n   * @param {!Node=} opt_contextNode\n   * @return {boolean}\n   * @private\n   */\n  canAnimate_(opt_contextNode) {\n    // Window level: animations allowed only when global window is visible.\n    if (isDocumentHidden(this.win.document)) {\n      return false;\n    }\n\n    // Single doc: animations allowed when single doc is visible.\n    if (this.ampdocService_.isSingleDoc()) {\n      return this.ampdocService_.getSingleDoc().isVisible();\n    }\n\n    // Multi-doc: animations depend on the state of the relevant doc.\n    if (opt_contextNode) {\n      const ampdoc = this.ampdocService_.getAmpDocIfAvailable(opt_contextNode);\n      return !ampdoc || ampdoc.isVisible();\n    }\n\n    return true;\n  }\n\n  /**\n   * Runs the animation vsync task. This operation can only run when animations\n   * are allowed. Otherwise, this method returns `false` and exits.\n   * @param {!Node} contextNode\n   * @param {!VsyncTaskSpecDef} task\n   * @param {!VsyncStateDef=} opt_state\n   * @return {boolean}\n   */\n  runAnim(contextNode, task, opt_state) {\n    // Do not request animation frames when the document is not visible.\n    if (!this.canAnimate_(contextNode)) {\n      dev().warn(\n        'VSYNC',\n        'Did not schedule a vsync request, because document was invisible'\n      );\n      return false;\n    }\n    this.run(task, opt_state);\n    return true;\n  }\n\n  /**\n   * Creates an animation vsync task. This operation can only run when\n   * animations are allowed. Otherwise, this closure returns `false` and exits.\n   * @param {!Node} contextNode\n   * @param {!VsyncTaskSpecDef} task\n   * @return {function(!VsyncStateDef=):boolean}\n   */\n  createAnimTask(contextNode, task) {\n    return /** @type {function(!VsyncStateDef=):boolean} */ (opt_state => {\n      return this.runAnim(contextNode, task, opt_state);\n    });\n  }\n\n  /**\n   * Runs the series of mutates until the mutator returns a false value.\n   * @param {!Node} contextNode\n   * @param {function(time, time, !VsyncStateDef):boolean} mutator The\n   *   mutator callback. Only expected to do DOM writes, not reads. If the\n   *   returned value is true, the vsync task will be repeated, otherwise it\n   *   will be completed. The arguments are: timeSinceStart:time,\n   *   timeSincePrev:time and state:VsyncStateDef.\n   * @param {number=} opt_timeout Optional timeout that will force the series\n   *   to complete and reject the promise.\n   * @return {!Promise} Returns the promise that will either resolve on when\n   *   the vsync series are completed or reject in case of failure, such as\n   *   timeout.\n   */\n  runAnimMutateSeries(contextNode, mutator, opt_timeout) {\n    if (!this.canAnimate_(contextNode)) {\n      return Promise.reject(cancellation());\n    }\n    return new Promise((resolve, reject) => {\n      const startTime = Date.now();\n      let prevTime = 0;\n      const task = this.createAnimTask(contextNode, {\n        mutate: state => {\n          const timeSinceStart = Date.now() - startTime;\n          const res = mutator(timeSinceStart, timeSinceStart - prevTime, state);\n          if (!res) {\n            resolve();\n          } else if (opt_timeout && timeSinceStart > opt_timeout) {\n            reject(new Error('timeout'));\n          } else {\n            prevTime = timeSinceStart;\n            task(state);\n          }\n        },\n      });\n      task({});\n    });\n  }\n\n  /** @private */\n  schedule_() {\n    if (this.scheduled_) {\n      return;\n    }\n    // Schedule actual animation frame and then run tasks.\n    this.scheduled_ = true;\n    this.jankMeter_.onScheduled();\n    this.forceSchedule_();\n  }\n\n  /** @private */\n  forceSchedule_() {\n    if (this.canAnimate_()) {\n      this.raf_(this.boundRunScheduledTasks_);\n      this.backupPass_.schedule();\n    } else {\n      this.invisiblePass_.schedule();\n    }\n  }\n\n  /**\n   * Runs all scheduled tasks. This is typically called in an RAF\n   * callback. Tests may call this method to force execution of\n   * tasks without waiting.\n   * @private\n   */\n  runScheduledTasks_() {\n    this.backupPass_.cancel();\n    this.scheduled_ = false;\n    this.jankMeter_.onRun();\n\n    const {tasks_: tasks, states_: states, nextFrameResolver_: resolver} = this;\n    this.nextFrameResolver_ = null;\n    this.nextFramePromise_ = null;\n    // Double buffering\n    this.tasks_ = this.nextTasks_;\n    this.states_ = this.nextStates_;\n    for (let i = 0; i < tasks.length; i++) {\n      if (tasks[i].measure) {\n        if (!callTask_(tasks[i].measure, states[i])) {\n          // Ensure that the mutate is not executed when measure fails.\n          tasks[i].mutate = undefined;\n        }\n      }\n    }\n    for (let i = 0; i < tasks.length; i++) {\n      if (tasks[i].mutate) {\n        callTask_(tasks[i].mutate, states[i]);\n      }\n    }\n    // Swap last arrays into double buffer.\n    this.nextTasks_ = tasks;\n    this.nextStates_ = states;\n    this.nextTasks_.length = 0;\n    this.nextStates_.length = 0;\n    if (resolver) {\n      resolver();\n    }\n  }\n\n  /**\n   * @return {function(function())} requestAnimationFrame or polyfill.\n   */\n  getRaf_() {\n    const raf =\n      this.win.requestAnimationFrame || this.win.webkitRequestAnimationFrame;\n    if (raf) {\n      return raf.bind(this.win);\n    }\n    let lastTime = 0;\n    return fn => {\n      const now = Date.now();\n      // By default we take 16ms between frames, but if the last frame is say\n      // 10ms ago, we only want to wait 6ms.\n      const timeToCall = Math.max(0, FRAME_TIME - (now - lastTime));\n      lastTime = now + timeToCall;\n      this.win.setTimeout(fn, timeToCall);\n    };\n  }\n}\n\n/**\n * For optimization reasons to stop try/catch from blocking optimization.\n * @param {function(!VsyncStateDef):undefined|undefined} callback\n * @param {!VsyncStateDef} state\n * @return {boolean}\n * @noinline\n */\nfunction callTask_(callback, state) {\n  devAssert(callback);\n  try {\n    const ret = callback(state);\n    if (ret !== undefined) {\n      dev().error(\n        'VSYNC',\n        'callback returned a value but vsync cannot propogate it: %s',\n        callback.toString()\n      );\n    }\n  } catch (e) {\n    rethrowAsync(e);\n    return false;\n  }\n  return true;\n}\n\n/**\n * @param {!Window} window\n * @return {!Vsync}\n */\nexport function vsyncForTesting(window) {\n  installVsyncService(window);\n  return getService(window, 'vsync');\n}\n\n/**\n * @param {!Window} window\n */\nexport function installVsyncService(window) {\n  installTimerService(window);\n  registerServiceBuilder(window, 'vsync', Vsync);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {\n  assertSuccess,\n  getViewerInterceptResponse,\n  setupAMPCors,\n  setupInit,\n  setupInput,\n  setupJsonFetchInit,\n} from '../utils/xhr-utils';\nimport {getCorsUrl, parseUrlDeprecated} from '../url';\nimport {getService, registerServiceBuilder} from '../service';\nimport {isFormDataWrapper} from '../form-data-wrapper';\nimport {user} from '../log';\n\n/**\n * A service that polyfills Fetch API for use within AMP.\n *\n * @package Visible for type.\n * @visibleForTesting\n */\nexport class Xhr {\n  /**\n   * @param {!Window} win\n   */\n  constructor(win) {\n    /** @const {!Window} */\n    this.win = win;\n\n    const ampdocService = Services.ampdocServiceFor(win);\n\n    // The isSingleDoc check is required because if in shadow mode, this will\n    // throw a console error because the shellShadowDoc_ is not set when\n    // fetching the amp doc. So either the test-bind-impl or test pre setup in\n    // shadow mode tests needs to be fixed or there is a bug in ampdoc impl\n    // getAmpDoc.\n    // TODO(alabiaga): This should be investigated and fixed\n    /** @private {?./ampdoc-impl.AmpDoc} */\n    this.ampdocSingle_ = ampdocService.isSingleDoc()\n      ? ampdocService.getSingleDoc()\n      : null;\n  }\n\n  /**\n   * We want to call `fetch_` unbound from any context since it could\n   * be either the native fetch or our polyfill.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef} init\n   * @return {!Promise<!Response>}\n   * @private\n   */\n  fetch_(input, init) {\n    return getViewerInterceptResponse(\n      this.win,\n      this.ampdocSingle_,\n      input,\n      init\n    ).then(interceptorResponse => {\n      if (interceptorResponse) {\n        return interceptorResponse;\n      }\n      // After this point, both the native `fetch` and the `fetch` polyfill\n      // will expect a native `FormData` object in the `body` property, so\n      // the native `FormData` object needs to be unwrapped.\n      if (isFormDataWrapper(init.body)) {\n        const formDataWrapper =\n          /** @type {!FormDataWrapperInterface} */ (init.body);\n        init.body = formDataWrapper.getFormData();\n      }\n      return this.win.fetch.apply(null, arguments);\n    });\n  }\n\n  /**\n   * Performs the final initialization and requests the fetch. It does two\n   * main things:\n   * - It adds \"__amp_source_origin\" URL parameter with source origin\n   * USE WITH CAUTION: setting ampCors to false disables AMP source origin check\n   * but allows for caching resources cross pages.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef=} init\n   * @return {!Promise<!Response>}\n   * @private\n   */\n  fetchAmpCors_(input, init = {}) {\n    input = setupInput(this.win, input, init);\n    init = setupAMPCors(this.win, input, init);\n    return this.fetch_(input, init).then(\n      response => response,\n      reason => {\n        const targetOrigin = parseUrlDeprecated(input).origin;\n        throw user().createExpectedError(\n          'XHR',\n          `Failed fetching (${targetOrigin}/...):`,\n          reason && reason.message\n        );\n      }\n    );\n  }\n\n  /**\n   * Fetches a JSON response. Note this returns the response object, not the\n   * response's JSON. #fetchJson merely sets up the request to accept JSON.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {?FetchInitDef=} opt_init\n   * @return {!Promise<!Response>}\n   */\n  fetchJson(input, opt_init) {\n    return this.fetch(input, setupJsonFetchInit(opt_init));\n  }\n\n  /**\n   * Fetches a text response. Note this returns the response object, not the\n   * response's text. #fetchText merely sets up the request to accept text.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {?FetchInitDef=} opt_init\n   * @return {!Promise<!Response>}\n   */\n  fetchText(input, opt_init) {\n    return this.fetch(input, setupInit(opt_init, 'text/plain'));\n  }\n\n  /**\n   * @param {string} input URL\n   * @param {?FetchInitDef=} opt_init Fetch options object.\n   * @return {!Promise<!Response>}\n   */\n  fetch(input, opt_init) {\n    const init = setupInit(opt_init);\n    return this.fetchAmpCors_(input, init).then(response =>\n      assertSuccess(response)\n    );\n  }\n\n  /**\n   * Sends the request, awaits result and confirms that it was successful.\n   *\n   * See https://developer.mozilla.org/en-US/docs/Web/API/GlobalFetch/fetch\n   *\n   * See `fetchAmpCors_` for more detail.\n   *\n   * @param {string} input\n   * @param {!FetchInitDef=} opt_init\n   * @return {!Promise}\n   */\n  sendSignal(input, opt_init) {\n    return this.fetchAmpCors_(input, opt_init).then(response =>\n      assertSuccess(response)\n    );\n  }\n\n  /**\n   * Add \"__amp_source_origin\" query parameter to the URL. Ideally, we'd be\n   * able to set a header (e.g. AMP-Source-Origin), but this will force\n   * preflight request on all CORS request.\n   * @param {!Window} win\n   * @param {string} url\n   * @return {string}\n   */\n  getCorsUrl(win, url) {\n    return getCorsUrl(win, url);\n  }\n}\n\n/**\n * @param {!Window} window\n * @return {!Xhr}\n */\nexport function xhrServiceForTesting(window) {\n  installXhrService(window);\n  return getService(window, 'xhr');\n}\n\n/**\n * @param {!Window} window\n */\nexport function installXhrService(window) {\n  registerServiceBuilder(window, 'xhr', Xhr);\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  getAmpdoc,\n  getExistingServiceForDocInEmbedScope,\n  getExistingServiceOrNull,\n  getService,\n  getServiceForDoc,\n  getServicePromiseForDoc,\n} from './service';\nimport {\n  getElementServiceForDoc,\n  getElementServiceIfAvailable,\n  getElementServiceIfAvailableForDoc,\n  getElementServiceIfAvailableForDocInEmbedScope,\n} from './element-service';\n\n/** @typedef {!../extensions/amp-subscriptions/0.1/amp-subscriptions.SubscriptionService} */\nexport let SubscriptionService;\n\nexport class Services {\n  /**\n   * Hint: Add extensions folder path to compile.js with\n   * warnings cannot find modules.\n   */\n\n  /**\n   * Returns a promise for the Access service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-access/0.1/amp-access.AccessService>} */ (getElementServiceForDoc(\n      element,\n      'access',\n      'amp-access'\n    ));\n  }\n\n  /**\n   * Returns a promise for the Access service or a promise for null if the\n   * service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>}\n   */\n  static accessServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-access/0.1/amp-access.AccessService>} */ (getElementServiceIfAvailableForDoc(\n      element,\n      'access',\n      'amp-access'\n    ));\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!SubscriptionService>}\n   */\n  static subscriptionsServiceForDoc(element) {\n    return /** @type {!Promise<!SubscriptionService>} */ (getElementServiceForDoc(\n      element,\n      'subscriptions',\n      'amp-subscriptions'\n    ));\n  }\n\n  /**\n   * Returns a promise for the Subscriptions service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?SubscriptionService>}\n   */\n  static subscriptionsServiceForDocOrNull(element) {\n    return /** @type {!Promise<?SubscriptionService>} */ (getElementServiceIfAvailableForDoc(\n      element,\n      'subscriptions',\n      'amp-subscriptions'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/action-impl.ActionService}\n   */\n  static actionServiceForDoc(element) {\n    return /** @type {!./service/action-impl.ActionService} */ (getExistingServiceForDocInEmbedScope(\n      element,\n      'action'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/standard-actions-impl.StandardActions}\n   */\n  static standardActionsForDoc(element) {\n    return /** @type {!./service/standard-actions-impl.StandardActions} */ (getExistingServiceForDocInEmbedScope(\n      element,\n      'standard-actions'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>}\n   */\n  static activityForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/activity-impl.Activity>} */ (getElementServiceForDoc(\n      element,\n      'activity',\n      'amp-analytics'\n    ));\n  }\n\n  /**\n   * Returns the global instance of the `AmpDocService` service that can be\n   * used to resolve an ampdoc for any node: either in the single-doc or\n   * shadow-doc environment.\n   * @param {!Window} window\n   * @return {!./service/ampdoc-impl.AmpDocService}\n   */\n  static ampdocServiceFor(window) {\n    return /** @type {!./service/ampdoc-impl.AmpDocService} */ (getService(\n      window,\n      'ampdoc'\n    ));\n  }\n\n  /**\n   * Returns the AmpDoc for the specified context node.\n   * @param {!Node|!./service/ampdoc-impl.AmpDoc} nodeOrAmpDoc\n   * @return {!./service/ampdoc-impl.AmpDoc}\n   */\n  static ampdoc(nodeOrAmpDoc) {\n    return getAmpdoc(nodeOrAmpDoc);\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @param {boolean=} loadAnalytics\n   * @return {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDoc(element, loadAnalytics = false) {\n    if (loadAnalytics) {\n      // Get Extensions service and force load analytics extension.\n      const ampdoc = getAmpdoc(element);\n      Services.extensionsFor(ampdoc.win)./*OK*/ installExtensionForDoc(\n        ampdoc,\n        'amp-analytics'\n      );\n    }\n    return /** @type {!Promise<!../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (getElementServiceForDoc(\n      element,\n      'amp-analytics-instrumentation',\n      'amp-analytics'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>}\n   */\n  static analyticsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-analytics/0.1/instrumentation.InstrumentationService>} */ (getElementServiceIfAvailableForDoc(\n      element,\n      'amp-analytics-instrumentation',\n      'amp-analytics'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/batched-xhr-impl.BatchedXhr}\n   */\n  static batchedXhrFor(window) {\n    return /** @type {!./service/batched-xhr-impl.BatchedXhr} */ (getService(\n      window,\n      'batched-xhr'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>}\n   */\n  static bindForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-bind/0.1/bind-impl.Bind>} */ (getElementServiceIfAvailableForDocInEmbedScope(\n      element,\n      'bind',\n      'amp-bind'\n    ));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/cid-impl.CidDef>}\n   */\n  static cidForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/cid-impl.CidDef>} */ (getServicePromiseForDoc(\n      elementOrAmpDoc,\n      'cid'\n    ));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/navigation.Navigation}\n   */\n  static navigationForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/navigation.Navigation} */ (getServiceForDoc(\n      elementOrAmpDoc,\n      'navigation'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>}\n   */\n  static loaderServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-loader/0.1/amp-loader.LoaderService>} */ (getElementServiceForDoc(\n      element,\n      'loader',\n      'amp-loader'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>}\n   */\n  static standaloneServiceForDoc(element) {\n    return /** @type {!Promise<!../extensions/amp-standalone/0.1/amp-standalone.StandaloneService>} */ (getElementServiceForDoc(\n      element,\n      'standalone',\n      'amp-standalone'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/crypto-impl.Crypto}\n   */\n  static cryptoFor(window) {\n    return /** @type {!./service/crypto-impl.Crypto} */ (getService(\n      window,\n      'crypto'\n    ));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/document-info-impl.DocumentInfoDef} Info about the doc\n   */\n  static documentInfoForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/document-info-impl.DocInfo} */ (getServiceForDoc(\n      elementOrAmpDoc,\n      'documentInfo'\n    )).get();\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/extensions-impl.Extensions}\n   */\n  static extensionsFor(window) {\n    return /** @type {!./service/extensions-impl.Extensions} */ (getService(\n      window,\n      'extensions'\n    ));\n  }\n\n  /**\n   * Returns a service to register callbacks we wish to execute when an\n   * amp-form is submitted.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>}\n   */\n  static formSubmitForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<../extensions/amp-form/0.1/form-submit-service.FormSubmitService>} */ (getServicePromiseForDoc(\n      elementOrAmpDoc,\n      'form-submit-service'\n    ));\n  }\n\n  /**\n   * Returns service to listen for `hidden` attribute mutations.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/hidden-observer-impl.HiddenObserver}\n   */\n  static hiddenObserverForDoc(element) {\n    return /** @type {!./service/hidden-observer-impl.HiddenObserver} */ (getExistingServiceForDocInEmbedScope(\n      element,\n      'hidden-observer'\n    ));\n  }\n\n  /**\n   * Returns service implemented in service/history-impl.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/history-impl.History}\n   */\n  static historyForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/history-impl.History} */ (getServiceForDoc(\n      elementOrAmpDoc,\n      'history'\n    ));\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!./input.Input}\n   */\n  static inputFor(win) {\n    return getService(win, 'input');\n  }\n\n  /**s\n   * Returns a promise for the Inputmask service.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>}\n   */\n  static inputmaskServiceForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-inputmask/0.1/amp-inputmask.AmpInputmaskService>} */ (getElementServiceIfAvailableForDoc(\n      element,\n      'inputmask',\n      'amp-inputmask'\n    ));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/owners-interface.OwnersInterface}\n   */\n  static ownersForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/owners-interface.OwnersInterface} */ (getServiceForDoc(\n      elementOrAmpDoc,\n      'owners'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceFor(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (getService(\n      window,\n      'performance'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/performance-impl.Performance}\n   */\n  static performanceForOrNull(window) {\n    return /** @type {!./service/performance-impl.Performance}*/ (getExistingServiceOrNull(\n      window,\n      'performance'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/platform-impl.Platform}\n   */\n  static platformFor(window) {\n    return /** @type {!./service/platform-impl.Platform} */ (getService(\n      window,\n      'platform'\n    ));\n  }\n\n  /**\n   * Not installed by default; must be installed in extension code before use.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/position-observer/position-observer-impl.PositionObserver}\n   * @throws If the service is not installed.\n   */\n  static positionObserverForDoc(element) {\n    return /** @type {!./service/position-observer/position-observer-impl.PositionObserver} */ (getServiceForDoc(\n      element,\n      'position-observer'\n    ));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/resources-interface.ResourcesInterface}\n   */\n  static resourcesForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/resources-interface.ResourcesInterface} */ (getServiceForDoc(\n      elementOrAmpDoc,\n      'resources'\n    ));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/resources-interface.ResourcesInterface>}\n   */\n  static resourcesPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/resources-interface.ResourcesInterface>} */ (getServicePromiseForDoc(\n      elementOrAmpDoc,\n      'resources'\n    ));\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?{incomingFragment: string, outgoingFragment: string}>}\n   */\n  static shareTrackingForOrNull(win) {\n    return /** @type {!Promise<?{incomingFragment: string, outgoingFragment: string}>} */ (getElementServiceIfAvailable(\n      win,\n      'share-tracking',\n      'amp-share-tracking',\n      true\n    ));\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/variable-service.StoryVariableDef>}\n   */\n  static storyVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/variable-service.StoryVariableDef>} */\n      (getElementServiceIfAvailable(win, 'story-variable', 'amp-story', true))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService}\n   */\n  static storyVariableService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/variable-service.AmpStoryVariableService} */\n      (getExistingServiceOrNull(win, 'story-variable'))\n    );\n  }\n\n  /**\n   * Version of the story store service depends on which version of amp-story\n   * the publisher is loading. They all have the same implementation.\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService|?../extensions/amp-story/0.1/amp-story-store-service.AmpStoryStoreService>}\n   */\n  static storyStoreServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService|?../extensions/amp-story/0.1/amp-story-store-service.AmpStoryStoreService>} */\n      (getElementServiceIfAvailable(win, 'story-store', 'amp-story'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService}\n   */\n  static storyStoreService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-store-service.AmpStoryStoreService} */\n      (getExistingServiceOrNull(win, 'story-store'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService}\n   */\n  static storyMediaQueryService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-media-query-service.AmpStoryMediaQueryService} */\n      (getExistingServiceOrNull(win, 'story-media-query'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService}\n   */\n  static storyRequestService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/amp-story-request-service.AmpStoryRequestService} */\n      (getExistingServiceOrNull(win, 'story-request'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService}\n   */\n  static mediaPerformanceMetricsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/media-performance-metrics-service.MediaPerformanceMetricsService} */\n      (getExistingServiceOrNull(win, 'media-performance-metrics'))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!Promise<?./service/localization.LocalizationService>}\n   */\n  static localizationServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?./service/localization.LocalizationService>} */\n      (getElementServiceIfAvailable(win, 'localization', 'amp-story', true))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {!./service/localization.LocalizationService}\n   */\n  static localizationService(win) {\n    return getService(win, 'localization');\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>}\n   */\n  static storyAnalyticsServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService>} */\n      (getElementServiceIfAvailable(win, 'story-analytics', 'amp-story', true))\n    );\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService}\n   */\n  static storyAnalyticsService(win) {\n    return (\n      /** @type {?../extensions/amp-story/1.0/story-analytics.StoryAnalyticsService} */\n      (getExistingServiceOrNull(win, 'story-analytics'))\n    );\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!../extensions/amp-story/0.1/amp-story-store-service.AmpStoryStoreService}\n   */\n  static storyStoreServiceV01(win) {\n    return getService(win, 'story-store');\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!../extensions/amp-story/0.1/amp-story-request-service.AmpStoryRequestService}\n   */\n  static storyRequestServiceV01(win) {\n    return getService(win, 'story-request-v01');\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!Promise<?./service/localization.LocalizationService>}\n   */\n  static localizationServiceForOrNullV01(win) {\n    return (\n      /** @type {!Promise<?./service/localization.LocalizationService>} */\n      (getElementServiceIfAvailable(win, 'localization-v01', 'amp-story', true))\n    );\n  }\n\n  /**\n   * TODO(#14357): Remove this when amp-story:0.1 is deprecated.\n   * @param {!Window} win\n   * @return {!./service/localization.LocalizationService}\n   */\n  static localizationServiceV01(win) {\n    return getService(win, 'localization-v01');\n  }\n\n  /**\n   * @param {!Window} win\n   * @return {?Promise<?../extensions/amp-viewer-integration/0.1/variable-service.ViewerIntegrationVariableDef>}\n   */\n  static viewerIntegrationVariableServiceForOrNull(win) {\n    return (\n      /** @type {!Promise<?../extensions/amp-viewer-integration/0.1/variable-service.ViewerIntegrationVariableDef>} */\n      (getElementServiceIfAvailable(\n        win,\n        'viewer-integration-variable',\n        'amp-viewer-integration',\n        true\n      ))\n    );\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>}\n   */\n  static webAnimationServiceFor(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-animation/0.1/web-animation-service.WebAnimationService>} */\n      (getElementServiceForDoc(element, 'web-animation', 'amp-animation'))\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/storage-impl.Storage>}\n   */\n  static storageForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/storage-impl.Storage>} */ (getServicePromiseForDoc(\n      elementOrAmpDoc,\n      'storage'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/template-impl.Templates}\n   */\n  static templatesFor(window) {\n    return /** @type {!./service/template-impl.Templates} */ (getService(\n      window,\n      'templates'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/timer-impl.Timer}\n   */\n  static timerFor(window) {\n    // TODO(alabiaga): This will always return the top window's Timer service.\n    return /** @type {!./service/timer-impl.Timer} */ (getService(\n      window,\n      'timer'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-replacements-impl.UrlReplacements}\n   */\n  static urlReplacementsForDoc(element) {\n    return /** @type {!./service/url-replacements-impl.UrlReplacements} */ (getExistingServiceForDocInEmbedScope(\n      element,\n      'url-replace'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>}\n   */\n  static userNotificationManagerForDoc(element) {\n    return (\n      /** @type {!Promise<!../extensions/amp-user-notification/0.1/amp-user-notification.UserNotificationManager>} */\n      (getElementServiceForDoc(\n        element,\n        'userNotificationManager',\n        'amp-user-notification'\n      ))\n    );\n  }\n\n  /**\n   * Returns a promise for the consentPolicy Service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>}\n   */\n  static consentPolicyServiceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-consent/0.1/consent-policy-manager.ConsentPolicyManager>} */\n      (getElementServiceIfAvailableForDoc(\n        element,\n        'consentPolicyManager',\n        'amp-consent'\n      ))\n    );\n  }\n\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>}\n   */\n  static geoForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-geo/0.1/amp-geo.GeoDef>} */ (getElementServiceIfAvailableForDoc(\n      element,\n      'geo',\n      'amp-geo',\n      true\n    ));\n  }\n\n  /**\n   * Returns a promise for the geo service or a promise for null if\n   * the service is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-user-location/0.1/user-location-service.UserLocationService>}\n   */\n  static userLocationForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-user-location/0.1/user-location-service.UserLocationService>} */ (getElementServiceIfAvailableForDoc(\n      element,\n      'user-location',\n      'amp-user-location',\n      true\n    ));\n  }\n\n  /**\n   * Unlike most service getters, passing `Node` is necessary for some FIE-scope\n   * services since sometimes we only have the FIE Document for context.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!./service/url-impl.Url}\n   */\n  static urlForDoc(element) {\n    return /** @type {!./service/url-impl.Url} */ (getExistingServiceForDocInEmbedScope(\n      element,\n      'url'\n    ));\n  }\n\n  /**\n   * Returns a promise for the experiment variants or a promise for null if it\n   * is not available on the current page.\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>}\n   */\n  static variantsForDocOrNull(element) {\n    return /** @type {!Promise<?../extensions/amp-experiment/0.1/variant.Variants>} */ (getElementServiceIfAvailableForDoc(\n      element,\n      'variant',\n      'amp-experiment',\n      true\n    ));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/video-manager-impl.VideoManager}\n   */\n  static videoManagerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/video-manager-impl.VideoManager} */ (getServiceForDoc(\n      elementOrAmpDoc,\n      'video-manager'\n    ));\n  }\n\n  /**\n   * @param {!Element|!ShadowRoot} element\n   * @return {!Promise<?../extensions/amp-viewer-assistance/0.1/amp-viewer-assistance.AmpViewerAssistance>}\n   */\n  static viewerAssistanceForDocOrNull(element) {\n    return (\n      /** @type {!Promise<?../extensions/amp-viewer-assistance/0.1/amp-viewer-assistance.AmpViewerAssistance>} */\n      (getElementServiceIfAvailableForDoc(\n        element,\n        'amp-viewer-assistance',\n        'amp-viewer-assistance'\n      ))\n    );\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewer-interface.ViewerInterface}\n   */\n  static viewerForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewer-interface.ViewerInterface} */ (getServiceForDoc(\n      elementOrAmpDoc,\n      'viewer'\n    ));\n  }\n\n  /**\n   * Returns promise for the viewer. This is an unusual case and necessary only\n   * for services that need reference to the viewer before it has been\n   * initialized. Most of the code, however, just should use `viewerForDoc`.\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!Promise<!./service/viewer-interface.ViewerInterface>}\n   */\n  static viewerPromiseForDoc(elementOrAmpDoc) {\n    return /** @type {!Promise<!./service/viewer-interface.ViewerInterface>} */ (getServicePromiseForDoc(\n      elementOrAmpDoc,\n      'viewer'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/vsync-impl.Vsync}\n   */\n  static vsyncFor(window) {\n    return /** @type {!./service/vsync-impl.Vsync} */ (getService(\n      window,\n      'vsync'\n    ));\n  }\n\n  /**\n   * @param {!Element|!./service/ampdoc-impl.AmpDoc} elementOrAmpDoc\n   * @return {!./service/viewport/viewport-interface.ViewportInterface}\n   */\n  static viewportForDoc(elementOrAmpDoc) {\n    return /** @type {!./service/viewport/viewport-interface.ViewportInterface} */ (getServiceForDoc(\n      elementOrAmpDoc,\n      'viewport'\n    ));\n  }\n\n  /**\n   * @param {!Window} window\n   * @return {!./service/xhr-impl.Xhr}\n   */\n  static xhrFor(window) {\n    return /** @type {!./service/xhr-impl.Xhr} */ (getService(window, 'xhr'));\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {assertLength, assertLengthOrPercent} from './layout';\nimport {userAssert} from './log';\n\n/**\n * A single option within a SizeList.\n * @typedef {{\n *   mediaQuery: (string|undefined),\n *   size: (!./layout.LengthDef)\n * }}\n */\nlet SizeListOptionDef;\n\n/**\n * Parses the text representation of \"sizes\" into SizeList object.\n *\n * There could be any number of size options within the SizeList. They are tried\n * in the order they were defined. The final size option must not have \"media\"\n * condition specified. All other size options must have \"media\" condition\n * specified.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img#Attributes\n * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n * @param {string} s\n * @param {boolean=} opt_allowPercentAsLength when parsing heights\n * @return {!SizeList}\n */\nexport function parseSizeList(s, opt_allowPercentAsLength) {\n  const sSizes = s.split(',');\n  userAssert(sSizes.length > 0, 'sizes has to have at least one size');\n  const sizes = [];\n  sSizes.forEach(sSize => {\n    sSize = sSize.replace(/\\s+/g, ' ').trim();\n    if (sSize.length == 0) {\n      return;\n    }\n\n    let mediaStr;\n    let sizeStr;\n\n    // Process the expression from the end.\n    const lastChar = sSize.charAt(sSize.length - 1);\n    let div;\n    let func = false;\n    if (lastChar == ')') {\n      // Value is the CSS function, e.g. `calc(50vw + 10px)`.\n      func = true;\n\n      // First, skip to the opening paren.\n      let parens = 1;\n      div = sSize.length - 2;\n      for (; div >= 0; div--) {\n        const c = sSize.charAt(div);\n        if (c == '(') {\n          parens--;\n        } else if (c == ')') {\n          parens++;\n        }\n        if (parens == 0) {\n          break;\n        }\n      }\n\n      // Then, skip to the begining to the function's name.\n      const funcEnd = div - 1;\n      if (div > 0) {\n        div--;\n        for (; div >= 0; div--) {\n          const c = sSize.charAt(div);\n          if (\n            !(\n              c == '%' ||\n              c == '-' ||\n              c == '_' ||\n              (c >= 'a' && c <= 'z') ||\n              (c >= 'A' && c <= 'Z') ||\n              (c >= '0' && c <= '9')\n            )\n          ) {\n            break;\n          }\n        }\n      }\n      userAssert(div < funcEnd, 'Invalid CSS function in \"%s\"', sSize);\n    } else {\n      // Value is the length or a percent: accept a wide range of values,\n      // including invalid values - they will be later asserted to conform\n      // to exact CSS length or percent value.\n      div = sSize.length - 2;\n      for (; div >= 0; div--) {\n        const c = sSize.charAt(div);\n        if (\n          !(\n            c == '%' ||\n            c == '.' ||\n            (c >= 'a' && c <= 'z') ||\n            (c >= 'A' && c <= 'Z') ||\n            (c >= '0' && c <= '9')\n          )\n        ) {\n          break;\n        }\n      }\n    }\n    if (div >= 0) {\n      mediaStr = sSize.substring(0, div + 1).trim();\n      sizeStr = sSize.substring(div + 1).trim();\n    } else {\n      sizeStr = sSize;\n      mediaStr = undefined;\n    }\n    sizes.push({\n      mediaQuery: mediaStr,\n      size: func\n        ? sizeStr\n        : opt_allowPercentAsLength\n        ? assertLengthOrPercent(sizeStr)\n        : assertLength(sizeStr),\n    });\n  });\n  return new SizeList(sizes);\n}\n\n/**\n * A SizeList object contains one or more sizes as typically seen in \"sizes\"\n * attribute.\n *\n * See \"select\" method for details on how the size selection is performed.\n *\n * See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/img#Attributes\n * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n */\nexport class SizeList {\n  /**\n   * @param {!Array<!SizeListOptionDef>} sizes\n   */\n  constructor(sizes) {\n    userAssert(sizes.length > 0, 'SizeList must have at least one option');\n    /** @private @const {!Array<!SizeListOptionDef>} */\n    this.sizes_ = sizes;\n\n    // All sources except for last must have a media query. The last one must\n    // not.\n    for (let i = 0; i < sizes.length; i++) {\n      const option = sizes[i];\n      if (i < sizes.length - 1) {\n        userAssert(\n          option.mediaQuery,\n          'All options except for the last must have a media condition'\n        );\n      } else {\n        userAssert(\n          !option.mediaQuery,\n          'The last option must not have a media condition'\n        );\n      }\n    }\n  }\n\n  /**\n   * Selects the first size that matches media conditions. If no options match,\n   * the last option is returned.\n   *\n   * See http://www.w3.org/html/wg/drafts/html/master/semantics.html#attr-img-sizes\n   * @param {!Window} win\n   * @return {!./layout.LengthDef|string}\n   */\n  select(win) {\n    const sizes = this.sizes_;\n    const length = sizes.length - 1;\n\n    // Iterate all but the last size\n    for (let i = 0; i < length; i++) {\n      const option = sizes[i];\n      // Only the last item (which we don't iterate) has an undefined\n      // mediaQuery.\n      const query = /** @type {string} */ (option.mediaQuery);\n      if (win.matchMedia(query).matches) {\n        return option.size;\n      }\n    }\n\n    // Returns the last size in the SizeList, which is the default.\n    return sizes[length].size;\n  }\n}\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from './log';\nimport {map} from './utils/object.js';\n\nlet htmlContainer;\nlet svgContainer;\n\n/**\n * Creates the html helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\nexport function htmlFor(nodeOrDoc) {\n  const doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n  if (!htmlContainer || htmlContainer.ownerDocument !== doc) {\n    htmlContainer = doc.createElement('div');\n  }\n\n  return html;\n}\n\n/**\n * Creates the svg helper for the doc.\n *\n * @param {!Element|!Document} nodeOrDoc\n * @return {function(!Array<string>):!Element}\n */\nexport function svgFor(nodeOrDoc) {\n  const doc = nodeOrDoc.ownerDocument || nodeOrDoc;\n  if (!svgContainer || svgContainer.ownerDocument !== svgContainer) {\n    svgContainer = doc.createElementNS('http://www.w3.org/2000/svg', 'svg');\n  }\n\n  return svg;\n}\n\n/**\n * A tagged template literal helper to generate static SVG trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const circle = svg`<circle cx=\"60\" cy=\"60\" r=\"22\"></circle>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction svg(strings) {\n  return createNode(svgContainer, strings);\n}\n\n/**\n * A tagged template literal helper to generate static DOM trees.\n * This must be used as a tagged template, ie\n *\n * ```\n * const div = html`<div><span></span></div>`;\n * ```\n *\n * Only the root element and its subtree will be returned. DO NOT use this to\n * render subtree's with dynamic content, it WILL result in an error!\n *\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction html(strings) {\n  return createNode(htmlContainer, strings);\n}\n\n/**\n * Helper used by html and svg string literal functions.\n * @param {!Element} container\n * @param {!Array<string>} strings\n * @return {!Element}\n */\nfunction createNode(container, strings) {\n  devAssert(strings.length === 1, 'Improper html template tag usage.');\n  container./*OK*/ innerHTML = strings[0];\n\n  const el = container.firstElementChild;\n  devAssert(el, 'No elements in template');\n  devAssert(!el.nextElementSibling, 'Too many root elements in template');\n\n  // Clear to free memory.\n  container.removeChild(el);\n\n  return el;\n}\n\n/**\n * Queries an element for all elements with a \"ref\" attribute, removing\n * the attribute afterwards.\n * Returns a named map of all ref elements.\n *\n * @param {!Element} root\n * @return {!Object<string, !Element>}\n */\nexport function htmlRefs(root) {\n  const elements = root.querySelectorAll('[ref]');\n  const refs = map();\n\n  for (let i = 0; i < elements.length; i++) {\n    const element = elements[i];\n    const ref = devAssert(element.getAttribute('ref'), 'Empty ref attr');\n    element.removeAttribute('ref');\n    devAssert(refs[ref] === undefined, 'Duplicate ref');\n    refs[ref] = element;\n  }\n\n  return refs;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @param {string} _match\n * @param {string} character\n * @return {string}\n */\nfunction toUpperCase(_match, character) {\n  return character.toUpperCase();\n}\n\n/**\n * @param {string} match\n * @return {string}\n */\nfunction prependDashAndToLowerCase(match) {\n  return '-' + match.toLowerCase();\n}\n\n/**\n * @param {string} name Attribute name containing dashes.\n * @return {string} Dashes removed and successive character sent to upper case.\n * visibleForTesting\n */\nexport function dashToCamelCase(name) {\n  return name.replace(/-([a-z])/g, toUpperCase);\n}\n\n/**\n * Converts a string that is in camelCase to one that is in dash-case.\n *\n * @param {string} string The string to convert.\n * @return {string} The string in dash-case.\n */\nexport function camelCaseToDash(string) {\n  return string.replace(/(?!^)[A-Z]/g, prependDashAndToLowerCase);\n}\n\n/**\n * @param {string} name Attribute name with dashes\n * @return {string} Dashes replaced by underlines.\n */\nexport function dashToUnderline(name) {\n  return name.replace('-', '_');\n}\n\n/**\n * Polyfill for String.prototype.endsWith.\n * @param {string} string\n * @param {string} suffix\n * @return {boolean}\n */\nexport function endsWith(string, suffix) {\n  const index = string.length - suffix.length;\n  return index >= 0 && string.indexOf(suffix, index) == index;\n}\n\n/**\n * Polyfill for String.prototype.startsWith.\n * @param {string} string\n * @param {string} prefix\n * @return {boolean}\n */\nexport function startsWith(string, prefix) {\n  if (prefix.length > string.length) {\n    return false;\n  }\n  return string.lastIndexOf(prefix, 0) == 0;\n}\n\n/**\n * Polyfill for String.prototype.includes.\n * @param {string} string\n * @param {string} substring\n * @param {number=} start\n * @return {boolean}\n */\nexport function includes(string, substring, start) {\n  if (typeof start !== 'number') {\n    start = 0;\n  }\n  if (start + substring.length > string.length) {\n    return false;\n  }\n  return string.indexOf(substring, start) !== -1;\n}\n\n/**\n * Expands placeholders in a given template string with values.\n *\n * Placeholders use ${key-name} syntax and are replaced with the value\n * returned from the given getter function.\n *\n * @param {string} template The template string to expand.\n * @param {function(string):*} getter Function used to retrieve a value for a\n *   placeholder. Returns values will be coerced into strings.\n * @param {number=} opt_maxIterations Number of times to expand the template.\n *   Defaults to 1, but should be set to a larger value your placeholder tokens\n *   can be expanded to other placeholder tokens. Take caution with large values\n *   as recursively expanding a string can be exponentially expensive.\n * @return {string}\n */\nexport function expandTemplate(template, getter, opt_maxIterations) {\n  const maxIterations = opt_maxIterations || 1;\n  for (let i = 0; i < maxIterations; i++) {\n    let matches = 0;\n    template = template.replace(/\\${([^}]*)}/g, (_a, b) => {\n      matches++;\n      return getter(b);\n    });\n    if (!matches) {\n      break;\n    }\n  }\n  return template;\n}\n\n/**\n * Hash function djb2a\n * This is intended to be a simple, fast hashing function using minimal code.\n * It does *not* have good cryptographic properties.\n * @param {string} str\n * @return {string} 32-bit unsigned hash of the string\n */\nexport function stringHash32(str) {\n  const {length} = str;\n  let hash = 5381;\n  for (let i = 0; i < length; i++) {\n    hash = (hash * 33) ^ str.charCodeAt(i);\n  }\n  // Convert from 32-bit signed to unsigned.\n  return String(hash >>> 0);\n}\n\n/**\n * Trims a string on the end, removing whitespace characters.\n * @param {string} str  A string to trim.\n * @return {string} The string, with trailing whitespace removed.\n */\nexport function trimEnd(str) {\n  // TODO(sparhami) Does this get inlined for an ES2019 build?\n  if (str.trimEnd) {\n    return str.trimEnd();\n  }\n\n  return ('_' + str).trim().slice(1);\n}\n\n/**\n * Trims any leading whitespace from a string.\n * @param {string} str  A string to trim.\n * @return {string} The string, with leading whitespace removed.\n */\nexport function trimStart(str) {\n  if (str.trimStart) {\n    return str.trimStart();\n  }\n\n  return (str + '_').trim().slice(0, -1);\n}\n\n/**\n * Pads the beginning of a string with a substring to a target length.\n * @param {string} s\n * @param {number} targetLength\n * @param {string} padString\n * @return {*} TODO(#23582): Specify return type\n */\nexport function padStart(s, targetLength, padString) {\n  if (s.length >= targetLength) {\n    return s;\n  }\n  targetLength = targetLength - s.length;\n  let padding = padString;\n  while (targetLength > padding.length) {\n    padding += padString;\n  }\n  return padding.slice(0, targetLength) + s;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {CommonSignals} from './common-signals';\nimport {Services} from './services';\nimport {dev, devAssert, rethrowAsync} from './log';\nimport {getAmpdoc} from './service';\nimport {insertAfterOrAtStart, waitForBodyOpenPromise} from './dom';\nimport {map} from './utils/object';\nimport {setStyles} from './style';\nimport {waitForServices} from './render-delaying-services';\n\nconst TRANSFORMER_PROP = '__AMP_CSS_TR';\nconst STYLE_MAP_PROP = '__AMP_CSS_SM';\n\n/**\n * Adds the given css text to the given ampdoc.\n *\n * The style tags will be at the beginning of the head before all author\n * styles. One element can be the main runtime CSS. This is guaranteed\n * to always be the first stylesheet in the doc.\n *\n * @param {!./service/ampdoc-impl.AmpDoc} ampdoc The ampdoc that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are available.\n *     Not using a promise, because this is synchronous when possible.\n *     for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\nexport function installStylesForDoc(\n  ampdoc,\n  cssText,\n  cb,\n  opt_isRuntimeCss,\n  opt_ext\n) {\n  const cssRoot = ampdoc.getHeadNode();\n  const style = insertStyleElement(\n    cssRoot,\n    maybeTransform(cssRoot, cssText),\n    opt_isRuntimeCss || false,\n    opt_ext || null\n  );\n\n  if (cb) {\n    const rootNode = ampdoc.getRootNode();\n    // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n    if (styleLoaded(rootNode, style)) {\n      cb(style);\n      return style;\n    }\n    // Poll until styles are available.\n    const interval = setInterval(() => {\n      if (styleLoaded(rootNode, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n  return style;\n}\n\n/**\n * Adds the given css text to the given document.\n * TODO(dvoytenko, #22733): Remove this method once FIE/ampdoc migration is\n * done.\n *\n * @param {!Document} doc The document that should get the new styles.\n * @param {string} cssText\n * @param {?function(!Element)|undefined} cb Called when the new styles are\n *     available. Not using a promise, because this is synchronous when\n *     possible. for better performance.\n * @param {boolean=} opt_isRuntimeCss If true, this style tag will be inserted\n *     as the first element in head and all style elements will be positioned\n *     after.\n * @param {string=} opt_ext\n * @return {!Element}\n */\nexport function installStylesLegacy(\n  doc,\n  cssText,\n  cb,\n  opt_isRuntimeCss,\n  opt_ext\n) {\n  const style = insertStyleElement(\n    dev().assertElement(doc.head),\n    cssText,\n    opt_isRuntimeCss || false,\n    opt_ext || null\n  );\n\n  if (cb) {\n    // Styles aren't always available synchronously. E.g. if there is a\n    // pending style download, it will have to finish before the new\n    // style is visible.\n    // For this reason we poll until the style becomes available.\n    // Sync case.\n    if (styleLoaded(doc, style)) {\n      cb(style);\n      return style;\n    }\n    // Poll until styles are available.\n    const interval = setInterval(() => {\n      if (styleLoaded(doc, style)) {\n        clearInterval(interval);\n        cb(style);\n      }\n    }, 4);\n  }\n  return style;\n}\n\n/**\n * Creates the properly configured style element.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @param {boolean} isRuntimeCss\n * @param {?string} ext\n * @return {!Element}\n */\nfunction insertStyleElement(cssRoot, cssText, isRuntimeCss, ext) {\n  let styleMap = cssRoot[STYLE_MAP_PROP];\n  if (!styleMap) {\n    styleMap = cssRoot[STYLE_MAP_PROP] = map();\n  }\n\n  const isExtCss =\n    !isRuntimeCss && (ext && ext != 'amp-custom' && ext != 'amp-keyframes');\n  const key = isRuntimeCss\n    ? 'amp-runtime'\n    : isExtCss\n    ? `amp-extension=${ext}`\n    : null;\n\n  // Check if it has already been created or discovered.\n  if (key) {\n    const existing = getExistingStyleElement(cssRoot, styleMap, key);\n    if (existing) {\n      if (existing.textContent !== cssText) {\n        existing.textContent = cssText;\n      }\n      return existing;\n    }\n  }\n\n  // Create the new style element and append to cssRoot.\n  const doc = cssRoot.ownerDocument || cssRoot;\n  const style = doc.createElement('style');\n  style./*OK*/ textContent = cssText;\n  let afterElement = null;\n  // Make sure that we place style tags after the main runtime CSS. Otherwise\n  // the order is random.\n  if (isRuntimeCss) {\n    style.setAttribute('amp-runtime', '');\n  } else if (isExtCss) {\n    style.setAttribute('amp-extension', ext || '');\n    afterElement = dev().assertElement(\n      getExistingStyleElement(cssRoot, styleMap, 'amp-runtime')\n    );\n  } else {\n    if (ext) {\n      style.setAttribute(ext, '');\n    }\n    afterElement = cssRoot.lastChild;\n  }\n  insertAfterOrAtStart(cssRoot, style, afterElement);\n  if (key) {\n    styleMap[key] = style;\n  }\n  return style;\n}\n\n/**\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {!Object<string, !Element>} styleMap\n * @param {string} key\n * @return {?Element}\n */\nfunction getExistingStyleElement(cssRoot, styleMap, key) {\n  // Already cached.\n  if (styleMap[key]) {\n    return styleMap[key];\n  }\n  // Check if the style has already been added by the server layout.\n  const existing = cssRoot./*OK*/ querySelector(`style[${key}]`);\n  if (existing) {\n    styleMap[key] = existing;\n    return existing;\n  }\n  // Nothing found.\n  return null;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {function(string):string} transformer\n */\nexport function installCssTransformer(cssRoot, transformer) {\n  cssRoot[TRANSFORMER_PROP] = transformer;\n}\n\n/**\n * Applies a transformer to the CSS text if it has been registered.\n * @param {!Element|!ShadowRoot} cssRoot\n * @param {string} cssText\n * @return {string}\n */\nfunction maybeTransform(cssRoot, cssText) {\n  const transformer = cssRoot[TRANSFORMER_PROP];\n  return transformer ? transformer(cssText) : cssText;\n}\n\n/** @private {boolean} */\nlet bodyMadeVisible = false;\n\n/**\n * @param {boolean} value\n * @visibleForTesting\n */\nexport function setBodyMadeVisibleForTesting(value) {\n  bodyMadeVisible = value;\n}\n\n/**\n * Sets the document's body opacity to 1.\n * If the body is not yet available (because our script was loaded\n * synchronously), polls until it is.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisible(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  const win = /** @type {!Window} */ (doc.defaultView);\n  waitForBodyOpenPromise(doc)\n    .then(() => {\n      return waitForServices(win);\n    })\n    .catch(reason => {\n      rethrowAsync(reason);\n      return [];\n    })\n    .then(services => {\n      bodyMadeVisible = true;\n      setBodyVisibleStyles(doc);\n      const ampdoc = getAmpdoc(doc);\n      ampdoc.signals().signal(CommonSignals.RENDER_START);\n      if (services.length > 0) {\n        const resources = Services.resourcesForDoc(doc.documentElement);\n        resources./*OK*/ schedulePass(1, /* relayoutAll */ true);\n      }\n      try {\n        const perf = Services.performanceFor(win);\n        perf.tick('mbv');\n        perf.flush();\n      } catch (e) {}\n    });\n}\n\n/**\n * Set the document's body opacity to 1. Called in error cases.\n * @param {!Document} doc The document who's body we should make visible.\n */\nexport function makeBodyVisibleRecovery(doc) {\n  devAssert(doc.defaultView, 'Passed in document must have a defaultView');\n  if (bodyMadeVisible) {\n    return;\n  }\n  bodyMadeVisible = true;\n  setBodyVisibleStyles(doc);\n}\n\n/**\n * Make sure that body exists, and make it visible.\n * @param {!Document} doc\n */\nfunction setBodyVisibleStyles(doc) {\n  setStyles(dev().assertElement(doc.body), {\n    opacity: 1,\n    visibility: 'visible',\n    'animation': 'none',\n  });\n}\n\n/**\n * Indicates that the body is always visible. For instance, in case of PWA.\n * This check is on a module level variable, and could be problematic if you are\n * relying on this function across different binaries.\n * @param {!Window} unusedWin\n */\nexport function bodyAlwaysVisible(unusedWin) {\n  bodyMadeVisible = true;\n}\n\n/**\n * Checks whether a style element was registered in the DOM.\n * @param {!Document|!ShadowRoot} doc\n * @param {!Element} style\n * @return {boolean}\n */\nfunction styleLoaded(doc, style) {\n  const sheets = doc.styleSheets;\n  for (let i = 0; i < sheets.length; i++) {\n    const sheet = sheets[i];\n    if (sheet.ownerNode == style) {\n      return true;\n    }\n  }\n  return false;\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// Note: loaded by 3p system. Cannot rely on babel polyfills.\nimport {dev, devAssert} from './log';\nimport {map} from './utils/object.js';\nimport {startsWith} from './string';\n\n/** @type {Object<string, string>} */\nlet propertyNameCache;\n\n/** @const {!Array<string>} */\nconst vendorPrefixes = ['Webkit', 'webkit', 'Moz', 'moz', 'ms', 'O', 'o'];\n\n/**\n * @export\n * @param {string} camelCase camel cased string\n * @return {string} title cased string\n */\nexport function camelCaseToTitleCase(camelCase) {\n  return camelCase.charAt(0).toUpperCase() + camelCase.slice(1);\n}\n\n/**\n  Checks the style if a prefixed version of a property exists and returns\n * it or returns an empty string.\n * @private\n * @param {!Object} style\n * @param {string} titleCase the title case version of a css property name\n * @return {string} the prefixed property name or null.\n */\nfunction getVendorJsPropertyName_(style, titleCase) {\n  for (let i = 0; i < vendorPrefixes.length; i++) {\n    const propertyName = vendorPrefixes[i] + titleCase;\n    if (style[propertyName] !== undefined) {\n      return propertyName;\n    }\n  }\n  return '';\n}\n\n/**\n * Returns the possibly prefixed JavaScript property name of a style property\n * (ex. WebkitTransitionDuration) given a camelCase'd version of the property\n * (ex. transitionDuration).\n * @export\n * @param {!Object} style\n * @param {string} camelCase the camel cased version of a css property name\n * @param {boolean=} opt_bypassCache bypass the memoized cache of property\n *   mapping\n * @return {string}\n */\nexport function getVendorJsPropertyName(style, camelCase, opt_bypassCache) {\n  if (startsWith(camelCase, '--')) {\n    // CSS vars are returned as is.\n    return camelCase;\n  }\n  if (!propertyNameCache) {\n    propertyNameCache = map();\n  }\n  let propertyName = propertyNameCache[camelCase];\n  if (!propertyName || opt_bypassCache) {\n    propertyName = camelCase;\n    if (style[camelCase] === undefined) {\n      const titleCase = camelCaseToTitleCase(camelCase);\n      const prefixedPropertyName = getVendorJsPropertyName_(style, titleCase);\n\n      if (style[prefixedPropertyName] !== undefined) {\n        propertyName = prefixedPropertyName;\n      }\n    }\n    if (!opt_bypassCache) {\n      propertyNameCache[camelCase] = propertyName;\n    }\n  }\n  return propertyName;\n}\n\n/**\n * Sets the CSS styles of the specified element with !important. The styles\n * are specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setImportantStyles(element, styles) {\n  const {style} = element;\n  for (const k in styles) {\n    style.setProperty(\n      getVendorJsPropertyName(style, k),\n      styles[k].toString(),\n      'important'\n    );\n  }\n}\n\n/**\n * Sets the CSS style of the specified element with optional units, e.g. \"px\".\n * @param {?Element} element\n * @param {string} property\n * @param {*} value\n * @param {string=} opt_units\n * @param {boolean=} opt_bypassCache\n */\nexport function setStyle(element, property, value, opt_units, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (propertyName) {\n    element.style[propertyName] = /** @type {string} */ (opt_units\n      ? value + opt_units\n      : value);\n  }\n}\n\n/**\n * Returns the value of the CSS style of the specified element.\n * @param {!Element} element\n * @param {string} property\n * @param {boolean=} opt_bypassCache\n * @return {*}\n */\nexport function getStyle(element, property, opt_bypassCache) {\n  const propertyName = getVendorJsPropertyName(\n    element.style,\n    property,\n    opt_bypassCache\n  );\n  if (!propertyName) {\n    return undefined;\n  }\n  return element.style[propertyName];\n}\n\n/**\n * Sets the CSS styles of the specified element. The styles\n * a specified as a map from CSS property names to their values.\n * @param {!Element} element\n * @param {!Object<string, *>} styles\n */\nexport function setStyles(element, styles) {\n  for (const k in styles) {\n    setStyle(element, k, styles[k]);\n  }\n}\n\n/**\n * Asserts that the style is not the `display` style.\n * This is the only possible way to pass a dynamic style to setStyle.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {string} style\n * @return {string}\n */\nexport function assertNotDisplay(style) {\n  if (style === 'display') {\n    dev().error(\n      'STYLE',\n      '`display` style detected. You must use toggle instead.'\n    );\n  }\n  return style;\n}\n\n/**\n * Asserts that the styles does not contain the `display` style.\n * This is the only possible way to pass a dynamic styles object to setStyles\n * and setImportantStyles.\n *\n * If you wish to set `display`, use the `toggle` helper instead. This is so\n * changes to display can trigger necessary updates. See #17475.\n *\n * @param {!Object<string, *>} styles\n * @return {!Object<string, *>}\n */\nexport function assertDoesNotContainDisplay(styles) {\n  if ('display' in styles) {\n    dev().error(\n      'STYLE',\n      '`display` style detected in styles. You must use toggle instead.'\n    );\n  }\n  return styles;\n}\n\n/**\n * Sets the initial display style of an element. This is a last resort. If you\n * can set the initial display using CSS, YOU MUST.\n * DO NOT USE THIS TO ARBITRARILY SET THE DISPLAY STYLE AFTER INITIAL SETUP.\n *\n * @param {!Element} el\n * @param {string} value\n */\nexport function setInitialDisplay(el, value) {\n  const {style} = el;\n  devAssert(\n    value !== '' && value !== 'none',\n    'Initial display value must not be \"none\". Use toggle instead.'\n  );\n  devAssert(\n    !style['display'],\n    'setInitialDisplay MUST NOT be used for ' +\n      'resetting the display style. If you are looking for display:none ' +\n      'toggling, use toggle instead.'\n  );\n  style['display'] = value;\n}\n\n/**\n * Shows or hides the specified element.\n * @param {!Element} element\n * @param {boolean=} opt_display\n */\nexport function toggle(element, opt_display) {\n  if (opt_display === undefined) {\n    opt_display = element.hasAttribute('hidden');\n  }\n  if (opt_display) {\n    element.removeAttribute('hidden');\n  } else {\n    element.setAttribute('hidden', '');\n  }\n}\n\n/**\n * Returns a pixel value.\n * @param {number} value\n * @return {string}\n */\nexport function px(value) {\n  return `${value}px`;\n}\n\n/**\n * Returns a degree value.\n * @param {number} value\n * @return {string}\n */\nexport function deg(value) {\n  return `${value}deg`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function translateX(value) {\n  if (typeof value == 'string') {\n    return `translateX(${value})`;\n  }\n  return `translateX(${px(value)})`;\n}\n\n/**\n * Returns a \"translateX\" for CSS \"transform\" property.\n * @param {number|string} x\n * @param {(number|string)=} opt_y\n * @return {string}\n */\nexport function translate(x, opt_y) {\n  if (typeof x == 'number') {\n    x = px(x);\n  }\n  if (opt_y === undefined) {\n    return `translate(${x})`;\n  }\n  if (typeof opt_y == 'number') {\n    opt_y = px(opt_y);\n  }\n  return `translate(${x}, ${opt_y})`;\n}\n\n/**\n * Returns a \"scale\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function scale(value) {\n  return `scale(${value})`;\n}\n\n/**\n * Returns a \"rotate\" for CSS \"transform\" property.\n * @param {number|string} value\n * @return {string}\n */\nexport function rotate(value) {\n  if (typeof value == 'number') {\n    value = deg(value);\n  }\n  return `rotate(${value})`;\n}\n\n/**\n * Remove alpha value from a rgba color value.\n * Return the new color property with alpha equals if has the alpha value.\n * Caller needs to make sure the input color value is a valid rgba/rgb value\n * @param {string} rgbaColor\n * @return {string}\n */\nexport function removeAlphaFromColor(rgbaColor) {\n  return rgbaColor.replace(\n    /\\(([^,]+),([^,]+),([^,)]+),[^)]+\\)/g,\n    '($1,$2,$3, 1)'\n  );\n}\n\n/**\n * Gets the computed style of the element. The helper is necessary to enforce\n * the possible `null` value returned by a buggy Firefox.\n *\n * @param {!Window} win\n * @param {!Element} el\n * @return {!Object<string, string>}\n */\nexport function computedStyle(win, el) {\n  const style = /** @type {?CSSStyleDeclaration} */ (win.getComputedStyle(el));\n  return /** @type {!Object<string, string>} */ (style) || map();\n}\n\n/**\n * Resets styles that were set dynamically (i.e. inline)\n * @param {!Element} element\n * @param {!Array<string>} properties\n */\nexport function resetStyles(element, properties) {\n  for (let i = 0; i < properties.length; i++) {\n    setStyle(element, properties[i], null);\n  }\n}\n\n/**\n * Propagates the object-fit/position element attributes as styles.\n * @param {!Element} fromEl ie: amp-img\n * @param {!Element} toEl ie: the img within amp-img\n */\nexport function propagateObjectFitStyles(fromEl, toEl) {\n  if (fromEl.hasAttribute('object-fit')) {\n    setStyle(toEl, 'object-fit', fromEl.getAttribute('object-fit'));\n  }\n\n  if (fromEl.hasAttribute('object-position')) {\n    setStyle(toEl, 'object-position', fromEl.getAttribute('object-position'));\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Absolute time in milliseconds.\n * @typedef {number}\n */\nexport let timeDef;\n\n/**\n * Number between 0 and 1 that designates normalized time, as in \"from start to\n * end\".\n * @typedef {number}\n */\nexport let normtimeDef;\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as st from './style';\nimport {assertNotDisplay, setStyle} from './style';\nimport {getCurve} from './curve';\n\nexport const NOOP = function(unusedTime) {\n  return null;\n};\n\n/**\n * Returns a transition that combines a number of other transitions and\n * invokes them all in parallel.\n * @param {!Array<!TransitionDef>} transitions\n * @return {!TransitionDef<void>}\n */\nexport function all(transitions) {\n  return (time, complete) => {\n    for (let i = 0; i < transitions.length; i++) {\n      const tr = transitions[i];\n      tr(time, complete);\n    }\n  };\n}\n\n/**\n * Returns a transition that combines the string result of other string-based\n * transitions such as transform and scale using the given opt_delimiter.\n * @param {!Array<!TransitionDef<string>>} transitions\n * @param {string=} opt_delimiter Defaults to a single whitespace.\n * @return {!TransitionDef<string>}\n */\nexport function concat(transitions, opt_delimiter = ' ') {\n  return (time, complete) => {\n    const results = [];\n    for (let i = 0; i < transitions.length; i++) {\n      const tr = transitions[i];\n      const result = tr(time, complete);\n      if (typeof result == 'string') {\n        results.push(result);\n      }\n    }\n    return results.join(opt_delimiter);\n  };\n}\n\n/**\n * Returns the specified transition with the time curved via specified curve\n * function.\n * @param {!TransitionDef<RESULT>} transition\n * @param {!./curve.CurveDef|string} curve\n * @return {!TransitionDef<RESULT>}\n * @template RESULT\n */\nexport function withCurve(transition, curve) {\n  /** @const {?./curve.CurveDef} */\n  const curveFn = getCurve(curve);\n  return (time, complete) => {\n    return transition(complete ? 1 : curveFn(time), complete);\n  };\n}\n\n/**\n * A transition that sets the CSS style of the specified element. The styles\n * a specified as a map from CSS property names to transition functions for\n * each of these properties.\n * @param {!Element} element\n * @param {!Object<string, !TransitionDef>} styles\n * @return {!TransitionDef<void>}\n */\nexport function setStyles(element, styles) {\n  return (time, complete) => {\n    for (const k in styles) {\n      setStyle(element, assertNotDisplay(k), styles[k](time, complete));\n    }\n  };\n}\n\n/**\n * A basic numeric interpolation.\n * @param {number} start\n * @param {number} end\n * @return {!TransitionDef<number>}\n */\nexport function numeric(start, end) {\n  return time => {\n    return start + (end - start) * time;\n  };\n}\n\n/**\n * Spring numeric interpolation.\n * @param {number} start\n * @param {number} end\n * @param {number} extended\n * @param {number} threshold\n * @return {!TransitionDef<number>}\n */\nexport function spring(start, end, extended, threshold) {\n  if (end == extended) {\n    return time => {\n      return numeric(start, end)(time);\n    };\n  }\n  return time => {\n    if (time < threshold) {\n      return start + (extended - start) * (time / threshold);\n    }\n    return extended + (end - extended) * ((time - threshold) / (1 - threshold));\n  };\n}\n\n/**\n * Adds \"px\" units.\n * @param {!TransitionDef<number>} transition\n * @return {!TransitionDef<string>}\n */\nexport function px(transition) {\n  return time => {\n    return transition(time) + 'px';\n  };\n}\n\n/**\n * A transition for \"translateX\" of CSS \"transform\" property.\n * @param {!TransitionDef<number|string>} transition\n * @return {!TransitionDef<string>}\n */\nexport function translateX(transition) {\n  return time => {\n    const res = transition(time);\n    if (typeof res == 'string') {\n      return `translateX(${res})`;\n    }\n    return `translateX(${res}px)`;\n  };\n}\n\n/**\n * A transition for \"translateY\" of CSS \"transform\" property.\n * @param {!TransitionDef<number|string>} transition\n * @return {!TransitionDef<string>}\n */\nexport function translateY(transition) {\n  return time => {\n    const res = transition(time);\n    if (typeof res == 'string') {\n      return `translateY(${res})`;\n    }\n    return `translateY(${res}px)`;\n  };\n}\n\n/**\n * A transition for \"translate(x, y)\" of CSS \"transform\" property.\n * @param {!TransitionDef<number|string>} transitionX\n * @param {!TransitionDef<number|string>|undefined} opt_transitionY\n * @return {!TransitionDef<string>}\n */\nexport function translate(transitionX, opt_transitionY) {\n  return time => {\n    let x = transitionX(time);\n    if (typeof x == 'number') {\n      x = st.px(x);\n    }\n    if (!opt_transitionY) {\n      return `translate(${x})`;\n    }\n\n    let y = opt_transitionY(time);\n    if (typeof y == 'number') {\n      y = st.px(y);\n    }\n    return `translate(${x},${y})`;\n  };\n}\n\n/**\n * A transition for \"scale\" of CSS \"transform\" property.\n * @param {!TransitionDef<number|string>} transition\n * @return {!TransitionDef<string>}\n */\nexport function scale(transition) {\n  return time => {\n    return `scale(${transition(time)})`;\n  };\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* @const */\nconst toString_ = Object.prototype.toString;\n\n/**\n * Returns the ECMA [[Class]] of a value\n * @param {*} value\n * @return {string}\n */\nfunction toString(value) {\n  return toString_.call(value);\n}\n\n/**\n * Determines if value is actually an Array.\n * @param {*} value\n * @return {boolean}\n */\nexport function isArray(value) {\n  return Array.isArray(value);\n}\n\n/**\n * Converts an array-like object to an array.\n * @param {?IArrayLike<T>|string} arrayLike\n * @return {!Array<T>}\n * @template T\n */\nexport function toArray(arrayLike) {\n  return arrayLike ? Array.prototype.slice.call(arrayLike) : [];\n}\n\n/**\n * Determines if value is actually an Object.\n * @param {*} value\n * @return {boolean}\n */\nexport function isObject(value) {\n  return toString(value) === '[object Object]';\n}\n\n/**\n * Determines if value is of number type and finite.\n * NaN and Infinity are not considered a finite number.\n * String numbers are not considered numbers.\n * @param {*} value\n * @return {boolean}\n */\nexport function isFiniteNumber(value) {\n  return typeof value === 'number' && isFinite(value);\n}\n\n/**\n * Checks whether `s` is a valid value of `enumObj`.\n *\n * @param {!Object<T>} enumObj\n * @param {T} s\n * @return {boolean}\n * @template T\n */\nexport function isEnumValue(enumObj, s) {\n  for (const k in enumObj) {\n    if (enumObj[k] === s) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Externs declare that access `defaultView` from `document` or\n * `ownerDocument` is of type `(Window|null)` but most of our parameter types\n * assume that it is never null. This is OK in practice as we ever only get\n * null on disconnected documents or old IE.\n * This helper function casts it into just a simple Window return type.\n *\n * @param {!Window|null} winOrNull\n * @return {!Window}\n */\nexport function toWin(winOrNull) {\n  return /** @type {!Window} */ (winOrNull);\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {tryDecodeUriComponent_} from './url-try-decode-uri-component';\n\nconst regex = /(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * DO NOT import the function from this file. Instead, import parseQueryString\n * from `src/url.js`.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString_(queryString) {\n  const params = /** @type {!JsonObject} */ (Object.create(null));\n  if (!queryString) {\n    return params;\n  }\n\n  let match;\n  while ((match = regex.exec(queryString))) {\n    const name = tryDecodeUriComponent_(match[1], match[1]);\n    const value = match[2]\n      ? tryDecodeUriComponent_(match[2].replace(/\\+/g, ' '), match[2])\n      : '';\n    params[name] = value;\n  }\n  return params;\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * DO NOT import the function from this file. Instead, import\n * tryDecodeUriComponent from `src/url.js`.\n *\n * @param {string} component\n * @param {string=} fallback\n * @return {string}\n */\nexport function tryDecodeUriComponent_(component, fallback = '') {\n  try {\n    return decodeURIComponent(component);\n  } catch (e) {\n    return fallback;\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {LruCache} from './utils/lru-cache';\nimport {dict, hasOwn} from './utils/object';\nimport {endsWith, startsWith} from './string';\nimport {getMode} from './mode';\nimport {isArray} from './types';\nimport {parseQueryString_} from './url-parse-query-string';\nimport {tryDecodeUriComponent_} from './url-try-decode-uri-component';\nimport {urls} from './config';\nimport {userAssert} from './log';\n\n/**\n * @type {!JsonObject}\n */\nconst SERVING_TYPE_PREFIX = dict({\n  // No viewer\n  'c': true,\n  // In viewer\n  'v': true,\n  // Ad landing page\n  'a': true,\n  // Ad\n  'ad': true,\n  // Actions viewer\n  'action': true,\n});\n\n/**\n * Cached a-tag to avoid memory allocation during URL parsing.\n * @type {HTMLAnchorElement}\n */\nlet a;\n\n/**\n * We cached all parsed URLs. As of now there are no use cases\n * of AMP docs that would ever parse an actual large number of URLs,\n * but we often parse the same one over and over again.\n * @type {LruCache}\n */\nlet cache;\n\n/** @private @const Matches amp_js_* parameters in query string. */\nconst AMP_JS_PARAMS_REGEX = /[?&]amp_js[^&]*/;\n\n/** @private @const Matches amp_gsa parameters in query string. */\nconst AMP_GSA_PARAMS_REGEX = /[?&]amp_gsa[^&]*/;\n\n/** @private @const Matches amp_r parameters in query string. */\nconst AMP_R_PARAMS_REGEX = /[?&]amp_r[^&]*/;\n\n/** @private @const Matches amp_kit parameters in query string. */\nconst AMP_KIT_PARAMS_REGEX = /[?&]amp_kit[^&]*/;\n\n/** @private @const Matches usqp parameters from goog experiment in query string. */\nconst GOOGLE_EXPERIMENT_PARAMS_REGEX = /[?&]usqp[^&]*/;\n\nconst INVALID_PROTOCOLS = [\n  /*eslint no-script-url: 0*/ 'javascript:',\n  /*eslint no-script-url: 0*/ 'data:',\n  /*eslint no-script-url: 0*/ 'vbscript:',\n];\n\n/** @const {string} */\nexport const SOURCE_ORIGIN_PARAM = '__amp_source_origin';\n\n/**\n * Returns the correct origin for a given window.\n * @param {!Window} win\n * @return {string} origin\n */\nexport function getWinOrigin(win) {\n  return win.origin || parseUrlDeprecated(win.location.href).origin;\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {string} url\n * @param {boolean=} opt_nocache\n * @return {!Location}\n */\nexport function parseUrlDeprecated(url, opt_nocache) {\n  if (!a) {\n    a = /** @type {!HTMLAnchorElement} */ (self.document.createElement('a'));\n    cache = self.__AMP_URL_CACHE || (self.__AMP_URL_CACHE = new LruCache(100));\n  }\n\n  return parseUrlWithA(a, url, opt_nocache ? null : cache);\n}\n\n/**\n * Returns a Location-like object for the given URL. If it is relative,\n * the URL gets resolved.\n * Consider the returned object immutable. This is enforced during\n * testing by freezing the object.\n * @param {!HTMLAnchorElement} a\n * @param {string} url\n * @param {LruCache=} opt_cache\n * @return {!Location}\n * @restricted\n */\nexport function parseUrlWithA(a, url, opt_cache) {\n  if (opt_cache && opt_cache.has(url)) {\n    return opt_cache.get(url);\n  }\n\n  a.href = url;\n\n  // IE11 doesn't provide full URL components when parsing relative URLs.\n  // Assigning to itself again does the trick #3449.\n  if (!a.protocol) {\n    a.href = a.href;\n  }\n\n  const info = /** @type {!Location} */ ({\n    href: a.href,\n    protocol: a.protocol,\n    host: a.host,\n    hostname: a.hostname,\n    port: a.port == '0' ? '' : a.port,\n    pathname: a.pathname,\n    search: a.search,\n    hash: a.hash,\n    origin: null, // Set below.\n  });\n\n  // Some IE11 specific polyfills.\n  // 1) IE11 strips out the leading '/' in the pathname.\n  if (info.pathname[0] !== '/') {\n    info.pathname = '/' + info.pathname;\n  }\n\n  // 2) For URLs with implicit ports, IE11 parses to default ports while\n  // other browsers leave the port field empty.\n  if (\n    (info.protocol == 'http:' && info.port == 80) ||\n    (info.protocol == 'https:' && info.port == 443)\n  ) {\n    info.port = '';\n    info.host = info.hostname;\n  }\n\n  // For data URI a.origin is equal to the string 'null' which is not useful.\n  // We instead return the actual origin which is the full URL.\n  let origin;\n  if (a.origin && a.origin != 'null') {\n    origin = a.origin;\n  } else if (info.protocol == 'data:' || !info.host) {\n    origin = info.href;\n  } else {\n    origin = info.protocol + '//' + info.host;\n  }\n  info.origin = origin;\n\n  // Freeze during testing to avoid accidental mutation.\n  const frozen = getMode().test && Object.freeze ? Object.freeze(info) : info;\n\n  if (opt_cache) {\n    opt_cache.put(url, frozen);\n  }\n\n  return frozen;\n}\n\n/**\n * Appends the string just before the fragment part (or optionally\n * to the front of the query string) of the URL.\n * @param {string} url\n * @param {string} paramString\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function appendEncodedParamStringToUrl(\n  url,\n  paramString,\n  opt_addToFront\n) {\n  if (!paramString) {\n    return url;\n  }\n  const mainAndFragment = url.split('#', 2);\n  const mainAndQuery = mainAndFragment[0].split('?', 2);\n\n  let newUrl =\n    mainAndQuery[0] +\n    (mainAndQuery[1]\n      ? opt_addToFront\n        ? `?${paramString}&${mainAndQuery[1]}`\n        : `?${mainAndQuery[1]}&${paramString}`\n      : `?${paramString}`);\n  newUrl += mainAndFragment[1] ? `#${mainAndFragment[1]}` : '';\n  return newUrl;\n}\n/**\n * Appends a query string field and value to a url. `key` and `value`\n * will be ran through `encodeURIComponent` before appending.\n * @param {string} url\n * @param {string} key\n * @param {string} value\n * @param {boolean=} opt_addToFront\n * @return {string}\n */\nexport function addParamToUrl(url, key, value, opt_addToFront) {\n  const field = `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;\n  return appendEncodedParamStringToUrl(url, field, opt_addToFront);\n}\n\n/**\n * Appends query string fields and values to a url. The `params` objects'\n * `key`s and `value`s will be transformed into query string keys/values.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addParamsToUrl(url, params) {\n  return appendEncodedParamStringToUrl(url, serializeQueryString(params));\n}\n\n/**\n * Append query string fields and values to a url, only if the key does not\n * exist in current query string.\n * @param {string} url\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function addMissingParamsToUrl(url, params) {\n  const location = parseUrlDeprecated(url);\n  const existingParams = parseQueryString(location.search);\n  const paramsToAdd = dict({});\n  const keys = Object.keys(params);\n  for (let i = 0; i < keys.length; i++) {\n    if (!hasOwn(existingParams, keys[i])) {\n      paramsToAdd[keys[i]] = params[keys[i]];\n    }\n  }\n  return addParamsToUrl(url, paramsToAdd);\n}\n\n/**\n * Serializes the passed parameter map into a query string with both keys\n * and values encoded.\n * @param {!JsonObject<string, string|!Array<string>>} params\n * @return {string}\n */\nexport function serializeQueryString(params) {\n  const s = [];\n  for (const k in params) {\n    const v = params[k];\n    if (v == null) {\n      continue;\n    } else if (isArray(v)) {\n      for (let i = 0; i < v.length; i++) {\n        const sv = /** @type {string} */ (v[i]);\n        s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n      }\n    } else {\n      const sv = /** @type {string} */ (v);\n      s.push(`${encodeURIComponent(k)}=${encodeURIComponent(sv)}`);\n    }\n  }\n  return s.join('&');\n}\n\n/**\n * Returns `true` if the URL is secure: either HTTPS or localhost (for testing).\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isSecureUrlDeprecated(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return (\n    url.protocol == 'https:' ||\n    url.hostname == 'localhost' ||\n    url.hostname == '127.0.0.1' ||\n    endsWith(url.hostname, '.localhost')\n  );\n}\n\n/**\n * Asserts that a given url is HTTPS or protocol relative. It's a user-level\n * assert.\n *\n * Provides an exception for localhost.\n *\n * @param {?string|undefined} urlString\n * @param {!Element|string} elementContext Element where the url was found.\n * @param {string=} sourceName Used for error messages.\n * @return {string}\n */\nexport function assertHttpsUrl(\n  urlString,\n  elementContext,\n  sourceName = 'source'\n) {\n  userAssert(\n    urlString != null,\n    '%s %s must be available',\n    elementContext,\n    sourceName\n  );\n  // (erwinm, #4560): type cast necessary until #4560 is fixed.\n  const theUrlString = /** @type {string} */ (urlString);\n  userAssert(\n    isSecureUrlDeprecated(theUrlString) || /^(\\/\\/)/.test(theUrlString),\n    '%s %s must start with ' +\n      '\"https://\" or \"//\" or be relative and served from ' +\n      'either https or from localhost. Invalid value: %s',\n    elementContext,\n    sourceName,\n    theUrlString\n  );\n  return theUrlString;\n}\n\n/**\n * Asserts that a given url is an absolute HTTP or HTTPS URL.\n * @param {string} urlString\n * @return {string}\n */\nexport function assertAbsoluteHttpOrHttpsUrl(urlString) {\n  userAssert(\n    /^https?\\:/i.test(urlString),\n    'URL must start with \"http://\" or \"https://\". Invalid value: %s',\n    urlString\n  );\n  return parseUrlDeprecated(urlString).href;\n}\n\n/**\n * Parses the query string of an URL. This method returns a simple key/value\n * map. If there are duplicate keys the latest value is returned.\n *\n * This function is implemented in a separate file to avoid a circular\n * dependency.\n *\n * @param {string} queryString\n * @return {!JsonObject}\n */\nexport function parseQueryString(queryString) {\n  return parseQueryString_(queryString);\n}\n\n/**\n * Returns the URL without fragment. If URL doesn't contain fragment, the same\n * string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function removeFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return url;\n  }\n  return url.substring(0, index);\n}\n\n/**\n * Returns the fragment from the URL. If the URL doesn't contain fragment,\n * the empty string is returned.\n * @param {string} url\n * @return {string}\n */\nexport function getFragment(url) {\n  const index = url.indexOf('#');\n  if (index == -1) {\n    return '';\n  }\n  return url.substring(index);\n}\n\n/**\n * Returns whether the URL has the origin of a proxy.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isProxyOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.cdnProxyRegex.test(url.origin);\n}\n\n/**\n * For proxy-origin URLs, returns the serving type. Otherwise, returns null.\n * E.g., 'https://amp-com.cdn.ampproject.org/a/s/amp.com/amp_document.html'\n * returns 'a'.\n * @param {string|!Location} url URL of an AMP document.\n * @return {?string}\n */\nexport function getProxyServingType(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  if (!isProxyOrigin(url)) {\n    return null;\n  }\n  const path = url.pathname.split('/', 2);\n  return path[1];\n}\n\n/**\n * Returns whether the URL origin is localhost.\n * @param {string|!Location} url URL of an AMP document.\n * @return {boolean}\n */\nexport function isLocalhostOrigin(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return urls.localhostRegex.test(url.origin);\n}\n\n/**\n * Returns whether the URL has valid protocol.\n * Deep link protocol is valid, but not javascript etc.\n * @param {string|!Location} url\n * @return {boolean}\n */\nexport function isProtocolValid(url) {\n  if (!url) {\n    return true;\n  }\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n  return !INVALID_PROTOCOLS.includes(url.protocol);\n}\n\n/**\n * Returns a URL without AMP JS parameters.\n * @param {string} url\n * @return {string}\n */\nexport function removeAmpJsParamsFromUrl(url) {\n  const parsed = parseUrlDeprecated(url);\n  const search = removeAmpJsParamsFromSearch(parsed.search);\n  return parsed.origin + parsed.pathname + search + parsed.hash;\n}\n\n/**\n * Returns a URL without a query string.\n * @param {string} url\n * @return {string}\n */\nexport function removeSearch(url) {\n  const index = url.indexOf('?');\n  if (index == -1) {\n    return url;\n  }\n  const fragment = getFragment(url);\n  return url.substring(0, index) + fragment;\n}\n\n/**\n * Removes parameters that start with amp js parameter pattern and returns the\n * new search string.\n * @param {string} urlSearch\n * @return {string}\n */\nfunction removeAmpJsParamsFromSearch(urlSearch) {\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const search = urlSearch\n    .replace(AMP_JS_PARAMS_REGEX, '')\n    .replace(AMP_GSA_PARAMS_REGEX, '')\n    .replace(AMP_R_PARAMS_REGEX, '')\n    .replace(AMP_KIT_PARAMS_REGEX, '')\n    .replace(GOOGLE_EXPERIMENT_PARAMS_REGEX, '')\n    .replace(/^[?&]/, ''); // Removes first ? or &.\n  return search ? '?' + search : '';\n}\n\n/**\n * Removes parameters with param name and returns the new search string.\n * @param {string} urlSearch\n * @param {string} paramName\n * @return {string}\n */\nexport function removeParamsFromSearch(urlSearch, paramName) {\n  // TODO: reuse the function in removeAmpJsParamsFromSearch. Accept paramNames\n  // as an array.\n  if (!urlSearch || urlSearch == '?') {\n    return '';\n  }\n  const paramRegex = new RegExp(`[?&]${paramName}=[^&]*`, 'g');\n  const search = urlSearch.replace(paramRegex, '').replace(/^[?&]/, '');\n  return search ? '?' + search : '';\n}\n\n/**\n * Returns the source URL of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string}\n */\nexport function getSourceUrl(url) {\n  if (typeof url == 'string') {\n    url = parseUrlDeprecated(url);\n  }\n\n  // Not a proxy URL - return the URL itself.\n  if (!isProxyOrigin(url)) {\n    return url.href;\n  }\n\n  // A proxy URL.\n  // Example path that is being matched here.\n  // https://cdn.ampproject.org/c/s/www.origin.com/foo/\n  // The /s/ is optional and signals a secure origin.\n  const path = url.pathname.split('/');\n  const prefix = path[1];\n  userAssert(\n    SERVING_TYPE_PREFIX[prefix],\n    'Unknown path prefix in url %s',\n    url.href\n  );\n  const domainOrHttpsSignal = path[2];\n  const origin =\n    domainOrHttpsSignal == 's'\n      ? 'https://' + decodeURIComponent(path[3])\n      : 'http://' + decodeURIComponent(domainOrHttpsSignal);\n  // Sanity test that what we found looks like a domain.\n  userAssert(origin.indexOf('.') > 0, 'Expected a . in origin %s', origin);\n  path.splice(1, domainOrHttpsSignal == 's' ? 3 : 2);\n  return (\n    origin +\n    path.join('/') +\n    removeAmpJsParamsFromSearch(url.search) +\n    (url.hash || '')\n  );\n}\n\n/**\n * Returns the source origin of an AMP document for documents served\n * on a proxy origin or directly.\n * @param {string|!Location} url URL of an AMP document.\n * @return {string} The source origin of the URL.\n */\nexport function getSourceOrigin(url) {\n  return parseUrlDeprecated(getSourceUrl(url)).origin;\n}\n\n/**\n * Returns absolute URL resolved based on the relative URL and the base.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n */\nexport function resolveRelativeUrl(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  if (typeof URL == 'function') {\n    return new URL(relativeUrlString, baseUrl.href).toString();\n  }\n  return resolveRelativeUrlFallback_(relativeUrlString, baseUrl);\n}\n\n/**\n * Fallback for URL resolver when URL class is not available.\n * @param {string} relativeUrlString\n * @param {string|!Location} baseUrl\n * @return {string}\n * @private Visible for testing.\n */\nexport function resolveRelativeUrlFallback_(relativeUrlString, baseUrl) {\n  if (typeof baseUrl == 'string') {\n    baseUrl = parseUrlDeprecated(baseUrl);\n  }\n  relativeUrlString = relativeUrlString.replace(/\\\\/g, '/');\n  const relativeUrl = parseUrlDeprecated(relativeUrlString);\n\n  // Absolute URL.\n  if (startsWith(relativeUrlString.toLowerCase(), relativeUrl.protocol)) {\n    return relativeUrl.href;\n  }\n\n  // Protocol-relative URL.\n  if (startsWith(relativeUrlString, '//')) {\n    return baseUrl.protocol + relativeUrlString;\n  }\n\n  // Absolute path.\n  if (startsWith(relativeUrlString, '/')) {\n    return baseUrl.origin + relativeUrlString;\n  }\n\n  // Relative path.\n  return (\n    baseUrl.origin +\n    baseUrl.pathname.replace(/\\/[^/]*$/, '/') +\n    relativeUrlString\n  );\n}\n\n/**\n * Add \"__amp_source_origin\" query parameter to the URL.\n * @param {!Window} win\n * @param {string} url\n * @return {string}\n */\nexport function getCorsUrl(win, url) {\n  checkCorsUrl(url);\n  const sourceOrigin = getSourceOrigin(win.location.href);\n  return addParamToUrl(url, SOURCE_ORIGIN_PARAM, sourceOrigin);\n}\n\n/**\n * Checks if the url has __amp_source_origin and throws if it does.\n * @param {string} url\n */\nexport function checkCorsUrl(url) {\n  const parsedUrl = parseUrlDeprecated(url);\n  const query = parseQueryString(parsedUrl.search);\n  userAssert(\n    !(SOURCE_ORIGIN_PARAM in query),\n    'Source origin is not allowed in %s',\n    url\n  );\n}\n\n/**\n * Tries to decode a URI component, falling back to opt_fallback (or an empty\n * string)\n *\n * @param {string} component\n * @param {string=} opt_fallback\n * @return {string}\n */\nexport function tryDecodeUriComponent(component, opt_fallback) {\n  return tryDecodeUriComponent_(component, opt_fallback);\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Compares if two arrays contains exactly same elements of same number\n * of same order. Note that it does NOT handle NaN case as expected.\n *\n * @param {!Array<T>} arr1\n * @param {!Array<T>} arr2\n * @return {boolean}\n * @template T\n */\nexport function areEqualOrdered(arr1, arr2) {\n  if (arr1.length !== arr2.length) {\n    return false;\n  }\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr1[i] !== arr2[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Removes elements that shouldRemove returns true for from the array.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} shouldRemove\n * @return {!Array<T>}\n * @template T\n */\nexport function remove(array, shouldRemove) {\n  const removed = [];\n  let index = 0;\n  for (let i = 0; i < array.length; i++) {\n    const item = array[i];\n    if (shouldRemove(item, i, array)) {\n      removed.push(item);\n    } else {\n      if (index < i) {\n        array[index] = item;\n      }\n      index++;\n    }\n  }\n  if (index < array.length) {\n    array.length = index;\n  }\n  return removed;\n}\n\n/**\n * Returns the index of the first element matching the predicate.\n * Like Array#findIndex.\n *\n * @param {!Array<T>} array\n * @param {function(T, number, !Array<T>):boolean} predicate\n * @return {number}\n * @template T\n */\nexport function findIndex(array, predicate) {\n  for (let i = 0; i < array.length; i++) {\n    if (predicate(array[i], i, array)) {\n      return i;\n    }\n  }\n  return -1;\n}\n\n/**\n * Converts the given iterator to an array.\n *\n * @param {!Iterator<T>} iterator\n * @return {Array<T>}\n * @template T\n */\nexport function fromIterator(iterator) {\n  const array = [];\n  for (let e = iterator.next(); !e.done; e = iterator.next()) {\n    array.push(e.value);\n  }\n  return array;\n}\n\n/**\n * Adds item to array if it is not already present.\n *\n * @param {Array<T>} array\n * @param {T} item\n * @template T\n */\nexport function pushIfNotExist(array, item) {\n  if (array.indexOf(item) < 0) {\n    array.push(item);\n  }\n}\n\n/**\n * Returns the last item in an array.\n *\n * @param {Array<T>} array\n * @template T\n * @return {?T}\n */\nexport function lastItem(array) {\n  return array[array.length - 1];\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {bytesToString, stringToBytes, utf8Decode, utf8Encode} from './bytes';\n\n/**\n * Character mapping from base64url to base64.\n * @const {!Object<string, string>}\n */\nconst base64UrlDecodeSubs = {'-': '+', '_': '/', '.': '='};\n\n/**\n * Character mapping from base64 to base64url.\n * @const {!Object<string, string>}\n */\nconst base64UrlEncodeSubs = {'+': '-', '/': '_', '=': '.'};\n\n/**\n * Converts a string which is in base64url encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function base64UrlDecodeToBytes(str) {\n  const encoded = atob(str.replace(/[-_.]/g, ch => base64UrlDecodeSubs[ch]));\n  return stringToBytes(encoded);\n}\n\n/**\n * Converts a string which is in base64 encoding into a Uint8Array\n * containing the decoded value.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function base64DecodeToBytes(str) {\n  return stringToBytes(atob(str));\n}\n\n/**\n * Converts a bytes array into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function base64UrlEncodeFromBytes(bytes) {\n  const str = bytesToString(bytes);\n  return btoa(str).replace(/[+/=]/g, ch => base64UrlEncodeSubs[ch]);\n}\n\n/**\n * Converts a string into base64url encoded string.\n * base64url is defined in RFC 4648. It is sometimes referred to as \"web safe\".\n * @param {string} str\n * @return {string}\n */\nexport function base64UrlEncodeFromString(str) {\n  const bytes = utf8Encode(str);\n  return base64UrlEncodeFromBytes(bytes);\n}\n\n/**\n * Decode a base64url encoded string by `base64UrlEncodeFromString`\n * @param {string} str\n * @return {string}\n */\nexport function base64UrlDecodeFromString(str) {\n  const bytes = base64UrlDecodeToBytes(str);\n  return utf8Decode(bytes);\n}\n\n/**\n * Converts a bytes array into base64 encoded string.\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function base64EncodeFromBytes(bytes) {\n  return btoa(bytesToString(bytes));\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../log';\n\n/**\n * Interpret a byte array as a UTF-8 string.\n * @param {!BufferSource} bytes\n * @return {string}\n */\nexport function utf8Decode(bytes) {\n  if (typeof TextDecoder !== 'undefined') {\n    return new TextDecoder('utf-8').decode(bytes);\n  }\n  const asciiString = bytesToString(new Uint8Array(bytes.buffer || bytes));\n  return decodeURIComponent(escape(asciiString));\n}\n\n/**\n * Turn a string into UTF-8 bytes.\n * @param {string} string\n * @return {!Uint8Array}\n */\nexport function utf8Encode(string) {\n  if (typeof TextEncoder !== 'undefined') {\n    return new TextEncoder('utf-8').encode(string);\n  }\n  return stringToBytes(unescape(encodeURIComponent(string)));\n}\n\n/**\n * Converts a string which holds 8-bit code points, such as the result of atob,\n * into a Uint8Array with the corresponding bytes.\n * If you have a string of characters, you probably want to be using utf8Encode.\n * @param {string} str\n * @return {!Uint8Array}\n */\nexport function stringToBytes(str) {\n  const bytes = new Uint8Array(str.length);\n  for (let i = 0; i < str.length; i++) {\n    const charCode = str.charCodeAt(i);\n    devAssert(charCode <= 255, 'Characters must be in range [0,255]');\n    bytes[i] = charCode;\n  }\n  return bytes;\n}\n\n/**\n * Converts a 8-bit bytes array into a string\n * @param {!Uint8Array} bytes\n * @return {string}\n */\nexport function bytesToString(bytes) {\n  // Intentionally avoids String.fromCharCode.apply so we don't suffer a\n  // stack overflow. #10495, https://jsperf.com/bytesToString-2\n  const array = new Array(bytes.length);\n  for (let i = 0; i < bytes.length; i++) {\n    array[i] = String.fromCharCode(bytes[i]);\n  }\n  return array.join('');\n}\n\n/**\n * Converts a 4-item byte array to an unsigned integer.\n * Assumes bytes are big endian.\n * @param {!Uint8Array} bytes\n * @return {number}\n */\nexport function bytesToUInt32(bytes) {\n  if (bytes.length != 4) {\n    throw new Error('Received byte array with length != 4');\n  }\n  const val =\n    ((bytes[0] & 0xff) << 24) |\n    ((bytes[1] & 0xff) << 16) |\n    ((bytes[2] & 0xff) << 8) |\n    (bytes[3] & 0xff);\n  // Convert to unsigned.\n  return val >>> 0;\n}\n\n/**\n * Generate a random bytes array with specific length using\n * win.crypto.getRandomValues. Return null if it is not available.\n * @param {!Window} win\n * @param {number} length\n * @return {?Uint8Array}\n */\nexport function getCryptoRandomBytesArray(win, length) {\n  if (!win.crypto || !win.crypto.getRandomValues) {\n    return null;\n  }\n\n  // Widely available in browsers we support:\n  // http://caniuse.com/#search=getRandomValues\n  const uint8array = new Uint8Array(length);\n  win.crypto.getRandomValues(uint8array);\n  return uint8array;\n}\n","/**\n * Copyright 2019 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {VisibilityState} from '../visibility-state';\nimport {getVendorJsPropertyName} from '../style';\n\n/**\n * @param {!Document} doc\n * @return {!VisibilityState}\n */\nexport function getDocumentVisibilityState(doc) {\n  // New API: `document.visibilityState` property.\n  const visibilityStateProp = getVendorJsPropertyName(\n    doc,\n    'visibilityState',\n    true\n  );\n  if (doc[visibilityStateProp]) {\n    return doc[visibilityStateProp];\n  }\n\n  // Old API: `document.hidden` property.\n  const hiddenProp = getVendorJsPropertyName(doc, 'hidden', true);\n  if (doc[hiddenProp]) {\n    return doc[hiddenProp] ? VisibilityState.HIDDEN : VisibilityState.VISIBLE;\n  }\n\n  return VisibilityState.VISIBLE;\n}\n\n/**\n * Returns the value of \"document.hidden\" property. The reasons why it may\n * not be visible include document in a non-active tab or when the document\n * is being pre-rendered via link with rel=\"prerender\".\n * @param {!Document} doc\n * @return {boolean}\n */\nexport function isDocumentHidden(doc) {\n  return getDocumentVisibilityState(doc) != VisibilityState.VISIBLE;\n}\n\n/**\n * @param {!Document} doc\n * @param {function()} handler\n */\nexport function addDocumentVisibilityChangeListener(doc, handler) {\n  if (!doc.addEventListener) {\n    return;\n  }\n  const visibilityChangeEvent = getVisibilityChangeEvent(doc);\n  if (visibilityChangeEvent) {\n    doc.addEventListener(visibilityChangeEvent, handler);\n  }\n}\n\n/**\n * @param {!Document} doc\n * @param {function()} handler\n */\nexport function removeDocumentVisibilityChangeListener(doc, handler) {\n  if (!doc.removeEventListener) {\n    return;\n  }\n  const visibilityChangeEvent = getVisibilityChangeEvent(doc);\n  if (visibilityChangeEvent) {\n    doc.removeEventListener(visibilityChangeEvent, handler);\n  }\n}\n\n/**\n * @param {!Document} doc\n * @return {?string}\n */\nfunction getVisibilityChangeEvent(doc) {\n  const hiddenProp = getVendorJsPropertyName(doc, 'hidden', true);\n  const vendorStop = hiddenProp.indexOf('Hidden');\n  return vendorStop != -1\n    ? hiddenProp.substring(0, vendorStop) + 'Visibilitychange'\n    : 'visibilitychange';\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {stringHash32} from '../string';\n\n/**\n * Gets a string of concatenated element names and relative positions\n * of the DOM element and its parentElement's (up to 25).  Relative position\n * is the index of nodes with this tag within the parent's children.\n * The order is from the inner to outer nodes in DOM hierarchy.\n *\n * If a DOM hierarchy is the following:\n *\n * <div id='id1' ...>\n *   <div id='id2' ...>\n *     <table ...>       // table:0\n *       <tr>            // tr:0\n *         <td>...</td>  // td:0\n *         <td>          // td:1\n *           <amp-ad ...></amp-ad>\n *         </td>\n *       </tr>\n *       <tr>...</tr>    // tr:1\n *     </table>\n *   </div>\n * </div>\n *\n * With the amp-ad element passed in:\n * 'amp-ad.0,td.1,tr.0,table.0,div/id2.0,div/id1.0'\n *\n * Note: 25 is chosen arbitrarily.\n *\n * @param {?Element} element DOM node from which to get fingerprint.\n * @return {string} Concatenated element ids.\n */\nexport function domFingerprintPlain(element) {\n  const ids = [];\n  let level = 0;\n  while (element && element.nodeType == /* element */ 1 && level < 25) {\n    let id = '';\n    if (element.id) {\n      id = `/${element.id}`;\n    }\n    const nodeName = element.nodeName.toLowerCase();\n    ids.push(`${nodeName}${id}${indexWithinParent(element)}`);\n    level++;\n    element = element.parentElement;\n  }\n  return ids.join();\n}\n\nexport class DomFingerprint {\n  /**\n   * Calculates ad slot DOM fingerprint.  This key is intended to\n   * identify \"same\" ad unit across many page views. This is\n   * based on where the ad appears within the page's DOM structure.\n   *\n   * @param {?Element} element The DOM element from which to collect\n   *     the DOM chain element IDs.  If null, DOM chain element IDs are not\n   *     included in the hash.\n   * @return {string} The ad unit hash key string.\n   */\n  static generate(element) {\n    return stringHash32(domFingerprintPlain(element));\n  }\n}\n\n/**\n * Gets a string showing the index of an element within\n * the children of its parent, counting only nodes with the same tag.\n * Stop at 25, just to have a limit.\n * @param {!Element} element DOM node to get index of.\n * @return {string} '.<index>' or ''.\n */\nfunction indexWithinParent(element) {\n  const {nodeName} = element;\n  // Find my index within my parent's children\n  let i = 0;\n  let count = 0;\n  let sibling = element.previousElementSibling;\n  // Different browsers have different children.\n  // So count only nodes with the same tag.\n  // Use a limit for the tags, so that different browsers get the same\n  // count. So 25 and higher all return no index.\n  while (sibling && count < 25 && i < 100) {\n    if (sibling.nodeName == nodeName) {\n      count++;\n    }\n    i++;\n    sibling = sibling.previousElementSibling;\n  }\n  // If we got to the end, then the count is accurate; otherwise skip count.\n  return count < 25 && i < 100 ? `.${count}` : '';\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n// TODO(rsimha, #15334): Enable this rule.\n/* eslint jsdoc/check-types: 0 */\n\n/**\n * Creates a function that is evaluated only once and returns the cached result\n * subsequently.\n *\n * Please note that `once` only takes the function definition into account,\n * so it will return the same cached value even when the arguments are\n * different.\n *\n * @param {function(...):T} fn\n * @return {function(...):T}\n * @template T\n */\nexport function once(fn) {\n  let evaluated = false;\n  let retValue = null;\n  let callback = fn;\n  return (...args) => {\n    if (!evaluated) {\n      retValue = callback.apply(self, args);\n      evaluated = true;\n      callback = null; // GC\n    }\n    return retValue;\n  };\n}\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Sets the img src to the first url in the srcset if srcset is defined but\n * src is not for browsers that do not support srcset.\n * @param {!Element} img\n */\nexport function guaranteeSrcForSrcsetUnsupportedBrowsers(img) {\n  // The <img> tag does not have a src and does not support srcset\n  if (!img.hasAttribute('src') && 'srcset' in img == false) {\n    const srcset = img.getAttribute('srcset');\n    const matches = /\\S+/.exec(srcset);\n    if (matches == null) {\n      return;\n    }\n    const srcseturl = matches[0];\n    img.setAttribute('src', srcseturl);\n  }\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @enum {number}\n */\nexport const KeyCodes = {\n  ENTER: 13,\n  ESCAPE: 27,\n  SPACE: 32,\n  LEFT_ARROW: 37,\n  UP_ARROW: 38,\n  RIGHT_ARROW: 39,\n  DOWN_ARROW: 40,\n};\n\n/**\n * @enum {string}\n */\nexport const Keys = {\n  ENTER: 'Enter',\n  ESCAPE: 'Escape',\n  SPACE: ' ',\n  LEFT_ARROW: 'ArrowLeft',\n  UP_ARROW: 'ArrowUp',\n  RIGHT_ARROW: 'ArrowRight',\n  DOWN_ARROW: 'ArrowDown',\n  TAB: 'Tab',\n  BACKSPACE: 'Backspace',\n  HOME: 'Home',\n  END: 'End',\n};\n","/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {dev} from '../log';\n\n/** @const {string} */\nconst TAG = 'lru-cache';\n\n/**\n * @template T\n */\nexport class LruCache {\n  /**\n   * @param {number} capacity\n   */\n  constructor(capacity) {\n    /** @private @const {number} */\n    this.capacity_ = capacity;\n\n    /** @private {number} */\n    this.size_ = 0;\n\n    /**\n     * An incrementing counter to define the last access.\n     * @private {number}\n     */\n    this.access_ = 0;\n\n    /** @private {!Object<(number|string), {payload: T, access: number}>} */\n    this.cache_ = Object.create(null);\n  }\n\n  /**\n   * Returns whether key is cached.\n   *\n   * @param {number|string} key\n   * @return {boolean}\n   */\n  has(key) {\n    return !!this.cache_[key];\n  }\n\n  /**\n   * @param {number|string} key\n   * @return {T} The cached payload.\n   */\n  get(key) {\n    const cacheable = this.cache_[key];\n    if (cacheable) {\n      cacheable.access = ++this.access_;\n      return cacheable.payload;\n    }\n    return undefined;\n  }\n\n  /**\n   * @param {number|string} key\n   * @param {T} payload The payload to cache.\n   */\n  put(key, payload) {\n    if (!this.has(key)) {\n      this.size_++;\n    }\n    this.cache_[key] = {payload, access: this.access_};\n    this.evict_();\n  }\n\n  /**\n   * Evicts the oldest cache entry, if we've exceeded capacity.\n   */\n  evict_() {\n    if (this.size_ <= this.capacity_) {\n      return;\n    }\n\n    dev().warn(TAG, 'Trimming LRU cache');\n    const cache = this.cache_;\n    let oldest = this.access_ + 1;\n    let oldestKey;\n    for (const key in cache) {\n      const {access} = cache[key];\n      if (access < oldest) {\n        oldest = access;\n        oldestKey = key;\n      }\n    }\n\n    if (oldestKey !== undefined) {\n      delete cache[oldestKey];\n      this.size_--;\n    }\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {devAssert} from '../log';\n\n/**\n * Maps a value in a first range to its equivalent in a second range\n * Ex.: 5 in the range [0,10] gives 60 in the range[40,80]\n *\n * NOTE: lower/upper bounds on the source range are detected automatically,\n * however the bounds on the target range are not altered (thus the target\n * range could be decreasing).\n * Ex1: 8 in the range [0, 10] gives 2 in the range [10, 0]\n * Ex2: also, 8 in the range [10, 0] gives 2 in the range [10, 0]\n *\n * NOTE: Input value is enforced to be bounded inside the source range\n * Ex1: -2 in the range [0, 10] is interpreted as 0 and thus gives 40 in [40,80]\n * Ex2: 19 in the range [0, 5] is interpreted as 5 and thus gives 80 in [40,80]\n *\n * @param {number} val the value in the source range\n * @param {number} min1 the lower bound of the source range\n * @param {number} max1 the upper bound of the source range\n * @param {number} min2 the lower bound of the target range\n * @param {number} max2 the upper bound of the target range\n * @return {number} the equivalent value in the target range\n */\nexport function mapRange(val, min1, max1, min2, max2) {\n  let max1Bound = max1;\n  let min1Bound = min1;\n  if (min1 > max1) {\n    max1Bound = min1;\n    min1Bound = max1;\n  }\n\n  if (val < min1Bound) {\n    val = min1Bound;\n  } else if (val > max1Bound) {\n    val = max1Bound;\n  }\n\n  return ((val - min1) * (max2 - min2)) / (max1 - min1) + min2;\n}\n\n/**\n * Computes the modulus of values `a` and `b`.\n *\n * This is needed because the % operator in JavaScript doesn't implement\n * modulus behavior as can be seen by the spec here:\n * http://www.ecma-international.org/ecma-262/5.1/#sec-11.5.3.\n * It instead is used to obtain the remainder of a division.\n * This function uses the remainder (%) operator to determine the modulus.\n * Derived from here:\n * https://stackoverflow.com/questions/25726760/javascript-modular-arithmetic/47354356#47354356\n *\n * @param {number} a\n * @param {number} b\n * @return {number} returns the modulus of the two numbers.\n * @example\n *\n * _.min(10, 5);\n * // => 0\n *\n * _.mod(-1, 5);\n * // => 4\n */\nexport function mod(a, b) {\n  return a > 0 && b > 0 ? a % b : ((a % b) + b) % b;\n}\n\n/**\n * Restricts a number to be in the given min/max range. The minimum value must\n * be less than or equal to the maximum value.\n *\n * Examples:\n * clamp(0.5, 0, 1) -> 0.5\n * clamp(1.5, 0, 1) -> 1\n * clamp(-0.5, 0, 1) -> 0\n *\n * @param {number} val the value to clamp.\n * @param {number} min the lower bound.\n * @param {number} max the upper bound.\n * @return {number} the clamped value.\n */\nexport function clamp(val, min, max) {\n  devAssert(min <= max, 'Minimum value is greater than the maximum.');\n  return Math.min(Math.max(val, min), max);\n}\n\n/**\n * Returns value bound to min and max values +/- extent. The lower bound must\n * be less than or equal to the upper bound.\n * @param {number} val the value to bound.\n * @param {number} min the lower bound.\n * @param {number} max the upper bound\n * @param {number} extent the allowed extent beyond the bounds.\n * @return {number} the bounded value.\n */\nexport function boundValue(val, min, max, extent) {\n  devAssert(min <= max, 'Lower bound is greater than the upper bound.');\n  return clamp(val, min - extent, max + extent);\n}\n\n/**\n * Returns the length of a vector given in X- and Y-coordinates.\n * @param {number} deltaX distance in the X direction.\n * @param {number} deltaY distance in the Y direction.\n * @return {number} the magnitude of the vector.\n */\nexport function magnitude(deltaX, deltaY) {\n  return Math.sqrt(deltaX * deltaX + deltaY * deltaY);\n}\n\n/**\n * Returns the distance between two points.\n * @param {number} x1 X-coordinate of the first point.\n * @param {number} y1 Y-coordinate of the first point.\n * @param {number} x2 X-coordinate of the second point.\n * @param {number} y2 Y-coordinate of the second point.\n * @return {number} the distance between the two points.\n */\nexport function distance(x1, y1, x2, y2) {\n  return magnitude(x2 - x1, y2 - y1);\n}\n\n/**\n * @param {number} centerX\n * @param {number} centerY\n * @param {number} radius\n * @param {number} angleInDegrees\n * @return {{\n *  x: number,\n *  y: number,\n * }}\n */\nexport function polarToCartesian(centerX, centerY, radius, angleInDegrees) {\n  const angleInRadians = ((angleInDegrees - 90) * Math.PI) / 180.0;\n\n  return {\n    x: centerX + radius * Math.cos(angleInRadians),\n    y: centerY + radius * Math.sin(angleInRadians),\n  };\n}\n\n/**\n * Sums up the values of the given array and returns the result\n * @param {Array<number>} values\n * @return {number}\n */\nexport function sum(values) {\n  return values.reduce(function(a, b) {\n    return a + b;\n  });\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {isObject} from '../types';\n\n/* @const */\nconst hasOwn_ = Object.prototype.hasOwnProperty;\n\n/**\n * Returns a map-like object.\n * If opt_initial is provided, copies its own properties into the\n * newly created object.\n * @param {T=} opt_initial This should typically be an object literal.\n * @return {T}\n * @template T\n */\nexport function map(opt_initial) {\n  const obj = Object.create(null);\n  if (opt_initial) {\n    Object.assign(obj, opt_initial);\n  }\n  return obj;\n}\n\n/**\n * Return an empty JsonObject or makes the passed in object literal\n * an JsonObject.\n * The JsonObject type is just a simple object that is at-dict.\n * See\n * https://github.com/google/closure-compiler/wiki/@struct-and-@dict-Annotations\n * for what a dict is type-wise.\n * The linter enforces that the argument is, in fact, at-dict like.\n * @param {!Object=} opt_initial\n * @return {!JsonObject}\n */\nexport function dict(opt_initial) {\n  // We do not copy. The linter enforces that the passed in object is a literal\n  // and thus the caller cannot have a reference to it.\n  return /** @type {!JsonObject} */ (opt_initial || {});\n}\n\n/**\n * Checks if the given key is a property in the map.\n *\n * @param {T}  obj a map like property.\n * @param {string}  key\n * @return {boolean}\n * @template T\n */\nexport function hasOwn(obj, key) {\n  return hasOwn_.call(obj, key);\n}\n\n/**\n * Returns obj[key] iff key is obj's own property (is not inherited).\n * Otherwise, returns undefined.\n *\n * @param {Object} obj\n * @param {string} key\n * @return {*}\n */\nexport function ownProperty(obj, key) {\n  if (hasOwn(obj, key)) {\n    return obj[key];\n  } else {\n    return undefined;\n  }\n}\n\n/**\n * Deep merges source into target.\n *\n * @param {!Object} target\n * @param {!Object} source\n * @param {number} depth The maximum merge depth. If exceeded, Object.assign\n *                       will be used instead.\n * @return {!Object}\n * @throws {Error} If source contains a circular reference.\n * Note: Only nested objects are deep-merged, primitives and arrays are not.\n */\nexport function deepMerge(target, source, depth = 10) {\n  // Keep track of seen objects to detect recursive references.\n  const seen = [];\n\n  /** @type {!Array<{t: !Object, s: !Object, d: number}>} */\n  const queue = [];\n  queue.push({t: target, s: source, d: 0});\n\n  // BFS to ensure objects don't have recursive references at shallower depths.\n  while (queue.length > 0) {\n    const {t, s, d} = queue.shift();\n    if (seen.includes(s)) {\n      throw new Error('Source object has a circular reference.');\n    }\n    seen.push(s);\n    if (t === s) {\n      continue;\n    }\n    if (d > depth) {\n      Object.assign(t, s);\n      continue;\n    }\n    Object.keys(s).forEach(key => {\n      const newValue = s[key];\n      // Perform a deep merge IFF both target and source have the same key\n      // whose corresponding values are objects.\n      if (hasOwn(t, key)) {\n        const oldValue = t[key];\n        if (isObject(newValue) && isObject(oldValue)) {\n          queue.push({t: oldValue, s: newValue, d: d + 1});\n          return;\n        }\n      }\n      t[key] = newValue;\n    });\n  }\n  return target;\n}\n\n/**\n * @param {!Object} o An object to remove properties from\n * @param {!Array<string>} props A list of properties to remove from the Object\n * @return {!Object} An object with the given properties removed\n */\nexport function omit(o, props) {\n  return Object.keys(o).reduce((acc, key) => {\n    if (!props.includes(key)) {\n      acc[key] = o[key];\n    }\n    return acc;\n  }, {});\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * A priority queue backed with sorted array.\n * @template T\n */\nexport default class PriorityQueue {\n  /**\n   * Creates an instance of PriorityQueue.\n   */\n  constructor() {\n    /** @private @const {Array<{item: T, priority: number}>} */\n    this.queue_ = [];\n  }\n\n  /**\n   * Returns the max priority item without dequeueing it.\n   * @return {T}\n   */\n  peek() {\n    const l = this.queue_.length;\n    if (!l) {\n      return null;\n    }\n    return this.queue_[l - 1].item;\n  }\n\n  /**\n   * Enqueues an item with the given priority.\n   * @param {T} item\n   * @param {number} priority\n   */\n  enqueue(item, priority) {\n    if (isNaN(priority)) {\n      throw new Error('Priority must not be NaN.');\n    }\n    const i = this.binarySearch_(priority);\n    this.queue_.splice(i, 0, {item, priority});\n  }\n\n  /**\n   * Returns index at which item with `target` priority should be inserted.\n   * @param {number} target\n   * @return {number}\n   * @private\n   */\n  binarySearch_(target) {\n    let i = -1;\n    let lo = 0;\n    let hi = this.queue_.length;\n    while (lo <= hi) {\n      i = Math.floor((lo + hi) / 2);\n      // This means `target` is the new max priority in the queue.\n      if (i === this.queue_.length) {\n        break;\n      }\n      // Stop searching once p[i] >= target AND p[i-1] < target.\n      // This way, we'll return the index of the first occurence of `target`\n      // priority (if any), which preserves FIFO order of same-priority items.\n      if (this.queue_[i].priority < target) {\n        lo = i + 1;\n      } else if (i > 0 && this.queue_[i - 1].priority >= target) {\n        hi = i - 1;\n      } else {\n        break;\n      }\n    }\n    return i;\n  }\n\n  /**\n   * @param {function(T)} callback\n   */\n  forEach(callback) {\n    let index = this.queue_.length;\n    while (index--) {\n      callback(this.queue_[index].item);\n    }\n  }\n\n  /**\n   * Dequeues the max priority item.\n   * Items with the same priority are dequeued in FIFO order.\n   * @return {T}\n   */\n  dequeue() {\n    if (!this.queue_.length) {\n      return null;\n    }\n    return this.queue_.pop().item;\n  }\n\n  /**\n   * The number of items in the queue.\n   * @return {number}\n   */\n  get length() {\n    return this.queue_.length;\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Returns a Deferred struct, which holds a pending promise and its associated\n * resolve and reject functions.\n *\n * This is preferred instead of creating a Promise instance to extract the\n * resolve/reject functions yourself:\n *\n * ```\n * // Avoid doing\n * let resolve;\n * const promise = new Promise(res => {\n *   resolve = res;\n * });\n *\n * // Good\n * const deferred = new Deferred();\n * const { promise, resolve } = deferred;\n * ```\n *\n * @template T\n */\nexport class Deferred {\n  /**\n   * Creates an instance of Deferred.\n   */\n  constructor() {\n    let resolve, reject;\n\n    /**\n     * @const {!Promise<T>}\n     */\n    this.promise = new /*OK*/ Promise((res, rej) => {\n      resolve = res;\n      reject = rej;\n    });\n\n    /**\n     * @const {function(T=)}\n     */\n    this.resolve = resolve;\n\n    /**\n     * @const {function(*=)}\n     */\n    this.reject = reject;\n  }\n}\n\n/**\n * Creates a promise resolved to the return value of fn.\n * If fn sync throws, it will cause the promise to reject.\n *\n * @param {function():T} fn\n * @return {!Promise<T>}\n * @template T\n */\nexport function tryResolve(fn) {\n  return new Promise(resolve => {\n    resolve(fn());\n  });\n}\n\n/**\n * Returns a promise which resolves if a threshold amount of the given promises\n * resolve, and rejects otherwise.\n * @param {!Array<!Promise>} promises The array of promises to test.\n * @param {number} count The number of promises that must resolve for the\n *     returned promise to resolve.\n * @return {!Promise} A promise that resolves if any of the given promises\n *     resolve, and which rejects otherwise.\n */\nexport function some(promises, count = 1) {\n  return new Promise((resolve, reject) => {\n    count = Math.max(count, 0);\n    const extra = promises.length - count;\n    if (extra < 0) {\n      reject(new Error('not enough promises to resolve'));\n    }\n    if (promises.length == 0) {\n      resolve([]);\n    }\n    const values = [];\n    const reasons = [];\n\n    const onFulfilled = value => {\n      if (values.length < count) {\n        values.push(value);\n      }\n      if (values.length == count) {\n        resolve(values);\n      }\n    };\n    const onRejected = reason => {\n      if (reasons.length <= extra) {\n        reasons.push(reason);\n      }\n      if (reasons.length > extra) {\n        reject(reasons);\n      }\n    };\n    for (let i = 0; i < promises.length; i++) {\n      Promise.resolve(promises[i]).then(onFulfilled, onRejected);\n    }\n  });\n}\n\n/**\n * Resolves with the result of the last promise added.\n * @implements {IThenable}\n */\nexport class LastAddedResolver {\n  /**\n   * @param {!Array<!Promise>=} opt_promises\n   */\n  constructor(opt_promises) {\n    let resolve_, reject_;\n    /** @private @const {!Promise} */\n    this.promise_ = new Promise((resolve, reject) => {\n      resolve_ = resolve;\n      reject_ = reject;\n    });\n\n    /** @private */\n    this.resolve_ = resolve_;\n\n    /** @private */\n    this.reject_ = reject_;\n\n    /** @private */\n    this.count_ = 0;\n\n    if (opt_promises) {\n      for (let i = 0; i < opt_promises.length; i++) {\n        this.add(opt_promises[i]);\n      }\n    }\n  }\n\n  /**\n   * Add a promise to possibly be resolved.\n   * @param {!Promise} promise\n   * @return {!Promise}\n   */\n  add(promise) {\n    const countAtAdd = ++this.count_;\n    Promise.resolve(promise).then(\n      result => {\n        if (this.count_ === countAtAdd) {\n          this.resolve_(result);\n        }\n      },\n      error => {\n        // Don't follow behavior of Promise.all and Promise.race error so that\n        // this will only reject when most recently added promise fails.\n        if (this.count_ === countAtAdd) {\n          this.reject_(error);\n        }\n      }\n    );\n    return this.promise_;\n  }\n\n  /** @override */\n  then(opt_resolve, opt_reject) {\n    return this.promise_.then(opt_resolve, opt_reject);\n  }\n}\n","/**\n * Copyright 2016 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Wraps a given callback and applies a rate limit.\n * It throttles the calls so that no consequent calls have time interval\n * smaller than the given minimal interval.\n *\n * @param {!Window} win\n * @param {function(...*)} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...*)}\n */\nexport function throttle(win, callback, minInterval) {\n  let locker = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {!Object} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    // Lock the fire for minInterval milliseconds\n    locker = win.setTimeout(waiter, minInterval);\n\n    callback.apply(null, args);\n  }\n\n  /**\n   * Waiter function\n   */\n  function waiter() {\n    locker = 0;\n    // If during the period there're invocations queued up, fire once.\n    if (nextCallArgs) {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function(...args) {\n    if (locker) {\n      nextCallArgs = args;\n    } else {\n      fire(args);\n    }\n  };\n}\n\n/**\n * Wraps a given callback and applies a wait timer, so that minInterval\n * milliseconds must pass since the last call before the callback is actually\n * invoked.\n *\n * @param {!Window} win\n * @param {function(...*)} callback\n * @param {number} minInterval the minimum time interval in millisecond\n * @return {function(...*)}\n */\nexport function debounce(win, callback, minInterval) {\n  let locker = 0;\n  let timestamp = 0;\n  let nextCallArgs = null;\n\n  /**\n   * @param {?Array} args\n   */\n  function fire(args) {\n    nextCallArgs = null;\n    callback.apply(null, args);\n  }\n\n  /**\n   * Wait function for debounce\n   */\n  function waiter() {\n    locker = 0;\n    const remaining = minInterval - (win.Date.now() - timestamp);\n    if (remaining > 0) {\n      locker = win.setTimeout(waiter, remaining);\n    } else {\n      fire(nextCallArgs);\n    }\n  }\n\n  return function(...args) {\n    timestamp = win.Date.now();\n    nextCallArgs = args;\n    if (!locker) {\n      locker = win.setTimeout(waiter, minInterval);\n    }\n  };\n}\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Deferred} from './promise';\nimport {map} from './object';\n\n/**\n * This object tracts signals and allows blocking until a signal has been\n * received.\n */\nexport class Signals {\n  /**\n   * Creates an instance of Signals.\n   */\n  constructor() {\n    /**\n     * A mapping from a signal name to the signal response: either time or\n     * an error.\n     * @private @const {!Object<string, (time|!Error)>}\n     */\n    this.map_ = map();\n\n    /**\n     * A mapping from a signal name to the signal promise, resolve and reject.\n     * Only allocated when promise has been requested.\n     * @private {?Object<string, {\n     *   promise: !Promise,\n     *   resolve: (function(time)|undefined),\n     *   reject: (function(!Error)|undefined)\n     * }>}\n     */\n    this.promiseMap_ = null;\n  }\n\n  /**\n   * Returns the current known value of the signal. If signal is not yet\n   * available, `null` is returned.\n   * @param {string} name\n   * @return {number|!Error|null}\n   */\n  get(name) {\n    const v = this.map_[name];\n    return v == null ? null : v;\n  }\n\n  /**\n   * Returns the promise that's resolved when the signal is triggered. The\n   * resolved value is the time of the signal.\n   * @param {string} name\n   * @return {!Promise<time>}\n   */\n  whenSignal(name) {\n    let promiseStruct = this.promiseMap_ && this.promiseMap_[name];\n    if (!promiseStruct) {\n      const result = this.map_[name];\n      if (result != null) {\n        // Immediately resolve signal.\n        const promise =\n          typeof result == 'number'\n            ? Promise.resolve(result)\n            : Promise.reject(result);\n        promiseStruct = {promise};\n      } else {\n        // Allocate the promise/resolver for when the signal arrives in the\n        // future.\n        const deferred = new Deferred();\n        const {promise, resolve, reject} = deferred;\n\n        promiseStruct = {promise, resolve, reject};\n      }\n      if (!this.promiseMap_) {\n        this.promiseMap_ = map();\n      }\n      this.promiseMap_[name] = promiseStruct;\n    }\n    return promiseStruct.promise;\n  }\n\n  /**\n   * Triggers the signal with the specified name on the element. The time is\n   * optional; if not provided, the current time is used. The associated\n   * promise is resolved with the resulting time.\n   * @param {string} name\n   * @param {time=} opt_time\n   */\n  signal(name, opt_time) {\n    if (this.map_[name] != null) {\n      // Do not duplicate signals.\n      return;\n    }\n    const time = opt_time || Date.now();\n    this.map_[name] = time;\n    const promiseStruct = this.promiseMap_ && this.promiseMap_[name];\n    if (promiseStruct && promiseStruct.resolve) {\n      promiseStruct.resolve(time);\n      promiseStruct.resolve = undefined;\n      promiseStruct.reject = undefined;\n    }\n  }\n\n  /**\n   * Rejects the signal. Indicates that the signal will never succeed. The\n   * associated signal is rejected.\n   * @param {string} name\n   * @param {!Error} error\n   */\n  rejectSignal(name, error) {\n    if (this.map_[name] != null) {\n      // Do not duplicate signals.\n      return;\n    }\n    this.map_[name] = error;\n    const promiseStruct = this.promiseMap_ && this.promiseMap_[name];\n    if (promiseStruct && promiseStruct.reject) {\n      promiseStruct.reject(error);\n      promiseStruct.resolve = undefined;\n      promiseStruct.reject = undefined;\n    }\n  }\n\n  /**\n   * Resets all signals.\n   * @param {string} name\n   */\n  reset(name) {\n    if (this.map_[name]) {\n      delete this.map_[name];\n    }\n    // Reset promise it has already been resolved.\n    const promiseStruct = this.promiseMap_ && this.promiseMap_[name];\n    if (promiseStruct && !promiseStruct.resolve) {\n      delete this.promiseMap_[name];\n    }\n  }\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Services} from '../services';\nimport {devAssert, user, userAssert} from '../log';\nimport {dict, map} from './object';\nimport {fromIterator} from './array';\nimport {\n  getCorsUrl,\n  getWinOrigin,\n  isProxyOrigin,\n  parseUrlDeprecated,\n  serializeQueryString,\n} from '../url';\nimport {getMode} from '../mode';\nimport {isArray, isObject} from '../types';\nimport {isExperimentOn} from '../experiments';\nimport {isFormDataWrapper} from '../form-data-wrapper';\n\n/** @private @const {!Array<string>} */\nconst allowedMethods_ = ['GET', 'POST'];\n\n/** @private @const {!Array<function(*):boolean>} */\nconst allowedJsonBodyTypes_ = [isArray, isObject];\n\n/**\n * Serializes a fetch request so that it can be passed to `postMessage()`,\n * i.e., can be cloned using the\n * [structured clone algorithm](http://mdn.io/Structured_clone_algorithm).\n *\n * The request is serialized in the following way:\n *\n * 1. If the `init.body` is a `FormData`, set content-type header to\n * `multipart/form-data` and transform `init.body` into an\n * `!Array<!Array<string>>` holding the list of form entries, where each\n * element in the array is a form entry (key-value pair) represented as a\n * 2-element array.\n *\n * 2. Return a new object having properties `input` and the transformed\n * `init`.\n *\n * The serialized request is assumed to be de-serialized in the following way:\n *\n * 1.If content-type header starts with `multipart/form-data`\n * (case-insensitive), transform the entry array in `init.body` into a\n * `FormData` object.\n *\n * 2. Pass `input` and transformed `init` to `fetch` (or the constructor of\n * `Request`).\n *\n * Currently only `FormData` used in `init.body` is handled as it's the only\n * type being used in AMP runtime that needs serialization. The `Headers` type\n * also needs serialization, but callers should not be passing `Headers`\n * object in `init`, as that fails `fetchPolyfill` on browsers that don't\n * support fetch. Some serialization-needing types for `init.body` such as\n * `ArrayBuffer` and `Blob` are already supported by the structured clone\n * algorithm. Other serialization-needing types such as `URLSearchParams`\n * (which is not supported in IE and Safari) and `FederatedCredentials` are\n * not used in AMP runtime.\n *\n * @param {string} input The URL of the XHR to convert to structured\n *     cloneable.\n * @param {!FetchInitDef} init The options of the XHR to convert to structured\n *     cloneable.\n * @return {{input: string, init: !FetchInitDef}} The serialized structurally-\n *     cloneable request.\n * @private\n */\nexport function toStructuredCloneable(input, init) {\n  const newInit = Object.assign({}, init);\n  if (isFormDataWrapper(init.body)) {\n    const wrapper = /** @type {!FormDataWrapperInterface} */ (init.body);\n    newInit.headers['Content-Type'] = 'multipart/form-data;charset=utf-8';\n    newInit.body = fromIterator(wrapper.entries());\n  }\n  return {input, init: newInit};\n}\n\n/**\n * De-serializes a fetch response that was made possible to be passed to\n * `postMessage()`, i.e., can be cloned using the\n * [structured clone algorithm](http://mdn.io/Structured_clone_algorithm).\n *\n * The response is assumed to be serialized in the following way:\n *\n * 1. Transform the entries in the headers of the response into an\n * `!Array<!Array<string>>` holding the list of header entries, where each\n * element in the array is a header entry (key-value pair) represented as a\n * 2-element array. The header key is case-insensitive.\n *\n * 2. Include the header entry list and `status` and `statusText` properties\n * of the response in as `headers`, `status` and `statusText` properties of\n * `init`.\n *\n * 3. Include the body of the response serialized as string in `body`.\n *\n * 4. Return a new object having properties `body` and `init`.\n *\n * The response is de-serialized in the following way:\n *\n * 1. If the `Response` type is supported and `responseType` is not\n * document, pass `body` and `init` directly to the constructor of `Response`.\n *\n * 2. Otherwise, populate a fake XHR object to pass to `FetchResponse` as if\n * the response is returned by the fetch polyfill.\n *\n * 3. If `responseType` is `document`, also parse the body and populate\n * `responseXML` as a `Document` type.\n *\n * @param {JsonObject|string|undefined} response The structurally-cloneable\n *     response to convert back to a regular Response.\n * @param {string|undefined} responseType The original response type used to\n *     initiate the XHR.\n * @return {!Response} The deserialized regular response.\n * @private\n */\nexport function fromStructuredCloneable(response, responseType) {\n  userAssert(isObject(response), 'Object expected: %s', response);\n\n  const isDocumentType = responseType == 'document';\n  if (!isDocumentType) {\n    // Use native `Response` type if available for performance. If response\n    // type is `document`, we must fall back to `FetchResponse` polyfill\n    // because callers would then rely on the `responseXML` property being\n    // present, which is not supported by the Response type.\n    return new Response(response['body'], response['init']);\n  }\n\n  const lowercasedHeaders = map();\n  const data = {\n    status: 200,\n    statusText: 'OK',\n    /**\n     * @param {string} name\n     * @return {string}\n     */\n    getResponseHeader(name) {\n      return lowercasedHeaders[String(name).toLowerCase()] || null;\n    },\n  };\n\n  if (response['init']) {\n    const init = response['init'];\n    if (isArray(init.headers)) {\n      init.headers.forEach(entry => {\n        const headerName = entry[0];\n        const headerValue = entry[1];\n        lowercasedHeaders[String(headerName).toLowerCase()] = String(\n          headerValue\n        );\n      });\n    }\n    if (init.status) {\n      data.status = parseInt(init.status, 10);\n    }\n    if (init.statusText) {\n      data.statusText = String(init.statusText);\n    }\n  }\n\n  return new Response(response['body'] ? String(response['body']) : '', data);\n}\n\n/**\n * Intercepts the XHR and proxies it through the viewer if necessary.\n *\n * XHRs are intercepted if all of the following are true:\n * - The AMP doc is in single doc mode\n * - The requested resource is not a 1p request.\n * - The viewer has the `xhrInterceptor` capability\n * - The Viewer is a trusted viewer or AMP is currently in developement mode\n * - The AMP doc is opted-in for XHR interception (`<html>` tag has\n *   `allow-xhr-interception` attribute)\n *\n * @param {!Window} win\n * @param {?../service/ampdoc-impl.AmpDoc} ampdocSingle\n * @param {string} input The URL of the XHR which may get intercepted.\n * @param {!FetchInitDef} init The options of the XHR which may get\n *     intercepted.\n * @return {!Promise<!Response|undefined>}\n *     A response returned by the interceptor if XHR is intercepted or\n *     `Promise<undefined>` otherwise.\n * @private\n */\nexport function getViewerInterceptResponse(win, ampdocSingle, input, init) {\n  if (!ampdocSingle) {\n    return Promise.resolve();\n  }\n\n  const whenUnblocked = init.prerenderSafe\n    ? Promise.resolve()\n    : ampdocSingle.whenFirstVisible();\n  const viewer = Services.viewerForDoc(ampdocSingle);\n  const urlIsProxy = isProxyOrigin(input);\n  const viewerCanIntercept = viewer.hasCapability('xhrInterceptor');\n  const interceptorDisabledForLocalDev =\n    init.bypassInterceptorForDev && getMode(win).localDev;\n  if (urlIsProxy || !viewerCanIntercept || interceptorDisabledForLocalDev) {\n    return whenUnblocked;\n  }\n\n  const htmlElement = ampdocSingle.getRootNode().documentElement;\n  const docOptedIn = htmlElement.hasAttribute('allow-xhr-interception');\n  if (!docOptedIn) {\n    return whenUnblocked;\n  }\n\n  return whenUnblocked\n    .then(() => viewer.isTrustedViewer())\n    .then(viewerTrusted => {\n      if (\n        !(\n          viewerTrusted ||\n          getMode(win).localDev ||\n          isExperimentOn(win, 'untrusted-xhr-interception')\n        )\n      ) {\n        return;\n      }\n      const messagePayload = dict({\n        'originalRequest': toStructuredCloneable(input, init),\n      });\n      return viewer\n        .sendMessageAwaitResponse('xhr', messagePayload)\n        .then(response => fromStructuredCloneable(response, init.responseType));\n    });\n}\n\n/**\n * Sets up URL based on ampCors\n * @param {!Window} win\n * @param {string} input\n * @param {!FetchInitDef} init The options of the XHR which may get\n * intercepted.\n * @return {string}\n */\nexport function setupInput(win, input, init) {\n  devAssert(typeof input == 'string', 'Only URL supported: %s', input);\n  if (init.ampCors !== false) {\n    input = getCorsUrl(win, input);\n  }\n  return input;\n}\n\n/**\n * Sets up and normalizes the FetchInitDef\n *\n * @param {?FetchInitDef=} opt_init Fetch options object.\n * @param {string=} opt_accept The HTTP Accept header value.\n * @return {!FetchInitDef}\n */\nexport function setupInit(opt_init, opt_accept) {\n  const init = opt_init || {};\n\n  // In particular, Firefox does not tolerate `null` values for\n  // `credentials`.\n  const creds = init.credentials;\n  devAssert(\n    creds === undefined || creds == 'include' || creds == 'omit',\n    'Only credentials=include|omit support: %s',\n    creds\n  );\n\n  init.method = normalizeMethod_(init.method);\n  init.headers = init.headers || dict({});\n  if (opt_accept) {\n    init.headers['Accept'] = opt_accept;\n  }\n\n  // In edge a `TypeMismatchError` is thrown when body is set to null.\n  devAssert(init.body !== null, 'fetch `body` can not be `null`');\n\n  return init;\n}\n\n/**\n *\n * Sets up AMPSpecific CORS headers.\n * @param {!Window} win\n * @param {string} input\n * @param {?FetchInitDef=} init\n * @return {!FetchInitDef}\n */\nexport function setupAMPCors(win, input, init) {\n  init = init || {};\n  // For some same origin requests, add AMP-Same-Origin: true header to allow\n  // publishers to validate that this request came from their own origin.\n  const currentOrigin = getWinOrigin(win);\n  const targetOrigin = parseUrlDeprecated(input).origin;\n  if (currentOrigin == targetOrigin) {\n    init['headers'] = init['headers'] || {};\n    init['headers']['AMP-Same-Origin'] = 'true';\n  }\n  return init;\n}\n\n/**\n * @param {?FetchInitDef=} init\n * @return {!FetchInitDef}\n */\nexport function setupJsonFetchInit(init) {\n  const fetchInit = setupInit(init, 'application/json');\n  if (fetchInit.method == 'POST' && !isFormDataWrapper(fetchInit.body)) {\n    // Assume JSON strict mode where only objects or arrays are allowed\n    // as body.\n    devAssert(\n      allowedJsonBodyTypes_.some(test => test(fetchInit.body)),\n      'body must be of type object or array. %s',\n      fetchInit.body\n    );\n\n    // Content should be 'text/plain' to avoid CORS preflight.\n    fetchInit.headers['Content-Type'] =\n      fetchInit.headers['Content-Type'] || 'text/plain;charset=utf-8';\n    const headerContentType = fetchInit.headers['Content-Type'];\n    // Cast is valid, because we checked that it is not form data above.\n    if (headerContentType === 'application/x-www-form-urlencoded') {\n      fetchInit.body = serializeQueryString(\n        /** @type {!JsonObject} */ (fetchInit.body)\n      );\n    } else {\n      fetchInit.body = JSON.stringify(\n        /** @type {!JsonObject} */ (fetchInit.body)\n      );\n    }\n  }\n  return fetchInit;\n}\n\n/**\n * Normalized method name by uppercasing.\n * @param {string|undefined} method\n * @return {string}\n * @private\n */\nfunction normalizeMethod_(method) {\n  if (method === undefined) {\n    return 'GET';\n  }\n  method = method.toUpperCase();\n  devAssert(\n    allowedMethods_.includes(method),\n    'Only one of %s is currently allowed. Got %s',\n    allowedMethods_.join(', '),\n    method\n  );\n  return method;\n}\n\n/**\n * If 415 or in the 5xx range.\n * @param {number} status\n * @return {boolean}\n */\nfunction isRetriable(status) {\n  return status == 415 || (status >= 500 && status < 600);\n}\n\n/**\n * Returns the response if successful or otherwise throws an error.\n * @param {!Response} response\n * @return {!Promise<!Response>}\n * @private Visible for testing\n */\nexport function assertSuccess(response) {\n  return new Promise(resolve => {\n    if (response.ok) {\n      return resolve(response);\n    }\n\n    const {status} = response;\n    const err = user().createError(`HTTP error ${status}`);\n    err.retriable = isRetriable(status);\n    // TODO(@jridgewell, #9448): Callers who need the response should\n    // skip processing.\n    err.response = response;\n    throw err;\n  });\n}\n\n/**\n * Returns a promise resolving to a string identity token if the element\n * contains the 'crossorigin' attribute and the amp-viewer-assistance extension\n * is present. Resolves to undefined otherwise.\n * @param {!Element} element\n * @return {!Promise<undefined>}\n */\nexport function getViewerAuthTokenIfAvailable(element) {\n  const crossOriginAttr = element.getAttribute('crossorigin');\n  if (\n    crossOriginAttr &&\n    crossOriginAttr.trim() === 'amp-viewer-auth-token-via-post'\n  ) {\n    return (\n      Services.viewerAssistanceForDocOrNull(element)\n        .then(va => {\n          userAssert(\n            va,\n            'crossorigin=\"amp-viewer-auth-token-post\" ' +\n              'requires amp-viewer-assistance extension.'\n          );\n          return va.getIdTokenPromise();\n        })\n        // If crossorigin attr is present, resolve with token or empty string.\n        .then(token => token || '')\n        .catch(() => '')\n    );\n  }\n  // If crossorigin attribute is missing, always resolve with undefined.\n  return Promise.resolve(undefined);\n}\n","/**\n * Copyright 2015 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * Visibility state of the AMP document.\n * @enum {string}\n */\nexport const VisibilityState = {\n  /**\n   * The AMP document is being pre-rendered before being shown.\n   */\n  PRERENDER: 'prerender',\n\n  /**\n   * The AMP document is currently active and visible.\n   */\n  VISIBLE: 'visible',\n\n  /**\n   * The AMP document is active but the browser tab or AMP app is not.\n   */\n  HIDDEN: 'hidden',\n\n  /**\n   * The AMP document is visible, but the user has started swiping away from\n   * it. The runtime may stop active playback.\n   */\n  PAUSED: 'paused',\n\n  /**\n   * The AMP document is no longer active because the user swiped away or\n   * closed the viewer. The document may become visible again later.\n   */\n  INACTIVE: 'inactive',\n};\n","/**\n * Copyright 2017 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * An interface to interact with browser window object.\n * Mainly used to mock out read only APIs in test.\n * See test-helper.js#mockWindowInterface\n */\nexport class WindowInterface {\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {!Location}\n   */\n  static getLocation(win) {\n    return win.location;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getDocumentReferrer(win) {\n    return win.document.referrer;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getHostname(win) {\n    return win.location.hostname;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getUserAgent(win) {\n    return win.navigator.userAgent;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {string}\n   */\n  static getUserLanguage(win) {\n    return win.navigator.userLanguage || win.navigator.language;\n  }\n\n  /**\n   * @static\n   * @return {number}\n   */\n  static getDevicePixelRatio() {\n    // No matter the window, the device-pixel-ratio is always one.\n    return self.devicePixelRatio || 1;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {function(string,(ArrayBufferView|Blob|FormData|null|string)=):boolean|undefined}\n   */\n  static getSendBeacon(win) {\n    if (!win.navigator.sendBeacon) {\n      return undefined;\n    }\n    return win.navigator.sendBeacon.bind(win.navigator);\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {function(new:XMLHttpRequest)}\n   */\n  static getXMLHttpRequest(win) {\n    return win.XMLHttpRequest;\n  }\n\n  /**\n   * @static\n   * @param {!Window} win\n   * @return {function(new:Image)}\n   */\n  static getImage(win) {\n    return win.Image;\n  }\n}\n","/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */\n\n\n/**\n * This regex consists of 4 matching capture groups and one (non-matching) fallback:\n *\n * - (\\0), catch the null terminator character so it may be replaced by UTF\n *   Replacement Char\n * - ^(-)$, catch a solitary dash char, so that it may be backslash escaped.\n *   This is a separate capture group so that the legal-chars (group 4) doesn't\n *   capture it first, since that group doesn't need to escape its dash.\n * - ([\\x01-\\x1f\\x7f]|^-?[0-9]), catch a UTF control char, or any leading\n *   number (with an optional leading dash). The control or the number (but not\n *   the leading dash) must be hex-escaped,.\n * - ([\\x80-\\uffff0-9a-zA-Z_-]+), catch legal-chars, with the exception of a\n *   solitary dash, which will already have matched in group 1.\n * - [^], finally, a catch-all that allows us to backslash escape the char.\n *\n * Together, this matches everything necessary for CSS.escape.\n */\nvar regex = /(\\0)|^(-)$|([\\x01-\\x1f\\x7f]|^-?[0-9])|([\\x80-\\uffff0-9a-zA-Z_-]+)|[^]/g;\n\nfunction escaper(match, nil, dash, hexEscape, chars) {\n  // Chars is the legal-chars (group 4) capture\n  if (chars) {\n    return chars;\n  }\n  // Nil is the null terminator (group 1) capture\n  if (nil) {\n    return '\\uFFFD';\n  }\n  // Both UTF control chars, and leading numbers (with optional leading dash)\n  // (group 3) must be backslash escaped with a trailing space.  Funnily, the\n  // leading dash must not be escaped, but the number. :shrug:\n  if (hexEscape) {\n    return match.slice(0, -1) + '\\\\' + match.slice(-1).charCodeAt(0).toString(16) + ' '\n  }\n  // Finally, the solitary dash and the catch-all chars require backslash\n  // escaping.\n  return '\\\\' + match;\n}\n\n/**\n * https://drafts.csswg.org/cssom/#serialize-an-identifier\n * @param {string} value\n * @return {string}\n */\nexport function cssEscape(value) {\n  return String(value).replace(regex, escaper);\n}\n"]}